% Options for packages loaded elsewhere
\PassOptionsToPackage{unicode}{hyperref}
\PassOptionsToPackage{hyphens}{url}
\PassOptionsToPackage{dvipsnames,svgnames,x11names}{xcolor}
%
\documentclass[
  11pt,
  oneside]{book}
\usepackage{amsmath,amssymb}
\usepackage{lmodern}
\usepackage{iftex}
\ifPDFTeX
  \usepackage[T1]{fontenc}
  \usepackage[utf8]{inputenc}
  \usepackage{textcomp} % provide euro and other symbols
\else % if luatex or xetex
  \usepackage{unicode-math}
  \defaultfontfeatures{Scale=MatchLowercase}
  \defaultfontfeatures[\rmfamily]{Ligatures=TeX,Scale=1}
\fi
% Use upquote if available, for straight quotes in verbatim environments
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
\IfFileExists{microtype.sty}{% use microtype if available
  \usepackage[]{microtype}
  \UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts
}{}
\makeatletter
\@ifundefined{KOMAClassName}{% if non-KOMA class
  \IfFileExists{parskip.sty}{%
    \usepackage{parskip}
  }{% else
    \setlength{\parindent}{0pt}
    \setlength{\parskip}{6pt plus 2pt minus 1pt}}
}{% if KOMA class
  \KOMAoptions{parskip=half}}
\makeatother
\usepackage{xcolor}
\usepackage[left=1in,right=1in,top=1.5in,bottom=1.5in]{geometry}
\usepackage{color}
\usepackage{fancyvrb}
\newcommand{\VerbBar}{|}
\newcommand{\VERB}{\Verb[commandchars=\\\{\}]}
\DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
% Add ',fontsize=\small' for more characters per line
\usepackage{framed}
\definecolor{shadecolor}{RGB}{248,248,248}
\newenvironment{Shaded}{\begin{snugshade}}{\end{snugshade}}
\newcommand{\AlertTok}[1]{\textcolor[rgb]{0.94,0.16,0.16}{#1}}
\newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.77,0.63,0.00}{#1}}
\newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\BuiltInTok}[1]{#1}
\newcommand{\CharTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\CommentTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{#1}}
\newcommand{\DecValTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ErrorTok}[1]{\textcolor[rgb]{0.64,0.00,0.00}{\textbf{#1}}}
\newcommand{\ExtensionTok}[1]{#1}
\newcommand{\FloatTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ImportTok}[1]{#1}
\newcommand{\InformationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\NormalTok}[1]{#1}
\newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.81,0.36,0.00}{\textbf{#1}}}
\newcommand{\OtherTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{#1}}
\newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\RegionMarkerTok}[1]{#1}
\newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\StringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\VariableTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\WarningTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\usepackage{longtable,booktabs,array}
\usepackage{calc} % for calculating minipage widths
% Correct order of tables after \paragraph or \subparagraph
\usepackage{etoolbox}
\makeatletter
\patchcmd\longtable{\par}{\if@noskipsec\mbox{}\fi\par}{}{}
\makeatother
% Allow footnotes in longtable head/foot
\IfFileExists{footnotehyper.sty}{\usepackage{footnotehyper}}{\usepackage{footnote}}
\makesavenoteenv{longtable}
\usepackage{graphicx}
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\makeatother
% Scale images if necessary, so that they will not overflow the page
% margins by default, and it is still possible to overwrite the defaults
% using explicit options in \includegraphics[width, height, ...]{}
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}
% Set default figure placement to htbp
\makeatletter
\def\fps@figure{htbp}
\makeatother
\setlength{\emergencystretch}{3em} % prevent overfull lines
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
\setcounter{secnumdepth}{5}
% section formatting
\usepackage{fancyhdr}
\renewcommand{\chaptername}{Section}
\usepackage{titlesec}
\titleformat{\chapter}[display]   
{\normalfont\huge\bfseries}{\chaptertitlename\ \thechapter}{20pt}{\Huge}   
\titlespacing*{\chapter}{0pt}{-50pt}{40pt}
\usepackage{fvextra}
\DefineVerbatimEnvironment{Highlighting}{Verbatim}{breaklines,commandchars=\\\{\}}

% tables
\usepackage{booktabs}
\usepackage{longtable}
\usepackage[bf, singlelinecheck=off, justification=centering]{caption}

% increase color options
\usepackage{color}
\usepackage{color, colortbl}
\usepackage[dvipsnames, x11names]{xcolor}
\definecolor{carminered}{rgb}{1.0, 0.0, 0.22}

% links 
\usepackage[colorlinks=true, urlcolor=blue, linkcolor=Violet, citecolor=BrickRed, pdfborder={0 0 0}]{hyperref}
\urlstyle{tt}

\usepackage[scale=.7]{sourcecodepro}

\renewcommand{\textfraction}{0.05}
\renewcommand{\topfraction}{0.8}
\renewcommand{\bottomfraction}{0.8}
\renewcommand{\floatpagefraction}{0.75}

\renewenvironment{quote}{\begin{VF}}{\end{VF}}
\let\oldhref\href
\renewcommand{\href}[2]{#2\footnote{\url{#1}}}

\makeatletter
\newenvironment{kframe}{%
\medskip{}
\setlength{\fboxsep}{.8em}
 \def\at@end@of@kframe{}%
 \ifinner\ifhmode%
  \def\at@end@of@kframe{\end{minipage}}%
  \begin{minipage}{\columnwidth}%
 \fi\fi%
 \def\FrameCommand##1{\hskip\@totalleftmargin \hskip-\fboxsep
 \colorbox{shadecolor}{##1}\hskip-\fboxsep
     % There is no \\@totalrightmargin, so:
     \hskip-\linewidth \hskip-\@totalleftmargin \hskip\columnwidth}%
 \MakeFramed {\advance\hsize-\width
   \@totalleftmargin\z@ \linewidth\hsize
   \@setminipage}}%
 {\par\unskip\endMakeFramed%
 \at@end@of@kframe}
\makeatother

\makeatletter
\@ifundefined{Shaded}{
}{\renewenvironment{Shaded}{\begin{kframe}}{\end{kframe}}}
\makeatother

\newenvironment{rmdblock}[1]
  {
  \begin{itemize}
  \renewcommand{\labelitemi}{
    \raisebox{-.7\height}[0pt][0pt]{
      {\setkeys{Gin}{width=3em,keepaspectratio}\includegraphics{images/#1}}
    }
  }
  \setlength{\fboxsep}{1em}
  \begin{kframe}
  \item
  }
  {
  \end{kframe}
  \end{itemize}
  }
\newenvironment{rmdnote}
  {\begin{rmdblock}{note}}
  {\end{rmdblock}}
\newenvironment{rmdcaution}
  {\begin{rmdblock}{caution}}
  {\end{rmdblock}}
\newenvironment{rmdimportant}
  {\begin{rmdblock}{important}}
  {\end{rmdblock}}
\newenvironment{rmdtip}
  {\begin{rmdblock}{tip}}
  {\end{rmdblock}}
\newenvironment{rmdwarning}
  {\begin{rmdblock}{warning}}
  {\end{rmdblock}}

\usepackage{makeidx}
\makeindex

\usepackage{amsthm}
\makeatletter
\def\thm@space@setup{%
  \thm@preskip=8pt plus 2pt minus 4pt
  \thm@postskip=\thm@preskip
}
\makeatother

\frontmatter
\ifLuaTeX
  \usepackage{selnolig}  % disable illegal ligatures
\fi
\IfFileExists{bookmark.sty}{\usepackage{bookmark}}{\usepackage{hyperref}}
\IfFileExists{xurl.sty}{\usepackage{xurl}}{} % add URL line breaks if available
\urlstyle{same} % disable monospaced font for URLs
\hypersetup{
  pdftitle={Multifunctional peptide engineering},
  pdfauthor={Renee Ti Chou and Henry T. Hsueh},
  colorlinks=true,
  linkcolor={Maroon},
  filecolor={Maroon},
  citecolor={Blue},
  urlcolor={Blue},
  pdfcreator={LaTeX via pandoc}}

\title{Multifunctional peptide engineering}
\author{Renee Ti Chou and Henry T. Hsueh}
\date{2023-03-12}

\begin{document}
\maketitle

{
\hypersetup{linkcolor=}
\setcounter{tocdepth}{2}
\tableofcontents
}
\mainmatter

\hypertarget{preface}{%
\chapter*{Preface}\label{preface}}
\addcontentsline{toc}{chapter}{Preface}

The research notebook contains the code of the machine learning algorithms used to generate the results in the paper ``\emph{Machine learning-driven multifunctional peptide engineering for sustained ocular drug delivery.}'' The research involves a super learner-based methodology to improve multifunctional peptide engineering. The aim is to impart high melanin binding, high cell-penetration, and low cytotoxicity to ocular drugs through peptide-drug conjugation, with the ultimate goal of enhancing the sustained delivery of the drug to maintain the therapeutic level in the eye for a prolonged period.

\textbf{Citation:}

Chou RT, \emph{et al.} Supplementary materials for machine learning-driven multifunctional peptide engineering for sustained ocular drug delivery. \url{https://doi.org/10.13016/0jck-hnnv}, (2023).

\begin{Shaded}
\begin{Highlighting}[]
\VariableTok{@misc}\NormalTok{\{}\OtherTok{https:}\NormalTok{//}\OtherTok{doi}\NormalTok{.}\OtherTok{org}\NormalTok{/}\OtherTok{10}\NormalTok{.}\OtherTok{13016}\NormalTok{/}\OtherTok{0jck}\NormalTok{{-}}\OtherTok{hnnv}\NormalTok{,}
  \DataTypeTok{doi}\NormalTok{ = \{10.13016/0JCK{-}HNNV\},}
  \DataTypeTok{url}\NormalTok{ = \{https://drum.lib.umd.edu/handle/1903/29529\},}
  \DataTypeTok{author}\NormalTok{ = \{Chou,  Renee Ti and Hsueh,  Henry T. and Rai,  Usha and Liyanage,  Wathsala and Kim,  Yoo Chun and Appell,  Matthew B. and Pejavar,  Jahnavi and Leo,  Kirby T. and Davison,  Charlotte and Kolodziejski,  Patricia and Mozzer,  Ann and Kwon,  HyeYoung and Sista,  Maanasa and Anders,  Nicole M. and Hemingway,  Avelina and Rompicharla,  Sri Vishnu Kiran and Edwards,  Malia and Pitha,  Ian and Hanes,  Justin and Cummings,  Michael P. and Ensign,  Laura M.\},}
  \DataTypeTok{keywords}\NormalTok{ = \{machine learning,  drug delivery\},}
  \DataTypeTok{language}\NormalTok{ = \{en\},}
  \DataTypeTok{title}\NormalTok{ = \{Supplementary materials for machine learning{-}driven multifunctional peptide engineering for sustained ocular drug delivery\},}
  \DataTypeTok{publisher}\NormalTok{ = \{Digital Repository at the University of Maryland\},}
  \DataTypeTok{year}\NormalTok{ = \{2023\}}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

The notebook is licensed under the Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License.

\hypertarget{01_pilot_peptide_array}{%
\chapter{Melanin binding pilot peptide array}\label{01_pilot_peptide_array}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(seqinr)}
\FunctionTok{library}\NormalTok{(Peptides)}
\FunctionTok{library}\NormalTok{(stringr)}
\FunctionTok{library}\NormalTok{(protr)}
\FunctionTok{library}\NormalTok{(plyr)}
\FunctionTok{library}\NormalTok{(randomForest)}
\FunctionTok{library}\NormalTok{(ggplot2)}
\end{Highlighting}
\end{Shaded}

\hypertarget{overview}{%
\section{Overview}\label{overview}}

\begin{center}\includegraphics[width=1\linewidth]{./figures/mb_pilot_overview} \end{center}

\hypertarget{generating-ml-input}{%
\section{Generating ML input}\label{generating-ml-input}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\CommentTok{\# Peptides\_2.4.4}
\CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\CommentTok{\# read in fasta file}
\NormalTok{peptides }\OtherTok{\textless{}{-}} \FunctionTok{read.fasta}\NormalTok{(}\StringTok{"./other\_data/mb\_pilot\_peptide\_array.fasta"}\NormalTok{, }\AttributeTok{seqtype =} \StringTok{"AA"}\NormalTok{, }\AttributeTok{as.string =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{set.attributes =} \ConstantTok{FALSE}\NormalTok{)}
\CommentTok{\# Molecular weight}
\NormalTok{weights }\OtherTok{\textless{}{-}} \FunctionTok{as.matrix}\NormalTok{(}\FunctionTok{sapply}\NormalTok{(peptides, }\ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{mw}\NormalTok{(x, }\AttributeTok{monoisotopic =} \ConstantTok{FALSE}\NormalTok{)))}
\FunctionTok{colnames}\NormalTok{(weights) }\OtherTok{\textless{}{-}} \StringTok{"weight"}
\CommentTok{\# Amino acid composition}
\NormalTok{aa.comp }\OtherTok{\textless{}{-}} \FunctionTok{sapply}\NormalTok{(peptides, }\ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{aaComp}\NormalTok{(x))}
\NormalTok{aa.comp.matrix }\OtherTok{\textless{}{-}} \FunctionTok{t}\NormalTok{(}\FunctionTok{sapply}\NormalTok{(aa.comp, }\ControlFlowTok{function}\NormalTok{(x) x[, }\StringTok{"Mole\%"}\NormalTok{]))}
\CommentTok{\# Isoelectric point}
\NormalTok{pI.values }\OtherTok{\textless{}{-}} \FunctionTok{as.matrix}\NormalTok{(}\FunctionTok{sapply}\NormalTok{(peptides, }\ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{pI}\NormalTok{(x, }\AttributeTok{pKscale =} \StringTok{"EMBOSS"}\NormalTok{)))}
\FunctionTok{colnames}\NormalTok{(pI.values) }\OtherTok{\textless{}{-}} \StringTok{"pI.value"}
\CommentTok{\# Hydrophobicity}
\NormalTok{hydrophobicity.values }\OtherTok{\textless{}{-}} \FunctionTok{as.matrix}\NormalTok{(}\FunctionTok{sapply}\NormalTok{(peptides, }\ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{hydrophobicity}\NormalTok{(x, }\AttributeTok{scale =} \StringTok{"KyteDoolittle"}\NormalTok{)))}
\FunctionTok{colnames}\NormalTok{(hydrophobicity.values) }\OtherTok{\textless{}{-}} \StringTok{"hydrophobicity.value"}
\CommentTok{\# Net charge at pH 7}
\NormalTok{net.charges }\OtherTok{\textless{}{-}} \FunctionTok{as.matrix}\NormalTok{(}\FunctionTok{sapply}\NormalTok{(peptides, }\ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{charge}\NormalTok{(x, }\AttributeTok{pH =} \DecValTok{7}\NormalTok{, }\AttributeTok{pKscale =} \StringTok{"EMBOSS"}\NormalTok{)))}
\FunctionTok{colnames}\NormalTok{(net.charges) }\OtherTok{\textless{}{-}} \StringTok{"net.charge"}
\CommentTok{\# Boman index}
\NormalTok{boman.indices }\OtherTok{\textless{}{-}} \FunctionTok{as.matrix}\NormalTok{(}\FunctionTok{sapply}\NormalTok{(peptides, }\ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{boman}\NormalTok{(x)))}
\FunctionTok{colnames}\NormalTok{(boman.indices) }\OtherTok{\textless{}{-}} \StringTok{"boman.index"}
\CommentTok{\# combine peptides results}
\NormalTok{peptides\_res }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}\FunctionTok{cbind}\NormalTok{(weights, aa.comp.matrix, pI.values, hydrophobicity.values, net.charges, boman.indices))}

\CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\CommentTok{\# protr\_1.6{-}2}
\CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\NormalTok{length }\OtherTok{\textless{}{-}} \DecValTok{7}
\CommentTok{\# read in FASTA file}
\NormalTok{sequences }\OtherTok{\textless{}{-}} \FunctionTok{readFASTA}\NormalTok{(}\StringTok{"./other\_data/mb\_pilot\_peptide\_array.fasta"}\NormalTok{)}
\NormalTok{sequences }\OtherTok{\textless{}{-}}\NormalTok{ sequences[}\FunctionTok{unlist}\NormalTok{(}\FunctionTok{lapply}\NormalTok{(sequences, }\ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{nchar}\NormalTok{(x) }\SpecialCharTok{\textgreater{}} \DecValTok{1}\NormalTok{))]}
\CommentTok{\# calculate amino acid composition descriptors (dim = 20)}
\NormalTok{x1 }\OtherTok{\textless{}{-}} \FunctionTok{t}\NormalTok{(}\FunctionTok{sapply}\NormalTok{(sequences, extractAAC))}
\FunctionTok{colnames}\NormalTok{(x1)[}\FunctionTok{colnames}\NormalTok{(x1) }\SpecialCharTok{==} \StringTok{"Y"}\NormalTok{] }\OtherTok{\textless{}{-}} \StringTok{"Y\_tyrosine"}
\CommentTok{\# calculate dipeptide composition descriptors (dim = 400)}
\NormalTok{x2 }\OtherTok{\textless{}{-}} \FunctionTok{t}\NormalTok{(}\FunctionTok{sapply}\NormalTok{(sequences, extractDC))}
\FunctionTok{colnames}\NormalTok{(x2)[}\FunctionTok{colnames}\NormalTok{(x2) }\SpecialCharTok{==} \StringTok{"NA"}\NormalTok{] }\OtherTok{\textless{}{-}} \StringTok{"NA\_dipeptide"}
\CommentTok{\# calculate Moreau{-}Broto autocorrelation descriptors (dim = 8 * (length {-} 1))}
\NormalTok{x3 }\OtherTok{\textless{}{-}} \FunctionTok{t}\NormalTok{(}\FunctionTok{sapply}\NormalTok{(sequences, extractMoreauBroto, }\AttributeTok{nlag =}\NormalTok{ length }\SpecialCharTok{{-}}\NormalTok{ 1L))}
\FunctionTok{colnames}\NormalTok{(x3) }\OtherTok{\textless{}{-}} \FunctionTok{paste}\NormalTok{(}\StringTok{"moreau\_broto"}\NormalTok{, }\FunctionTok{colnames}\NormalTok{(x3), }\AttributeTok{sep =} \StringTok{"\_"}\NormalTok{)}
\CommentTok{\# calculate composition descriptors (dim = 21)}
\NormalTok{x4 }\OtherTok{\textless{}{-}} \FunctionTok{t}\NormalTok{(}\FunctionTok{sapply}\NormalTok{(sequences, extractCTDC))}
\CommentTok{\# calculate transition descriptors (dim = 21)}
\NormalTok{x5 }\OtherTok{\textless{}{-}} \FunctionTok{t}\NormalTok{(}\FunctionTok{sapply}\NormalTok{(sequences, extractCTDT))}
\CommentTok{\# calculate distribution descriptors (dim = 105)}
\NormalTok{x6 }\OtherTok{\textless{}{-}} \FunctionTok{t}\NormalTok{(}\FunctionTok{sapply}\NormalTok{(sequences, extractCTDD))}
\CommentTok{\# calculate conjoint triad descriptors (dim = 343)}
\NormalTok{x7 }\OtherTok{\textless{}{-}} \FunctionTok{t}\NormalTok{(}\FunctionTok{sapply}\NormalTok{(sequences, extractCTriad))}
\CommentTok{\# calculate sequence{-}order{-}coupling numbers (dim = 2 * (length {-} 1))}
\NormalTok{x8 }\OtherTok{\textless{}{-}} \FunctionTok{t}\NormalTok{(}\FunctionTok{sapply}\NormalTok{(sequences, extractSOCN, }\AttributeTok{nlag =}\NormalTok{ length }\SpecialCharTok{{-}}\NormalTok{ 1L))}
\CommentTok{\# calculate quasi{-}sequence{-}order descriptors (dim = 40 + 2 * (length {-} 1))}
\NormalTok{x9 }\OtherTok{\textless{}{-}} \FunctionTok{t}\NormalTok{(}\FunctionTok{sapply}\NormalTok{(sequences, extractQSO, }\AttributeTok{nlag =}\NormalTok{ length }\SpecialCharTok{{-}}\NormalTok{ 1L))}
\CommentTok{\# calculate pseudo{-}amino acid composition (dim = 20 + (length {-} 1))}
\NormalTok{x10 }\OtherTok{\textless{}{-}} \FunctionTok{t}\NormalTok{(}\FunctionTok{sapply}\NormalTok{(sequences, extractPAAC, }\AttributeTok{lambda =}\NormalTok{ length }\SpecialCharTok{{-}}\NormalTok{ 1L))}
\CommentTok{\# calculate amphiphilic pseudo{-}amino acid composition (dim = 20 + 2 * (length {-} 1))}
\NormalTok{x11 }\OtherTok{\textless{}{-}} \FunctionTok{t}\NormalTok{(}\FunctionTok{sapply}\NormalTok{(sequences, extractAPAAC, }\AttributeTok{lambda =}\NormalTok{ length }\SpecialCharTok{{-}}\NormalTok{ 1L))}
\CommentTok{\# combine all of the result datasets}
\NormalTok{protr\_res }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}\FunctionTok{cbind}\NormalTok{(x1, x2, x3, x4, x5, x6, x7, x8, x9, x10, x11))}

\NormalTok{labels }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\StringTok{"./other\_data/mb\_pilot\_peptide\_array\_labels.csv"}\NormalTok{, }\AttributeTok{row.names =} \DecValTok{1}\NormalTok{)}
\NormalTok{merge.all }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x, ..., }\AttributeTok{by =} \StringTok{"row.names"}\NormalTok{) \{}
\NormalTok{  L }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(...)}
  \ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \FunctionTok{seq\_along}\NormalTok{(L)) \{}
\NormalTok{    x }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(x, L[[i]], }\AttributeTok{by =}\NormalTok{ by)}
    \FunctionTok{rownames}\NormalTok{(x) }\OtherTok{\textless{}{-}}\NormalTok{ x}\SpecialCharTok{$}\NormalTok{Row.names}
\NormalTok{    x}\SpecialCharTok{$}\NormalTok{Row.names }\OtherTok{\textless{}{-}} \ConstantTok{NULL}
\NormalTok{  \}}
  \FunctionTok{return}\NormalTok{(x)}
\NormalTok{\}}
\NormalTok{data }\OtherTok{\textless{}{-}} \FunctionTok{merge.all}\NormalTok{(peptides\_res, protr\_res, labels)}
\FunctionTok{write.csv}\NormalTok{(data, }\AttributeTok{file =} \StringTok{"./data/mb\_pilot\_peptide\_array\_ml\_input.csv"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{training-initial-rf-model}{%
\section{Training initial RF model}\label{training-initial-rf-model}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\StringTok{"./data/mb\_pilot\_peptide\_array\_ml\_input.csv"}\NormalTok{, }\AttributeTok{check.names =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{row.names =} \DecValTok{1}\NormalTok{)}
\NormalTok{predictor\_variables }\OtherTok{\textless{}{-}} \FunctionTok{subset}\NormalTok{(data, }\AttributeTok{select =} \SpecialCharTok{{-}}\NormalTok{category)}
\NormalTok{response\_variable }\OtherTok{\textless{}{-}} \FunctionTok{factor}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{category, }\AttributeTok{levels =} \FunctionTok{c}\NormalTok{(}\StringTok{"non{-}bind"}\NormalTok{, }\StringTok{"bind"}\NormalTok{))}
\CommentTok{\# impute missing values}
\NormalTok{response\_variable }\OtherTok{\textless{}{-}} \FunctionTok{na.roughfix}\NormalTok{(response\_variable)}
\CommentTok{\# perform balance sampling}
\NormalTok{samp\_size }\OtherTok{\textless{}{-}} \FunctionTok{min}\NormalTok{(}\FunctionTok{table}\NormalTok{(response\_variable))}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# build RF model}
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{22}\NormalTok{)}
\NormalTok{ntree }\OtherTok{\textless{}{-}} \DecValTok{100000}
\NormalTok{rf }\OtherTok{\textless{}{-}} \FunctionTok{randomForest}\NormalTok{(}
  \AttributeTok{x =}\NormalTok{ predictor\_variables, }\AttributeTok{y =}\NormalTok{ response\_variable, }\AttributeTok{ntree =}\NormalTok{ ntree, }\AttributeTok{sampsize =} \FunctionTok{rep}\NormalTok{(samp\_size, }\DecValTok{2}\NormalTok{),}
  \AttributeTok{importance =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{proximity =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{do.trace =} \FloatTok{0.1} \SpecialCharTok{*}\NormalTok{ ntree}
\NormalTok{)}
\FunctionTok{save}\NormalTok{(rf, }\AttributeTok{file =} \StringTok{"./rdata/mb\_pilot\_rf.RData"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{melanin-binding-variable-importance}{%
\section{Melanin binding variable importance}\label{melanin-binding-variable-importance}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{load}\NormalTok{(}\AttributeTok{file =} \StringTok{"./rdata/mb\_pilot\_rf.RData"}\NormalTok{)}
\NormalTok{imp\_ds }\OtherTok{\textless{}{-}} \FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{importance}\NormalTok{(rf)[, }\StringTok{"MeanDecreaseAccuracy"}\NormalTok{, }\AttributeTok{drop =} \ConstantTok{FALSE}\NormalTok{])}
\NormalTok{imp\_ds}\SpecialCharTok{$}\StringTok{\textasciigrave{}}\AttributeTok{Feature}\StringTok{\textasciigrave{}} \OtherTok{\textless{}{-}} \FunctionTok{rownames}\NormalTok{(imp\_ds)}
\FunctionTok{colnames}\NormalTok{(imp\_ds) }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"Mean decrease accuracy"}\NormalTok{, }\StringTok{"Feature"}\NormalTok{)}
\NormalTok{imp\_ds }\OtherTok{\textless{}{-}}\NormalTok{ imp\_ds[}\FunctionTok{order}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{imp\_ds}\SpecialCharTok{$}\StringTok{\textasciigrave{}}\AttributeTok{Mean decrease accuracy}\StringTok{\textasciigrave{}}\NormalTok{), ][}\DecValTok{1}\SpecialCharTok{:}\DecValTok{20}\NormalTok{, ]}

\NormalTok{p }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(imp\_ds, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =} \FunctionTok{reorder}\NormalTok{(}\StringTok{\textasciigrave{}}\AttributeTok{Feature}\StringTok{\textasciigrave{}}\NormalTok{, }\StringTok{\textasciigrave{}}\AttributeTok{Mean decrease accuracy}\StringTok{\textasciigrave{}}\NormalTok{), }\AttributeTok{y =} \StringTok{\textasciigrave{}}\AttributeTok{Mean decrease accuracy}\StringTok{\textasciigrave{}}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{geom\_col}\NormalTok{(}\AttributeTok{color =} \StringTok{"grey10"}\NormalTok{, }\AttributeTok{fill =} \StringTok{"\#f5b8b8"}\NormalTok{, }\AttributeTok{size =} \FloatTok{0.2}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_text}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{label =} \FunctionTok{sprintf}\NormalTok{(}\StringTok{"\%.2f"}\NormalTok{, }\StringTok{\textasciigrave{}}\AttributeTok{Mean decrease accuracy}\StringTok{\textasciigrave{}}\NormalTok{)), }\AttributeTok{nudge\_y =} \FloatTok{4.2}\NormalTok{, }\AttributeTok{size =} \DecValTok{3}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{coord\_flip}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{ylim}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FunctionTok{max}\NormalTok{(imp\_ds}\SpecialCharTok{$}\StringTok{\textasciigrave{}}\AttributeTok{Mean decrease accuracy}\StringTok{\textasciigrave{}}\NormalTok{) }\SpecialCharTok{+} \DecValTok{5}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_bw}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}
    \AttributeTok{panel.grid.major =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{panel.grid.minor =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{strip.background =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{panel.border =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{axis.line =} \FunctionTok{element\_line}\NormalTok{(}\AttributeTok{color =} \StringTok{"black"}\NormalTok{),}
    \AttributeTok{legend.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{10}\NormalTok{),}
    \AttributeTok{plot.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{hjust =} \FloatTok{0.5}\NormalTok{, }\AttributeTok{size =} \DecValTok{18}\NormalTok{),}
    \AttributeTok{plot.margin =}\NormalTok{ ggplot2}\SpecialCharTok{::}\FunctionTok{margin}\NormalTok{(}\DecValTok{10}\NormalTok{, }\DecValTok{10}\NormalTok{, }\DecValTok{10}\NormalTok{, }\DecValTok{0}\NormalTok{, }\StringTok{"pt"}\NormalTok{),}
    \AttributeTok{axis.title.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{18}\NormalTok{),}
    \AttributeTok{axis.title.y =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{18}\NormalTok{),}
    \AttributeTok{axis.text.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{12}\NormalTok{),}
    \AttributeTok{axis.text.y =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{12}\NormalTok{),}
    \AttributeTok{legend.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{14}\NormalTok{),}
    \AttributeTok{legend.position =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.85}\NormalTok{, }\FloatTok{0.5}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{xlab}\NormalTok{(}\StringTok{""}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{ggtitle}\NormalTok{(}\StringTok{""}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics[width=1\linewidth]{./figures/Fig 1 mb pilot var imp} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sessionInfo}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## R version 4.2.2 (2022-10-31)
## Platform: x86_64-apple-darwin17.0 (64-bit)
## Running under: macOS Big Sur ... 10.16
## 
## Matrix products: default
## BLAS:   /Library/Frameworks/R.framework/Versions/4.2/Resources/lib/libRblas.0.dylib
## LAPACK: /Library/Frameworks/R.framework/Versions/4.2/Resources/lib/libRlapack.dylib
## 
## locale:
## [1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8
## 
## attached base packages:
## [1] stats     graphics  grDevices utils     datasets  methods   base     
## 
## other attached packages:
## [1] ggplot2_3.3.6        randomForest_4.7-1.1 plyr_1.8.7          
## [4] protr_1.6-2          stringr_1.4.1        Peptides_2.4.4      
## [7] seqinr_4.2-16       
## 
## loaded via a namespace (and not attached):
##  [1] Rcpp_1.0.9        pillar_1.8.1      compiler_4.2.2    R.methodsS3_1.8.2
##  [5] R.utils_2.12.0    tools_4.2.2       digest_0.6.29     evaluate_0.16    
##  [9] lifecycle_1.0.1   tibble_3.1.8      gtable_0.3.0      R.cache_0.16.0   
## [13] pkgconfig_2.0.3   rlang_1.0.4       DBI_1.1.3         cli_3.3.0        
## [17] rstudioapi_0.14   yaml_2.3.5        xfun_0.32         fastmap_1.1.0    
## [21] withr_2.5.0       dplyr_1.0.9       styler_1.8.0      knitr_1.40       
## [25] generics_0.1.3    vctrs_0.4.1       tidyselect_1.1.2  ade4_1.7-19      
## [29] grid_4.2.2        glue_1.6.2        R6_2.5.1          fansi_1.0.3      
## [33] rmarkdown_2.16    bookdown_0.28     purrr_0.3.4       magrittr_2.0.3   
## [37] codetools_0.2-18  scales_1.2.1      htmltools_0.5.3   MASS_7.3-58.1    
## [41] assertthat_0.2.1  colorspace_2.0-3  utf8_1.2.2        stringi_1.7.8    
## [45] munsell_0.5.0     R.oo_1.25.0
\end{verbatim}

\hypertarget{02_variable_reduction}{%
\chapter{Variable reduction}\label{02_variable_reduction}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(Peptides)}
\FunctionTok{library}\NormalTok{(protr)}
\FunctionTok{library}\NormalTok{(rlist)}
\FunctionTok{library}\NormalTok{(ranger)}
\FunctionTok{library}\NormalTok{(ggplot2)}
\FunctionTok{library}\NormalTok{(cowplot)}
\FunctionTok{library}\NormalTok{(scales)}
\end{Highlighting}
\end{Shaded}

\hypertarget{methods}{%
\section{Methods}\label{methods}}

\begin{itemize}
\tightlist
\item
  Formula of AIC
\end{itemize}

\begin{equation}
AIC = -2\ln(\hat{L}) + 2k, 
\label{eq:aic}
\end{equation}

\begin{equation}
\begin{split}
\mathrm{where}\:\hat{L}\:\mathrm{is\:the\:maximum\:likelihood\:value,}\\
\mathrm{and}\:k\:\mathrm{is\:the\:number\:of\:parameters.}
\end{split}
\end{equation}

\hypertarget{regression}{%
\subsection{Regression}\label{regression}}

\begin{itemize}
\item
  Likelihood of normal distribution

  Assume residuals are normally distributed, then
  \begin{equation}
  L(\theta) = \prod_{i = 1}^{N} \frac{1}{\sqrt{2\pi\sigma^2}}e^{-\frac{{(\hat{y}_{i} - y_i)}^2}{2\sigma^2}}
  \label{eq:likelihood-reg}
  \end{equation}
\end{itemize}

\begin{equation}
\begin{split}
\ln{L(\theta)} & = \sum_{i = 1}^{N} [\ln{(\frac{1}{\sqrt{2\pi\sigma^2}})} - {\frac{{(\hat{y}_{i} - y_i)}^2}{2\sigma^2}}] \\
& = -\frac{N}{2}\ln{(2\pi)} -\frac{N}{2}\ln{(\sigma^2)} - \frac{1}{2\sigma^2}\sum_{i = 1}^{N}{{(\hat{y}_{i} - y_i)}^2.} \\
\end{split}
\label{eq:log-likelihood-reg-1}
\end{equation}
\(\mathrm{Since}\:{\hat{\sigma}^2} = \frac{\sum_{i = 1}^{N}{{(\hat{y}_{i} - y_i)}^2}}{N} = {MSE},\)
\begin{equation}
\ln{L(\theta)} = -\frac{N}{2}\ln{(MSE)} + C, \mathrm{where}\:C\:\mathrm{is\:a\:constant.}
\label{eq:log-likelihood-reg-2}
\end{equation}

\begin{itemize}
\tightlist
\item
  Derived regression AIC
\end{itemize}

\begin{equation}
AIC_{reg} = N\ln{(MSE)} + 2k
\label{eq:aic-reg}
\end{equation}

\hypertarget{classification}{%
\subsection{Classification}\label{classification}}

\begin{itemize}
\tightlist
\item
  Likelihood of Bernoulli distribution
\end{itemize}

\begin{equation}
L(\theta) = \prod_{i = 1}^{N} [q_{\theta}(y_i = 1)^{y_i}q_{\theta}(y_i = 0)^{1-y_i}]
\label{eq:likelihood-clf}
\end{equation}

\begin{equation}
\begin{split}
\ln{L(\theta)} = \sum_{i = 1}^{N} [y_i\ln{q_{\theta}(y_i = 1)} + (1 - y_i)\ln{q_{\theta}(y_i = 0)}], 
\end{split}
\label{eq:log-likelihood-clf}
\end{equation}

\begin{equation}
\begin{split}
\mathrm{where}\:q_{\theta}\:\mathrm{is\:the\:estimated\:probability\:with\:parameters\:\theta}\:\mathrm{and\:}\:y_i \in \{0, 1\}
\end{split}
\end{equation}

\begin{itemize}
\tightlist
\item
  Binary cross-entropy
\end{itemize}

\begin{equation}
\begin{split}
H_p(q_{\theta}) & = -\frac{1}{N}\sum_{i = 1}^{N} [y_i\log_2{q_{\theta}(y_i = 1)} + (1 - y_i)\log_2{q_{\theta}(y_i = 0)}] \\
& = -\frac{1}{N{\cdot}\ln{2}}\sum_{i = 1}^{N} [y_i\ln{q_{\theta}(y_i = 1)} + (1 - y_i)\ln{q_{\theta}(y_i = 0)}]
\end{split}
\label{eq:binary-cross-entropy}
\end{equation}

\begin{itemize}
\tightlist
\item
  Derived classification AIC
\end{itemize}

\begin{equation}
AIC_{clf} = 2{\cdot}\ln{2}{\cdot}N{\cdot}H_p(q_{\theta}) + 2k
\label{eq:aic-clf}
\end{equation}

\hypertarget{extension-to-multi-class-classification}{%
\subsubsection{Extension to multi-class classification}\label{extension-to-multi-class-classification}}

\begin{itemize}
\item
  Generalized likelihood estimation

  Assume the classes are one-hot encoded, then we can generalize equation \eqref{eq:aic-clf} to multi-class problems.
\end{itemize}

\begin{equation}
L(\theta) = \prod_{i = 1}^{N}\prod_{j = 1}^{M}\hat{y}_{ij}^{y_{ij}}
\label{eq:likelihood-multi-clf}
\end{equation}

\begin{equation}
\begin{split}
\ln{L(\theta)} = \sum_{i = 1}^{N}\sum_{j = 1}^{M}y_{ij}\ln{\hat{y}_{ij}}, 
\end{split}
\label{eq:log-likelihood-multi-clf}
\end{equation}

\begin{equation}
\begin{split}
\mathrm{where}\:\hat{y}_{ij}\:\mathrm{is\:the\:estimated\:probability\:of\:class}\:j\:\mathrm{of\:sample\:}i\:\mathrm{and\:}\:y_{ij} \in \{0, 1\}
\end{split}
\end{equation}

\begin{itemize}
\tightlist
\item
  Categorical cross-entropy
\end{itemize}

\begin{equation}
H_p(q_{\theta}) = -\frac{1}{N}\sum_{i = 1}^{N}\sum_{j = 1}^{M}y_{ij}\log_2{\hat{y}_{ij}}
\label{eq:cat-cross-entropy}
\end{equation}

\begin{itemize}
\tightlist
\item
  Derived generalized classification AIC
\end{itemize}

\begin{equation}
AIC_{clf} = 2{\cdot}\ln{2}{\cdot}N{\cdot}H_p(q_{\theta}) + 2k
\label{eq:aic-multi-clf}
\end{equation}

\hypertarget{ml-input-generating-function}{%
\section{ML input generating function}\label{ml-input-generating-function}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{generate\_ml\_input }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(fasta\_file, label\_file, output\_file) \{}
  \CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
  \CommentTok{\# Peptides\_2.4.4}
  \CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
  \CommentTok{\# read in fasta file}
\NormalTok{  peptides }\OtherTok{\textless{}{-}} \FunctionTok{read.fasta}\NormalTok{(fasta\_file, }\AttributeTok{seqtype =} \StringTok{"AA"}\NormalTok{, }\AttributeTok{as.string =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{set.attributes =} \ConstantTok{FALSE}\NormalTok{)}
  \CommentTok{\# Molecular weight}
\NormalTok{  weights }\OtherTok{\textless{}{-}} \FunctionTok{as.matrix}\NormalTok{(}\FunctionTok{sapply}\NormalTok{(peptides, }\ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{mw}\NormalTok{(x, }\AttributeTok{monoisotopic =} \ConstantTok{FALSE}\NormalTok{)))}
  \FunctionTok{colnames}\NormalTok{(weights) }\OtherTok{\textless{}{-}} \StringTok{"weight"}
  \CommentTok{\# Amino acid composition}
\NormalTok{  aa.comp }\OtherTok{\textless{}{-}} \FunctionTok{sapply}\NormalTok{(peptides, }\ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{aaComp}\NormalTok{(x))}
\NormalTok{  aa.comp.matrix }\OtherTok{\textless{}{-}} \FunctionTok{t}\NormalTok{(}\FunctionTok{sapply}\NormalTok{(aa.comp, }\ControlFlowTok{function}\NormalTok{(x) x[, }\StringTok{"Mole\%"}\NormalTok{]))}
  \CommentTok{\# Isoelectric point}
\NormalTok{  pI.values }\OtherTok{\textless{}{-}} \FunctionTok{as.matrix}\NormalTok{(}\FunctionTok{sapply}\NormalTok{(peptides, }\ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{pI}\NormalTok{(x, }\AttributeTok{pKscale =} \StringTok{"EMBOSS"}\NormalTok{)))}
  \FunctionTok{colnames}\NormalTok{(pI.values) }\OtherTok{\textless{}{-}} \StringTok{"pI.value"}
  \CommentTok{\# Hydrophobicity}
\NormalTok{  hydrophobicity.values }\OtherTok{\textless{}{-}} \FunctionTok{as.matrix}\NormalTok{(}\FunctionTok{sapply}\NormalTok{(peptides, }\ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{hydrophobicity}\NormalTok{(x, }\AttributeTok{scale =} \StringTok{"KyteDoolittle"}\NormalTok{)))}
  \FunctionTok{colnames}\NormalTok{(hydrophobicity.values) }\OtherTok{\textless{}{-}} \StringTok{"hydrophobicity.value"}
  \CommentTok{\# Net charge at pH 7}
\NormalTok{  net.charges }\OtherTok{\textless{}{-}} \FunctionTok{as.matrix}\NormalTok{(}\FunctionTok{sapply}\NormalTok{(peptides, }\ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{charge}\NormalTok{(x, }\AttributeTok{pH =} \DecValTok{7}\NormalTok{, }\AttributeTok{pKscale =} \StringTok{"EMBOSS"}\NormalTok{)))}
  \FunctionTok{colnames}\NormalTok{(net.charges) }\OtherTok{\textless{}{-}} \StringTok{"net.charge"}
  \CommentTok{\# Boman index}
\NormalTok{  boman.indices }\OtherTok{\textless{}{-}} \FunctionTok{as.matrix}\NormalTok{(}\FunctionTok{sapply}\NormalTok{(peptides, }\ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{boman}\NormalTok{(x)))}
  \FunctionTok{colnames}\NormalTok{(boman.indices) }\OtherTok{\textless{}{-}} \StringTok{"boman.index"}
  \CommentTok{\# combine peptides results}
\NormalTok{  peptides\_res }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}\FunctionTok{cbind}\NormalTok{(weights, aa.comp.matrix, pI.values, hydrophobicity.values, net.charges, boman.indices))}

  \CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
  \CommentTok{\# protr\_1.6{-}2}
  \CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\NormalTok{  length }\OtherTok{\textless{}{-}} \DecValTok{7}
  \CommentTok{\# read in FASTA file}
\NormalTok{  sequences }\OtherTok{\textless{}{-}} \FunctionTok{readFASTA}\NormalTok{(fasta\_file)}
\NormalTok{  sequences }\OtherTok{\textless{}{-}}\NormalTok{ sequences[}\FunctionTok{unlist}\NormalTok{(}\FunctionTok{lapply}\NormalTok{(sequences, }\ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{nchar}\NormalTok{(x) }\SpecialCharTok{\textgreater{}} \DecValTok{1}\NormalTok{))]}
  \CommentTok{\# calculate amino acid composition descriptors (dim = 20)}
\NormalTok{  x1 }\OtherTok{\textless{}{-}} \FunctionTok{t}\NormalTok{(}\FunctionTok{sapply}\NormalTok{(sequences, extractAAC))}
  \FunctionTok{colnames}\NormalTok{(x1)[}\FunctionTok{colnames}\NormalTok{(x1) }\SpecialCharTok{==} \StringTok{"Y"}\NormalTok{] }\OtherTok{\textless{}{-}} \StringTok{"Y\_tyrosine"}
  \CommentTok{\# calculate dipeptide composition descriptors (dim = 400)}
\NormalTok{  x2 }\OtherTok{\textless{}{-}} \FunctionTok{t}\NormalTok{(}\FunctionTok{sapply}\NormalTok{(sequences, extractDC))}
  \FunctionTok{colnames}\NormalTok{(x2)[}\FunctionTok{colnames}\NormalTok{(x2) }\SpecialCharTok{==} \StringTok{"NA"}\NormalTok{] }\OtherTok{\textless{}{-}} \StringTok{"NA\_dipeptide"}
  \CommentTok{\# calculate Moreau{-}Broto autocorrelation descriptors (dim = 8 * (length {-} 1))}
\NormalTok{  x3 }\OtherTok{\textless{}{-}} \FunctionTok{t}\NormalTok{(}\FunctionTok{sapply}\NormalTok{(sequences, extractMoreauBroto, }\AttributeTok{nlag =}\NormalTok{ length }\SpecialCharTok{{-}}\NormalTok{ 1L))}
  \FunctionTok{colnames}\NormalTok{(x3) }\OtherTok{\textless{}{-}} \FunctionTok{paste}\NormalTok{(}\StringTok{"moreau\_broto"}\NormalTok{, }\FunctionTok{colnames}\NormalTok{(x3), }\AttributeTok{sep =} \StringTok{"\_"}\NormalTok{)}
  \CommentTok{\# calculate composition descriptors (dim = 21)}
\NormalTok{  x4 }\OtherTok{\textless{}{-}} \FunctionTok{t}\NormalTok{(}\FunctionTok{sapply}\NormalTok{(sequences, extractCTDC))}
  \CommentTok{\# calculate transition descriptors (dim = 21)}
\NormalTok{  x5 }\OtherTok{\textless{}{-}} \FunctionTok{t}\NormalTok{(}\FunctionTok{sapply}\NormalTok{(sequences, extractCTDT))}
  \CommentTok{\# calculate distribution descriptors (dim = 105)}
\NormalTok{  x6 }\OtherTok{\textless{}{-}} \FunctionTok{t}\NormalTok{(}\FunctionTok{sapply}\NormalTok{(sequences, extractCTDD))}
  \CommentTok{\# calculate conjoint triad descriptors (dim = 343)}
\NormalTok{  x7 }\OtherTok{\textless{}{-}} \FunctionTok{t}\NormalTok{(}\FunctionTok{sapply}\NormalTok{(sequences, extractCTriad))}
  \CommentTok{\# calculate sequence{-}order{-}coupling numbers (dim = 2 * (length {-} 1))}
\NormalTok{  x8 }\OtherTok{\textless{}{-}} \FunctionTok{t}\NormalTok{(}\FunctionTok{sapply}\NormalTok{(sequences, extractSOCN, }\AttributeTok{nlag =}\NormalTok{ length }\SpecialCharTok{{-}}\NormalTok{ 1L))}
  \CommentTok{\# calculate quasi{-}sequence{-}order descriptors (dim = 40 + 2 * (length {-} 1))}
\NormalTok{  x9 }\OtherTok{\textless{}{-}} \FunctionTok{t}\NormalTok{(}\FunctionTok{sapply}\NormalTok{(sequences, extractQSO, }\AttributeTok{nlag =}\NormalTok{ length }\SpecialCharTok{{-}}\NormalTok{ 1L))}
  \CommentTok{\# calculate pseudo{-}amino acid composition (dim = 20 + (length {-} 1))}
\NormalTok{  x10 }\OtherTok{\textless{}{-}} \FunctionTok{t}\NormalTok{(}\FunctionTok{sapply}\NormalTok{(sequences, extractPAAC, }\AttributeTok{lambda =}\NormalTok{ length }\SpecialCharTok{{-}}\NormalTok{ 1L))}
  \CommentTok{\# calculate amphiphilic pseudo{-}amino acid composition (dim = 20 + 2 * (length {-} 1))}
\NormalTok{  x11 }\OtherTok{\textless{}{-}} \FunctionTok{t}\NormalTok{(}\FunctionTok{sapply}\NormalTok{(sequences, extractAPAAC, }\AttributeTok{lambda =}\NormalTok{ length }\SpecialCharTok{{-}}\NormalTok{ 1L))}
  \CommentTok{\# combine all of the result datasets}
\NormalTok{  protr\_res }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}\FunctionTok{cbind}\NormalTok{(x1, x2, x3, x4, x5, x6, x7, x8, x9, x10, x11))}

\NormalTok{  labels }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(label\_file, }\AttributeTok{row.names =} \DecValTok{1}\NormalTok{)}
\NormalTok{  merge.all }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x, ..., }\AttributeTok{by =} \StringTok{"row.names"}\NormalTok{) \{ }\CommentTok{\# https://stackoverflow.com/a/22618297}
\NormalTok{    L }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(...)}
    \ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \FunctionTok{seq\_along}\NormalTok{(L)) \{}
\NormalTok{      x }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(x, L[[i]], }\AttributeTok{by =}\NormalTok{ by)}
      \FunctionTok{rownames}\NormalTok{(x) }\OtherTok{\textless{}{-}}\NormalTok{ x}\SpecialCharTok{$}\NormalTok{Row.names}
\NormalTok{      x}\SpecialCharTok{$}\NormalTok{Row.names }\OtherTok{\textless{}{-}} \ConstantTok{NULL}
\NormalTok{    \}}
    \FunctionTok{return}\NormalTok{(x)}
\NormalTok{  \}}
\NormalTok{  data }\OtherTok{\textless{}{-}} \FunctionTok{merge.all}\NormalTok{(peptides\_res, protr\_res, labels)}
  \FunctionTok{write.csv}\NormalTok{(data, }\AttributeTok{file =}\NormalTok{ output\_file)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\hypertarget{aic-functions}{%
\section{AIC functions}\label{aic-functions}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\#\textquotesingle{} Mean squared error function}
\CommentTok{\#\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @param y\_true a factor vector representing true values.}
\CommentTok{\#\textquotesingle{} @param y\_pred a numeric vector or a matrix of predicted values.}
\CommentTok{\#\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @return MSE}
\CommentTok{\#\textquotesingle{}}
\NormalTok{mse }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(y\_true, y\_pred) \{}
  \FunctionTok{return}\NormalTok{(}\FunctionTok{mean}\NormalTok{((y\_true }\SpecialCharTok{{-}}\NormalTok{ y\_pred)}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{))}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\#\textquotesingle{} Regression AIC}
\CommentTok{\#\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @param y\_true a factor vector representing true values.}
\CommentTok{\#\textquotesingle{} @param y\_pred a numeric vector or a matrix of predicted values.}
\CommentTok{\#\textquotesingle{} @param k number of parameters/variables.}
\CommentTok{\#\textquotesingle{} @param eps a very small value to avoid negative infinitives generated by log(p=0).}
\CommentTok{\#\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @return AIC}
\CommentTok{\#\textquotesingle{}}
\NormalTok{aic\_reg }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(y\_true, y\_pred, k, }\AttributeTok{eps =} \FloatTok{1e{-}15}\NormalTok{) \{}
\NormalTok{  mserr }\OtherTok{\textless{}{-}} \FunctionTok{mse}\NormalTok{(y\_true, y\_pred)}
  \ControlFlowTok{if}\NormalTok{ (mserr }\SpecialCharTok{==} \DecValTok{0}\NormalTok{) mserr }\OtherTok{\textless{}{-}}\NormalTok{ eps}
\NormalTok{  AIC }\OtherTok{\textless{}{-}} \FunctionTok{length}\NormalTok{(y\_true) }\SpecialCharTok{*} \FunctionTok{log}\NormalTok{(mserr) }\SpecialCharTok{+} \DecValTok{2} \SpecialCharTok{*}\NormalTok{ k}
  \FunctionTok{return}\NormalTok{(AIC)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\#\textquotesingle{} Cross{-}entropy function}
\CommentTok{\#\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @param y\_true a factor vector representing true labels.}
\CommentTok{\#\textquotesingle{} @param y\_pred a numeric vector (probabilities of the second class/factor level)}
\CommentTok{\#\textquotesingle{} or a matrix of predicted probabilities.}
\CommentTok{\#\textquotesingle{} @param eps a very small value to avoid negative infinitives generated by log(p=0).}
\CommentTok{\#\textquotesingle{} If the function returns NaN, then increasing eps may solve the issue. Alternatively,}
\CommentTok{\#\textquotesingle{} As NaN is usually generated in the case of p = 1 {-} eps = 1, resulting in log(1 {-} p)}
\CommentTok{\#\textquotesingle{} = log(0) from binary cross{-}entropy, the user can pass prediction values as a matrix}
\CommentTok{\#\textquotesingle{} to calculate categorical cross{-}entropy instead.}
\CommentTok{\#\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @return H, cross{-}entropy (mean loss per sample)}
\CommentTok{\#\textquotesingle{}}
\NormalTok{crossEntropy }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(y\_true, y\_pred, }\AttributeTok{eps =} \FloatTok{1e{-}15}\NormalTok{) \{}
  \FunctionTok{stopifnot}\NormalTok{(}\FunctionTok{is.factor}\NormalTok{(y\_true))}
\NormalTok{  y\_pred }\OtherTok{\textless{}{-}} \FunctionTok{pmax}\NormalTok{(}\FunctionTok{pmin}\NormalTok{(y\_pred, }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ eps), eps)}
\NormalTok{  n\_levels }\OtherTok{\textless{}{-}} \FunctionTok{nlevels}\NormalTok{(y\_true)}
\NormalTok{  H }\OtherTok{\textless{}{-}} \ConstantTok{NULL}
  \CommentTok{\# Binary classification}
  \ControlFlowTok{if}\NormalTok{ (n\_levels }\SpecialCharTok{==} \DecValTok{2} \SpecialCharTok{\&\&} \FunctionTok{is.vector}\NormalTok{(y\_pred)) \{}
\NormalTok{    y\_true }\OtherTok{\textless{}{-}} \FunctionTok{as.numeric}\NormalTok{(y\_true }\SpecialCharTok{==} \FunctionTok{levels}\NormalTok{(y\_true)[}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{])}
\NormalTok{    H }\OtherTok{\textless{}{-}} \SpecialCharTok{{-}}\FunctionTok{mean}\NormalTok{(y\_true }\SpecialCharTok{*} \FunctionTok{log2}\NormalTok{(y\_pred) }\SpecialCharTok{+}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ y\_true) }\SpecialCharTok{*} \FunctionTok{log2}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ y\_pred))}
\NormalTok{  \}}
  \CommentTok{\# Multi{-}class classification}
  \ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (n\_levels }\SpecialCharTok{==} \FunctionTok{ncol}\NormalTok{(y\_pred)) \{}
\NormalTok{    y\_true }\OtherTok{\textless{}{-}} \FunctionTok{as.numeric}\NormalTok{(y\_true)}
\NormalTok{    y\_true\_encoded }\OtherTok{\textless{}{-}} \FunctionTok{t}\NormalTok{(}\FunctionTok{sapply}\NormalTok{(y\_true, }\ControlFlowTok{function}\NormalTok{(x) \{}
\NormalTok{      tmp }\OtherTok{\textless{}{-}} \FunctionTok{rep}\NormalTok{(}\DecValTok{0}\NormalTok{, n\_levels)}
\NormalTok{      tmp[x] }\OtherTok{\textless{}{-}} \DecValTok{1}
      \FunctionTok{return}\NormalTok{(tmp)}
\NormalTok{    \}))}
\NormalTok{    H }\OtherTok{\textless{}{-}} \SpecialCharTok{{-}}\FunctionTok{mean}\NormalTok{(}\FunctionTok{sapply}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(y\_true\_encoded), }\ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{sum}\NormalTok{(y\_true\_encoded[x, ] }\SpecialCharTok{*} \FunctionTok{log2}\NormalTok{(y\_pred[x, ]))))}
\NormalTok{  \}}
  \FunctionTok{return}\NormalTok{(H)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\#\textquotesingle{} Classification AIC}
\CommentTok{\#\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @param y\_true a factor vector representing true labels.}
\CommentTok{\#\textquotesingle{} @param y\_pred a numeric vector or a matrix of predicted probabilities.}
\CommentTok{\#\textquotesingle{} @param k number of parameters/variables.}
\CommentTok{\#\textquotesingle{} @param ... other parameters to be passed to \textasciigrave{}crossEntropy()\textasciigrave{}}
\CommentTok{\#\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @return AIC}
\CommentTok{\#\textquotesingle{}}
\NormalTok{aic\_clf }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(y\_true, y\_pred, k, ...) \{}
\NormalTok{  H }\OtherTok{\textless{}{-}} \FunctionTok{crossEntropy}\NormalTok{(y\_true, y\_pred, ...)}
\NormalTok{  AIC }\OtherTok{\textless{}{-}} \DecValTok{2} \SpecialCharTok{*} \FunctionTok{log}\NormalTok{(}\DecValTok{2}\NormalTok{) }\SpecialCharTok{*} \FunctionTok{length}\NormalTok{(y\_true) }\SpecialCharTok{*}\NormalTok{ H }\SpecialCharTok{+} \DecValTok{2} \SpecialCharTok{*}\NormalTok{ k}
  \FunctionTok{return}\NormalTok{(AIC)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\hypertarget{melanin-binding-regression}{%
\section{Melanin binding (regression)}\label{melanin-binding-regression}}

\hypertarget{generating-ml-input-1}{%
\subsection{Generating ML input}\label{generating-ml-input-1}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{generate\_ml\_input}\NormalTok{(}
  \AttributeTok{fasta\_file =} \StringTok{"./other\_data/mb\_second\_peptide\_array.fasta"}\NormalTok{,}
  \AttributeTok{label\_file =} \StringTok{"./other\_data/mb\_second\_peptide\_array\_labels.csv"}\NormalTok{,}
  \AttributeTok{output\_file =} \StringTok{"./data/mb\_second\_peptide\_array\_ml\_input.csv"}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{variable-importance}{%
\subsection{Variable importance}\label{variable-importance}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{12}\NormalTok{)}
\NormalTok{mb\_data }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\StringTok{"./data/mb\_second\_peptide\_array\_ml\_input.csv"}\NormalTok{, }\AttributeTok{check.names =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{row.names =} \DecValTok{1}\NormalTok{)}
\CommentTok{\# random shuffle}
\NormalTok{mb\_data }\OtherTok{\textless{}{-}}\NormalTok{ mb\_data[}\FunctionTok{sample}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(mb\_data), }\AttributeTok{replace =} \ConstantTok{FALSE}\NormalTok{), ]}

\CommentTok{\# train random forest using ranger}
\NormalTok{ntree }\OtherTok{\textless{}{-}} \DecValTok{100000}
\NormalTok{predictor\_variables }\OtherTok{\textless{}{-}} \FunctionTok{subset}\NormalTok{(mb\_data, }\AttributeTok{select =} \SpecialCharTok{{-}}\NormalTok{log\_intensity)}
\NormalTok{response\_variable }\OtherTok{\textless{}{-}}\NormalTok{ mb\_data}\SpecialCharTok{$}\NormalTok{log\_intensity}
\NormalTok{rf }\OtherTok{\textless{}{-}} \FunctionTok{ranger}\NormalTok{(}
  \AttributeTok{x =}\NormalTok{ predictor\_variables, }\AttributeTok{y =}\NormalTok{ response\_variable, }\AttributeTok{num.trees =}\NormalTok{ ntree, }\AttributeTok{importance =} \StringTok{"permutation"}\NormalTok{, }\AttributeTok{verbose =} \ConstantTok{TRUE}\NormalTok{,}
  \AttributeTok{scale.permutation.importance =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{seed =} \DecValTok{3}\NormalTok{, }\AttributeTok{keep.inbag =} \ConstantTok{TRUE}
\NormalTok{)}
\FunctionTok{save}\NormalTok{(rf, }\AttributeTok{file =} \StringTok{"./rdata/var\_reduct\_mb\_rf.RData"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{variable-reduction}{%
\subsection{Variable reduction}\label{variable-reduction}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{load}\NormalTok{(}\AttributeTok{file =} \StringTok{"./rdata/var\_reduct\_mb\_rf.RData"}\NormalTok{)}
\NormalTok{var\_imp }\OtherTok{\textless{}{-}}\NormalTok{ ranger}\SpecialCharTok{::}\FunctionTok{importance}\NormalTok{(rf)}
\NormalTok{var\_imp }\OtherTok{\textless{}{-}}\NormalTok{ var\_imp[}\FunctionTok{order}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{var\_imp)]}
\NormalTok{var\_imp }\OtherTok{\textless{}{-}}\NormalTok{ var\_imp[var\_imp }\SpecialCharTok{\textgreater{}=} \DecValTok{0}\NormalTok{]}

\FunctionTok{set.seed}\NormalTok{(}\DecValTok{12}\NormalTok{)}
\NormalTok{mb\_data }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\StringTok{"./data/mb\_second\_peptide\_array\_ml\_input.csv"}\NormalTok{, }\AttributeTok{check.names =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{row.names =} \DecValTok{1}\NormalTok{)}
\CommentTok{\# random shuffle}
\NormalTok{mb\_data }\OtherTok{\textless{}{-}}\NormalTok{ mb\_data[}\FunctionTok{sample}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(mb\_data), }\AttributeTok{replace =} \ConstantTok{FALSE}\NormalTok{), ]}

\NormalTok{ntree }\OtherTok{\textless{}{-}} \DecValTok{1000}
\NormalTok{var\_subset\_res }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
\ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(var\_imp)) \{}
  \FunctionTok{cat}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(i, }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{))}
\NormalTok{  predictor\_variables }\OtherTok{\textless{}{-}}\NormalTok{ mb\_data[, }\FunctionTok{colnames}\NormalTok{(mb\_data) }\SpecialCharTok{\%in\%} \FunctionTok{names}\NormalTok{(var\_imp)[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{i], drop }\OtherTok{=} \ConstantTok{FALSE}\NormalTok{]}
\NormalTok{  response\_variable }\OtherTok{\textless{}{-}}\NormalTok{ mb\_data}\SpecialCharTok{$}\NormalTok{log\_intensity}
\NormalTok{  rf }\OtherTok{\textless{}{-}} \FunctionTok{ranger}\NormalTok{(}\AttributeTok{x =}\NormalTok{ predictor\_variables, }\AttributeTok{y =}\NormalTok{ response\_variable, }\AttributeTok{num.trees =}\NormalTok{ ntree, }\AttributeTok{importance =} \StringTok{"none"}\NormalTok{, }\AttributeTok{verbose =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{seed =} \DecValTok{3}\NormalTok{)}
\NormalTok{  var\_subset\_res }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(var\_subset\_res, }\FunctionTok{list}\NormalTok{(}
    \AttributeTok{rsq =}\NormalTok{ rf}\SpecialCharTok{$}\NormalTok{r.squared,}
    \AttributeTok{aic =} \FunctionTok{aic\_reg}\NormalTok{(}
      \AttributeTok{y\_true =}\NormalTok{ response\_variable,}
      \AttributeTok{y\_pred =}\NormalTok{ rf}\SpecialCharTok{$}\NormalTok{predictions,}
      \AttributeTok{k =}\NormalTok{ i}
\NormalTok{    )}
\NormalTok{  ))}
\NormalTok{\}}
\FunctionTok{save}\NormalTok{(var\_subset\_res, }\AttributeTok{file =} \StringTok{"./rdata/var\_reduct\_mb\_var\_subset\_res.RData"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{load}\NormalTok{(}\AttributeTok{file =} \StringTok{"./rdata/var\_reduct\_mb\_var\_subset\_res.RData"}\NormalTok{)}
\NormalTok{rsq\_vec }\OtherTok{\textless{}{-}} \FunctionTok{unlist}\NormalTok{(}\FunctionTok{lapply}\NormalTok{(var\_subset\_res, }\ControlFlowTok{function}\NormalTok{(x) x}\SpecialCharTok{$}\NormalTok{rsq))}
\NormalTok{aic\_vec }\OtherTok{\textless{}{-}} \FunctionTok{unlist}\NormalTok{(}\FunctionTok{lapply}\NormalTok{(var\_subset\_res, }\ControlFlowTok{function}\NormalTok{(x) x}\SpecialCharTok{$}\NormalTok{aic))}
\NormalTok{rsq\_cutoff }\OtherTok{\textless{}{-}} \FunctionTok{which.max}\NormalTok{(rsq\_vec)}
\NormalTok{aic\_cutoff }\OtherTok{\textless{}{-}} \FunctionTok{which.min}\NormalTok{(aic\_vec)}

\NormalTok{p1\_1 }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =} \FunctionTok{data.frame}\NormalTok{(}\AttributeTok{x =} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(rsq\_vec), }\AttributeTok{y =}\NormalTok{ rsq\_vec), }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{alpha =} \FloatTok{0.3}\NormalTok{, }\AttributeTok{size =} \FloatTok{0.5}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_vline}\NormalTok{(}\AttributeTok{xintercept =}\NormalTok{ rsq\_cutoff, }\AttributeTok{colour =} \StringTok{"red"}\NormalTok{, }\AttributeTok{linetype =} \StringTok{"dashed"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_x\_continuous}\NormalTok{(}\AttributeTok{breaks =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, rsq\_cutoff, }\DecValTok{200}\NormalTok{, }\DecValTok{400}\NormalTok{, }\DecValTok{600}\NormalTok{, }\DecValTok{735}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{scale\_y\_continuous}\NormalTok{(}
    \AttributeTok{breaks =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.40}\NormalTok{, }\FloatTok{0.45}\NormalTok{, }\FloatTok{0.50}\NormalTok{, }\FloatTok{0.55}\NormalTok{),}
    \AttributeTok{labels =} \FunctionTok{c}\NormalTok{(}\StringTok{"0.40"}\NormalTok{, }\StringTok{"0.45"}\NormalTok{, }\StringTok{"0.50"}\NormalTok{, }\StringTok{"0.55"}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{theme\_bw}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}
    \AttributeTok{plot.margin =} \FunctionTok{unit}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{10}\NormalTok{, }\DecValTok{10}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{10}\NormalTok{, }\DecValTok{10}\NormalTok{), }\StringTok{"pt"}\NormalTok{),}
    \AttributeTok{panel.grid.major =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{panel.grid.minor =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{strip.background =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{panel.border =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{axis.line =} \FunctionTok{element\_line}\NormalTok{(}\AttributeTok{color =} \StringTok{"black"}\NormalTok{),}
    \AttributeTok{plot.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{hjust =} \FloatTok{0.5}\NormalTok{),}
    \AttributeTok{axis.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{),}
    \AttributeTok{axis.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{xlab}\NormalTok{(}\StringTok{""}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{ylab}\NormalTok{(}\FunctionTok{expression}\NormalTok{(}\FunctionTok{italic}\NormalTok{(R}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{))) }\SpecialCharTok{+}
  \FunctionTok{ggtitle}\NormalTok{(}\StringTok{"Melanin binding"}\NormalTok{)}

\NormalTok{p1\_2 }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =} \FunctionTok{data.frame}\NormalTok{(}\AttributeTok{x =} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(aic\_vec), }\AttributeTok{y =}\NormalTok{ aic\_vec), }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{alpha =} \FloatTok{0.3}\NormalTok{, }\AttributeTok{size =} \FloatTok{0.5}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_vline}\NormalTok{(}\AttributeTok{xintercept =}\NormalTok{ aic\_cutoff, }\AttributeTok{colour =} \StringTok{"red"}\NormalTok{, }\AttributeTok{linetype =} \StringTok{"dashed"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_x\_continuous}\NormalTok{(}\AttributeTok{breaks =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, aic\_cutoff, }\DecValTok{200}\NormalTok{, }\DecValTok{400}\NormalTok{, }\DecValTok{600}\NormalTok{, }\DecValTok{735}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{scale\_y\_continuous}\NormalTok{(}
    \AttributeTok{breaks =} \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{500}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{500}\NormalTok{, }\DecValTok{1000}\NormalTok{),}
    \AttributeTok{labels =} \FunctionTok{c}\NormalTok{(}\StringTok{"{-}500"}\NormalTok{, }\StringTok{"0"}\NormalTok{, }\StringTok{"500"}\NormalTok{, }\StringTok{"1,000"}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{theme\_bw}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}
    \AttributeTok{plot.margin =} \FunctionTok{unit}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{15}\NormalTok{, }\DecValTok{10}\NormalTok{, }\DecValTok{10}\NormalTok{, }\DecValTok{10}\NormalTok{), }\StringTok{"pt"}\NormalTok{),}
    \AttributeTok{panel.grid.major =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{panel.grid.minor =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{strip.background =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{panel.border =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{axis.line =} \FunctionTok{element\_line}\NormalTok{(}\AttributeTok{color =} \StringTok{"black"}\NormalTok{),}
    \AttributeTok{plot.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{hjust =} \FloatTok{0.5}\NormalTok{),}
    \AttributeTok{axis.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{),}
    \AttributeTok{axis.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{xlab}\NormalTok{(}\StringTok{"Number of variables"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{ylab}\NormalTok{(}\StringTok{"AIC"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{ggtitle}\NormalTok{(}\StringTok{""}\NormalTok{)}

\FunctionTok{cat}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"Maximum R{-}squared: "}\NormalTok{, }\FunctionTok{formatC}\NormalTok{(rsq\_vec[rsq\_cutoff], }\AttributeTok{format =} \StringTok{"f"}\NormalTok{, }\AttributeTok{digits =} \DecValTok{3}\NormalTok{), }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{))}
\FunctionTok{cat}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"R{-}squared at AIC cutoff: "}\NormalTok{, }\FunctionTok{formatC}\NormalTok{(rsq\_vec[aic\_cutoff], }\AttributeTok{format =} \StringTok{"f"}\NormalTok{, }\AttributeTok{digits =} \DecValTok{3}\NormalTok{), }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\hypertarget{generating-train-test-splits}{%
\subsection{Generating train-test splits}\label{generating-train-test-splits}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{12}\NormalTok{)}
\NormalTok{mb\_data }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\StringTok{"./data/mb\_second\_peptide\_array\_ml\_input.csv"}\NormalTok{, }\AttributeTok{check.names =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{row.names =} \DecValTok{1}\NormalTok{)}
\CommentTok{\# random shuffle}
\NormalTok{mb\_data }\OtherTok{\textless{}{-}}\NormalTok{ mb\_data[}\FunctionTok{sample}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(mb\_data), }\AttributeTok{replace =} \ConstantTok{FALSE}\NormalTok{), ]}

\NormalTok{cutoff }\OtherTok{\textless{}{-}}\NormalTok{ aic\_cutoff}
\FunctionTok{load}\NormalTok{(}\AttributeTok{file =} \StringTok{"./rdata/var\_reduct\_mb\_rf.RData"}\NormalTok{)}
\NormalTok{var\_imp }\OtherTok{\textless{}{-}}\NormalTok{ ranger}\SpecialCharTok{::}\FunctionTok{importance}\NormalTok{(rf)}
\NormalTok{var\_imp }\OtherTok{\textless{}{-}}\NormalTok{ var\_imp[}\FunctionTok{order}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{var\_imp)][}\DecValTok{1}\SpecialCharTok{:}\NormalTok{cutoff]}
\NormalTok{mb\_data }\OtherTok{\textless{}{-}}\NormalTok{ mb\_data[, }\FunctionTok{colnames}\NormalTok{(mb\_data) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\FunctionTok{names}\NormalTok{(var\_imp), }\StringTok{"log\_intensity"}\NormalTok{)]}

\NormalTok{outer\_splits }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
\NormalTok{n\_train }\OtherTok{\textless{}{-}} \FunctionTok{round}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(mb\_data) }\SpecialCharTok{*} \FloatTok{0.9}\NormalTok{)}
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{22}\NormalTok{)}
\ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{) \{}
  \CommentTok{\# random shuffle}
\NormalTok{  mb\_data\_ }\OtherTok{\textless{}{-}}\NormalTok{ mb\_data[}\FunctionTok{sample}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(mb\_data), }\AttributeTok{replace =} \ConstantTok{FALSE}\NormalTok{), ]}
\NormalTok{  outer\_train }\OtherTok{\textless{}{-}}\NormalTok{ mb\_data\_[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_train, ]}
\NormalTok{  outer\_test }\OtherTok{\textless{}{-}}\NormalTok{ mb\_data\_[(n\_train }\SpecialCharTok{+} \DecValTok{1}\NormalTok{)}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(mb\_data\_), ]}
\NormalTok{  outer\_splits }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(outer\_splits, }\FunctionTok{list}\NormalTok{(}\AttributeTok{train =}\NormalTok{ outer\_train, }\AttributeTok{test =}\NormalTok{ outer\_test))}
\NormalTok{\}}
\FunctionTok{save}\NormalTok{(mb\_data, outer\_splits, }\AttributeTok{file =} \StringTok{"./rdata/var\_reduct\_mb\_train\_test\_splits.RData"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{cell-penetration-classification}{%
\section{Cell-penetration (classification)}\label{cell-penetration-classification}}

\hypertarget{generating-ml-input-2}{%
\subsection{Generating ML input}\label{generating-ml-input-2}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{generate\_ml\_input}\NormalTok{(}
  \AttributeTok{fasta\_file =} \StringTok{"./other\_data/CPP924.fasta"}\NormalTok{,}
  \AttributeTok{label\_file =} \StringTok{"./other\_data/cpp\_labels.csv"}\NormalTok{,}
  \AttributeTok{output\_file =} \StringTok{"./data/cpp\_ml\_input.csv"}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{variable-importance-1}{%
\subsection{Variable importance}\label{variable-importance-1}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{12}\NormalTok{)}
\NormalTok{cpp\_data }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\StringTok{"./data/cpp\_ml\_input.csv"}\NormalTok{, }\AttributeTok{check.names =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{row.names =} \DecValTok{1}\NormalTok{)}
\CommentTok{\# random shuffle}
\NormalTok{cpp\_data }\OtherTok{\textless{}{-}}\NormalTok{ cpp\_data[}\FunctionTok{sample}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(cpp\_data), }\AttributeTok{replace =} \ConstantTok{FALSE}\NormalTok{), ]}

\CommentTok{\# train random forest using ranger}
\NormalTok{ntree }\OtherTok{\textless{}{-}} \DecValTok{100000}
\NormalTok{predictor\_variables }\OtherTok{\textless{}{-}} \FunctionTok{subset}\NormalTok{(cpp\_data, }\AttributeTok{select =} \SpecialCharTok{{-}}\NormalTok{category)}
\NormalTok{response\_variable }\OtherTok{\textless{}{-}} \FunctionTok{factor}\NormalTok{(cpp\_data}\SpecialCharTok{$}\NormalTok{category, }\AttributeTok{levels =} \FunctionTok{c}\NormalTok{(}\StringTok{"non{-}penetrating"}\NormalTok{, }\StringTok{"penetrating"}\NormalTok{))}
\NormalTok{rf }\OtherTok{\textless{}{-}} \FunctionTok{ranger}\NormalTok{(}
  \AttributeTok{x =}\NormalTok{ predictor\_variables, }\AttributeTok{y =}\NormalTok{ response\_variable, }\AttributeTok{num.trees =}\NormalTok{ ntree, }\AttributeTok{sample.fraction =} \FunctionTok{rep}\NormalTok{(}\FloatTok{0.5}\NormalTok{, }\DecValTok{2}\NormalTok{),}
  \AttributeTok{importance =} \StringTok{"permutation"}\NormalTok{, }\AttributeTok{verbose =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{scale.permutation.importance =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{seed =} \DecValTok{3}\NormalTok{, }\AttributeTok{keep.inbag =} \ConstantTok{TRUE}
\NormalTok{)}
\FunctionTok{save}\NormalTok{(rf, }\AttributeTok{file =} \StringTok{"./rdata/var\_reduct\_cpp\_rf.RData"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{variable-reduction-1}{%
\subsection{Variable reduction}\label{variable-reduction-1}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{load}\NormalTok{(}\AttributeTok{file =} \StringTok{"./rdata/var\_reduct\_cpp\_rf.RData"}\NormalTok{)}
\NormalTok{var\_imp }\OtherTok{\textless{}{-}}\NormalTok{ ranger}\SpecialCharTok{::}\FunctionTok{importance}\NormalTok{(rf)}
\NormalTok{var\_imp }\OtherTok{\textless{}{-}}\NormalTok{ var\_imp[}\FunctionTok{order}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{var\_imp)]}
\NormalTok{var\_imp }\OtherTok{\textless{}{-}}\NormalTok{ var\_imp[var\_imp }\SpecialCharTok{\textgreater{}=} \DecValTok{0}\NormalTok{]}

\FunctionTok{set.seed}\NormalTok{(}\DecValTok{12}\NormalTok{)}
\NormalTok{cpp\_data }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\StringTok{"./data/cpp\_ml\_input.csv"}\NormalTok{, }\AttributeTok{check.names =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{row.names =} \DecValTok{1}\NormalTok{)}
\CommentTok{\# random shuffle}
\NormalTok{cpp\_data }\OtherTok{\textless{}{-}}\NormalTok{ cpp\_data[}\FunctionTok{sample}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(cpp\_data), }\AttributeTok{replace =} \ConstantTok{FALSE}\NormalTok{), ]}

\NormalTok{ntree }\OtherTok{\textless{}{-}} \DecValTok{1000}
\NormalTok{var\_subset\_res }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
\ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(var\_imp)) \{}
  \FunctionTok{cat}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(i, }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{))}
\NormalTok{  predictor\_variables }\OtherTok{\textless{}{-}}\NormalTok{ cpp\_data[, }\FunctionTok{colnames}\NormalTok{(cpp\_data) }\SpecialCharTok{\%in\%} \FunctionTok{names}\NormalTok{(var\_imp)[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{i], drop }\OtherTok{=} \ConstantTok{FALSE}\NormalTok{]}
\NormalTok{  response\_variable }\OtherTok{\textless{}{-}} \FunctionTok{factor}\NormalTok{(cpp\_data}\SpecialCharTok{$}\NormalTok{category, }\AttributeTok{levels =} \FunctionTok{c}\NormalTok{(}\StringTok{"non{-}penetrating"}\NormalTok{, }\StringTok{"penetrating"}\NormalTok{))}
\NormalTok{  rf }\OtherTok{\textless{}{-}} \FunctionTok{ranger}\NormalTok{(}
    \AttributeTok{x =}\NormalTok{ predictor\_variables, }\AttributeTok{y =}\NormalTok{ response\_variable, }\AttributeTok{num.trees =}\NormalTok{ ntree, }\AttributeTok{importance =} \StringTok{"none"}\NormalTok{, }\AttributeTok{verbose =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{seed =} \DecValTok{3}\NormalTok{,}
    \AttributeTok{probability =} \ConstantTok{TRUE}
\NormalTok{  )}
\NormalTok{  var\_subset\_res }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(var\_subset\_res, }\FunctionTok{list}\NormalTok{(}
    \AttributeTok{acc =} \DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ rf}\SpecialCharTok{$}\NormalTok{prediction.error,}
    \AttributeTok{aic =} \FunctionTok{aic\_clf}\NormalTok{(}
      \AttributeTok{y\_true =}\NormalTok{ response\_variable,}
      \AttributeTok{y\_pred =}\NormalTok{ rf}\SpecialCharTok{$}\NormalTok{predictions,}
      \AttributeTok{k =}\NormalTok{ i}
\NormalTok{    )}
\NormalTok{  ))}
\NormalTok{\}}
\FunctionTok{save}\NormalTok{(var\_subset\_res, }\AttributeTok{file =} \StringTok{"./rdata/var\_reduct\_cpp\_var\_subset\_res.RData"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{load}\NormalTok{(}\AttributeTok{file =} \StringTok{"./rdata/var\_reduct\_cpp\_var\_subset\_res.RData"}\NormalTok{)}
\NormalTok{acc\_vec }\OtherTok{\textless{}{-}} \FunctionTok{unlist}\NormalTok{(}\FunctionTok{lapply}\NormalTok{(var\_subset\_res, }\ControlFlowTok{function}\NormalTok{(x) x}\SpecialCharTok{$}\NormalTok{acc))}
\NormalTok{aic\_vec }\OtherTok{\textless{}{-}} \FunctionTok{unlist}\NormalTok{(}\FunctionTok{lapply}\NormalTok{(var\_subset\_res, }\ControlFlowTok{function}\NormalTok{(x) x}\SpecialCharTok{$}\NormalTok{aic))}
\NormalTok{acc\_cutoff }\OtherTok{\textless{}{-}} \FunctionTok{which.max}\NormalTok{(acc\_vec)}
\NormalTok{aic\_cutoff }\OtherTok{\textless{}{-}} \FunctionTok{which.min}\NormalTok{(aic\_vec)}

\NormalTok{p2\_1 }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =} \FunctionTok{data.frame}\NormalTok{(}\AttributeTok{x =} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(acc\_vec), }\AttributeTok{y =}\NormalTok{ acc\_vec), }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{alpha =} \FloatTok{0.3}\NormalTok{, }\AttributeTok{size =} \FloatTok{0.5}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_vline}\NormalTok{(}\AttributeTok{xintercept =}\NormalTok{ acc\_cutoff, }\AttributeTok{colour =} \StringTok{"red"}\NormalTok{, }\AttributeTok{linetype =} \StringTok{"dashed"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_x\_continuous}\NormalTok{(}\AttributeTok{breaks =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, acc\_cutoff, }\DecValTok{250}\NormalTok{, }\DecValTok{500}\NormalTok{, }\DecValTok{750}\NormalTok{, }\DecValTok{955}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{scale\_y\_continuous}\NormalTok{(}
    \AttributeTok{breaks =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.88}\NormalTok{, }\FloatTok{0.90}\NormalTok{, }\FloatTok{0.92}\NormalTok{),}
    \AttributeTok{labels =} \FunctionTok{c}\NormalTok{(}\StringTok{"0.88"}\NormalTok{, }\StringTok{"0.90"}\NormalTok{, }\StringTok{"0.92"}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{theme\_bw}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}
    \AttributeTok{plot.margin =} \FunctionTok{unit}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{10}\NormalTok{, }\DecValTok{10}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{10}\NormalTok{, }\DecValTok{10}\NormalTok{), }\StringTok{"pt"}\NormalTok{),}
    \AttributeTok{panel.grid.major =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{panel.grid.minor =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{strip.background =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{panel.border =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{axis.line =} \FunctionTok{element\_line}\NormalTok{(}\AttributeTok{color =} \StringTok{"black"}\NormalTok{),}
    \AttributeTok{plot.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{hjust =} \FloatTok{0.5}\NormalTok{),}
    \AttributeTok{axis.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{),}
    \AttributeTok{axis.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{xlab}\NormalTok{(}\StringTok{""}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{ylab}\NormalTok{(}\StringTok{"Accuracy"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{ggtitle}\NormalTok{(}\StringTok{"Cell{-}penetration"}\NormalTok{)}

\NormalTok{p2\_2 }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =} \FunctionTok{data.frame}\NormalTok{(}\AttributeTok{x =} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(aic\_vec), }\AttributeTok{y =}\NormalTok{ aic\_vec), }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{alpha =} \FloatTok{0.3}\NormalTok{, }\AttributeTok{size =} \FloatTok{0.5}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_vline}\NormalTok{(}\AttributeTok{xintercept =}\NormalTok{ aic\_cutoff, }\AttributeTok{colour =} \StringTok{"red"}\NormalTok{, }\AttributeTok{linetype =} \StringTok{"dashed"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_x\_continuous}\NormalTok{(}\AttributeTok{breaks =} \FunctionTok{c}\NormalTok{(aic\_cutoff, }\DecValTok{250}\NormalTok{, }\DecValTok{500}\NormalTok{, }\DecValTok{750}\NormalTok{, }\DecValTok{955}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{scale\_y\_continuous}\NormalTok{(}
    \AttributeTok{breaks =} \FunctionTok{c}\NormalTok{(}\DecValTok{500}\NormalTok{, }\DecValTok{1000}\NormalTok{, }\DecValTok{1500}\NormalTok{, }\DecValTok{2000}\NormalTok{, }\DecValTok{2500}\NormalTok{),}
    \AttributeTok{labels =} \FunctionTok{c}\NormalTok{(}\StringTok{"500"}\NormalTok{, }\StringTok{"1,000"}\NormalTok{, }\StringTok{"1,500"}\NormalTok{, }\StringTok{"2,000"}\NormalTok{, }\StringTok{"2,500"}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{theme\_bw}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}
    \AttributeTok{plot.margin =} \FunctionTok{unit}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{15}\NormalTok{, }\DecValTok{10}\NormalTok{, }\DecValTok{10}\NormalTok{, }\DecValTok{10}\NormalTok{), }\StringTok{"pt"}\NormalTok{),}
    \AttributeTok{panel.grid.major =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{panel.grid.minor =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{strip.background =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{panel.border =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{axis.line =} \FunctionTok{element\_line}\NormalTok{(}\AttributeTok{color =} \StringTok{"black"}\NormalTok{),}
    \AttributeTok{plot.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{hjust =} \FloatTok{0.5}\NormalTok{),}
    \AttributeTok{axis.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{),}
    \AttributeTok{axis.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{xlab}\NormalTok{(}\StringTok{"Number of variables"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{ylab}\NormalTok{(}\StringTok{"AIC"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{ggtitle}\NormalTok{(}\StringTok{""}\NormalTok{)}

\FunctionTok{cat}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"Maximum accuracy: "}\NormalTok{, }\FunctionTok{formatC}\NormalTok{(acc\_vec[acc\_cutoff], }\AttributeTok{format =} \StringTok{"f"}\NormalTok{, }\AttributeTok{digits =} \DecValTok{3}\NormalTok{), }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{))}
\FunctionTok{cat}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"Accuracy at AIC cutoff: "}\NormalTok{, }\FunctionTok{formatC}\NormalTok{(acc\_vec[aic\_cutoff], }\AttributeTok{format =} \StringTok{"f"}\NormalTok{, }\AttributeTok{digits =} \DecValTok{3}\NormalTok{), }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\hypertarget{generating-train-test-splits-1}{%
\subsection{Generating train-test splits}\label{generating-train-test-splits-1}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{12}\NormalTok{)}
\NormalTok{cpp\_data }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\StringTok{"./data/cpp\_ml\_input.csv"}\NormalTok{, }\AttributeTok{check.names =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{row.names =} \DecValTok{1}\NormalTok{)}
\CommentTok{\# random shuffle}
\NormalTok{cpp\_data }\OtherTok{\textless{}{-}}\NormalTok{ cpp\_data[}\FunctionTok{sample}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(cpp\_data), }\AttributeTok{replace =} \ConstantTok{FALSE}\NormalTok{), ]}

\NormalTok{cutoff }\OtherTok{\textless{}{-}}\NormalTok{ aic\_cutoff}
\FunctionTok{load}\NormalTok{(}\AttributeTok{file =} \StringTok{"./rdata/var\_reduct\_cpp\_rf.RData"}\NormalTok{)}
\NormalTok{var\_imp }\OtherTok{\textless{}{-}}\NormalTok{ ranger}\SpecialCharTok{::}\FunctionTok{importance}\NormalTok{(rf)}
\NormalTok{var\_imp }\OtherTok{\textless{}{-}}\NormalTok{ var\_imp[}\FunctionTok{order}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{var\_imp)][}\DecValTok{1}\SpecialCharTok{:}\NormalTok{cutoff]}
\NormalTok{cpp\_data }\OtherTok{\textless{}{-}}\NormalTok{ cpp\_data[, }\FunctionTok{colnames}\NormalTok{(cpp\_data) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\FunctionTok{names}\NormalTok{(var\_imp), }\StringTok{"category"}\NormalTok{)]}

\NormalTok{outer\_splits }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
\NormalTok{n\_train }\OtherTok{\textless{}{-}} \FunctionTok{round}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(cpp\_data) }\SpecialCharTok{*} \FloatTok{0.9}\NormalTok{)}
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{22}\NormalTok{)}
\ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{) \{}
  \CommentTok{\# random shuffle}
\NormalTok{  cpp\_data\_ }\OtherTok{\textless{}{-}}\NormalTok{ cpp\_data[}\FunctionTok{sample}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(cpp\_data), }\AttributeTok{replace =} \ConstantTok{FALSE}\NormalTok{), ]}
\NormalTok{  outer\_train }\OtherTok{\textless{}{-}}\NormalTok{ cpp\_data\_[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_train, ]}
\NormalTok{  outer\_test }\OtherTok{\textless{}{-}}\NormalTok{ cpp\_data\_[(n\_train }\SpecialCharTok{+} \DecValTok{1}\NormalTok{)}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(cpp\_data\_), ]}
\NormalTok{  outer\_splits }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(outer\_splits, }\FunctionTok{list}\NormalTok{(}\AttributeTok{train =}\NormalTok{ outer\_train, }\AttributeTok{test =}\NormalTok{ outer\_test))}
\NormalTok{\}}
\FunctionTok{save}\NormalTok{(cpp\_data, outer\_splits, }\AttributeTok{file =} \StringTok{"./rdata/var\_reduct\_cpp\_train\_test\_splits.RData"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{toxicity-classification}{%
\section{Toxicity (classification)}\label{toxicity-classification}}

\hypertarget{generating-ml-input-3}{%
\subsection{Generating ML input}\label{generating-ml-input-3}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{generate\_ml\_input}\NormalTok{(}
  \AttributeTok{fasta\_file =} \StringTok{"./other\_data/toxicity.fasta"}\NormalTok{,}
  \AttributeTok{label\_file =} \StringTok{"./other\_data/tx\_labels.csv"}\NormalTok{,}
  \AttributeTok{output\_file =} \StringTok{"./data/tx\_ml\_input.csv"}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{variable-importance-2}{%
\subsection{Variable importance}\label{variable-importance-2}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{12}\NormalTok{)}
\NormalTok{tx\_data }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\StringTok{"./data/tx\_ml\_input.csv"}\NormalTok{, }\AttributeTok{check.names =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{row.names =} \DecValTok{1}\NormalTok{)}
\CommentTok{\# random shuffle}
\NormalTok{tx\_data }\OtherTok{\textless{}{-}}\NormalTok{ tx\_data[}\FunctionTok{sample}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(tx\_data), }\AttributeTok{replace =} \ConstantTok{FALSE}\NormalTok{), ]}
\CommentTok{\# train random forest using ranger}
\NormalTok{ntree }\OtherTok{\textless{}{-}} \DecValTok{100000}
\NormalTok{predictor\_variables }\OtherTok{\textless{}{-}} \FunctionTok{subset}\NormalTok{(tx\_data, }\AttributeTok{select =} \SpecialCharTok{{-}}\NormalTok{category)}
\NormalTok{response\_variable }\OtherTok{\textless{}{-}} \FunctionTok{factor}\NormalTok{(tx\_data}\SpecialCharTok{$}\NormalTok{category, }\AttributeTok{levels =} \FunctionTok{c}\NormalTok{(}\StringTok{"non{-}toxic"}\NormalTok{, }\StringTok{"toxic"}\NormalTok{))}
\NormalTok{rf }\OtherTok{\textless{}{-}} \FunctionTok{ranger}\NormalTok{(}
  \AttributeTok{x =}\NormalTok{ predictor\_variables, }\AttributeTok{y =}\NormalTok{ response\_variable, }\AttributeTok{num.trees =}\NormalTok{ ntree, }\AttributeTok{sample.fraction =} \FunctionTok{rep}\NormalTok{(}\FloatTok{0.5}\NormalTok{, }\DecValTok{2}\NormalTok{),}
  \AttributeTok{importance =} \StringTok{"permutation"}\NormalTok{, }\AttributeTok{verbose =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{scale.permutation.importance =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{seed =} \DecValTok{3}\NormalTok{, }\AttributeTok{keep.inbag =} \ConstantTok{TRUE}
\NormalTok{)}
\FunctionTok{save}\NormalTok{(rf, }\AttributeTok{file =} \StringTok{"./rdata/var\_reduct\_tx\_rf.RData"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{variable-reduction-2}{%
\subsection{Variable reduction}\label{variable-reduction-2}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{load}\NormalTok{(}\AttributeTok{file =} \StringTok{"./rdata/var\_reduct\_tx\_rf.RData"}\NormalTok{)}
\NormalTok{var\_imp }\OtherTok{\textless{}{-}}\NormalTok{ ranger}\SpecialCharTok{::}\FunctionTok{importance}\NormalTok{(rf)}
\NormalTok{var\_imp }\OtherTok{\textless{}{-}}\NormalTok{ var\_imp[}\FunctionTok{order}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{var\_imp)]}
\NormalTok{var\_imp }\OtherTok{\textless{}{-}}\NormalTok{ var\_imp[var\_imp }\SpecialCharTok{\textgreater{}=} \DecValTok{0}\NormalTok{]}

\FunctionTok{set.seed}\NormalTok{(}\DecValTok{12}\NormalTok{)}
\NormalTok{tx\_data }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\StringTok{"./data/tx\_ml\_input.csv"}\NormalTok{, }\AttributeTok{check.names =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{row.names =} \DecValTok{1}\NormalTok{)}
\CommentTok{\# random shuffle}
\NormalTok{tx\_data }\OtherTok{\textless{}{-}}\NormalTok{ tx\_data[}\FunctionTok{sample}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(tx\_data), }\AttributeTok{replace =} \ConstantTok{FALSE}\NormalTok{), ]}

\NormalTok{ntree }\OtherTok{\textless{}{-}} \DecValTok{1000}
\NormalTok{var\_subset\_res }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
\ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(var\_imp)) \{}
  \FunctionTok{cat}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(i, }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{))}
\NormalTok{  predictor\_variables }\OtherTok{\textless{}{-}}\NormalTok{ tx\_data[, }\FunctionTok{colnames}\NormalTok{(tx\_data) }\SpecialCharTok{\%in\%} \FunctionTok{names}\NormalTok{(var\_imp)[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{i], drop }\OtherTok{=} \ConstantTok{FALSE}\NormalTok{]}
\NormalTok{  response\_variable }\OtherTok{\textless{}{-}} \FunctionTok{factor}\NormalTok{(tx\_data}\SpecialCharTok{$}\NormalTok{category, }\AttributeTok{levels =} \FunctionTok{c}\NormalTok{(}\StringTok{"non{-}toxic"}\NormalTok{, }\StringTok{"toxic"}\NormalTok{))}
\NormalTok{  rf }\OtherTok{\textless{}{-}} \FunctionTok{ranger}\NormalTok{(}
    \AttributeTok{x =}\NormalTok{ predictor\_variables, }\AttributeTok{y =}\NormalTok{ response\_variable, }\AttributeTok{num.trees =}\NormalTok{ ntree, }\AttributeTok{importance =} \StringTok{"none"}\NormalTok{, }\AttributeTok{verbose =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{seed =} \DecValTok{3}\NormalTok{,}
    \AttributeTok{probability =} \ConstantTok{TRUE}
\NormalTok{  )}
\NormalTok{  var\_subset\_res }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(var\_subset\_res, }\FunctionTok{list}\NormalTok{(}
    \AttributeTok{acc =} \DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ rf}\SpecialCharTok{$}\NormalTok{prediction.error,}
    \AttributeTok{aic =} \FunctionTok{aic\_clf}\NormalTok{(}
      \AttributeTok{y\_true =}\NormalTok{ response\_variable,}
      \AttributeTok{y\_pred =}\NormalTok{ rf}\SpecialCharTok{$}\NormalTok{predictions,}
      \AttributeTok{k =}\NormalTok{ i}
\NormalTok{    )}
\NormalTok{  ))}
\NormalTok{\}}
\FunctionTok{save}\NormalTok{(var\_subset\_res, }\AttributeTok{file =} \StringTok{"./rdata/var\_reduct\_tx\_var\_subset\_res.RData"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{load}\NormalTok{(}\AttributeTok{file =} \StringTok{"./rdata/var\_reduct\_tx\_var\_subset\_res.RData"}\NormalTok{)}
\NormalTok{acc\_vec }\OtherTok{\textless{}{-}} \FunctionTok{unlist}\NormalTok{(}\FunctionTok{lapply}\NormalTok{(var\_subset\_res, }\ControlFlowTok{function}\NormalTok{(x) x}\SpecialCharTok{$}\NormalTok{acc))}
\NormalTok{aic\_vec }\OtherTok{\textless{}{-}} \FunctionTok{unlist}\NormalTok{(}\FunctionTok{lapply}\NormalTok{(var\_subset\_res, }\ControlFlowTok{function}\NormalTok{(x) x}\SpecialCharTok{$}\NormalTok{aic))}
\NormalTok{acc\_cutoff }\OtherTok{\textless{}{-}} \FunctionTok{which.max}\NormalTok{(acc\_vec)}
\NormalTok{aic\_cutoff }\OtherTok{\textless{}{-}} \FunctionTok{which.min}\NormalTok{(aic\_vec)}

\NormalTok{p3\_1 }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =} \FunctionTok{data.frame}\NormalTok{(}\AttributeTok{x =} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(acc\_vec), }\AttributeTok{y =}\NormalTok{ acc\_vec), }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{alpha =} \FloatTok{0.3}\NormalTok{, }\AttributeTok{size =} \FloatTok{0.5}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_vline}\NormalTok{(}\AttributeTok{xintercept =}\NormalTok{ acc\_cutoff, }\AttributeTok{colour =} \StringTok{"red"}\NormalTok{, }\AttributeTok{linetype =} \StringTok{"dashed"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_x\_continuous}\NormalTok{(}
    \AttributeTok{breaks =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, acc\_cutoff, }\DecValTok{300}\NormalTok{, }\DecValTok{600}\NormalTok{, }\DecValTok{900}\NormalTok{, }\DecValTok{1076}\NormalTok{),}
    \AttributeTok{labels =} \FunctionTok{c}\NormalTok{(}\StringTok{"1"}\NormalTok{, }\StringTok{"148"}\NormalTok{, }\StringTok{"300"}\NormalTok{, }\StringTok{"600"}\NormalTok{, }\StringTok{"900"}\NormalTok{, }\StringTok{"1,076"}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{scale\_y\_continuous}\NormalTok{(}
    \AttributeTok{breaks =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.91}\NormalTok{, }\FloatTok{0.92}\NormalTok{, }\FloatTok{0.93}\NormalTok{, }\FloatTok{0.94}\NormalTok{, }\FloatTok{0.95}\NormalTok{, }\FloatTok{0.96}\NormalTok{),}
    \AttributeTok{labels =} \FunctionTok{c}\NormalTok{(}\StringTok{"0.91"}\NormalTok{, }\StringTok{"0.92"}\NormalTok{, }\StringTok{"0.93"}\NormalTok{, }\StringTok{"0.94"}\NormalTok{, }\StringTok{"0.95"}\NormalTok{, }\StringTok{"0.96"}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{theme\_bw}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}
    \AttributeTok{plot.margin =} \FunctionTok{unit}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{10}\NormalTok{, }\DecValTok{10}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{10}\NormalTok{, }\DecValTok{10}\NormalTok{), }\StringTok{"pt"}\NormalTok{),}
    \AttributeTok{panel.grid.major =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{panel.grid.minor =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{strip.background =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{panel.border =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{axis.line =} \FunctionTok{element\_line}\NormalTok{(}\AttributeTok{color =} \StringTok{"black"}\NormalTok{),}
    \AttributeTok{plot.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{hjust =} \FloatTok{0.5}\NormalTok{),}
    \AttributeTok{axis.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{),}
    \AttributeTok{axis.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{xlab}\NormalTok{(}\StringTok{""}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{ylab}\NormalTok{(}\StringTok{"Accuracy"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{ggtitle}\NormalTok{(}\StringTok{"Toxicity"}\NormalTok{)}

\NormalTok{p3\_2 }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =} \FunctionTok{data.frame}\NormalTok{(}\AttributeTok{x =} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(aic\_vec), }\AttributeTok{y =}\NormalTok{ aic\_vec), }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{alpha =} \FloatTok{0.3}\NormalTok{, }\AttributeTok{size =} \FloatTok{0.5}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_vline}\NormalTok{(}\AttributeTok{xintercept =}\NormalTok{ aic\_cutoff, }\AttributeTok{colour =} \StringTok{"red"}\NormalTok{, }\AttributeTok{linetype =} \StringTok{"dashed"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_x\_continuous}\NormalTok{(}
    \AttributeTok{breaks =} \FunctionTok{c}\NormalTok{(aic\_cutoff, }\DecValTok{300}\NormalTok{, }\DecValTok{600}\NormalTok{, }\DecValTok{900}\NormalTok{, }\DecValTok{1076}\NormalTok{),}
    \AttributeTok{labels =} \FunctionTok{c}\NormalTok{(}\StringTok{"56"}\NormalTok{, }\StringTok{"300"}\NormalTok{, }\StringTok{"600"}\NormalTok{, }\StringTok{"900"}\NormalTok{, }\StringTok{"1,076"}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{scale\_y\_continuous}\NormalTok{(}
    \AttributeTok{breaks =} \FunctionTok{c}\NormalTok{(}\DecValTok{2000}\NormalTok{, }\DecValTok{3000}\NormalTok{, }\DecValTok{4000}\NormalTok{, }\DecValTok{5000}\NormalTok{, }\DecValTok{6000}\NormalTok{, }\DecValTok{7000}\NormalTok{),}
    \AttributeTok{labels =} \FunctionTok{c}\NormalTok{(}\StringTok{"2,000"}\NormalTok{, }\StringTok{"3,000"}\NormalTok{, }\StringTok{"4,000"}\NormalTok{, }\StringTok{"5,000"}\NormalTok{, }\StringTok{"6,000"}\NormalTok{, }\StringTok{"7,000"}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{theme\_bw}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}
    \AttributeTok{plot.margin =} \FunctionTok{unit}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{15}\NormalTok{, }\DecValTok{10}\NormalTok{, }\DecValTok{10}\NormalTok{, }\DecValTok{10}\NormalTok{), }\StringTok{"pt"}\NormalTok{),}
    \AttributeTok{panel.grid.major =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{panel.grid.minor =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{strip.background =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{panel.border =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{axis.line =} \FunctionTok{element\_line}\NormalTok{(}\AttributeTok{color =} \StringTok{"black"}\NormalTok{),}
    \AttributeTok{plot.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{hjust =} \FloatTok{0.5}\NormalTok{),}
    \AttributeTok{axis.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{),}
    \AttributeTok{axis.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{xlab}\NormalTok{(}\StringTok{"Number of variables"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{ylab}\NormalTok{(}\StringTok{"AIC"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{ggtitle}\NormalTok{(}\StringTok{""}\NormalTok{)}

\FunctionTok{cat}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"Maximum accuracy: "}\NormalTok{, }\FunctionTok{formatC}\NormalTok{(acc\_vec[acc\_cutoff], }\AttributeTok{format =} \StringTok{"f"}\NormalTok{, }\AttributeTok{digits =} \DecValTok{3}\NormalTok{), }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{))}
\FunctionTok{cat}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"Accuracy at AIC cutoff: "}\NormalTok{, }\FunctionTok{formatC}\NormalTok{(acc\_vec[aic\_cutoff], }\AttributeTok{format =} \StringTok{"f"}\NormalTok{, }\AttributeTok{digits =} \DecValTok{3}\NormalTok{), }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\hypertarget{generating-train-test-splits-2}{%
\subsection{Generating train-test splits}\label{generating-train-test-splits-2}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{12}\NormalTok{)}
\NormalTok{tx\_data }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\StringTok{"./data/tx\_ml\_input.csv"}\NormalTok{, }\AttributeTok{check.names =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{row.names =} \DecValTok{1}\NormalTok{)}
\CommentTok{\# random shuffle}
\NormalTok{tx\_data }\OtherTok{\textless{}{-}}\NormalTok{ tx\_data[}\FunctionTok{sample}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(tx\_data), }\AttributeTok{replace =} \ConstantTok{FALSE}\NormalTok{), ]}
\CommentTok{\# convert category so that positive class represents non{-}toxic}
\CommentTok{\# for evaluation metrics that focus on true positives more than}
\CommentTok{\# true negatives}
\NormalTok{tx\_data}\SpecialCharTok{$}\NormalTok{category }\OtherTok{\textless{}{-}} \FunctionTok{as.factor}\NormalTok{(}\FunctionTok{sapply}\NormalTok{(tx\_data}\SpecialCharTok{$}\NormalTok{category, }\ControlFlowTok{function}\NormalTok{(x) }\ControlFlowTok{if}\NormalTok{ (x }\SpecialCharTok{==} \StringTok{"non{-}toxic"}\NormalTok{) }\DecValTok{1} \ControlFlowTok{else} \DecValTok{0}\NormalTok{))}

\NormalTok{cutoff }\OtherTok{\textless{}{-}}\NormalTok{ aic\_cutoff}
\FunctionTok{load}\NormalTok{(}\AttributeTok{file =} \StringTok{"./rdata/var\_reduct\_tx\_rf.RData"}\NormalTok{)}
\NormalTok{var\_imp }\OtherTok{\textless{}{-}}\NormalTok{ ranger}\SpecialCharTok{::}\FunctionTok{importance}\NormalTok{(rf)}
\NormalTok{var\_imp }\OtherTok{\textless{}{-}}\NormalTok{ var\_imp[}\FunctionTok{order}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{var\_imp)][}\DecValTok{1}\SpecialCharTok{:}\NormalTok{cutoff]}
\NormalTok{tx\_data }\OtherTok{\textless{}{-}}\NormalTok{ tx\_data[, }\FunctionTok{colnames}\NormalTok{(tx\_data) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\FunctionTok{names}\NormalTok{(var\_imp), }\StringTok{"category"}\NormalTok{)]}

\NormalTok{outer\_splits }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
\NormalTok{n\_train }\OtherTok{\textless{}{-}} \FunctionTok{round}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(tx\_data) }\SpecialCharTok{*} \FloatTok{0.9}\NormalTok{)}
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{22}\NormalTok{)}
\ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{) \{}
  \CommentTok{\# random shuffle}
\NormalTok{  tx\_data\_ }\OtherTok{\textless{}{-}}\NormalTok{ tx\_data[}\FunctionTok{sample}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(tx\_data), }\AttributeTok{replace =} \ConstantTok{FALSE}\NormalTok{), ]}
\NormalTok{  outer\_train }\OtherTok{\textless{}{-}}\NormalTok{ tx\_data\_[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{n\_train, ]}
\NormalTok{  outer\_test }\OtherTok{\textless{}{-}}\NormalTok{ tx\_data\_[(n\_train }\SpecialCharTok{+} \DecValTok{1}\NormalTok{)}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(tx\_data\_), ]}
\NormalTok{  outer\_splits }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(outer\_splits, }\FunctionTok{list}\NormalTok{(}\AttributeTok{train =}\NormalTok{ outer\_train, }\AttributeTok{test =}\NormalTok{ outer\_test))}
\NormalTok{\}}
\FunctionTok{save}\NormalTok{(tx\_data, outer\_splits, }\AttributeTok{file =} \StringTok{"./rdata/var\_reduct\_tx\_train\_test\_splits.RData"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{plotting}{%
\section{Plotting}\label{plotting}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{p\_combined }\OtherTok{\textless{}{-}} \FunctionTok{plot\_grid}\NormalTok{(p1\_1, p2\_1, p3\_1,}
\NormalTok{  p1\_2, p2\_2, p3\_2,}
  \AttributeTok{nrow =} \DecValTok{2}\NormalTok{,}
  \AttributeTok{labels =} \FunctionTok{c}\NormalTok{(}\StringTok{"a"}\NormalTok{, }\StringTok{"b"}\NormalTok{, }\StringTok{"c"}\NormalTok{, }\StringTok{""}\NormalTok{, }\StringTok{""}\NormalTok{, }\StringTok{""}\NormalTok{),}
  \AttributeTok{align =} \StringTok{"v"}
\NormalTok{)}
\NormalTok{p\_combined}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics[width=1\linewidth]{./figures/Supplementary Fig 3 var reduct} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sessionInfo}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## R version 4.2.2 (2022-10-31)
## Platform: x86_64-apple-darwin17.0 (64-bit)
## Running under: macOS Big Sur ... 10.16
## 
## Matrix products: default
## BLAS:   /Library/Frameworks/R.framework/Versions/4.2/Resources/lib/libRblas.0.dylib
## LAPACK: /Library/Frameworks/R.framework/Versions/4.2/Resources/lib/libRlapack.dylib
## 
## locale:
## [1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8
## 
## attached base packages:
## [1] stats     graphics  grDevices utils     datasets  methods   base     
## 
## other attached packages:
## [1] scales_1.2.1   cowplot_1.1.1  ggplot2_3.3.6  ranger_0.14.1  rlist_0.4.6.2 
## [6] protr_1.6-2    Peptides_2.4.4
## 
## loaded via a namespace (and not attached):
##  [1] Rcpp_1.0.9        pillar_1.8.1      compiler_4.2.2    R.methodsS3_1.8.2
##  [5] R.utils_2.12.0    tools_4.2.2       digest_0.6.29     tibble_3.1.8     
##  [9] evaluate_0.16     lifecycle_1.0.1   gtable_0.3.0      R.cache_0.16.0   
## [13] lattice_0.20-45   pkgconfig_2.0.3   rlang_1.0.4       Matrix_1.5-1     
## [17] DBI_1.1.3         cli_3.3.0         rstudioapi_0.14   yaml_2.3.5       
## [21] xfun_0.32         fastmap_1.1.0     withr_2.5.0       dplyr_1.0.9      
## [25] styler_1.8.0      stringr_1.4.1     knitr_1.40        generics_0.1.3   
## [29] vctrs_0.4.1       tidyselect_1.1.2  grid_4.2.2        glue_1.6.2       
## [33] data.table_1.14.2 R6_2.5.1          fansi_1.0.3       rmarkdown_2.16   
## [37] bookdown_0.28     purrr_0.3.4       magrittr_2.0.3    codetools_0.2-18 
## [41] htmltools_0.5.3   assertthat_0.2.1  colorspace_2.0-3  utf8_1.2.2       
## [45] stringi_1.7.8     munsell_0.5.0     R.oo_1.25.0
\end{verbatim}

\hypertarget{03_model_training}{%
\chapter{Model training}\label{03_model_training}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(h2o)}
\FunctionTok{library}\NormalTok{(MLmetrics)}
\FunctionTok{library}\NormalTok{(mltools)}
\FunctionTok{library}\NormalTok{(scales)}
\FunctionTok{library}\NormalTok{(enrichvs)}
\FunctionTok{library}\NormalTok{(rlist)}
\FunctionTok{library}\NormalTok{(stringr)}
\FunctionTok{library}\NormalTok{(digest)}
\FunctionTok{library}\NormalTok{(DT)}
\FunctionTok{library}\NormalTok{(reshape2)}
\end{Highlighting}
\end{Shaded}

\hypertarget{overview-1}{%
\section{Overview}\label{overview-1}}

\begin{center}\includegraphics[width=1\linewidth]{./figures/nested_cross_validation} \end{center}

\hypertarget{general-codefunctions}{%
\section{General code/functions}\label{general-codefunctions}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# h2o.init(nthreads={-}1, max\_mem\_size=\textquotesingle{}100G\textquotesingle{}, port=54321)}
\FunctionTok{h2o.init}\NormalTok{(}\AttributeTok{nthreads =} \SpecialCharTok{{-}}\DecValTok{1}\NormalTok{)}
\FunctionTok{h2o.removeAll}\NormalTok{()}
\CommentTok{\# DeepLearning Grid 1}
\NormalTok{deeplearning\_params\_1 }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}
  \AttributeTok{activation =} \StringTok{"RectifierWithDropout"}\NormalTok{,}
  \AttributeTok{epochs =} \DecValTok{10000}\NormalTok{, }\CommentTok{\# early stopping}
  \AttributeTok{epsilon =} \FunctionTok{c}\NormalTok{(}\FloatTok{1e{-}6}\NormalTok{, }\FloatTok{1e{-}7}\NormalTok{, }\FloatTok{1e{-}8}\NormalTok{, }\FloatTok{1e{-}9}\NormalTok{),}
  \AttributeTok{hidden =} \FunctionTok{list}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{50}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\DecValTok{200}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\DecValTok{500}\NormalTok{)),}
  \AttributeTok{hidden\_dropout\_ratios =} \FunctionTok{list}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\FloatTok{0.1}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\FloatTok{0.2}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\FloatTok{0.3}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\FloatTok{0.4}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\FloatTok{0.5}\NormalTok{)),}
  \AttributeTok{input\_dropout\_ratio =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FloatTok{0.05}\NormalTok{, }\FloatTok{0.1}\NormalTok{, }\FloatTok{0.15}\NormalTok{, }\FloatTok{0.2}\NormalTok{),}
  \AttributeTok{rho =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.9}\NormalTok{, }\FloatTok{0.95}\NormalTok{, }\FloatTok{0.99}\NormalTok{)}
\NormalTok{)}
\CommentTok{\# DeepLearning Grid 2}
\NormalTok{deeplearning\_params\_2 }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}
  \AttributeTok{activation =} \StringTok{"RectifierWithDropout"}\NormalTok{,}
  \AttributeTok{epochs =} \DecValTok{10000}\NormalTok{, }\CommentTok{\# early stopping}
  \AttributeTok{epsilon =} \FunctionTok{c}\NormalTok{(}\FloatTok{1e{-}6}\NormalTok{, }\FloatTok{1e{-}7}\NormalTok{, }\FloatTok{1e{-}8}\NormalTok{, }\FloatTok{1e{-}9}\NormalTok{),}
  \AttributeTok{hidden =} \FunctionTok{list}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{50}\NormalTok{, }\DecValTok{50}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\DecValTok{200}\NormalTok{, }\DecValTok{200}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\DecValTok{500}\NormalTok{, }\DecValTok{500}\NormalTok{)),}
  \AttributeTok{hidden\_dropout\_ratios =} \FunctionTok{list}\NormalTok{(}
    \FunctionTok{c}\NormalTok{(}\FloatTok{0.1}\NormalTok{, }\FloatTok{0.1}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\FloatTok{0.2}\NormalTok{, }\FloatTok{0.2}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\FloatTok{0.3}\NormalTok{, }\FloatTok{0.3}\NormalTok{),}
    \FunctionTok{c}\NormalTok{(}\FloatTok{0.4}\NormalTok{, }\FloatTok{0.4}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\FloatTok{0.5}\NormalTok{, }\FloatTok{0.5}\NormalTok{)}
\NormalTok{  ),}
  \AttributeTok{input\_dropout\_ratio =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FloatTok{0.05}\NormalTok{, }\FloatTok{0.1}\NormalTok{, }\FloatTok{0.15}\NormalTok{, }\FloatTok{0.2}\NormalTok{),}
  \AttributeTok{rho =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.9}\NormalTok{, }\FloatTok{0.95}\NormalTok{, }\FloatTok{0.99}\NormalTok{)}
\NormalTok{)}
\CommentTok{\# DeepLearning Grid 3}
\NormalTok{deeplearning\_params\_3 }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}
  \AttributeTok{activation =} \StringTok{"RectifierWithDropout"}\NormalTok{,}
  \AttributeTok{epochs =} \DecValTok{10000}\NormalTok{, }\CommentTok{\# early stopping}
  \AttributeTok{epsilon =} \FunctionTok{c}\NormalTok{(}\FloatTok{1e{-}6}\NormalTok{, }\FloatTok{1e{-}7}\NormalTok{, }\FloatTok{1e{-}8}\NormalTok{, }\FloatTok{1e{-}9}\NormalTok{),}
  \AttributeTok{hidden =} \FunctionTok{list}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{50}\NormalTok{, }\DecValTok{50}\NormalTok{, }\DecValTok{50}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\DecValTok{200}\NormalTok{, }\DecValTok{200}\NormalTok{, }\DecValTok{200}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\DecValTok{500}\NormalTok{, }\DecValTok{500}\NormalTok{, }\DecValTok{500}\NormalTok{)),}
  \AttributeTok{hidden\_dropout\_ratios =} \FunctionTok{list}\NormalTok{(}
    \FunctionTok{c}\NormalTok{(}\FloatTok{0.1}\NormalTok{, }\FloatTok{0.1}\NormalTok{, }\FloatTok{0.1}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\FloatTok{0.2}\NormalTok{, }\FloatTok{0.2}\NormalTok{, }\FloatTok{0.2}\NormalTok{),}
    \FunctionTok{c}\NormalTok{(}\FloatTok{0.3}\NormalTok{, }\FloatTok{0.3}\NormalTok{, }\FloatTok{0.3}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\FloatTok{0.4}\NormalTok{, }\FloatTok{0.4}\NormalTok{, }\FloatTok{0.4}\NormalTok{),}
    \FunctionTok{c}\NormalTok{(}\FloatTok{0.5}\NormalTok{, }\FloatTok{0.5}\NormalTok{, }\FloatTok{0.5}\NormalTok{)}
\NormalTok{  ),}
  \AttributeTok{input\_dropout\_ratio =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FloatTok{0.05}\NormalTok{, }\FloatTok{0.1}\NormalTok{, }\FloatTok{0.15}\NormalTok{, }\FloatTok{0.2}\NormalTok{),}
  \AttributeTok{rho =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.9}\NormalTok{, }\FloatTok{0.95}\NormalTok{, }\FloatTok{0.99}\NormalTok{)}
\NormalTok{)}
\CommentTok{\# GBM}
\NormalTok{gbm\_params }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}
  \AttributeTok{col\_sample\_rate =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.4}\NormalTok{, }\FloatTok{0.7}\NormalTok{, }\FloatTok{1.0}\NormalTok{),}
  \AttributeTok{col\_sample\_rate\_per\_tree =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.4}\NormalTok{, }\FloatTok{0.7}\NormalTok{, }\FloatTok{1.0}\NormalTok{),}
  \AttributeTok{learn\_rate =} \FloatTok{0.1}\NormalTok{,}
  \AttributeTok{max\_depth =} \FunctionTok{c}\NormalTok{(}\DecValTok{3}\NormalTok{, }\DecValTok{4}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{6}\NormalTok{, }\DecValTok{7}\NormalTok{, }\DecValTok{8}\NormalTok{, }\DecValTok{9}\NormalTok{, }\DecValTok{10}\NormalTok{, }\DecValTok{11}\NormalTok{, }\DecValTok{12}\NormalTok{, }\DecValTok{13}\NormalTok{, }\DecValTok{14}\NormalTok{, }\DecValTok{15}\NormalTok{, }\DecValTok{16}\NormalTok{, }\DecValTok{17}\NormalTok{),}
  \AttributeTok{min\_rows =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{10}\NormalTok{, }\DecValTok{15}\NormalTok{, }\DecValTok{30}\NormalTok{, }\DecValTok{100}\NormalTok{),}
  \AttributeTok{min\_split\_improvement =} \FunctionTok{c}\NormalTok{(}\FloatTok{1e{-}4}\NormalTok{, }\FloatTok{1e{-}5}\NormalTok{),}
  \AttributeTok{ntrees =} \DecValTok{10000}\NormalTok{, }\CommentTok{\# early stopping}
  \AttributeTok{sample\_rate =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.5}\NormalTok{, }\FloatTok{0.6}\NormalTok{, }\FloatTok{0.7}\NormalTok{, }\FloatTok{0.8}\NormalTok{, }\FloatTok{0.9}\NormalTok{, }\FloatTok{1.0}\NormalTok{)}
\NormalTok{)}
\CommentTok{\# XGBoost}
\NormalTok{xgboost\_params }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}
  \AttributeTok{booster =} \FunctionTok{c}\NormalTok{(}\StringTok{"gbtree"}\NormalTok{, }\StringTok{"dart"}\NormalTok{),}
  \AttributeTok{col\_sample\_rate =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.6}\NormalTok{, }\FloatTok{0.8}\NormalTok{, }\FloatTok{1.0}\NormalTok{),}
  \AttributeTok{col\_sample\_rate\_per\_tree =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.7}\NormalTok{, }\FloatTok{0.8}\NormalTok{, }\FloatTok{0.9}\NormalTok{, }\FloatTok{1.0}\NormalTok{),}
  \AttributeTok{max\_depth =} \FunctionTok{c}\NormalTok{(}\DecValTok{5}\NormalTok{, }\DecValTok{10}\NormalTok{, }\DecValTok{15}\NormalTok{, }\DecValTok{20}\NormalTok{),}
  \AttributeTok{min\_rows =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.01}\NormalTok{, }\FloatTok{0.1}\NormalTok{, }\FloatTok{1.0}\NormalTok{, }\FloatTok{3.0}\NormalTok{, }\FloatTok{5.0}\NormalTok{, }\FloatTok{10.0}\NormalTok{, }\FloatTok{15.0}\NormalTok{, }\FloatTok{20.0}\NormalTok{),}
  \AttributeTok{ntrees =} \DecValTok{10000}\NormalTok{, }\CommentTok{\# early stopping}
  \AttributeTok{reg\_alpha =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.001}\NormalTok{, }\FloatTok{0.01}\NormalTok{, }\FloatTok{0.1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{10}\NormalTok{, }\DecValTok{100}\NormalTok{),}
  \AttributeTok{reg\_lambda =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.001}\NormalTok{, }\FloatTok{0.01}\NormalTok{, }\FloatTok{0.1}\NormalTok{, }\FloatTok{0.5}\NormalTok{, }\DecValTok{1}\NormalTok{),}
  \AttributeTok{sample\_rate =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.6}\NormalTok{, }\FloatTok{0.8}\NormalTok{, }\FloatTok{1.0}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{balanced\_accuracy }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(y\_pred, y\_true) \{}
  \FunctionTok{return}\NormalTok{(}\FunctionTok{mean}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\FunctionTok{Sensitivity}\NormalTok{(y\_pred, y\_true), }\FunctionTok{Specificity}\NormalTok{(y\_pred, y\_true)), }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{))}
\NormalTok{\}}

\NormalTok{sem }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{) }\FunctionTok{sd}\NormalTok{(x, na.rm) }\SpecialCharTok{/} \FunctionTok{sqrt}\NormalTok{(}\FunctionTok{length}\NormalTok{(}\FunctionTok{na.omit}\NormalTok{(x)))}

\NormalTok{statistical\_testing }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(data, metric\_vec, decreasing\_vec, }\AttributeTok{p\_value\_threshold =} \FloatTok{0.05}\NormalTok{, }\AttributeTok{num\_entries =} \DecValTok{10}\NormalTok{,}
                                \AttributeTok{output\_path =} \ConstantTok{NULL}\NormalTok{) \{}
  \ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(metric\_vec)) \{}
\NormalTok{    metric }\OtherTok{\textless{}{-}}\NormalTok{ metric\_vec[i]}
\NormalTok{    ranked\_models }\OtherTok{\textless{}{-}} \FunctionTok{rownames}\NormalTok{(data[}\FunctionTok{order}\NormalTok{(data[, }\FunctionTok{paste}\NormalTok{(metric, }\StringTok{"mean"}\NormalTok{)], }\AttributeTok{decreasing =}\NormalTok{ decreasing\_vec[i]), ])}
\NormalTok{    pval }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
    \ControlFlowTok{for}\NormalTok{ (j }\ControlFlowTok{in} \DecValTok{2}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(ranked\_models)) \{}
      \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{sum}\NormalTok{(}\FunctionTok{is.na}\NormalTok{(data[ranked\_models[j], }\FunctionTok{paste}\NormalTok{(metric, }\StringTok{"CV"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{)]))) \{}
\NormalTok{        pval }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(pval, }\ConstantTok{NA}\NormalTok{)}
\NormalTok{      \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{        pval }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(pval, }\FunctionTok{wilcox.test}\NormalTok{(}\FunctionTok{as.numeric}\NormalTok{(data[ranked\_models[}\DecValTok{1}\NormalTok{], }\FunctionTok{paste}\NormalTok{(metric, }\StringTok{"CV"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{)]),}
          \FunctionTok{as.numeric}\NormalTok{(data[ranked\_models[j], }\FunctionTok{paste}\NormalTok{(metric, }\StringTok{"CV"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{)]),}
          \AttributeTok{exact =} \ConstantTok{FALSE}
\NormalTok{        )}\SpecialCharTok{$}\NormalTok{p.value)}
\NormalTok{      \}}
\NormalTok{    \}}
\NormalTok{    adj\_pval }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\ConstantTok{NA}\NormalTok{, }\FunctionTok{p.adjust}\NormalTok{(pval, }\AttributeTok{method =} \StringTok{"BH"}\NormalTok{, }\AttributeTok{n =} \FunctionTok{length}\NormalTok{(pval)))}
\NormalTok{    df }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(adj\_pval)}
    \FunctionTok{rownames}\NormalTok{(df) }\OtherTok{\textless{}{-}}\NormalTok{ ranked\_models}
    \FunctionTok{colnames}\NormalTok{(df) }\OtherTok{\textless{}{-}} \FunctionTok{paste}\NormalTok{(metric, }\StringTok{"adj. \textless{}i\textgreater{}p\textless{}/i\textgreater{} value"}\NormalTok{)}
\NormalTok{    data }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(data, df, }\AttributeTok{by =} \StringTok{"row.names"}\NormalTok{, }\AttributeTok{all =} \ConstantTok{TRUE}\NormalTok{)}
    \FunctionTok{rownames}\NormalTok{(data) }\OtherTok{\textless{}{-}}\NormalTok{ data}\SpecialCharTok{$}\NormalTok{Row.names}
\NormalTok{    data}\SpecialCharTok{$}\NormalTok{Row.names }\OtherTok{\textless{}{-}} \ConstantTok{NULL}
\NormalTok{  \}}
  \ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(metric\_vec)) \{}
    \ControlFlowTok{if}\NormalTok{ (decreasing\_vec[i]) \{}
\NormalTok{      data[}\FunctionTok{paste}\NormalTok{(metric\_vec[i], }\StringTok{"rank"}\NormalTok{)] }\OtherTok{\textless{}{-}} \FunctionTok{rank}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{data[, }\FunctionTok{paste}\NormalTok{(metric\_vec[i], }\StringTok{"mean"}\NormalTok{)], }\AttributeTok{ties.method =} \StringTok{"average"}\NormalTok{)}
\NormalTok{    \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{      data[}\FunctionTok{paste}\NormalTok{(metric\_vec[i], }\StringTok{"rank"}\NormalTok{)] }\OtherTok{\textless{}{-}} \FunctionTok{rank}\NormalTok{(data[, }\FunctionTok{paste}\NormalTok{(metric\_vec[i], }\StringTok{"mean"}\NormalTok{)], }\AttributeTok{ties.method =} \StringTok{"average"}\NormalTok{)}
\NormalTok{    \}}
\NormalTok{  \}}
\NormalTok{  data[}\StringTok{"Rank sum"}\NormalTok{] }\OtherTok{\textless{}{-}} \FunctionTok{rowSums}\NormalTok{(data[(}\FunctionTok{ncol}\NormalTok{(data) }\SpecialCharTok{{-}} \FunctionTok{length}\NormalTok{(metric\_vec) }\SpecialCharTok{+} \DecValTok{1}\NormalTok{)}\SpecialCharTok{:}\FunctionTok{ncol}\NormalTok{(data)])}
\NormalTok{  data }\OtherTok{\textless{}{-}}\NormalTok{ data[}\FunctionTok{order}\NormalTok{(data}\SpecialCharTok{$}\StringTok{\textasciigrave{}}\AttributeTok{Rank sum}\StringTok{\textasciigrave{}}\NormalTok{), ]}
\NormalTok{  competitive }\OtherTok{\textless{}{-}} \FunctionTok{rowSums}\NormalTok{(data[}\FunctionTok{paste}\NormalTok{(metric\_vec, }\StringTok{"adj. \textless{}i\textgreater{}p\textless{}/i\textgreater{} value"}\NormalTok{)] }\SpecialCharTok{\textless{}}\NormalTok{ p\_value\_threshold) }\SpecialCharTok{==} \DecValTok{0}
\NormalTok{  competitive[}\FunctionTok{is.na}\NormalTok{(competitive)] }\OtherTok{\textless{}{-}} \ConstantTok{TRUE}
\NormalTok{  data }\OtherTok{\textless{}{-}}\NormalTok{ data[competitive, ]}
  \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{is.null}\NormalTok{(output\_path)) \{}
\NormalTok{    data[}\FunctionTok{c}\NormalTok{(}
      \FunctionTok{paste}\NormalTok{(metric\_vec, }\StringTok{"adj. \textless{}i\textgreater{}p\textless{}/i\textgreater{} value"}\NormalTok{), }\FunctionTok{paste}\NormalTok{(metric\_vec, }\StringTok{"rank"}\NormalTok{), }\StringTok{"Rank sum"}\NormalTok{,}
      \FunctionTok{melt}\NormalTok{(}\FunctionTok{sapply}\NormalTok{(metric\_vec, }\ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{paste}\NormalTok{(x, }\FunctionTok{c}\NormalTok{(}\StringTok{"mean"}\NormalTok{, }\StringTok{"s.e.m."}\NormalTok{))))}\SpecialCharTok{$}\NormalTok{value}
\NormalTok{    )] }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{round}\NormalTok{(}\AttributeTok{digits =} \DecValTok{4}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{write.csv}\NormalTok{(., }\AttributeTok{file =}\NormalTok{ output\_path)}
\NormalTok{  \}}
\NormalTok{  data[}\FunctionTok{c}\NormalTok{(}\FunctionTok{paste}\NormalTok{(metric\_vec, }\StringTok{"adj. \textless{}i\textgreater{}p\textless{}/i\textgreater{} value"}\NormalTok{), }\FunctionTok{paste}\NormalTok{(metric\_vec, }\StringTok{"rank"}\NormalTok{), }\StringTok{"Rank sum"}\NormalTok{)] }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{round}\NormalTok{(}\AttributeTok{digits =} \DecValTok{4}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{datatable}\NormalTok{(}\AttributeTok{options =} \FunctionTok{list}\NormalTok{(}\AttributeTok{pageLength =}\NormalTok{ num\_entries), }\AttributeTok{escape =} \ConstantTok{FALSE}\NormalTok{)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\hypertarget{melanin-binding-regression-1}{%
\section{Melanin binding (regression)}\label{melanin-binding-regression-1}}

\hypertarget{model-training}{%
\subsection{Model training}\label{model-training}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{train\_mb\_models }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(train\_set, exp\_dir, prefix, }\AttributeTok{nfolds =} \DecValTok{10}\NormalTok{, }\AttributeTok{grid\_seed =} \DecValTok{1}\NormalTok{) \{}
\NormalTok{  tmp }\OtherTok{\textless{}{-}} \FunctionTok{as.h2o}\NormalTok{(train\_set, }\AttributeTok{destination\_frame =}\NormalTok{ prefix)}
\NormalTok{  y }\OtherTok{\textless{}{-}} \StringTok{"log\_intensity"}
\NormalTok{  x }\OtherTok{\textless{}{-}} \FunctionTok{setdiff}\NormalTok{(}\FunctionTok{names}\NormalTok{(tmp), y)}
\NormalTok{  res }\OtherTok{\textless{}{-}} \FunctionTok{as.data.frame}\NormalTok{(tmp}\SpecialCharTok{$}\NormalTok{log\_intensity)}
  \CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
  \CommentTok{\# base model training}
  \CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"Deep learning grid 1}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  deeplearning\_1 }\OtherTok{\textless{}{-}} \FunctionTok{h2o.grid}\NormalTok{(}
    \AttributeTok{algorithm =} \StringTok{"deeplearning"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{hyper\_params =}\NormalTok{ deeplearning\_params\_1,}
    \AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{, }\AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{,}
    \AttributeTok{search\_criteria =} \FunctionTok{list}\NormalTok{(}
      \AttributeTok{strategy =} \StringTok{"RandomDiscrete"}\NormalTok{,}
      \AttributeTok{max\_models =} \DecValTok{100}\NormalTok{, }\AttributeTok{seed =}\NormalTok{ grid\_seed}
\NormalTok{    ),}
    \AttributeTok{fold\_assignment =} \StringTok{"Modulo"}\NormalTok{, }\AttributeTok{parallelism =} \DecValTok{0}
\NormalTok{  )}
  \ControlFlowTok{for}\NormalTok{ (model\_id }\ControlFlowTok{in}\NormalTok{ deeplearning\_1}\SpecialCharTok{@}\NormalTok{model\_ids) \{}
\NormalTok{    tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(model\_id), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  \}}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"Deep learning grid 2}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  deeplearning\_2 }\OtherTok{\textless{}{-}} \FunctionTok{h2o.grid}\NormalTok{(}
    \AttributeTok{algorithm =} \StringTok{"deeplearning"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{hyper\_params =}\NormalTok{ deeplearning\_params\_2,}
    \AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{, }\AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{,}
    \AttributeTok{search\_criteria =} \FunctionTok{list}\NormalTok{(}
      \AttributeTok{strategy =} \StringTok{"RandomDiscrete"}\NormalTok{,}
      \AttributeTok{max\_models =} \DecValTok{100}\NormalTok{, }\AttributeTok{seed =}\NormalTok{ grid\_seed}
\NormalTok{    ),}
    \AttributeTok{fold\_assignment =} \StringTok{"Modulo"}\NormalTok{, }\AttributeTok{parallelism =} \DecValTok{0}
\NormalTok{  )}
  \ControlFlowTok{for}\NormalTok{ (model\_id }\ControlFlowTok{in}\NormalTok{ deeplearning\_2}\SpecialCharTok{@}\NormalTok{model\_ids) \{}
\NormalTok{    tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(model\_id), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  \}}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"Deep learning grid 3}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  deeplearning\_3 }\OtherTok{\textless{}{-}} \FunctionTok{h2o.grid}\NormalTok{(}
    \AttributeTok{algorithm =} \StringTok{"deeplearning"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{hyper\_params =}\NormalTok{ deeplearning\_params\_3,}
    \AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{, }\AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{,}
    \AttributeTok{search\_criteria =} \FunctionTok{list}\NormalTok{(}
      \AttributeTok{strategy =} \StringTok{"RandomDiscrete"}\NormalTok{,}
      \AttributeTok{max\_models =} \DecValTok{100}\NormalTok{, }\AttributeTok{seed =}\NormalTok{ grid\_seed}
\NormalTok{    ),}
    \AttributeTok{fold\_assignment =} \StringTok{"Modulo"}\NormalTok{, }\AttributeTok{parallelism =} \DecValTok{0}
\NormalTok{  )}
  \ControlFlowTok{for}\NormalTok{ (model\_id }\ControlFlowTok{in}\NormalTok{ deeplearning\_3}\SpecialCharTok{@}\NormalTok{model\_ids) \{}
\NormalTok{    tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(model\_id), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  \}}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"GBM grid}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  gbm }\OtherTok{\textless{}{-}} \FunctionTok{h2o.grid}\NormalTok{(}
    \AttributeTok{algorithm =} \StringTok{"gbm"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{hyper\_params =}\NormalTok{ gbm\_params, }\AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{,}
    \AttributeTok{search\_criteria =} \FunctionTok{list}\NormalTok{(}\AttributeTok{strategy =} \StringTok{"RandomDiscrete"}\NormalTok{, }\AttributeTok{max\_models =} \DecValTok{300}\NormalTok{, }\AttributeTok{seed =}\NormalTok{ grid\_seed),}
    \AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}\NormalTok{, }\AttributeTok{parallelism =} \DecValTok{0}
\NormalTok{  )}
  \ControlFlowTok{for}\NormalTok{ (model\_id }\ControlFlowTok{in}\NormalTok{ gbm}\SpecialCharTok{@}\NormalTok{model\_ids) \{}
\NormalTok{    tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(model\_id), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  \}}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"GBM 5 default models}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  gbm\_1 }\OtherTok{\textless{}{-}} \FunctionTok{h2o.gbm}\NormalTok{(}
    \AttributeTok{model\_id =} \StringTok{"GBM\_1"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{, }\AttributeTok{score\_tree\_interval =} \DecValTok{5}\NormalTok{,}
    \AttributeTok{col\_sample\_rate =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{col\_sample\_rate\_per\_tree =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{learn\_rate =} \FloatTok{0.1}\NormalTok{,}
    \AttributeTok{max\_depth =} \DecValTok{6}\NormalTok{, }\AttributeTok{min\_rows =} \DecValTok{1}\NormalTok{, }\AttributeTok{min\_split\_improvement =} \FloatTok{1e{-}5}\NormalTok{, }\AttributeTok{ntrees =} \DecValTok{10000}\NormalTok{, }\AttributeTok{sample\_rate =} \FloatTok{0.8}\NormalTok{,}
    \AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}
\NormalTok{  )}
\NormalTok{  gbm\_2 }\OtherTok{\textless{}{-}} \FunctionTok{h2o.gbm}\NormalTok{(}
    \AttributeTok{model\_id =} \StringTok{"GBM\_2"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{, }\AttributeTok{score\_tree\_interval =} \DecValTok{5}\NormalTok{,}
    \AttributeTok{col\_sample\_rate =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{col\_sample\_rate\_per\_tree =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{learn\_rate =} \FloatTok{0.1}\NormalTok{,}
    \AttributeTok{max\_depth =} \DecValTok{7}\NormalTok{, }\AttributeTok{min\_rows =} \DecValTok{10}\NormalTok{, }\AttributeTok{min\_split\_improvement =} \FloatTok{1e{-}5}\NormalTok{, }\AttributeTok{ntrees =} \DecValTok{10000}\NormalTok{, }\AttributeTok{sample\_rate =} \FloatTok{0.8}\NormalTok{,}
    \AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}
\NormalTok{  )}
\NormalTok{  gbm\_3 }\OtherTok{\textless{}{-}} \FunctionTok{h2o.gbm}\NormalTok{(}
    \AttributeTok{model\_id =} \StringTok{"GBM\_3"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{, }\AttributeTok{score\_tree\_interval =} \DecValTok{5}\NormalTok{,}
    \AttributeTok{col\_sample\_rate =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{col\_sample\_rate\_per\_tree =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{learn\_rate =} \FloatTok{0.1}\NormalTok{,}
    \AttributeTok{max\_depth =} \DecValTok{8}\NormalTok{, }\AttributeTok{min\_rows =} \DecValTok{10}\NormalTok{, }\AttributeTok{min\_split\_improvement =} \FloatTok{1e{-}5}\NormalTok{, }\AttributeTok{ntrees =} \DecValTok{10000}\NormalTok{, }\AttributeTok{sample\_rate =} \FloatTok{0.8}\NormalTok{,}
    \AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}
\NormalTok{  )}
\NormalTok{  gbm\_4 }\OtherTok{\textless{}{-}} \FunctionTok{h2o.gbm}\NormalTok{(}
    \AttributeTok{model\_id =} \StringTok{"GBM\_4"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{, }\AttributeTok{score\_tree\_interval =} \DecValTok{5}\NormalTok{,}
    \AttributeTok{col\_sample\_rate =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{col\_sample\_rate\_per\_tree =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{learn\_rate =} \FloatTok{0.1}\NormalTok{,}
    \AttributeTok{max\_depth =} \DecValTok{10}\NormalTok{, }\AttributeTok{min\_rows =} \DecValTok{10}\NormalTok{, }\AttributeTok{min\_split\_improvement =} \FloatTok{1e{-}5}\NormalTok{, }\AttributeTok{ntrees =} \DecValTok{10000}\NormalTok{, }\AttributeTok{sample\_rate =} \FloatTok{0.8}\NormalTok{,}
    \AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}
\NormalTok{  )}
\NormalTok{  gbm\_5 }\OtherTok{\textless{}{-}} \FunctionTok{h2o.gbm}\NormalTok{(}
    \AttributeTok{model\_id =} \StringTok{"GBM\_5"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{, }\AttributeTok{score\_tree\_interval =} \DecValTok{5}\NormalTok{,}
    \AttributeTok{col\_sample\_rate =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{col\_sample\_rate\_per\_tree =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{learn\_rate =} \FloatTok{0.1}\NormalTok{,}
    \AttributeTok{max\_depth =} \DecValTok{15}\NormalTok{, }\AttributeTok{min\_rows =} \DecValTok{100}\NormalTok{, }\AttributeTok{min\_split\_improvement =} \FloatTok{1e{-}5}\NormalTok{, }\AttributeTok{ntrees =} \DecValTok{10000}\NormalTok{, }\AttributeTok{sample\_rate =} \FloatTok{0.8}\NormalTok{,}
    \AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}
\NormalTok{  )}
  \ControlFlowTok{for}\NormalTok{ (model\_id }\ControlFlowTok{in} \FunctionTok{paste0}\NormalTok{(}\StringTok{"GBM\_"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{5}\NormalTok{)) \{}
\NormalTok{    tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(model\_id), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  \}}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"XGBoost grid}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  xgboost }\OtherTok{\textless{}{-}} \FunctionTok{h2o.grid}\NormalTok{(}
    \AttributeTok{algorithm =} \StringTok{"xgboost"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{hyper\_params =}\NormalTok{ xgboost\_params, }\AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{,}
    \AttributeTok{search\_criteria =} \FunctionTok{list}\NormalTok{(}\AttributeTok{strategy =} \StringTok{"RandomDiscrete"}\NormalTok{, }\AttributeTok{max\_models =} \DecValTok{300}\NormalTok{, }\AttributeTok{seed =}\NormalTok{ grid\_seed),}
    \AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}\NormalTok{, }\AttributeTok{parallelism =} \DecValTok{0}
\NormalTok{  )}
  \ControlFlowTok{for}\NormalTok{ (model\_id }\ControlFlowTok{in}\NormalTok{ xgboost}\SpecialCharTok{@}\NormalTok{model\_ids) \{}
\NormalTok{    tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(model\_id), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  \}}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"XGBoost 3 default models}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  xgboost\_1 }\OtherTok{\textless{}{-}} \FunctionTok{h2o.xgboost}\NormalTok{(}
    \AttributeTok{model\_id =} \StringTok{"XGBoost\_1"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{, }\AttributeTok{score\_tree\_interval =} \DecValTok{5}\NormalTok{,}
    \AttributeTok{booster =} \StringTok{"gbtree"}\NormalTok{, }\AttributeTok{col\_sample\_rate =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{col\_sample\_rate\_per\_tree =} \FloatTok{0.8}\NormalTok{,}
    \AttributeTok{max\_depth =} \DecValTok{10}\NormalTok{, }\AttributeTok{min\_rows =} \DecValTok{5}\NormalTok{, }\AttributeTok{ntrees =} \DecValTok{10000}\NormalTok{, }\AttributeTok{reg\_alpha =} \DecValTok{0}\NormalTok{, }\AttributeTok{reg\_lambda =} \DecValTok{1}\NormalTok{,}
    \AttributeTok{sample\_rate =} \FloatTok{0.6}\NormalTok{, }\AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}
\NormalTok{  )}
\NormalTok{  xgboost\_2 }\OtherTok{\textless{}{-}} \FunctionTok{h2o.xgboost}\NormalTok{(}
    \AttributeTok{model\_id =} \StringTok{"XGBoost\_2"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{, }\AttributeTok{score\_tree\_interval =} \DecValTok{5}\NormalTok{,}
    \AttributeTok{booster =} \StringTok{"gbtree"}\NormalTok{, }\AttributeTok{col\_sample\_rate =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{col\_sample\_rate\_per\_tree =} \FloatTok{0.8}\NormalTok{,}
    \AttributeTok{max\_depth =} \DecValTok{20}\NormalTok{, }\AttributeTok{min\_rows =} \DecValTok{10}\NormalTok{, }\AttributeTok{ntrees =} \DecValTok{10000}\NormalTok{, }\AttributeTok{reg\_alpha =} \DecValTok{0}\NormalTok{, }\AttributeTok{reg\_lambda =} \DecValTok{1}\NormalTok{,}
    \AttributeTok{sample\_rate =} \FloatTok{0.6}\NormalTok{, }\AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}
\NormalTok{  )}
\NormalTok{  xgboost\_3 }\OtherTok{\textless{}{-}} \FunctionTok{h2o.xgboost}\NormalTok{(}
    \AttributeTok{model\_id =} \StringTok{"XGBoost\_3"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{, }\AttributeTok{score\_tree\_interval =} \DecValTok{5}\NormalTok{,}
    \AttributeTok{booster =} \StringTok{"gbtree"}\NormalTok{, }\AttributeTok{col\_sample\_rate =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{col\_sample\_rate\_per\_tree =} \FloatTok{0.8}\NormalTok{,}
    \AttributeTok{max\_depth =} \DecValTok{5}\NormalTok{, }\AttributeTok{min\_rows =} \DecValTok{3}\NormalTok{, }\AttributeTok{ntrees =} \DecValTok{10000}\NormalTok{, }\AttributeTok{reg\_alpha =} \DecValTok{0}\NormalTok{, }\AttributeTok{reg\_lambda =} \DecValTok{1}\NormalTok{,}
    \AttributeTok{sample\_rate =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}
\NormalTok{  )}
  \ControlFlowTok{for}\NormalTok{ (model\_id }\ControlFlowTok{in} \FunctionTok{paste0}\NormalTok{(}\StringTok{"XGBoost\_"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{)) \{}
\NormalTok{    tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(model\_id), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  \}}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"GLM}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  glm }\OtherTok{\textless{}{-}} \FunctionTok{h2o.glm}\NormalTok{(}
    \AttributeTok{model\_id =} \StringTok{"GLM"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{alpha =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.0}\NormalTok{, }\FloatTok{0.2}\NormalTok{, }\FloatTok{0.4}\NormalTok{, }\FloatTok{0.6}\NormalTok{, }\FloatTok{0.8}\NormalTok{, }\FloatTok{1.0}\NormalTok{),}
    \AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}
\NormalTok{  )}
\NormalTok{  tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(}\StringTok{"GLM"}\NormalTok{), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"DRF}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  drf }\OtherTok{\textless{}{-}} \FunctionTok{h2o.randomForest}\NormalTok{(}
    \AttributeTok{model\_id =} \StringTok{"DRF"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{ntrees =} \DecValTok{10000}\NormalTok{,}
    \AttributeTok{score\_tree\_interval =} \DecValTok{5}\NormalTok{, }\AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{,}
    \AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}
\NormalTok{  )}
\NormalTok{  tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(}\StringTok{"DRF"}\NormalTok{), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"XRT}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  xrt }\OtherTok{\textless{}{-}} \FunctionTok{h2o.randomForest}\NormalTok{(}
    \AttributeTok{model\_id =} \StringTok{"XRT"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{ntrees =} \DecValTok{10000}\NormalTok{, }\AttributeTok{histogram\_type =} \StringTok{"Random"}\NormalTok{,}
    \AttributeTok{score\_tree\_interval =} \DecValTok{5}\NormalTok{, }\AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{,}
    \AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}
\NormalTok{  )}
\NormalTok{  tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(}\StringTok{"XRT"}\NormalTok{), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
  \CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
  \CommentTok{\# get holdout predictions}
  \CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\NormalTok{  base\_models }\OtherTok{\textless{}{-}} \FunctionTok{as.list}\NormalTok{(}\FunctionTok{c}\NormalTok{(}
    \FunctionTok{unlist}\NormalTok{(deeplearning\_1}\SpecialCharTok{@}\NormalTok{model\_ids),}
    \FunctionTok{unlist}\NormalTok{(deeplearning\_2}\SpecialCharTok{@}\NormalTok{model\_ids),}
    \FunctionTok{unlist}\NormalTok{(deeplearning\_3}\SpecialCharTok{@}\NormalTok{model\_ids),}
    \FunctionTok{unlist}\NormalTok{(gbm}\SpecialCharTok{@}\NormalTok{model\_ids), }\FunctionTok{paste0}\NormalTok{(}\StringTok{"GBM\_"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{5}\NormalTok{),}
    \FunctionTok{unlist}\NormalTok{(xgboost}\SpecialCharTok{@}\NormalTok{model\_ids), }\FunctionTok{paste0}\NormalTok{(}\StringTok{"XGBoost\_"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{),}
    \StringTok{"GLM"}\NormalTok{,}
    \StringTok{"DRF"}\NormalTok{,}
    \StringTok{"XRT"}
\NormalTok{  ))}
  \ControlFlowTok{for}\NormalTok{ (model\_id }\ControlFlowTok{in}\NormalTok{ base\_models) \{}
\NormalTok{    res }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(res, }\FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{h2o.getFrame}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"cv\_holdout\_prediction\_"}\NormalTok{, model\_id)),}
      \AttributeTok{col.names =}\NormalTok{ model\_id}
\NormalTok{    ))}
\NormalTok{  \}}
  \CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
  \CommentTok{\# super learner training}
  \CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\NormalTok{  sl\_iter }\OtherTok{\textless{}{-}} \DecValTok{0}
  \FunctionTok{cat}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"Super learner iteration "}\NormalTok{, sl\_iter, }\StringTok{" ("}\NormalTok{, }\FunctionTok{length}\NormalTok{(base\_models), }\StringTok{" models)}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{))}
\NormalTok{  sl }\OtherTok{\textless{}{-}} \FunctionTok{h2o.stackedEnsemble}\NormalTok{(}
    \AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{model\_id =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"superlearner\_iter\_"}\NormalTok{, sl\_iter),}
    \AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{,}
    \AttributeTok{base\_models =}\NormalTok{ base\_models,}
    \AttributeTok{metalearner\_algorithm =} \StringTok{"glm"}\NormalTok{,}
    \AttributeTok{metalearner\_nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_levelone\_frame =} \ConstantTok{TRUE}\NormalTok{,}
    \AttributeTok{metalearner\_params =} \FunctionTok{list}\NormalTok{(}\AttributeTok{standardize =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  )}
\NormalTok{  tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"superlearner\_iter\_"}\NormalTok{, sl\_iter)), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  model\_id }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"metalearner\_glm\_superlearner\_iter\_"}\NormalTok{, sl\_iter)}
\NormalTok{  tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(model\_id), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  res }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(res, }\FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{h2o.getFrame}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"cv\_holdout\_prediction\_"}\NormalTok{, model\_id)),}
    \AttributeTok{col.names =} \FunctionTok{paste0}\NormalTok{(model\_id, }\StringTok{"\_"}\NormalTok{, }\FunctionTok{length}\NormalTok{(base\_models), }\StringTok{"\_models"}\NormalTok{)}
\NormalTok{  ))}
  \CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
  \CommentTok{\# super learner base model reduction}
  \CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
  \ControlFlowTok{while}\NormalTok{ (}\ConstantTok{TRUE}\NormalTok{) \{}
\NormalTok{    meta }\OtherTok{\textless{}{-}} \FunctionTok{h2o.getModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"metalearner\_glm\_superlearner\_iter\_"}\NormalTok{, sl\_iter, }\StringTok{"\_cv\_1"}\NormalTok{))}
\NormalTok{    names }\OtherTok{\textless{}{-}}\NormalTok{ meta}\SpecialCharTok{@}\NormalTok{model}\SpecialCharTok{$}\NormalTok{coefficients\_table[, }\StringTok{"names"}\NormalTok{]}
\NormalTok{    coeffs }\OtherTok{\textless{}{-}}\NormalTok{ (meta}\SpecialCharTok{@}\NormalTok{model}\SpecialCharTok{$}\NormalTok{coefficients\_table[, }\StringTok{"standardized\_coefficients"}\NormalTok{] }\SpecialCharTok{\textgreater{}} \DecValTok{0}\NormalTok{)}
    \ControlFlowTok{for}\NormalTok{ (j }\ControlFlowTok{in} \DecValTok{2}\SpecialCharTok{:}\NormalTok{nfolds) \{}
\NormalTok{      meta }\OtherTok{\textless{}{-}} \FunctionTok{h2o.getModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"metalearner\_glm\_superlearner\_iter\_"}\NormalTok{, sl\_iter, }\StringTok{"\_cv\_"}\NormalTok{, j))}
\NormalTok{      names }\OtherTok{\textless{}{-}}\NormalTok{ meta}\SpecialCharTok{@}\NormalTok{model}\SpecialCharTok{$}\NormalTok{coefficients\_table[, }\StringTok{"names"}\NormalTok{]}
\NormalTok{      coeffs }\OtherTok{\textless{}{-}}\NormalTok{ coeffs }\SpecialCharTok{+}\NormalTok{ (meta}\SpecialCharTok{@}\NormalTok{model}\SpecialCharTok{$}\NormalTok{coefficients\_table[, }\StringTok{"standardized\_coefficients"}\NormalTok{] }\SpecialCharTok{\textgreater{}} \DecValTok{0}\NormalTok{)}
\NormalTok{    \}}
\NormalTok{    base\_models\_ }\OtherTok{\textless{}{-}} \FunctionTok{as.list}\NormalTok{(names[coeffs }\SpecialCharTok{\textgreater{}=} \FunctionTok{ceiling}\NormalTok{(nfolds }\SpecialCharTok{/} \DecValTok{2}\NormalTok{) }\SpecialCharTok{\&}\NormalTok{ names }\SpecialCharTok{!=} \StringTok{"Intercept"}\NormalTok{])}
    \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{length}\NormalTok{(base\_models\_) }\SpecialCharTok{==} \DecValTok{0}\NormalTok{) \{}
      \FunctionTok{cat}\NormalTok{(}\StringTok{"No base models passing the threshold}\SpecialCharTok{\textbackslash{}n\textbackslash{}n}\StringTok{"}\NormalTok{)}
      \ControlFlowTok{break}
\NormalTok{    \}}
    \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{sum}\NormalTok{(base\_models }\SpecialCharTok{\%in\%}\NormalTok{ base\_models\_) }\SpecialCharTok{==} \FunctionTok{length}\NormalTok{(base\_models)) \{}
      \FunctionTok{cat}\NormalTok{(}\StringTok{"No further reduction of base models}\SpecialCharTok{\textbackslash{}n\textbackslash{}n}\StringTok{"}\NormalTok{)}
      \ControlFlowTok{break}
\NormalTok{    \}}
\NormalTok{    sl\_iter }\OtherTok{\textless{}{-}}\NormalTok{ sl\_iter }\SpecialCharTok{+} \DecValTok{1}
\NormalTok{    base\_models }\OtherTok{\textless{}{-}}\NormalTok{ base\_models\_}
    \FunctionTok{cat}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"Super learner iteration "}\NormalTok{, sl\_iter, }\StringTok{" ("}\NormalTok{, }\FunctionTok{length}\NormalTok{(base\_models), }\StringTok{" models)}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{))}
\NormalTok{    sl }\OtherTok{\textless{}{-}} \FunctionTok{h2o.stackedEnsemble}\NormalTok{(}
      \AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{model\_id =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"superlearner\_iter\_"}\NormalTok{, sl\_iter),}
      \AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{,}
      \AttributeTok{base\_models =}\NormalTok{ base\_models,}
      \AttributeTok{metalearner\_algorithm =} \StringTok{"glm"}\NormalTok{,}
      \AttributeTok{metalearner\_nfolds =}\NormalTok{ nfolds,}
      \AttributeTok{keep\_levelone\_frame =} \ConstantTok{TRUE}\NormalTok{,}
      \AttributeTok{metalearner\_params =} \FunctionTok{list}\NormalTok{(}\AttributeTok{standardize =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{    )}
\NormalTok{    tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"superlearner\_iter\_"}\NormalTok{, sl\_iter)), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{    model\_id }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"metalearner\_glm\_superlearner\_iter\_"}\NormalTok{, sl\_iter)}
\NormalTok{    tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(model\_id), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{    res }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(res, }\FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{h2o.getFrame}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"cv\_holdout\_prediction\_"}\NormalTok{, model\_id)),}
      \AttributeTok{col.names =} \FunctionTok{paste0}\NormalTok{(model\_id, }\StringTok{"\_"}\NormalTok{, }\FunctionTok{length}\NormalTok{(base\_models), }\StringTok{"\_models"}\NormalTok{)}
\NormalTok{    ))}
\NormalTok{  \}}
  \CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
  \CommentTok{\# super learner for homogeneous base models}
  \CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
  \CommentTok{\# DeepLearning}
\NormalTok{  base\_models }\OtherTok{\textless{}{-}} \FunctionTok{as.list}\NormalTok{(}\FunctionTok{c}\NormalTok{(}
    \FunctionTok{unlist}\NormalTok{(deeplearning\_1}\SpecialCharTok{@}\NormalTok{model\_ids),}
    \FunctionTok{unlist}\NormalTok{(deeplearning\_2}\SpecialCharTok{@}\NormalTok{model\_ids),}
    \FunctionTok{unlist}\NormalTok{(deeplearning\_3}\SpecialCharTok{@}\NormalTok{model\_ids)}
\NormalTok{  ))}
  \FunctionTok{cat}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"Super learner deep learning ("}\NormalTok{, }\FunctionTok{length}\NormalTok{(base\_models), }\StringTok{" models)}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{))}
\NormalTok{  sl }\OtherTok{\textless{}{-}} \FunctionTok{h2o.stackedEnsemble}\NormalTok{(}
    \AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{model\_id =} \StringTok{"superlearner\_deeplearning"}\NormalTok{,}
    \AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{,}
    \AttributeTok{base\_models =}\NormalTok{ base\_models,}
    \AttributeTok{metalearner\_algorithm =} \StringTok{"glm"}\NormalTok{,}
    \AttributeTok{metalearner\_nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_levelone\_frame =} \ConstantTok{TRUE}\NormalTok{,}
    \AttributeTok{metalearner\_params =} \FunctionTok{list}\NormalTok{(}\AttributeTok{standardize =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  )}
\NormalTok{  tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(}\StringTok{"superlearner\_deeplearning"}\NormalTok{), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  model\_id }\OtherTok{\textless{}{-}} \StringTok{"metalearner\_glm\_superlearner\_deeplearning"}
\NormalTok{  tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(model\_id), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  res }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(res, }\FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{h2o.getFrame}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"cv\_holdout\_prediction\_"}\NormalTok{, model\_id)),}
    \AttributeTok{col.names =} \FunctionTok{paste0}\NormalTok{(model\_id, }\StringTok{"\_"}\NormalTok{, }\FunctionTok{length}\NormalTok{(base\_models), }\StringTok{"\_models"}\NormalTok{)}
\NormalTok{  ))}
  \CommentTok{\# GBM}
\NormalTok{  base\_models }\OtherTok{\textless{}{-}} \FunctionTok{as.list}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\FunctionTok{unlist}\NormalTok{(gbm}\SpecialCharTok{@}\NormalTok{model\_ids), }\FunctionTok{paste0}\NormalTok{(}\StringTok{"GBM\_"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{5}\NormalTok{)))}
  \FunctionTok{cat}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"Super learner GBM ("}\NormalTok{, }\FunctionTok{length}\NormalTok{(base\_models), }\StringTok{" models)}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{))}
\NormalTok{  sl }\OtherTok{\textless{}{-}} \FunctionTok{h2o.stackedEnsemble}\NormalTok{(}
    \AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{model\_id =} \StringTok{"superlearner\_gbm"}\NormalTok{,}
    \AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{,}
    \AttributeTok{base\_models =}\NormalTok{ base\_models,}
    \AttributeTok{metalearner\_algorithm =} \StringTok{"glm"}\NormalTok{,}
    \AttributeTok{metalearner\_nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_levelone\_frame =} \ConstantTok{TRUE}\NormalTok{,}
    \AttributeTok{metalearner\_params =} \FunctionTok{list}\NormalTok{(}\AttributeTok{standardize =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  )}
\NormalTok{  tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(}\StringTok{"superlearner\_gbm"}\NormalTok{), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  model\_id }\OtherTok{\textless{}{-}} \StringTok{"metalearner\_glm\_superlearner\_gbm"}
\NormalTok{  tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(model\_id), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  res }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(res, }\FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{h2o.getFrame}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"cv\_holdout\_prediction\_"}\NormalTok{, model\_id)),}
    \AttributeTok{col.names =} \FunctionTok{paste0}\NormalTok{(model\_id, }\StringTok{"\_"}\NormalTok{, }\FunctionTok{length}\NormalTok{(base\_models), }\StringTok{"\_models"}\NormalTok{)}
\NormalTok{  ))}
  \CommentTok{\# XGBoost}
\NormalTok{  base\_models }\OtherTok{\textless{}{-}} \FunctionTok{as.list}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\FunctionTok{unlist}\NormalTok{(xgboost}\SpecialCharTok{@}\NormalTok{model\_ids), }\FunctionTok{paste0}\NormalTok{(}\StringTok{"XGBoost\_"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{)))}
  \FunctionTok{cat}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"Super learner XGBoost ("}\NormalTok{, }\FunctionTok{length}\NormalTok{(base\_models), }\StringTok{" models)}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{))}
\NormalTok{  sl }\OtherTok{\textless{}{-}} \FunctionTok{h2o.stackedEnsemble}\NormalTok{(}
    \AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{model\_id =} \StringTok{"superlearner\_xgboost"}\NormalTok{,}
    \AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{,}
    \AttributeTok{base\_models =}\NormalTok{ base\_models,}
    \AttributeTok{metalearner\_algorithm =} \StringTok{"glm"}\NormalTok{,}
    \AttributeTok{metalearner\_nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_levelone\_frame =} \ConstantTok{TRUE}\NormalTok{,}
    \AttributeTok{metalearner\_params =} \FunctionTok{list}\NormalTok{(}\AttributeTok{standardize =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  )}
\NormalTok{  tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(}\StringTok{"superlearner\_xgboost"}\NormalTok{), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  model\_id }\OtherTok{\textless{}{-}} \StringTok{"metalearner\_glm\_superlearner\_xgboost"}
\NormalTok{  tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(model\_id), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  res }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(res, }\FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{h2o.getFrame}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"cv\_holdout\_prediction\_"}\NormalTok{, model\_id)),}
    \AttributeTok{col.names =} \FunctionTok{paste0}\NormalTok{(model\_id, }\StringTok{"\_"}\NormalTok{, }\FunctionTok{length}\NormalTok{(base\_models), }\StringTok{"\_models"}\NormalTok{)}
\NormalTok{  ))}
  \FunctionTok{write.csv}\NormalTok{(res, }\AttributeTok{file =} \FunctionTok{paste0}\NormalTok{(exp\_dir, }\StringTok{"/cv\_holdout\_predictions.csv"}\NormalTok{), }\AttributeTok{row.names =} \ConstantTok{FALSE}\NormalTok{)}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}n\textbackslash{}n}\StringTok{"}\NormalTok{)}
  \FunctionTok{h2o.removeAll}\NormalTok{()}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\hypertarget{inner-cross-validation}{%
\subsection{Inner cross-validation}\label{inner-cross-validation}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{load}\NormalTok{(}\AttributeTok{file =} \StringTok{"./rdata/var\_reduct\_mb\_train\_test\_splits.RData"}\NormalTok{)}
\ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{) \{}
  \FunctionTok{cat}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"Outer training set "}\NormalTok{, i, }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{))}
\NormalTok{  prefix }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"outer\_"}\NormalTok{, i)}
\NormalTok{  exp\_dir }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"/Users/renee/Downloads/melanin\_binding/"}\NormalTok{, prefix)}
  \FunctionTok{dir.create}\NormalTok{(exp\_dir)}
  \FunctionTok{train\_mb\_models}\NormalTok{(}\AttributeTok{train\_set =}\NormalTok{ outer\_splits[[i]][[}\StringTok{"train"}\NormalTok{]], }\AttributeTok{exp\_dir =}\NormalTok{ exp\_dir, }\AttributeTok{prefix =}\NormalTok{ prefix)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\hypertarget{training-on-whole-data-set}{%
\subsection{Training on whole data set}\label{training-on-whole-data-set}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{load}\NormalTok{(}\AttributeTok{file =} \StringTok{"./rdata/var\_reduct\_mb\_train\_test\_splits.RData"}\NormalTok{)}
\NormalTok{prefix }\OtherTok{\textless{}{-}} \StringTok{"whole\_data\_set"}
\NormalTok{exp\_dir }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"/Users/renee/Downloads/melanin\_binding/"}\NormalTok{, prefix)}
\FunctionTok{dir.create}\NormalTok{(exp\_dir)}
\FunctionTok{train\_mb\_models}\NormalTok{(}\AttributeTok{train\_set =}\NormalTok{ mb\_data, }\AttributeTok{exp\_dir =}\NormalTok{ exp\_dir, }\AttributeTok{prefix =}\NormalTok{ prefix)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Keep track of grid models}
\NormalTok{dl\_grid }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
\NormalTok{gbm\_grid }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
\NormalTok{xgboost\_grid }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
\NormalTok{dl\_grid\_params }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
\NormalTok{gbm\_grid\_params }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
\NormalTok{xgboost\_grid\_params }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
\ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{11}\NormalTok{) \{}
  \ControlFlowTok{if}\NormalTok{ (i }\SpecialCharTok{==} \DecValTok{11}\NormalTok{) \{}
    \FunctionTok{cat}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"Whole data set}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{))}
\NormalTok{    prefix }\OtherTok{\textless{}{-}} \StringTok{"whole\_data\_set"}
\NormalTok{  \} }\ControlFlowTok{else}\NormalTok{ \{}
    \FunctionTok{cat}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"Outer training set "}\NormalTok{, i, }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{))}
\NormalTok{    prefix }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"outer\_"}\NormalTok{, i)}
\NormalTok{  \}}
\NormalTok{  dir }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"/Users/renee/Downloads/melanin\_binding/"}\NormalTok{, prefix)}
\NormalTok{  files }\OtherTok{\textless{}{-}} \FunctionTok{list.files}\NormalTok{(dir)}
  \CommentTok{\# Deep learning}
\NormalTok{  dl }\OtherTok{\textless{}{-}}\NormalTok{ files[}\FunctionTok{str\_detect}\NormalTok{(files, }\StringTok{"DeepLearning\_model"}\NormalTok{)]}
  \ControlFlowTok{for}\NormalTok{ (m }\ControlFlowTok{in}\NormalTok{ dl) \{}
\NormalTok{    model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/"}\NormalTok{, m))}
\NormalTok{    hs }\OtherTok{\textless{}{-}} \FunctionTok{sha1}\NormalTok{(}\FunctionTok{paste}\NormalTok{(}\FunctionTok{c}\NormalTok{(}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{epsilon,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{hidden,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{hidden\_dropout\_ratios,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{input\_dropout\_ratio,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{rho}
\NormalTok{    ), }\AttributeTok{collapse =} \StringTok{" "}\NormalTok{))}
    \ControlFlowTok{if}\NormalTok{ (hs }\SpecialCharTok{\%in\%} \FunctionTok{names}\NormalTok{(dl\_grid)) \{}
\NormalTok{      dl\_grid[[hs]] }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(dl\_grid[[hs]], m)}
\NormalTok{    \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{      dl\_grid[[hs]] }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(m)}
\NormalTok{      dl\_grid\_params }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(}
\NormalTok{        dl\_grid\_params,}
        \FunctionTok{c}\NormalTok{(}
          \StringTok{"epsilon"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{epsilon,}
          \StringTok{"hidden"} \OtherTok{=} \FunctionTok{paste0}\NormalTok{(}\StringTok{"["}\NormalTok{, }\FunctionTok{paste}\NormalTok{(model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{hidden, }\AttributeTok{collapse =} \StringTok{","}\NormalTok{), }\StringTok{"]"}\NormalTok{),}
          \StringTok{"hidden\_dropout\_ratios"} \OtherTok{=} \FunctionTok{paste0}\NormalTok{(}
            \StringTok{"["}\NormalTok{,}
            \FunctionTok{paste}\NormalTok{(model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{hidden\_dropout\_ratios,}
              \AttributeTok{collapse =} \StringTok{","}
\NormalTok{            ), }\StringTok{"]"}
\NormalTok{          ),}
          \StringTok{"input\_dropout\_ratio"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{input\_dropout\_ratio,}
          \StringTok{"rho"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{rho}
\NormalTok{        )}
\NormalTok{      )}
\NormalTok{    \}}
\NormalTok{  \}}
  \FunctionTok{h2o.removeAll}\NormalTok{()}
  \CommentTok{\# GBM}
\NormalTok{  gbm }\OtherTok{\textless{}{-}}\NormalTok{ files[}\FunctionTok{str\_detect}\NormalTok{(files, }\StringTok{"GBM\_model"}\NormalTok{)]}
  \ControlFlowTok{for}\NormalTok{ (m }\ControlFlowTok{in}\NormalTok{ gbm) \{}
\NormalTok{    model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/"}\NormalTok{, m))}
\NormalTok{    hs }\OtherTok{\textless{}{-}} \FunctionTok{sha1}\NormalTok{(}\FunctionTok{paste}\NormalTok{(}\FunctionTok{c}\NormalTok{(}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{col\_sample\_rate,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{col\_sample\_rate\_per\_tree,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{max\_depth,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{min\_rows,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{min\_split\_improvement,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{sample\_rate}
\NormalTok{    ), }\AttributeTok{collapse =} \StringTok{" "}\NormalTok{))}
    \ControlFlowTok{if}\NormalTok{ (hs }\SpecialCharTok{\%in\%} \FunctionTok{names}\NormalTok{(gbm\_grid)) \{}
\NormalTok{      gbm\_grid[[hs]] }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(gbm\_grid[[hs]], m)}
\NormalTok{    \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{      gbm\_grid[[hs]] }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(m)}
\NormalTok{      gbm\_grid\_params }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(}
\NormalTok{        gbm\_grid\_params,}
        \FunctionTok{c}\NormalTok{(}
          \StringTok{"col\_sample\_rate"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{col\_sample\_rate,}
          \StringTok{"col\_sample\_rate\_per\_tree"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{col\_sample\_rate\_per\_tree,}
          \StringTok{"max\_depth"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{max\_depth,}
          \StringTok{"min\_rows"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{min\_rows,}
          \StringTok{"min\_split\_improvement"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{min\_split\_improvement,}
          \StringTok{"sample\_rate"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{sample\_rate}
\NormalTok{        )}
\NormalTok{      )}
\NormalTok{    \}}
\NormalTok{  \}}
  \FunctionTok{h2o.removeAll}\NormalTok{()}
  \CommentTok{\# XGBoost}
\NormalTok{  xgboost }\OtherTok{\textless{}{-}}\NormalTok{ files[}\FunctionTok{str\_detect}\NormalTok{(files, }\StringTok{"XGBoost\_model"}\NormalTok{)]}
  \ControlFlowTok{for}\NormalTok{ (m }\ControlFlowTok{in}\NormalTok{ xgboost) \{}
\NormalTok{    model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/"}\NormalTok{, m))}
\NormalTok{    hs }\OtherTok{\textless{}{-}} \FunctionTok{sha1}\NormalTok{(}\FunctionTok{paste}\NormalTok{(}\FunctionTok{c}\NormalTok{(}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{booster,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{col\_sample\_rate,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{col\_sample\_rate\_per\_tree,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{max\_depth,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{min\_rows,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{reg\_alpha,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{reg\_lambda,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{sample\_rate}
\NormalTok{    ), }\AttributeTok{collapse =} \StringTok{" "}\NormalTok{))}
    \ControlFlowTok{if}\NormalTok{ (hs }\SpecialCharTok{\%in\%} \FunctionTok{names}\NormalTok{(xgboost\_grid)) \{}
\NormalTok{      xgboost\_grid[[hs]] }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(xgboost\_grid[[hs]], m)}
\NormalTok{    \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{      xgboost\_grid[[hs]] }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(m)}
\NormalTok{      xgboost\_grid\_params }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(}
\NormalTok{        xgboost\_grid\_params,}
        \FunctionTok{c}\NormalTok{(}
          \StringTok{"booster"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{booster,}
          \StringTok{"col\_sample\_rate"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{col\_sample\_rate,}
          \StringTok{"col\_sample\_rate\_per\_tree"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{col\_sample\_rate\_per\_tree,}
          \StringTok{"max\_depth"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{max\_depth,}
          \StringTok{"min\_rows"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{min\_rows,}
          \StringTok{"reg\_alpha"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{reg\_alpha,}
          \StringTok{"reg\_lambda"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{reg\_lambda,}
          \StringTok{"sample\_rate"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{sample\_rate}
\NormalTok{        )}
\NormalTok{      )}
\NormalTok{    \}}
\NormalTok{  \}}
  \FunctionTok{h2o.removeAll}\NormalTok{()}
\NormalTok{\}}

\NormalTok{dl\_grid\_params }\OtherTok{\textless{}{-}} \FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{t}\NormalTok{(}\FunctionTok{data.frame}\NormalTok{(dl\_grid\_params)))}
\FunctionTok{rownames}\NormalTok{(dl\_grid\_params) }\OtherTok{\textless{}{-}} \FunctionTok{paste}\NormalTok{(}\StringTok{"Neural network grid model"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(dl\_grid\_params))}

\NormalTok{gbm\_grid\_params }\OtherTok{\textless{}{-}} \FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{t}\NormalTok{(}\FunctionTok{data.frame}\NormalTok{(gbm\_grid\_params)))}
\FunctionTok{rownames}\NormalTok{(gbm\_grid\_params) }\OtherTok{\textless{}{-}} \FunctionTok{paste}\NormalTok{(}\StringTok{"GBM grid model"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(gbm\_grid\_params))}

\NormalTok{xgboost\_grid\_params }\OtherTok{\textless{}{-}} \FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{t}\NormalTok{(}\FunctionTok{data.frame}\NormalTok{(xgboost\_grid\_params)))}
\FunctionTok{rownames}\NormalTok{(xgboost\_grid\_params) }\OtherTok{\textless{}{-}} \FunctionTok{paste}\NormalTok{(}\StringTok{"XGBoost grid model"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(xgboost\_grid\_params))}

\FunctionTok{write.csv}\NormalTok{(dl\_grid\_params, }\StringTok{"./other\_data/melanin\_binding/neural\_network\_grid\_params.csv"}\NormalTok{)}
\FunctionTok{write.csv}\NormalTok{(gbm\_grid\_params, }\StringTok{"./other\_data/melanin\_binding/gbm\_grid\_params.csv"}\NormalTok{)}
\FunctionTok{write.csv}\NormalTok{(xgboost\_grid\_params, }\StringTok{"./other\_data/melanin\_binding/xgboost\_grid\_params.csv"}\NormalTok{)}

\FunctionTok{save}\NormalTok{(dl\_grid, gbm\_grid, xgboost\_grid, }\AttributeTok{file =} \StringTok{"./rdata/model\_training\_grid\_models\_mb.RData"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{model-evaluation}{%
\subsection{Model evaluation}\label{model-evaluation}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{model\_evaluation }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(holdout\_pred, fold\_asign, grid\_name, }\AttributeTok{grid\_meta =} \ConstantTok{NULL}\NormalTok{) \{}
  \FunctionTok{load}\NormalTok{(}\AttributeTok{file =} \StringTok{"./rdata/var\_reduct\_mb\_train\_test\_splits.RData"}\NormalTok{)}
\NormalTok{  res\_ }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
\NormalTok{  model\_num }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{startsWith}\NormalTok{(grid\_name, }\StringTok{"Super learner"}\NormalTok{)) \{}
    \ControlFlowTok{if}\NormalTok{ (grid\_name }\SpecialCharTok{==} \StringTok{"Super learner all models"}\NormalTok{) \{}
\NormalTok{      m }\OtherTok{\textless{}{-}} \FunctionTok{colnames}\NormalTok{(holdout\_pred)[}\FunctionTok{startsWith}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(holdout\_pred), }\StringTok{"metalearner\_glm\_superlearner\_iter\_0"}\NormalTok{)]}
\NormalTok{    \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (grid\_name }\SpecialCharTok{==} \StringTok{"Super learner final"}\NormalTok{) \{}
\NormalTok{      sl\_models }\OtherTok{\textless{}{-}} \FunctionTok{colnames}\NormalTok{(holdout\_pred)[}\FunctionTok{startsWith}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(holdout\_pred), }\StringTok{"metalearner\_glm\_superlearner\_iter"}\NormalTok{)]}
\NormalTok{      m }\OtherTok{\textless{}{-}}\NormalTok{ sl\_models[}\FunctionTok{length}\NormalTok{(sl\_models)]}
\NormalTok{    \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (grid\_name }\SpecialCharTok{==} \StringTok{"Super learner neural network"}\NormalTok{) \{}
\NormalTok{      m }\OtherTok{\textless{}{-}} \FunctionTok{colnames}\NormalTok{(holdout\_pred)[}\FunctionTok{startsWith}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(holdout\_pred), }\StringTok{"metalearner\_glm\_superlearner\_deeplearning"}\NormalTok{)]}
\NormalTok{    \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (grid\_name }\SpecialCharTok{==} \StringTok{"Super learner GBM"}\NormalTok{) \{}
\NormalTok{      m }\OtherTok{\textless{}{-}} \FunctionTok{colnames}\NormalTok{(holdout\_pred)[}\FunctionTok{startsWith}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(holdout\_pred), }\StringTok{"metalearner\_glm\_superlearner\_gbm"}\NormalTok{)]}
\NormalTok{    \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (grid\_name }\SpecialCharTok{==} \StringTok{"Super learner XGBoost"}\NormalTok{) \{}
\NormalTok{      m }\OtherTok{\textless{}{-}} \FunctionTok{colnames}\NormalTok{(holdout\_pred)[}\FunctionTok{startsWith}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(holdout\_pred), }\StringTok{"metalearner\_glm\_superlearner\_xgboost"}\NormalTok{)]}
\NormalTok{    \}}
\NormalTok{    mae }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{    rmse }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{    R2 }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
    \ControlFlowTok{for}\NormalTok{ (k }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{) \{}
\NormalTok{      y\_true }\OtherTok{\textless{}{-}}\NormalTok{ holdout\_pred[fold\_assign }\SpecialCharTok{==}\NormalTok{ k, }\StringTok{"log\_intensity"}\NormalTok{]}
\NormalTok{      y\_pred }\OtherTok{\textless{}{-}}\NormalTok{ holdout\_pred[fold\_assign }\SpecialCharTok{==}\NormalTok{ k, m]}
\NormalTok{      mae }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(mae, }\FunctionTok{MAE}\NormalTok{(}\AttributeTok{y\_pred =}\NormalTok{ y\_pred, }\AttributeTok{y\_true =}\NormalTok{ y\_true))}
\NormalTok{      rmse }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(rmse, }\FunctionTok{RMSE}\NormalTok{(}\AttributeTok{y\_pred =}\NormalTok{ y\_pred, }\AttributeTok{y\_true =}\NormalTok{ y\_true))}
\NormalTok{      R2 }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(R2, }\FunctionTok{R2\_Score}\NormalTok{(}\AttributeTok{y\_pred =}\NormalTok{ y\_pred, }\AttributeTok{y\_true =}\NormalTok{ y\_true))}
\NormalTok{    \}}
    \CommentTok{\# Re{-}scale to 0{-}100}
\NormalTok{    mae }\OtherTok{\textless{}{-}} \FunctionTok{rescale}\NormalTok{(mae, }\AttributeTok{to =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{100}\NormalTok{), }\AttributeTok{from =} \FunctionTok{range}\NormalTok{(mb\_data}\SpecialCharTok{$}\NormalTok{log\_intensity))}
\NormalTok{    rmse }\OtherTok{\textless{}{-}} \FunctionTok{rescale}\NormalTok{(rmse, }\AttributeTok{to =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{100}\NormalTok{), }\AttributeTok{from =} \FunctionTok{range}\NormalTok{(mb\_data}\SpecialCharTok{$}\NormalTok{log\_intensity))}
\NormalTok{    res\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(res\_, }\FunctionTok{c}\NormalTok{(}
      \FunctionTok{mean}\NormalTok{(mae, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{), }\FunctionTok{sem}\NormalTok{(mae),}
      \FunctionTok{mean}\NormalTok{(rmse, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{), }\FunctionTok{sem}\NormalTok{(rmse),}
      \FunctionTok{mean}\NormalTok{(R2, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{), }\FunctionTok{sem}\NormalTok{(R2),}
\NormalTok{      mae, rmse, R2}
\NormalTok{    ))}
\NormalTok{  \} }\ControlFlowTok{else}\NormalTok{ \{}
    \ControlFlowTok{for}\NormalTok{ (j }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(grid\_meta)) \{}
\NormalTok{      g }\OtherTok{\textless{}{-}}\NormalTok{ grid\_meta[[j]]}
\NormalTok{      m }\OtherTok{\textless{}{-}} \FunctionTok{intersect}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(holdout\_pred), g)}
      \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{length}\NormalTok{(m) }\SpecialCharTok{==} \DecValTok{1}\NormalTok{) \{}
\NormalTok{        model\_num }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(model\_num, j)}
\NormalTok{        mae }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{        rmse }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{        R2 }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
        \ControlFlowTok{for}\NormalTok{ (k }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{) \{}
\NormalTok{          y\_true }\OtherTok{\textless{}{-}}\NormalTok{ holdout\_pred[fold\_assign }\SpecialCharTok{==}\NormalTok{ k, }\StringTok{"log\_intensity"}\NormalTok{]}
\NormalTok{          y\_pred }\OtherTok{\textless{}{-}}\NormalTok{ holdout\_pred[fold\_assign }\SpecialCharTok{==}\NormalTok{ k, m]}
\NormalTok{          mae }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(mae, }\FunctionTok{MAE}\NormalTok{(}\AttributeTok{y\_pred =}\NormalTok{ y\_pred, }\AttributeTok{y\_true =}\NormalTok{ y\_true))}
\NormalTok{          rmse }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(rmse, }\FunctionTok{RMSE}\NormalTok{(}\AttributeTok{y\_pred =}\NormalTok{ y\_pred, }\AttributeTok{y\_true =}\NormalTok{ y\_true))}
\NormalTok{          R2 }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(R2, }\FunctionTok{R2\_Score}\NormalTok{(}\AttributeTok{y\_pred =}\NormalTok{ y\_pred, }\AttributeTok{y\_true =}\NormalTok{ y\_true))}
\NormalTok{        \}}
        \CommentTok{\# Re{-}scale to 0{-}100}
\NormalTok{        mae }\OtherTok{\textless{}{-}} \FunctionTok{rescale}\NormalTok{(mae, }\AttributeTok{to =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{100}\NormalTok{), }\AttributeTok{from =} \FunctionTok{range}\NormalTok{(mb\_data}\SpecialCharTok{$}\NormalTok{log\_intensity))}
\NormalTok{        rmse }\OtherTok{\textless{}{-}} \FunctionTok{rescale}\NormalTok{(rmse, }\AttributeTok{to =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{100}\NormalTok{), }\AttributeTok{from =} \FunctionTok{range}\NormalTok{(mb\_data}\SpecialCharTok{$}\NormalTok{log\_intensity))}
\NormalTok{        res\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(res\_, }\FunctionTok{c}\NormalTok{(}
          \FunctionTok{mean}\NormalTok{(mae, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{), }\FunctionTok{sem}\NormalTok{(mae),}
          \FunctionTok{mean}\NormalTok{(rmse, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{), }\FunctionTok{sem}\NormalTok{(rmse),}
          \FunctionTok{mean}\NormalTok{(R2, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{), }\FunctionTok{sem}\NormalTok{(R2),}
\NormalTok{          mae, rmse, R2}
\NormalTok{        ))}
\NormalTok{      \}}
\NormalTok{    \}}
\NormalTok{  \}}
\NormalTok{  res }\OtherTok{\textless{}{-}} \FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{t}\NormalTok{(}\FunctionTok{data.frame}\NormalTok{(res\_)))}
  \FunctionTok{colnames}\NormalTok{(res) }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}
    \StringTok{"Norm. MAE mean"}\NormalTok{, }\StringTok{"Norm. MAE s.e.m."}\NormalTok{, }\StringTok{"Norm. RMSE mean"}\NormalTok{, }\StringTok{"Norm. RMSE s.e.m."}\NormalTok{,}
    \StringTok{"R\^{}2 mean"}\NormalTok{, }\StringTok{"R\^{}2 s.e.m."}\NormalTok{,}
    \FunctionTok{paste}\NormalTok{(}\StringTok{"Norm. MAE CV"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{), }\FunctionTok{paste}\NormalTok{(}\StringTok{"Norm. RMSE CV"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{), }\FunctionTok{paste}\NormalTok{(}\StringTok{"R\^{}2 CV"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{)}
\NormalTok{  )}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{nrow}\NormalTok{(res) }\SpecialCharTok{==} \DecValTok{1}\NormalTok{) \{}
    \FunctionTok{rownames}\NormalTok{(res) }\OtherTok{\textless{}{-}}\NormalTok{ grid\_name}
\NormalTok{  \} }\ControlFlowTok{else}\NormalTok{ \{}
    \FunctionTok{rownames}\NormalTok{(res) }\OtherTok{\textless{}{-}} \FunctionTok{paste}\NormalTok{(grid\_name, model\_num)}
\NormalTok{  \}}
  \FunctionTok{return}\NormalTok{(res)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\hypertarget{inner-loop-model-selection}{%
\subsection{Inner loop model selection}\label{inner-loop-model-selection}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{load}\NormalTok{(}\AttributeTok{file =} \StringTok{"./rdata/model\_training\_grid\_models\_mb.RData"}\NormalTok{)}

\ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{) \{}
\NormalTok{  holdout\_pred }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"./other\_data/melanin\_binding/outer\_"}\NormalTok{, i, }\StringTok{"/cv\_holdout\_predictions.csv"}\NormalTok{))}
\NormalTok{  fold\_assign }\OtherTok{\textless{}{-}} \FunctionTok{rep}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{, }\FunctionTok{ceiling}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(holdout\_pred) }\SpecialCharTok{/} \DecValTok{10}\NormalTok{))[}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(holdout\_pred)]}
\NormalTok{  data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
  \CommentTok{\# Deep learning grid models}
\NormalTok{  data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign,}
    \AttributeTok{grid\_name =} \StringTok{"Neural network grid model"}\NormalTok{,}
    \AttributeTok{grid\_meta =}\NormalTok{ dl\_grid}
\NormalTok{  ))}
  \CommentTok{\# GBM grid models}
\NormalTok{  data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign,}
    \AttributeTok{grid\_name =} \StringTok{"GBM grid model"}\NormalTok{,}
    \AttributeTok{grid\_meta =}\NormalTok{ gbm\_grid}
\NormalTok{  ))}
  \CommentTok{\# GBM default models}
\NormalTok{  data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign,}
    \AttributeTok{grid\_name =} \StringTok{"GBM model"}\NormalTok{,}
    \AttributeTok{grid\_meta =} \FunctionTok{as.list}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"GBM\_"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{5}\NormalTok{))}
\NormalTok{  ))}
  \CommentTok{\# XGBoost grid models}
\NormalTok{  data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign,}
    \AttributeTok{grid\_name =} \StringTok{"XGBoost grid model"}\NormalTok{,}
    \AttributeTok{grid\_meta =}\NormalTok{ xgboost\_grid}
\NormalTok{  ))}
  \CommentTok{\# XGBoost default models}
\NormalTok{  data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign,}
    \AttributeTok{grid\_name =} \StringTok{"XGBoost model"}\NormalTok{,}
    \AttributeTok{grid\_meta =} \FunctionTok{as.list}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"XGBoost\_"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{))}
\NormalTok{  ))}
  \CommentTok{\# GLM}
\NormalTok{  data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign, }\AttributeTok{grid\_name =} \StringTok{"GLM model"}\NormalTok{, }\AttributeTok{grid\_meta =} \FunctionTok{list}\NormalTok{(}\StringTok{"GLM"}\NormalTok{)))}
  \CommentTok{\# DRF}
\NormalTok{  data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign, }\AttributeTok{grid\_name =} \StringTok{"DRF model"}\NormalTok{, }\AttributeTok{grid\_meta =} \FunctionTok{list}\NormalTok{(}\StringTok{"DRF"}\NormalTok{)))}
  \CommentTok{\# XRT}
\NormalTok{  data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign, }\AttributeTok{grid\_name =} \StringTok{"XRT model"}\NormalTok{, }\AttributeTok{grid\_meta =} \FunctionTok{list}\NormalTok{(}\StringTok{"XRT"}\NormalTok{)))}
  \CommentTok{\# Super learner all}
\NormalTok{  data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign, }\AttributeTok{grid\_name =} \StringTok{"Super learner all models"}\NormalTok{))}
  \CommentTok{\# Super learner final}
\NormalTok{  data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign, }\AttributeTok{grid\_name =} \StringTok{"Super learner final"}\NormalTok{))}
  \CommentTok{\# Super learner deep learning}
\NormalTok{  data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign, }\AttributeTok{grid\_name =} \StringTok{"Super learner neural network"}\NormalTok{))}
  \CommentTok{\# Super learner GBM}
\NormalTok{  data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign, }\AttributeTok{grid\_name =} \StringTok{"Super learner GBM"}\NormalTok{))}
  \CommentTok{\# Super learner XGBoost}
\NormalTok{  data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign, }\AttributeTok{grid\_name =} \StringTok{"Super learner XGBoost"}\NormalTok{))}

\NormalTok{  data }\OtherTok{\textless{}{-}} \FunctionTok{do.call}\NormalTok{(rbind, data\_)}
  \FunctionTok{write.csv}\NormalTok{(data, }\FunctionTok{paste0}\NormalTok{(}\StringTok{"./other\_data/melanin\_binding/outer\_"}\NormalTok{, i, }\StringTok{"/cv\_res.csv"}\NormalTok{))}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\hypertarget{cv-1}{%
\subsubsection{CV 1}\label{cv-1}}

\includegraphics{03_model_training_files/figure-latex/unnamed-chunk-12-1.pdf}

\hypertarget{cv-2}{%
\subsubsection{CV 2}\label{cv-2}}

\includegraphics{03_model_training_files/figure-latex/unnamed-chunk-13-1.pdf}

\hypertarget{cv-3}{%
\subsubsection{CV 3}\label{cv-3}}

\includegraphics{03_model_training_files/figure-latex/unnamed-chunk-14-1.pdf}

\hypertarget{cv-4}{%
\subsubsection{CV 4}\label{cv-4}}

\includegraphics{03_model_training_files/figure-latex/unnamed-chunk-15-1.pdf}

\hypertarget{cv-5}{%
\subsubsection{CV 5}\label{cv-5}}

\includegraphics{03_model_training_files/figure-latex/unnamed-chunk-16-1.pdf}

\hypertarget{cv-6}{%
\subsubsection{CV 6}\label{cv-6}}

\includegraphics{03_model_training_files/figure-latex/unnamed-chunk-17-1.pdf}

\hypertarget{cv-7}{%
\subsubsection{CV 7}\label{cv-7}}

\includegraphics{03_model_training_files/figure-latex/unnamed-chunk-18-1.pdf}

\hypertarget{cv-8}{%
\subsubsection{CV 8}\label{cv-8}}

\includegraphics{03_model_training_files/figure-latex/unnamed-chunk-19-1.pdf}

\hypertarget{cv-9}{%
\subsubsection{CV 9}\label{cv-9}}

\includegraphics{03_model_training_files/figure-latex/unnamed-chunk-20-1.pdf}

\hypertarget{cv-10}{%
\subsubsection{CV 10}\label{cv-10}}

\includegraphics{03_model_training_files/figure-latex/unnamed-chunk-21-1.pdf}

\hypertarget{final-evaluation}{%
\subsection{Final evaluation}\label{final-evaluation}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{load}\NormalTok{(}\AttributeTok{file =} \StringTok{"./rdata/var\_reduct\_mb\_train\_test\_splits.RData"}\NormalTok{)}
\NormalTok{dir }\OtherTok{\textless{}{-}} \StringTok{"/Users/renee/Downloads/melanin\_binding"}
\NormalTok{selected\_models }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}
  \StringTok{"Super learner final"}\NormalTok{, }\StringTok{"Super learner final"}\NormalTok{, }\StringTok{"Super learner final"}\NormalTok{,}
  \StringTok{"Super learner final"}\NormalTok{, }\StringTok{"Super learner final"}\NormalTok{, }\StringTok{"Super learner final"}\NormalTok{,}
  \StringTok{"Super learner final"}\NormalTok{, }\StringTok{"Super learner final"}\NormalTok{, }\StringTok{"Super learner final"}\NormalTok{,}
  \StringTok{"Super learner final"}
\NormalTok{)}
\NormalTok{mae }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{rmse }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{R2 }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{) \{}
\NormalTok{  holdout\_pred }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"./other\_data/melanin\_binding/outer\_"}\NormalTok{, i, }\StringTok{"/cv\_holdout\_predictions.csv"}\NormalTok{))}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{startsWith}\NormalTok{(selected\_models[i], }\StringTok{"Neural network grid model"}\NormalTok{)) \{}
\NormalTok{    grid\_num }\OtherTok{\textless{}{-}} \FunctionTok{as.integer}\NormalTok{(}\FunctionTok{str\_extract}\NormalTok{(selected\_models[i], }\StringTok{"[0{-}9]+"}\NormalTok{))}
\NormalTok{    m }\OtherTok{\textless{}{-}} \FunctionTok{intersect}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(holdout\_pred), dl\_grid[[grid\_num]])}
\NormalTok{    model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/outer\_"}\NormalTok{, i, }\StringTok{"/"}\NormalTok{, m))}
\NormalTok{  \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{startsWith}\NormalTok{(selected\_models[i], }\StringTok{"GBM grid model"}\NormalTok{)) \{}
\NormalTok{    grid\_num }\OtherTok{\textless{}{-}} \FunctionTok{as.integer}\NormalTok{(}\FunctionTok{str\_extract}\NormalTok{(selected\_models[i], }\StringTok{"[0{-}9]+"}\NormalTok{))}
\NormalTok{    m }\OtherTok{\textless{}{-}} \FunctionTok{intersect}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(holdout\_pred), gbm\_grid[[grid\_num]])}
\NormalTok{    model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/outer\_"}\NormalTok{, i, }\StringTok{"/"}\NormalTok{, m))}
\NormalTok{  \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{startsWith}\NormalTok{(selected\_models[i], }\StringTok{"GBM model"}\NormalTok{)) \{}
\NormalTok{    grid\_num }\OtherTok{\textless{}{-}} \FunctionTok{as.integer}\NormalTok{(}\FunctionTok{str\_extract}\NormalTok{(selected\_models[i], }\StringTok{"[0{-}9]+"}\NormalTok{))}
\NormalTok{    model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/outer\_"}\NormalTok{, i, }\StringTok{"/GBM\_"}\NormalTok{, grid\_num))}
\NormalTok{  \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{startsWith}\NormalTok{(selected\_models[i], }\StringTok{"XGBoost grid model"}\NormalTok{)) \{}
\NormalTok{    grid\_num }\OtherTok{\textless{}{-}} \FunctionTok{as.integer}\NormalTok{(}\FunctionTok{str\_extract}\NormalTok{(selected\_models[i], }\StringTok{"[0{-}9]+"}\NormalTok{))}
\NormalTok{    m }\OtherTok{\textless{}{-}} \FunctionTok{intersect}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(holdout\_pred), xgboost\_grid[[grid\_num]])}
\NormalTok{    model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/outer\_"}\NormalTok{, i, }\StringTok{"/"}\NormalTok{, m))}
\NormalTok{  \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{startsWith}\NormalTok{(selected\_models[i], }\StringTok{"XGBoost model"}\NormalTok{)) \{}
\NormalTok{    grid\_num }\OtherTok{\textless{}{-}} \FunctionTok{as.integer}\NormalTok{(}\FunctionTok{str\_extract}\NormalTok{(selected\_models[i], }\StringTok{"[0{-}9]+"}\NormalTok{))}
\NormalTok{    model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/outer\_"}\NormalTok{, i, }\StringTok{"/XGBoost\_"}\NormalTok{, grid\_num))}
\NormalTok{  \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (selected\_models[i] }\SpecialCharTok{==} \StringTok{"Super learner all models"}\NormalTok{) \{}
\NormalTok{    model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/outer\_"}\NormalTok{, i, }\StringTok{"/superlearner\_iter\_0"}\NormalTok{))}
\NormalTok{  \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (selected\_models[i] }\SpecialCharTok{==} \StringTok{"Super learner final"}\NormalTok{) \{}
\NormalTok{    files }\OtherTok{\textless{}{-}} \FunctionTok{list.files}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/outer\_"}\NormalTok{, i))}
\NormalTok{    files }\OtherTok{\textless{}{-}}\NormalTok{ files[}\FunctionTok{startsWith}\NormalTok{(files, }\StringTok{"superlearner\_iter"}\NormalTok{)]}
\NormalTok{    model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/outer\_"}\NormalTok{, i, }\StringTok{"/"}\NormalTok{, files[}\FunctionTok{length}\NormalTok{(files)]))}
\NormalTok{  \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (selected\_models[i] }\SpecialCharTok{==} \StringTok{"Super learner neural network"}\NormalTok{) \{}
\NormalTok{    model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/outer\_"}\NormalTok{, i, }\StringTok{"/superlearner\_deeplearning"}\NormalTok{))}
\NormalTok{  \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (selected\_models[i] }\SpecialCharTok{==} \StringTok{"Super learner GBM"}\NormalTok{) \{}
\NormalTok{    model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/outer\_"}\NormalTok{, i, }\StringTok{"/superlearner\_gbm"}\NormalTok{))}
\NormalTok{  \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (selected\_models[i] }\SpecialCharTok{==} \StringTok{"Super learner XGBoost"}\NormalTok{) \{}
\NormalTok{    model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/outer\_"}\NormalTok{, i, }\StringTok{"/superlearner\_xgboost"}\NormalTok{))}
\NormalTok{  \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{    model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/outer\_"}\NormalTok{, i, }\StringTok{"/"}\NormalTok{, }\FunctionTok{unlist}\NormalTok{(}\FunctionTok{strsplit}\NormalTok{(selected\_models[i], }\StringTok{" "}\NormalTok{))[}\DecValTok{1}\NormalTok{]))}
\NormalTok{  \}}
\NormalTok{  tmp }\OtherTok{\textless{}{-}} \FunctionTok{as.h2o}\NormalTok{(}\FunctionTok{subset}\NormalTok{(outer\_splits[[i]][[}\StringTok{"test"}\NormalTok{]], }\AttributeTok{select =} \SpecialCharTok{{-}}\NormalTok{log\_intensity))}
\NormalTok{  y\_true }\OtherTok{\textless{}{-}}\NormalTok{ outer\_splits[[i]][[}\StringTok{"test"}\NormalTok{]]}\SpecialCharTok{$}\NormalTok{log\_intensity}
\NormalTok{  y\_pred }\OtherTok{\textless{}{-}} \FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{h2o.predict}\NormalTok{(model, tmp)))[, }\DecValTok{1}\NormalTok{]}
\NormalTok{  mae }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(mae, }\FunctionTok{MAE}\NormalTok{(}\AttributeTok{y\_pred =}\NormalTok{ y\_pred, }\AttributeTok{y\_true =}\NormalTok{ y\_true))}
\NormalTok{  rmse }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(rmse, }\FunctionTok{RMSE}\NormalTok{(}\AttributeTok{y\_pred =}\NormalTok{ y\_pred, }\AttributeTok{y\_true =}\NormalTok{ y\_true))}
\NormalTok{  R2 }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(R2, }\FunctionTok{R2\_Score}\NormalTok{(}\AttributeTok{y\_pred =}\NormalTok{ y\_pred, }\AttributeTok{y\_true =}\NormalTok{ y\_true))}
\NormalTok{\}}

\CommentTok{\# Re{-}scale to 0{-}100}
\NormalTok{mae }\OtherTok{\textless{}{-}} \FunctionTok{rescale}\NormalTok{(mae, }\AttributeTok{to =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{100}\NormalTok{), }\AttributeTok{from =} \FunctionTok{range}\NormalTok{(mb\_data}\SpecialCharTok{$}\NormalTok{log\_intensity))}
\NormalTok{rmse }\OtherTok{\textless{}{-}} \FunctionTok{rescale}\NormalTok{(rmse, }\AttributeTok{to =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{100}\NormalTok{), }\AttributeTok{from =} \FunctionTok{range}\NormalTok{(mb\_data}\SpecialCharTok{$}\NormalTok{log\_intensity))}

\FunctionTok{h2o.removeAll}\NormalTok{()}
\FunctionTok{save}\NormalTok{(mae, rmse, R2, }\AttributeTok{file =} \StringTok{"./rdata/final\_evaluation\_mb.RData"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{load}\NormalTok{(}\AttributeTok{file =} \StringTok{"./rdata/final\_evaluation\_mb.RData"}\NormalTok{)}
\FunctionTok{data.frame}\NormalTok{(}
  \AttributeTok{Metric =} \FunctionTok{c}\NormalTok{(}\StringTok{"Norm. MAE"}\NormalTok{, }\StringTok{"Norm. RMSE"}\NormalTok{, }\StringTok{"R\textless{}sup\textgreater{}2\textless{}/sup\textgreater{}"}\NormalTok{),}
  \StringTok{\textasciigrave{}}\AttributeTok{Mean  s.e.m.}\StringTok{\textasciigrave{}} \OtherTok{=} \FunctionTok{c}\NormalTok{(}
    \FunctionTok{paste0}\NormalTok{(}\FunctionTok{round}\NormalTok{(}\FunctionTok{mean}\NormalTok{(mae), }\DecValTok{3}\NormalTok{), }\StringTok{"  "}\NormalTok{, }\FunctionTok{round}\NormalTok{(}\FunctionTok{sem}\NormalTok{(mae), }\DecValTok{3}\NormalTok{)),}
    \FunctionTok{paste0}\NormalTok{(}\FunctionTok{round}\NormalTok{(}\FunctionTok{mean}\NormalTok{(rmse), }\DecValTok{3}\NormalTok{), }\StringTok{"  "}\NormalTok{, }\FunctionTok{round}\NormalTok{(}\FunctionTok{sem}\NormalTok{(rmse), }\DecValTok{3}\NormalTok{)),}
    \FunctionTok{paste0}\NormalTok{(}\FunctionTok{round}\NormalTok{(}\FunctionTok{mean}\NormalTok{(R2), }\DecValTok{3}\NormalTok{), }\StringTok{"  "}\NormalTok{, }\FunctionTok{round}\NormalTok{(}\FunctionTok{sem}\NormalTok{(R2), }\DecValTok{3}\NormalTok{))}
\NormalTok{  ),}
  \AttributeTok{check.names =} \ConstantTok{FALSE}
\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{datatable}\NormalTok{(}\AttributeTok{escape =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{rownames =} \ConstantTok{FALSE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{03_model_training_files/figure-latex/unnamed-chunk-23-1.pdf}

\hypertarget{final-model-selection}{%
\subsection{Final model selection}\label{final-model-selection}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{load}\NormalTok{(}\AttributeTok{file =} \StringTok{"./rdata/model\_training\_grid\_models\_mb.RData"}\NormalTok{)}

\NormalTok{holdout\_pred }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\StringTok{"./other\_data/melanin\_binding/whole\_data\_set/cv\_holdout\_predictions.csv"}\NormalTok{)}
\NormalTok{fold\_assign }\OtherTok{\textless{}{-}} \FunctionTok{rep}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{, }\FunctionTok{ceiling}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(holdout\_pred) }\SpecialCharTok{/} \DecValTok{10}\NormalTok{))[}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(holdout\_pred)]}
\NormalTok{data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
\CommentTok{\# Deep learning grid models}
\NormalTok{data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign,}
  \AttributeTok{grid\_name =} \StringTok{"Neural network grid model"}\NormalTok{,}
  \AttributeTok{grid\_meta =}\NormalTok{ dl\_grid}
\NormalTok{))}
\CommentTok{\# GBM grid models}
\NormalTok{data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign,}
  \AttributeTok{grid\_name =} \StringTok{"GBM grid model"}\NormalTok{,}
  \AttributeTok{grid\_meta =}\NormalTok{ gbm\_grid}
\NormalTok{))}
\CommentTok{\# GBM default models}
\NormalTok{data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign,}
  \AttributeTok{grid\_name =} \StringTok{"GBM model"}\NormalTok{,}
  \AttributeTok{grid\_meta =} \FunctionTok{as.list}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"GBM\_"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{5}\NormalTok{))}
\NormalTok{))}
\CommentTok{\# XGBoost grid models}
\NormalTok{data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign,}
  \AttributeTok{grid\_name =} \StringTok{"XGBoost grid model"}\NormalTok{,}
  \AttributeTok{grid\_meta =}\NormalTok{ xgboost\_grid}
\NormalTok{))}
\CommentTok{\# XGBoost default models}
\NormalTok{data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign,}
  \AttributeTok{grid\_name =} \StringTok{"XGBoost model"}\NormalTok{,}
  \AttributeTok{grid\_meta =} \FunctionTok{as.list}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"XGBoost\_"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{))}
\NormalTok{))}
\CommentTok{\# GLM}
\NormalTok{data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign, }\AttributeTok{grid\_name =} \StringTok{"GLM model"}\NormalTok{, }\AttributeTok{grid\_meta =} \FunctionTok{list}\NormalTok{(}\StringTok{"GLM"}\NormalTok{)))}
\CommentTok{\# DRF}
\NormalTok{data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign, }\AttributeTok{grid\_name =} \StringTok{"DRF model"}\NormalTok{, }\AttributeTok{grid\_meta =} \FunctionTok{list}\NormalTok{(}\StringTok{"DRF"}\NormalTok{)))}
\CommentTok{\# XRT}
\NormalTok{data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign, }\AttributeTok{grid\_name =} \StringTok{"XRT model"}\NormalTok{, }\AttributeTok{grid\_meta =} \FunctionTok{list}\NormalTok{(}\StringTok{"XRT"}\NormalTok{)))}
\CommentTok{\# Super learner all}
\NormalTok{data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign, }\AttributeTok{grid\_name =} \StringTok{"Super learner all models"}\NormalTok{))}
\CommentTok{\# Super learner final}
\NormalTok{data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign, }\AttributeTok{grid\_name =} \StringTok{"Super learner final"}\NormalTok{))}
\CommentTok{\# Super learner deep learning}
\NormalTok{data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign, }\AttributeTok{grid\_name =} \StringTok{"Super learner neural network"}\NormalTok{))}
\CommentTok{\# Super learner GBM}
\NormalTok{data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign, }\AttributeTok{grid\_name =} \StringTok{"Super learner GBM"}\NormalTok{))}
\CommentTok{\# Super learner XGBoost}
\NormalTok{data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign, }\AttributeTok{grid\_name =} \StringTok{"Super learner XGBoost"}\NormalTok{))}

\NormalTok{data }\OtherTok{\textless{}{-}} \FunctionTok{do.call}\NormalTok{(rbind, data\_)}
\FunctionTok{write.csv}\NormalTok{(data, }\StringTok{"./other\_data/melanin\_binding/whole\_data\_set/cv\_res.csv"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\StringTok{"./other\_data/melanin\_binding/whole\_data\_set/cv\_res.csv"}\NormalTok{, }\AttributeTok{row.names =} \DecValTok{1}\NormalTok{, }\AttributeTok{check.names =} \ConstantTok{FALSE}\NormalTok{)}
\FunctionTok{statistical\_testing}\NormalTok{(data, }\AttributeTok{metric\_vec =} \FunctionTok{c}\NormalTok{(}\StringTok{"Norm. MAE"}\NormalTok{, }\StringTok{"Norm. RMSE"}\NormalTok{, }\StringTok{"R\^{}2"}\NormalTok{), }\AttributeTok{decreasing\_vec =} \FunctionTok{c}\NormalTok{(}\ConstantTok{FALSE}\NormalTok{, }\ConstantTok{FALSE}\NormalTok{, }\ConstantTok{TRUE}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\includegraphics{03_model_training_files/figure-latex/unnamed-chunk-25-1.pdf}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# statistical\_testing(data, metric\_vec=c(\textquotesingle{}Norm. MAE\textquotesingle{}, \textquotesingle{}Norm. RMSE\textquotesingle{}, \textquotesingle{}R\^{}2\textquotesingle{}), decreasing\_vec=c(FALSE, FALSE, TRUE),}
\CommentTok{\#                     output\_path=\textquotesingle{}./other\_data/melanin\_binding/whole\_data\_set/cv\_res\_statistical\_testing.csv\textquotesingle{})}
\end{Highlighting}
\end{Shaded}

\hypertarget{final-reduced-sl}{%
\subsection{Final reduced SL}\label{final-reduced-sl}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{h2o.init}\NormalTok{(}\AttributeTok{nthreads =} \SpecialCharTok{{-}}\DecValTok{1}\NormalTok{)}
\NormalTok{model\_path }\OtherTok{\textless{}{-}} \StringTok{"/Users/renee/Downloads/melanin\_binding/whole\_data\_set/superlearner\_iter\_3"}
\NormalTok{model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(model\_path)}
\FunctionTok{load}\NormalTok{(}\AttributeTok{file =} \StringTok{"./rdata/model\_training\_grid\_models\_mb.RData"}\NormalTok{)}
\NormalTok{data }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\StringTok{"./other\_data/melanin\_binding/whole\_data\_set/cv\_res.csv"}\NormalTok{, }\AttributeTok{row.names =} \DecValTok{1}\NormalTok{, }\AttributeTok{check.names =} \ConstantTok{FALSE}\NormalTok{)}
\NormalTok{df }\OtherTok{\textless{}{-}} \FunctionTok{as.data.frame}\NormalTok{(model}\SpecialCharTok{@}\NormalTok{model}\SpecialCharTok{$}\NormalTok{metalearner\_model}\SpecialCharTok{@}\NormalTok{model}\SpecialCharTok{$}\NormalTok{coefficients\_table)[}\FunctionTok{c}\NormalTok{(}\StringTok{"names"}\NormalTok{, }\StringTok{"standardized\_coefficients"}\NormalTok{)][}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{, ]}

\ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(df)) \{}
\NormalTok{  name }\OtherTok{\textless{}{-}}\NormalTok{ df}\SpecialCharTok{$}\NormalTok{names[i]}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{startsWith}\NormalTok{(name, }\StringTok{"DeepLearning\_model"}\NormalTok{)) \{}
    \ControlFlowTok{for}\NormalTok{ (j }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(dl\_grid)) \{}
      \ControlFlowTok{if}\NormalTok{ (name }\SpecialCharTok{\%in\%}\NormalTok{ dl\_grid[[j]]) }\ControlFlowTok{break}
\NormalTok{    \}}
\NormalTok{    df}\SpecialCharTok{$}\NormalTok{names[i] }\OtherTok{\textless{}{-}} \FunctionTok{paste}\NormalTok{(}\StringTok{"Neural network grid model"}\NormalTok{, j)}
\NormalTok{  \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{startsWith}\NormalTok{(name, }\StringTok{"GBM\_model"}\NormalTok{)) \{}
    \ControlFlowTok{for}\NormalTok{ (j }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(gbm\_grid)) \{}
      \ControlFlowTok{if}\NormalTok{ (name }\SpecialCharTok{\%in\%}\NormalTok{ gbm\_grid[[j]]) }\ControlFlowTok{break}
\NormalTok{    \}}
\NormalTok{    df}\SpecialCharTok{$}\NormalTok{names[i] }\OtherTok{\textless{}{-}} \FunctionTok{paste}\NormalTok{(}\StringTok{"GBM grid model"}\NormalTok{, j)}
\NormalTok{  \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{startsWith}\NormalTok{(name, }\StringTok{"XGBoost\_model"}\NormalTok{)) \{}
    \ControlFlowTok{for}\NormalTok{ (j }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(xgboost\_grid)) \{}
      \ControlFlowTok{if}\NormalTok{ (name }\SpecialCharTok{\%in\%}\NormalTok{ xgboost\_grid[[j]]) }\ControlFlowTok{break}
\NormalTok{    \}}
\NormalTok{    df}\SpecialCharTok{$}\NormalTok{names[i] }\OtherTok{\textless{}{-}} \FunctionTok{paste}\NormalTok{(}\StringTok{"XGBoost grid model"}\NormalTok{, j)}
\NormalTok{  \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{    df}\SpecialCharTok{$}\NormalTok{names[i] }\OtherTok{\textless{}{-}} \FunctionTok{paste}\NormalTok{(}\FunctionTok{strsplit}\NormalTok{(name, }\StringTok{"\_"}\NormalTok{)[[}\DecValTok{1}\NormalTok{]], }\AttributeTok{collapse =} \StringTok{" model "}\NormalTok{)}
\NormalTok{  \}}
\NormalTok{\}}

\FunctionTok{rownames}\NormalTok{(df) }\OtherTok{\textless{}{-}}\NormalTok{ df}\SpecialCharTok{$}\NormalTok{names}
\NormalTok{df }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(df, data[}\StringTok{"R\^{}2 mean"}\NormalTok{], }\AttributeTok{by =} \StringTok{"row.names"}\NormalTok{)[, }\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{]}
\NormalTok{df }\OtherTok{\textless{}{-}}\NormalTok{ df[df}\SpecialCharTok{$}\NormalTok{standardized\_coefficients }\SpecialCharTok{\textgreater{}} \DecValTok{0}\NormalTok{, ]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{p1 }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(df, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =} \FunctionTok{reorder}\NormalTok{(names, standardized\_coefficients), }\AttributeTok{y =}\NormalTok{ standardized\_coefficients, }\AttributeTok{fill =} \StringTok{\textasciigrave{}}\AttributeTok{R\^{}2 mean}\StringTok{\textasciigrave{}}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{geom\_col}\NormalTok{(}\AttributeTok{color =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \FloatTok{0.2}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_fill\_gradient}\NormalTok{(}\AttributeTok{low =} \StringTok{"white"}\NormalTok{, }\AttributeTok{high =} \StringTok{"red"}\NormalTok{, }\AttributeTok{n.breaks =} \DecValTok{4}\NormalTok{, }\AttributeTok{limits =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.30}\NormalTok{, }\FloatTok{0.60}\NormalTok{), }\AttributeTok{breaks =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.3}\NormalTok{, }\FloatTok{0.4}\NormalTok{, }\FloatTok{0.5}\NormalTok{, }\FloatTok{0.6}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{geom\_text}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{label =} \FunctionTok{sprintf}\NormalTok{(}\StringTok{"\%.2f"}\NormalTok{, }\StringTok{\textasciigrave{}}\AttributeTok{R\^{}2 mean}\StringTok{\textasciigrave{}}\NormalTok{)), }\AttributeTok{nudge\_y =} \SpecialCharTok{{-}}\FloatTok{0.002}\NormalTok{, }\AttributeTok{size =} \DecValTok{3}\NormalTok{, }\AttributeTok{color =} \StringTok{"white"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_text}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{label =} \FunctionTok{sprintf}\NormalTok{(}\StringTok{"\%.3f"}\NormalTok{, standardized\_coefficients)), }\AttributeTok{nudge\_y =} \FloatTok{0.0025}\NormalTok{, }\AttributeTok{size =} \DecValTok{3}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{coord\_flip}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{scale\_y\_continuous}\NormalTok{(}\AttributeTok{limits =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FunctionTok{max}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{standardized\_coefficients) }\SpecialCharTok{+} \FloatTok{0.005}\NormalTok{), }\AttributeTok{expand =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.01}\NormalTok{, }\DecValTok{0}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{theme\_bw}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}
    \AttributeTok{panel.grid.major =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{panel.grid.minor =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{strip.background =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{panel.border =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{axis.line =} \FunctionTok{element\_line}\NormalTok{(}\AttributeTok{color =} \StringTok{"black"}\NormalTok{),}
    \AttributeTok{legend.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{10}\NormalTok{),}
    \AttributeTok{plot.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{hjust =} \FloatTok{0.5}\NormalTok{, }\AttributeTok{size =} \DecValTok{18}\NormalTok{),}
    \AttributeTok{plot.margin =}\NormalTok{ ggplot2}\SpecialCharTok{::}\FunctionTok{margin}\NormalTok{(}\DecValTok{10}\NormalTok{, }\DecValTok{10}\NormalTok{, }\DecValTok{10}\NormalTok{, }\DecValTok{0}\NormalTok{, }\StringTok{"pt"}\NormalTok{),}
    \AttributeTok{axis.title.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{18}\NormalTok{),}
    \AttributeTok{axis.title.y =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{18}\NormalTok{),}
    \AttributeTok{axis.text.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{12}\NormalTok{),}
    \AttributeTok{axis.text.y =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{12}\NormalTok{),}
    \AttributeTok{legend.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{14}\NormalTok{),}
    \AttributeTok{legend.position =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.85}\NormalTok{, }\FloatTok{0.5}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{guides}\NormalTok{(}\AttributeTok{fill =} \FunctionTok{guide\_colorbar}\NormalTok{(}\AttributeTok{title =} \FunctionTok{expression}\NormalTok{(}\FunctionTok{italic}\NormalTok{(}\StringTok{"R"}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{)))) }\SpecialCharTok{+}
  \FunctionTok{xlab}\NormalTok{(}\StringTok{""}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{ylab}\NormalTok{(}\StringTok{"Coefficient"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{ggtitle}\NormalTok{(}\StringTok{"Melanin binding"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics[width=1\linewidth]{./figures/Fig 2 mb super learner} \end{center}

\hypertarget{cell-penetration-classification-1}{%
\section{Cell-penetration (classification)}\label{cell-penetration-classification-1}}

\hypertarget{model-training-1}{%
\subsection{Model training}\label{model-training-1}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{train\_cpp\_models }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(train\_set, exp\_dir, prefix, }\AttributeTok{nfolds =} \DecValTok{10}\NormalTok{, }\AttributeTok{grid\_seed =} \DecValTok{1}\NormalTok{) \{}
\NormalTok{  tmp }\OtherTok{\textless{}{-}} \FunctionTok{as.h2o}\NormalTok{(train\_set, }\AttributeTok{destination\_frame =}\NormalTok{ prefix)}
\NormalTok{  tmp[}\StringTok{"category"}\NormalTok{] }\OtherTok{\textless{}{-}} \FunctionTok{as.factor}\NormalTok{(tmp[}\StringTok{"category"}\NormalTok{])}
\NormalTok{  y }\OtherTok{\textless{}{-}} \StringTok{"category"}
\NormalTok{  x }\OtherTok{\textless{}{-}} \FunctionTok{setdiff}\NormalTok{(}\FunctionTok{names}\NormalTok{(tmp), y)}
\NormalTok{  res }\OtherTok{\textless{}{-}} \FunctionTok{as.data.frame}\NormalTok{(tmp}\SpecialCharTok{$}\NormalTok{category)}
\NormalTok{  samp\_factors }\OtherTok{\textless{}{-}} \FunctionTok{as.vector}\NormalTok{(}\FunctionTok{mean}\NormalTok{(}\FunctionTok{table}\NormalTok{(train\_set}\SpecialCharTok{$}\NormalTok{category)) }\SpecialCharTok{/} \FunctionTok{table}\NormalTok{(train\_set}\SpecialCharTok{$}\NormalTok{category))}
  \CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
  \CommentTok{\# base model training}
  \CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"Deep learning grid 1}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  deeplearning\_1 }\OtherTok{\textless{}{-}} \FunctionTok{h2o.grid}\NormalTok{(}
    \AttributeTok{algorithm =} \StringTok{"deeplearning"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{hyper\_params =}\NormalTok{ deeplearning\_params\_1,}
    \AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{, }\AttributeTok{balance\_classes =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{class\_sampling\_factors =}\NormalTok{ samp\_factors,}
    \AttributeTok{search\_criteria =} \FunctionTok{list}\NormalTok{(}
      \AttributeTok{strategy =} \StringTok{"RandomDiscrete"}\NormalTok{,}
      \AttributeTok{max\_models =} \DecValTok{100}\NormalTok{, }\AttributeTok{seed =}\NormalTok{ grid\_seed}
\NormalTok{    ),}
    \AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}\NormalTok{, }\AttributeTok{parallelism =} \DecValTok{0}
\NormalTok{  )}
  \ControlFlowTok{for}\NormalTok{ (model\_id }\ControlFlowTok{in}\NormalTok{ deeplearning\_1}\SpecialCharTok{@}\NormalTok{model\_ids) \{}
\NormalTok{    tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(model\_id), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  \}}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"GBM grid}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  gbm }\OtherTok{\textless{}{-}} \FunctionTok{h2o.grid}\NormalTok{(}
    \AttributeTok{algorithm =} \StringTok{"gbm"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{hyper\_params =}\NormalTok{ gbm\_params, }\AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{,}
    \AttributeTok{balance\_classes =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{class\_sampling\_factors =}\NormalTok{ samp\_factors,}
    \AttributeTok{search\_criteria =} \FunctionTok{list}\NormalTok{(}\AttributeTok{strategy =} \StringTok{"RandomDiscrete"}\NormalTok{, }\AttributeTok{max\_models =} \DecValTok{100}\NormalTok{, }\AttributeTok{seed =}\NormalTok{ grid\_seed),}
    \AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}\NormalTok{, }\AttributeTok{parallelism =} \DecValTok{0}
\NormalTok{  )}
  \ControlFlowTok{for}\NormalTok{ (model\_id }\ControlFlowTok{in}\NormalTok{ gbm}\SpecialCharTok{@}\NormalTok{model\_ids) \{}
\NormalTok{    tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(model\_id), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  \}}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"GBM 5 default models}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  gbm\_1 }\OtherTok{\textless{}{-}} \FunctionTok{h2o.gbm}\NormalTok{(}
    \AttributeTok{model\_id =} \StringTok{"GBM\_1"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{, }\AttributeTok{score\_tree\_interval =} \DecValTok{5}\NormalTok{,}
    \AttributeTok{balance\_classes =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{class\_sampling\_factors =}\NormalTok{ samp\_factors,}
    \AttributeTok{col\_sample\_rate =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{col\_sample\_rate\_per\_tree =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{learn\_rate =} \FloatTok{0.1}\NormalTok{,}
    \AttributeTok{max\_depth =} \DecValTok{6}\NormalTok{, }\AttributeTok{min\_rows =} \DecValTok{1}\NormalTok{, }\AttributeTok{min\_split\_improvement =} \FloatTok{1e{-}5}\NormalTok{, }\AttributeTok{ntrees =} \DecValTok{10000}\NormalTok{, }\AttributeTok{sample\_rate =} \FloatTok{0.8}\NormalTok{,}
    \AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}
\NormalTok{  )}
\NormalTok{  gbm\_2 }\OtherTok{\textless{}{-}} \FunctionTok{h2o.gbm}\NormalTok{(}
    \AttributeTok{model\_id =} \StringTok{"GBM\_2"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{, }\AttributeTok{score\_tree\_interval =} \DecValTok{5}\NormalTok{,}
    \AttributeTok{balance\_classes =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{class\_sampling\_factors =}\NormalTok{ samp\_factors,}
    \AttributeTok{col\_sample\_rate =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{col\_sample\_rate\_per\_tree =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{learn\_rate =} \FloatTok{0.1}\NormalTok{,}
    \AttributeTok{max\_depth =} \DecValTok{7}\NormalTok{, }\AttributeTok{min\_rows =} \DecValTok{10}\NormalTok{, }\AttributeTok{min\_split\_improvement =} \FloatTok{1e{-}5}\NormalTok{, }\AttributeTok{ntrees =} \DecValTok{10000}\NormalTok{, }\AttributeTok{sample\_rate =} \FloatTok{0.8}\NormalTok{,}
    \AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}
\NormalTok{  )}
\NormalTok{  gbm\_3 }\OtherTok{\textless{}{-}} \FunctionTok{h2o.gbm}\NormalTok{(}
    \AttributeTok{model\_id =} \StringTok{"GBM\_3"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{, }\AttributeTok{score\_tree\_interval =} \DecValTok{5}\NormalTok{,}
    \AttributeTok{balance\_classes =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{class\_sampling\_factors =}\NormalTok{ samp\_factors,}
    \AttributeTok{col\_sample\_rate =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{col\_sample\_rate\_per\_tree =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{learn\_rate =} \FloatTok{0.1}\NormalTok{,}
    \AttributeTok{max\_depth =} \DecValTok{8}\NormalTok{, }\AttributeTok{min\_rows =} \DecValTok{10}\NormalTok{, }\AttributeTok{min\_split\_improvement =} \FloatTok{1e{-}5}\NormalTok{, }\AttributeTok{ntrees =} \DecValTok{10000}\NormalTok{, }\AttributeTok{sample\_rate =} \FloatTok{0.8}\NormalTok{,}
    \AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}
\NormalTok{  )}
\NormalTok{  gbm\_4 }\OtherTok{\textless{}{-}} \FunctionTok{h2o.gbm}\NormalTok{(}
    \AttributeTok{model\_id =} \StringTok{"GBM\_4"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{, }\AttributeTok{score\_tree\_interval =} \DecValTok{5}\NormalTok{,}
    \AttributeTok{balance\_classes =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{class\_sampling\_factors =}\NormalTok{ samp\_factors,}
    \AttributeTok{col\_sample\_rate =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{col\_sample\_rate\_per\_tree =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{learn\_rate =} \FloatTok{0.1}\NormalTok{,}
    \AttributeTok{max\_depth =} \DecValTok{10}\NormalTok{, }\AttributeTok{min\_rows =} \DecValTok{10}\NormalTok{, }\AttributeTok{min\_split\_improvement =} \FloatTok{1e{-}5}\NormalTok{, }\AttributeTok{ntrees =} \DecValTok{10000}\NormalTok{, }\AttributeTok{sample\_rate =} \FloatTok{0.8}\NormalTok{,}
    \AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}
\NormalTok{  )}
\NormalTok{  gbm\_5 }\OtherTok{\textless{}{-}} \FunctionTok{h2o.gbm}\NormalTok{(}
    \AttributeTok{model\_id =} \StringTok{"GBM\_5"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{, }\AttributeTok{score\_tree\_interval =} \DecValTok{5}\NormalTok{,}
    \AttributeTok{balance\_classes =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{class\_sampling\_factors =}\NormalTok{ samp\_factors,}
    \AttributeTok{col\_sample\_rate =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{col\_sample\_rate\_per\_tree =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{learn\_rate =} \FloatTok{0.1}\NormalTok{,}
    \AttributeTok{max\_depth =} \DecValTok{15}\NormalTok{, }\AttributeTok{min\_rows =} \DecValTok{100}\NormalTok{, }\AttributeTok{min\_split\_improvement =} \FloatTok{1e{-}5}\NormalTok{, }\AttributeTok{ntrees =} \DecValTok{10000}\NormalTok{, }\AttributeTok{sample\_rate =} \FloatTok{0.8}\NormalTok{,}
    \AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}
\NormalTok{  )}
  \ControlFlowTok{for}\NormalTok{ (model\_id }\ControlFlowTok{in} \FunctionTok{paste0}\NormalTok{(}\StringTok{"GBM\_"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{5}\NormalTok{)) \{}
\NormalTok{    tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(model\_id), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  \}}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"XGBoost grid}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  xgboost }\OtherTok{\textless{}{-}} \FunctionTok{h2o.grid}\NormalTok{(}
    \AttributeTok{algorithm =} \StringTok{"xgboost"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{hyper\_params =}\NormalTok{ xgboost\_params, }\AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{,}
    \AttributeTok{search\_criteria =} \FunctionTok{list}\NormalTok{(}\AttributeTok{strategy =} \StringTok{"RandomDiscrete"}\NormalTok{, }\AttributeTok{max\_models =} \DecValTok{100}\NormalTok{, }\AttributeTok{seed =}\NormalTok{ grid\_seed),}
    \AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}\NormalTok{, }\AttributeTok{parallelism =} \DecValTok{0}
\NormalTok{  )}
  \ControlFlowTok{for}\NormalTok{ (model\_id }\ControlFlowTok{in}\NormalTok{ xgboost}\SpecialCharTok{@}\NormalTok{model\_ids) \{}
\NormalTok{    tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(model\_id), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  \}}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"XGBoost 3 default models}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  xgboost\_1 }\OtherTok{\textless{}{-}} \FunctionTok{h2o.xgboost}\NormalTok{(}
    \AttributeTok{model\_id =} \StringTok{"XGBoost\_1"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{, }\AttributeTok{score\_tree\_interval =} \DecValTok{5}\NormalTok{,}
    \AttributeTok{booster =} \StringTok{"gbtree"}\NormalTok{, }\AttributeTok{col\_sample\_rate =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{col\_sample\_rate\_per\_tree =} \FloatTok{0.8}\NormalTok{,}
    \AttributeTok{max\_depth =} \DecValTok{10}\NormalTok{, }\AttributeTok{min\_rows =} \DecValTok{5}\NormalTok{, }\AttributeTok{ntrees =} \DecValTok{10000}\NormalTok{, }\AttributeTok{reg\_alpha =} \DecValTok{0}\NormalTok{, }\AttributeTok{reg\_lambda =} \DecValTok{1}\NormalTok{,}
    \AttributeTok{sample\_rate =} \FloatTok{0.6}\NormalTok{, }\AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}
\NormalTok{  )}
\NormalTok{  xgboost\_2 }\OtherTok{\textless{}{-}} \FunctionTok{h2o.xgboost}\NormalTok{(}
    \AttributeTok{model\_id =} \StringTok{"XGBoost\_2"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{, }\AttributeTok{score\_tree\_interval =} \DecValTok{5}\NormalTok{,}
    \AttributeTok{booster =} \StringTok{"gbtree"}\NormalTok{, }\AttributeTok{col\_sample\_rate =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{col\_sample\_rate\_per\_tree =} \FloatTok{0.8}\NormalTok{,}
    \AttributeTok{max\_depth =} \DecValTok{20}\NormalTok{, }\AttributeTok{min\_rows =} \DecValTok{10}\NormalTok{, }\AttributeTok{ntrees =} \DecValTok{10000}\NormalTok{, }\AttributeTok{reg\_alpha =} \DecValTok{0}\NormalTok{, }\AttributeTok{reg\_lambda =} \DecValTok{1}\NormalTok{,}
    \AttributeTok{sample\_rate =} \FloatTok{0.6}\NormalTok{, }\AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}
\NormalTok{  )}
\NormalTok{  xgboost\_3 }\OtherTok{\textless{}{-}} \FunctionTok{h2o.xgboost}\NormalTok{(}
    \AttributeTok{model\_id =} \StringTok{"XGBoost\_3"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{, }\AttributeTok{score\_tree\_interval =} \DecValTok{5}\NormalTok{,}
    \AttributeTok{booster =} \StringTok{"gbtree"}\NormalTok{, }\AttributeTok{col\_sample\_rate =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{col\_sample\_rate\_per\_tree =} \FloatTok{0.8}\NormalTok{,}
    \AttributeTok{max\_depth =} \DecValTok{5}\NormalTok{, }\AttributeTok{min\_rows =} \DecValTok{3}\NormalTok{, }\AttributeTok{ntrees =} \DecValTok{10000}\NormalTok{, }\AttributeTok{reg\_alpha =} \DecValTok{0}\NormalTok{, }\AttributeTok{reg\_lambda =} \DecValTok{1}\NormalTok{,}
    \AttributeTok{sample\_rate =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}
\NormalTok{  )}
  \ControlFlowTok{for}\NormalTok{ (model\_id }\ControlFlowTok{in} \FunctionTok{paste0}\NormalTok{(}\StringTok{"XGBoost\_"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{)) \{}
\NormalTok{    tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(model\_id), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  \}}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"DRF}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  drf }\OtherTok{\textless{}{-}} \FunctionTok{h2o.randomForest}\NormalTok{(}
    \AttributeTok{model\_id =} \StringTok{"DRF"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{ntrees =} \DecValTok{10000}\NormalTok{,}
    \AttributeTok{score\_tree\_interval =} \DecValTok{5}\NormalTok{, }\AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{,}
    \AttributeTok{balance\_classes =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{class\_sampling\_factors =}\NormalTok{ samp\_factors,}
    \AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}
\NormalTok{  )}
\NormalTok{  tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(}\StringTok{"DRF"}\NormalTok{), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"XRT}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  xrt }\OtherTok{\textless{}{-}} \FunctionTok{h2o.randomForest}\NormalTok{(}
    \AttributeTok{model\_id =} \StringTok{"XRT"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{ntrees =} \DecValTok{10000}\NormalTok{, }\AttributeTok{histogram\_type =} \StringTok{"Random"}\NormalTok{,}
    \AttributeTok{score\_tree\_interval =} \DecValTok{5}\NormalTok{, }\AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{,}
    \AttributeTok{balance\_classes =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{class\_sampling\_factors =}\NormalTok{ samp\_factors,}
    \AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}
\NormalTok{  )}
\NormalTok{  tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(}\StringTok{"XRT"}\NormalTok{), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
  \CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
  \CommentTok{\# get holdout predictions}
  \CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\NormalTok{  base\_models }\OtherTok{\textless{}{-}} \FunctionTok{as.list}\NormalTok{(}\FunctionTok{c}\NormalTok{(}
    \FunctionTok{unlist}\NormalTok{(deeplearning\_1}\SpecialCharTok{@}\NormalTok{model\_ids),}
    \FunctionTok{unlist}\NormalTok{(gbm}\SpecialCharTok{@}\NormalTok{model\_ids), }\FunctionTok{paste0}\NormalTok{(}\StringTok{"GBM\_"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{5}\NormalTok{),}
    \FunctionTok{unlist}\NormalTok{(xgboost}\SpecialCharTok{@}\NormalTok{model\_ids), }\FunctionTok{paste0}\NormalTok{(}\StringTok{"XGBoost\_"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{),}
    \StringTok{"DRF"}\NormalTok{,}
    \StringTok{"XRT"}
\NormalTok{  ))}
  \ControlFlowTok{for}\NormalTok{ (model\_id }\ControlFlowTok{in}\NormalTok{ base\_models) \{}
\NormalTok{    res }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(res, }\FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{h2o.getFrame}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"cv\_holdout\_prediction\_"}\NormalTok{, model\_id))[}\StringTok{"penetrating"}\NormalTok{],}
      \AttributeTok{col.names =}\NormalTok{ model\_id}
\NormalTok{    ))}
\NormalTok{  \}}
  \CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
  \CommentTok{\# super learner training}
  \CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\NormalTok{  sl\_iter }\OtherTok{\textless{}{-}} \DecValTok{0}
  \FunctionTok{cat}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"Super learner iteration "}\NormalTok{, sl\_iter, }\StringTok{" ("}\NormalTok{, }\FunctionTok{length}\NormalTok{(base\_models), }\StringTok{" models)}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{))}
\NormalTok{  sl }\OtherTok{\textless{}{-}} \FunctionTok{h2o.stackedEnsemble}\NormalTok{(}
    \AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{model\_id =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"superlearner\_iter\_"}\NormalTok{, sl\_iter),}
    \AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{,}
    \AttributeTok{base\_models =}\NormalTok{ base\_models,}
    \AttributeTok{metalearner\_algorithm =} \StringTok{"glm"}\NormalTok{,}
    \AttributeTok{metalearner\_nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_levelone\_frame =} \ConstantTok{TRUE}\NormalTok{,}
    \AttributeTok{metalearner\_params =} \FunctionTok{list}\NormalTok{(}
      \AttributeTok{standardize =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{,}
      \AttributeTok{balance\_classes =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{class\_sampling\_factors =}\NormalTok{ samp\_factors}
\NormalTok{    )}
\NormalTok{  )}
\NormalTok{  tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"superlearner\_iter\_"}\NormalTok{, sl\_iter)), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  model\_id }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"metalearner\_glm\_superlearner\_iter\_"}\NormalTok{, sl\_iter)}
\NormalTok{  tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(model\_id), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  res }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(res, }\FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{h2o.getFrame}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"cv\_holdout\_prediction\_"}\NormalTok{, model\_id))[}\StringTok{"penetrating"}\NormalTok{],}
    \AttributeTok{col.names =} \FunctionTok{paste0}\NormalTok{(model\_id, }\StringTok{"\_"}\NormalTok{, }\FunctionTok{length}\NormalTok{(base\_models), }\StringTok{"\_models"}\NormalTok{)}
\NormalTok{  ))}
  \CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
  \CommentTok{\# super learner base model reduction}
  \CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
  \ControlFlowTok{while}\NormalTok{ (}\ConstantTok{TRUE}\NormalTok{) \{}
\NormalTok{    meta }\OtherTok{\textless{}{-}} \FunctionTok{h2o.getModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"metalearner\_glm\_superlearner\_iter\_"}\NormalTok{, sl\_iter, }\StringTok{"\_cv\_1"}\NormalTok{))}
\NormalTok{    names }\OtherTok{\textless{}{-}}\NormalTok{ meta}\SpecialCharTok{@}\NormalTok{model}\SpecialCharTok{$}\NormalTok{coefficients\_table[, }\StringTok{"names"}\NormalTok{]}
\NormalTok{    coeffs }\OtherTok{\textless{}{-}}\NormalTok{ (meta}\SpecialCharTok{@}\NormalTok{model}\SpecialCharTok{$}\NormalTok{coefficients\_table[, }\StringTok{"standardized\_coefficients"}\NormalTok{] }\SpecialCharTok{\textgreater{}} \DecValTok{0}\NormalTok{)}
    \ControlFlowTok{for}\NormalTok{ (j }\ControlFlowTok{in} \DecValTok{2}\SpecialCharTok{:}\NormalTok{nfolds) \{}
\NormalTok{      meta }\OtherTok{\textless{}{-}} \FunctionTok{h2o.getModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"metalearner\_glm\_superlearner\_iter\_"}\NormalTok{, sl\_iter, }\StringTok{"\_cv\_"}\NormalTok{, j))}
\NormalTok{      names }\OtherTok{\textless{}{-}}\NormalTok{ meta}\SpecialCharTok{@}\NormalTok{model}\SpecialCharTok{$}\NormalTok{coefficients\_table[, }\StringTok{"names"}\NormalTok{]}
\NormalTok{      coeffs }\OtherTok{\textless{}{-}}\NormalTok{ coeffs }\SpecialCharTok{+}\NormalTok{ (meta}\SpecialCharTok{@}\NormalTok{model}\SpecialCharTok{$}\NormalTok{coefficients\_table[, }\StringTok{"standardized\_coefficients"}\NormalTok{] }\SpecialCharTok{\textgreater{}} \DecValTok{0}\NormalTok{)}
\NormalTok{    \}}
\NormalTok{    base\_models\_ }\OtherTok{\textless{}{-}} \FunctionTok{as.list}\NormalTok{(names[coeffs }\SpecialCharTok{\textgreater{}=} \FunctionTok{ceiling}\NormalTok{(nfolds }\SpecialCharTok{/} \DecValTok{2}\NormalTok{) }\SpecialCharTok{\&}\NormalTok{ names }\SpecialCharTok{!=} \StringTok{"Intercept"}\NormalTok{])}
    \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{length}\NormalTok{(base\_models\_) }\SpecialCharTok{==} \DecValTok{0}\NormalTok{) \{}
      \FunctionTok{cat}\NormalTok{(}\StringTok{"No base models passing the threshold}\SpecialCharTok{\textbackslash{}n\textbackslash{}n}\StringTok{"}\NormalTok{)}
      \ControlFlowTok{break}
\NormalTok{    \}}
    \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{sum}\NormalTok{(base\_models }\SpecialCharTok{\%in\%}\NormalTok{ base\_models\_) }\SpecialCharTok{==} \FunctionTok{length}\NormalTok{(base\_models)) \{}
      \FunctionTok{cat}\NormalTok{(}\StringTok{"No further reduction of base models}\SpecialCharTok{\textbackslash{}n\textbackslash{}n}\StringTok{"}\NormalTok{)}
      \ControlFlowTok{break}
\NormalTok{    \}}
\NormalTok{    sl\_iter }\OtherTok{\textless{}{-}}\NormalTok{ sl\_iter }\SpecialCharTok{+} \DecValTok{1}
\NormalTok{    base\_models }\OtherTok{\textless{}{-}}\NormalTok{ base\_models\_}
    \FunctionTok{cat}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"Super learner iteration "}\NormalTok{, sl\_iter, }\StringTok{" ("}\NormalTok{, }\FunctionTok{length}\NormalTok{(base\_models), }\StringTok{" models)}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{))}
\NormalTok{    sl }\OtherTok{\textless{}{-}} \FunctionTok{h2o.stackedEnsemble}\NormalTok{(}
      \AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{model\_id =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"superlearner\_iter\_"}\NormalTok{, sl\_iter),}
      \AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{,}
      \AttributeTok{base\_models =}\NormalTok{ base\_models,}
      \AttributeTok{metalearner\_algorithm =} \StringTok{"glm"}\NormalTok{,}
      \AttributeTok{metalearner\_nfolds =}\NormalTok{ nfolds,}
      \AttributeTok{keep\_levelone\_frame =} \ConstantTok{TRUE}\NormalTok{,}
      \AttributeTok{metalearner\_params =} \FunctionTok{list}\NormalTok{(}
        \AttributeTok{standardize =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{,}
        \AttributeTok{balance\_classes =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{class\_sampling\_factors =}\NormalTok{ samp\_factors}
\NormalTok{      )}
\NormalTok{    )}
\NormalTok{    tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"superlearner\_iter\_"}\NormalTok{, sl\_iter)), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{    model\_id }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"metalearner\_glm\_superlearner\_iter\_"}\NormalTok{, sl\_iter)}
\NormalTok{    tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(model\_id), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{    res }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(res, }\FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{h2o.getFrame}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"cv\_holdout\_prediction\_"}\NormalTok{, model\_id))[}\StringTok{"penetrating"}\NormalTok{],}
      \AttributeTok{col.names =} \FunctionTok{paste0}\NormalTok{(model\_id, }\StringTok{"\_"}\NormalTok{, }\FunctionTok{length}\NormalTok{(base\_models), }\StringTok{"\_models"}\NormalTok{)}
\NormalTok{    ))}
\NormalTok{  \}}
  \CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
  \CommentTok{\# super learner for homogeneous base models}
  \CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
  \CommentTok{\# DeepLearning}
\NormalTok{  base\_models }\OtherTok{\textless{}{-}}\NormalTok{ deeplearning\_1}\SpecialCharTok{@}\NormalTok{model\_ids}
  \FunctionTok{cat}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"Super learner deep learning ("}\NormalTok{, }\FunctionTok{length}\NormalTok{(base\_models), }\StringTok{" models)}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{))}
\NormalTok{  sl }\OtherTok{\textless{}{-}} \FunctionTok{h2o.stackedEnsemble}\NormalTok{(}
    \AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{model\_id =} \StringTok{"superlearner\_deeplearning"}\NormalTok{,}
    \AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{,}
    \AttributeTok{base\_models =}\NormalTok{ base\_models,}
    \AttributeTok{metalearner\_algorithm =} \StringTok{"glm"}\NormalTok{,}
    \AttributeTok{metalearner\_nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_levelone\_frame =} \ConstantTok{TRUE}\NormalTok{,}
    \AttributeTok{metalearner\_params =} \FunctionTok{list}\NormalTok{(}
      \AttributeTok{standardize =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{,}
      \AttributeTok{balance\_classes =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{class\_sampling\_factors =}\NormalTok{ samp\_factors}
\NormalTok{    )}
\NormalTok{  )}
\NormalTok{  tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(}\StringTok{"superlearner\_deeplearning"}\NormalTok{), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  model\_id }\OtherTok{\textless{}{-}} \StringTok{"metalearner\_glm\_superlearner\_deeplearning"}
\NormalTok{  tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(model\_id), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  res }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(res, }\FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{h2o.getFrame}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"cv\_holdout\_prediction\_"}\NormalTok{, model\_id))[}\StringTok{"penetrating"}\NormalTok{],}
    \AttributeTok{col.names =} \FunctionTok{paste0}\NormalTok{(model\_id, }\StringTok{"\_"}\NormalTok{, }\FunctionTok{length}\NormalTok{(base\_models), }\StringTok{"\_models"}\NormalTok{)}
\NormalTok{  ))}
  \CommentTok{\# GBM}
\NormalTok{  base\_models }\OtherTok{\textless{}{-}} \FunctionTok{as.list}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\FunctionTok{unlist}\NormalTok{(gbm}\SpecialCharTok{@}\NormalTok{model\_ids), }\FunctionTok{paste0}\NormalTok{(}\StringTok{"GBM\_"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{5}\NormalTok{)))}
  \FunctionTok{cat}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"Super learner GBM ("}\NormalTok{, }\FunctionTok{length}\NormalTok{(base\_models), }\StringTok{" models)}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{))}
\NormalTok{  sl }\OtherTok{\textless{}{-}} \FunctionTok{h2o.stackedEnsemble}\NormalTok{(}
    \AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{model\_id =} \StringTok{"superlearner\_gbm"}\NormalTok{,}
    \AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{,}
    \AttributeTok{base\_models =}\NormalTok{ base\_models,}
    \AttributeTok{metalearner\_algorithm =} \StringTok{"glm"}\NormalTok{,}
    \AttributeTok{metalearner\_nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_levelone\_frame =} \ConstantTok{TRUE}\NormalTok{,}
    \AttributeTok{metalearner\_params =} \FunctionTok{list}\NormalTok{(}
      \AttributeTok{standardize =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{,}
      \AttributeTok{balance\_classes =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{class\_sampling\_factors =}\NormalTok{ samp\_factors}
\NormalTok{    )}
\NormalTok{  )}
\NormalTok{  tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(}\StringTok{"superlearner\_gbm"}\NormalTok{), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  model\_id }\OtherTok{\textless{}{-}} \StringTok{"metalearner\_glm\_superlearner\_gbm"}
\NormalTok{  tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(model\_id), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  res }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(res, }\FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{h2o.getFrame}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"cv\_holdout\_prediction\_"}\NormalTok{, model\_id))[}\StringTok{"penetrating"}\NormalTok{],}
    \AttributeTok{col.names =} \FunctionTok{paste0}\NormalTok{(model\_id, }\StringTok{"\_"}\NormalTok{, }\FunctionTok{length}\NormalTok{(base\_models), }\StringTok{"\_models"}\NormalTok{)}
\NormalTok{  ))}
  \CommentTok{\# XGBoost}
\NormalTok{  base\_models }\OtherTok{\textless{}{-}} \FunctionTok{as.list}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\FunctionTok{unlist}\NormalTok{(xgboost}\SpecialCharTok{@}\NormalTok{model\_ids), }\FunctionTok{paste0}\NormalTok{(}\StringTok{"XGBoost\_"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{)))}
  \FunctionTok{cat}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"Super learner XGBoost ("}\NormalTok{, }\FunctionTok{length}\NormalTok{(base\_models), }\StringTok{" models)}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{))}
\NormalTok{  sl }\OtherTok{\textless{}{-}} \FunctionTok{h2o.stackedEnsemble}\NormalTok{(}
    \AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{model\_id =} \StringTok{"superlearner\_xgboost"}\NormalTok{,}
    \AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{,}
    \AttributeTok{base\_models =}\NormalTok{ base\_models,}
    \AttributeTok{metalearner\_algorithm =} \StringTok{"glm"}\NormalTok{,}
    \AttributeTok{metalearner\_nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_levelone\_frame =} \ConstantTok{TRUE}\NormalTok{,}
    \AttributeTok{metalearner\_params =} \FunctionTok{list}\NormalTok{(}
      \AttributeTok{standardize =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{,}
      \AttributeTok{balance\_classes =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{class\_sampling\_factors =}\NormalTok{ samp\_factors}
\NormalTok{    )}
\NormalTok{  )}
\NormalTok{  tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(}\StringTok{"superlearner\_xgboost"}\NormalTok{), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  model\_id }\OtherTok{\textless{}{-}} \StringTok{"metalearner\_glm\_superlearner\_xgboost"}
\NormalTok{  tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(model\_id), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  res }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(res, }\FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{h2o.getFrame}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"cv\_holdout\_prediction\_"}\NormalTok{, model\_id))[}\StringTok{"penetrating"}\NormalTok{],}
    \AttributeTok{col.names =} \FunctionTok{paste0}\NormalTok{(model\_id, }\StringTok{"\_"}\NormalTok{, }\FunctionTok{length}\NormalTok{(base\_models), }\StringTok{"\_models"}\NormalTok{)}
\NormalTok{  ))}
  \FunctionTok{write.csv}\NormalTok{(res, }\AttributeTok{file =} \FunctionTok{paste0}\NormalTok{(exp\_dir, }\StringTok{"/cv\_holdout\_predictions.csv"}\NormalTok{), }\AttributeTok{row.names =} \ConstantTok{FALSE}\NormalTok{)}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}n\textbackslash{}n}\StringTok{"}\NormalTok{)}
  \FunctionTok{h2o.removeAll}\NormalTok{()}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\hypertarget{inner-cross-validation-1}{%
\subsection{Inner cross-validation}\label{inner-cross-validation-1}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{load}\NormalTok{(}\AttributeTok{file =} \StringTok{"./rdata/var\_reduct\_cpp\_train\_test\_splits.RData"}\NormalTok{)}
\ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{) \{}
  \FunctionTok{cat}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"Outer training set "}\NormalTok{, i, }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{))}
\NormalTok{  prefix }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"outer\_"}\NormalTok{, i)}
\NormalTok{  exp\_dir }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"/Users/renee/Downloads/cell\_penetration/"}\NormalTok{, prefix)}
  \FunctionTok{dir.create}\NormalTok{(exp\_dir)}
  \FunctionTok{train\_cpp\_models}\NormalTok{(}\AttributeTok{train\_set =}\NormalTok{ outer\_splits[[i]][[}\StringTok{"train"}\NormalTok{]], }\AttributeTok{exp\_dir =}\NormalTok{ exp\_dir, }\AttributeTok{prefix =}\NormalTok{ prefix)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\hypertarget{training-on-whole-data-set-1}{%
\subsection{Training on whole data set}\label{training-on-whole-data-set-1}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{load}\NormalTok{(}\AttributeTok{file =} \StringTok{"./rdata/var\_reduct\_cpp\_train\_test\_splits.RData"}\NormalTok{)}
\NormalTok{prefix }\OtherTok{\textless{}{-}} \StringTok{"whole\_data\_set"}
\NormalTok{exp\_dir }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"/Users/renee/Downloads/cell\_penetration/"}\NormalTok{, prefix)}
\FunctionTok{dir.create}\NormalTok{(exp\_dir)}
\FunctionTok{train\_cpp\_models}\NormalTok{(}\AttributeTok{train\_set =}\NormalTok{ cpp\_data, }\AttributeTok{exp\_dir =}\NormalTok{ exp\_dir, }\AttributeTok{prefix =}\NormalTok{ prefix)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Keep track of grid models}
\NormalTok{dl\_grid }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
\NormalTok{gbm\_grid }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
\NormalTok{xgboost\_grid }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
\NormalTok{dl\_grid\_params }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
\NormalTok{gbm\_grid\_params }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
\NormalTok{xgboost\_grid\_params }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
\ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{11}\NormalTok{) \{}
  \ControlFlowTok{if}\NormalTok{ (i }\SpecialCharTok{==} \DecValTok{11}\NormalTok{) \{}
    \FunctionTok{cat}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"Whole data set}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{))}
\NormalTok{    prefix }\OtherTok{\textless{}{-}} \StringTok{"whole\_data\_set"}
\NormalTok{  \} }\ControlFlowTok{else}\NormalTok{ \{}
    \FunctionTok{cat}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"Outer training set "}\NormalTok{, i, }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{))}
\NormalTok{    prefix }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"outer\_"}\NormalTok{, i)}
\NormalTok{  \}}
\NormalTok{  dir }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"/Users/renee/Downloads/cell\_penetration/"}\NormalTok{, prefix)}
\NormalTok{  files }\OtherTok{\textless{}{-}} \FunctionTok{list.files}\NormalTok{(dir)}
  \CommentTok{\# Deep learning}
\NormalTok{  dl }\OtherTok{\textless{}{-}}\NormalTok{ files[}\FunctionTok{str\_detect}\NormalTok{(files, }\StringTok{"DeepLearning\_model"}\NormalTok{)]}
  \ControlFlowTok{for}\NormalTok{ (m }\ControlFlowTok{in}\NormalTok{ dl) \{}
\NormalTok{    model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/"}\NormalTok{, m))}
\NormalTok{    hs }\OtherTok{\textless{}{-}} \FunctionTok{sha1}\NormalTok{(}\FunctionTok{paste}\NormalTok{(}\FunctionTok{c}\NormalTok{(}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{epsilon,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{hidden,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{hidden\_dropout\_ratios,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{input\_dropout\_ratio,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{rho}
\NormalTok{    ), }\AttributeTok{collapse =} \StringTok{" "}\NormalTok{))}
    \ControlFlowTok{if}\NormalTok{ (hs }\SpecialCharTok{\%in\%} \FunctionTok{names}\NormalTok{(dl\_grid)) \{}
\NormalTok{      dl\_grid[[hs]] }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(dl\_grid[[hs]], m)}
\NormalTok{    \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{      dl\_grid[[hs]] }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(m)}
\NormalTok{      dl\_grid\_params }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(}
\NormalTok{        dl\_grid\_params,}
        \FunctionTok{c}\NormalTok{(}
          \StringTok{"epsilon"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{epsilon,}
          \StringTok{"hidden"} \OtherTok{=} \FunctionTok{paste0}\NormalTok{(}\StringTok{"["}\NormalTok{, }\FunctionTok{paste}\NormalTok{(model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{hidden, }\AttributeTok{collapse =} \StringTok{","}\NormalTok{), }\StringTok{"]"}\NormalTok{),}
          \StringTok{"hidden\_dropout\_ratios"} \OtherTok{=} \FunctionTok{paste0}\NormalTok{(}
            \StringTok{"["}\NormalTok{,}
            \FunctionTok{paste}\NormalTok{(model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{hidden\_dropout\_ratios,}
              \AttributeTok{collapse =} \StringTok{","}
\NormalTok{            ), }\StringTok{"]"}
\NormalTok{          ),}
          \StringTok{"input\_dropout\_ratio"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{input\_dropout\_ratio,}
          \StringTok{"rho"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{rho}
\NormalTok{        )}
\NormalTok{      )}
\NormalTok{    \}}
\NormalTok{  \}}
  \FunctionTok{h2o.removeAll}\NormalTok{()}
  \CommentTok{\# GBM}
\NormalTok{  gbm }\OtherTok{\textless{}{-}}\NormalTok{ files[}\FunctionTok{str\_detect}\NormalTok{(files, }\StringTok{"GBM\_model"}\NormalTok{)]}
  \ControlFlowTok{for}\NormalTok{ (m }\ControlFlowTok{in}\NormalTok{ gbm) \{}
\NormalTok{    model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/"}\NormalTok{, m))}
\NormalTok{    hs }\OtherTok{\textless{}{-}} \FunctionTok{sha1}\NormalTok{(}\FunctionTok{paste}\NormalTok{(}\FunctionTok{c}\NormalTok{(}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{col\_sample\_rate,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{col\_sample\_rate\_per\_tree,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{max\_depth,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{min\_rows,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{min\_split\_improvement,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{sample\_rate}
\NormalTok{    ), }\AttributeTok{collapse =} \StringTok{" "}\NormalTok{))}
    \ControlFlowTok{if}\NormalTok{ (hs }\SpecialCharTok{\%in\%} \FunctionTok{names}\NormalTok{(gbm\_grid)) \{}
\NormalTok{      gbm\_grid[[hs]] }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(gbm\_grid[[hs]], m)}
\NormalTok{    \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{      gbm\_grid[[hs]] }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(m)}
\NormalTok{      gbm\_grid\_params }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(}
\NormalTok{        gbm\_grid\_params,}
        \FunctionTok{c}\NormalTok{(}
          \StringTok{"col\_sample\_rate"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{col\_sample\_rate,}
          \StringTok{"col\_sample\_rate\_per\_tree"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{col\_sample\_rate\_per\_tree,}
          \StringTok{"max\_depth"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{max\_depth,}
          \StringTok{"min\_rows"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{min\_rows,}
          \StringTok{"min\_split\_improvement"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{min\_split\_improvement,}
          \StringTok{"sample\_rate"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{sample\_rate}
\NormalTok{        )}
\NormalTok{      )}
\NormalTok{    \}}
\NormalTok{  \}}
  \FunctionTok{h2o.removeAll}\NormalTok{()}
  \CommentTok{\# XGBoost}
\NormalTok{  xgboost }\OtherTok{\textless{}{-}}\NormalTok{ files[}\FunctionTok{str\_detect}\NormalTok{(files, }\StringTok{"XGBoost\_model"}\NormalTok{)]}
  \ControlFlowTok{for}\NormalTok{ (m }\ControlFlowTok{in}\NormalTok{ xgboost) \{}
\NormalTok{    model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/"}\NormalTok{, m))}
\NormalTok{    hs }\OtherTok{\textless{}{-}} \FunctionTok{sha1}\NormalTok{(}\FunctionTok{paste}\NormalTok{(}\FunctionTok{c}\NormalTok{(}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{booster,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{col\_sample\_rate,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{col\_sample\_rate\_per\_tree,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{max\_depth,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{min\_rows,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{reg\_alpha,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{reg\_lambda,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{sample\_rate}
\NormalTok{    ), }\AttributeTok{collapse =} \StringTok{" "}\NormalTok{))}
    \ControlFlowTok{if}\NormalTok{ (hs }\SpecialCharTok{\%in\%} \FunctionTok{names}\NormalTok{(xgboost\_grid)) \{}
\NormalTok{      xgboost\_grid[[hs]] }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(xgboost\_grid[[hs]], m)}
\NormalTok{    \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{      xgboost\_grid[[hs]] }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(m)}
\NormalTok{      xgboost\_grid\_params }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(}
\NormalTok{        xgboost\_grid\_params,}
        \FunctionTok{c}\NormalTok{(}
          \StringTok{"booster"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{booster,}
          \StringTok{"col\_sample\_rate"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{col\_sample\_rate,}
          \StringTok{"col\_sample\_rate\_per\_tree"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{col\_sample\_rate\_per\_tree,}
          \StringTok{"max\_depth"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{max\_depth,}
          \StringTok{"min\_rows"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{min\_rows,}
          \StringTok{"reg\_alpha"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{reg\_alpha,}
          \StringTok{"reg\_lambda"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{reg\_lambda,}
          \StringTok{"sample\_rate"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{sample\_rate}
\NormalTok{        )}
\NormalTok{      )}
\NormalTok{    \}}
\NormalTok{  \}}
  \FunctionTok{h2o.removeAll}\NormalTok{()}
\NormalTok{\}}

\NormalTok{dl\_grid\_params }\OtherTok{\textless{}{-}} \FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{t}\NormalTok{(}\FunctionTok{data.frame}\NormalTok{(dl\_grid\_params)))}
\FunctionTok{rownames}\NormalTok{(dl\_grid\_params) }\OtherTok{\textless{}{-}} \FunctionTok{paste}\NormalTok{(}\StringTok{"Neural network grid model"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(dl\_grid\_params))}

\NormalTok{gbm\_grid\_params }\OtherTok{\textless{}{-}} \FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{t}\NormalTok{(}\FunctionTok{data.frame}\NormalTok{(gbm\_grid\_params)))}
\FunctionTok{rownames}\NormalTok{(gbm\_grid\_params) }\OtherTok{\textless{}{-}} \FunctionTok{paste}\NormalTok{(}\StringTok{"GBM grid model"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(gbm\_grid\_params))}

\NormalTok{xgboost\_grid\_params }\OtherTok{\textless{}{-}} \FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{t}\NormalTok{(}\FunctionTok{data.frame}\NormalTok{(xgboost\_grid\_params)))}
\FunctionTok{rownames}\NormalTok{(xgboost\_grid\_params) }\OtherTok{\textless{}{-}} \FunctionTok{paste}\NormalTok{(}\StringTok{"XGBoost grid model"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(xgboost\_grid\_params))}

\FunctionTok{write.csv}\NormalTok{(dl\_grid\_params, }\StringTok{"./other\_data/cell\_penetration/neural\_network\_grid\_params.csv"}\NormalTok{)}
\FunctionTok{write.csv}\NormalTok{(gbm\_grid\_params, }\StringTok{"./other\_data/cell\_penetration/gbm\_grid\_params.csv"}\NormalTok{)}
\FunctionTok{write.csv}\NormalTok{(xgboost\_grid\_params, }\StringTok{"./other\_data/cell\_penetration/xgboost\_grid\_params.csv"}\NormalTok{)}

\FunctionTok{save}\NormalTok{(dl\_grid, gbm\_grid, xgboost\_grid, }\AttributeTok{file =} \StringTok{"./rdata/model\_training\_grid\_models\_cpp.RData"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{model-evaluation-1}{%
\subsection{Model evaluation}\label{model-evaluation-1}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{model\_evaluation }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(holdout\_pred, fold\_asign, grid\_name, }\AttributeTok{grid\_meta =} \ConstantTok{NULL}\NormalTok{) \{}
\NormalTok{  res\_ }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
\NormalTok{  model\_num }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{startsWith}\NormalTok{(grid\_name, }\StringTok{"Super learner"}\NormalTok{)) \{}
    \ControlFlowTok{if}\NormalTok{ (grid\_name }\SpecialCharTok{==} \StringTok{"Super learner all models"}\NormalTok{) \{}
\NormalTok{      m }\OtherTok{\textless{}{-}} \FunctionTok{colnames}\NormalTok{(holdout\_pred)[}\FunctionTok{startsWith}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(holdout\_pred), }\StringTok{"metalearner\_glm\_superlearner\_iter\_0"}\NormalTok{)]}
\NormalTok{    \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (grid\_name }\SpecialCharTok{==} \StringTok{"Super learner final"}\NormalTok{) \{}
\NormalTok{      sl\_models }\OtherTok{\textless{}{-}} \FunctionTok{colnames}\NormalTok{(holdout\_pred)[}\FunctionTok{startsWith}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(holdout\_pred), }\StringTok{"metalearner\_glm\_superlearner\_iter"}\NormalTok{)]}
\NormalTok{      m }\OtherTok{\textless{}{-}}\NormalTok{ sl\_models[}\FunctionTok{length}\NormalTok{(sl\_models)]}
\NormalTok{    \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (grid\_name }\SpecialCharTok{==} \StringTok{"Super learner neural network"}\NormalTok{) \{}
\NormalTok{      m }\OtherTok{\textless{}{-}} \FunctionTok{colnames}\NormalTok{(holdout\_pred)[}\FunctionTok{startsWith}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(holdout\_pred), }\StringTok{"metalearner\_glm\_superlearner\_deeplearning"}\NormalTok{)]}
\NormalTok{    \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (grid\_name }\SpecialCharTok{==} \StringTok{"Super learner GBM"}\NormalTok{) \{}
\NormalTok{      m }\OtherTok{\textless{}{-}} \FunctionTok{colnames}\NormalTok{(holdout\_pred)[}\FunctionTok{startsWith}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(holdout\_pred), }\StringTok{"metalearner\_glm\_superlearner\_gbm"}\NormalTok{)]}
\NormalTok{    \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (grid\_name }\SpecialCharTok{==} \StringTok{"Super learner XGBoost"}\NormalTok{) \{}
\NormalTok{      m }\OtherTok{\textless{}{-}} \FunctionTok{colnames}\NormalTok{(holdout\_pred)[}\FunctionTok{startsWith}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(holdout\_pred), }\StringTok{"metalearner\_glm\_superlearner\_xgboost"}\NormalTok{)]}
\NormalTok{    \}}
\NormalTok{    logloss }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{    MCC }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{    F1 }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{    acc }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{    EF }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{    BEDROC }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{    threshold }\OtherTok{\textless{}{-}} \FloatTok{0.5}
    \ControlFlowTok{for}\NormalTok{ (k }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{) \{}
\NormalTok{      y\_true }\OtherTok{\textless{}{-}} \FunctionTok{sapply}\NormalTok{(holdout\_pred[fold\_assign }\SpecialCharTok{==}\NormalTok{ k, }\StringTok{"category"}\NormalTok{], }\ControlFlowTok{function}\NormalTok{(x) }\ControlFlowTok{if}\NormalTok{ (x }\SpecialCharTok{==} \StringTok{"penetrating"}\NormalTok{) }\DecValTok{1} \ControlFlowTok{else} \DecValTok{0}\NormalTok{)}
\NormalTok{      y\_pred }\OtherTok{\textless{}{-}}\NormalTok{ holdout\_pred[fold\_assign }\SpecialCharTok{==}\NormalTok{ k, m]}
\NormalTok{      y\_pred\_cls }\OtherTok{\textless{}{-}} \FunctionTok{sapply}\NormalTok{(y\_pred, }\ControlFlowTok{function}\NormalTok{(x) }\ControlFlowTok{if}\NormalTok{ (x }\SpecialCharTok{\textgreater{}=}\NormalTok{ threshold) }\DecValTok{1} \ControlFlowTok{else} \DecValTok{0}\NormalTok{)}
\NormalTok{      logloss }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(logloss, }\FunctionTok{LogLoss}\NormalTok{(}\AttributeTok{y\_pred =}\NormalTok{ y\_pred, }\AttributeTok{y\_true =}\NormalTok{ y\_true))}
\NormalTok{      MCC }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(MCC, }\FunctionTok{mcc}\NormalTok{(}\AttributeTok{preds =}\NormalTok{ y\_pred\_cls, }\AttributeTok{actuals =}\NormalTok{ y\_true))}
\NormalTok{      F1 }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(F1, }\FunctionTok{F1\_Score}\NormalTok{(}\AttributeTok{y\_pred =}\NormalTok{ y\_pred\_cls, }\AttributeTok{y\_true =}\NormalTok{ y\_true))}
\NormalTok{      acc }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(acc, }\FunctionTok{balanced\_accuracy}\NormalTok{(}\AttributeTok{y\_pred =}\NormalTok{ y\_pred\_cls, }\AttributeTok{y\_true =}\NormalTok{ y\_true))}
\NormalTok{      EF }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(EF, }\FunctionTok{enrichment\_factor}\NormalTok{(}\AttributeTok{x =}\NormalTok{ y\_pred, }\AttributeTok{y =}\NormalTok{ y\_true, }\AttributeTok{top =} \FloatTok{0.05}\NormalTok{))}
\NormalTok{      BEDROC }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(BEDROC, }\FunctionTok{bedroc}\NormalTok{(}\AttributeTok{x =}\NormalTok{ y\_pred, }\AttributeTok{y =}\NormalTok{ y\_true, }\AttributeTok{alpha =} \DecValTok{20}\NormalTok{))}
\NormalTok{    \}}
\NormalTok{    res\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(res\_, }\FunctionTok{c}\NormalTok{(}
      \FunctionTok{mean}\NormalTok{(logloss, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{), }\FunctionTok{sem}\NormalTok{(logloss),}
      \FunctionTok{mean}\NormalTok{(MCC, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{), }\FunctionTok{sem}\NormalTok{(MCC),}
      \FunctionTok{mean}\NormalTok{(F1, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{), }\FunctionTok{sem}\NormalTok{(F1),}
      \FunctionTok{mean}\NormalTok{(acc, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{), }\FunctionTok{sem}\NormalTok{(acc),}
      \FunctionTok{mean}\NormalTok{(EF, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{), }\FunctionTok{sem}\NormalTok{(EF),}
      \FunctionTok{mean}\NormalTok{(BEDROC, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{), }\FunctionTok{sem}\NormalTok{(BEDROC),}
\NormalTok{      logloss, MCC, F1, acc, EF, BEDROC}
\NormalTok{    ))}
\NormalTok{  \} }\ControlFlowTok{else}\NormalTok{ \{}
    \ControlFlowTok{for}\NormalTok{ (j }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(grid\_meta)) \{}
\NormalTok{      g }\OtherTok{\textless{}{-}}\NormalTok{ grid\_meta[[j]]}
\NormalTok{      m }\OtherTok{\textless{}{-}} \FunctionTok{intersect}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(holdout\_pred), g)}
      \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{length}\NormalTok{(m) }\SpecialCharTok{==} \DecValTok{1}\NormalTok{) \{}
\NormalTok{        model\_num }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(model\_num, j)}
\NormalTok{        logloss }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{        MCC }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{        F1 }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{        acc }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{        EF }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{        BEDROC }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{        threshold }\OtherTok{\textless{}{-}} \FloatTok{0.5}
        \ControlFlowTok{for}\NormalTok{ (k }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{) \{}
\NormalTok{          y\_true }\OtherTok{\textless{}{-}} \FunctionTok{sapply}\NormalTok{(holdout\_pred[fold\_assign }\SpecialCharTok{==}\NormalTok{ k, }\StringTok{"category"}\NormalTok{], }\ControlFlowTok{function}\NormalTok{(x) }\ControlFlowTok{if}\NormalTok{ (x }\SpecialCharTok{==} \StringTok{"penetrating"}\NormalTok{) }\DecValTok{1} \ControlFlowTok{else} \DecValTok{0}\NormalTok{)}
\NormalTok{          y\_pred }\OtherTok{\textless{}{-}}\NormalTok{ holdout\_pred[fold\_assign }\SpecialCharTok{==}\NormalTok{ k, m]}
\NormalTok{          y\_pred\_cls }\OtherTok{\textless{}{-}} \FunctionTok{sapply}\NormalTok{(y\_pred, }\ControlFlowTok{function}\NormalTok{(x) }\ControlFlowTok{if}\NormalTok{ (x }\SpecialCharTok{\textgreater{}=}\NormalTok{ threshold) }\DecValTok{1} \ControlFlowTok{else} \DecValTok{0}\NormalTok{)}
\NormalTok{          logloss }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(logloss, }\FunctionTok{LogLoss}\NormalTok{(}\AttributeTok{y\_pred =}\NormalTok{ y\_pred, }\AttributeTok{y\_true =}\NormalTok{ y\_true))}
\NormalTok{          MCC }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(MCC, }\FunctionTok{mcc}\NormalTok{(}\AttributeTok{preds =}\NormalTok{ y\_pred\_cls, }\AttributeTok{actuals =}\NormalTok{ y\_true))}
\NormalTok{          F1 }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(F1, }\FunctionTok{F1\_Score}\NormalTok{(}\AttributeTok{y\_pred =}\NormalTok{ y\_pred\_cls, }\AttributeTok{y\_true =}\NormalTok{ y\_true))}
\NormalTok{          acc }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(acc, }\FunctionTok{balanced\_accuracy}\NormalTok{(}\AttributeTok{y\_pred =}\NormalTok{ y\_pred\_cls, }\AttributeTok{y\_true =}\NormalTok{ y\_true))}
\NormalTok{          EF }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(EF, }\FunctionTok{enrichment\_factor}\NormalTok{(}\AttributeTok{x =}\NormalTok{ y\_pred, }\AttributeTok{y =}\NormalTok{ y\_true, }\AttributeTok{top =} \FloatTok{0.05}\NormalTok{))}
\NormalTok{          BEDROC }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(BEDROC, }\FunctionTok{bedroc}\NormalTok{(}\AttributeTok{x =}\NormalTok{ y\_pred, }\AttributeTok{y =}\NormalTok{ y\_true, }\AttributeTok{alpha =} \DecValTok{20}\NormalTok{))}
\NormalTok{        \}}
\NormalTok{        res\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(res\_, }\FunctionTok{c}\NormalTok{(}
          \FunctionTok{mean}\NormalTok{(logloss, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{), }\FunctionTok{sem}\NormalTok{(logloss),}
          \FunctionTok{mean}\NormalTok{(MCC, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{), }\FunctionTok{sem}\NormalTok{(MCC),}
          \FunctionTok{mean}\NormalTok{(F1, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{), }\FunctionTok{sem}\NormalTok{(F1),}
          \FunctionTok{mean}\NormalTok{(acc, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{), }\FunctionTok{sem}\NormalTok{(acc),}
          \FunctionTok{mean}\NormalTok{(EF, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{), }\FunctionTok{sem}\NormalTok{(EF),}
          \FunctionTok{mean}\NormalTok{(BEDROC, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{), }\FunctionTok{sem}\NormalTok{(BEDROC),}
\NormalTok{          logloss, MCC, F1, acc, EF, BEDROC}
\NormalTok{        ))}
\NormalTok{      \}}
\NormalTok{    \}}
\NormalTok{  \}}
\NormalTok{  res }\OtherTok{\textless{}{-}} \FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{t}\NormalTok{(}\FunctionTok{data.frame}\NormalTok{(res\_)))}
  \FunctionTok{colnames}\NormalTok{(res) }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}
    \StringTok{"Log loss mean"}\NormalTok{, }\StringTok{"Log loss s.e.m."}\NormalTok{, }\StringTok{"MCC mean"}\NormalTok{, }\StringTok{"MCC s.e.m."}\NormalTok{, }\StringTok{"F\_1 mean"}\NormalTok{, }\StringTok{"F\_1 s.e.m."}\NormalTok{,}
    \StringTok{"Balanced accuracy mean"}\NormalTok{, }\StringTok{"Balanced accuracy s.e.m."}\NormalTok{, }\StringTok{"EF mean"}\NormalTok{, }\StringTok{"EF s.e.m."}\NormalTok{, }\StringTok{"BEDROC mean"}\NormalTok{, }\StringTok{"BEDROC s.e.m."}\NormalTok{,}
    \FunctionTok{paste}\NormalTok{(}\StringTok{"Log loss CV"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{), }\FunctionTok{paste}\NormalTok{(}\StringTok{"MCC CV"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{), }\FunctionTok{paste}\NormalTok{(}\StringTok{"F\_1 CV"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{),}
    \FunctionTok{paste}\NormalTok{(}\StringTok{"Balanced accuracy CV"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{), }\FunctionTok{paste}\NormalTok{(}\StringTok{"EF CV"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{), }\FunctionTok{paste}\NormalTok{(}\StringTok{"BEDROC CV"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{)}
\NormalTok{  )}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{nrow}\NormalTok{(res) }\SpecialCharTok{==} \DecValTok{1}\NormalTok{) \{}
    \FunctionTok{rownames}\NormalTok{(res) }\OtherTok{\textless{}{-}}\NormalTok{ grid\_name}
\NormalTok{  \} }\ControlFlowTok{else}\NormalTok{ \{}
    \FunctionTok{rownames}\NormalTok{(res) }\OtherTok{\textless{}{-}} \FunctionTok{paste}\NormalTok{(grid\_name, model\_num)}
\NormalTok{  \}}
  \FunctionTok{return}\NormalTok{(res)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\hypertarget{inner-loop-model-selection-1}{%
\subsection{Inner loop model selection}\label{inner-loop-model-selection-1}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{load}\NormalTok{(}\AttributeTok{file =} \StringTok{"./rdata/model\_training\_grid\_models\_cpp.RData"}\NormalTok{)}

\ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{) \{}
\NormalTok{  holdout\_pred }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"./other\_data/cell\_penetration/outer\_"}\NormalTok{, i, }\StringTok{"/cv\_holdout\_predictions.csv"}\NormalTok{))}
\NormalTok{  fold\_assign }\OtherTok{\textless{}{-}} \FunctionTok{rep}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{, }\FunctionTok{ceiling}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(holdout\_pred) }\SpecialCharTok{/} \DecValTok{10}\NormalTok{))[}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(holdout\_pred)]}
\NormalTok{  data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
  \CommentTok{\# Deep learning grid models}
\NormalTok{  data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign,}
    \AttributeTok{grid\_name =} \StringTok{"Neural network grid model"}\NormalTok{,}
    \AttributeTok{grid\_meta =}\NormalTok{ dl\_grid}
\NormalTok{  ))}
  \CommentTok{\# GBM grid models}
\NormalTok{  data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign,}
    \AttributeTok{grid\_name =} \StringTok{"GBM grid model"}\NormalTok{,}
    \AttributeTok{grid\_meta =}\NormalTok{ gbm\_grid}
\NormalTok{  ))}
  \CommentTok{\# GBM default models}
\NormalTok{  data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign,}
    \AttributeTok{grid\_name =} \StringTok{"GBM model"}\NormalTok{,}
    \AttributeTok{grid\_meta =} \FunctionTok{as.list}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"GBM\_"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{5}\NormalTok{))}
\NormalTok{  ))}
  \CommentTok{\# XGBoost grid models}
\NormalTok{  data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign,}
    \AttributeTok{grid\_name =} \StringTok{"XGBoost grid model"}\NormalTok{,}
    \AttributeTok{grid\_meta =}\NormalTok{ xgboost\_grid}
\NormalTok{  ))}
  \CommentTok{\# XGBoost default models}
\NormalTok{  data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign,}
    \AttributeTok{grid\_name =} \StringTok{"XGBoost model"}\NormalTok{,}
    \AttributeTok{grid\_meta =} \FunctionTok{as.list}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"XGBoost\_"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{))}
\NormalTok{  ))}
  \CommentTok{\# DRF}
\NormalTok{  data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign, }\AttributeTok{grid\_name =} \StringTok{"DRF model"}\NormalTok{, }\AttributeTok{grid\_meta =} \FunctionTok{list}\NormalTok{(}\StringTok{"DRF"}\NormalTok{)))}
  \CommentTok{\# XRT}
\NormalTok{  data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign, }\AttributeTok{grid\_name =} \StringTok{"XRT model"}\NormalTok{, }\AttributeTok{grid\_meta =} \FunctionTok{list}\NormalTok{(}\StringTok{"XRT"}\NormalTok{)))}
  \CommentTok{\# Super learner all}
\NormalTok{  data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign, }\AttributeTok{grid\_name =} \StringTok{"Super learner all models"}\NormalTok{))}
  \CommentTok{\# Super learner final}
\NormalTok{  data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign, }\AttributeTok{grid\_name =} \StringTok{"Super learner final"}\NormalTok{))}
  \CommentTok{\# Super learner deep learning}
\NormalTok{  data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign, }\AttributeTok{grid\_name =} \StringTok{"Super learner neural network"}\NormalTok{))}
  \CommentTok{\# Super learner GBM}
\NormalTok{  data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign, }\AttributeTok{grid\_name =} \StringTok{"Super learner GBM"}\NormalTok{))}
  \CommentTok{\# Super learner XGBoost}
\NormalTok{  data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign, }\AttributeTok{grid\_name =} \StringTok{"Super learner XGBoost"}\NormalTok{))}

\NormalTok{  data }\OtherTok{\textless{}{-}} \FunctionTok{do.call}\NormalTok{(rbind, data\_)}
  \FunctionTok{write.csv}\NormalTok{(data, }\FunctionTok{paste0}\NormalTok{(}\StringTok{"./other\_data/cell\_penetration/outer\_"}\NormalTok{, i, }\StringTok{"/cv\_res.csv"}\NormalTok{))}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\hypertarget{cv-1-1}{%
\subsubsection{CV 1}\label{cv-1-1}}

\includegraphics{03_model_training_files/figure-latex/unnamed-chunk-36-1.pdf}

\hypertarget{cv-2-1}{%
\subsubsection{CV 2}\label{cv-2-1}}

\includegraphics{03_model_training_files/figure-latex/unnamed-chunk-37-1.pdf}

\hypertarget{cv-3-1}{%
\subsubsection{CV 3}\label{cv-3-1}}

\includegraphics{03_model_training_files/figure-latex/unnamed-chunk-38-1.pdf}

\hypertarget{cv-4-1}{%
\subsubsection{CV 4}\label{cv-4-1}}

\includegraphics{03_model_training_files/figure-latex/unnamed-chunk-39-1.pdf}

\hypertarget{cv-5-1}{%
\subsubsection{CV 5}\label{cv-5-1}}

\includegraphics{03_model_training_files/figure-latex/unnamed-chunk-40-1.pdf}

\hypertarget{cv-6-1}{%
\subsubsection{CV 6}\label{cv-6-1}}

\includegraphics{03_model_training_files/figure-latex/unnamed-chunk-41-1.pdf}

\hypertarget{cv-7-1}{%
\subsubsection{CV 7}\label{cv-7-1}}

\includegraphics{03_model_training_files/figure-latex/unnamed-chunk-42-1.pdf}

\hypertarget{cv-8-1}{%
\subsubsection{CV 8}\label{cv-8-1}}

\includegraphics{03_model_training_files/figure-latex/unnamed-chunk-43-1.pdf}

\hypertarget{cv-9-1}{%
\subsubsection{CV 9}\label{cv-9-1}}

\includegraphics{03_model_training_files/figure-latex/unnamed-chunk-44-1.pdf}

\hypertarget{cv-10-1}{%
\subsubsection{CV 10}\label{cv-10-1}}

\includegraphics{03_model_training_files/figure-latex/unnamed-chunk-45-1.pdf}

\hypertarget{final-evaluation-1}{%
\subsection{Final evaluation}\label{final-evaluation-1}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{load}\NormalTok{(}\AttributeTok{file =} \StringTok{"./rdata/var\_reduct\_cpp\_train\_test\_splits.RData"}\NormalTok{)}
\FunctionTok{load}\NormalTok{(}\AttributeTok{file =} \StringTok{"./rdata/model\_training\_grid\_models\_cpp.RData"}\NormalTok{)}
\NormalTok{dir }\OtherTok{\textless{}{-}} \StringTok{"/Users/renee/Downloads/cell\_penetration"}
\NormalTok{selected\_models }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}
  \StringTok{"GBM grid model 30"}\NormalTok{, }\StringTok{"Neural network grid model 98"}\NormalTok{, }\StringTok{"Neural network grid model 72"}\NormalTok{,}
  \StringTok{"GBM grid model 1"}\NormalTok{, }\StringTok{"GBM grid model 45"}\NormalTok{, }\StringTok{"GBM grid model 82"}\NormalTok{, }\StringTok{"GBM grid model 72"}\NormalTok{,}
  \StringTok{"GBM grid model 15"}\NormalTok{, }\StringTok{"GBM grid model 74"}\NormalTok{, }\StringTok{"GBM grid model 24"}
\NormalTok{)}
\NormalTok{logloss }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{MCC }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{F1 }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{acc }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{EF }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{BEDROC }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{threshold }\OtherTok{\textless{}{-}} \FloatTok{0.5}
\ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{) \{}
\NormalTok{  holdout\_pred }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"./other\_data/cell\_penetration/outer\_"}\NormalTok{, i, }\StringTok{"/cv\_holdout\_predictions.csv"}\NormalTok{))}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{startsWith}\NormalTok{(selected\_models[i], }\StringTok{"Neural network grid model"}\NormalTok{)) \{}
\NormalTok{    grid\_num }\OtherTok{\textless{}{-}} \FunctionTok{as.integer}\NormalTok{(}\FunctionTok{str\_extract}\NormalTok{(selected\_models[i], }\StringTok{"[0{-}9]+"}\NormalTok{))}
\NormalTok{    m }\OtherTok{\textless{}{-}} \FunctionTok{intersect}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(holdout\_pred), dl\_grid[[grid\_num]])}
\NormalTok{    model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/outer\_"}\NormalTok{, i, }\StringTok{"/"}\NormalTok{, m))}
\NormalTok{  \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{startsWith}\NormalTok{(selected\_models[i], }\StringTok{"GBM grid model"}\NormalTok{)) \{}
\NormalTok{    grid\_num }\OtherTok{\textless{}{-}} \FunctionTok{as.integer}\NormalTok{(}\FunctionTok{str\_extract}\NormalTok{(selected\_models[i], }\StringTok{"[0{-}9]+"}\NormalTok{))}
\NormalTok{    m }\OtherTok{\textless{}{-}} \FunctionTok{intersect}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(holdout\_pred), gbm\_grid[[grid\_num]])}
\NormalTok{    model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/outer\_"}\NormalTok{, i, }\StringTok{"/"}\NormalTok{, m))}
\NormalTok{  \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{startsWith}\NormalTok{(selected\_models[i], }\StringTok{"GBM model"}\NormalTok{)) \{}
\NormalTok{    grid\_num }\OtherTok{\textless{}{-}} \FunctionTok{as.integer}\NormalTok{(}\FunctionTok{str\_extract}\NormalTok{(selected\_models[i], }\StringTok{"[0{-}9]+"}\NormalTok{))}
\NormalTok{    model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/outer\_"}\NormalTok{, i, }\StringTok{"/GBM\_"}\NormalTok{, grid\_num))}
\NormalTok{  \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{startsWith}\NormalTok{(selected\_models[i], }\StringTok{"XGBoost grid model"}\NormalTok{)) \{}
\NormalTok{    grid\_num }\OtherTok{\textless{}{-}} \FunctionTok{as.integer}\NormalTok{(}\FunctionTok{str\_extract}\NormalTok{(selected\_models[i], }\StringTok{"[0{-}9]+"}\NormalTok{))}
\NormalTok{    m }\OtherTok{\textless{}{-}} \FunctionTok{intersect}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(holdout\_pred), xgboost\_grid[[grid\_num]])}
\NormalTok{    model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/outer\_"}\NormalTok{, i, }\StringTok{"/"}\NormalTok{, m))}
\NormalTok{  \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{startsWith}\NormalTok{(selected\_models[i], }\StringTok{"XGBoost model"}\NormalTok{)) \{}
\NormalTok{    grid\_num }\OtherTok{\textless{}{-}} \FunctionTok{as.integer}\NormalTok{(}\FunctionTok{str\_extract}\NormalTok{(selected\_models[i], }\StringTok{"[0{-}9]+"}\NormalTok{))}
\NormalTok{    model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/outer\_"}\NormalTok{, i, }\StringTok{"/XGBoost\_"}\NormalTok{, grid\_num))}
\NormalTok{  \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (selected\_models[i] }\SpecialCharTok{==} \StringTok{"Super learner all models"}\NormalTok{) \{}
\NormalTok{    model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/outer\_"}\NormalTok{, i, }\StringTok{"/superlearner\_iter\_0"}\NormalTok{))}
\NormalTok{  \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (selected\_models[i] }\SpecialCharTok{==} \StringTok{"Super learner final"}\NormalTok{) \{}
\NormalTok{    files }\OtherTok{\textless{}{-}} \FunctionTok{list.files}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/outer\_"}\NormalTok{, i))}
\NormalTok{    files }\OtherTok{\textless{}{-}}\NormalTok{ files[}\FunctionTok{startsWith}\NormalTok{(files, }\StringTok{"superlearner\_iter"}\NormalTok{)]}
\NormalTok{    model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/outer\_"}\NormalTok{, i, }\StringTok{"/"}\NormalTok{, files[}\FunctionTok{length}\NormalTok{(files)]))}
\NormalTok{  \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (selected\_models[i] }\SpecialCharTok{==} \StringTok{"Super learner neural network"}\NormalTok{) \{}
\NormalTok{    model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/outer\_"}\NormalTok{, i, }\StringTok{"/superlearner\_deeplearning"}\NormalTok{))}
\NormalTok{  \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (selected\_models[i] }\SpecialCharTok{==} \StringTok{"Super learner GBM"}\NormalTok{) \{}
\NormalTok{    model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/outer\_"}\NormalTok{, i, }\StringTok{"/superlearner\_gbm"}\NormalTok{))}
\NormalTok{  \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (selected\_models[i] }\SpecialCharTok{==} \StringTok{"Super learner XGBoost"}\NormalTok{) \{}
\NormalTok{    model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/outer\_"}\NormalTok{, i, }\StringTok{"/superlearner\_xgboost"}\NormalTok{))}
\NormalTok{  \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{    model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/outer\_"}\NormalTok{, i, }\StringTok{"/"}\NormalTok{, }\FunctionTok{unlist}\NormalTok{(}\FunctionTok{strsplit}\NormalTok{(selected\_models[i], }\StringTok{" "}\NormalTok{))[}\DecValTok{1}\NormalTok{]))}
\NormalTok{  \}}
\NormalTok{  tmp }\OtherTok{\textless{}{-}} \FunctionTok{as.h2o}\NormalTok{(}\FunctionTok{subset}\NormalTok{(outer\_splits[[i]][[}\StringTok{"test"}\NormalTok{]], }\AttributeTok{select =} \SpecialCharTok{{-}}\NormalTok{category))}
\NormalTok{  y\_true }\OtherTok{\textless{}{-}} \FunctionTok{sapply}\NormalTok{(outer\_splits[[i]][[}\StringTok{"test"}\NormalTok{]]}\SpecialCharTok{$}\NormalTok{category, }\ControlFlowTok{function}\NormalTok{(x) }\ControlFlowTok{if}\NormalTok{ (x }\SpecialCharTok{==} \StringTok{"penetrating"}\NormalTok{) }\DecValTok{1} \ControlFlowTok{else} \DecValTok{0}\NormalTok{)}
\NormalTok{  y\_pred }\OtherTok{\textless{}{-}} \FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{h2o.predict}\NormalTok{(model, tmp)))[, }\StringTok{"penetrating"}\NormalTok{]}
\NormalTok{  y\_pred\_cls }\OtherTok{\textless{}{-}} \FunctionTok{sapply}\NormalTok{(y\_pred, }\ControlFlowTok{function}\NormalTok{(x) }\ControlFlowTok{if}\NormalTok{ (x }\SpecialCharTok{\textgreater{}=}\NormalTok{ threshold) }\DecValTok{1} \ControlFlowTok{else} \DecValTok{0}\NormalTok{)}
\NormalTok{  logloss }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(logloss, }\FunctionTok{LogLoss}\NormalTok{(}\AttributeTok{y\_pred =}\NormalTok{ y\_pred, }\AttributeTok{y\_true =}\NormalTok{ y\_true))}
\NormalTok{  MCC }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(MCC, }\FunctionTok{mcc}\NormalTok{(}\AttributeTok{preds =}\NormalTok{ y\_pred\_cls, }\AttributeTok{actuals =}\NormalTok{ y\_true))}
\NormalTok{  F1 }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(F1, }\FunctionTok{F1\_Score}\NormalTok{(}\AttributeTok{y\_pred =}\NormalTok{ y\_pred\_cls, }\AttributeTok{y\_true =}\NormalTok{ y\_true))}
\NormalTok{  acc }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(acc, }\FunctionTok{balanced\_accuracy}\NormalTok{(}\AttributeTok{y\_pred =}\NormalTok{ y\_pred\_cls, }\AttributeTok{y\_true =}\NormalTok{ y\_true))}
\NormalTok{  EF }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(EF, }\FunctionTok{enrichment\_factor}\NormalTok{(}\AttributeTok{x =}\NormalTok{ y\_pred, }\AttributeTok{y =}\NormalTok{ y\_true, }\AttributeTok{top =} \FloatTok{0.05}\NormalTok{))}
\NormalTok{  BEDROC }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(BEDROC, }\FunctionTok{bedroc}\NormalTok{(}\AttributeTok{x =}\NormalTok{ y\_pred, }\AttributeTok{y =}\NormalTok{ y\_true, }\AttributeTok{alpha =} \DecValTok{20}\NormalTok{))}
\NormalTok{\}}
\FunctionTok{save}\NormalTok{(logloss, MCC, F1, acc, EF, BEDROC, }\AttributeTok{file =} \StringTok{"./rdata/final\_evaluation\_cpp.RData"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{load}\NormalTok{(}\AttributeTok{file =} \StringTok{"./rdata/final\_evaluation\_cpp.RData"}\NormalTok{)}
\FunctionTok{data.frame}\NormalTok{(}
  \AttributeTok{Metric =} \FunctionTok{c}\NormalTok{(}\StringTok{"Log loss"}\NormalTok{, }\StringTok{"MCC"}\NormalTok{, }\StringTok{"F\textless{}sub\textgreater{}1\textless{}/sub\textgreater{}"}\NormalTok{, }\StringTok{"Balanced accuracy"}\NormalTok{, }\StringTok{"EF"}\NormalTok{, }\StringTok{"BEDROC"}\NormalTok{),}
  \StringTok{\textasciigrave{}}\AttributeTok{Mean  s.e.m.}\StringTok{\textasciigrave{}} \OtherTok{=} \FunctionTok{c}\NormalTok{(}
    \FunctionTok{paste0}\NormalTok{(}\FunctionTok{round}\NormalTok{(}\FunctionTok{mean}\NormalTok{(logloss), }\DecValTok{3}\NormalTok{), }\StringTok{"  "}\NormalTok{, }\FunctionTok{round}\NormalTok{(}\FunctionTok{sem}\NormalTok{(logloss), }\DecValTok{3}\NormalTok{)),}
    \FunctionTok{paste0}\NormalTok{(}\FunctionTok{round}\NormalTok{(}\FunctionTok{mean}\NormalTok{(MCC), }\DecValTok{3}\NormalTok{), }\StringTok{"  "}\NormalTok{, }\FunctionTok{round}\NormalTok{(}\FunctionTok{sem}\NormalTok{(MCC), }\DecValTok{3}\NormalTok{)),}
    \FunctionTok{paste0}\NormalTok{(}\FunctionTok{round}\NormalTok{(}\FunctionTok{mean}\NormalTok{(F1), }\DecValTok{3}\NormalTok{), }\StringTok{"  "}\NormalTok{, }\FunctionTok{round}\NormalTok{(}\FunctionTok{sem}\NormalTok{(F1), }\DecValTok{3}\NormalTok{)),}
    \FunctionTok{paste0}\NormalTok{(}\FunctionTok{round}\NormalTok{(}\FunctionTok{mean}\NormalTok{(acc), }\DecValTok{3}\NormalTok{), }\StringTok{"  "}\NormalTok{, }\FunctionTok{round}\NormalTok{(}\FunctionTok{sem}\NormalTok{(acc), }\DecValTok{3}\NormalTok{)),}
    \FunctionTok{paste0}\NormalTok{(}\FunctionTok{round}\NormalTok{(}\FunctionTok{mean}\NormalTok{(EF), }\DecValTok{3}\NormalTok{), }\StringTok{"  "}\NormalTok{, }\FunctionTok{round}\NormalTok{(}\FunctionTok{sem}\NormalTok{(EF), }\DecValTok{3}\NormalTok{)),}
    \FunctionTok{paste0}\NormalTok{(}\FunctionTok{round}\NormalTok{(}\FunctionTok{mean}\NormalTok{(BEDROC), }\DecValTok{3}\NormalTok{), }\StringTok{"  "}\NormalTok{, }\FunctionTok{round}\NormalTok{(}\FunctionTok{sem}\NormalTok{(BEDROC), }\DecValTok{3}\NormalTok{))}
\NormalTok{  ),}
  \AttributeTok{check.names =} \ConstantTok{FALSE}
\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{datatable}\NormalTok{(}\AttributeTok{escape =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{rownames =} \ConstantTok{FALSE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{03_model_training_files/figure-latex/unnamed-chunk-47-1.pdf}

\hypertarget{final-model-selection-1}{%
\subsection{Final model selection}\label{final-model-selection-1}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{load}\NormalTok{(}\AttributeTok{file =} \StringTok{"./rdata/model\_training\_grid\_models\_cpp.RData"}\NormalTok{)}

\NormalTok{holdout\_pred }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\StringTok{"./other\_data/cell\_penetration/whole\_data\_set/cv\_holdout\_predictions.csv"}\NormalTok{)}
\NormalTok{fold\_assign }\OtherTok{\textless{}{-}} \FunctionTok{rep}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{, }\FunctionTok{ceiling}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(holdout\_pred) }\SpecialCharTok{/} \DecValTok{10}\NormalTok{))[}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(holdout\_pred)]}
\NormalTok{data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
\CommentTok{\# Deep learning grid models}
\NormalTok{data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign,}
  \AttributeTok{grid\_name =} \StringTok{"Neural network grid model"}\NormalTok{,}
  \AttributeTok{grid\_meta =}\NormalTok{ dl\_grid}
\NormalTok{))}
\CommentTok{\# GBM grid models}
\NormalTok{data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign,}
  \AttributeTok{grid\_name =} \StringTok{"GBM grid model"}\NormalTok{,}
  \AttributeTok{grid\_meta =}\NormalTok{ gbm\_grid}
\NormalTok{))}
\CommentTok{\# GBM default models}
\NormalTok{data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign,}
  \AttributeTok{grid\_name =} \StringTok{"GBM model"}\NormalTok{,}
  \AttributeTok{grid\_meta =} \FunctionTok{as.list}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"GBM\_"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{5}\NormalTok{))}
\NormalTok{))}
\CommentTok{\# XGBoost grid models}
\NormalTok{data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign,}
  \AttributeTok{grid\_name =} \StringTok{"XGBoost grid model"}\NormalTok{,}
  \AttributeTok{grid\_meta =}\NormalTok{ xgboost\_grid}
\NormalTok{))}
\CommentTok{\# XGBoost default models}
\NormalTok{data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign,}
  \AttributeTok{grid\_name =} \StringTok{"XGBoost model"}\NormalTok{,}
  \AttributeTok{grid\_meta =} \FunctionTok{as.list}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"XGBoost\_"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{))}
\NormalTok{))}
\CommentTok{\# DRF}
\NormalTok{data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign, }\AttributeTok{grid\_name =} \StringTok{"DRF model"}\NormalTok{, }\AttributeTok{grid\_meta =} \FunctionTok{list}\NormalTok{(}\StringTok{"DRF"}\NormalTok{)))}
\CommentTok{\# XRT}
\NormalTok{data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign, }\AttributeTok{grid\_name =} \StringTok{"XRT model"}\NormalTok{, }\AttributeTok{grid\_meta =} \FunctionTok{list}\NormalTok{(}\StringTok{"XRT"}\NormalTok{)))}
\CommentTok{\# Super learner all}
\NormalTok{data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign, }\AttributeTok{grid\_name =} \StringTok{"Super learner all models"}\NormalTok{))}
\CommentTok{\# Super learner final}
\NormalTok{data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign, }\AttributeTok{grid\_name =} \StringTok{"Super learner final"}\NormalTok{))}
\CommentTok{\# Super learner deep learning}
\NormalTok{data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign, }\AttributeTok{grid\_name =} \StringTok{"Super learner neural network"}\NormalTok{))}
\CommentTok{\# Super learner GBM}
\NormalTok{data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign, }\AttributeTok{grid\_name =} \StringTok{"Super learner GBM"}\NormalTok{))}
\CommentTok{\# Super learner XGBoost}
\NormalTok{data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign, }\AttributeTok{grid\_name =} \StringTok{"Super learner XGBoost"}\NormalTok{))}

\NormalTok{data }\OtherTok{\textless{}{-}} \FunctionTok{do.call}\NormalTok{(rbind, data\_)}
\FunctionTok{write.csv}\NormalTok{(data, }\StringTok{"./other\_data/cell\_penetration/whole\_data\_set/cv\_res.csv"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\StringTok{"./other\_data/cell\_penetration/whole\_data\_set/cv\_res.csv"}\NormalTok{, }\AttributeTok{row.names =} \DecValTok{1}\NormalTok{, }\AttributeTok{check.names =} \ConstantTok{FALSE}\NormalTok{)}
\FunctionTok{statistical\_testing}\NormalTok{(data,}
  \AttributeTok{metric\_vec =} \FunctionTok{c}\NormalTok{(}\StringTok{"Log loss"}\NormalTok{, }\StringTok{"MCC"}\NormalTok{, }\StringTok{"F\_1"}\NormalTok{, }\StringTok{"Balanced accuracy"}\NormalTok{),}
  \AttributeTok{decreasing\_vec =} \FunctionTok{c}\NormalTok{(}\ConstantTok{FALSE}\NormalTok{, }\ConstantTok{TRUE}\NormalTok{, }\ConstantTok{TRUE}\NormalTok{, }\ConstantTok{TRUE}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{03_model_training_files/figure-latex/unnamed-chunk-49-1.pdf}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# statistical\_testing(data, metric\_vec=c(\textquotesingle{}Log loss\textquotesingle{}, \textquotesingle{}MCC\textquotesingle{}, \textquotesingle{}F\_1\textquotesingle{}, \textquotesingle{}Balanced accuracy\textquotesingle{}),}
\CommentTok{\#                     decreasing\_vec=c(FALSE, TRUE, TRUE, TRUE),}
\CommentTok{\#                     output\_path=\textquotesingle{}./other\_data/cell\_penetration/whole\_data\_set/cv\_res\_statistical\_testing.csv\textquotesingle{})}
\end{Highlighting}
\end{Shaded}

\hypertarget{final-reduced-sl-1}{%
\subsection{Final reduced SL}\label{final-reduced-sl-1}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{h2o.init}\NormalTok{(}\AttributeTok{nthreads =} \SpecialCharTok{{-}}\DecValTok{1}\NormalTok{)}
\NormalTok{model\_path }\OtherTok{\textless{}{-}} \StringTok{"/Users/renee/Downloads/cell\_penetration/whole\_data\_set/superlearner\_iter\_1"}
\NormalTok{model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(model\_path)}
\FunctionTok{load}\NormalTok{(}\AttributeTok{file =} \StringTok{"./rdata/model\_training\_grid\_models\_cpp.RData"}\NormalTok{)}
\NormalTok{data }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\StringTok{"./other\_data/cell\_penetration/whole\_data\_set/cv\_res.csv"}\NormalTok{, }\AttributeTok{row.names =} \DecValTok{1}\NormalTok{, }\AttributeTok{check.names =} \ConstantTok{FALSE}\NormalTok{)}
\NormalTok{df }\OtherTok{\textless{}{-}} \FunctionTok{as.data.frame}\NormalTok{(model}\SpecialCharTok{@}\NormalTok{model}\SpecialCharTok{$}\NormalTok{metalearner\_model}\SpecialCharTok{@}\NormalTok{model}\SpecialCharTok{$}\NormalTok{coefficients\_table)[}\FunctionTok{c}\NormalTok{(}\StringTok{"names"}\NormalTok{, }\StringTok{"standardized\_coefficients"}\NormalTok{)][}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{, ]}

\ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(df)) \{}
\NormalTok{  name }\OtherTok{\textless{}{-}}\NormalTok{ df}\SpecialCharTok{$}\NormalTok{names[i]}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{startsWith}\NormalTok{(name, }\StringTok{"DeepLearning\_model"}\NormalTok{)) \{}
    \ControlFlowTok{for}\NormalTok{ (j }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(dl\_grid)) \{}
      \ControlFlowTok{if}\NormalTok{ (name }\SpecialCharTok{\%in\%}\NormalTok{ dl\_grid[[j]]) }\ControlFlowTok{break}
\NormalTok{    \}}
\NormalTok{    df}\SpecialCharTok{$}\NormalTok{names[i] }\OtherTok{\textless{}{-}} \FunctionTok{paste}\NormalTok{(}\StringTok{"Neural network grid model"}\NormalTok{, j)}
\NormalTok{  \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{startsWith}\NormalTok{(name, }\StringTok{"GBM\_model"}\NormalTok{)) \{}
    \ControlFlowTok{for}\NormalTok{ (j }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(gbm\_grid)) \{}
      \ControlFlowTok{if}\NormalTok{ (name }\SpecialCharTok{\%in\%}\NormalTok{ gbm\_grid[[j]]) }\ControlFlowTok{break}
\NormalTok{    \}}
\NormalTok{    df}\SpecialCharTok{$}\NormalTok{names[i] }\OtherTok{\textless{}{-}} \FunctionTok{paste}\NormalTok{(}\StringTok{"GBM grid model"}\NormalTok{, j)}
\NormalTok{  \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{startsWith}\NormalTok{(name, }\StringTok{"XGBoost\_model"}\NormalTok{)) \{}
    \ControlFlowTok{for}\NormalTok{ (j }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(xgboost\_grid)) \{}
      \ControlFlowTok{if}\NormalTok{ (name }\SpecialCharTok{\%in\%}\NormalTok{ xgboost\_grid[[j]]) }\ControlFlowTok{break}
\NormalTok{    \}}
\NormalTok{    df}\SpecialCharTok{$}\NormalTok{names[i] }\OtherTok{\textless{}{-}} \FunctionTok{paste}\NormalTok{(}\StringTok{"XGBoost grid model"}\NormalTok{, j)}
\NormalTok{  \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{startsWith}\NormalTok{(name, }\StringTok{"DRF"}\NormalTok{)) \{}
\NormalTok{    df}\SpecialCharTok{$}\NormalTok{names[i] }\OtherTok{\textless{}{-}} \StringTok{"DRF model"}
\NormalTok{  \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{startsWith}\NormalTok{(name, }\StringTok{"XRT"}\NormalTok{)) \{}
\NormalTok{    df}\SpecialCharTok{$}\NormalTok{names[i] }\OtherTok{\textless{}{-}} \StringTok{"XRT model"}
\NormalTok{  \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{    df}\SpecialCharTok{$}\NormalTok{names[i] }\OtherTok{\textless{}{-}} \FunctionTok{paste}\NormalTok{(}\FunctionTok{strsplit}\NormalTok{(name, }\StringTok{"\_"}\NormalTok{)[[}\DecValTok{1}\NormalTok{]], }\AttributeTok{collapse =} \StringTok{" model "}\NormalTok{)}
\NormalTok{  \}}
\NormalTok{\}}

\FunctionTok{rownames}\NormalTok{(df) }\OtherTok{\textless{}{-}}\NormalTok{ df}\SpecialCharTok{$}\NormalTok{names}
\NormalTok{df }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(df, data[}\StringTok{"Balanced accuracy mean"}\NormalTok{], }\AttributeTok{by =} \StringTok{"row.names"}\NormalTok{)[, }\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{]}
\NormalTok{df }\OtherTok{\textless{}{-}}\NormalTok{ df[df}\SpecialCharTok{$}\NormalTok{standardized\_coefficients }\SpecialCharTok{\textgreater{}} \DecValTok{0}\NormalTok{, ]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{p2 }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(df, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =} \FunctionTok{reorder}\NormalTok{(names, standardized\_coefficients), }\AttributeTok{y =}\NormalTok{ standardized\_coefficients, }\AttributeTok{fill =} \StringTok{\textasciigrave{}}\AttributeTok{Balanced accuracy mean}\StringTok{\textasciigrave{}}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{geom\_col}\NormalTok{(}\AttributeTok{color =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \FloatTok{0.2}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_fill\_gradient}\NormalTok{(}\AttributeTok{low =} \StringTok{"white"}\NormalTok{, }\AttributeTok{high =} \StringTok{"red"}\NormalTok{, }\AttributeTok{n.breaks =} \DecValTok{4}\NormalTok{, }\AttributeTok{limits =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.85}\NormalTok{, }\FloatTok{1.00}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{geom\_text}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{label =} \FunctionTok{sprintf}\NormalTok{(}\StringTok{"\%.2f"}\NormalTok{, }\StringTok{\textasciigrave{}}\AttributeTok{Balanced accuracy mean}\StringTok{\textasciigrave{}}\NormalTok{)), }\AttributeTok{nudge\_y =} \SpecialCharTok{{-}}\FloatTok{0.0025}\NormalTok{, }\AttributeTok{size =} \DecValTok{3}\NormalTok{, }\AttributeTok{color =} \StringTok{"white"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_text}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{label =} \FunctionTok{sprintf}\NormalTok{(}\StringTok{"\%.3f"}\NormalTok{, standardized\_coefficients)), }\AttributeTok{nudge\_y =} \FloatTok{0.0035}\NormalTok{, }\AttributeTok{size =} \DecValTok{3}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{coord\_flip}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{scale\_y\_continuous}\NormalTok{(}\AttributeTok{limits =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FunctionTok{max}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{standardized\_coefficients) }\SpecialCharTok{+} \FloatTok{0.006}\NormalTok{), }\AttributeTok{expand =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.01}\NormalTok{, }\DecValTok{0}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{theme\_bw}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}
    \AttributeTok{panel.grid.major =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{panel.grid.minor =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{strip.background =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{panel.border =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{axis.line =} \FunctionTok{element\_line}\NormalTok{(}\AttributeTok{color =} \StringTok{"black"}\NormalTok{),}
    \AttributeTok{legend.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{10}\NormalTok{),}
    \AttributeTok{plot.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{hjust =} \FloatTok{0.5}\NormalTok{, }\AttributeTok{size =} \DecValTok{18}\NormalTok{),}
    \AttributeTok{plot.margin =}\NormalTok{ ggplot2}\SpecialCharTok{::}\FunctionTok{margin}\NormalTok{(}\DecValTok{10}\NormalTok{, }\DecValTok{10}\NormalTok{, }\DecValTok{10}\NormalTok{, }\DecValTok{0}\NormalTok{, }\StringTok{"pt"}\NormalTok{),}
    \AttributeTok{axis.title.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{18}\NormalTok{),}
    \AttributeTok{axis.title.y =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{18}\NormalTok{),}
    \AttributeTok{axis.text.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{12}\NormalTok{),}
    \AttributeTok{axis.text.y =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{12}\NormalTok{),}
    \AttributeTok{legend.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{14}\NormalTok{),}
    \AttributeTok{legend.position =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.85}\NormalTok{, }\FloatTok{0.5}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{guides}\NormalTok{(}\AttributeTok{fill =} \FunctionTok{guide\_colorbar}\NormalTok{(}\AttributeTok{title =} \StringTok{"Balanced accuracy"}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{xlab}\NormalTok{(}\StringTok{""}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{ylab}\NormalTok{(}\StringTok{"Coefficient"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{ggtitle}\NormalTok{(}\StringTok{"Cell{-}penetration"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics[width=1\linewidth]{./figures/Supplementary Fig 4 cpp super learner} \end{center}

\hypertarget{toxicity-classification-1}{%
\section{Toxicity (classification)}\label{toxicity-classification-1}}

\hypertarget{model-training-2}{%
\subsection{Model training}\label{model-training-2}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{train\_tx\_models }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(train\_set, exp\_dir, prefix, }\AttributeTok{nfolds =} \DecValTok{10}\NormalTok{, }\AttributeTok{grid\_seed =} \DecValTok{1}\NormalTok{) \{}
\NormalTok{  tmp }\OtherTok{\textless{}{-}} \FunctionTok{as.h2o}\NormalTok{(train\_set, }\AttributeTok{destination\_frame =}\NormalTok{ prefix)}
\NormalTok{  tmp[}\StringTok{"category"}\NormalTok{] }\OtherTok{\textless{}{-}} \FunctionTok{as.factor}\NormalTok{(tmp[}\StringTok{"category"}\NormalTok{])}
\NormalTok{  y }\OtherTok{\textless{}{-}} \StringTok{"category"}
\NormalTok{  x }\OtherTok{\textless{}{-}} \FunctionTok{setdiff}\NormalTok{(}\FunctionTok{names}\NormalTok{(tmp), y)}
\NormalTok{  res }\OtherTok{\textless{}{-}} \FunctionTok{as.data.frame}\NormalTok{(tmp}\SpecialCharTok{$}\NormalTok{category)}
\NormalTok{  samp\_factors }\OtherTok{\textless{}{-}} \FunctionTok{as.vector}\NormalTok{(}\FunctionTok{mean}\NormalTok{(}\FunctionTok{table}\NormalTok{(train\_set}\SpecialCharTok{$}\NormalTok{category)) }\SpecialCharTok{/} \FunctionTok{table}\NormalTok{(train\_set}\SpecialCharTok{$}\NormalTok{category))}
  \CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
  \CommentTok{\# base model training}
  \CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"Deep learning grid 1}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  deeplearning\_1 }\OtherTok{\textless{}{-}} \FunctionTok{h2o.grid}\NormalTok{(}
    \AttributeTok{algorithm =} \StringTok{"deeplearning"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{hyper\_params =}\NormalTok{ deeplearning\_params\_1,}
    \AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{, }\AttributeTok{balance\_classes =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{class\_sampling\_factors =}\NormalTok{ samp\_factors,}
    \AttributeTok{max\_after\_balance\_size =} \FloatTok{0.5}\NormalTok{,}
    \AttributeTok{search\_criteria =} \FunctionTok{list}\NormalTok{(}
      \AttributeTok{strategy =} \StringTok{"RandomDiscrete"}\NormalTok{,}
      \AttributeTok{max\_models =} \DecValTok{100}\NormalTok{, }\AttributeTok{seed =}\NormalTok{ grid\_seed}
\NormalTok{    ),}
    \AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}\NormalTok{, }\AttributeTok{parallelism =} \DecValTok{0}
\NormalTok{  )}
  \ControlFlowTok{for}\NormalTok{ (model\_id }\ControlFlowTok{in}\NormalTok{ deeplearning\_1}\SpecialCharTok{@}\NormalTok{model\_ids) \{}
\NormalTok{    tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(model\_id), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  \}}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"GBM grid}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  gbm }\OtherTok{\textless{}{-}} \FunctionTok{h2o.grid}\NormalTok{(}
    \AttributeTok{algorithm =} \StringTok{"gbm"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{hyper\_params =}\NormalTok{ gbm\_params, }\AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{,}
    \AttributeTok{balance\_classes =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{class\_sampling\_factors =}\NormalTok{ samp\_factors, }\AttributeTok{max\_after\_balance\_size =} \FloatTok{0.5}\NormalTok{,}
    \AttributeTok{search\_criteria =} \FunctionTok{list}\NormalTok{(}\AttributeTok{strategy =} \StringTok{"RandomDiscrete"}\NormalTok{, }\AttributeTok{max\_models =} \DecValTok{100}\NormalTok{, }\AttributeTok{seed =}\NormalTok{ grid\_seed),}
    \AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}\NormalTok{, }\AttributeTok{parallelism =} \DecValTok{0}
\NormalTok{  )}
  \ControlFlowTok{for}\NormalTok{ (model\_id }\ControlFlowTok{in}\NormalTok{ gbm}\SpecialCharTok{@}\NormalTok{model\_ids) \{}
\NormalTok{    tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(model\_id), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  \}}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"GBM 5 default models}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  gbm\_1 }\OtherTok{\textless{}{-}} \FunctionTok{h2o.gbm}\NormalTok{(}
    \AttributeTok{model\_id =} \StringTok{"GBM\_1"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{, }\AttributeTok{score\_tree\_interval =} \DecValTok{5}\NormalTok{,}
    \AttributeTok{balance\_classes =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{class\_sampling\_factors =}\NormalTok{ samp\_factors, }\AttributeTok{max\_after\_balance\_size =} \FloatTok{0.5}\NormalTok{,}
    \AttributeTok{col\_sample\_rate =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{col\_sample\_rate\_per\_tree =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{learn\_rate =} \FloatTok{0.1}\NormalTok{,}
    \AttributeTok{max\_depth =} \DecValTok{6}\NormalTok{, }\AttributeTok{min\_rows =} \DecValTok{1}\NormalTok{, }\AttributeTok{min\_split\_improvement =} \FloatTok{1e{-}5}\NormalTok{, }\AttributeTok{ntrees =} \DecValTok{10000}\NormalTok{, }\AttributeTok{sample\_rate =} \FloatTok{0.8}\NormalTok{,}
    \AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}
\NormalTok{  )}
\NormalTok{  gbm\_2 }\OtherTok{\textless{}{-}} \FunctionTok{h2o.gbm}\NormalTok{(}
    \AttributeTok{model\_id =} \StringTok{"GBM\_2"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{, }\AttributeTok{score\_tree\_interval =} \DecValTok{5}\NormalTok{,}
    \AttributeTok{balance\_classes =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{class\_sampling\_factors =}\NormalTok{ samp\_factors, }\AttributeTok{max\_after\_balance\_size =} \FloatTok{0.5}\NormalTok{,}
    \AttributeTok{col\_sample\_rate =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{col\_sample\_rate\_per\_tree =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{learn\_rate =} \FloatTok{0.1}\NormalTok{,}
    \AttributeTok{max\_depth =} \DecValTok{7}\NormalTok{, }\AttributeTok{min\_rows =} \DecValTok{10}\NormalTok{, }\AttributeTok{min\_split\_improvement =} \FloatTok{1e{-}5}\NormalTok{, }\AttributeTok{ntrees =} \DecValTok{10000}\NormalTok{, }\AttributeTok{sample\_rate =} \FloatTok{0.8}\NormalTok{,}
    \AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}
\NormalTok{  )}
\NormalTok{  gbm\_3 }\OtherTok{\textless{}{-}} \FunctionTok{h2o.gbm}\NormalTok{(}
    \AttributeTok{model\_id =} \StringTok{"GBM\_3"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{, }\AttributeTok{score\_tree\_interval =} \DecValTok{5}\NormalTok{,}
    \AttributeTok{balance\_classes =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{class\_sampling\_factors =}\NormalTok{ samp\_factors, }\AttributeTok{max\_after\_balance\_size =} \FloatTok{0.5}\NormalTok{,}
    \AttributeTok{col\_sample\_rate =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{col\_sample\_rate\_per\_tree =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{learn\_rate =} \FloatTok{0.1}\NormalTok{,}
    \AttributeTok{max\_depth =} \DecValTok{8}\NormalTok{, }\AttributeTok{min\_rows =} \DecValTok{10}\NormalTok{, }\AttributeTok{min\_split\_improvement =} \FloatTok{1e{-}5}\NormalTok{, }\AttributeTok{ntrees =} \DecValTok{10000}\NormalTok{, }\AttributeTok{sample\_rate =} \FloatTok{0.8}\NormalTok{,}
    \AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}
\NormalTok{  )}
\NormalTok{  gbm\_4 }\OtherTok{\textless{}{-}} \FunctionTok{h2o.gbm}\NormalTok{(}
    \AttributeTok{model\_id =} \StringTok{"GBM\_4"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{, }\AttributeTok{score\_tree\_interval =} \DecValTok{5}\NormalTok{,}
    \AttributeTok{balance\_classes =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{class\_sampling\_factors =}\NormalTok{ samp\_factors, }\AttributeTok{max\_after\_balance\_size =} \FloatTok{0.5}\NormalTok{,}
    \AttributeTok{col\_sample\_rate =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{col\_sample\_rate\_per\_tree =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{learn\_rate =} \FloatTok{0.1}\NormalTok{,}
    \AttributeTok{max\_depth =} \DecValTok{10}\NormalTok{, }\AttributeTok{min\_rows =} \DecValTok{10}\NormalTok{, }\AttributeTok{min\_split\_improvement =} \FloatTok{1e{-}5}\NormalTok{, }\AttributeTok{ntrees =} \DecValTok{10000}\NormalTok{, }\AttributeTok{sample\_rate =} \FloatTok{0.8}\NormalTok{,}
    \AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}
\NormalTok{  )}
\NormalTok{  gbm\_5 }\OtherTok{\textless{}{-}} \FunctionTok{h2o.gbm}\NormalTok{(}
    \AttributeTok{model\_id =} \StringTok{"GBM\_5"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{, }\AttributeTok{score\_tree\_interval =} \DecValTok{5}\NormalTok{,}
    \AttributeTok{balance\_classes =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{class\_sampling\_factors =}\NormalTok{ samp\_factors, }\AttributeTok{max\_after\_balance\_size =} \FloatTok{0.5}\NormalTok{,}
    \AttributeTok{col\_sample\_rate =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{col\_sample\_rate\_per\_tree =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{learn\_rate =} \FloatTok{0.1}\NormalTok{,}
    \AttributeTok{max\_depth =} \DecValTok{15}\NormalTok{, }\AttributeTok{min\_rows =} \DecValTok{100}\NormalTok{, }\AttributeTok{min\_split\_improvement =} \FloatTok{1e{-}5}\NormalTok{, }\AttributeTok{ntrees =} \DecValTok{10000}\NormalTok{, }\AttributeTok{sample\_rate =} \FloatTok{0.8}\NormalTok{,}
    \AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}
\NormalTok{  )}
  \ControlFlowTok{for}\NormalTok{ (model\_id }\ControlFlowTok{in} \FunctionTok{paste0}\NormalTok{(}\StringTok{"GBM\_"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{5}\NormalTok{)) \{}
\NormalTok{    tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(model\_id), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  \}}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"XGBoost grid}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  xgboost }\OtherTok{\textless{}{-}} \FunctionTok{h2o.grid}\NormalTok{(}
    \AttributeTok{algorithm =} \StringTok{"xgboost"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{hyper\_params =}\NormalTok{ xgboost\_params, }\AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{,}
    \AttributeTok{search\_criteria =} \FunctionTok{list}\NormalTok{(}\AttributeTok{strategy =} \StringTok{"RandomDiscrete"}\NormalTok{, }\AttributeTok{max\_models =} \DecValTok{100}\NormalTok{, }\AttributeTok{seed =}\NormalTok{ grid\_seed),}
    \AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}\NormalTok{, }\AttributeTok{parallelism =} \DecValTok{0}
\NormalTok{  )}
  \ControlFlowTok{for}\NormalTok{ (model\_id }\ControlFlowTok{in}\NormalTok{ xgboost}\SpecialCharTok{@}\NormalTok{model\_ids) \{}
\NormalTok{    tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(model\_id), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  \}}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"XGBoost 3 default models}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  xgboost\_1 }\OtherTok{\textless{}{-}} \FunctionTok{h2o.xgboost}\NormalTok{(}
    \AttributeTok{model\_id =} \StringTok{"XGBoost\_1"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{, }\AttributeTok{score\_tree\_interval =} \DecValTok{5}\NormalTok{,}
    \AttributeTok{booster =} \StringTok{"gbtree"}\NormalTok{, }\AttributeTok{col\_sample\_rate =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{col\_sample\_rate\_per\_tree =} \FloatTok{0.8}\NormalTok{,}
    \AttributeTok{max\_depth =} \DecValTok{10}\NormalTok{, }\AttributeTok{min\_rows =} \DecValTok{5}\NormalTok{, }\AttributeTok{ntrees =} \DecValTok{10000}\NormalTok{, }\AttributeTok{reg\_alpha =} \DecValTok{0}\NormalTok{, }\AttributeTok{reg\_lambda =} \DecValTok{1}\NormalTok{,}
    \AttributeTok{sample\_rate =} \FloatTok{0.6}\NormalTok{, }\AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}
\NormalTok{  )}
\NormalTok{  xgboost\_2 }\OtherTok{\textless{}{-}} \FunctionTok{h2o.xgboost}\NormalTok{(}
    \AttributeTok{model\_id =} \StringTok{"XGBoost\_2"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{, }\AttributeTok{score\_tree\_interval =} \DecValTok{5}\NormalTok{,}
    \AttributeTok{booster =} \StringTok{"gbtree"}\NormalTok{, }\AttributeTok{col\_sample\_rate =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{col\_sample\_rate\_per\_tree =} \FloatTok{0.8}\NormalTok{,}
    \AttributeTok{max\_depth =} \DecValTok{20}\NormalTok{, }\AttributeTok{min\_rows =} \DecValTok{10}\NormalTok{, }\AttributeTok{ntrees =} \DecValTok{10000}\NormalTok{, }\AttributeTok{reg\_alpha =} \DecValTok{0}\NormalTok{, }\AttributeTok{reg\_lambda =} \DecValTok{1}\NormalTok{,}
    \AttributeTok{sample\_rate =} \FloatTok{0.6}\NormalTok{, }\AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}
\NormalTok{  )}
\NormalTok{  xgboost\_3 }\OtherTok{\textless{}{-}} \FunctionTok{h2o.xgboost}\NormalTok{(}
    \AttributeTok{model\_id =} \StringTok{"XGBoost\_3"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{, }\AttributeTok{score\_tree\_interval =} \DecValTok{5}\NormalTok{,}
    \AttributeTok{booster =} \StringTok{"gbtree"}\NormalTok{, }\AttributeTok{col\_sample\_rate =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{col\_sample\_rate\_per\_tree =} \FloatTok{0.8}\NormalTok{,}
    \AttributeTok{max\_depth =} \DecValTok{5}\NormalTok{, }\AttributeTok{min\_rows =} \DecValTok{3}\NormalTok{, }\AttributeTok{ntrees =} \DecValTok{10000}\NormalTok{, }\AttributeTok{reg\_alpha =} \DecValTok{0}\NormalTok{, }\AttributeTok{reg\_lambda =} \DecValTok{1}\NormalTok{,}
    \AttributeTok{sample\_rate =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}
\NormalTok{  )}
  \ControlFlowTok{for}\NormalTok{ (model\_id }\ControlFlowTok{in} \FunctionTok{paste0}\NormalTok{(}\StringTok{"XGBoost\_"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{)) \{}
\NormalTok{    tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(model\_id), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  \}}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"GLM}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  glm }\OtherTok{\textless{}{-}} \FunctionTok{h2o.glm}\NormalTok{(}
    \AttributeTok{model\_id =} \StringTok{"GLM"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{alpha =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.0}\NormalTok{, }\FloatTok{0.2}\NormalTok{, }\FloatTok{0.4}\NormalTok{, }\FloatTok{0.6}\NormalTok{, }\FloatTok{0.8}\NormalTok{, }\FloatTok{1.0}\NormalTok{),}
    \AttributeTok{balance\_classes =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{class\_sampling\_factors =}\NormalTok{ samp\_factors, }\AttributeTok{max\_after\_balance\_size =} \FloatTok{0.5}\NormalTok{,}
    \AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}
\NormalTok{  )}
\NormalTok{  tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(}\StringTok{"GLM"}\NormalTok{), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"DRF}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  drf }\OtherTok{\textless{}{-}} \FunctionTok{h2o.randomForest}\NormalTok{(}
    \AttributeTok{model\_id =} \StringTok{"DRF"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{ntrees =} \DecValTok{10000}\NormalTok{,}
    \AttributeTok{score\_tree\_interval =} \DecValTok{5}\NormalTok{, }\AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{,}
    \AttributeTok{balance\_classes =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{class\_sampling\_factors =}\NormalTok{ samp\_factors, }\AttributeTok{max\_after\_balance\_size =} \FloatTok{0.5}\NormalTok{,}
    \AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}
\NormalTok{  )}
\NormalTok{  tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(}\StringTok{"DRF"}\NormalTok{), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"XRT}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  xrt }\OtherTok{\textless{}{-}} \FunctionTok{h2o.randomForest}\NormalTok{(}
    \AttributeTok{model\_id =} \StringTok{"XRT"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{ntrees =} \DecValTok{10000}\NormalTok{, }\AttributeTok{histogram\_type =} \StringTok{"Random"}\NormalTok{,}
    \AttributeTok{score\_tree\_interval =} \DecValTok{5}\NormalTok{, }\AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{,}
    \AttributeTok{balance\_classes =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{class\_sampling\_factors =}\NormalTok{ samp\_factors, }\AttributeTok{max\_after\_balance\_size =} \FloatTok{0.5}\NormalTok{,}
    \AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}
\NormalTok{  )}
\NormalTok{  tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(}\StringTok{"XRT"}\NormalTok{), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
  \CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
  \CommentTok{\# get holdout predictions}
  \CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\NormalTok{  base\_models }\OtherTok{\textless{}{-}} \FunctionTok{as.list}\NormalTok{(}\FunctionTok{c}\NormalTok{(}
    \FunctionTok{unlist}\NormalTok{(deeplearning\_1}\SpecialCharTok{@}\NormalTok{model\_ids),}
    \FunctionTok{unlist}\NormalTok{(gbm}\SpecialCharTok{@}\NormalTok{model\_ids), }\FunctionTok{paste0}\NormalTok{(}\StringTok{"GBM\_"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{5}\NormalTok{),}
    \FunctionTok{unlist}\NormalTok{(xgboost}\SpecialCharTok{@}\NormalTok{model\_ids), }\FunctionTok{paste0}\NormalTok{(}\StringTok{"XGBoost\_"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{),}
    \StringTok{"GLM"}\NormalTok{,}
    \StringTok{"DRF"}\NormalTok{,}
    \StringTok{"XRT"}
\NormalTok{  ))}
  \ControlFlowTok{for}\NormalTok{ (model\_id }\ControlFlowTok{in}\NormalTok{ base\_models) \{}
\NormalTok{    res }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(res, }\FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{h2o.getFrame}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"cv\_holdout\_prediction\_"}\NormalTok{, model\_id))[}\DecValTok{3}\NormalTok{],}
      \AttributeTok{col.names =}\NormalTok{ model\_id}
\NormalTok{    ))}
\NormalTok{  \}}
  \CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
  \CommentTok{\# super learner training}
  \CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\NormalTok{  sl\_iter }\OtherTok{\textless{}{-}} \DecValTok{0}
  \FunctionTok{cat}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"Super learner iteration "}\NormalTok{, sl\_iter, }\StringTok{" ("}\NormalTok{, }\FunctionTok{length}\NormalTok{(base\_models), }\StringTok{" models)}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{))}
\NormalTok{  sl }\OtherTok{\textless{}{-}} \FunctionTok{h2o.stackedEnsemble}\NormalTok{(}
    \AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{model\_id =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"superlearner\_iter\_"}\NormalTok{, sl\_iter),}
    \AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{,}
    \AttributeTok{base\_models =}\NormalTok{ base\_models,}
    \AttributeTok{metalearner\_algorithm =} \StringTok{"glm"}\NormalTok{,}
    \AttributeTok{metalearner\_nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_levelone\_frame =} \ConstantTok{TRUE}\NormalTok{,}
    \AttributeTok{metalearner\_params =} \FunctionTok{list}\NormalTok{(}
      \AttributeTok{standardize =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{,}
      \AttributeTok{balance\_classes =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{class\_sampling\_factors =}\NormalTok{ samp\_factors,}
      \AttributeTok{max\_after\_balance\_size =} \FloatTok{0.5}
\NormalTok{    )}
\NormalTok{  )}
\NormalTok{  tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"superlearner\_iter\_"}\NormalTok{, sl\_iter)), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  model\_id }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"metalearner\_glm\_superlearner\_iter\_"}\NormalTok{, sl\_iter)}
\NormalTok{  tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(model\_id), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  res }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(res, }\FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{h2o.getFrame}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"cv\_holdout\_prediction\_"}\NormalTok{, model\_id))[}\DecValTok{3}\NormalTok{],}
    \AttributeTok{col.names =} \FunctionTok{paste0}\NormalTok{(model\_id, }\StringTok{"\_"}\NormalTok{, }\FunctionTok{length}\NormalTok{(base\_models), }\StringTok{"\_models"}\NormalTok{)}
\NormalTok{  ))}
  \CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
  \CommentTok{\# super learner base model reduction}
  \CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
  \ControlFlowTok{while}\NormalTok{ (}\ConstantTok{TRUE}\NormalTok{) \{}
\NormalTok{    meta }\OtherTok{\textless{}{-}} \FunctionTok{h2o.getModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"metalearner\_glm\_superlearner\_iter\_"}\NormalTok{, sl\_iter, }\StringTok{"\_cv\_1"}\NormalTok{))}
\NormalTok{    names }\OtherTok{\textless{}{-}}\NormalTok{ meta}\SpecialCharTok{@}\NormalTok{model}\SpecialCharTok{$}\NormalTok{coefficients\_table[, }\StringTok{"names"}\NormalTok{]}
\NormalTok{    coeffs }\OtherTok{\textless{}{-}}\NormalTok{ (meta}\SpecialCharTok{@}\NormalTok{model}\SpecialCharTok{$}\NormalTok{coefficients\_table[, }\StringTok{"standardized\_coefficients"}\NormalTok{] }\SpecialCharTok{\textgreater{}} \DecValTok{0}\NormalTok{)}
    \ControlFlowTok{for}\NormalTok{ (j }\ControlFlowTok{in} \DecValTok{2}\SpecialCharTok{:}\NormalTok{nfolds) \{}
\NormalTok{      meta }\OtherTok{\textless{}{-}} \FunctionTok{h2o.getModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"metalearner\_glm\_superlearner\_iter\_"}\NormalTok{, sl\_iter, }\StringTok{"\_cv\_"}\NormalTok{, j))}
\NormalTok{      names }\OtherTok{\textless{}{-}}\NormalTok{ meta}\SpecialCharTok{@}\NormalTok{model}\SpecialCharTok{$}\NormalTok{coefficients\_table[, }\StringTok{"names"}\NormalTok{]}
\NormalTok{      coeffs }\OtherTok{\textless{}{-}}\NormalTok{ coeffs }\SpecialCharTok{+}\NormalTok{ (meta}\SpecialCharTok{@}\NormalTok{model}\SpecialCharTok{$}\NormalTok{coefficients\_table[, }\StringTok{"standardized\_coefficients"}\NormalTok{] }\SpecialCharTok{\textgreater{}} \DecValTok{0}\NormalTok{)}
\NormalTok{    \}}
\NormalTok{    base\_models\_ }\OtherTok{\textless{}{-}} \FunctionTok{as.list}\NormalTok{(names[coeffs }\SpecialCharTok{\textgreater{}=} \FunctionTok{ceiling}\NormalTok{(nfolds }\SpecialCharTok{/} \DecValTok{2}\NormalTok{) }\SpecialCharTok{\&}\NormalTok{ names }\SpecialCharTok{!=} \StringTok{"Intercept"}\NormalTok{])}
    \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{length}\NormalTok{(base\_models\_) }\SpecialCharTok{==} \DecValTok{0}\NormalTok{) \{}
      \FunctionTok{cat}\NormalTok{(}\StringTok{"No base models passing the threshold}\SpecialCharTok{\textbackslash{}n\textbackslash{}n}\StringTok{"}\NormalTok{)}
      \ControlFlowTok{break}
\NormalTok{    \}}
    \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{sum}\NormalTok{(base\_models }\SpecialCharTok{\%in\%}\NormalTok{ base\_models\_) }\SpecialCharTok{==} \FunctionTok{length}\NormalTok{(base\_models)) \{}
      \FunctionTok{cat}\NormalTok{(}\StringTok{"No further reduction of base models}\SpecialCharTok{\textbackslash{}n\textbackslash{}n}\StringTok{"}\NormalTok{)}
      \ControlFlowTok{break}
\NormalTok{    \}}
\NormalTok{    sl\_iter }\OtherTok{\textless{}{-}}\NormalTok{ sl\_iter }\SpecialCharTok{+} \DecValTok{1}
\NormalTok{    base\_models }\OtherTok{\textless{}{-}}\NormalTok{ base\_models\_}
    \FunctionTok{cat}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"Super learner iteration "}\NormalTok{, sl\_iter, }\StringTok{" ("}\NormalTok{, }\FunctionTok{length}\NormalTok{(base\_models), }\StringTok{" models)}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{))}
\NormalTok{    sl }\OtherTok{\textless{}{-}} \FunctionTok{h2o.stackedEnsemble}\NormalTok{(}
      \AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{model\_id =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"superlearner\_iter\_"}\NormalTok{, sl\_iter),}
      \AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{,}
      \AttributeTok{base\_models =}\NormalTok{ base\_models,}
      \AttributeTok{metalearner\_algorithm =} \StringTok{"glm"}\NormalTok{,}
      \AttributeTok{metalearner\_nfolds =}\NormalTok{ nfolds,}
      \AttributeTok{keep\_levelone\_frame =} \ConstantTok{TRUE}\NormalTok{,}
      \AttributeTok{metalearner\_params =} \FunctionTok{list}\NormalTok{(}
        \AttributeTok{standardize =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{,}
        \AttributeTok{balance\_classes =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{class\_sampling\_factors =}\NormalTok{ samp\_factors,}
        \AttributeTok{max\_after\_balance\_size =} \FloatTok{0.5}
\NormalTok{      )}
\NormalTok{    )}
\NormalTok{    tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"superlearner\_iter\_"}\NormalTok{, sl\_iter)), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{    model\_id }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"metalearner\_glm\_superlearner\_iter\_"}\NormalTok{, sl\_iter)}
\NormalTok{    tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(model\_id), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{    res }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(res, }\FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{h2o.getFrame}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"cv\_holdout\_prediction\_"}\NormalTok{, model\_id))[}\DecValTok{3}\NormalTok{],}
      \AttributeTok{col.names =} \FunctionTok{paste0}\NormalTok{(model\_id, }\StringTok{"\_"}\NormalTok{, }\FunctionTok{length}\NormalTok{(base\_models), }\StringTok{"\_models"}\NormalTok{)}
\NormalTok{    ))}
\NormalTok{  \}}
  \CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
  \CommentTok{\# super learner for homogeneous base models}
  \CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
  \CommentTok{\# DeepLearning}
\NormalTok{  base\_models }\OtherTok{\textless{}{-}}\NormalTok{ deeplearning\_1}\SpecialCharTok{@}\NormalTok{model\_ids}
  \FunctionTok{cat}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"Super learner deep learning ("}\NormalTok{, }\FunctionTok{length}\NormalTok{(base\_models), }\StringTok{" models)}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{))}
\NormalTok{  sl }\OtherTok{\textless{}{-}} \FunctionTok{h2o.stackedEnsemble}\NormalTok{(}
    \AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{model\_id =} \StringTok{"superlearner\_deeplearning"}\NormalTok{,}
    \AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{,}
    \AttributeTok{base\_models =}\NormalTok{ base\_models,}
    \AttributeTok{metalearner\_algorithm =} \StringTok{"glm"}\NormalTok{,}
    \AttributeTok{metalearner\_nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_levelone\_frame =} \ConstantTok{TRUE}\NormalTok{,}
    \AttributeTok{metalearner\_params =} \FunctionTok{list}\NormalTok{(}
      \AttributeTok{standardize =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{,}
      \AttributeTok{balance\_classes =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{class\_sampling\_factors =}\NormalTok{ samp\_factors,}
      \AttributeTok{max\_after\_balance\_size =} \FloatTok{0.5}
\NormalTok{    )}
\NormalTok{  )}
\NormalTok{  tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(}\StringTok{"superlearner\_deeplearning"}\NormalTok{), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  model\_id }\OtherTok{\textless{}{-}} \StringTok{"metalearner\_glm\_superlearner\_deeplearning"}
\NormalTok{  tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(model\_id), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  res }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(res, }\FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{h2o.getFrame}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"cv\_holdout\_prediction\_"}\NormalTok{, model\_id))[}\DecValTok{3}\NormalTok{],}
    \AttributeTok{col.names =} \FunctionTok{paste0}\NormalTok{(model\_id, }\StringTok{"\_"}\NormalTok{, }\FunctionTok{length}\NormalTok{(base\_models), }\StringTok{"\_models"}\NormalTok{)}
\NormalTok{  ))}
  \CommentTok{\# GBM}
\NormalTok{  base\_models }\OtherTok{\textless{}{-}} \FunctionTok{as.list}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\FunctionTok{unlist}\NormalTok{(gbm}\SpecialCharTok{@}\NormalTok{model\_ids), }\FunctionTok{paste0}\NormalTok{(}\StringTok{"GBM\_"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{5}\NormalTok{)))}
  \FunctionTok{cat}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"Super learner GBM ("}\NormalTok{, }\FunctionTok{length}\NormalTok{(base\_models), }\StringTok{" models)}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{))}
\NormalTok{  sl }\OtherTok{\textless{}{-}} \FunctionTok{h2o.stackedEnsemble}\NormalTok{(}
    \AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{model\_id =} \StringTok{"superlearner\_gbm"}\NormalTok{,}
    \AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{,}
    \AttributeTok{base\_models =}\NormalTok{ base\_models,}
    \AttributeTok{metalearner\_algorithm =} \StringTok{"glm"}\NormalTok{,}
    \AttributeTok{metalearner\_nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_levelone\_frame =} \ConstantTok{TRUE}\NormalTok{,}
    \AttributeTok{metalearner\_params =} \FunctionTok{list}\NormalTok{(}
      \AttributeTok{standardize =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{,}
      \AttributeTok{balance\_classes =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{class\_sampling\_factors =}\NormalTok{ samp\_factors,}
      \AttributeTok{max\_after\_balance\_size =} \FloatTok{0.5}
\NormalTok{    )}
\NormalTok{  )}
\NormalTok{  tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(}\StringTok{"superlearner\_gbm"}\NormalTok{), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  model\_id }\OtherTok{\textless{}{-}} \StringTok{"metalearner\_glm\_superlearner\_gbm"}
\NormalTok{  tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(model\_id), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  res }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(res, }\FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{h2o.getFrame}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"cv\_holdout\_prediction\_"}\NormalTok{, model\_id))[}\DecValTok{3}\NormalTok{],}
    \AttributeTok{col.names =} \FunctionTok{paste0}\NormalTok{(model\_id, }\StringTok{"\_"}\NormalTok{, }\FunctionTok{length}\NormalTok{(base\_models), }\StringTok{"\_models"}\NormalTok{)}
\NormalTok{  ))}
  \CommentTok{\# XGBoost}
\NormalTok{  base\_models }\OtherTok{\textless{}{-}} \FunctionTok{as.list}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\FunctionTok{unlist}\NormalTok{(xgboost}\SpecialCharTok{@}\NormalTok{model\_ids), }\FunctionTok{paste0}\NormalTok{(}\StringTok{"XGBoost\_"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{)))}
  \FunctionTok{cat}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"Super learner XGBoost ("}\NormalTok{, }\FunctionTok{length}\NormalTok{(base\_models), }\StringTok{" models)}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{))}
\NormalTok{  sl }\OtherTok{\textless{}{-}} \FunctionTok{h2o.stackedEnsemble}\NormalTok{(}
    \AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{model\_id =} \StringTok{"superlearner\_xgboost"}\NormalTok{,}
    \AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{,}
    \AttributeTok{base\_models =}\NormalTok{ base\_models,}
    \AttributeTok{metalearner\_algorithm =} \StringTok{"glm"}\NormalTok{,}
    \AttributeTok{metalearner\_nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_levelone\_frame =} \ConstantTok{TRUE}\NormalTok{,}
    \AttributeTok{metalearner\_params =} \FunctionTok{list}\NormalTok{(}
      \AttributeTok{standardize =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{,}
      \AttributeTok{balance\_classes =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{class\_sampling\_factors =}\NormalTok{ samp\_factors,}
      \AttributeTok{max\_after\_balance\_size =} \FloatTok{0.5}
\NormalTok{    )}
\NormalTok{  )}
\NormalTok{  tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(}\StringTok{"superlearner\_xgboost"}\NormalTok{), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  model\_id }\OtherTok{\textless{}{-}} \StringTok{"metalearner\_glm\_superlearner\_xgboost"}
\NormalTok{  tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(model\_id), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  res }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(res, }\FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{h2o.getFrame}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"cv\_holdout\_prediction\_"}\NormalTok{, model\_id))[}\DecValTok{3}\NormalTok{],}
    \AttributeTok{col.names =} \FunctionTok{paste0}\NormalTok{(model\_id, }\StringTok{"\_"}\NormalTok{, }\FunctionTok{length}\NormalTok{(base\_models), }\StringTok{"\_models"}\NormalTok{)}
\NormalTok{  ))}
  \FunctionTok{write.csv}\NormalTok{(res, }\AttributeTok{file =} \FunctionTok{paste0}\NormalTok{(exp\_dir, }\StringTok{"/cv\_holdout\_predictions.csv"}\NormalTok{), }\AttributeTok{row.names =} \ConstantTok{FALSE}\NormalTok{)}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}n\textbackslash{}n}\StringTok{"}\NormalTok{)}
  \FunctionTok{h2o.removeAll}\NormalTok{()}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\hypertarget{inner-cross-validation-2}{%
\subsection{Inner cross-validation}\label{inner-cross-validation-2}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{load}\NormalTok{(}\AttributeTok{file =} \StringTok{"./rdata/var\_reduct\_tx\_train\_test\_splits.RData"}\NormalTok{)}
\ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{) \{}
  \FunctionTok{cat}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"Outer training set "}\NormalTok{, i, }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{))}
\NormalTok{  prefix }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"outer\_"}\NormalTok{, i)}
\NormalTok{  exp\_dir }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"/Users/renee/Downloads/toxicity/"}\NormalTok{, prefix)}
  \FunctionTok{dir.create}\NormalTok{(exp\_dir)}
  \FunctionTok{train\_tx\_models}\NormalTok{(}\AttributeTok{train\_set =}\NormalTok{ outer\_splits[[i]][[}\StringTok{"train"}\NormalTok{]], }\AttributeTok{exp\_dir =}\NormalTok{ exp\_dir, }\AttributeTok{prefix =}\NormalTok{ prefix)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\hypertarget{training-on-whole-data-set-2}{%
\subsection{Training on whole data set}\label{training-on-whole-data-set-2}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{load}\NormalTok{(}\AttributeTok{file =} \StringTok{"./rdata/var\_reduct\_tx\_train\_test\_splits.RData"}\NormalTok{)}
\NormalTok{prefix }\OtherTok{\textless{}{-}} \StringTok{"whole\_data\_set"}
\NormalTok{exp\_dir }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"/Users/renee/Downloads/toxicity/"}\NormalTok{, prefix)}
\FunctionTok{dir.create}\NormalTok{(exp\_dir)}
\FunctionTok{train\_tx\_models}\NormalTok{(}\AttributeTok{train\_set =}\NormalTok{ tx\_data, }\AttributeTok{exp\_dir =}\NormalTok{ exp\_dir, }\AttributeTok{prefix =}\NormalTok{ prefix)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Keep track of grid models}
\NormalTok{dl\_grid }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
\NormalTok{gbm\_grid }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
\NormalTok{xgboost\_grid }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
\NormalTok{dl\_grid\_params }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
\NormalTok{gbm\_grid\_params }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
\NormalTok{xgboost\_grid\_params }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
\ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{11}\NormalTok{) \{}
  \ControlFlowTok{if}\NormalTok{ (i }\SpecialCharTok{==} \DecValTok{11}\NormalTok{) \{}
    \FunctionTok{cat}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"Whole data set}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{))}
\NormalTok{    prefix }\OtherTok{\textless{}{-}} \StringTok{"whole\_data\_set"}
\NormalTok{  \} }\ControlFlowTok{else}\NormalTok{ \{}
    \FunctionTok{cat}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"Outer training set "}\NormalTok{, i, }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{))}
\NormalTok{    prefix }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"outer\_"}\NormalTok{, i)}
\NormalTok{  \}}
\NormalTok{  dir }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"/Users/renee/Downloads/toxicity/"}\NormalTok{, prefix)}
\NormalTok{  files }\OtherTok{\textless{}{-}} \FunctionTok{list.files}\NormalTok{(dir)}
  \CommentTok{\# Deep learning}
\NormalTok{  dl }\OtherTok{\textless{}{-}}\NormalTok{ files[}\FunctionTok{str\_detect}\NormalTok{(files, }\StringTok{"DeepLearning\_model"}\NormalTok{)]}
  \ControlFlowTok{for}\NormalTok{ (m }\ControlFlowTok{in}\NormalTok{ dl) \{}
\NormalTok{    model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/"}\NormalTok{, m))}
\NormalTok{    hs }\OtherTok{\textless{}{-}} \FunctionTok{sha1}\NormalTok{(}\FunctionTok{paste}\NormalTok{(}\FunctionTok{c}\NormalTok{(}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{epsilon,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{hidden,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{hidden\_dropout\_ratios,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{input\_dropout\_ratio,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{rho}
\NormalTok{    ), }\AttributeTok{collapse =} \StringTok{" "}\NormalTok{))}
    \ControlFlowTok{if}\NormalTok{ (hs }\SpecialCharTok{\%in\%} \FunctionTok{names}\NormalTok{(dl\_grid)) \{}
\NormalTok{      dl\_grid[[hs]] }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(dl\_grid[[hs]], m)}
\NormalTok{    \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{      dl\_grid[[hs]] }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(m)}
\NormalTok{      dl\_grid\_params }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(}
\NormalTok{        dl\_grid\_params,}
        \FunctionTok{c}\NormalTok{(}
          \StringTok{"epsilon"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{epsilon,}
          \StringTok{"hidden"} \OtherTok{=} \FunctionTok{paste0}\NormalTok{(}\StringTok{"["}\NormalTok{, }\FunctionTok{paste}\NormalTok{(model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{hidden, }\AttributeTok{collapse =} \StringTok{","}\NormalTok{), }\StringTok{"]"}\NormalTok{),}
          \StringTok{"hidden\_dropout\_ratios"} \OtherTok{=} \FunctionTok{paste0}\NormalTok{(}
            \StringTok{"["}\NormalTok{,}
            \FunctionTok{paste}\NormalTok{(model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{hidden\_dropout\_ratios,}
              \AttributeTok{collapse =} \StringTok{","}
\NormalTok{            ), }\StringTok{"]"}
\NormalTok{          ),}
          \StringTok{"input\_dropout\_ratio"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{input\_dropout\_ratio,}
          \StringTok{"rho"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{rho}
\NormalTok{        )}
\NormalTok{      )}
\NormalTok{    \}}
\NormalTok{  \}}
  \FunctionTok{h2o.removeAll}\NormalTok{()}
  \CommentTok{\# GBM}
\NormalTok{  gbm }\OtherTok{\textless{}{-}}\NormalTok{ files[}\FunctionTok{str\_detect}\NormalTok{(files, }\StringTok{"GBM\_model"}\NormalTok{)]}
  \ControlFlowTok{for}\NormalTok{ (m }\ControlFlowTok{in}\NormalTok{ gbm) \{}
\NormalTok{    model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/"}\NormalTok{, m))}
\NormalTok{    hs }\OtherTok{\textless{}{-}} \FunctionTok{sha1}\NormalTok{(}\FunctionTok{paste}\NormalTok{(}\FunctionTok{c}\NormalTok{(}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{col\_sample\_rate,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{col\_sample\_rate\_per\_tree,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{max\_depth,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{min\_rows,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{min\_split\_improvement,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{sample\_rate}
\NormalTok{    ), }\AttributeTok{collapse =} \StringTok{" "}\NormalTok{))}
    \ControlFlowTok{if}\NormalTok{ (hs }\SpecialCharTok{\%in\%} \FunctionTok{names}\NormalTok{(gbm\_grid)) \{}
\NormalTok{      gbm\_grid[[hs]] }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(gbm\_grid[[hs]], m)}
\NormalTok{    \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{      gbm\_grid[[hs]] }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(m)}
\NormalTok{      gbm\_grid\_params }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(}
\NormalTok{        gbm\_grid\_params,}
        \FunctionTok{c}\NormalTok{(}
          \StringTok{"col\_sample\_rate"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{col\_sample\_rate,}
          \StringTok{"col\_sample\_rate\_per\_tree"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{col\_sample\_rate\_per\_tree,}
          \StringTok{"max\_depth"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{max\_depth,}
          \StringTok{"min\_rows"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{min\_rows,}
          \StringTok{"min\_split\_improvement"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{min\_split\_improvement,}
          \StringTok{"sample\_rate"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{sample\_rate}
\NormalTok{        )}
\NormalTok{      )}
\NormalTok{    \}}
\NormalTok{  \}}
  \FunctionTok{h2o.removeAll}\NormalTok{()}
  \CommentTok{\# XGBoost}
\NormalTok{  xgboost }\OtherTok{\textless{}{-}}\NormalTok{ files[}\FunctionTok{str\_detect}\NormalTok{(files, }\StringTok{"XGBoost\_model"}\NormalTok{)]}
  \ControlFlowTok{for}\NormalTok{ (m }\ControlFlowTok{in}\NormalTok{ xgboost) \{}
\NormalTok{    model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/"}\NormalTok{, m))}
\NormalTok{    hs }\OtherTok{\textless{}{-}} \FunctionTok{sha1}\NormalTok{(}\FunctionTok{paste}\NormalTok{(}\FunctionTok{c}\NormalTok{(}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{booster,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{col\_sample\_rate,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{col\_sample\_rate\_per\_tree,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{max\_depth,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{min\_rows,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{reg\_alpha,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{reg\_lambda,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{sample\_rate}
\NormalTok{    ), }\AttributeTok{collapse =} \StringTok{" "}\NormalTok{))}
    \ControlFlowTok{if}\NormalTok{ (hs }\SpecialCharTok{\%in\%} \FunctionTok{names}\NormalTok{(xgboost\_grid)) \{}
\NormalTok{      xgboost\_grid[[hs]] }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(xgboost\_grid[[hs]], m)}
\NormalTok{    \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{      xgboost\_grid[[hs]] }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(m)}
\NormalTok{      xgboost\_grid\_params }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(}
\NormalTok{        xgboost\_grid\_params,}
        \FunctionTok{c}\NormalTok{(}
          \StringTok{"booster"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{booster,}
          \StringTok{"col\_sample\_rate"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{col\_sample\_rate,}
          \StringTok{"col\_sample\_rate\_per\_tree"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{col\_sample\_rate\_per\_tree,}
          \StringTok{"max\_depth"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{max\_depth,}
          \StringTok{"min\_rows"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{min\_rows,}
          \StringTok{"reg\_alpha"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{reg\_alpha,}
          \StringTok{"reg\_lambda"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{reg\_lambda,}
          \StringTok{"sample\_rate"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{sample\_rate}
\NormalTok{        )}
\NormalTok{      )}
\NormalTok{    \}}
\NormalTok{  \}}
  \FunctionTok{h2o.removeAll}\NormalTok{()}
\NormalTok{\}}

\NormalTok{dl\_grid\_params }\OtherTok{\textless{}{-}} \FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{t}\NormalTok{(}\FunctionTok{data.frame}\NormalTok{(dl\_grid\_params)))}
\FunctionTok{rownames}\NormalTok{(dl\_grid\_params) }\OtherTok{\textless{}{-}} \FunctionTok{paste}\NormalTok{(}\StringTok{"Neural network grid model"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(dl\_grid\_params))}

\NormalTok{gbm\_grid\_params }\OtherTok{\textless{}{-}} \FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{t}\NormalTok{(}\FunctionTok{data.frame}\NormalTok{(gbm\_grid\_params)))}
\FunctionTok{rownames}\NormalTok{(gbm\_grid\_params) }\OtherTok{\textless{}{-}} \FunctionTok{paste}\NormalTok{(}\StringTok{"GBM grid model"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(gbm\_grid\_params))}

\NormalTok{xgboost\_grid\_params }\OtherTok{\textless{}{-}} \FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{t}\NormalTok{(}\FunctionTok{data.frame}\NormalTok{(xgboost\_grid\_params)))}
\FunctionTok{rownames}\NormalTok{(xgboost\_grid\_params) }\OtherTok{\textless{}{-}} \FunctionTok{paste}\NormalTok{(}\StringTok{"XGBoost grid model"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(xgboost\_grid\_params))}

\FunctionTok{write.csv}\NormalTok{(dl\_grid\_params, }\StringTok{"./other\_data/toxicity/neural\_network\_grid\_params.csv"}\NormalTok{)}
\FunctionTok{write.csv}\NormalTok{(gbm\_grid\_params, }\StringTok{"./other\_data/toxicity/gbm\_grid\_params.csv"}\NormalTok{)}
\FunctionTok{write.csv}\NormalTok{(xgboost\_grid\_params, }\StringTok{"./other\_data/toxicity/xgboost\_grid\_params.csv"}\NormalTok{)}

\FunctionTok{save}\NormalTok{(dl\_grid, gbm\_grid, xgboost\_grid, }\AttributeTok{file =} \StringTok{"./rdata/model\_training\_grid\_models\_tx.RData"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{model-evaluation-2}{%
\subsection{Model evaluation}\label{model-evaluation-2}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{model\_evaluation }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(holdout\_pred, fold\_asign, grid\_name, }\AttributeTok{grid\_meta =} \ConstantTok{NULL}\NormalTok{) \{}
\NormalTok{  res\_ }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
\NormalTok{  model\_num }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{startsWith}\NormalTok{(grid\_name, }\StringTok{"Super learner"}\NormalTok{)) \{}
    \ControlFlowTok{if}\NormalTok{ (grid\_name }\SpecialCharTok{==} \StringTok{"Super learner all models"}\NormalTok{) \{}
\NormalTok{      m }\OtherTok{\textless{}{-}} \FunctionTok{colnames}\NormalTok{(holdout\_pred)[}\FunctionTok{startsWith}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(holdout\_pred), }\StringTok{"metalearner\_glm\_superlearner\_iter\_0"}\NormalTok{)]}
\NormalTok{    \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (grid\_name }\SpecialCharTok{==} \StringTok{"Super learner final"}\NormalTok{) \{}
\NormalTok{      sl\_models }\OtherTok{\textless{}{-}} \FunctionTok{colnames}\NormalTok{(holdout\_pred)[}\FunctionTok{startsWith}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(holdout\_pred), }\StringTok{"metalearner\_glm\_superlearner\_iter"}\NormalTok{)]}
\NormalTok{      m }\OtherTok{\textless{}{-}}\NormalTok{ sl\_models[}\FunctionTok{length}\NormalTok{(sl\_models)]}
\NormalTok{    \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (grid\_name }\SpecialCharTok{==} \StringTok{"Super learner neural network"}\NormalTok{) \{}
\NormalTok{      m }\OtherTok{\textless{}{-}} \FunctionTok{colnames}\NormalTok{(holdout\_pred)[}\FunctionTok{startsWith}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(holdout\_pred), }\StringTok{"metalearner\_glm\_superlearner\_deeplearning"}\NormalTok{)]}
\NormalTok{    \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (grid\_name }\SpecialCharTok{==} \StringTok{"Super learner GBM"}\NormalTok{) \{}
\NormalTok{      m }\OtherTok{\textless{}{-}} \FunctionTok{colnames}\NormalTok{(holdout\_pred)[}\FunctionTok{startsWith}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(holdout\_pred), }\StringTok{"metalearner\_glm\_superlearner\_gbm"}\NormalTok{)]}
\NormalTok{    \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (grid\_name }\SpecialCharTok{==} \StringTok{"Super learner XGBoost"}\NormalTok{) \{}
\NormalTok{      m }\OtherTok{\textless{}{-}} \FunctionTok{colnames}\NormalTok{(holdout\_pred)[}\FunctionTok{startsWith}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(holdout\_pred), }\StringTok{"metalearner\_glm\_superlearner\_xgboost"}\NormalTok{)]}
\NormalTok{    \}}
\NormalTok{    logloss }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{    MCC }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{    F1 }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{    acc }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{    EF }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{    BEDROC }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{    threshold }\OtherTok{\textless{}{-}} \FloatTok{0.5}
    \ControlFlowTok{for}\NormalTok{ (k }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{) \{}
\NormalTok{      y\_true }\OtherTok{\textless{}{-}}\NormalTok{ holdout\_pred[fold\_assign }\SpecialCharTok{==}\NormalTok{ k, }\StringTok{"category"}\NormalTok{]}
\NormalTok{      y\_pred }\OtherTok{\textless{}{-}}\NormalTok{ holdout\_pred[fold\_assign }\SpecialCharTok{==}\NormalTok{ k, m]}
\NormalTok{      y\_pred\_cls }\OtherTok{\textless{}{-}} \FunctionTok{sapply}\NormalTok{(y\_pred, }\ControlFlowTok{function}\NormalTok{(x) }\ControlFlowTok{if}\NormalTok{ (x }\SpecialCharTok{\textgreater{}=}\NormalTok{ threshold) }\DecValTok{1} \ControlFlowTok{else} \DecValTok{0}\NormalTok{)}
\NormalTok{      logloss }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(logloss, }\FunctionTok{LogLoss}\NormalTok{(}\AttributeTok{y\_pred =}\NormalTok{ y\_pred, }\AttributeTok{y\_true =}\NormalTok{ y\_true))}
\NormalTok{      MCC }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(MCC, }\FunctionTok{mcc}\NormalTok{(}\AttributeTok{preds =}\NormalTok{ y\_pred\_cls, }\AttributeTok{actuals =}\NormalTok{ y\_true))}
\NormalTok{      F1 }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(F1, }\FunctionTok{F1\_Score}\NormalTok{(}\AttributeTok{y\_pred =}\NormalTok{ y\_pred\_cls, }\AttributeTok{y\_true =}\NormalTok{ y\_true))}
\NormalTok{      acc }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(acc, }\FunctionTok{balanced\_accuracy}\NormalTok{(}\AttributeTok{y\_pred =}\NormalTok{ y\_pred\_cls, }\AttributeTok{y\_true =}\NormalTok{ y\_true))}
\NormalTok{      EF }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(EF, }\FunctionTok{enrichment\_factor}\NormalTok{(}\AttributeTok{x =}\NormalTok{ y\_pred, }\AttributeTok{y =}\NormalTok{ y\_true, }\AttributeTok{top =} \FloatTok{0.05}\NormalTok{))}
\NormalTok{      BEDROC }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(BEDROC, }\FunctionTok{bedroc}\NormalTok{(}\AttributeTok{x =}\NormalTok{ y\_pred, }\AttributeTok{y =}\NormalTok{ y\_true, }\AttributeTok{alpha =} \DecValTok{20}\NormalTok{))}
\NormalTok{    \}}
\NormalTok{    res\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(res\_, }\FunctionTok{c}\NormalTok{(}
      \FunctionTok{mean}\NormalTok{(logloss, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{), }\FunctionTok{sem}\NormalTok{(logloss),}
      \FunctionTok{mean}\NormalTok{(MCC, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{), }\FunctionTok{sem}\NormalTok{(MCC),}
      \FunctionTok{mean}\NormalTok{(F1, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{), }\FunctionTok{sem}\NormalTok{(F1),}
      \FunctionTok{mean}\NormalTok{(acc, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{), }\FunctionTok{sem}\NormalTok{(acc),}
      \FunctionTok{mean}\NormalTok{(EF, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{), }\FunctionTok{sem}\NormalTok{(EF),}
      \FunctionTok{mean}\NormalTok{(BEDROC, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{), }\FunctionTok{sem}\NormalTok{(BEDROC),}
\NormalTok{      logloss, MCC, F1, acc, EF, BEDROC}
\NormalTok{    ))}
\NormalTok{  \} }\ControlFlowTok{else}\NormalTok{ \{}
    \ControlFlowTok{for}\NormalTok{ (j }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(grid\_meta)) \{}
\NormalTok{      g }\OtherTok{\textless{}{-}}\NormalTok{ grid\_meta[[j]]}
\NormalTok{      m }\OtherTok{\textless{}{-}} \FunctionTok{intersect}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(holdout\_pred), g)}
      \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{length}\NormalTok{(m) }\SpecialCharTok{==} \DecValTok{1}\NormalTok{) \{}
\NormalTok{        model\_num }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(model\_num, j)}
\NormalTok{        logloss }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{        MCC }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{        F1 }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{        acc }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{        EF }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{        BEDROC }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{        threshold }\OtherTok{\textless{}{-}} \FloatTok{0.5}
        \ControlFlowTok{for}\NormalTok{ (k }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{) \{}
\NormalTok{          y\_true }\OtherTok{\textless{}{-}}\NormalTok{ holdout\_pred[fold\_assign }\SpecialCharTok{==}\NormalTok{ k, }\StringTok{"category"}\NormalTok{]}
\NormalTok{          y\_pred }\OtherTok{\textless{}{-}}\NormalTok{ holdout\_pred[fold\_assign }\SpecialCharTok{==}\NormalTok{ k, m]}
\NormalTok{          y\_pred\_cls }\OtherTok{\textless{}{-}} \FunctionTok{sapply}\NormalTok{(y\_pred, }\ControlFlowTok{function}\NormalTok{(x) }\ControlFlowTok{if}\NormalTok{ (x }\SpecialCharTok{\textgreater{}=}\NormalTok{ threshold) }\DecValTok{1} \ControlFlowTok{else} \DecValTok{0}\NormalTok{)}
\NormalTok{          logloss }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(logloss, }\FunctionTok{LogLoss}\NormalTok{(}\AttributeTok{y\_pred =}\NormalTok{ y\_pred, }\AttributeTok{y\_true =}\NormalTok{ y\_true))}
\NormalTok{          MCC }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(MCC, }\FunctionTok{mcc}\NormalTok{(}\AttributeTok{preds =}\NormalTok{ y\_pred\_cls, }\AttributeTok{actuals =}\NormalTok{ y\_true))}
\NormalTok{          F1 }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(F1, }\FunctionTok{F1\_Score}\NormalTok{(}\AttributeTok{y\_pred =}\NormalTok{ y\_pred\_cls, }\AttributeTok{y\_true =}\NormalTok{ y\_true))}
\NormalTok{          acc }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(acc, }\FunctionTok{balanced\_accuracy}\NormalTok{(}\AttributeTok{y\_pred =}\NormalTok{ y\_pred\_cls, }\AttributeTok{y\_true =}\NormalTok{ y\_true))}
\NormalTok{          EF }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(EF, }\FunctionTok{enrichment\_factor}\NormalTok{(}\AttributeTok{x =}\NormalTok{ y\_pred, }\AttributeTok{y =}\NormalTok{ y\_true, }\AttributeTok{top =} \FloatTok{0.05}\NormalTok{))}
\NormalTok{          BEDROC }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(BEDROC, }\FunctionTok{bedroc}\NormalTok{(}\AttributeTok{x =}\NormalTok{ y\_pred, }\AttributeTok{y =}\NormalTok{ y\_true, }\AttributeTok{alpha =} \DecValTok{20}\NormalTok{))}
\NormalTok{        \}}
\NormalTok{        res\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(res\_, }\FunctionTok{c}\NormalTok{(}
          \FunctionTok{mean}\NormalTok{(logloss, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{), }\FunctionTok{sem}\NormalTok{(logloss),}
          \FunctionTok{mean}\NormalTok{(MCC, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{), }\FunctionTok{sem}\NormalTok{(MCC),}
          \FunctionTok{mean}\NormalTok{(F1, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{), }\FunctionTok{sem}\NormalTok{(F1),}
          \FunctionTok{mean}\NormalTok{(acc, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{), }\FunctionTok{sem}\NormalTok{(acc),}
          \FunctionTok{mean}\NormalTok{(EF, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{), }\FunctionTok{sem}\NormalTok{(EF),}
          \FunctionTok{mean}\NormalTok{(BEDROC, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{), }\FunctionTok{sem}\NormalTok{(BEDROC),}
\NormalTok{          logloss, MCC, F1, acc, EF, BEDROC}
\NormalTok{        ))}
\NormalTok{      \}}
\NormalTok{    \}}
\NormalTok{  \}}
\NormalTok{  res }\OtherTok{\textless{}{-}} \FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{t}\NormalTok{(}\FunctionTok{data.frame}\NormalTok{(res\_)))}
  \FunctionTok{colnames}\NormalTok{(res) }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}
    \StringTok{"Log loss mean"}\NormalTok{, }\StringTok{"Log loss s.e.m."}\NormalTok{, }\StringTok{"MCC mean"}\NormalTok{, }\StringTok{"MCC s.e.m."}\NormalTok{, }\StringTok{"F\_1 mean"}\NormalTok{, }\StringTok{"F\_1 s.e.m."}\NormalTok{,}
    \StringTok{"Balanced accuracy mean"}\NormalTok{, }\StringTok{"Balanced accuracy s.e.m."}\NormalTok{, }\StringTok{"EF mean"}\NormalTok{, }\StringTok{"EF s.e.m."}\NormalTok{, }\StringTok{"BEDROC mean"}\NormalTok{, }\StringTok{"BEDROC s.e.m."}\NormalTok{,}
    \FunctionTok{paste}\NormalTok{(}\StringTok{"Log loss CV"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{), }\FunctionTok{paste}\NormalTok{(}\StringTok{"MCC CV"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{), }\FunctionTok{paste}\NormalTok{(}\StringTok{"F\_1 CV"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{),}
    \FunctionTok{paste}\NormalTok{(}\StringTok{"Balanced accuracy CV"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{), }\FunctionTok{paste}\NormalTok{(}\StringTok{"EF CV"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{), }\FunctionTok{paste}\NormalTok{(}\StringTok{"BEDROC CV"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{)}
\NormalTok{  )}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{nrow}\NormalTok{(res) }\SpecialCharTok{==} \DecValTok{1}\NormalTok{) \{}
    \FunctionTok{rownames}\NormalTok{(res) }\OtherTok{\textless{}{-}}\NormalTok{ grid\_name}
\NormalTok{  \} }\ControlFlowTok{else}\NormalTok{ \{}
    \FunctionTok{rownames}\NormalTok{(res) }\OtherTok{\textless{}{-}} \FunctionTok{paste}\NormalTok{(grid\_name, model\_num)}
\NormalTok{  \}}
  \FunctionTok{return}\NormalTok{(res)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\hypertarget{inner-loop-model-selection-2}{%
\subsection{Inner loop model selection}\label{inner-loop-model-selection-2}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{load}\NormalTok{(}\AttributeTok{file =} \StringTok{"./rdata/model\_training\_grid\_models\_tx.RData"}\NormalTok{)}

\ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{) \{}
\NormalTok{  holdout\_pred }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"./other\_data/toxicity/outer\_"}\NormalTok{, i, }\StringTok{"/cv\_holdout\_predictions.csv"}\NormalTok{))}
\NormalTok{  fold\_assign }\OtherTok{\textless{}{-}} \FunctionTok{rep}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{, }\FunctionTok{ceiling}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(holdout\_pred) }\SpecialCharTok{/} \DecValTok{10}\NormalTok{))[}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(holdout\_pred)]}
\NormalTok{  data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
  \CommentTok{\# Deep learning grid models}
\NormalTok{  data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign,}
    \AttributeTok{grid\_name =} \StringTok{"Neural network grid model"}\NormalTok{,}
    \AttributeTok{grid\_meta =}\NormalTok{ dl\_grid}
\NormalTok{  ))}
  \CommentTok{\# GBM grid models}
\NormalTok{  data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign,}
    \AttributeTok{grid\_name =} \StringTok{"GBM grid model"}\NormalTok{,}
    \AttributeTok{grid\_meta =}\NormalTok{ gbm\_grid}
\NormalTok{  ))}
  \CommentTok{\# GBM default models}
\NormalTok{  data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign,}
    \AttributeTok{grid\_name =} \StringTok{"GBM model"}\NormalTok{,}
    \AttributeTok{grid\_meta =} \FunctionTok{as.list}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"GBM\_"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{5}\NormalTok{))}
\NormalTok{  ))}
  \CommentTok{\# XGBoost grid models}
\NormalTok{  data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign,}
    \AttributeTok{grid\_name =} \StringTok{"XGBoost grid model"}\NormalTok{,}
    \AttributeTok{grid\_meta =}\NormalTok{ xgboost\_grid}
\NormalTok{  ))}
  \CommentTok{\# XGBoost default models}
\NormalTok{  data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign,}
    \AttributeTok{grid\_name =} \StringTok{"XGBoost model"}\NormalTok{,}
    \AttributeTok{grid\_meta =} \FunctionTok{as.list}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"XGBoost\_"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{))}
\NormalTok{  ))}
  \CommentTok{\# GLM}
\NormalTok{  data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign, }\AttributeTok{grid\_name =} \StringTok{"GLM model"}\NormalTok{, }\AttributeTok{grid\_meta =} \FunctionTok{list}\NormalTok{(}\StringTok{"GLM"}\NormalTok{)))}
  \CommentTok{\# DRF}
\NormalTok{  data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign, }\AttributeTok{grid\_name =} \StringTok{"DRF model"}\NormalTok{, }\AttributeTok{grid\_meta =} \FunctionTok{list}\NormalTok{(}\StringTok{"DRF"}\NormalTok{)))}
  \CommentTok{\# XRT}
\NormalTok{  data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign, }\AttributeTok{grid\_name =} \StringTok{"XRT model"}\NormalTok{, }\AttributeTok{grid\_meta =} \FunctionTok{list}\NormalTok{(}\StringTok{"XRT"}\NormalTok{)))}
  \CommentTok{\# Super learner all}
\NormalTok{  data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign, }\AttributeTok{grid\_name =} \StringTok{"Super learner all models"}\NormalTok{))}
  \CommentTok{\# Super learner final}
\NormalTok{  data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign, }\AttributeTok{grid\_name =} \StringTok{"Super learner final"}\NormalTok{))}
  \CommentTok{\# Super learner deep learning}
\NormalTok{  data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign, }\AttributeTok{grid\_name =} \StringTok{"Super learner neural network"}\NormalTok{))}
  \CommentTok{\# Super learner GBM}
\NormalTok{  data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign, }\AttributeTok{grid\_name =} \StringTok{"Super learner GBM"}\NormalTok{))}
  \CommentTok{\# Super learner XGBoost}
\NormalTok{  data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign, }\AttributeTok{grid\_name =} \StringTok{"Super learner XGBoost"}\NormalTok{))}

\NormalTok{  data }\OtherTok{\textless{}{-}} \FunctionTok{do.call}\NormalTok{(rbind, data\_)}
  \FunctionTok{write.csv}\NormalTok{(data, }\FunctionTok{paste0}\NormalTok{(}\StringTok{"./other\_data/toxicity/outer\_"}\NormalTok{, i, }\StringTok{"/cv\_res.csv"}\NormalTok{))}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\hypertarget{cv-1-2}{%
\subsubsection{CV 1}\label{cv-1-2}}

\includegraphics{03_model_training_files/figure-latex/unnamed-chunk-60-1.pdf}

\hypertarget{cv-2-2}{%
\subsubsection{CV 2}\label{cv-2-2}}

\includegraphics{03_model_training_files/figure-latex/unnamed-chunk-61-1.pdf}

\hypertarget{cv-3-2}{%
\subsubsection{CV 3}\label{cv-3-2}}

\includegraphics{03_model_training_files/figure-latex/unnamed-chunk-62-1.pdf}

\hypertarget{cv-4-2}{%
\subsubsection{CV 4}\label{cv-4-2}}

\includegraphics{03_model_training_files/figure-latex/unnamed-chunk-63-1.pdf}

\hypertarget{cv-5-2}{%
\subsubsection{CV 5}\label{cv-5-2}}

\includegraphics{03_model_training_files/figure-latex/unnamed-chunk-64-1.pdf}

\hypertarget{cv-6-2}{%
\subsubsection{CV 6}\label{cv-6-2}}

\includegraphics{03_model_training_files/figure-latex/unnamed-chunk-65-1.pdf}

\hypertarget{cv-7-2}{%
\subsubsection{CV 7}\label{cv-7-2}}

\includegraphics{03_model_training_files/figure-latex/unnamed-chunk-66-1.pdf}

\hypertarget{cv-8-2}{%
\subsubsection{CV 8}\label{cv-8-2}}

\includegraphics{03_model_training_files/figure-latex/unnamed-chunk-67-1.pdf}

\hypertarget{cv-9-2}{%
\subsubsection{CV 9}\label{cv-9-2}}

\includegraphics{03_model_training_files/figure-latex/unnamed-chunk-68-1.pdf}

\hypertarget{cv-10-2}{%
\subsubsection{CV 10}\label{cv-10-2}}

\includegraphics{03_model_training_files/figure-latex/unnamed-chunk-69-1.pdf}

\hypertarget{final-evaluation-2}{%
\subsection{Final evaluation}\label{final-evaluation-2}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{load}\NormalTok{(}\AttributeTok{file =} \StringTok{"./rdata/var\_reduct\_tx\_train\_test\_splits.RData"}\NormalTok{)}
\FunctionTok{load}\NormalTok{(}\AttributeTok{file =} \StringTok{"./rdata/model\_training\_grid\_models\_tx.RData"}\NormalTok{)}
\NormalTok{dir }\OtherTok{\textless{}{-}} \StringTok{"/Users/renee/Downloads/toxicity"}
\NormalTok{selected\_models }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}
  \StringTok{"Super learner XGBoost"}\NormalTok{, }\StringTok{"Super learner final"}\NormalTok{, }\StringTok{"Super learner final"}\NormalTok{, }\StringTok{"Super learner final"}\NormalTok{,}
  \StringTok{"Super learner final"}\NormalTok{, }\StringTok{"Super learner final"}\NormalTok{, }\StringTok{"Super learner final"}\NormalTok{, }\StringTok{"Super learner final"}\NormalTok{,}
  \StringTok{"Super learner final"}\NormalTok{, }\StringTok{"Super learner final"}
\NormalTok{)}
\NormalTok{logloss }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{MCC }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{F1 }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{acc }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{EF }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{BEDROC }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{threshold }\OtherTok{\textless{}{-}} \FloatTok{0.5}
\ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{) \{}
\NormalTok{  holdout\_pred }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"./other\_data/toxicity/outer\_"}\NormalTok{, i, }\StringTok{"/cv\_holdout\_predictions.csv"}\NormalTok{))}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{startsWith}\NormalTok{(selected\_models[i], }\StringTok{"Neural network grid model"}\NormalTok{)) \{}
\NormalTok{    grid\_num }\OtherTok{\textless{}{-}} \FunctionTok{as.integer}\NormalTok{(}\FunctionTok{str\_extract}\NormalTok{(selected\_models[i], }\StringTok{"[0{-}9]+"}\NormalTok{))}
\NormalTok{    m }\OtherTok{\textless{}{-}} \FunctionTok{intersect}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(holdout\_pred), dl\_grid[[grid\_num]])}
\NormalTok{    model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/outer\_"}\NormalTok{, i, }\StringTok{"/"}\NormalTok{, m))}
\NormalTok{  \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{startsWith}\NormalTok{(selected\_models[i], }\StringTok{"GBM grid model"}\NormalTok{)) \{}
\NormalTok{    grid\_num }\OtherTok{\textless{}{-}} \FunctionTok{as.integer}\NormalTok{(}\FunctionTok{str\_extract}\NormalTok{(selected\_models[i], }\StringTok{"[0{-}9]+"}\NormalTok{))}
\NormalTok{    m }\OtherTok{\textless{}{-}} \FunctionTok{intersect}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(holdout\_pred), gbm\_grid[[grid\_num]])}
\NormalTok{    model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/outer\_"}\NormalTok{, i, }\StringTok{"/"}\NormalTok{, m))}
\NormalTok{  \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{startsWith}\NormalTok{(selected\_models[i], }\StringTok{"GBM model"}\NormalTok{)) \{}
\NormalTok{    grid\_num }\OtherTok{\textless{}{-}} \FunctionTok{as.integer}\NormalTok{(}\FunctionTok{str\_extract}\NormalTok{(selected\_models[i], }\StringTok{"[0{-}9]+"}\NormalTok{))}
\NormalTok{    model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/outer\_"}\NormalTok{, i, }\StringTok{"/GBM\_"}\NormalTok{, grid\_num))}
\NormalTok{  \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{startsWith}\NormalTok{(selected\_models[i], }\StringTok{"XGBoost grid model"}\NormalTok{)) \{}
\NormalTok{    grid\_num }\OtherTok{\textless{}{-}} \FunctionTok{as.integer}\NormalTok{(}\FunctionTok{str\_extract}\NormalTok{(selected\_models[i], }\StringTok{"[0{-}9]+"}\NormalTok{))}
\NormalTok{    m }\OtherTok{\textless{}{-}} \FunctionTok{intersect}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(holdout\_pred), xgboost\_grid[[grid\_num]])}
\NormalTok{    model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/outer\_"}\NormalTok{, i, }\StringTok{"/"}\NormalTok{, m))}
\NormalTok{  \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{startsWith}\NormalTok{(selected\_models[i], }\StringTok{"XGBoost model"}\NormalTok{)) \{}
\NormalTok{    grid\_num }\OtherTok{\textless{}{-}} \FunctionTok{as.integer}\NormalTok{(}\FunctionTok{str\_extract}\NormalTok{(selected\_models[i], }\StringTok{"[0{-}9]+"}\NormalTok{))}
\NormalTok{    model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/outer\_"}\NormalTok{, i, }\StringTok{"/XGBoost\_"}\NormalTok{, grid\_num))}
\NormalTok{  \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (selected\_models[i] }\SpecialCharTok{==} \StringTok{"Super learner all models"}\NormalTok{) \{}
\NormalTok{    model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/outer\_"}\NormalTok{, i, }\StringTok{"/superlearner\_iter\_0"}\NormalTok{))}
\NormalTok{  \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (selected\_models[i] }\SpecialCharTok{==} \StringTok{"Super learner final"}\NormalTok{) \{}
\NormalTok{    files }\OtherTok{\textless{}{-}} \FunctionTok{list.files}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/outer\_"}\NormalTok{, i))}
\NormalTok{    files }\OtherTok{\textless{}{-}}\NormalTok{ files[}\FunctionTok{startsWith}\NormalTok{(files, }\StringTok{"superlearner\_iter"}\NormalTok{)]}
\NormalTok{    model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/outer\_"}\NormalTok{, i, }\StringTok{"/"}\NormalTok{, files[}\FunctionTok{length}\NormalTok{(files)]))}
\NormalTok{  \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (selected\_models[i] }\SpecialCharTok{==} \StringTok{"Super learner neural network"}\NormalTok{) \{}
\NormalTok{    model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/outer\_"}\NormalTok{, i, }\StringTok{"/superlearner\_deeplearning"}\NormalTok{))}
\NormalTok{  \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (selected\_models[i] }\SpecialCharTok{==} \StringTok{"Super learner GBM"}\NormalTok{) \{}
\NormalTok{    model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/outer\_"}\NormalTok{, i, }\StringTok{"/superlearner\_gbm"}\NormalTok{))}
\NormalTok{  \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (selected\_models[i] }\SpecialCharTok{==} \StringTok{"Super learner XGBoost"}\NormalTok{) \{}
\NormalTok{    model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/outer\_"}\NormalTok{, i, }\StringTok{"/superlearner\_xgboost"}\NormalTok{))}
\NormalTok{  \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{    model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/outer\_"}\NormalTok{, i, }\StringTok{"/"}\NormalTok{, }\FunctionTok{unlist}\NormalTok{(}\FunctionTok{strsplit}\NormalTok{(selected\_models[i], }\StringTok{" "}\NormalTok{))[}\DecValTok{1}\NormalTok{]))}
\NormalTok{  \}}
\NormalTok{  tmp }\OtherTok{\textless{}{-}} \FunctionTok{as.h2o}\NormalTok{(}\FunctionTok{subset}\NormalTok{(outer\_splits[[i]][[}\StringTok{"test"}\NormalTok{]], }\AttributeTok{select =} \SpecialCharTok{{-}}\NormalTok{category))}
\NormalTok{  y\_true }\OtherTok{\textless{}{-}} \FunctionTok{as.numeric}\NormalTok{(outer\_splits[[i]][[}\StringTok{"test"}\NormalTok{]]}\SpecialCharTok{$}\NormalTok{category) }\SpecialCharTok{{-}} \DecValTok{1}
\NormalTok{  y\_pred }\OtherTok{\textless{}{-}} \FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{h2o.predict}\NormalTok{(model, tmp)))[, }\DecValTok{3}\NormalTok{]}
\NormalTok{  y\_pred\_cls }\OtherTok{\textless{}{-}} \FunctionTok{sapply}\NormalTok{(y\_pred, }\ControlFlowTok{function}\NormalTok{(x) }\ControlFlowTok{if}\NormalTok{ (x }\SpecialCharTok{\textgreater{}=}\NormalTok{ threshold) }\DecValTok{1} \ControlFlowTok{else} \DecValTok{0}\NormalTok{)}
\NormalTok{  logloss }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(logloss, }\FunctionTok{LogLoss}\NormalTok{(}\AttributeTok{y\_pred =}\NormalTok{ y\_pred, }\AttributeTok{y\_true =}\NormalTok{ y\_true))}
\NormalTok{  MCC }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(MCC, }\FunctionTok{mcc}\NormalTok{(}\AttributeTok{preds =}\NormalTok{ y\_pred\_cls, }\AttributeTok{actuals =}\NormalTok{ y\_true))}
\NormalTok{  F1 }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(F1, }\FunctionTok{F1\_Score}\NormalTok{(}\AttributeTok{y\_pred =}\NormalTok{ y\_pred\_cls, }\AttributeTok{y\_true =}\NormalTok{ y\_true))}
\NormalTok{  acc }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(acc, }\FunctionTok{balanced\_accuracy}\NormalTok{(}\AttributeTok{y\_pred =}\NormalTok{ y\_pred\_cls, }\AttributeTok{y\_true =}\NormalTok{ y\_true))}
\NormalTok{  EF }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(EF, }\FunctionTok{enrichment\_factor}\NormalTok{(}\AttributeTok{x =}\NormalTok{ y\_pred, }\AttributeTok{y =}\NormalTok{ y\_true, }\AttributeTok{top =} \FloatTok{0.05}\NormalTok{))}
\NormalTok{  BEDROC }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(BEDROC, }\FunctionTok{bedroc}\NormalTok{(}\AttributeTok{x =}\NormalTok{ y\_pred, }\AttributeTok{y =}\NormalTok{ y\_true, }\AttributeTok{alpha =} \DecValTok{20}\NormalTok{))}
\NormalTok{\}}
\FunctionTok{save}\NormalTok{(logloss, MCC, F1, acc, EF, BEDROC, }\AttributeTok{file =} \StringTok{"./rdata/final\_evaluation\_tx.RData"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{load}\NormalTok{(}\AttributeTok{file =} \StringTok{"./rdata/final\_evaluation\_tx.RData"}\NormalTok{)}
\FunctionTok{data.frame}\NormalTok{(}
  \AttributeTok{Metric =} \FunctionTok{c}\NormalTok{(}\StringTok{"Log loss"}\NormalTok{, }\StringTok{"MCC"}\NormalTok{, }\StringTok{"F\textless{}sub\textgreater{}1\textless{}/sub\textgreater{}"}\NormalTok{, }\StringTok{"Balanced accuracy"}\NormalTok{, }\StringTok{"EF"}\NormalTok{, }\StringTok{"BEDROC"}\NormalTok{),}
  \StringTok{\textasciigrave{}}\AttributeTok{Mean  s.e.m.}\StringTok{\textasciigrave{}} \OtherTok{=} \FunctionTok{c}\NormalTok{(}
    \FunctionTok{paste0}\NormalTok{(}\FunctionTok{round}\NormalTok{(}\FunctionTok{mean}\NormalTok{(logloss), }\DecValTok{3}\NormalTok{), }\StringTok{"  "}\NormalTok{, }\FunctionTok{round}\NormalTok{(}\FunctionTok{sem}\NormalTok{(logloss), }\DecValTok{3}\NormalTok{)),}
    \FunctionTok{paste0}\NormalTok{(}\FunctionTok{round}\NormalTok{(}\FunctionTok{mean}\NormalTok{(MCC), }\DecValTok{3}\NormalTok{), }\StringTok{"  "}\NormalTok{, }\FunctionTok{round}\NormalTok{(}\FunctionTok{sem}\NormalTok{(MCC), }\DecValTok{3}\NormalTok{)),}
    \FunctionTok{paste0}\NormalTok{(}\FunctionTok{round}\NormalTok{(}\FunctionTok{mean}\NormalTok{(F1), }\DecValTok{3}\NormalTok{), }\StringTok{"  "}\NormalTok{, }\FunctionTok{round}\NormalTok{(}\FunctionTok{sem}\NormalTok{(F1), }\DecValTok{3}\NormalTok{)),}
    \FunctionTok{paste0}\NormalTok{(}\FunctionTok{round}\NormalTok{(}\FunctionTok{mean}\NormalTok{(acc), }\DecValTok{3}\NormalTok{), }\StringTok{"  "}\NormalTok{, }\FunctionTok{round}\NormalTok{(}\FunctionTok{sem}\NormalTok{(acc), }\DecValTok{3}\NormalTok{)),}
    \FunctionTok{paste0}\NormalTok{(}\FunctionTok{round}\NormalTok{(}\FunctionTok{mean}\NormalTok{(EF), }\DecValTok{3}\NormalTok{), }\StringTok{"  "}\NormalTok{, }\FunctionTok{round}\NormalTok{(}\FunctionTok{sem}\NormalTok{(EF), }\DecValTok{3}\NormalTok{)),}
    \FunctionTok{paste0}\NormalTok{(}\FunctionTok{round}\NormalTok{(}\FunctionTok{mean}\NormalTok{(BEDROC), }\DecValTok{3}\NormalTok{), }\StringTok{"  "}\NormalTok{, }\FunctionTok{round}\NormalTok{(}\FunctionTok{sem}\NormalTok{(BEDROC), }\DecValTok{3}\NormalTok{))}
\NormalTok{  ),}
  \AttributeTok{check.names =} \ConstantTok{FALSE}
\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{datatable}\NormalTok{(}\AttributeTok{escape =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{rownames =} \ConstantTok{FALSE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{03_model_training_files/figure-latex/unnamed-chunk-71-1.pdf}

\hypertarget{final-model-selection-2}{%
\subsection{Final model selection}\label{final-model-selection-2}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{load}\NormalTok{(}\AttributeTok{file =} \StringTok{"./rdata/model\_training\_grid\_models\_tx.RData"}\NormalTok{)}

\NormalTok{holdout\_pred }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\StringTok{"./other\_data/toxicity/whole\_data\_set/cv\_holdout\_predictions.csv"}\NormalTok{)}
\NormalTok{fold\_assign }\OtherTok{\textless{}{-}} \FunctionTok{rep}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{, }\FunctionTok{ceiling}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(holdout\_pred) }\SpecialCharTok{/} \DecValTok{10}\NormalTok{))[}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(holdout\_pred)]}
\NormalTok{data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
\CommentTok{\# Deep learning grid models}
\NormalTok{data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign,}
  \AttributeTok{grid\_name =} \StringTok{"Neural network grid model"}\NormalTok{,}
  \AttributeTok{grid\_meta =}\NormalTok{ dl\_grid}
\NormalTok{))}
\CommentTok{\# GBM grid models}
\NormalTok{data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign,}
  \AttributeTok{grid\_name =} \StringTok{"GBM grid model"}\NormalTok{,}
  \AttributeTok{grid\_meta =}\NormalTok{ gbm\_grid}
\NormalTok{))}
\CommentTok{\# GBM default models}
\NormalTok{data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign,}
  \AttributeTok{grid\_name =} \StringTok{"GBM model"}\NormalTok{,}
  \AttributeTok{grid\_meta =} \FunctionTok{as.list}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"GBM\_"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{5}\NormalTok{))}
\NormalTok{))}
\CommentTok{\# XGBoost grid models}
\NormalTok{data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign,}
  \AttributeTok{grid\_name =} \StringTok{"XGBoost grid model"}\NormalTok{,}
  \AttributeTok{grid\_meta =}\NormalTok{ xgboost\_grid}
\NormalTok{))}
\CommentTok{\# XGBoost default models}
\NormalTok{data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign,}
  \AttributeTok{grid\_name =} \StringTok{"XGBoost model"}\NormalTok{,}
  \AttributeTok{grid\_meta =} \FunctionTok{as.list}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"XGBoost\_"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{))}
\NormalTok{))}
\CommentTok{\# GLM}
\NormalTok{data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign, }\AttributeTok{grid\_name =} \StringTok{"GLM model"}\NormalTok{, }\AttributeTok{grid\_meta =} \FunctionTok{list}\NormalTok{(}\StringTok{"GLM"}\NormalTok{)))}
\CommentTok{\# DRF}
\NormalTok{data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign, }\AttributeTok{grid\_name =} \StringTok{"DRF model"}\NormalTok{, }\AttributeTok{grid\_meta =} \FunctionTok{list}\NormalTok{(}\StringTok{"DRF"}\NormalTok{)))}
\CommentTok{\# XRT}
\NormalTok{data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign, }\AttributeTok{grid\_name =} \StringTok{"XRT model"}\NormalTok{, }\AttributeTok{grid\_meta =} \FunctionTok{list}\NormalTok{(}\StringTok{"XRT"}\NormalTok{)))}
\CommentTok{\# Super learner all}
\NormalTok{data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign, }\AttributeTok{grid\_name =} \StringTok{"Super learner all models"}\NormalTok{))}
\CommentTok{\# Super learner final}
\NormalTok{data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign, }\AttributeTok{grid\_name =} \StringTok{"Super learner final"}\NormalTok{))}
\CommentTok{\# Super learner deep learning}
\NormalTok{data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign, }\AttributeTok{grid\_name =} \StringTok{"Super learner neural network"}\NormalTok{))}
\CommentTok{\# Super learner GBM}
\NormalTok{data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign, }\AttributeTok{grid\_name =} \StringTok{"Super learner GBM"}\NormalTok{))}
\CommentTok{\# Super learner XGBoost}
\NormalTok{data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign, }\AttributeTok{grid\_name =} \StringTok{"Super learner XGBoost"}\NormalTok{))}

\NormalTok{data }\OtherTok{\textless{}{-}} \FunctionTok{do.call}\NormalTok{(rbind, data\_)}
\FunctionTok{write.csv}\NormalTok{(data, }\StringTok{"./other\_data/toxicity/whole\_data\_set/cv\_res.csv"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\StringTok{"./other\_data/toxicity/whole\_data\_set/cv\_res.csv"}\NormalTok{, }\AttributeTok{row.names =} \DecValTok{1}\NormalTok{, }\AttributeTok{check.names =} \ConstantTok{FALSE}\NormalTok{)}
\FunctionTok{statistical\_testing}\NormalTok{(data,}
  \AttributeTok{metric\_vec =} \FunctionTok{c}\NormalTok{(}\StringTok{"Log loss"}\NormalTok{, }\StringTok{"MCC"}\NormalTok{, }\StringTok{"F\_1"}\NormalTok{, }\StringTok{"Balanced accuracy"}\NormalTok{),}
  \AttributeTok{decreasing\_vec =} \FunctionTok{c}\NormalTok{(}\ConstantTok{FALSE}\NormalTok{, }\ConstantTok{TRUE}\NormalTok{, }\ConstantTok{TRUE}\NormalTok{, }\ConstantTok{TRUE}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{03_model_training_files/figure-latex/unnamed-chunk-73-1.pdf}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# statistical\_testing(data, metric\_vec=c(\textquotesingle{}Log loss\textquotesingle{}, \textquotesingle{}MCC\textquotesingle{}, \textquotesingle{}F\_1\textquotesingle{}, \textquotesingle{}Balanced accuracy\textquotesingle{}),}
\CommentTok{\#                     decreasing\_vec=c(FALSE, TRUE, TRUE, TRUE),}
\CommentTok{\#                     output\_path=\textquotesingle{}./other\_data/toxicity/whole\_data\_set/cv\_res\_statistical\_testing.csv\textquotesingle{})}
\end{Highlighting}
\end{Shaded}

\hypertarget{final-reduced-sl-2}{%
\subsection{Final reduced SL}\label{final-reduced-sl-2}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{h2o.init}\NormalTok{(}\AttributeTok{nthreads =} \SpecialCharTok{{-}}\DecValTok{1}\NormalTok{)}
\NormalTok{model\_path }\OtherTok{\textless{}{-}} \StringTok{"/Users/renee/Downloads/toxicity/whole\_data\_set/superlearner\_iter\_3"}
\NormalTok{model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(model\_path)}
\FunctionTok{load}\NormalTok{(}\AttributeTok{file =} \StringTok{"./rdata/model\_training\_grid\_models\_tx.RData"}\NormalTok{)}
\NormalTok{data }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\StringTok{"./other\_data/toxicity/whole\_data\_set/cv\_res.csv"}\NormalTok{, }\AttributeTok{row.names =} \DecValTok{1}\NormalTok{, }\AttributeTok{check.names =} \ConstantTok{FALSE}\NormalTok{)}
\NormalTok{df }\OtherTok{\textless{}{-}} \FunctionTok{as.data.frame}\NormalTok{(model}\SpecialCharTok{@}\NormalTok{model}\SpecialCharTok{$}\NormalTok{metalearner\_model}\SpecialCharTok{@}\NormalTok{model}\SpecialCharTok{$}\NormalTok{coefficients\_table)[}\FunctionTok{c}\NormalTok{(}\StringTok{"names"}\NormalTok{, }\StringTok{"standardized\_coefficients"}\NormalTok{)][}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{, ]}

\ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(df)) \{}
\NormalTok{  name }\OtherTok{\textless{}{-}}\NormalTok{ df}\SpecialCharTok{$}\NormalTok{names[i]}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{startsWith}\NormalTok{(name, }\StringTok{"DeepLearning\_model"}\NormalTok{)) \{}
    \ControlFlowTok{for}\NormalTok{ (j }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(dl\_grid)) \{}
      \ControlFlowTok{if}\NormalTok{ (name }\SpecialCharTok{\%in\%}\NormalTok{ dl\_grid[[j]]) }\ControlFlowTok{break}
\NormalTok{    \}}
\NormalTok{    df}\SpecialCharTok{$}\NormalTok{names[i] }\OtherTok{\textless{}{-}} \FunctionTok{paste}\NormalTok{(}\StringTok{"Neural network grid model"}\NormalTok{, j)}
\NormalTok{  \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{startsWith}\NormalTok{(name, }\StringTok{"GBM\_model"}\NormalTok{)) \{}
    \ControlFlowTok{for}\NormalTok{ (j }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(gbm\_grid)) \{}
      \ControlFlowTok{if}\NormalTok{ (name }\SpecialCharTok{\%in\%}\NormalTok{ gbm\_grid[[j]]) }\ControlFlowTok{break}
\NormalTok{    \}}
\NormalTok{    df}\SpecialCharTok{$}\NormalTok{names[i] }\OtherTok{\textless{}{-}} \FunctionTok{paste}\NormalTok{(}\StringTok{"GBM grid model"}\NormalTok{, j)}
\NormalTok{  \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{startsWith}\NormalTok{(name, }\StringTok{"XGBoost\_model"}\NormalTok{)) \{}
    \ControlFlowTok{for}\NormalTok{ (j }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(xgboost\_grid)) \{}
      \ControlFlowTok{if}\NormalTok{ (name }\SpecialCharTok{\%in\%}\NormalTok{ xgboost\_grid[[j]]) }\ControlFlowTok{break}
\NormalTok{    \}}
\NormalTok{    df}\SpecialCharTok{$}\NormalTok{names[i] }\OtherTok{\textless{}{-}} \FunctionTok{paste}\NormalTok{(}\StringTok{"XGBoost grid model"}\NormalTok{, j)}
\NormalTok{  \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{    df}\SpecialCharTok{$}\NormalTok{names[i] }\OtherTok{\textless{}{-}} \FunctionTok{paste}\NormalTok{(}\FunctionTok{strsplit}\NormalTok{(name, }\StringTok{"\_"}\NormalTok{)[[}\DecValTok{1}\NormalTok{]], }\AttributeTok{collapse =} \StringTok{" model "}\NormalTok{)}
\NormalTok{  \}}
\NormalTok{\}}

\FunctionTok{rownames}\NormalTok{(df) }\OtherTok{\textless{}{-}}\NormalTok{ df}\SpecialCharTok{$}\NormalTok{names}
\NormalTok{df }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(df, data[}\StringTok{"Balanced accuracy mean"}\NormalTok{], }\AttributeTok{by =} \StringTok{"row.names"}\NormalTok{)[, }\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{]}
\NormalTok{df }\OtherTok{\textless{}{-}}\NormalTok{ df[df}\SpecialCharTok{$}\NormalTok{standardized\_coefficients }\SpecialCharTok{\textgreater{}} \DecValTok{0}\NormalTok{, ]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{p3 }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(df, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =} \FunctionTok{reorder}\NormalTok{(names, standardized\_coefficients), }\AttributeTok{y =}\NormalTok{ standardized\_coefficients, }\AttributeTok{fill =} \StringTok{\textasciigrave{}}\AttributeTok{Balanced accuracy mean}\StringTok{\textasciigrave{}}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{geom\_col}\NormalTok{(}\AttributeTok{color =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \FloatTok{0.2}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_fill\_gradient}\NormalTok{(}\AttributeTok{low =} \StringTok{"white"}\NormalTok{, }\AttributeTok{high =} \StringTok{"red"}\NormalTok{, }\AttributeTok{n.breaks =} \DecValTok{4}\NormalTok{, }\AttributeTok{limits =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.85}\NormalTok{, }\FloatTok{1.00}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{geom\_text}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{label =} \FunctionTok{sprintf}\NormalTok{(}\StringTok{"\%.2f"}\NormalTok{, }\StringTok{\textasciigrave{}}\AttributeTok{Balanced accuracy mean}\StringTok{\textasciigrave{}}\NormalTok{)), }\AttributeTok{nudge\_y =} \SpecialCharTok{{-}}\FloatTok{0.008}\NormalTok{, }\AttributeTok{size =} \DecValTok{3}\NormalTok{, }\AttributeTok{color =} \StringTok{"white"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_text}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{label =} \FunctionTok{sprintf}\NormalTok{(}\StringTok{"\%.3f"}\NormalTok{, standardized\_coefficients)), }\AttributeTok{nudge\_y =} \FloatTok{0.01}\NormalTok{, }\AttributeTok{size =} \DecValTok{3}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{coord\_flip}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{scale\_y\_continuous}\NormalTok{(}\AttributeTok{limits =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FunctionTok{max}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{standardized\_coefficients) }\SpecialCharTok{+} \FloatTok{0.02}\NormalTok{), }\AttributeTok{expand =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.01}\NormalTok{, }\DecValTok{0}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{theme\_bw}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}
    \AttributeTok{panel.grid.major =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{panel.grid.minor =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{strip.background =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{panel.border =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{axis.line =} \FunctionTok{element\_line}\NormalTok{(}\AttributeTok{color =} \StringTok{"black"}\NormalTok{),}
    \AttributeTok{legend.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{10}\NormalTok{),}
    \AttributeTok{plot.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{hjust =} \FloatTok{0.5}\NormalTok{, }\AttributeTok{size =} \DecValTok{18}\NormalTok{),}
    \AttributeTok{plot.margin =}\NormalTok{ ggplot2}\SpecialCharTok{::}\FunctionTok{margin}\NormalTok{(}\DecValTok{10}\NormalTok{, }\DecValTok{10}\NormalTok{, }\DecValTok{10}\NormalTok{, }\DecValTok{0}\NormalTok{, }\StringTok{"pt"}\NormalTok{),}
    \AttributeTok{axis.title.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{18}\NormalTok{),}
    \AttributeTok{axis.title.y =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{18}\NormalTok{),}
    \AttributeTok{axis.text.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{12}\NormalTok{),}
    \AttributeTok{axis.text.y =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{12}\NormalTok{),}
    \AttributeTok{legend.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{14}\NormalTok{),}
    \AttributeTok{legend.position =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.85}\NormalTok{, }\FloatTok{0.35}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{guides}\NormalTok{(}\AttributeTok{fill =} \FunctionTok{guide\_colorbar}\NormalTok{(}\AttributeTok{title =} \StringTok{"Balanced accuracy"}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{xlab}\NormalTok{(}\StringTok{""}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{ylab}\NormalTok{(}\StringTok{"Coefficient"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{ggtitle}\NormalTok{(}\StringTok{"Non{-}toxic"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics[width=1\linewidth]{./figures/Supplementary Fig 4 tx super learner} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Close h2o server}
\CommentTok{\# h2o.shutdown()}
\FunctionTok{sessionInfo}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## R version 4.2.2 (2022-10-31)
## Platform: x86_64-apple-darwin17.0 (64-bit)
## Running under: macOS Big Sur ... 10.16
## 
## Matrix products: default
## BLAS:   /Library/Frameworks/R.framework/Versions/4.2/Resources/lib/libRblas.0.dylib
## LAPACK: /Library/Frameworks/R.framework/Versions/4.2/Resources/lib/libRlapack.dylib
## 
## locale:
## [1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8
## 
## attached base packages:
## [1] stats     graphics  grDevices utils     datasets  methods   base     
## 
## other attached packages:
##  [1] reshape2_1.4.4  DT_0.24         digest_0.6.29   stringr_1.4.1  
##  [5] rlist_0.4.6.2   enrichvs_0.0.5  scales_1.2.1    mltools_0.3.5  
##  [9] MLmetrics_1.1.1 h2o_3.38.0.2   
## 
## loaded via a namespace (and not attached):
##  [1] styler_1.8.0      xfun_0.32         bslib_0.4.0       purrr_0.3.4      
##  [5] lattice_0.20-45   colorspace_2.0-3  vctrs_0.4.1       htmltools_0.5.3  
##  [9] yaml_2.3.5        rlang_1.0.4       R.oo_1.25.0       jquerylib_0.1.4  
## [13] R.utils_2.12.0    R.cache_0.16.0    lifecycle_1.0.1   plyr_1.8.7       
## [17] munsell_0.5.0     R.methodsS3_1.8.2 htmlwidgets_1.5.4 codetools_0.2-18 
## [21] evaluate_0.16     knitr_1.40        callr_3.7.2       fastmap_1.1.0    
## [25] ps_1.7.1          crosstalk_1.2.0   highr_0.9         Rcpp_1.0.9       
## [29] cachem_1.0.6      webshot_0.5.4     jsonlite_1.8.0    stringi_1.7.8    
## [33] bookdown_0.28     processx_3.7.0    grid_4.2.2        cli_3.3.0        
## [37] tools_4.2.2       bitops_1.0-7      magrittr_2.0.3    sass_0.4.2       
## [41] RCurl_1.98-1.8    Matrix_1.5-1      data.table_1.14.2 rmarkdown_2.16   
## [45] rstudioapi_0.14   R6_2.5.1          compiler_4.2.2
\end{verbatim}

\hypertarget{04_model_validation_and_interpretation}{%
\chapter{Model validation and interpretation}\label{04_model_validation_and_interpretation}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(h2o)}
\FunctionTok{library}\NormalTok{(ggplot2)}
\FunctionTok{library}\NormalTok{(ggpubr)}
\FunctionTok{library}\NormalTok{(ggbeeswarm)}
\FunctionTok{library}\NormalTok{(reticulate)}
\FunctionTok{use\_condaenv}\NormalTok{(}\StringTok{"/Users/renee/Library/r{-}miniconda/envs/peptide\_engineering/bin/python"}\NormalTok{)}
\FunctionTok{library}\NormalTok{(reshape2)}
\FunctionTok{library}\NormalTok{(scales)}
\FunctionTok{library}\NormalTok{(ggforce)}
\FunctionTok{library}\NormalTok{(cowplot)}
\FunctionTok{library}\NormalTok{(plotly)}
\FunctionTok{library}\NormalTok{(ggrepel)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ h2o}
\ImportTok{import}\NormalTok{ pandas }\ImportTok{as}\NormalTok{ pd}
\ImportTok{import}\NormalTok{ numpy }\ImportTok{as}\NormalTok{ np}
\ImportTok{import}\NormalTok{ shap}
\ImportTok{import}\NormalTok{ matplotlib.pyplot }\ImportTok{as}\NormalTok{ plt}
\ImportTok{import}\NormalTok{ session\_info}
\end{Highlighting}
\end{Shaded}

\hypertarget{model-validation}{%
\section{Model validation}\label{model-validation}}

\hypertarget{melaning-binding}{%
\subsection{Melaning binding}\label{melaning-binding}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# ================}
\CommentTok{\# predicted values}
\CommentTok{\# ================}
\NormalTok{mb\_pred\_ }\OtherTok{\textless{}{-}} \FunctionTok{matrix}\NormalTok{(}
  \FunctionTok{c}\NormalTok{(}
    \SpecialCharTok{{-}}\FloatTok{0.0202}\NormalTok{, }\FloatTok{1.3650}\NormalTok{, }\FloatTok{2.1745}\NormalTok{, }\FloatTok{2.3456}\NormalTok{, }\FloatTok{2.5907}\NormalTok{, }\FloatTok{2.6903}\NormalTok{, }\FloatTok{2.9842}\NormalTok{, }\FloatTok{3.1325}\NormalTok{, }\FloatTok{3.5015}\NormalTok{, }\FloatTok{3.6640}\NormalTok{, }\FloatTok{3.7181}\NormalTok{, }\FloatTok{4.0701}\NormalTok{,}
    \FloatTok{0.3223}\NormalTok{, }\FloatTok{1.5153}\NormalTok{, }\FloatTok{2.1196}\NormalTok{, }\FloatTok{2.4047}\NormalTok{, }\FloatTok{2.5032}\NormalTok{, }\FloatTok{2.8177}\NormalTok{, }\FloatTok{3.0653}\NormalTok{, }\FloatTok{3.1491}\NormalTok{, }\FloatTok{3.5578}\NormalTok{, }\FloatTok{3.6465}\NormalTok{, }\FloatTok{3.5599}\NormalTok{, }\FloatTok{3.9509}\NormalTok{,}
    \FloatTok{0.6579}\NormalTok{, }\FloatTok{2.1797}\NormalTok{, }\FloatTok{1.9685}\NormalTok{, }\FloatTok{2.3709}\NormalTok{, }\FloatTok{2.6702}\NormalTok{, }\FloatTok{3.0694}\NormalTok{, }\FloatTok{2.9323}\NormalTok{, }\FloatTok{3.3150}\NormalTok{, }\FloatTok{3.4798}\NormalTok{, }\FloatTok{3.5661}\NormalTok{, }\FloatTok{3.6981}\NormalTok{, }\FloatTok{3.9730}\NormalTok{,}
    \SpecialCharTok{{-}}\FloatTok{0.0589}\NormalTok{, }\FloatTok{1.3490}\NormalTok{, }\FloatTok{2.4402}\NormalTok{, }\FloatTok{2.1269}\NormalTok{, }\FloatTok{2.5097}\NormalTok{, }\FloatTok{2.6128}\NormalTok{, }\FloatTok{2.9359}\NormalTok{, }\FloatTok{3.3530}\NormalTok{, }\FloatTok{3.8094}\NormalTok{, }\FloatTok{3.5260}\NormalTok{, }\FloatTok{3.7525}\NormalTok{, }\FloatTok{3.8405}\NormalTok{,}
    \FloatTok{0.6532}\NormalTok{, }\FloatTok{1.3684}\NormalTok{, }\FloatTok{2.6170}\NormalTok{, }\FloatTok{2.5270}\NormalTok{, }\FloatTok{2.5228}\NormalTok{, }\FloatTok{2.9967}\NormalTok{, }\FloatTok{3.1125}\NormalTok{, }\FloatTok{3.2106}\NormalTok{, }\FloatTok{3.5952}\NormalTok{, }\FloatTok{3.7345}\NormalTok{, }\FloatTok{3.7353}\NormalTok{, }\FloatTok{3.8400}\NormalTok{,}
    \FloatTok{0.2941}\NormalTok{, }\FloatTok{1.1896}\NormalTok{, }\FloatTok{2.1987}\NormalTok{, }\FloatTok{2.7585}\NormalTok{, }\FloatTok{3.1348}\NormalTok{, }\FloatTok{2.9791}\NormalTok{, }\FloatTok{3.2625}\NormalTok{, }\FloatTok{3.0559}\NormalTok{, }\FloatTok{3.5153}\NormalTok{, }\FloatTok{3.6829}\NormalTok{, }\FloatTok{3.9875}\NormalTok{, }\FloatTok{4.0330}\NormalTok{,}
    \FloatTok{0.0156}\NormalTok{, }\FloatTok{1.1113}\NormalTok{, }\FloatTok{1.9551}\NormalTok{, }\FloatTok{2.3677}\NormalTok{, }\FloatTok{2.4250}\NormalTok{, }\FloatTok{4.0111}\NormalTok{, }\FloatTok{3.4891}\NormalTok{, }\FloatTok{3.6521}\NormalTok{, }\FloatTok{3.6634}\NormalTok{, }\FloatTok{3.2731}\NormalTok{, }\FloatTok{3.4504}\NormalTok{, }\FloatTok{3.7587}\NormalTok{,}
    \FloatTok{0.0209}\NormalTok{, }\FloatTok{1.9146}\NormalTok{, }\FloatTok{2.2865}\NormalTok{, }\FloatTok{2.5308}\NormalTok{, }\FloatTok{2.7193}\NormalTok{, }\FloatTok{3.0322}\NormalTok{, }\FloatTok{3.1020}\NormalTok{, }\FloatTok{3.3582}\NormalTok{, }\FloatTok{3.2993}\NormalTok{, }\FloatTok{3.8534}\NormalTok{, }\FloatTok{4.9542}\NormalTok{, }\FloatTok{3.5464}
\NormalTok{  ),}
  \AttributeTok{nrow =} \DecValTok{8}\NormalTok{, }\AttributeTok{byrow =} \ConstantTok{TRUE}
\NormalTok{)}

\NormalTok{new\_mb\_pred\_ }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}
  \FloatTok{3.9318}\NormalTok{, }\FloatTok{3.9366}\NormalTok{, }\FloatTok{3.5531}\NormalTok{, }\FloatTok{3.4385}\NormalTok{, }\FloatTok{3.8434}\NormalTok{, }\FloatTok{3.3893}\NormalTok{, }\FloatTok{4.4159}\NormalTok{, }\FloatTok{4.7549}\NormalTok{, }\FloatTok{4.0004}\NormalTok{, }\FloatTok{3.2785}\NormalTok{,}
  \FloatTok{4.5784}\NormalTok{, }\FloatTok{4.6026}\NormalTok{, }\FloatTok{3.6229}\NormalTok{, }\FloatTok{3.8261}\NormalTok{, }\FloatTok{3.6111}\NormalTok{, }\FloatTok{5.0536}\NormalTok{, }\FloatTok{4.8169}\NormalTok{, }\FloatTok{5.9021}\NormalTok{, }\FloatTok{4.0992}\NormalTok{, }\FloatTok{4.3451}\NormalTok{,}
  \FloatTok{5.9626}\NormalTok{, }\FloatTok{4.2730}\NormalTok{, }\FloatTok{4.4115}\NormalTok{, }\FloatTok{4.8889}\NormalTok{, }\FloatTok{4.3264}\NormalTok{, }\FloatTok{4.4830}\NormalTok{, }\FloatTok{4.2847}\NormalTok{, }\FloatTok{4.6585}\NormalTok{, }\FloatTok{4.4568}\NormalTok{, }\FloatTok{4.8513}\NormalTok{,}
  \FloatTok{4.1523}
\NormalTok{)}

\NormalTok{mb\_pred }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\FunctionTok{as.vector}\NormalTok{(mb\_pred\_), new\_mb\_pred\_)}
\ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{127}\NormalTok{) \{}
  \ControlFlowTok{if}\NormalTok{ (mb\_pred[i] }\SpecialCharTok{\textless{}} \DecValTok{0}\NormalTok{) mb\_pred[i] }\OtherTok{\textless{}{-}} \ConstantTok{NA}
\NormalTok{\}}
\CommentTok{\# Re{-}scale to 0{-}100}
\FunctionTok{load}\NormalTok{(}\AttributeTok{file =} \StringTok{"./rdata/var\_reduct\_mb\_train\_test\_splits.RData"}\NormalTok{)}
\NormalTok{mb\_pred }\OtherTok{\textless{}{-}} \FunctionTok{rescale}\NormalTok{(mb\_pred, }\AttributeTok{to =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{100}\NormalTok{), }\AttributeTok{from =} \FunctionTok{range}\NormalTok{(mb\_data}\SpecialCharTok{$}\NormalTok{log\_intensity))}
\NormalTok{mb\_pred[mb\_pred }\SpecialCharTok{\textgreater{}} \DecValTok{100}\NormalTok{] }\OtherTok{\textless{}{-}} \DecValTok{100}

\CommentTok{\# ===================}
\CommentTok{\# Experimental values}
\CommentTok{\# ===================}
\NormalTok{replicate\_1\_1 }\OtherTok{\textless{}{-}} \FunctionTok{matrix}\NormalTok{(}
  \FunctionTok{c}\NormalTok{(}
    \FloatTok{0.9775}\NormalTok{, }\FloatTok{50.1718}\NormalTok{, }\FloatTok{39.9822}\NormalTok{, }\FloatTok{66.0486}\NormalTok{, }\FloatTok{46.0249}\NormalTok{, }\FloatTok{40.8353}\NormalTok{, }\FloatTok{58.6552}\NormalTok{, }\FloatTok{72.8258}\NormalTok{, }\FloatTok{55.1955}\NormalTok{, }\FloatTok{59.8874}\NormalTok{, }\FloatTok{78.4182}\NormalTok{, }\FloatTok{77.8258}\NormalTok{,}
    \SpecialCharTok{{-}}\FloatTok{3.6197}\NormalTok{, }\FloatTok{25.3377}\NormalTok{, }\FloatTok{56.6884}\NormalTok{, }\FloatTok{58.1339}\NormalTok{, }\SpecialCharTok{{-}}\FloatTok{0.8945}\NormalTok{, }\FloatTok{26.5936}\NormalTok{, }\FloatTok{64.4609}\NormalTok{, }\FloatTok{63.2050}\NormalTok{, }\FloatTok{68.3472}\NormalTok{, }\FloatTok{71.3566}\NormalTok{, }\FloatTok{80.4325}\NormalTok{, }\FloatTok{70.3140}\NormalTok{,}
    \SpecialCharTok{{-}}\FloatTok{34.7571}\NormalTok{, }\FloatTok{26.0249}\NormalTok{, }\FloatTok{52.3519}\NormalTok{, }\FloatTok{70.4562}\NormalTok{, }\FloatTok{63.1813}\NormalTok{, }\FloatTok{69.1291}\NormalTok{, }\FloatTok{73.1339}\NormalTok{, }\FloatTok{65.6220}\NormalTok{, }\FloatTok{73.9396}\NormalTok{, }\FloatTok{76.5699}\NormalTok{, }\FloatTok{75.1955}\NormalTok{, }\FloatTok{76.0249}\NormalTok{,}
    \SpecialCharTok{{-}}\FloatTok{1.3922}\NormalTok{, }\FloatTok{35.4325}\NormalTok{, }\FloatTok{4.0344}\NormalTok{, }\FloatTok{16.4514}\NormalTok{, }\FloatTok{28.4656}\NormalTok{, }\FloatTok{38.9870}\NormalTok{, }\FloatTok{71.5699}\NormalTok{, }\FloatTok{66.8306}\NormalTok{, }\FloatTok{71.0723}\NormalTok{, }\FloatTok{45.0059}\NormalTok{, }\FloatTok{83.4182}\NormalTok{, }\FloatTok{75.9301}\NormalTok{,}
    \SpecialCharTok{{-}}\FloatTok{6.0604}\NormalTok{, }\FloatTok{19.9111}\NormalTok{, }\FloatTok{20.2666}\NormalTok{, }\FloatTok{39.2476}\NormalTok{, }\FloatTok{36.3329}\NormalTok{, }\FloatTok{70.1955}\NormalTok{, }\FloatTok{73.9633}\NormalTok{, }\FloatTok{72.4467}\NormalTok{, }\FloatTok{75.5746}\NormalTok{, }\FloatTok{59.9348}\NormalTok{, }\FloatTok{55.4799}\NormalTok{, }\FloatTok{75.8590}\NormalTok{,}
    \FloatTok{1.9727}\NormalTok{, }\FloatTok{28.0628}\NormalTok{, }\SpecialCharTok{{-}}\FloatTok{29.7097}\NormalTok{, }\FloatTok{35.4562}\NormalTok{, }\FloatTok{58.8211}\NormalTok{, }\FloatTok{49.7927}\NormalTok{, }\FloatTok{61.7121}\NormalTok{, }\FloatTok{77.8732}\NormalTok{, }\FloatTok{77.2097}\NormalTok{, }\FloatTok{77.2571}\NormalTok{, }\FloatTok{54.8874}\NormalTok{, }\FloatTok{76.0249}\NormalTok{,}
    \SpecialCharTok{{-}}\FloatTok{23.3353}\NormalTok{, }\FloatTok{33.2998}\NormalTok{, }\FloatTok{45.9064}\NormalTok{, }\FloatTok{36.1671}\NormalTok{, }\FloatTok{36.4751}\NormalTok{, }\FloatTok{74.5557}\NormalTok{, }\FloatTok{70.6220}\NormalTok{, }\FloatTok{48.2998}\NormalTok{, }\FloatTok{69.6742}\NormalTok{, }\FloatTok{76.9727}\NormalTok{, }\FloatTok{65.1244}\NormalTok{, }\FloatTok{75.9064}\NormalTok{,}
    \FloatTok{2.2571}\NormalTok{, }\FloatTok{27.1860}\NormalTok{, }\SpecialCharTok{{-}}\FloatTok{1.6055}\NormalTok{, }\FloatTok{42.3519}\NormalTok{, }\FloatTok{48.7500}\NormalTok{, }\FloatTok{47.8969}\NormalTok{, }\FloatTok{62.2334}\NormalTok{, }\FloatTok{70.6220}\NormalTok{, }\FloatTok{79.7927}\NormalTok{, }\FloatTok{75.9538}\NormalTok{, }\FloatTok{77.4467}\NormalTok{, }\FloatTok{81.0960}
\NormalTok{  ),}
  \AttributeTok{nrow =} \DecValTok{8}\NormalTok{, }\AttributeTok{byrow =} \ConstantTok{TRUE}
\NormalTok{)}

\NormalTok{replicate\_1\_2 }\OtherTok{\textless{}{-}} \FunctionTok{matrix}\NormalTok{(}
  \FunctionTok{c}\NormalTok{(}
    \SpecialCharTok{{-}}\FloatTok{7.7192}\NormalTok{, }\FloatTok{54.0818}\NormalTok{, }\FloatTok{45.1007}\NormalTok{, }\FloatTok{62.8495}\NormalTok{, }\FloatTok{50.1481}\NormalTok{, }\FloatTok{37.6126}\NormalTok{, }\FloatTok{59.5083}\NormalTok{, }\FloatTok{71.7121}\NormalTok{, }\FloatTok{57.7073}\NormalTok{, }\FloatTok{59.4135}\NormalTok{, }\FloatTok{77.0201}\NormalTok{, }\FloatTok{82.3756}\NormalTok{,}
    \FloatTok{21.4277}\NormalTok{, }\FloatTok{10.8353}\NormalTok{, }\FloatTok{54.6268}\NormalTok{, }\FloatTok{65.7168}\NormalTok{, }\FloatTok{15.6220}\NormalTok{, }\FloatTok{35.1007}\NormalTok{, }\FloatTok{64.8637}\NormalTok{, }\FloatTok{67.8258}\NormalTok{, }\FloatTok{66.5225}\NormalTok{, }\FloatTok{72.7073}\NormalTok{, }\FloatTok{83.1576}\NormalTok{, }\FloatTok{72.7784}\NormalTok{,}
    \SpecialCharTok{{-}}\FloatTok{53.7855}\NormalTok{, }\FloatTok{2.6600}\NormalTok{, }\FloatTok{42.8732}\NormalTok{, }\FloatTok{32.9443}\NormalTok{, }\FloatTok{48.1576}\NormalTok{, }\FloatTok{71.0960}\NormalTok{, }\FloatTok{73.4656}\NormalTok{, }\FloatTok{66.9964}\NormalTok{, }\FloatTok{72.1386}\NormalTok{, }\FloatTok{78.6789}\NormalTok{, }\FloatTok{78.7500}\NormalTok{, }\FloatTok{77.1386}\NormalTok{,}
    \FloatTok{34.9822}\NormalTok{, }\FloatTok{37.1623}\NormalTok{, }\FloatTok{25.8590}\NormalTok{, }\FloatTok{34.7453}\NormalTok{, }\FloatTok{36.9964}\NormalTok{, }\FloatTok{54.2239}\NormalTok{, }\FloatTok{72.8969}\NormalTok{, }\FloatTok{67.5415}\NormalTok{, }\FloatTok{73.5604}\NormalTok{, }\FloatTok{52.8021}\NormalTok{, }\FloatTok{88.1339}\NormalTok{, }\FloatTok{80.0296}\NormalTok{,}
    \FloatTok{1.1434}\NormalTok{, }\FloatTok{30.6694}\NormalTok{, }\FloatTok{32.8969}\NormalTok{, }\FloatTok{45.5983}\NormalTok{, }\FloatTok{48.6552}\NormalTok{, }\FloatTok{70.5036}\NormalTok{, }\FloatTok{74.7927}\NormalTok{, }\FloatTok{76.0249}\NormalTok{, }\FloatTok{75.5983}\NormalTok{, }\FloatTok{62.6600}\NormalTok{, }\FloatTok{61.3803}\NormalTok{, }\FloatTok{81.4277}\NormalTok{,}
    \FloatTok{27.4467}\NormalTok{, }\FloatTok{30.3614}\NormalTok{, }\FloatTok{24.8164}\NormalTok{, }\FloatTok{25.8116}\NormalTok{, }\FloatTok{63.9633}\NormalTok{, }\FloatTok{49.7927}\NormalTok{, }\FloatTok{60.6457}\NormalTok{, }\FloatTok{79.8637}\NormalTok{, }\FloatTok{77.3282}\NormalTok{, }\FloatTok{79.8164}\NormalTok{, }\FloatTok{55.0770}\NormalTok{, }\FloatTok{77.1386}\NormalTok{,}
    \FloatTok{7.9206}\NormalTok{, }\FloatTok{44.0107}\NormalTok{, }\FloatTok{57.2571}\NormalTok{, }\FloatTok{50.1955}\NormalTok{, }\FloatTok{45.6220}\NormalTok{, }\FloatTok{76.2618}\NormalTok{, }\FloatTok{71.7358}\NormalTok{, }\FloatTok{51.6410}\NormalTok{, }\FloatTok{72.9680}\NormalTok{, }\FloatTok{76.6410}\NormalTok{, }\FloatTok{64.1291}\NormalTok{, }\FloatTok{76.5225}\NormalTok{,}
    \SpecialCharTok{{-}}\FloatTok{3.7618}\NormalTok{, }\FloatTok{32.5178}\NormalTok{, }\FloatTok{28.9159}\NormalTok{, }\FloatTok{47.3756}\NormalTok{, }\FloatTok{50.5983}\NormalTok{, }\FloatTok{49.4609}\NormalTok{, }\FloatTok{62.7547}\NormalTok{, }\FloatTok{71.7358}\NormalTok{, }\FloatTok{83.3709}\NormalTok{, }\FloatTok{81.7832}\NormalTok{, }\FloatTok{83.3235}\NormalTok{, }\FloatTok{82.9917}
\NormalTok{  ),}
  \AttributeTok{nrow =} \DecValTok{8}\NormalTok{, }\AttributeTok{byrow =} \ConstantTok{TRUE}
\NormalTok{)}

\NormalTok{replicate\_2\_1 }\OtherTok{\textless{}{-}} \FunctionTok{matrix}\NormalTok{(}
  \FunctionTok{c}\NormalTok{(}
    \SpecialCharTok{{-}}\FloatTok{21.6291}\NormalTok{, }\FloatTok{12.7784}\NormalTok{, }\FloatTok{51.7595}\NormalTok{, }\FloatTok{30.0770}\NormalTok{, }\FloatTok{33.6078}\NormalTok{, }\FloatTok{28.2524}\NormalTok{, }\FloatTok{47.4467}\NormalTok{, }\FloatTok{51.8780}\NormalTok{, }\FloatTok{45.4088}\NormalTok{, }\FloatTok{64.9585}\NormalTok{, }\FloatTok{64.9585}\NormalTok{, }\FloatTok{69.3187}\NormalTok{,}
    \FloatTok{24.2476}\NormalTok{, }\FloatTok{7.0675}\NormalTok{, }\FloatTok{56.8780}\NormalTok{, }\FloatTok{71.7595}\NormalTok{, }\FloatTok{25.8116}\NormalTok{, }\FloatTok{40.1481}\NormalTok{, }\FloatTok{69.2476}\NormalTok{, }\FloatTok{71.3803}\NormalTok{, }\FloatTok{74.9585}\NormalTok{, }\FloatTok{73.1813}\NormalTok{, }\FloatTok{81.8069}\NormalTok{, }\FloatTok{74.8400}\NormalTok{,}
    \FloatTok{44.5557}\NormalTok{, }\FloatTok{31.2618}\NormalTok{, }\FloatTok{43.6552}\NormalTok{, }\FloatTok{39.0818}\NormalTok{, }\FloatTok{48.3235}\NormalTok{, }\FloatTok{67.8495}\NormalTok{, }\FloatTok{76.2855}\NormalTok{, }\FloatTok{64.5557}\NormalTok{, }\FloatTok{74.5083}\NormalTok{, }\FloatTok{76.0723}\NormalTok{, }\FloatTok{75.4799}\NormalTok{, }\FloatTok{75.5746}\NormalTok{,}
    \FloatTok{17.3045}\NormalTok{, }\FloatTok{45.8590}\NormalTok{, }\SpecialCharTok{{-}}\FloatTok{7.5533}\NormalTok{, }\FloatTok{34.7690}\NormalTok{, }\FloatTok{28.3945}\NormalTok{, }\FloatTok{41.9491}\NormalTok{, }\FloatTok{73.3709}\NormalTok{, }\FloatTok{69.8874}\NormalTok{, }\FloatTok{70.1244}\NormalTok{, }\FloatTok{62.9206}\NormalTok{, }\FloatTok{71.8306}\NormalTok{, }\FloatTok{78.6552}\NormalTok{,}
    \FloatTok{17.0675}\NormalTok{, }\FloatTok{34.8874}\NormalTok{, }\FloatTok{19.2002}\NormalTok{, }\FloatTok{35.7168}\NormalTok{, }\FloatTok{43.5130}\NormalTok{, }\FloatTok{2.1386}\NormalTok{, }\FloatTok{70.8353}\NormalTok{, }\FloatTok{50.4325}\NormalTok{, }\FloatTok{73.8922}\NormalTok{, }\FloatTok{68.7974}\NormalTok{, }\FloatTok{76.4277}\NormalTok{, }\FloatTok{77.3756}\NormalTok{,}
    \FloatTok{51.4751}\NormalTok{, }\FloatTok{2.5652}\NormalTok{, }\FloatTok{13.2998}\NormalTok{, }\FloatTok{25.7405}\NormalTok{, }\FloatTok{58.7500}\NormalTok{, }\FloatTok{50.5036}\NormalTok{, }\FloatTok{64.6979}\NormalTok{, }\FloatTok{76.6410}\NormalTok{, }\FloatTok{67.4467}\NormalTok{, }\FloatTok{80.3614}\NormalTok{, }\FloatTok{63.3945}\NormalTok{, }\FloatTok{75.5746}\NormalTok{,}
    \SpecialCharTok{{-}}\FloatTok{41.2500}\NormalTok{, }\FloatTok{44.1528}\NormalTok{, }\FloatTok{51.4040}\NormalTok{, }\FloatTok{35.3377}\NormalTok{, }\FloatTok{57.3993}\NormalTok{, }\FloatTok{78.3945}\NormalTok{, }\FloatTok{72.7784}\NormalTok{, }\FloatTok{56.4751}\NormalTok{, }\FloatTok{75.5746}\NormalTok{, }\FloatTok{74.5320}\NormalTok{, }\FloatTok{68.5604}\NormalTok{, }\FloatTok{75.0533}\NormalTok{,}
    \FloatTok{15.5036}\NormalTok{, }\FloatTok{31.6173}\NormalTok{, }\FloatTok{11.4040}\NormalTok{, }\FloatTok{49.9111}\NormalTok{, }\FloatTok{49.6505}\NormalTok{, }\FloatTok{48.0865}\NormalTok{, }\FloatTok{61.4040}\NormalTok{, }\FloatTok{72.7784}\NormalTok{, }\FloatTok{79.9822}\NormalTok{, }\FloatTok{77.9443}\NormalTok{, }\FloatTok{71.5699}\NormalTok{, }\FloatTok{79.8164}
\NormalTok{  ),}
  \AttributeTok{nrow =} \DecValTok{8}\NormalTok{, }\AttributeTok{byrow =} \ConstantTok{TRUE}
\NormalTok{)}

\NormalTok{replicate\_2\_2 }\OtherTok{\textless{}{-}} \FunctionTok{matrix}\NormalTok{(}
  \FunctionTok{c}\NormalTok{(}
    \FloatTok{13.5367}\NormalTok{, }\FloatTok{25.8827}\NormalTok{, }\FloatTok{48.0628}\NormalTok{, }\FloatTok{76.2855}\NormalTok{, }\FloatTok{58.0628}\NormalTok{, }\FloatTok{54.2713}\NormalTok{, }\FloatTok{69.7927}\NormalTok{, }\FloatTok{78.9633}\NormalTok{, }\FloatTok{55.6457}\NormalTok{, }\FloatTok{78.2287}\NormalTok{, }\FloatTok{80.5983}\NormalTok{, }\FloatTok{83.6789}\NormalTok{,}
    \FloatTok{51.5699}\NormalTok{, }\FloatTok{6.1671}\NormalTok{, }\FloatTok{50.8116}\NormalTok{, }\FloatTok{73.3472}\NormalTok{, }\FloatTok{28.4419}\NormalTok{, }\FloatTok{26.0960}\NormalTok{, }\FloatTok{73.4893}\NormalTok{, }\FloatTok{76.5699}\NormalTok{, }\FloatTok{74.5320}\NormalTok{, }\FloatTok{78.7263}\NormalTok{, }\FloatTok{85.4799}\NormalTok{, }\FloatTok{80.1718}\NormalTok{,}
    \FloatTok{41.7595}\NormalTok{, }\FloatTok{48.1339}\NormalTok{, }\FloatTok{39.0818}\NormalTok{, }\FloatTok{43.8211}\NormalTok{, }\FloatTok{47.9917}\NormalTok{, }\FloatTok{65.2429}\NormalTok{, }\FloatTok{79.1765}\NormalTok{, }\FloatTok{73.6078}\NormalTok{, }\FloatTok{78.5604}\NormalTok{, }\FloatTok{82.7547}\NormalTok{, }\FloatTok{81.2855}\NormalTok{, }\FloatTok{82.6126}\NormalTok{,}
    \FloatTok{38.0154}\NormalTok{, }\FloatTok{30.6931}\NormalTok{, }\FloatTok{42.3045}\NormalTok{, }\FloatTok{41.2145}\NormalTok{, }\FloatTok{30.7642}\NormalTok{, }\FloatTok{57.1386}\NormalTok{, }\FloatTok{75.6220}\NormalTok{, }\FloatTok{70.5746}\NormalTok{, }\FloatTok{72.1386}\NormalTok{, }\FloatTok{66.0960}\NormalTok{, }\FloatTok{78.2287}\NormalTok{, }\FloatTok{80.9775}\NormalTok{,}
    \FloatTok{19.6742}\NormalTok{, }\FloatTok{25.1481}\NormalTok{, }\FloatTok{36.0012}\NormalTok{, }\FloatTok{28.8685}\NormalTok{, }\FloatTok{33.3472}\NormalTok{, }\FloatTok{70.0533}\NormalTok{, }\FloatTok{73.1102}\NormalTok{, }\FloatTok{55.5509}\NormalTok{, }\FloatTok{73.3945}\NormalTok{, }\FloatTok{74.7216}\NormalTok{, }\FloatTok{80.4325}\NormalTok{, }\FloatTok{80.8827}\NormalTok{,}
    \FloatTok{46.7832}\NormalTok{, }\FloatTok{28.2050}\NormalTok{, }\FloatTok{30.6220}\NormalTok{, }\FloatTok{30.2903}\NormalTok{, }\FloatTok{60.5036}\NormalTok{, }\FloatTok{34.1291}\NormalTok{, }\FloatTok{66.9964}\NormalTok{, }\FloatTok{77.6363}\NormalTok{, }\FloatTok{76.3803}\NormalTok{, }\FloatTok{85.6694}\NormalTok{, }\FloatTok{68.1102}\NormalTok{, }\FloatTok{82.6126}\NormalTok{,}
    \FloatTok{6.4040}\NormalTok{, }\FloatTok{24.1528}\NormalTok{, }\FloatTok{64.3661}\NormalTok{, }\FloatTok{47.6126}\NormalTok{, }\FloatTok{63.5604}\NormalTok{, }\FloatTok{81.3566}\NormalTok{, }\FloatTok{79.8164}\NormalTok{, }\FloatTok{61.2382}\NormalTok{, }\FloatTok{78.0628}\NormalTok{, }\FloatTok{78.5604}\NormalTok{, }\FloatTok{70.7405}\NormalTok{, }\FloatTok{76.9017}\NormalTok{,}
    \FloatTok{25.3140}\NormalTok{, }\FloatTok{42.5889}\NormalTok{, }\FloatTok{40.6694}\NormalTok{, }\FloatTok{50.2192}\NormalTok{, }\FloatTok{53.0154}\NormalTok{, }\FloatTok{47.0912}\NormalTok{, }\FloatTok{66.6173}\NormalTok{, }\FloatTok{79.8164}\NormalTok{, }\FloatTok{83.3709}\NormalTok{, }\FloatTok{82.6363}\NormalTok{, }\FloatTok{77.1623}\NormalTok{, }\FloatTok{84.3898}
\NormalTok{  ),}
  \AttributeTok{nrow =} \DecValTok{8}\NormalTok{, }\AttributeTok{byrow =} \ConstantTok{TRUE}
\NormalTok{)}

\NormalTok{replicate\_1\_1 }\OtherTok{\textless{}{-}} \FunctionTok{as.vector}\NormalTok{(replicate\_1\_1)}
\NormalTok{replicate\_1\_2 }\OtherTok{\textless{}{-}} \FunctionTok{as.vector}\NormalTok{(replicate\_1\_2)}
\NormalTok{replicate\_2\_1 }\OtherTok{\textless{}{-}} \FunctionTok{as.vector}\NormalTok{(replicate\_2\_1)}
\NormalTok{replicate\_2\_2 }\OtherTok{\textless{}{-}} \FunctionTok{as.vector}\NormalTok{(replicate\_2\_2)}

\NormalTok{mb\_true\_ }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{96}\NormalTok{) \{}
\NormalTok{  res\_ }\OtherTok{\textless{}{-}} \FunctionTok{mean}\NormalTok{(}\FunctionTok{c}\NormalTok{(}
    \FunctionTok{mean}\NormalTok{(}\FunctionTok{c}\NormalTok{(replicate\_1\_1[i], replicate\_1\_2[i])),}
    \FunctionTok{mean}\NormalTok{(}\FunctionTok{c}\NormalTok{(replicate\_2\_1[i], replicate\_2\_2[i]))}
\NormalTok{  ))}
  \ControlFlowTok{if}\NormalTok{ (res\_ }\SpecialCharTok{\textgreater{}=} \DecValTok{0}\NormalTok{) \{}
\NormalTok{    mb\_true\_ }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(mb\_true\_, res\_)}
\NormalTok{  \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{    mb\_true\_ }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(mb\_true\_, }\ConstantTok{NA}\NormalTok{)}
\NormalTok{  \}}
\NormalTok{\}}

\NormalTok{new\_replicate\_1 }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}
  \FloatTok{79.9064}\NormalTok{, }\FloatTok{80.2179}\NormalTok{, }\FloatTok{75.9474}\NormalTok{, }\FloatTok{79.1975}\NormalTok{, }\FloatTok{71.6238}\NormalTok{, }\FloatTok{53.5235}\NormalTok{, }\FloatTok{83.5678}\NormalTok{, }\FloatTok{81.2452}\NormalTok{, }\FloatTok{74.2512}\NormalTok{, }\FloatTok{68.4291}\NormalTok{,}
  \FloatTok{90.2855}\NormalTok{, }\FloatTok{89.2512}\NormalTok{, }\FloatTok{92.8356}\NormalTok{, }\FloatTok{80.2853}\NormalTok{, }\FloatTok{62.0912}\NormalTok{, }\FloatTok{89.2853}\NormalTok{, }\FloatTok{70.1267}\NormalTok{, }\FloatTok{90.2891}\NormalTok{, }\FloatTok{63.2853}\NormalTok{, }\FloatTok{70.6812}\NormalTok{,}
  \FloatTok{89.2582}\NormalTok{, }\FloatTok{85.2567}\NormalTok{, }\FloatTok{78.3682}\NormalTok{, }\FloatTok{90.5732}\NormalTok{, }\FloatTok{82.5253}\NormalTok{, }\FloatTok{84.2912}\NormalTok{, }\FloatTok{82.5923}\NormalTok{, }\FloatTok{90.8613}\NormalTok{, }\FloatTok{73.2862}\NormalTok{, }\FloatTok{90.4823}\NormalTok{,}
  \FloatTok{59.2715}
\NormalTok{)}

\NormalTok{new\_replicate\_2 }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}
  \FloatTok{77.6257}\NormalTok{, }\FloatTok{82.2692}\NormalTok{, }\FloatTok{71.8684}\NormalTok{, }\FloatTok{79.1338}\NormalTok{, }\FloatTok{67.7994}\NormalTok{, }\FloatTok{52.3258}\NormalTok{, }\FloatTok{88.2912}\NormalTok{, }\FloatTok{79.6823}\NormalTok{, }\FloatTok{78.5257}\NormalTok{, }\FloatTok{62.5212}\NormalTok{,}
  \FloatTok{81.2842}\NormalTok{, }\FloatTok{83.5812}\NormalTok{, }\FloatTok{90.2512}\NormalTok{, }\FloatTok{73.4821}\NormalTok{, }\FloatTok{63.6843}\NormalTok{, }\FloatTok{88.2965}\NormalTok{, }\FloatTok{72.0582}\NormalTok{, }\FloatTok{93.1925}\NormalTok{, }\FloatTok{62.9142}\NormalTok{, }\FloatTok{78.0396}\NormalTok{,}
  \FloatTok{86.9323}\NormalTok{, }\FloatTok{82.5323}\NormalTok{, }\FloatTok{72.6429}\NormalTok{, }\FloatTok{83.6736}\NormalTok{, }\FloatTok{89.5191}\NormalTok{, }\FloatTok{86.8432}\NormalTok{, }\FloatTok{81.5171}\NormalTok{, }\FloatTok{92.1856}\NormalTok{, }\FloatTok{92.6736}\NormalTok{, }\FloatTok{93.9124}\NormalTok{,}
  \FloatTok{95.3929}
\NormalTok{)}

\NormalTok{new\_replicate\_3 }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}
  \FloatTok{79.7602}\NormalTok{, }\FloatTok{83.5192}\NormalTok{, }\FloatTok{74.6645}\NormalTok{, }\FloatTok{80.8854}\NormalTok{, }\FloatTok{67.3918}\NormalTok{, }\FloatTok{49.5821}\NormalTok{, }\FloatTok{93.1263}\NormalTok{, }\FloatTok{84.2590}\NormalTok{, }\FloatTok{76.9253}\NormalTok{, }\FloatTok{60.4827}\NormalTok{,}
  \FloatTok{93.4825}\NormalTok{, }\FloatTok{85.9901}\NormalTok{, }\FloatTok{88.5705}\NormalTok{, }\FloatTok{79.0125}\NormalTok{, }\FloatTok{60.1825}\NormalTok{, }\FloatTok{90.5812}\NormalTok{, }\FloatTok{71.2281}\NormalTok{, }\FloatTok{89.9251}\NormalTok{, }\FloatTok{64.2681}\NormalTok{, }\FloatTok{72.5712}\NormalTok{,}
  \FloatTok{83.9235}\NormalTok{, }\FloatTok{84.2719}\NormalTok{, }\FloatTok{71.1281}\NormalTok{, }\FloatTok{95.2182}\NormalTok{, }\FloatTok{90.0191}\NormalTok{, }\FloatTok{89.1812}\NormalTok{, }\FloatTok{82.7195}\NormalTok{, }\FloatTok{89.9501}\NormalTok{, }\FloatTok{83.8581}\NormalTok{, }\FloatTok{85.3725}\NormalTok{,}
  \FloatTok{93.2801}
\NormalTok{)}

\NormalTok{new\_mb\_true\_ }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{31}\NormalTok{) \{}
\NormalTok{  res\_ }\OtherTok{\textless{}{-}} \FunctionTok{mean}\NormalTok{(}\FunctionTok{c}\NormalTok{(new\_replicate\_1[i], new\_replicate\_2[i], new\_replicate\_3[i]))}
  \ControlFlowTok{if}\NormalTok{ (res\_ }\SpecialCharTok{\textgreater{}=} \DecValTok{0}\NormalTok{) \{}
\NormalTok{    new\_mb\_true\_ }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(new\_mb\_true\_, res\_)}
\NormalTok{  \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{    new\_mb\_true\_ }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(new\_mb\_true\_, }\ConstantTok{NA}\NormalTok{)}
\NormalTok{  \}}
\NormalTok{\}}

\NormalTok{mb\_true }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(mb\_true\_, new\_mb\_true\_)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mb\_df }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}\AttributeTok{mb\_pred =}\NormalTok{ mb\_pred, }\AttributeTok{mb\_true =}\NormalTok{ mb\_true)}
\NormalTok{mb\_df }\OtherTok{\textless{}{-}}\NormalTok{ mb\_df[}\FunctionTok{complete.cases}\NormalTok{(mb\_df), ]}

\NormalTok{p1 }\OtherTok{\textless{}{-}} \FunctionTok{ggscatter}\NormalTok{(mb\_df,}
  \AttributeTok{x =} \StringTok{"mb\_pred"}\NormalTok{, }\AttributeTok{y =} \StringTok{"mb\_true"}\NormalTok{,}
  \AttributeTok{alpha =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{size =} \FloatTok{2.5}\NormalTok{, }\AttributeTok{stroke =} \FloatTok{0.2}\NormalTok{, }\AttributeTok{color =} \StringTok{"black"}\NormalTok{, }\AttributeTok{fill =} \StringTok{"grey70"}\NormalTok{, }\AttributeTok{shape =} \DecValTok{21}\NormalTok{,}
  \AttributeTok{add =} \StringTok{"reg.line"}\NormalTok{, }\AttributeTok{conf.int =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{conf.int.level =} \FloatTok{0.95}\NormalTok{, }\AttributeTok{cor.coef =} \ConstantTok{TRUE}\NormalTok{,}
  \AttributeTok{add.params =} \FunctionTok{list}\NormalTok{(}\AttributeTok{color =} \StringTok{"grey25"}\NormalTok{, }\AttributeTok{fill =} \StringTok{"grey70"}\NormalTok{),}
  \AttributeTok{cor.coeff.args =} \FunctionTok{list}\NormalTok{(}
    \AttributeTok{method =} \StringTok{"pearson"}\NormalTok{, }\AttributeTok{label.x =} \DecValTok{2}\NormalTok{, }\AttributeTok{label.y =} \DecValTok{95}\NormalTok{, }\AttributeTok{label.sep =} \StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{,}
    \AttributeTok{size =} \FloatTok{4.5}
\NormalTok{  )}
\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_bw}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}
    \AttributeTok{panel.grid.major =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{panel.grid.minor =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{strip.background =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{panel.border =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{axis.line =} \FunctionTok{element\_line}\NormalTok{(}\AttributeTok{color =} \StringTok{"black"}\NormalTok{),}
    \AttributeTok{axis.title.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{15}\NormalTok{),}
    \AttributeTok{axis.title.y =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{15}\NormalTok{),}
    \AttributeTok{axis.text.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{12}\NormalTok{),}
    \AttributeTok{axis.text.y =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{12}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{xlab}\NormalTok{(}\StringTok{"Predicted peptide bound}\SpecialCharTok{\textbackslash{}n}\StringTok{to b{-}mNPs (\%)"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{ylab}\NormalTok{(}\StringTok{"Measured peptide bound}\SpecialCharTok{\textbackslash{}n}\StringTok{to mNPs (\%)"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{xlim}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{5}\NormalTok{, }\DecValTok{105}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{ylim}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{5}\NormalTok{, }\DecValTok{105}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics[width=1\linewidth]{./figures/Fig 3 mb validation} \end{center}

\hypertarget{melanin-binding-and-cell-penetration}{%
\subsection{Melanin binding and cell-penetration}\label{melanin-binding-and-cell-penetration}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# ================}
\CommentTok{\# predicted values}
\CommentTok{\# ================}
\NormalTok{cpp\_pred\_ }\OtherTok{\textless{}{-}} \FunctionTok{matrix}\NormalTok{(}
  \FunctionTok{c}\NormalTok{(}
    \StringTok{"Non{-}CPP"}\NormalTok{, }\StringTok{"Non{-}CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{,}
    \StringTok{"Non{-}CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{,}
    \StringTok{"Non{-}CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{,}
    \StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{,}
    \StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{,}
    \StringTok{"Non{-}CPP"}\NormalTok{, }\StringTok{"Non{-}CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{,}
    \StringTok{"Non{-}CPP"}\NormalTok{, }\StringTok{"Non{-}CPP"}\NormalTok{, }\StringTok{"Non{-}CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{,}
    \StringTok{"Non{-}CPP"}\NormalTok{, }\StringTok{"Non{-}CPP"}\NormalTok{, }\StringTok{"Non{-}CPP"}\NormalTok{, }\StringTok{"Non{-}CPP"}\NormalTok{, }\StringTok{"Non{-}CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}
\NormalTok{  ),}
  \AttributeTok{nrow =} \DecValTok{8}\NormalTok{, }\AttributeTok{byrow =} \ConstantTok{TRUE}
\NormalTok{)}

\NormalTok{new\_cpp\_pred\_ }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}
  \StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{,}
  \StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{,}
  \StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{,}
  \StringTok{"CPP"}
\NormalTok{)}

\NormalTok{cpp\_pred }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\FunctionTok{as.vector}\NormalTok{(cpp\_pred\_), new\_cpp\_pred\_)}

\CommentTok{\# ===================}
\CommentTok{\# Experimental values}
\CommentTok{\# ===================}
\NormalTok{non\_induced\_replicate\_1 }\OtherTok{\textless{}{-}} \FunctionTok{matrix}\NormalTok{(}
  \FunctionTok{c}\NormalTok{(}
    \FloatTok{31.3344}\NormalTok{, }\FloatTok{24.1344}\NormalTok{, }\FloatTok{25.3344}\NormalTok{, }\FloatTok{45.4944}\NormalTok{, }\FloatTok{16.0944}\NormalTok{, }\FloatTok{146.6544}\NormalTok{, }\FloatTok{20.2944}\NormalTok{, }\FloatTok{18.9744}\NormalTok{, }\FloatTok{15.3744}\NormalTok{, }\FloatTok{12.0144}\NormalTok{, }\FloatTok{19.8144}\NormalTok{, }\FloatTok{15.3744}\NormalTok{,}
    \FloatTok{20.8944}\NormalTok{, }\FloatTok{20.1744}\NormalTok{, }\FloatTok{17.2944}\NormalTok{, }\FloatTok{63.1344}\NormalTok{, }\FloatTok{15.6144}\NormalTok{, }\FloatTok{15.6144}\NormalTok{, }\FloatTok{32.4144}\NormalTok{, }\FloatTok{16.5744}\NormalTok{, }\FloatTok{17.7744}\NormalTok{, }\FloatTok{12.1344}\NormalTok{, }\FloatTok{14.7744}\NormalTok{, }\FloatTok{55.9344}\NormalTok{,}
    \FloatTok{19.4544}\NormalTok{, }\FloatTok{21.3744}\NormalTok{, }\FloatTok{29.1744}\NormalTok{, }\FloatTok{25.9344}\NormalTok{, }\FloatTok{89.5344}\NormalTok{, }\FloatTok{14.8944}\NormalTok{, }\FloatTok{19.9344}\NormalTok{, }\FloatTok{11.4144}\NormalTok{, }\FloatTok{29.5344}\NormalTok{, }\FloatTok{13.5744}\NormalTok{, }\FloatTok{13.3344}\NormalTok{, }\FloatTok{33.9744}\NormalTok{,}
    \FloatTok{13.2144}\NormalTok{, }\FloatTok{8.1744}\NormalTok{, }\FloatTok{29.7744}\NormalTok{, }\SpecialCharTok{{-}}\FloatTok{24.8256}\NormalTok{, }\FloatTok{14.2944}\NormalTok{, }\FloatTok{18.4944}\NormalTok{, }\FloatTok{15.7344}\NormalTok{, }\FloatTok{14.6544}\NormalTok{, }\FloatTok{14.1744}\NormalTok{, }\FloatTok{10.9344}\NormalTok{, }\FloatTok{9.1344}\NormalTok{, }\FloatTok{55.6944}\NormalTok{,}
    \FloatTok{13.9344}\NormalTok{, }\FloatTok{12.8544}\NormalTok{, }\FloatTok{36.7344}\NormalTok{, }\FloatTok{20.8944}\NormalTok{, }\FloatTok{15.2544}\NormalTok{, }\FloatTok{17.5344}\NormalTok{, }\FloatTok{13.3344}\NormalTok{, }\FloatTok{17.4144}\NormalTok{, }\FloatTok{20.7744}\NormalTok{, }\FloatTok{10.9344}\NormalTok{, }\FloatTok{15.8544}\NormalTok{, }\FloatTok{19.4544}\NormalTok{,}
    \FloatTok{10.4544}\NormalTok{, }\FloatTok{20.2944}\NormalTok{, }\FloatTok{25.9344}\NormalTok{, }\FloatTok{19.9344}\NormalTok{, }\FloatTok{18.8544}\NormalTok{, }\FloatTok{15.8544}\NormalTok{, }\FloatTok{15.7344}\NormalTok{, }\FloatTok{20.2944}\NormalTok{, }\FloatTok{13.4544}\NormalTok{, }\FloatTok{7.5744}\NormalTok{, }\FloatTok{11.7744}\NormalTok{, }\FloatTok{33.9744}\NormalTok{,}
    \FloatTok{17.7744}\NormalTok{, }\FloatTok{24.8544}\NormalTok{, }\FloatTok{23.6544}\NormalTok{, }\FloatTok{19.5744}\NormalTok{, }\FloatTok{19.9344}\NormalTok{, }\FloatTok{77.5344}\NormalTok{, }\FloatTok{24.0144}\NormalTok{, }\FloatTok{24.8544}\NormalTok{, }\FloatTok{24.4944}\NormalTok{, }\FloatTok{29.5344}\NormalTok{, }\FloatTok{31.5744}\NormalTok{, }\FloatTok{53.8944}\NormalTok{,}
    \FloatTok{9.7344}\NormalTok{, }\FloatTok{10.5744}\NormalTok{, }\FloatTok{25.3344}\NormalTok{, }\FloatTok{15.7344}\NormalTok{, }\FloatTok{27.9744}\NormalTok{, }\FloatTok{27.4944}\NormalTok{, }\FloatTok{19.6944}\NormalTok{, }\FloatTok{19.4544}\NormalTok{, }\FloatTok{27.4944}\NormalTok{, }\FloatTok{24.4944}\NormalTok{, }\FloatTok{24.6144}\NormalTok{, }\FloatTok{26.2944}
\NormalTok{  ),}
  \AttributeTok{nrow =} \DecValTok{8}\NormalTok{, }\AttributeTok{byrow =} \ConstantTok{TRUE}
\NormalTok{)}

\NormalTok{non\_induced\_replicate\_2 }\OtherTok{\textless{}{-}} \FunctionTok{matrix}\NormalTok{(}
  \FunctionTok{c}\NormalTok{(}
    \FloatTok{30.3744}\NormalTok{, }\FloatTok{28.4544}\NormalTok{, }\FloatTok{26.1744}\NormalTok{, }\FloatTok{30.0144}\NormalTok{, }\FloatTok{25.6944}\NormalTok{, }\FloatTok{131.5344}\NormalTok{, }\FloatTok{31.8144}\NormalTok{, }\FloatTok{21.9744}\NormalTok{, }\FloatTok{30.4944}\NormalTok{, }\FloatTok{20.2944}\NormalTok{, }\FloatTok{17.7744}\NormalTok{, }\FloatTok{26.7744}\NormalTok{,}
    \FloatTok{27.4944}\NormalTok{, }\FloatTok{20.6544}\NormalTok{, }\FloatTok{21.3744}\NormalTok{, }\FloatTok{44.2944}\NormalTok{, }\FloatTok{23.6544}\NormalTok{, }\FloatTok{28.5744}\NormalTok{, }\FloatTok{26.5344}\NormalTok{, }\FloatTok{22.0944}\NormalTok{, }\FloatTok{26.7744}\NormalTok{, }\FloatTok{17.5344}\NormalTok{, }\FloatTok{18.9744}\NormalTok{, }\FloatTok{63.0144}\NormalTok{,}
    \FloatTok{25.6944}\NormalTok{, }\FloatTok{22.8144}\NormalTok{, }\FloatTok{27.6144}\NormalTok{, }\FloatTok{26.7744}\NormalTok{, }\FloatTok{88.9344}\NormalTok{, }\FloatTok{30.8544}\NormalTok{, }\FloatTok{24.1344}\NormalTok{, }\FloatTok{10.9344}\NormalTok{, }\FloatTok{19.9344}\NormalTok{, }\FloatTok{19.5744}\NormalTok{, }\FloatTok{21.4944}\NormalTok{, }\FloatTok{25.2144}\NormalTok{,}
    \FloatTok{12.9744}\NormalTok{, }\FloatTok{15.0144}\NormalTok{, }\FloatTok{17.7744}\NormalTok{, }\FloatTok{14.8944}\NormalTok{, }\FloatTok{13.5744}\NormalTok{, }\FloatTok{24.4944}\NormalTok{, }\FloatTok{27.6144}\NormalTok{, }\FloatTok{13.9344}\NormalTok{, }\FloatTok{23.1744}\NormalTok{, }\FloatTok{17.7744}\NormalTok{, }\FloatTok{15.7344}\NormalTok{, }\FloatTok{45.6144}\NormalTok{,}
    \FloatTok{16.0944}\NormalTok{, }\FloatTok{23.1744}\NormalTok{, }\FloatTok{17.7744}\NormalTok{, }\FloatTok{15.7344}\NormalTok{, }\FloatTok{20.6544}\NormalTok{, }\FloatTok{27.6144}\NormalTok{, }\FloatTok{34.0944}\NormalTok{, }\FloatTok{24.6144}\NormalTok{, }\FloatTok{22.8144}\NormalTok{, }\FloatTok{14.4144}\NormalTok{, }\FloatTok{26.7744}\NormalTok{, }\FloatTok{25.6944}\NormalTok{,}
    \FloatTok{12.0144}\NormalTok{, }\FloatTok{31.8144}\NormalTok{, }\FloatTok{16.4544}\NormalTok{, }\FloatTok{21.6144}\NormalTok{, }\FloatTok{30.2544}\NormalTok{, }\FloatTok{18.7344}\NormalTok{, }\FloatTok{24.9744}\NormalTok{, }\FloatTok{29.7744}\NormalTok{, }\FloatTok{15.1344}\NormalTok{, }\FloatTok{15.1344}\NormalTok{, }\FloatTok{27.8544}\NormalTok{, }\FloatTok{25.2144}\NormalTok{,}
    \FloatTok{23.2944}\NormalTok{, }\FloatTok{28.2144}\NormalTok{, }\FloatTok{30.6144}\NormalTok{, }\FloatTok{22.0944}\NormalTok{, }\FloatTok{19.9344}\NormalTok{, }\FloatTok{63.0144}\NormalTok{, }\FloatTok{22.8144}\NormalTok{, }\FloatTok{22.2144}\NormalTok{, }\FloatTok{21.6144}\NormalTok{, }\FloatTok{19.9344}\NormalTok{, }\FloatTok{23.0544}\NormalTok{, }\FloatTok{30.9744}\NormalTok{,}
    \FloatTok{14.0544}\NormalTok{, }\FloatTok{23.7744}\NormalTok{, }\FloatTok{20.6544}\NormalTok{, }\FloatTok{11.0544}\NormalTok{, }\FloatTok{23.8944}\NormalTok{, }\FloatTok{31.4544}\NormalTok{, }\FloatTok{20.6544}\NormalTok{, }\FloatTok{15.4944}\NormalTok{, }\FloatTok{31.4544}\NormalTok{, }\FloatTok{26.0544}\NormalTok{, }\FloatTok{33.0144}\NormalTok{, }\FloatTok{37.0944}
\NormalTok{  ),}
  \AttributeTok{nrow =} \DecValTok{8}\NormalTok{, }\AttributeTok{byrow =} \ConstantTok{TRUE}
\NormalTok{)}

\NormalTok{non\_induced\_replicate\_3 }\OtherTok{\textless{}{-}} \FunctionTok{matrix}\NormalTok{(}
  \FunctionTok{c}\NormalTok{(}
    \FloatTok{27.3744}\NormalTok{, }\FloatTok{16.3344}\NormalTok{, }\FloatTok{17.5344}\NormalTok{, }\FloatTok{33.7344}\NormalTok{, }\FloatTok{13.8144}\NormalTok{, }\FloatTok{110.8944}\NormalTok{, }\FloatTok{33.4944}\NormalTok{, }\FloatTok{37.2144}\NormalTok{, }\FloatTok{34.8144}\NormalTok{, }\FloatTok{20.8944}\NormalTok{, }\FloatTok{39.4944}\NormalTok{, }\FloatTok{36.1344}\NormalTok{,}
    \FloatTok{15.9744}\NormalTok{, }\FloatTok{13.4544}\NormalTok{, }\FloatTok{18.6144}\NormalTok{, }\FloatTok{28.2144}\NormalTok{, }\FloatTok{13.0944}\NormalTok{, }\FloatTok{12.8544}\NormalTok{, }\FloatTok{46.3344}\NormalTok{, }\FloatTok{27.6144}\NormalTok{, }\FloatTok{64.6944}\NormalTok{, }\FloatTok{3.4944}\NormalTok{, }\FloatTok{25.5744}\NormalTok{, }\FloatTok{40.8144}\NormalTok{,}
    \FloatTok{13.8144}\NormalTok{, }\FloatTok{13.5744}\NormalTok{, }\FloatTok{35.7744}\NormalTok{, }\FloatTok{16.4544}\NormalTok{, }\FloatTok{54.4944}\NormalTok{, }\FloatTok{14.2944}\NormalTok{, }\FloatTok{30.7344}\NormalTok{, }\FloatTok{23.6544}\NormalTok{, }\FloatTok{41.0544}\NormalTok{, }\FloatTok{8.5344}\NormalTok{, }\FloatTok{23.1744}\NormalTok{, }\FloatTok{52.2144}\NormalTok{,}
    \FloatTok{32.5344}\NormalTok{, }\FloatTok{19.4544}\NormalTok{, }\FloatTok{27.2544}\NormalTok{, }\FloatTok{27.1344}\NormalTok{, }\FloatTok{20.5344}\NormalTok{, }\FloatTok{27.3744}\NormalTok{, }\FloatTok{30.6144}\NormalTok{, }\FloatTok{25.6944}\NormalTok{, }\FloatTok{27.1344}\NormalTok{, }\FloatTok{28.3344}\NormalTok{, }\FloatTok{29.4144}\NormalTok{, }\FloatTok{27.3744}\NormalTok{,}
    \FloatTok{30.0144}\NormalTok{, }\FloatTok{19.5744}\NormalTok{, }\FloatTok{31.3344}\NormalTok{, }\FloatTok{31.9344}\NormalTok{, }\FloatTok{25.6944}\NormalTok{, }\FloatTok{26.7744}\NormalTok{, }\FloatTok{36.4944}\NormalTok{, }\FloatTok{25.8144}\NormalTok{, }\FloatTok{35.2944}\NormalTok{, }\FloatTok{7.8144}\NormalTok{, }\FloatTok{45.1344}\NormalTok{, }\FloatTok{21.7344}\NormalTok{,}
    \FloatTok{19.4544}\NormalTok{, }\FloatTok{33.4944}\NormalTok{, }\FloatTok{22.8144}\NormalTok{, }\FloatTok{19.8144}\NormalTok{, }\FloatTok{21.9744}\NormalTok{, }\FloatTok{22.8144}\NormalTok{, }\FloatTok{24.8544}\NormalTok{, }\FloatTok{29.4144}\NormalTok{, }\FloatTok{31.3344}\NormalTok{, }\FloatTok{33.3744}\NormalTok{, }\FloatTok{42.9744}\NormalTok{, }\FloatTok{52.2144}\NormalTok{,}
    \FloatTok{12.4944}\NormalTok{, }\FloatTok{15.3744}\NormalTok{, }\FloatTok{27.3744}\NormalTok{, }\FloatTok{10.4544}\NormalTok{, }\FloatTok{7.9344}\NormalTok{, }\FloatTok{64.3344}\NormalTok{, }\FloatTok{36.0144}\NormalTok{, }\FloatTok{68.7744}\NormalTok{, }\FloatTok{27.6144}\NormalTok{, }\FloatTok{41.0544}\NormalTok{, }\FloatTok{47.5344}\NormalTok{, }\FloatTok{70.2144}\NormalTok{,}
    \FloatTok{20.4144}\NormalTok{, }\FloatTok{10.8144}\NormalTok{, }\FloatTok{28.0944}\NormalTok{, }\FloatTok{20.5344}\NormalTok{, }\FloatTok{29.0544}\NormalTok{, }\FloatTok{37.2144}\NormalTok{, }\FloatTok{27.9744}\NormalTok{, }\FloatTok{14.1744}\NormalTok{, }\FloatTok{37.2144}\NormalTok{, }\FloatTok{29.4144}\NormalTok{, }\FloatTok{23.1744}\NormalTok{, }\FloatTok{25.5744}
\NormalTok{  ),}
  \AttributeTok{nrow =} \DecValTok{8}\NormalTok{, }\AttributeTok{byrow =} \ConstantTok{TRUE}
\NormalTok{)}

\NormalTok{non\_induced\_true\_ }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{96}\NormalTok{) \{}
\NormalTok{  res\_ }\OtherTok{\textless{}{-}} \FunctionTok{mean}\NormalTok{(}\FunctionTok{c}\NormalTok{(non\_induced\_replicate\_1[i], non\_induced\_replicate\_2[i], non\_induced\_replicate\_3[i]))}
\NormalTok{  non\_induced\_true\_ }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(non\_induced\_true\_, res\_)}
\NormalTok{\}}

\NormalTok{induced\_replicate\_1 }\OtherTok{\textless{}{-}} \FunctionTok{matrix}\NormalTok{(}
  \FunctionTok{c}\NormalTok{(}
    \FloatTok{171.4944}\NormalTok{, }\FloatTok{32.1744}\NormalTok{, }\FloatTok{23.6544}\NormalTok{, }\FloatTok{24.7344}\NormalTok{, }\FloatTok{47.1744}\NormalTok{, }\FloatTok{404.5344}\NormalTok{, }\FloatTok{224.2944}\NormalTok{, }\FloatTok{71.8944}\NormalTok{, }\FloatTok{442.4544}\NormalTok{, }\FloatTok{394.5744}\NormalTok{, }\FloatTok{294.8544}\NormalTok{, }\FloatTok{464.8944}\NormalTok{,}
    \FloatTok{39.4944}\NormalTok{, }\FloatTok{24.2544}\NormalTok{, }\FloatTok{59.4144}\NormalTok{, }\FloatTok{55.6944}\NormalTok{, }\FloatTok{31.9344}\NormalTok{, }\FloatTok{182.2944}\NormalTok{, }\FloatTok{195.2544}\NormalTok{, }\FloatTok{434.1744}\NormalTok{, }\FloatTok{486.8544}\NormalTok{, }\FloatTok{406.8144}\NormalTok{, }\FloatTok{25.4544}\NormalTok{, }\FloatTok{524.5344}\NormalTok{,}
    \FloatTok{28.8144}\NormalTok{, }\FloatTok{76.2144}\NormalTok{, }\FloatTok{160.6944}\NormalTok{, }\FloatTok{32.6544}\NormalTok{, }\FloatTok{424.8144}\NormalTok{, }\FloatTok{60.4944}\NormalTok{, }\FloatTok{474.1344}\NormalTok{, }\FloatTok{281.2944}\NormalTok{, }\FloatTok{240.2544}\NormalTok{, }\FloatTok{226.8144}\NormalTok{, }\FloatTok{386.1744}\NormalTok{, }\FloatTok{235.2144}\NormalTok{,}
    \FloatTok{20.7744}\NormalTok{, }\FloatTok{28.9344}\NormalTok{, }\FloatTok{43.6944}\NormalTok{, }\FloatTok{34.2144}\NormalTok{, }\FloatTok{20.6544}\NormalTok{, }\FloatTok{45.9744}\NormalTok{, }\FloatTok{297.0144}\NormalTok{, }\FloatTok{30.9744}\NormalTok{, }\FloatTok{540.3744}\NormalTok{, }\FloatTok{235.4544}\NormalTok{, }\FloatTok{618.3744}\NormalTok{, }\FloatTok{395.7744}\NormalTok{,}
    \FloatTok{24.7344}\NormalTok{, }\FloatTok{13.9344}\NormalTok{, }\FloatTok{30.2544}\NormalTok{, }\FloatTok{23.5344}\NormalTok{, }\FloatTok{14.8944}\NormalTok{, }\FloatTok{17.1744}\NormalTok{, }\FloatTok{40.5744}\NormalTok{, }\FloatTok{132.4944}\NormalTok{, }\FloatTok{410.4144}\NormalTok{, }\FloatTok{53.2944}\NormalTok{, }\FloatTok{352.8144}\NormalTok{, }\FloatTok{427.2144}\NormalTok{,}
    \FloatTok{13.3344}\NormalTok{, }\FloatTok{224.2944}\NormalTok{, }\FloatTok{28.2144}\NormalTok{, }\FloatTok{48.0144}\NormalTok{, }\FloatTok{62.5344}\NormalTok{, }\FloatTok{25.6944}\NormalTok{, }\FloatTok{352.6944}\NormalTok{, }\FloatTok{245.6544}\NormalTok{, }\FloatTok{80.8944}\NormalTok{, }\FloatTok{313.5744}\NormalTok{, }\FloatTok{414.6144}\NormalTok{, }\FloatTok{235.2144}\NormalTok{,}
    \FloatTok{20.8944}\NormalTok{, }\FloatTok{29.8944}\NormalTok{, }\FloatTok{36.9744}\NormalTok{, }\FloatTok{19.6944}\NormalTok{, }\FloatTok{12.7344}\NormalTok{, }\FloatTok{422.1744}\NormalTok{, }\FloatTok{341.8944}\NormalTok{, }\FloatTok{120.2544}\NormalTok{, }\FloatTok{333.6144}\NormalTok{, }\FloatTok{281.2944}\NormalTok{, }\FloatTok{534.7344}\NormalTok{, }\FloatTok{356.2944}\NormalTok{,}
    \FloatTok{15.7344}\NormalTok{, }\FloatTok{66.4944}\NormalTok{, }\FloatTok{33.3744}\NormalTok{, }\FloatTok{21.0144}\NormalTok{, }\FloatTok{73.5744}\NormalTok{, }\FloatTok{17.8944}\NormalTok{, }\FloatTok{108.9744}\NormalTok{, }\FloatTok{116.1744}\NormalTok{, }\FloatTok{618.3744}\NormalTok{, }\FloatTok{538.0944}\NormalTok{, }\FloatTok{554.0544}\NormalTok{, }\FloatTok{502.4544}
\NormalTok{  ),}
  \AttributeTok{nrow =} \DecValTok{8}\NormalTok{, }\AttributeTok{byrow =} \ConstantTok{TRUE}
\NormalTok{)}

\NormalTok{induced\_replicate\_2 }\OtherTok{\textless{}{-}} \FunctionTok{matrix}\NormalTok{(}
  \FunctionTok{c}\NormalTok{(}
    \FloatTok{39.1344}\NormalTok{, }\FloatTok{30.1344}\NormalTok{, }\FloatTok{34.5744}\NormalTok{, }\FloatTok{367.2144}\NormalTok{, }\FloatTok{36.7344}\NormalTok{, }\FloatTok{185.4144}\NormalTok{, }\FloatTok{192.9744}\NormalTok{, }\FloatTok{434.2944}\NormalTok{, }\FloatTok{376.2144}\NormalTok{, }\FloatTok{305.4144}\NormalTok{, }\FloatTok{192.9744}\NormalTok{, }\FloatTok{420.6144}\NormalTok{,}
    \FloatTok{41.4144}\NormalTok{, }\FloatTok{19.4544}\NormalTok{, }\FloatTok{101.6544}\NormalTok{, }\FloatTok{370.0944}\NormalTok{, }\FloatTok{43.9344}\NormalTok{, }\FloatTok{231.1344}\NormalTok{, }\FloatTok{110.1744}\NormalTok{, }\FloatTok{476.8944}\NormalTok{, }\FloatTok{395.6544}\NormalTok{, }\FloatTok{315.6144}\NormalTok{, }\FloatTok{75.9744}\NormalTok{, }\FloatTok{435.2544}\NormalTok{,}
    \FloatTok{26.8944}\NormalTok{, }\FloatTok{60.6144}\NormalTok{, }\FloatTok{29.8944}\NormalTok{, }\FloatTok{200.1744}\NormalTok{, }\FloatTok{460.5744}\NormalTok{, }\FloatTok{265.9344}\NormalTok{, }\FloatTok{541.6944}\NormalTok{, }\FloatTok{310.2144}\NormalTok{, }\FloatTok{282.6144}\NormalTok{, }\FloatTok{404.4144}\NormalTok{, }\FloatTok{168.9744}\NormalTok{, }\FloatTok{196.2144}\NormalTok{,}
    \FloatTok{12.6144}\NormalTok{, }\FloatTok{137.7744}\NormalTok{, }\FloatTok{16.0944}\NormalTok{, }\FloatTok{16.2144}\NormalTok{, }\FloatTok{47.8944}\NormalTok{, }\FloatTok{24.7344}\NormalTok{, }\FloatTok{274.4544}\NormalTok{, }\FloatTok{62.0544}\NormalTok{, }\FloatTok{247.9344}\NormalTok{, }\FloatTok{209.2944}\NormalTok{, }\FloatTok{393.4944}\NormalTok{, }\FloatTok{423.3744}\NormalTok{,}
    \FloatTok{22.2144}\NormalTok{, }\FloatTok{21.3744}\NormalTok{, }\FloatTok{11.1744}\NormalTok{, }\FloatTok{9.1344}\NormalTok{, }\FloatTok{128.4144}\NormalTok{, }\FloatTok{19.6944}\NormalTok{, }\FloatTok{58.9344}\NormalTok{, }\FloatTok{233.1744}\NormalTok{, }\FloatTok{437.4144}\NormalTok{, }\FloatTok{58.6944}\NormalTok{, }\FloatTok{361.0944}\NormalTok{, }\FloatTok{458.8944}\NormalTok{,}
    \FloatTok{16.8144}\NormalTok{, }\FloatTok{33.3744}\NormalTok{, }\FloatTok{12.3744}\NormalTok{, }\FloatTok{24.3744}\NormalTok{, }\FloatTok{134.1744}\NormalTok{, }\FloatTok{25.9344}\NormalTok{, }\FloatTok{364.4544}\NormalTok{, }\FloatTok{207.8544}\NormalTok{, }\FloatTok{91.2144}\NormalTok{, }\FloatTok{383.6544}\NormalTok{, }\FloatTok{434.0544}\NormalTok{, }\FloatTok{196.2144}\NormalTok{,}
    \FloatTok{11.8944}\NormalTok{, }\FloatTok{21.7344}\NormalTok{, }\FloatTok{17.4144}\NormalTok{, }\FloatTok{16.8144}\NormalTok{, }\FloatTok{19.9344}\NormalTok{, }\FloatTok{525.4944}\NormalTok{, }\FloatTok{422.4144}\NormalTok{, }\FloatTok{519.9744}\NormalTok{, }\FloatTok{379.5744}\NormalTok{, }\FloatTok{282.6144}\NormalTok{, }\FloatTok{616.9344}\NormalTok{, }\FloatTok{450.0144}\NormalTok{,}
    \FloatTok{19.2144}\NormalTok{, }\FloatTok{42.7344}\NormalTok{, }\FloatTok{19.4544}\NormalTok{, }\FloatTok{25.9344}\NormalTok{, }\FloatTok{54.7344}\NormalTok{, }\FloatTok{42.9744}\NormalTok{, }\FloatTok{73.2144}\NormalTok{, }\FloatTok{135.4944}\NormalTok{, }\FloatTok{524.0544}\NormalTok{, }\FloatTok{471.7344}\NormalTok{, }\FloatTok{528.4944}\NormalTok{, }\FloatTok{511.0944}
\NormalTok{  ),}
  \AttributeTok{nrow =} \DecValTok{8}\NormalTok{, }\AttributeTok{byrow =} \ConstantTok{TRUE}
\NormalTok{)}

\NormalTok{induced\_replicate\_3 }\OtherTok{\textless{}{-}} \FunctionTok{matrix}\NormalTok{(}
  \FunctionTok{c}\NormalTok{(}
    \FloatTok{30.3744}\NormalTok{, }\FloatTok{20.2944}\NormalTok{, }\FloatTok{233.8944}\NormalTok{, }\FloatTok{83.8944}\NormalTok{, }\FloatTok{24.2544}\NormalTok{, }\FloatTok{25.3344}\NormalTok{, }\FloatTok{136.2144}\NormalTok{, }\FloatTok{374.8944}\NormalTok{, }\FloatTok{334.5744}\NormalTok{, }\FloatTok{399.6144}\NormalTok{, }\FloatTok{383.6544}\NormalTok{, }\FloatTok{544.6944}\NormalTok{,}
    \FloatTok{18.9744}\NormalTok{, }\FloatTok{21.1344}\NormalTok{, }\FloatTok{20.0544}\NormalTok{, }\FloatTok{401.7744}\NormalTok{, }\FloatTok{22.6944}\NormalTok{, }\FloatTok{62.7744}\NormalTok{, }\FloatTok{51.4944}\NormalTok{, }\FloatTok{430.6944}\NormalTok{, }\FloatTok{303.7344}\NormalTok{, }\FloatTok{466.6944}\NormalTok{, }\FloatTok{329.6544}\NormalTok{, }\FloatTok{567.7344}\NormalTok{,}
    \FloatTok{21.8544}\NormalTok{, }\FloatTok{75.3744}\NormalTok{, }\FloatTok{51.9744}\NormalTok{, }\FloatTok{150.3744}\NormalTok{, }\FloatTok{411.4944}\NormalTok{, }\FloatTok{122.0544}\NormalTok{, }\FloatTok{458.2944}\NormalTok{, }\FloatTok{127.8144}\NormalTok{, }\FloatTok{38.4144}\NormalTok{, }\FloatTok{269.8944}\NormalTok{, }\FloatTok{51.9744}\NormalTok{, }\FloatTok{366.9744}\NormalTok{,}
    \FloatTok{12.1344}\NormalTok{, }\FloatTok{6.6144}\NormalTok{, }\FloatTok{8.8944}\NormalTok{, }\FloatTok{16.8144}\NormalTok{, }\FloatTok{13.3344}\NormalTok{, }\FloatTok{24.4944}\NormalTok{, }\FloatTok{276.9744}\NormalTok{, }\FloatTok{77.4144}\NormalTok{, }\FloatTok{163.6944}\NormalTok{, }\FloatTok{297.8544}\NormalTok{, }\FloatTok{423.9744}\NormalTok{, }\FloatTok{492.8544}\NormalTok{,}
    \FloatTok{13.9344}\NormalTok{, }\FloatTok{1.9344}\NormalTok{, }\FloatTok{10.4544}\NormalTok{, }\FloatTok{10.5744}\NormalTok{, }\FloatTok{19.0944}\NormalTok{, }\FloatTok{17.6544}\NormalTok{, }\FloatTok{33.0144}\NormalTok{, }\FloatTok{86.7744}\NormalTok{, }\FloatTok{43.2144}\NormalTok{, }\FloatTok{316.0944}\NormalTok{, }\FloatTok{382.8144}\NormalTok{, }\FloatTok{351.9744}\NormalTok{,}
    \FloatTok{1.4544}\NormalTok{, }\FloatTok{136.2144}\NormalTok{, }\FloatTok{9.9744}\NormalTok{, }\FloatTok{13.4544}\NormalTok{, }\FloatTok{101.5344}\NormalTok{, }\FloatTok{18.1344}\NormalTok{, }\FloatTok{403.9344}\NormalTok{, }\FloatTok{183.0144}\NormalTok{, }\FloatTok{389.7744}\NormalTok{, }\FloatTok{70.4544}\NormalTok{, }\FloatTok{444.1344}\NormalTok{, }\FloatTok{149.2944}\NormalTok{,}
    \FloatTok{7.5744}\NormalTok{, }\FloatTok{15.3744}\NormalTok{, }\FloatTok{141.7344}\NormalTok{, }\FloatTok{15.0144}\NormalTok{, }\FloatTok{12.1344}\NormalTok{, }\FloatTok{423.4944}\NormalTok{, }\FloatTok{422.7744}\NormalTok{, }\FloatTok{94.8144}\NormalTok{, }\FloatTok{269.8944}\NormalTok{, }\FloatTok{289.2144}\NormalTok{, }\FloatTok{473.7744}\NormalTok{, }\FloatTok{364.5744}\NormalTok{,}
    \FloatTok{0.8544}\NormalTok{, }\FloatTok{25.5744}\NormalTok{, }\FloatTok{14.4144}\NormalTok{, }\FloatTok{8.4144}\NormalTok{, }\FloatTok{37.3344}\NormalTok{, }\FloatTok{37.2144}\NormalTok{, }\FloatTok{250.5744}\NormalTok{, }\FloatTok{159.3744}\NormalTok{, }\FloatTok{608.5344}\NormalTok{, }\FloatTok{466.2144}\NormalTok{, }\FloatTok{524.4144}\NormalTok{, }\FloatTok{510.4944}
\NormalTok{  ),}
  \AttributeTok{nrow =} \DecValTok{8}\NormalTok{, }\AttributeTok{byrow =} \ConstantTok{TRUE}
\NormalTok{)}

\NormalTok{induced\_true\_ }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{96}\NormalTok{) \{}
\NormalTok{  res\_ }\OtherTok{\textless{}{-}} \FunctionTok{mean}\NormalTok{(}\FunctionTok{c}\NormalTok{(induced\_replicate\_1[i], induced\_replicate\_2[i], induced\_replicate\_3[i]))}
\NormalTok{  induced\_true\_ }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(induced\_true\_, res\_)}
\NormalTok{\}}

\NormalTok{new\_non\_induced\_replicate\_1 }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}
  \FloatTok{94.6865}\NormalTok{, }\FloatTok{84.2145}\NormalTok{, }\FloatTok{58.6890}\NormalTok{, }\FloatTok{69.1610}\NormalTok{, }\FloatTok{35.1270}\NormalTok{, }\FloatTok{12.4261}\NormalTok{, }\FloatTok{19.8169}\NormalTok{, }\FloatTok{12.4261}\NormalTok{, }\FloatTok{12.4368}\NormalTok{, }\FloatTok{19.8169}\NormalTok{,}
  \FloatTok{12.4261}\NormalTok{, }\FloatTok{19.8169}\NormalTok{, }\FloatTok{12.4368}\NormalTok{, }\FloatTok{10.1149}\NormalTok{, }\FloatTok{8.6644}\NormalTok{,  }\FloatTok{38.8384}\NormalTok{, }\FloatTok{12.0117}\NormalTok{, }\FloatTok{23.1802}\NormalTok{, }\FloatTok{9.9236}\NormalTok{,  }\FloatTok{10.7153}\NormalTok{,}
  \FloatTok{55.7665}\NormalTok{, }\FloatTok{14.1476}\NormalTok{, }\FloatTok{24.8167}\NormalTok{, }\FloatTok{11.4644}\NormalTok{, }\FloatTok{21.2568}\NormalTok{, }\FloatTok{41.3144}\NormalTok{, }\FloatTok{11.8948}\NormalTok{, }\FloatTok{17.2878}\NormalTok{, }\FloatTok{21.1505}\NormalTok{, }\FloatTok{12.9894}\NormalTok{,}
  \FloatTok{20.8902}
\NormalTok{)}

\NormalTok{new\_non\_induced\_replicate\_2 }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}
  \FloatTok{88.1415}\NormalTok{, }\FloatTok{77.0150}\NormalTok{, }\FloatTok{52.1440}\NormalTok{, }\FloatTok{43.6355}\NormalTok{, }\FloatTok{35.1270}\NormalTok{, }\FloatTok{11.6132}\NormalTok{, }\FloatTok{28.8335}\NormalTok{, }\FloatTok{11.6132}\NormalTok{, }\FloatTok{13.2019}\NormalTok{, }\FloatTok{28.8335}\NormalTok{,}
  \FloatTok{11.6132}\NormalTok{, }\FloatTok{28.8335}\NormalTok{, }\FloatTok{13.2019}\NormalTok{, }\FloatTok{11.6717}\NormalTok{, }\FloatTok{10.0671}\NormalTok{, }\FloatTok{30.3106}\NormalTok{, }\FloatTok{13.4888}\NormalTok{, }\FloatTok{34.5612}\NormalTok{, }\FloatTok{12.9309}\NormalTok{, }\FloatTok{12.6759}\NormalTok{,}
  \FloatTok{42.8393}\NormalTok{, }\FloatTok{17.0753}\NormalTok{, }\FloatTok{38.7481}\NormalTok{, }\FloatTok{11.7673}\NormalTok{, }\FloatTok{24.1153}\NormalTok{, }\FloatTok{35.5229}\NormalTok{, }\FloatTok{13.7651}\NormalTok{, }\FloatTok{22.8933}\NormalTok{, }\FloatTok{25.4702}\NormalTok{, }\FloatTok{14.9234}\NormalTok{,}
  \FloatTok{29.0832}
\NormalTok{)}

\NormalTok{new\_non\_induced\_replicate\_3 }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}
  \FloatTok{64.5795}\NormalTok{, }\FloatTok{63.2705}\NormalTok{, }\FloatTok{48.2170}\NormalTok{, }\FloatTok{52.1440}\NormalTok{, }\FloatTok{27.9275}\NormalTok{, }\FloatTok{15.0881}\NormalTok{, }\FloatTok{40.0817}\NormalTok{, }\FloatTok{15.0881}\NormalTok{, }\FloatTok{13.9936}\NormalTok{, }\FloatTok{40.0817}\NormalTok{,}
  \FloatTok{15.0881}\NormalTok{, }\FloatTok{40.0817}\NormalTok{, }\FloatTok{13.9936}\NormalTok{, }\FloatTok{8.5847}\NormalTok{, }\FloatTok{13.4835}\NormalTok{, }\FloatTok{64.9266}\NormalTok{, }\FloatTok{13.2444}\NormalTok{, }\FloatTok{56.1065}\NormalTok{, }\FloatTok{10.6090}\NormalTok{, }\FloatTok{13.8660}\NormalTok{,}
  \FloatTok{69.1400}\NormalTok{, }\FloatTok{21.0974}\NormalTok{, }\FloatTok{67.0891}\NormalTok{, }\FloatTok{10.8056}\NormalTok{, }\FloatTok{25.8900}\NormalTok{, }\FloatTok{55.3361}\NormalTok{, }\FloatTok{16.4695}\NormalTok{, }\FloatTok{24.6201}\NormalTok{, }\FloatTok{42.7755}\NormalTok{, }\FloatTok{14.1317}\NormalTok{,}
  \FloatTok{49.6828}
\NormalTok{)}

\NormalTok{new\_non\_induced\_true\_ }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{31}\NormalTok{) \{}
\NormalTok{  res\_ }\OtherTok{\textless{}{-}} \FunctionTok{mean}\NormalTok{(}\FunctionTok{c}\NormalTok{(new\_non\_induced\_replicate\_1[i], new\_non\_induced\_replicate\_2[i], new\_non\_induced\_replicate\_3[i]))}
\NormalTok{  new\_non\_induced\_true\_ }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(new\_non\_induced\_true\_, res\_)}
\NormalTok{\}}

\NormalTok{new\_induced\_replicate\_1 }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}
  \FloatTok{775.3412}\NormalTok{, }\FloatTok{608.3964}\NormalTok{, }\FloatTok{376.3855}\NormalTok{, }\FloatTok{403.2684}\NormalTok{, }\FloatTok{450.2610}\NormalTok{, }\FloatTok{104.3842}\NormalTok{, }\FloatTok{610.9376}\NormalTok{, }\FloatTok{104.3842}\NormalTok{, }\FloatTok{206.0770}\NormalTok{, }\FloatTok{610.9376}\NormalTok{,}
  \FloatTok{104.3842}\NormalTok{, }\FloatTok{610.9376}\NormalTok{, }\FloatTok{206.0770}\NormalTok{, }\FloatTok{61.42746}\NormalTok{, }\FloatTok{63.9640}\NormalTok{, }\FloatTok{725.5767}\NormalTok{, }\FloatTok{182.7868}\NormalTok{, }\FloatTok{436.4094}\NormalTok{, }\FloatTok{89.5931}\NormalTok{, }\FloatTok{105.8666}\NormalTok{,}
  \FloatTok{643.6163}\NormalTok{, }\FloatTok{295.6471}\NormalTok{, }\FloatTok{536.2245}\NormalTok{, }\FloatTok{141.8066}\NormalTok{, }\FloatTok{415.8205}\NormalTok{, }\FloatTok{549.5332}\NormalTok{, }\FloatTok{258.9823}\NormalTok{, }\FloatTok{532.0408}\NormalTok{, }\FloatTok{386.370}\NormalTok{, }\FloatTok{313.6335}\NormalTok{,}
  \FloatTok{596.1610}
\NormalTok{)}

\NormalTok{new\_induced\_replicate\_2 }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}
  \FloatTok{720.8794}\NormalTok{, }\FloatTok{670.3267}\NormalTok{, }\FloatTok{402.6897}\NormalTok{, }\FloatTok{361.0000}\NormalTok{, }\FloatTok{423.5832}\NormalTok{, }\FloatTok{95.4568}\NormalTok{, }\FloatTok{353.5596}\NormalTok{, }\FloatTok{95.4568}\NormalTok{, }\FloatTok{173.0359}\NormalTok{, }\FloatTok{353.5596}\NormalTok{,}
  \FloatTok{95.4568}\NormalTok{, }\FloatTok{353.5596}\NormalTok{, }\FloatTok{173.0359}\NormalTok{, }\FloatTok{70.6842}\NormalTok{, }\FloatTok{58.2979}\NormalTok{, }\FloatTok{560.2724}\NormalTok{, }\FloatTok{235.8898}\NormalTok{, }\FloatTok{367.2965}\NormalTok{, }\FloatTok{83.7953}\NormalTok{, }\FloatTok{102.8688}\NormalTok{,}
  \FloatTok{552.6956}\NormalTok{, }\FloatTok{249.6267}\NormalTok{, }\FloatTok{461.8738}\NormalTok{, }\FloatTok{114.8928}\NormalTok{, }\FloatTok{335.8037}\NormalTok{, }\FloatTok{455.3512}\NormalTok{, }\FloatTok{205.2205}\NormalTok{, }\FloatTok{327.7658}\NormalTok{, }\FloatTok{417.4017}\NormalTok{, }\FloatTok{186.3116}\NormalTok{,}
  \FloatTok{851.0120}
\NormalTok{)}

\NormalTok{new\_induced\_replicate\_3 }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}
  \FloatTok{783.3711}\NormalTok{, }\FloatTok{690.3612}\NormalTok{, }\FloatTok{393.6819}\NormalTok{, }\FloatTok{493.6712}\NormalTok{, }\FloatTok{480.9125}\NormalTok{, }\FloatTok{86.2659}\NormalTok{, }\FloatTok{417.0393}\NormalTok{, }\FloatTok{86.2659}\NormalTok{, }\FloatTok{159.3978}\NormalTok{, }\FloatTok{417.0393}\NormalTok{,}
  \FloatTok{86.2659}\NormalTok{, }\FloatTok{417.0393}\NormalTok{, }\FloatTok{159.3978}\NormalTok{, }\FloatTok{60.1427}\NormalTok{, }\FloatTok{53.6201}\NormalTok{, }\FloatTok{512.8355}\NormalTok{, }\FloatTok{120.0977}\NormalTok{, }\FloatTok{394.4739}\NormalTok{, }\FloatTok{100.9911}\NormalTok{, }\FloatTok{112.4550}\NormalTok{,}
  \FloatTok{577.1388}\NormalTok{, }\FloatTok{243.4006}\NormalTok{, }\FloatTok{552.0697}\NormalTok{, }\FloatTok{118.0552}\NormalTok{, }\FloatTok{376.5862}\NormalTok{, }\FloatTok{513.8896}\NormalTok{, }\FloatTok{224.0635}\NormalTok{, }\FloatTok{387.4242}\NormalTok{, }\FloatTok{380.8028}\NormalTok{, }\FloatTok{221.7246}\NormalTok{,}
  \FloatTok{766.4130}
\NormalTok{)}

\NormalTok{new\_induced\_true\_ }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{31}\NormalTok{) \{}
\NormalTok{  res\_ }\OtherTok{\textless{}{-}} \FunctionTok{mean}\NormalTok{(}\FunctionTok{c}\NormalTok{(new\_induced\_replicate\_1[i], new\_induced\_replicate\_2[i], new\_induced\_replicate\_3[i]))}
\NormalTok{  new\_induced\_true\_ }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(new\_induced\_true\_, res\_)}
\NormalTok{\}}

\NormalTok{cpp\_true\_non\_induced }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(non\_induced\_true\_, new\_non\_induced\_true\_)}
\NormalTok{cpp\_true\_induced }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(induced\_true\_, new\_induced\_true\_)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mb\_cp\_df }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}
  \AttributeTok{mb\_true =} \FunctionTok{rep}\NormalTok{(mb\_true, }\DecValTok{2}\NormalTok{),}
  \AttributeTok{cpp\_true =} \FunctionTok{c}\NormalTok{(cpp\_true\_non\_induced, cpp\_true\_induced),}
  \AttributeTok{mb\_pred =} \FunctionTok{rep}\NormalTok{(mb\_pred, }\DecValTok{2}\NormalTok{),}
  \AttributeTok{cpp\_pred =} \FunctionTok{factor}\NormalTok{(}\FunctionTok{rep}\NormalTok{(cpp\_pred, }\DecValTok{2}\NormalTok{), }\AttributeTok{levels =} \FunctionTok{c}\NormalTok{(}\StringTok{"Non{-}CPP"}\NormalTok{, }\StringTok{"CPP"}\NormalTok{)),}
  \AttributeTok{cell\_group =} \FunctionTok{as.factor}\NormalTok{(}\FunctionTok{c}\NormalTok{(}
    \FunctionTok{rep}\NormalTok{(}\StringTok{"Non{-}induced"}\NormalTok{, }\FunctionTok{length}\NormalTok{(cpp\_true\_non\_induced)),}
    \FunctionTok{rep}\NormalTok{(}\StringTok{"Induced"}\NormalTok{, }\FunctionTok{length}\NormalTok{(cpp\_true\_induced))}
\NormalTok{  ))}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{melanin-induced-cells}{%
\subsection{Melanin-induced cells}\label{melanin-induced-cells}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mb\_cp\_df}\SpecialCharTok{$}\NormalTok{log\_cpp\_true }\OtherTok{\textless{}{-}} \FunctionTok{log10}\NormalTok{(mb\_cp\_df}\SpecialCharTok{$}\NormalTok{cpp\_true)}
\NormalTok{p2\_1 }\OtherTok{\textless{}{-}} \FunctionTok{ggscatter}\NormalTok{(mb\_cp\_df[mb\_cp\_df}\SpecialCharTok{$}\NormalTok{cell\_group }\SpecialCharTok{==} \StringTok{"Induced"}\NormalTok{, ],}
  \AttributeTok{x =} \StringTok{"mb\_true"}\NormalTok{, }\AttributeTok{y =} \StringTok{"log\_cpp\_true"}\NormalTok{,}
  \AttributeTok{alpha =} \FloatTok{0.7}\NormalTok{, }\AttributeTok{size =} \DecValTok{3}\NormalTok{, }\AttributeTok{stroke =} \FloatTok{0.3}\NormalTok{, }\AttributeTok{color =} \StringTok{"black"}\NormalTok{, }\AttributeTok{fill =} \StringTok{"cpp\_pred"}\NormalTok{, }\AttributeTok{shape =} \StringTok{"cpp\_pred"}\NormalTok{,}
  \AttributeTok{add =} \StringTok{"reg.line"}\NormalTok{, }\AttributeTok{conf.int =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{conf.int.level =} \FloatTok{0.95}\NormalTok{, }\AttributeTok{cor.coef =} \ConstantTok{TRUE}\NormalTok{,}
  \AttributeTok{add.params =} \FunctionTok{list}\NormalTok{(}\AttributeTok{color =} \StringTok{"grey25"}\NormalTok{),}
  \AttributeTok{cor.coeff.args =} \FunctionTok{list}\NormalTok{(}
    \AttributeTok{method =} \StringTok{"pearson"}\NormalTok{, }\AttributeTok{label.x =} \FloatTok{2.2}\NormalTok{, }\AttributeTok{label.y =} \FloatTok{2.85}\NormalTok{, }\AttributeTok{label.sep =} \StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{,}
    \AttributeTok{size =} \DecValTok{5}
\NormalTok{  )}
\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{facet\_grid}\NormalTok{(. }\SpecialCharTok{\textasciitilde{}}\NormalTok{ cpp\_pred) }\SpecialCharTok{+}
  \FunctionTok{scale\_fill\_manual}\NormalTok{(}\AttributeTok{values =} \FunctionTok{c}\NormalTok{(}\StringTok{"\#1f77b4"}\NormalTok{, }\StringTok{"\#d62728"}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{scale\_shape\_manual}\NormalTok{(}\AttributeTok{values =} \FunctionTok{c}\NormalTok{(}\DecValTok{24}\NormalTok{, }\DecValTok{21}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{scale\_y\_continuous}\NormalTok{(}
    \AttributeTok{limits =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.63}\NormalTok{, }\DecValTok{3}\NormalTok{),}
    \AttributeTok{breaks =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{, }\FunctionTok{log10}\NormalTok{(}\DecValTok{10}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{4}\NormalTok{) }\SpecialCharTok{/} \DecValTok{2}\NormalTok{)),}
    \AttributeTok{labels =} \FunctionTok{sapply}\NormalTok{(}
      \FunctionTok{c}\NormalTok{(}\DecValTok{10}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{), }\DecValTok{10}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{4}\NormalTok{) }\SpecialCharTok{/} \DecValTok{2}\NormalTok{),}
      \ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{format}\NormalTok{(x, }\AttributeTok{big.mark =} \StringTok{","}\NormalTok{, }\AttributeTok{scientific =} \ConstantTok{FALSE}\NormalTok{)}
\NormalTok{    )}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{annotation\_logticks}\NormalTok{(}\AttributeTok{sides =} \StringTok{"l"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{guides}\NormalTok{(}\AttributeTok{fill =} \StringTok{"none"}\NormalTok{, }\AttributeTok{shape =} \StringTok{"none"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_bw}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}
    \AttributeTok{panel.grid.major =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{panel.grid.minor =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{axis.text.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{17}\NormalTok{),}
    \AttributeTok{axis.text.y =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{17}\NormalTok{),}
    \AttributeTok{strip.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{20}\NormalTok{),}
    \AttributeTok{panel.border =} \FunctionTok{element\_rect}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{),}
    \AttributeTok{strip.text.y =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{axis.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{22}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{xlab}\NormalTok{(}\StringTok{"Peptide bound to mNPs (\%)"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{ylab}\NormalTok{(}\StringTok{"Peptide (pMol / 100K cells)"}\NormalTok{)}

\FunctionTok{set.seed}\NormalTok{(}\DecValTok{1}\NormalTok{)}
\NormalTok{pos }\OtherTok{\textless{}{-}} \FunctionTok{position\_jitter}\NormalTok{(}\AttributeTok{width =} \FloatTok{0.1}\NormalTok{, }\AttributeTok{seed =} \DecValTok{16}\NormalTok{)}
\NormalTok{p2\_2 }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(mb\_cp\_df[mb\_cp\_df}\SpecialCharTok{$}\NormalTok{cell\_group }\SpecialCharTok{==} \StringTok{"Induced"}\NormalTok{, ], }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ cpp\_pred, }\AttributeTok{y =}\NormalTok{ log\_cpp\_true)) }\SpecialCharTok{+}
  \FunctionTok{geom\_boxplot}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{color =}\NormalTok{ cpp\_pred), }\AttributeTok{outlier.color =} \ConstantTok{NA}\NormalTok{, }\AttributeTok{lwd =} \FloatTok{1.5}\NormalTok{, }\AttributeTok{show.legend =} \ConstantTok{FALSE}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_beeswarm}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{fill =}\NormalTok{ cpp\_pred, }\AttributeTok{shape =}\NormalTok{ cpp\_pred),}
    \AttributeTok{color =} \StringTok{"black"}\NormalTok{, }\AttributeTok{alpha =} \FloatTok{0.7}\NormalTok{, }\AttributeTok{size =} \DecValTok{3}\NormalTok{,}
    \AttributeTok{stroke =} \FloatTok{0.3}\NormalTok{, }\AttributeTok{cex =} \DecValTok{2}\NormalTok{, }\AttributeTok{priority =} \StringTok{"random"}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{stat\_compare\_means}\NormalTok{(}
    \AttributeTok{label =} \StringTok{"p.signif"}\NormalTok{, }\AttributeTok{size =} \DecValTok{5}\NormalTok{, }\AttributeTok{method =} \StringTok{"wilcox.test"}\NormalTok{, }\AttributeTok{label.x.npc =} \FloatTok{0.2}\NormalTok{,}
    \AttributeTok{label.y =} \FloatTok{2.92}\NormalTok{, }\AttributeTok{hide.ns =} \ConstantTok{TRUE}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{stat\_compare\_means}\NormalTok{(}
    \AttributeTok{label =} \StringTok{"p.format"}\NormalTok{, }\AttributeTok{size =} \DecValTok{5}\NormalTok{, }\AttributeTok{method =} \StringTok{"wilcox.test"}\NormalTok{, }\AttributeTok{label.x.npc =} \FloatTok{0.2}\NormalTok{,}
    \AttributeTok{label.y =} \FloatTok{2.82}\NormalTok{, }\AttributeTok{hide.ns =} \ConstantTok{TRUE}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{scale\_color\_manual}\NormalTok{(}\AttributeTok{values =} \FunctionTok{c}\NormalTok{(}\StringTok{"\#cae6fa"}\NormalTok{, }\StringTok{"\#f5b8b8"}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{scale\_fill\_manual}\NormalTok{(}\AttributeTok{values =} \FunctionTok{c}\NormalTok{(}\StringTok{"\#1f77b4"}\NormalTok{, }\StringTok{"\#d62728"}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{scale\_shape\_manual}\NormalTok{(}\AttributeTok{values =} \FunctionTok{c}\NormalTok{(}\DecValTok{24}\NormalTok{, }\DecValTok{21}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{guides}\NormalTok{(}\AttributeTok{fill =} \FunctionTok{guide\_legend}\NormalTok{(}\AttributeTok{override.aes =} \FunctionTok{list}\NormalTok{(}\AttributeTok{shape =} \FunctionTok{c}\NormalTok{(}\DecValTok{24}\NormalTok{, }\DecValTok{21}\NormalTok{))), }\AttributeTok{shape =} \StringTok{"none"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_y\_continuous}\NormalTok{(}
    \AttributeTok{limits =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.63}\NormalTok{, }\DecValTok{3}\NormalTok{),}
    \AttributeTok{breaks =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{, }\FunctionTok{log10}\NormalTok{(}\DecValTok{10}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{4}\NormalTok{) }\SpecialCharTok{/} \DecValTok{2}\NormalTok{)),}
    \AttributeTok{labels =} \FunctionTok{c}\NormalTok{(}\DecValTok{10}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{), }\DecValTok{10}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{4}\NormalTok{) }\SpecialCharTok{/} \DecValTok{2}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{annotation\_logticks}\NormalTok{(}\AttributeTok{sides =} \StringTok{"l"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_bw}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}
    \AttributeTok{panel.grid.major =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{panel.grid.minor =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{panel.border =} \FunctionTok{element\_rect}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{),}
    \AttributeTok{strip.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{20}\NormalTok{),}
    \AttributeTok{axis.text.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{18}\NormalTok{),}
    \AttributeTok{legend.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{15}\NormalTok{),}
    \AttributeTok{axis.title.y =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{axis.text.y =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{axis.ticks.y =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{plot.margin =} \FunctionTok{unit}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\FloatTok{1.15}\NormalTok{, }\FloatTok{0.15}\NormalTok{, }\FloatTok{0.53}\NormalTok{, }\DecValTok{0}\NormalTok{), }\StringTok{"cm"}\NormalTok{),}
    \AttributeTok{legend.position =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.5}\NormalTok{, }\FloatTok{1.05}\NormalTok{),}
    \AttributeTok{legend.direction =} \StringTok{"horizontal"}\NormalTok{,}
    \AttributeTok{legend.key =} \FunctionTok{element\_rect}\NormalTok{(}\AttributeTok{fill =} \ConstantTok{NA}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{xlab}\NormalTok{(}\StringTok{""}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{fill =} \StringTok{""}\NormalTok{, }\AttributeTok{color =} \StringTok{""}\NormalTok{, }\AttributeTok{shape =} \StringTok{""}\NormalTok{)}

\NormalTok{p2 }\OtherTok{\textless{}{-}} \FunctionTok{ggarrange}\NormalTok{(p2\_1, p2\_2, }\AttributeTok{widths =} \FunctionTok{c}\NormalTok{(}\FloatTok{2.39}\NormalTok{, }\FloatTok{1.02}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics[width=1\linewidth]{./figures/Fig 3 mb vs cpp induced cells} \end{center}

\hypertarget{non-melanin-induced-cells}{%
\subsection{Non-melanin induced cells}\label{non-melanin-induced-cells}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{p3\_1 }\OtherTok{\textless{}{-}} \FunctionTok{ggscatter}\NormalTok{(mb\_cp\_df[mb\_cp\_df}\SpecialCharTok{$}\NormalTok{cell\_group }\SpecialCharTok{==} \StringTok{"Non{-}induced"}\NormalTok{, ],}
  \AttributeTok{x =} \StringTok{"mb\_true"}\NormalTok{, }\AttributeTok{y =} \StringTok{"log\_cpp\_true"}\NormalTok{,}
  \AttributeTok{alpha =} \FloatTok{0.7}\NormalTok{, }\AttributeTok{size =} \DecValTok{3}\NormalTok{, }\AttributeTok{stroke =} \FloatTok{0.3}\NormalTok{, }\AttributeTok{color =} \StringTok{"black"}\NormalTok{, }\AttributeTok{fill =} \StringTok{"cpp\_pred"}\NormalTok{, }\AttributeTok{shape =} \StringTok{"cpp\_pred"}\NormalTok{,}
  \AttributeTok{add =} \StringTok{"reg.line"}\NormalTok{, }\AttributeTok{conf.int =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{conf.int.level =} \FloatTok{0.95}\NormalTok{, }\AttributeTok{cor.coef =} \ConstantTok{TRUE}\NormalTok{,}
  \AttributeTok{add.params =} \FunctionTok{list}\NormalTok{(}\AttributeTok{color =} \StringTok{"grey25"}\NormalTok{),}
  \AttributeTok{cor.coeff.args =} \FunctionTok{list}\NormalTok{(}
    \AttributeTok{method =} \StringTok{"pearson"}\NormalTok{, }\AttributeTok{label.x =} \FloatTok{2.2}\NormalTok{, }\AttributeTok{label.y =} \FloatTok{2.85}\NormalTok{, }\AttributeTok{label.sep =} \StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{,}
    \AttributeTok{size =} \DecValTok{5}
\NormalTok{  )}
\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{facet\_grid}\NormalTok{(. }\SpecialCharTok{\textasciitilde{}}\NormalTok{ cpp\_pred) }\SpecialCharTok{+}
  \FunctionTok{scale\_fill\_manual}\NormalTok{(}\AttributeTok{values =} \FunctionTok{c}\NormalTok{(}\StringTok{"\#1f77b4"}\NormalTok{, }\StringTok{"\#d62728"}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{scale\_shape\_manual}\NormalTok{(}\AttributeTok{values =} \FunctionTok{c}\NormalTok{(}\DecValTok{24}\NormalTok{, }\DecValTok{21}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{scale\_y\_continuous}\NormalTok{(}
    \AttributeTok{limits =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.63}\NormalTok{, }\DecValTok{3}\NormalTok{),}
    \AttributeTok{breaks =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{, }\FunctionTok{log10}\NormalTok{(}\DecValTok{10}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{4}\NormalTok{) }\SpecialCharTok{/} \DecValTok{2}\NormalTok{)),}
    \AttributeTok{labels =} \FunctionTok{sapply}\NormalTok{(}
      \FunctionTok{c}\NormalTok{(}\DecValTok{10}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{), }\DecValTok{10}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{4}\NormalTok{) }\SpecialCharTok{/} \DecValTok{2}\NormalTok{),}
      \ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{format}\NormalTok{(x, }\AttributeTok{big.mark =} \StringTok{","}\NormalTok{, }\AttributeTok{scientific =} \ConstantTok{FALSE}\NormalTok{)}
\NormalTok{    )}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{annotation\_logticks}\NormalTok{(}\AttributeTok{sides =} \StringTok{"l"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{guides}\NormalTok{(}\AttributeTok{fill =} \StringTok{"none"}\NormalTok{, }\AttributeTok{shape =} \StringTok{"none"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_bw}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}
    \AttributeTok{panel.grid.major =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{panel.grid.minor =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{axis.text.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{17}\NormalTok{),}
    \AttributeTok{axis.text.y =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{17}\NormalTok{),}
    \AttributeTok{strip.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{20}\NormalTok{),}
    \AttributeTok{panel.border =} \FunctionTok{element\_rect}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{),}
    \AttributeTok{strip.text.y =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{axis.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{22}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{xlab}\NormalTok{(}\StringTok{"Peptide bound to mNPs (\%)"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{ylab}\NormalTok{(}\StringTok{"Peptide (pMol / 100K cells)"}\NormalTok{)}

\FunctionTok{set.seed}\NormalTok{(}\DecValTok{1}\NormalTok{)}
\NormalTok{pos }\OtherTok{\textless{}{-}} \FunctionTok{position\_jitter}\NormalTok{(}\AttributeTok{width =} \FloatTok{0.1}\NormalTok{, }\AttributeTok{seed =} \DecValTok{16}\NormalTok{)}
\NormalTok{p3\_2 }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(mb\_cp\_df[mb\_cp\_df}\SpecialCharTok{$}\NormalTok{cell\_group }\SpecialCharTok{==} \StringTok{"Non{-}induced"}\NormalTok{, ], }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ cpp\_pred, }\AttributeTok{y =}\NormalTok{ log\_cpp\_true)) }\SpecialCharTok{+}
  \FunctionTok{geom\_boxplot}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{color =}\NormalTok{ cpp\_pred), }\AttributeTok{outlier.color =} \ConstantTok{NA}\NormalTok{, }\AttributeTok{lwd =} \FloatTok{1.5}\NormalTok{, }\AttributeTok{show.legend =} \ConstantTok{FALSE}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_beeswarm}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{fill =}\NormalTok{ cpp\_pred, }\AttributeTok{shape =}\NormalTok{ cpp\_pred),}
    \AttributeTok{color =} \StringTok{"black"}\NormalTok{, }\AttributeTok{alpha =} \FloatTok{0.7}\NormalTok{, }\AttributeTok{size =} \DecValTok{3}\NormalTok{,}
    \AttributeTok{stroke =} \FloatTok{0.3}\NormalTok{, }\AttributeTok{cex =} \DecValTok{2}\NormalTok{, }\AttributeTok{priority =} \StringTok{"random"}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{stat\_compare\_means}\NormalTok{(}
    \AttributeTok{label =} \StringTok{"p.signif"}\NormalTok{, }\AttributeTok{size =} \DecValTok{5}\NormalTok{, }\AttributeTok{method =} \StringTok{"wilcox.test"}\NormalTok{, }\AttributeTok{label.x.npc =} \FloatTok{0.2}\NormalTok{,}
    \AttributeTok{label.y =} \FloatTok{2.92}\NormalTok{, }\AttributeTok{hide.ns =} \ConstantTok{TRUE}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{stat\_compare\_means}\NormalTok{(}
    \AttributeTok{label =} \StringTok{"p.format"}\NormalTok{, }\AttributeTok{size =} \DecValTok{5}\NormalTok{, }\AttributeTok{method =} \StringTok{"wilcox.test"}\NormalTok{, }\AttributeTok{label.x.npc =} \FloatTok{0.2}\NormalTok{,}
    \AttributeTok{label.y =} \FloatTok{2.82}\NormalTok{, }\AttributeTok{hide.ns =} \ConstantTok{TRUE}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{scale\_color\_manual}\NormalTok{(}\AttributeTok{values =} \FunctionTok{c}\NormalTok{(}\StringTok{"\#cae6fa"}\NormalTok{, }\StringTok{"\#f5b8b8"}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{scale\_fill\_manual}\NormalTok{(}\AttributeTok{values =} \FunctionTok{c}\NormalTok{(}\StringTok{"\#1f77b4"}\NormalTok{, }\StringTok{"\#d62728"}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{scale\_shape\_manual}\NormalTok{(}\AttributeTok{values =} \FunctionTok{c}\NormalTok{(}\DecValTok{24}\NormalTok{, }\DecValTok{21}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{guides}\NormalTok{(}\AttributeTok{fill =} \FunctionTok{guide\_legend}\NormalTok{(}\AttributeTok{override.aes =} \FunctionTok{list}\NormalTok{(}\AttributeTok{shape =} \FunctionTok{c}\NormalTok{(}\DecValTok{24}\NormalTok{, }\DecValTok{21}\NormalTok{))), }\AttributeTok{shape =} \StringTok{"none"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_y\_continuous}\NormalTok{(}
    \AttributeTok{limits =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.63}\NormalTok{, }\DecValTok{3}\NormalTok{),}
    \AttributeTok{breaks =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{, }\FunctionTok{log10}\NormalTok{(}\DecValTok{10}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{4}\NormalTok{) }\SpecialCharTok{/} \DecValTok{2}\NormalTok{)),}
    \AttributeTok{labels =} \FunctionTok{c}\NormalTok{(}\DecValTok{10}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{), }\DecValTok{10}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{4}\NormalTok{) }\SpecialCharTok{/} \DecValTok{2}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{annotation\_logticks}\NormalTok{(}\AttributeTok{sides =} \StringTok{"l"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_bw}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}
    \AttributeTok{panel.grid.major =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{panel.grid.minor =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{panel.border =} \FunctionTok{element\_rect}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{),}
    \AttributeTok{strip.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{20}\NormalTok{),}
    \AttributeTok{axis.text.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{18}\NormalTok{),}
    \AttributeTok{legend.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{15}\NormalTok{),}
    \AttributeTok{axis.title.y =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{axis.text.y =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{axis.ticks.y =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{plot.margin =} \FunctionTok{unit}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\FloatTok{1.15}\NormalTok{, }\FloatTok{0.15}\NormalTok{, }\FloatTok{0.53}\NormalTok{, }\DecValTok{0}\NormalTok{), }\StringTok{"cm"}\NormalTok{),}
    \AttributeTok{legend.position =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.5}\NormalTok{, }\FloatTok{1.05}\NormalTok{),}
    \AttributeTok{legend.direction =} \StringTok{"horizontal"}\NormalTok{,}
    \AttributeTok{legend.key =} \FunctionTok{element\_rect}\NormalTok{(}\AttributeTok{fill =} \ConstantTok{NA}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{xlab}\NormalTok{(}\StringTok{""}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{fill =} \StringTok{""}\NormalTok{, }\AttributeTok{color =} \StringTok{""}\NormalTok{, }\AttributeTok{shape =} \StringTok{""}\NormalTok{)}

\NormalTok{p3 }\OtherTok{\textless{}{-}} \FunctionTok{ggarrange}\NormalTok{(p3\_1, p3\_2, }\AttributeTok{widths =} \FunctionTok{c}\NormalTok{(}\FloatTok{2.39}\NormalTok{, }\FloatTok{1.02}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics[width=1\linewidth]{./figures/Supplementary Fig 5 mb vs cpp non-induced cells} \end{center}

\hypertarget{overall-model-interpretation}{%
\section{Overall model interpretation}\label{overall-model-interpretation}}

\hypertarget{melanin-binding-regression-2}{%
\subsection{Melanin binding (regression)}\label{melanin-binding-regression-2}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Save train and test sets in csv format}
\FunctionTok{load}\NormalTok{(}\AttributeTok{file =} \StringTok{"./rdata/var\_reduct\_mb\_train\_test\_splits.RData"}\NormalTok{)}
\ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{) \{}
\NormalTok{  prefix }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"outer\_"}\NormalTok{, i)}
\NormalTok{  exp\_dir }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"/Users/renee/Downloads/melanin\_binding/"}\NormalTok{, prefix)}
  \FunctionTok{write.csv}\NormalTok{(outer\_splits[[i]]}\SpecialCharTok{$}\NormalTok{train, }\AttributeTok{file =} \FunctionTok{paste0}\NormalTok{(exp\_dir, }\StringTok{"/train\_set.csv"}\NormalTok{))}
  \FunctionTok{write.csv}\NormalTok{(outer\_splits[[i]]}\SpecialCharTok{$}\NormalTok{test, }\AttributeTok{file =} \FunctionTok{paste0}\NormalTok{(exp\_dir, }\StringTok{"/test\_set.csv"}\NormalTok{))}
\NormalTok{\}}
\NormalTok{exp\_dir }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"/Users/renee/Downloads/melanin\_binding/whole\_data\_set"}\NormalTok{)}
\FunctionTok{write.csv}\NormalTok{(mb\_data, }\AttributeTok{file =} \FunctionTok{paste0}\NormalTok{(exp\_dir, }\StringTok{"/train\_set.csv"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{h2o.init(nthreads}\OperatorTok{={-}}\DecValTok{1}\NormalTok{)}

\NormalTok{dir\_path }\OperatorTok{=} \StringTok{\textquotesingle{}/Users/renee/Downloads/melanin\_binding\textquotesingle{}}
\NormalTok{model\_names }\OperatorTok{=}\NormalTok{ [}\StringTok{\textquotesingle{}superlearner\_iter\_3\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}superlearner\_iter\_2\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}superlearner\_iter\_2\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}superlearner\_iter\_3\textquotesingle{}}\NormalTok{, }
               \StringTok{\textquotesingle{}superlearner\_iter\_3\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}superlearner\_iter\_3\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}superlearner\_iter\_3\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}superlearner\_iter\_3\textquotesingle{}}\NormalTok{, }
               \StringTok{\textquotesingle{}superlearner\_iter\_4\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}superlearner\_iter\_3\textquotesingle{}}\NormalTok{]}
\NormalTok{shap\_res }\OperatorTok{=}\NormalTok{ []}
\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{10}\NormalTok{):}
    \BuiltInTok{print}\NormalTok{(}\StringTok{\textquotesingle{}Iter \textquotesingle{}} \OperatorTok{+} \BuiltInTok{str}\NormalTok{(i }\OperatorTok{+} \DecValTok{1}\NormalTok{) }\OperatorTok{+} \StringTok{\textquotesingle{}:\textquotesingle{}}\NormalTok{)}
\NormalTok{    train }\OperatorTok{=}\NormalTok{ pd.read\_csv(dir\_path }\OperatorTok{+} \StringTok{\textquotesingle{}/outer\_\textquotesingle{}} \OperatorTok{+} \BuiltInTok{str}\NormalTok{(i }\OperatorTok{+} \DecValTok{1}\NormalTok{) }\OperatorTok{+} \StringTok{\textquotesingle{}/train\_set.csv\textquotesingle{}}\NormalTok{, index\_col}\OperatorTok{=}\DecValTok{0}\NormalTok{)}
\NormalTok{    X\_train }\OperatorTok{=}\NormalTok{ train.iloc[:, :}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\NormalTok{    test }\OperatorTok{=}\NormalTok{ pd.read\_csv(dir\_path }\OperatorTok{+} \StringTok{\textquotesingle{}/outer\_\textquotesingle{}} \OperatorTok{+} \BuiltInTok{str}\NormalTok{(i }\OperatorTok{+} \DecValTok{1}\NormalTok{) }\OperatorTok{+} \StringTok{\textquotesingle{}/test\_set.csv\textquotesingle{}}\NormalTok{, index\_col}\OperatorTok{=}\DecValTok{0}\NormalTok{)}
\NormalTok{    X\_test }\OperatorTok{=}\NormalTok{ test.iloc[:, :}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\NormalTok{    model }\OperatorTok{=}\NormalTok{ h2o.load\_model(dir\_path }\OperatorTok{+} \StringTok{\textquotesingle{}/outer\_\textquotesingle{}} \OperatorTok{+} \BuiltInTok{str}\NormalTok{(i }\OperatorTok{+} \DecValTok{1}\NormalTok{) }\OperatorTok{+} \StringTok{\textquotesingle{}/\textquotesingle{}} \OperatorTok{+}\NormalTok{ model\_names[i])}
    \KeywordTok{def}\NormalTok{ model\_predict\_(data):}
\NormalTok{        data }\OperatorTok{=}\NormalTok{ pd.DataFrame(data, columns}\OperatorTok{=}\NormalTok{X\_train.columns)}
\NormalTok{        h2o\_data }\OperatorTok{=}\NormalTok{ h2o.H2OFrame(data)}
\NormalTok{        res }\OperatorTok{=}\NormalTok{ model.predict(h2o\_data)}
\NormalTok{        res }\OperatorTok{=}\NormalTok{ res.as\_data\_frame()}
        \ControlFlowTok{return}\NormalTok{(res)}
\NormalTok{    np.random.seed(}\DecValTok{1}\NormalTok{)}
\NormalTok{    X\_train\_ }\OperatorTok{=}\NormalTok{ X\_train.iloc[np.random.choice(X\_train.shape[}\DecValTok{0}\NormalTok{], }\DecValTok{100}\NormalTok{, replace}\OperatorTok{=}\VariableTok{False}\NormalTok{), :]}
\NormalTok{    explainer }\OperatorTok{=}\NormalTok{ shap.KernelExplainer(model\_predict\_, X\_train\_, link}\OperatorTok{=}\StringTok{\textquotesingle{}identity\textquotesingle{}}\NormalTok{)}
\NormalTok{    shap\_values }\OperatorTok{=}\NormalTok{ explainer.shap\_values(X\_test, nsamples}\OperatorTok{=}\DecValTok{1000}\NormalTok{)}
\NormalTok{    shap\_res.append(shap\_values)}
\NormalTok{    h2o.remove\_all()}

\NormalTok{shap\_res }\OperatorTok{=}\NormalTok{ pd.DataFrame(np.vstack(shap\_res), columns}\OperatorTok{=}\NormalTok{X\_train.columns)}
\NormalTok{shap\_res.to\_csv(}\StringTok{\textquotesingle{}./other\_data/mb\_shap\_values\_cv\_data\_sets.csv\textquotesingle{}}\NormalTok{, index}\OperatorTok{=}\VariableTok{False}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{load}\NormalTok{(}\AttributeTok{file =} \StringTok{"./rdata/var\_reduct\_mb\_train\_test\_splits.RData"}\NormalTok{)}
\NormalTok{data }\OtherTok{\textless{}{-}} \FunctionTok{do.call}\NormalTok{(rbind, }\FunctionTok{lapply}\NormalTok{(outer\_splits, }\ControlFlowTok{function}\NormalTok{(x) x}\SpecialCharTok{$}\NormalTok{test[}\SpecialCharTok{{-}}\FunctionTok{ncol}\NormalTok{(mb\_data)]))}
\NormalTok{data }\OtherTok{\textless{}{-}} \FunctionTok{apply}\NormalTok{(data, }\DecValTok{2}\NormalTok{, }\ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{rank}\NormalTok{(x))}
\NormalTok{data }\OtherTok{\textless{}{-}} \FunctionTok{apply}\NormalTok{(data, }\DecValTok{2}\NormalTok{, }\ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{rescale}\NormalTok{(x, }\AttributeTok{to =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{100}\NormalTok{)))}
\NormalTok{shap\_values }\OtherTok{\textless{}{-}} \FunctionTok{as.matrix}\NormalTok{(}\FunctionTok{read.csv}\NormalTok{(}\StringTok{"./other\_data/mb\_shap\_values\_cv\_data\_sets.csv"}\NormalTok{, }\AttributeTok{check.names =} \ConstantTok{FALSE}\NormalTok{))}
\NormalTok{shap\_values }\OtherTok{\textless{}{-}} \FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{rescale}\NormalTok{(shap\_values, }\AttributeTok{to =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{100}\NormalTok{), }\AttributeTok{from =} \FunctionTok{range}\NormalTok{(mb\_data}\SpecialCharTok{$}\NormalTok{log\_intensity)))}

\NormalTok{var\_diff }\OtherTok{\textless{}{-}} \FunctionTok{apply}\NormalTok{(shap\_values, }\DecValTok{2}\NormalTok{, }\ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{max}\NormalTok{(x) }\SpecialCharTok{{-}} \FunctionTok{min}\NormalTok{(x))}
\NormalTok{var\_diff }\OtherTok{\textless{}{-}}\NormalTok{ var\_diff[}\FunctionTok{order}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{var\_diff)]}
\NormalTok{df }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}
  \AttributeTok{variable =} \FunctionTok{melt}\NormalTok{(shap\_values)}\SpecialCharTok{$}\NormalTok{variable,}
  \AttributeTok{shap =} \FunctionTok{melt}\NormalTok{(shap\_values)}\SpecialCharTok{$}\NormalTok{value,}
  \AttributeTok{variable\_value =} \FunctionTok{melt}\NormalTok{(data)}\SpecialCharTok{$}\NormalTok{value}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{top\_vars }\OtherTok{\textless{}{-}} \FunctionTok{names}\NormalTok{(var\_diff)[}\DecValTok{1}\SpecialCharTok{:}\DecValTok{20}\NormalTok{]}
\NormalTok{df }\OtherTok{\textless{}{-}}\NormalTok{ df[df}\SpecialCharTok{$}\NormalTok{variable }\SpecialCharTok{\%in\%}\NormalTok{ top\_vars, ]}
\NormalTok{df}\SpecialCharTok{$}\NormalTok{variable }\OtherTok{\textless{}{-}} \FunctionTok{factor}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{variable, }\AttributeTok{levels =} \FunctionTok{rev}\NormalTok{(top\_vars), }\AttributeTok{labels =} \FunctionTok{rev}\NormalTok{(top\_vars))}

\NormalTok{p1 }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(df, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ shap, }\AttributeTok{y =}\NormalTok{ variable)) }\SpecialCharTok{+}
  \FunctionTok{geom\_hline}\NormalTok{(}\AttributeTok{yintercept =}\NormalTok{ top\_vars, }\AttributeTok{linetype =} \StringTok{"dotted"}\NormalTok{, }\AttributeTok{color =} \StringTok{"grey80"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_vline}\NormalTok{(}\AttributeTok{xintercept =} \DecValTok{0}\NormalTok{, }\AttributeTok{color =} \StringTok{"grey80"}\NormalTok{, }\AttributeTok{size =} \DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{fill =}\NormalTok{ variable\_value), }\AttributeTok{color =} \StringTok{"grey30"}\NormalTok{, }\AttributeTok{shape =} \DecValTok{21}\NormalTok{, }\AttributeTok{alpha =} \FloatTok{0.3}\NormalTok{, }\AttributeTok{size =} \DecValTok{2}\NormalTok{, }\AttributeTok{position =} \StringTok{"auto"}\NormalTok{, }\AttributeTok{stroke =} \FloatTok{0.1}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_fill\_gradient2}\NormalTok{(}\AttributeTok{low =} \StringTok{"\#1f77b4"}\NormalTok{, }\AttributeTok{mid =} \StringTok{"white"}\NormalTok{, }\AttributeTok{high =} \StringTok{"\#d62728"}\NormalTok{, }\AttributeTok{midpoint =} \DecValTok{50}\NormalTok{, }\AttributeTok{breaks =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{100}\NormalTok{), }\AttributeTok{labels =} \FunctionTok{c}\NormalTok{(}\StringTok{"Low"}\NormalTok{, }\StringTok{"High"}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{theme\_bw}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}
    \AttributeTok{plot.margin =}\NormalTok{ ggplot2}\SpecialCharTok{::}\FunctionTok{margin}\NormalTok{(}\FloatTok{1.5}\NormalTok{, }\DecValTok{8}\NormalTok{, }\FloatTok{1.5}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{3}\NormalTok{),}
    \AttributeTok{panel.grid.major =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{panel.grid.minor =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{strip.background =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{panel.border =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{axis.line =} \FunctionTok{element\_line}\NormalTok{(}\AttributeTok{color =} \StringTok{"black"}\NormalTok{),}
    \AttributeTok{plot.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{hjust =} \FloatTok{0.5}\NormalTok{, }\AttributeTok{size =} \DecValTok{20}\NormalTok{),}
    \AttributeTok{axis.title.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{hjust =} \FloatTok{0.5}\NormalTok{, }\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{20}\NormalTok{),}
    \AttributeTok{axis.title.y =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{20}\NormalTok{),}
    \AttributeTok{axis.text.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{17}\NormalTok{),}
    \AttributeTok{axis.text.y =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{16}\NormalTok{),}
    \AttributeTok{legend.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{20}\NormalTok{),}
    \AttributeTok{legend.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{16}\NormalTok{),}
    \AttributeTok{legend.title.align =} \FloatTok{0.5}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{guides}\NormalTok{(}
    \AttributeTok{fill =} \FunctionTok{guide\_colourbar}\NormalTok{(}\StringTok{"Variable}\SpecialCharTok{\textbackslash{}n}\StringTok{value}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{, }\AttributeTok{ticks =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{barheight =} \DecValTok{10}\NormalTok{, }\AttributeTok{barwidth =} \FloatTok{0.5}\NormalTok{),}
    \AttributeTok{color =} \StringTok{"none"}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{xlab}\NormalTok{(}\StringTok{"SHAP value}\SpecialCharTok{\textbackslash{}n}\StringTok{(variable contribution to model prediction)"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{ylab}\NormalTok{(}\StringTok{""}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{ggtitle}\NormalTok{(}\StringTok{"Melanin binding"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics[width=1\linewidth]{./figures/Fig 4 mb} \end{center}

\hypertarget{cell-penetration-classification-2}{%
\subsection{Cell-penetration (classification)}\label{cell-penetration-classification-2}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Save train and test sets in csv format}
\FunctionTok{load}\NormalTok{(}\AttributeTok{file =} \StringTok{"./rdata/var\_reduct\_cpp\_train\_test\_splits.RData"}\NormalTok{)}
\ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{) \{}
\NormalTok{  prefix }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"outer\_"}\NormalTok{, i)}
\NormalTok{  exp\_dir }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"/Users/renee/Downloads/cell\_penetration/"}\NormalTok{, prefix)}
  \FunctionTok{write.csv}\NormalTok{(outer\_splits[[i]]}\SpecialCharTok{$}\NormalTok{train, }\AttributeTok{file =} \FunctionTok{paste0}\NormalTok{(exp\_dir, }\StringTok{"/train\_set.csv"}\NormalTok{))}
  \FunctionTok{write.csv}\NormalTok{(outer\_splits[[i]]}\SpecialCharTok{$}\NormalTok{test, }\AttributeTok{file =} \FunctionTok{paste0}\NormalTok{(exp\_dir, }\StringTok{"/test\_set.csv"}\NormalTok{))}
\NormalTok{\}}
\NormalTok{exp\_dir }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"/Users/renee/Downloads/cell\_penetration/whole\_data\_set"}\NormalTok{)}
\FunctionTok{write.csv}\NormalTok{(cpp\_data, }\AttributeTok{file =} \FunctionTok{paste0}\NormalTok{(exp\_dir, }\StringTok{"/train\_set.csv"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{h2o.init(nthreads}\OperatorTok{={-}}\DecValTok{1}\NormalTok{)}

\NormalTok{dir\_path }\OperatorTok{=} \StringTok{\textquotesingle{}/Users/renee/Downloads/cell\_penetration\textquotesingle{}}
\NormalTok{model\_names }\OperatorTok{=}\NormalTok{ [}\StringTok{\textquotesingle{}GBM\_model\_1669777615732\_57632\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}GBM\_model\_1669777615732\_225117\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}GBM\_model\_1669777615732\_387368\textquotesingle{}}\NormalTok{, }
               \StringTok{\textquotesingle{}GBM\_model\_1669777615732\_552677\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}GBM\_model\_1669777615732\_717390\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}GBM\_model\_1669777538393\_67146\textquotesingle{}}\NormalTok{,  }
               \StringTok{\textquotesingle{}GBM\_model\_1669777538393\_246060\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}GBM\_model\_1669777538393\_420437\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}GBM\_model\_1669777538393\_602358\textquotesingle{}}\NormalTok{, }
               \StringTok{\textquotesingle{}GBM\_model\_1669777538393\_782798\textquotesingle{}}\NormalTok{]}
\NormalTok{shap\_res }\OperatorTok{=}\NormalTok{ []}
\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{10}\NormalTok{):}
    \BuiltInTok{print}\NormalTok{(}\StringTok{\textquotesingle{}Iter \textquotesingle{}} \OperatorTok{+} \BuiltInTok{str}\NormalTok{(i }\OperatorTok{+} \DecValTok{1}\NormalTok{) }\OperatorTok{+} \StringTok{\textquotesingle{}:\textquotesingle{}}\NormalTok{)}
\NormalTok{    train }\OperatorTok{=}\NormalTok{ pd.read\_csv(dir\_path }\OperatorTok{+} \StringTok{\textquotesingle{}/outer\_\textquotesingle{}} \OperatorTok{+} \BuiltInTok{str}\NormalTok{(i }\OperatorTok{+} \DecValTok{1}\NormalTok{) }\OperatorTok{+} \StringTok{\textquotesingle{}/train\_set.csv\textquotesingle{}}\NormalTok{, index\_col}\OperatorTok{=}\DecValTok{0}\NormalTok{)}
\NormalTok{    X\_train }\OperatorTok{=}\NormalTok{ train.iloc[:, :}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\NormalTok{    test }\OperatorTok{=}\NormalTok{ pd.read\_csv(dir\_path }\OperatorTok{+} \StringTok{\textquotesingle{}/outer\_\textquotesingle{}} \OperatorTok{+} \BuiltInTok{str}\NormalTok{(i }\OperatorTok{+} \DecValTok{1}\NormalTok{) }\OperatorTok{+} \StringTok{\textquotesingle{}/test\_set.csv\textquotesingle{}}\NormalTok{, index\_col}\OperatorTok{=}\DecValTok{0}\NormalTok{)}
\NormalTok{    X\_test }\OperatorTok{=}\NormalTok{ test.iloc[:, :}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\NormalTok{    model }\OperatorTok{=}\NormalTok{ h2o.load\_model(dir\_path }\OperatorTok{+} \StringTok{\textquotesingle{}/outer\_\textquotesingle{}} \OperatorTok{+} \BuiltInTok{str}\NormalTok{(i }\OperatorTok{+} \DecValTok{1}\NormalTok{) }\OperatorTok{+} \StringTok{\textquotesingle{}/\textquotesingle{}} \OperatorTok{+}\NormalTok{ model\_names[i])}
    \KeywordTok{def}\NormalTok{ model\_predict\_(data):}
\NormalTok{        data }\OperatorTok{=}\NormalTok{ pd.DataFrame(data, columns}\OperatorTok{=}\NormalTok{X\_train.columns)}
\NormalTok{        h2o\_data }\OperatorTok{=}\NormalTok{ h2o.H2OFrame(data)}
\NormalTok{        res }\OperatorTok{=}\NormalTok{ model.predict(h2o\_data)}
\NormalTok{        res }\OperatorTok{=}\NormalTok{ res.as\_data\_frame().iloc[:,}\DecValTok{2}\NormalTok{]}
        \ControlFlowTok{return}\NormalTok{(res)}
\NormalTok{    np.random.seed(}\DecValTok{1}\NormalTok{)}
\NormalTok{    X\_train\_ }\OperatorTok{=}\NormalTok{ X\_train.iloc[np.random.choice(X\_train.shape[}\DecValTok{0}\NormalTok{], }\DecValTok{100}\NormalTok{, replace}\OperatorTok{=}\VariableTok{False}\NormalTok{), :]}
\NormalTok{    explainer }\OperatorTok{=}\NormalTok{ shap.KernelExplainer(model\_predict\_, X\_train\_, link}\OperatorTok{=}\StringTok{\textquotesingle{}identity\textquotesingle{}}\NormalTok{)}
\NormalTok{    shap\_values }\OperatorTok{=}\NormalTok{ explainer.shap\_values(X\_test, nsamples}\OperatorTok{=}\DecValTok{1000}\NormalTok{)}
\NormalTok{    shap\_res.append(shap\_values)}
\NormalTok{    h2o.remove\_all()}

\NormalTok{shap\_res }\OperatorTok{=}\NormalTok{ pd.DataFrame(np.vstack(shap\_res), columns}\OperatorTok{=}\NormalTok{X\_train.columns)}
\NormalTok{shap\_res.to\_csv(}\StringTok{\textquotesingle{}./other\_data/cpp\_shap\_values\_cv\_data\_sets.csv\textquotesingle{}}\NormalTok{, index}\OperatorTok{=}\VariableTok{False}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{load}\NormalTok{(}\AttributeTok{file =} \StringTok{"./rdata/var\_reduct\_cpp\_train\_test\_splits.RData"}\NormalTok{)}
\NormalTok{data }\OtherTok{\textless{}{-}} \FunctionTok{do.call}\NormalTok{(rbind, }\FunctionTok{lapply}\NormalTok{(outer\_splits, }\ControlFlowTok{function}\NormalTok{(x) x}\SpecialCharTok{$}\NormalTok{test[}\SpecialCharTok{{-}}\FunctionTok{ncol}\NormalTok{(cpp\_data)]))}
\NormalTok{data }\OtherTok{\textless{}{-}} \FunctionTok{apply}\NormalTok{(data, }\DecValTok{2}\NormalTok{, }\ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{rank}\NormalTok{(x))}
\NormalTok{data }\OtherTok{\textless{}{-}} \FunctionTok{apply}\NormalTok{(data, }\DecValTok{2}\NormalTok{, }\ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{rescale}\NormalTok{(x, }\AttributeTok{to =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{100}\NormalTok{)))}
\NormalTok{shap\_values }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\StringTok{"./other\_data/cpp\_shap\_values\_cv\_data\_sets.csv"}\NormalTok{, }\AttributeTok{check.names =} \ConstantTok{FALSE}\NormalTok{) }\SpecialCharTok{*} \DecValTok{100}

\NormalTok{var\_diff }\OtherTok{\textless{}{-}} \FunctionTok{apply}\NormalTok{(shap\_values, }\DecValTok{2}\NormalTok{, }\ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{max}\NormalTok{(x) }\SpecialCharTok{{-}} \FunctionTok{min}\NormalTok{(x))}
\NormalTok{var\_diff }\OtherTok{\textless{}{-}}\NormalTok{ var\_diff[}\FunctionTok{order}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{var\_diff)]}
\NormalTok{df }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}
  \AttributeTok{variable =} \FunctionTok{melt}\NormalTok{(shap\_values)}\SpecialCharTok{$}\NormalTok{variable,}
  \AttributeTok{shap =} \FunctionTok{melt}\NormalTok{(shap\_values)}\SpecialCharTok{$}\NormalTok{value,}
  \AttributeTok{variable\_value =} \FunctionTok{melt}\NormalTok{(data)}\SpecialCharTok{$}\NormalTok{value}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{top\_vars }\OtherTok{\textless{}{-}} \FunctionTok{names}\NormalTok{(var\_diff)[}\DecValTok{1}\SpecialCharTok{:}\DecValTok{11}\NormalTok{]}
\NormalTok{df }\OtherTok{\textless{}{-}}\NormalTok{ df[df}\SpecialCharTok{$}\NormalTok{variable }\SpecialCharTok{\%in\%}\NormalTok{ top\_vars, ]}
\NormalTok{df}\SpecialCharTok{$}\NormalTok{variable }\OtherTok{\textless{}{-}} \FunctionTok{factor}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{variable, }\AttributeTok{levels =} \FunctionTok{rev}\NormalTok{(top\_vars), }\AttributeTok{labels =} \FunctionTok{rev}\NormalTok{(top\_vars))}

\NormalTok{p2 }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(df, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ shap, }\AttributeTok{y =}\NormalTok{ variable)) }\SpecialCharTok{+}
  \FunctionTok{geom\_hline}\NormalTok{(}\AttributeTok{yintercept =}\NormalTok{ top\_vars, }\AttributeTok{linetype =} \StringTok{"dotted"}\NormalTok{, }\AttributeTok{color =} \StringTok{"grey80"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_vline}\NormalTok{(}\AttributeTok{xintercept =} \DecValTok{0}\NormalTok{, }\AttributeTok{color =} \StringTok{"grey80"}\NormalTok{, }\AttributeTok{size =} \DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{fill =}\NormalTok{ variable\_value), }\AttributeTok{color =} \StringTok{"grey30"}\NormalTok{, }\AttributeTok{shape =} \DecValTok{21}\NormalTok{, }\AttributeTok{alpha =} \FloatTok{0.5}\NormalTok{, }\AttributeTok{size =} \DecValTok{2}\NormalTok{, }\AttributeTok{position =} \StringTok{"auto"}\NormalTok{, }\AttributeTok{stroke =} \FloatTok{0.1}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_fill\_gradient2}\NormalTok{(}\AttributeTok{low =} \StringTok{"\#1f77b4"}\NormalTok{, }\AttributeTok{mid =} \StringTok{"white"}\NormalTok{, }\AttributeTok{high =} \StringTok{"\#d62728"}\NormalTok{, }\AttributeTok{midpoint =} \DecValTok{50}\NormalTok{, }\AttributeTok{breaks =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{100}\NormalTok{), }\AttributeTok{labels =} \FunctionTok{c}\NormalTok{(}\StringTok{"Low"}\NormalTok{, }\StringTok{"High"}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{theme\_bw}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}
    \AttributeTok{plot.margin =}\NormalTok{ ggplot2}\SpecialCharTok{::}\FunctionTok{margin}\NormalTok{(}\FloatTok{1.5}\NormalTok{, }\DecValTok{8}\NormalTok{, }\FloatTok{1.5}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{3}\NormalTok{),}
    \AttributeTok{panel.grid.major =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{panel.grid.minor =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{strip.background =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{panel.border =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{axis.line =} \FunctionTok{element\_line}\NormalTok{(}\AttributeTok{color =} \StringTok{"black"}\NormalTok{),}
    \AttributeTok{plot.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{hjust =} \FloatTok{0.5}\NormalTok{, }\AttributeTok{size =} \DecValTok{20}\NormalTok{),}
    \AttributeTok{axis.title.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{hjust =} \FloatTok{0.5}\NormalTok{, }\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{20}\NormalTok{),}
    \AttributeTok{axis.title.y =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{20}\NormalTok{),}
    \AttributeTok{axis.text.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{17}\NormalTok{),}
    \AttributeTok{axis.text.y =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{16}\NormalTok{),}
    \AttributeTok{legend.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{20}\NormalTok{),}
    \AttributeTok{legend.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{16}\NormalTok{),}
    \AttributeTok{legend.title.align =} \FloatTok{0.5}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{guides}\NormalTok{(}
    \AttributeTok{fill =} \FunctionTok{guide\_colourbar}\NormalTok{(}\StringTok{"Variable}\SpecialCharTok{\textbackslash{}n}\StringTok{value}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{, }\AttributeTok{ticks =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{barheight =} \DecValTok{10}\NormalTok{, }\AttributeTok{barwidth =} \FloatTok{0.5}\NormalTok{),}
    \AttributeTok{color =} \StringTok{"none"}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{xlab}\NormalTok{(}\StringTok{"SHAP value}\SpecialCharTok{\textbackslash{}n}\StringTok{(variable contribution to model prediction)"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{ylab}\NormalTok{(}\StringTok{""}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{ggtitle}\NormalTok{(}\StringTok{"Cell{-}penetration"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics[width=1\linewidth]{./figures/Fig 4 cpp} \end{center}

\hypertarget{toxicity-classification-2}{%
\subsection{Toxicity (classification)}\label{toxicity-classification-2}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Save train and test sets in csv format}
\FunctionTok{load}\NormalTok{(}\AttributeTok{file =} \StringTok{"./rdata/var\_reduct\_tx\_train\_test\_splits.RData"}\NormalTok{)}
\ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{) \{}
\NormalTok{  prefix }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"outer\_"}\NormalTok{, i)}
\NormalTok{  exp\_dir }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"/Users/renee/Downloads/toxicity/"}\NormalTok{, prefix)}
  \FunctionTok{write.csv}\NormalTok{(outer\_splits[[i]]}\SpecialCharTok{$}\NormalTok{train, }\AttributeTok{file =} \FunctionTok{paste0}\NormalTok{(exp\_dir, }\StringTok{"/train\_set.csv"}\NormalTok{))}
  \FunctionTok{write.csv}\NormalTok{(outer\_splits[[i]]}\SpecialCharTok{$}\NormalTok{test, }\AttributeTok{file =} \FunctionTok{paste0}\NormalTok{(exp\_dir, }\StringTok{"/test\_set.csv"}\NormalTok{))}
\NormalTok{\}}
\NormalTok{exp\_dir }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"/Users/renee/Downloads/toxicity/whole\_data\_set"}\NormalTok{)}
\FunctionTok{write.csv}\NormalTok{(tx\_data, }\AttributeTok{file =} \FunctionTok{paste0}\NormalTok{(exp\_dir, }\StringTok{"/train\_set.csv"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{h2o.init(nthreads}\OperatorTok{={-}}\DecValTok{1}\NormalTok{)}

\NormalTok{dir\_path }\OperatorTok{=} \StringTok{\textquotesingle{}/Users/renee/Downloads/toxicity\textquotesingle{}}
\NormalTok{model\_names }\OperatorTok{=}\NormalTok{ [}\StringTok{\textquotesingle{}superlearner\_iter\_4\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}superlearner\_iter\_3\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}superlearner\_iter\_3\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}superlearner\_iter\_3\textquotesingle{}}\NormalTok{,}
               \StringTok{\textquotesingle{}superlearner\_iter\_3\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}superlearner\_iter\_3\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}superlearner\_iter\_3\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}superlearner\_iter\_4\textquotesingle{}}\NormalTok{,}
               \StringTok{\textquotesingle{}superlearner\_iter\_3\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}superlearner\_iter\_4\textquotesingle{}}\NormalTok{]}
\NormalTok{shap\_res }\OperatorTok{=}\NormalTok{ []}
\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{10}\NormalTok{):}
    \BuiltInTok{print}\NormalTok{(}\StringTok{\textquotesingle{}Iter \textquotesingle{}} \OperatorTok{+} \BuiltInTok{str}\NormalTok{(i }\OperatorTok{+} \DecValTok{1}\NormalTok{) }\OperatorTok{+} \StringTok{\textquotesingle{}:\textquotesingle{}}\NormalTok{)}
\NormalTok{    train }\OperatorTok{=}\NormalTok{ pd.read\_csv(dir\_path }\OperatorTok{+} \StringTok{\textquotesingle{}/outer\_\textquotesingle{}} \OperatorTok{+} \BuiltInTok{str}\NormalTok{(i }\OperatorTok{+} \DecValTok{1}\NormalTok{) }\OperatorTok{+} \StringTok{\textquotesingle{}/train\_set.csv\textquotesingle{}}\NormalTok{, index\_col}\OperatorTok{=}\DecValTok{0}\NormalTok{)}
\NormalTok{    X\_train }\OperatorTok{=}\NormalTok{ train.iloc[:, :}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\NormalTok{    test }\OperatorTok{=}\NormalTok{ pd.read\_csv(dir\_path }\OperatorTok{+} \StringTok{\textquotesingle{}/outer\_\textquotesingle{}} \OperatorTok{+} \BuiltInTok{str}\NormalTok{(i }\OperatorTok{+} \DecValTok{1}\NormalTok{) }\OperatorTok{+} \StringTok{\textquotesingle{}/test\_set.csv\textquotesingle{}}\NormalTok{, index\_col}\OperatorTok{=}\DecValTok{0}\NormalTok{)}
\NormalTok{    X\_test }\OperatorTok{=}\NormalTok{ test.iloc[:, :}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\NormalTok{    model }\OperatorTok{=}\NormalTok{ h2o.load\_model(dir\_path }\OperatorTok{+} \StringTok{\textquotesingle{}/outer\_\textquotesingle{}} \OperatorTok{+} \BuiltInTok{str}\NormalTok{(i }\OperatorTok{+} \DecValTok{1}\NormalTok{) }\OperatorTok{+} \StringTok{\textquotesingle{}/\textquotesingle{}} \OperatorTok{+}\NormalTok{ model\_names[i])}
    \KeywordTok{def}\NormalTok{ model\_predict\_(data):}
\NormalTok{        data }\OperatorTok{=}\NormalTok{ pd.DataFrame(data, columns}\OperatorTok{=}\NormalTok{X\_train.columns)}
\NormalTok{        h2o\_data }\OperatorTok{=}\NormalTok{ h2o.H2OFrame(data)}
\NormalTok{        res }\OperatorTok{=}\NormalTok{ model.predict(h2o\_data)}
\NormalTok{        res }\OperatorTok{=}\NormalTok{ res.as\_data\_frame().iloc[:,}\DecValTok{2}\NormalTok{] }\CommentTok{\# 0:toxic; 1:non{-}toxic }
        \ControlFlowTok{return}\NormalTok{(res)}
\NormalTok{    np.random.seed(}\DecValTok{1}\NormalTok{)}
\NormalTok{    X\_train\_ }\OperatorTok{=}\NormalTok{ X\_train.iloc[np.random.choice(X\_train.shape[}\DecValTok{0}\NormalTok{], }\DecValTok{100}\NormalTok{, replace}\OperatorTok{=}\VariableTok{False}\NormalTok{), :]}
\NormalTok{    explainer }\OperatorTok{=}\NormalTok{ shap.KernelExplainer(model\_predict\_, X\_train\_, link}\OperatorTok{=}\StringTok{\textquotesingle{}identity\textquotesingle{}}\NormalTok{)}
\NormalTok{    shap\_values }\OperatorTok{=}\NormalTok{ explainer.shap\_values(X\_test, nsamples}\OperatorTok{=}\DecValTok{1000}\NormalTok{)}
\NormalTok{    shap\_res.append(shap\_values)}
\NormalTok{    h2o.remove\_all()}

\NormalTok{shap\_res }\OperatorTok{=}\NormalTok{ pd.DataFrame(np.vstack(shap\_res), columns}\OperatorTok{=}\NormalTok{X\_train.columns)}
\NormalTok{shap\_res.to\_csv(}\StringTok{\textquotesingle{}./other\_data/tx\_shap\_values\_cv\_data\_sets.csv\textquotesingle{}}\NormalTok{, index}\OperatorTok{=}\VariableTok{False}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{load}\NormalTok{(}\AttributeTok{file =} \StringTok{"./rdata/var\_reduct\_tx\_train\_test\_splits.RData"}\NormalTok{)}
\NormalTok{data }\OtherTok{\textless{}{-}} \FunctionTok{do.call}\NormalTok{(rbind, }\FunctionTok{lapply}\NormalTok{(outer\_splits, }\ControlFlowTok{function}\NormalTok{(x) x}\SpecialCharTok{$}\NormalTok{test[}\SpecialCharTok{{-}}\FunctionTok{ncol}\NormalTok{(tx\_data)]))}
\NormalTok{data }\OtherTok{\textless{}{-}} \FunctionTok{apply}\NormalTok{(data, }\DecValTok{2}\NormalTok{, }\ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{rank}\NormalTok{(x))}
\NormalTok{data }\OtherTok{\textless{}{-}} \FunctionTok{apply}\NormalTok{(data, }\DecValTok{2}\NormalTok{, }\ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{rescale}\NormalTok{(x, }\AttributeTok{to =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{100}\NormalTok{)))}
\NormalTok{shap\_values }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\StringTok{"./other\_data/tx\_shap\_values\_cv\_data\_sets.csv"}\NormalTok{, }\AttributeTok{check.names =} \ConstantTok{FALSE}\NormalTok{) }\SpecialCharTok{*} \DecValTok{100}

\FunctionTok{set.seed}\NormalTok{(}\DecValTok{12}\NormalTok{)}
\NormalTok{ind }\OtherTok{\textless{}{-}} \FunctionTok{sample}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(data), }\DecValTok{2500}\NormalTok{)}
\NormalTok{data }\OtherTok{\textless{}{-}}\NormalTok{ data[ind, ]}
\NormalTok{shap\_values }\OtherTok{\textless{}{-}}\NormalTok{ shap\_values[ind, ]}

\NormalTok{var\_diff }\OtherTok{\textless{}{-}} \FunctionTok{apply}\NormalTok{(shap\_values, }\DecValTok{2}\NormalTok{, }\ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{max}\NormalTok{(x) }\SpecialCharTok{{-}} \FunctionTok{min}\NormalTok{(x))}
\NormalTok{var\_diff }\OtherTok{\textless{}{-}}\NormalTok{ var\_diff[}\FunctionTok{order}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{var\_diff)]}
\NormalTok{df }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}
  \AttributeTok{variable =} \FunctionTok{melt}\NormalTok{(shap\_values)}\SpecialCharTok{$}\NormalTok{variable,}
  \AttributeTok{shap =} \FunctionTok{melt}\NormalTok{(shap\_values)}\SpecialCharTok{$}\NormalTok{value,}
  \AttributeTok{variable\_value =} \FunctionTok{melt}\NormalTok{(data)}\SpecialCharTok{$}\NormalTok{value}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{top\_vars }\OtherTok{\textless{}{-}} \FunctionTok{names}\NormalTok{(var\_diff)[}\DecValTok{1}\SpecialCharTok{:}\DecValTok{20}\NormalTok{]}
\NormalTok{df }\OtherTok{\textless{}{-}}\NormalTok{ df[df}\SpecialCharTok{$}\NormalTok{variable }\SpecialCharTok{\%in\%}\NormalTok{ top\_vars, ]}
\NormalTok{df}\SpecialCharTok{$}\NormalTok{variable }\OtherTok{\textless{}{-}} \FunctionTok{factor}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{variable, }\AttributeTok{levels =} \FunctionTok{rev}\NormalTok{(top\_vars), }\AttributeTok{labels =} \FunctionTok{rev}\NormalTok{(top\_vars))}

\NormalTok{p3 }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(df, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ shap, }\AttributeTok{y =}\NormalTok{ variable)) }\SpecialCharTok{+}
  \FunctionTok{geom\_hline}\NormalTok{(}\AttributeTok{yintercept =}\NormalTok{ top\_vars, }\AttributeTok{linetype =} \StringTok{"dotted"}\NormalTok{, }\AttributeTok{color =} \StringTok{"grey80"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_vline}\NormalTok{(}\AttributeTok{xintercept =} \DecValTok{0}\NormalTok{, }\AttributeTok{color =} \StringTok{"grey80"}\NormalTok{, }\AttributeTok{size =} \DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{fill =}\NormalTok{ variable\_value), }\AttributeTok{color =} \StringTok{"grey30"}\NormalTok{, }\AttributeTok{shape =} \DecValTok{21}\NormalTok{, }\AttributeTok{alpha =} \FloatTok{0.3}\NormalTok{, }\AttributeTok{size =} \DecValTok{2}\NormalTok{, }\AttributeTok{position =} \StringTok{"auto"}\NormalTok{, }\AttributeTok{stroke =} \FloatTok{0.1}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_fill\_gradient2}\NormalTok{(}\AttributeTok{low =} \StringTok{"\#1f77b4"}\NormalTok{, }\AttributeTok{mid =} \StringTok{"white"}\NormalTok{, }\AttributeTok{high =} \StringTok{"\#d62728"}\NormalTok{, }\AttributeTok{midpoint =} \DecValTok{50}\NormalTok{, }\AttributeTok{breaks =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{100}\NormalTok{), }\AttributeTok{labels =} \FunctionTok{c}\NormalTok{(}\StringTok{"Low"}\NormalTok{, }\StringTok{"High"}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{theme\_bw}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}
    \AttributeTok{plot.margin =}\NormalTok{ ggplot2}\SpecialCharTok{::}\FunctionTok{margin}\NormalTok{(}\FloatTok{1.5}\NormalTok{, }\DecValTok{8}\NormalTok{, }\FloatTok{1.5}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{3}\NormalTok{),}
    \AttributeTok{panel.grid.major =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{panel.grid.minor =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{strip.background =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{panel.border =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{axis.line =} \FunctionTok{element\_line}\NormalTok{(}\AttributeTok{color =} \StringTok{"black"}\NormalTok{),}
    \AttributeTok{plot.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{hjust =} \FloatTok{0.5}\NormalTok{, }\AttributeTok{size =} \DecValTok{20}\NormalTok{),}
    \AttributeTok{axis.title.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{hjust =} \FloatTok{0.5}\NormalTok{, }\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{20}\NormalTok{),}
    \AttributeTok{axis.title.y =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{20}\NormalTok{),}
    \AttributeTok{axis.text.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{17}\NormalTok{),}
    \AttributeTok{axis.text.y =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{16}\NormalTok{),}
    \AttributeTok{legend.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{20}\NormalTok{),}
    \AttributeTok{legend.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{16}\NormalTok{),}
    \AttributeTok{legend.title.align =} \FloatTok{0.5}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{guides}\NormalTok{(}
    \AttributeTok{fill =} \FunctionTok{guide\_colourbar}\NormalTok{(}\StringTok{"Variable}\SpecialCharTok{\textbackslash{}n}\StringTok{value}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{, }\AttributeTok{ticks =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{barheight =} \DecValTok{10}\NormalTok{, }\AttributeTok{barwidth =} \FloatTok{0.5}\NormalTok{),}
    \AttributeTok{color =} \StringTok{"none"}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{xlab}\NormalTok{(}\StringTok{"SHAP value}\SpecialCharTok{\textbackslash{}n}\StringTok{(variable contribution to model prediction)"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{ylab}\NormalTok{(}\StringTok{""}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{ggtitle}\NormalTok{(}\StringTok{"Non{-}toxic"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics[width=1\linewidth]{./figures/Supplementary Fig 6 tx} \end{center}

\hypertarget{multifunctional-peptide-selection}{%
\section{Multifunctional peptide selection}\label{multifunctional-peptide-selection}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{load}\NormalTok{(}\AttributeTok{file =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"./rdata/tsne\_res.RData"}\NormalTok{))}
\FunctionTok{load}\NormalTok{(}\AttributeTok{file =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"./rdata/var\_reduct\_mb\_train\_test\_splits.RData"}\NormalTok{))}
\NormalTok{tsne\_df}\SpecialCharTok{$}\NormalTok{mb\_predict }\OtherTok{\textless{}{-}} \FunctionTok{rescale}\NormalTok{(tsne\_df}\SpecialCharTok{$}\NormalTok{mb\_predict, }\AttributeTok{to =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{100}\NormalTok{), }\AttributeTok{from =} \FunctionTok{range}\NormalTok{(mb\_data}\SpecialCharTok{$}\NormalTok{log\_intensity))}
\NormalTok{tsne\_df}\SpecialCharTok{$}\NormalTok{mb\_predict[tsne\_df}\SpecialCharTok{$}\NormalTok{mb\_predict }\SpecialCharTok{\textgreater{}} \DecValTok{100}\NormalTok{] }\OtherTok{\textless{}{-}} \DecValTok{100}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tsne\_df\_ }\OtherTok{\textless{}{-}}\NormalTok{ tsne\_df[tsne\_df}\SpecialCharTok{$}\NormalTok{source }\SpecialCharTok{==} \StringTok{"Validation control"} \SpecialCharTok{|}\NormalTok{ tsne\_df}\SpecialCharTok{$}\NormalTok{source }\SpecialCharTok{==} \StringTok{"Validation set"}\NormalTok{, ]}
\NormalTok{tsne\_df\_}\SpecialCharTok{$}\NormalTok{note[tsne\_df\_}\SpecialCharTok{$}\NormalTok{note }\SpecialCharTok{==} \StringTok{"TAT"}\NormalTok{] }\OtherTok{\textless{}{-}} \ConstantTok{NA}
\NormalTok{tsne\_df\_}\SpecialCharTok{$}\NormalTok{color }\OtherTok{\textless{}{-}} \FunctionTok{factor}\NormalTok{(}\FunctionTok{sapply}\NormalTok{(tsne\_df\_}\SpecialCharTok{$}\NormalTok{note, }\ControlFlowTok{function}\NormalTok{(x) }\ControlFlowTok{if}\NormalTok{ (}\FunctionTok{is.na}\NormalTok{(x)) }\DecValTok{0} \ControlFlowTok{else} \DecValTok{1}\NormalTok{))}
\NormalTok{p }\OtherTok{\textless{}{-}} \FunctionTok{plot\_ly}\NormalTok{(tsne\_df\_, }\AttributeTok{x =} \SpecialCharTok{\textasciitilde{}}\NormalTok{in\_vitro\_mb\_value, }\AttributeTok{y =} \SpecialCharTok{\textasciitilde{}}\NormalTok{in\_vitro\_cp\_value, }\AttributeTok{z =} \SpecialCharTok{\textasciitilde{}}\NormalTok{non\_tx\_prob, }\AttributeTok{text =} \SpecialCharTok{\textasciitilde{}}\NormalTok{note, }\AttributeTok{color =} \SpecialCharTok{\textasciitilde{}}\NormalTok{color, }\AttributeTok{colors =} \FunctionTok{c}\NormalTok{(}\StringTok{"grey70"}\NormalTok{, }\StringTok{"black"}\NormalTok{), }\AttributeTok{width =} \DecValTok{700}\NormalTok{, }\AttributeTok{height =} \DecValTok{600}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{add\_trace}\NormalTok{(}
    \AttributeTok{marker =} \FunctionTok{list}\NormalTok{(}\AttributeTok{size =} \DecValTok{5}\NormalTok{, }\AttributeTok{line =} \FunctionTok{list}\NormalTok{(}\AttributeTok{color =} \StringTok{"black"}\NormalTok{, }\AttributeTok{width =} \FloatTok{0.5}\NormalTok{)),}
    \AttributeTok{type =} \StringTok{"scatter3d"}\NormalTok{, }\AttributeTok{mode =} \StringTok{"text+markers"}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{layout}\NormalTok{(}
    \AttributeTok{scene =} \FunctionTok{list}\NormalTok{(}
      \AttributeTok{xaxis =} \FunctionTok{list}\NormalTok{(}
        \AttributeTok{title =} \StringTok{"Peptide bound to mNPs (\%)"}\NormalTok{,}
        \AttributeTok{range =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{100}\NormalTok{)}
\NormalTok{      ),}
      \AttributeTok{yaxis =} \FunctionTok{list}\NormalTok{(}
        \AttributeTok{title =} \StringTok{"Peptide (pMol / 100K cells)"}\NormalTok{,}
        \AttributeTok{type =} \StringTok{"log"}\NormalTok{,}
        \AttributeTok{ticktext =} \FunctionTok{list}\NormalTok{(}
          \StringTok{""}\NormalTok{, }\StringTok{"5"}\NormalTok{, }\StringTok{""}\NormalTok{, }\StringTok{""}\NormalTok{, }\StringTok{""}\NormalTok{, }\StringTok{""}\NormalTok{, }\StringTok{"10"}\NormalTok{,}
          \StringTok{""}\NormalTok{, }\StringTok{""}\NormalTok{, }\StringTok{""}\NormalTok{, }\StringTok{"50"}\NormalTok{, }\StringTok{""}\NormalTok{, }\StringTok{""}\NormalTok{, }\StringTok{""}\NormalTok{, }\StringTok{""}\NormalTok{, }\StringTok{"100"}\NormalTok{,}
          \StringTok{""}\NormalTok{, }\StringTok{""}\NormalTok{, }\StringTok{""}\NormalTok{, }\StringTok{"500"}\NormalTok{, }\StringTok{""}\NormalTok{, }\StringTok{""}\NormalTok{, }\StringTok{""}\NormalTok{, }\StringTok{""}\NormalTok{, }\StringTok{"1,000"}
\NormalTok{        ),}
        \AttributeTok{tickvals =} \FunctionTok{list}\NormalTok{(}
          \DecValTok{4}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{6}\NormalTok{, }\DecValTok{7}\NormalTok{, }\DecValTok{8}\NormalTok{, }\DecValTok{9}\NormalTok{, }\DecValTok{10}\NormalTok{,}
          \DecValTok{20}\NormalTok{, }\DecValTok{30}\NormalTok{, }\DecValTok{40}\NormalTok{, }\DecValTok{50}\NormalTok{, }\DecValTok{60}\NormalTok{, }\DecValTok{70}\NormalTok{, }\DecValTok{80}\NormalTok{, }\DecValTok{90}\NormalTok{, }\DecValTok{100}\NormalTok{,}
          \DecValTok{200}\NormalTok{, }\DecValTok{300}\NormalTok{, }\DecValTok{400}\NormalTok{, }\DecValTok{500}\NormalTok{, }\DecValTok{600}\NormalTok{, }\DecValTok{700}\NormalTok{, }\DecValTok{800}\NormalTok{, }\DecValTok{900}\NormalTok{, }\DecValTok{1000}
\NormalTok{        ),}
        \AttributeTok{range =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.63}\NormalTok{, }\DecValTok{3}\NormalTok{)}
\NormalTok{      ),}
      \AttributeTok{zaxis =} \FunctionTok{list}\NormalTok{(}
        \AttributeTok{title =} \StringTok{"Non{-}toxic prediction"}\NormalTok{,}
        \AttributeTok{range =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{100}\NormalTok{)}
\NormalTok{      )}
\NormalTok{    ),}
    \AttributeTok{showlegend =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{autosize =} \ConstantTok{TRUE}
\NormalTok{  )}
\NormalTok{p}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics[width=1\linewidth]{./figures/Fig 4 multifunctional peptide selection} \end{center}

\hypertarget{explanation-of-hr97-predictions}{%
\section{Explanation of HR97 predictions}\label{explanation-of-hr97-predictions}}

\hypertarget{melanin-binding}{%
\subsection{Melanin binding}\label{melanin-binding}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{h2o.init(nthreads}\OperatorTok{={-}}\DecValTok{1}\NormalTok{)}

\NormalTok{dir\_path }\OperatorTok{=} \StringTok{\textquotesingle{}/Users/renee/Downloads/melanin\_binding\textquotesingle{}}
\NormalTok{model\_name }\OperatorTok{=} \StringTok{\textquotesingle{}superlearner\_iter\_3\textquotesingle{}}
\NormalTok{train }\OperatorTok{=}\NormalTok{ pd.read\_csv(dir\_path }\OperatorTok{+} \StringTok{\textquotesingle{}/whole\_data\_set/train\_set.csv\textquotesingle{}}\NormalTok{, index\_col}\OperatorTok{=}\DecValTok{0}\NormalTok{)}
\NormalTok{X\_train }\OperatorTok{=}\NormalTok{ train.iloc[:, :}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\NormalTok{X\_test }\OperatorTok{=}\NormalTok{ pd.read\_csv(}\StringTok{\textquotesingle{}./other\_data/HR97\_ml\_input.csv\textquotesingle{}}\NormalTok{, index\_col}\OperatorTok{=}\DecValTok{0}\NormalTok{).loc[:,X\_train.columns]}
\NormalTok{model }\OperatorTok{=}\NormalTok{ h2o.load\_model(dir\_path }\OperatorTok{+} \StringTok{\textquotesingle{}/whole\_data\_set/\textquotesingle{}} \OperatorTok{+}\NormalTok{ model\_name)}
\KeywordTok{def}\NormalTok{ model\_predict\_(data):}
\NormalTok{    data }\OperatorTok{=}\NormalTok{ pd.DataFrame(data, columns}\OperatorTok{=}\NormalTok{X\_train.columns)}
\NormalTok{    h2o\_data }\OperatorTok{=}\NormalTok{ h2o.H2OFrame(data)}
\NormalTok{    res }\OperatorTok{=}\NormalTok{ model.predict(h2o\_data)}
\NormalTok{    res }\OperatorTok{=}\NormalTok{ res.as\_data\_frame()}
    \ControlFlowTok{return}\NormalTok{(res)}

\NormalTok{np.random.seed(}\DecValTok{1}\NormalTok{)}
\NormalTok{X\_train\_ }\OperatorTok{=}\NormalTok{ X\_train.iloc[np.random.choice(X\_train.shape[}\DecValTok{0}\NormalTok{], }\DecValTok{100}\NormalTok{, replace}\OperatorTok{=}\VariableTok{False}\NormalTok{), :]}
\NormalTok{explainer }\OperatorTok{=}\NormalTok{ shap.KernelExplainer(model\_predict\_, X\_train\_, link}\OperatorTok{=}\StringTok{\textquotesingle{}identity\textquotesingle{}}\NormalTok{)}
\NormalTok{shap\_res }\OperatorTok{=}\NormalTok{ explainer.shap\_values(X\_test, nsamples}\OperatorTok{=}\DecValTok{1000}\NormalTok{)}
\NormalTok{h2o.remove\_all()}

\NormalTok{exp }\OperatorTok{=}\NormalTok{ shap.Explanation(shap\_res }\OperatorTok{*} \DecValTok{100} \OperatorTok{/} \FloatTok{3.89063}\NormalTok{, explainer.expected\_value, data}\OperatorTok{=}\NormalTok{X\_test.iloc[}\DecValTok{0}\NormalTok{:}\DecValTok{1}\NormalTok{, :], }\OperatorTok{\textbackslash{}}
\NormalTok{                       feature\_names}\OperatorTok{=}\NormalTok{X\_train.columns)}
                       
\NormalTok{fig, ax }\OperatorTok{=}\NormalTok{ plt.subplots(figsize}\OperatorTok{=}\NormalTok{(}\DecValTok{10}\NormalTok{, }\DecValTok{7}\NormalTok{))}
\NormalTok{shap.plots.waterfall(exp[}\DecValTok{0}\NormalTok{], max\_display}\OperatorTok{=}\DecValTok{20}\NormalTok{, show}\OperatorTok{=}\VariableTok{False}\NormalTok{)}

\NormalTok{yticklabels }\OperatorTok{=}\NormalTok{ plt.gca().get\_yticklabels()}
\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\BuiltInTok{int}\NormalTok{(}\BuiltInTok{len}\NormalTok{(yticklabels) }\OperatorTok{/} \DecValTok{2}\NormalTok{)):}
\NormalTok{    label }\OperatorTok{=}\NormalTok{ yticklabels[i]}
\NormalTok{    label\_ }\OperatorTok{=}\NormalTok{ label.get\_text().split(}\StringTok{\textquotesingle{} = \textquotesingle{}}\NormalTok{)}
    \ControlFlowTok{if} \BuiltInTok{len}\NormalTok{(label\_) }\OperatorTok{\textgreater{}} \DecValTok{1}\NormalTok{:}
\NormalTok{        yticklabels[i].set\_text(}\StringTok{\textquotesingle{} = \textquotesingle{}} \OperatorTok{+}\NormalTok{ label\_[}\DecValTok{0}\NormalTok{])}
\NormalTok{    yticklabels[}\BuiltInTok{int}\NormalTok{(i }\OperatorTok{+} \BuiltInTok{len}\NormalTok{(yticklabels) }\OperatorTok{/} \DecValTok{2}\NormalTok{)].set\_text(}\StringTok{\textquotesingle{} = \textquotesingle{}}\NormalTok{.join(label\_[::}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]))}

\NormalTok{plt.gca().set\_yticklabels(yticklabels)}
\NormalTok{fig.subplots\_adjust(left}\OperatorTok{=}\FloatTok{0.33}\NormalTok{, bottom}\OperatorTok{=}\FloatTok{0.167}\NormalTok{, right}\OperatorTok{=}\FloatTok{0.93}\NormalTok{, top}\OperatorTok{=}\FloatTok{0.920}\NormalTok{)}
\NormalTok{fig.set\_figwidth(}\DecValTok{10}\NormalTok{)}
\NormalTok{fig.set\_figheight(}\DecValTok{7}\NormalTok{)}
\NormalTok{plt.text(}\DecValTok{40}\NormalTok{, }\OperatorTok{{-}}\FloatTok{4.8}\NormalTok{, }\StringTok{\textquotesingle{}SHAP value}\CharTok{\textbackslash{}n}\StringTok{(variable contribution to model prediction)\textquotesingle{}}\NormalTok{,}
\NormalTok{         horizontalalignment}\OperatorTok{=}\StringTok{\textquotesingle{}center\textquotesingle{}}\NormalTok{, fontsize}\OperatorTok{=}\DecValTok{14}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics[width=1\linewidth]{./figures/Fig 4 HR97 mb} \end{center}

\hypertarget{cell-penetration}{%
\subsection{Cell-penetration}\label{cell-penetration}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{h2o.init(nthreads}\OperatorTok{={-}}\DecValTok{1}\NormalTok{)}

\NormalTok{dir\_path }\OperatorTok{=} \StringTok{\textquotesingle{}/Users/renee/Downloads/cell\_penetration\textquotesingle{}}
\NormalTok{model\_name }\OperatorTok{=} \StringTok{\textquotesingle{}GBM\_model\_1669777615732\_886421\textquotesingle{}}
\NormalTok{train }\OperatorTok{=}\NormalTok{ pd.read\_csv(dir\_path }\OperatorTok{+} \StringTok{\textquotesingle{}/whole\_data\_set/train\_set.csv\textquotesingle{}}\NormalTok{, index\_col}\OperatorTok{=}\DecValTok{0}\NormalTok{)}
\NormalTok{X\_train }\OperatorTok{=}\NormalTok{ train.iloc[:, :}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\NormalTok{X\_test }\OperatorTok{=}\NormalTok{ pd.read\_csv(}\StringTok{\textquotesingle{}./other\_data/HR97\_ml\_input.csv\textquotesingle{}}\NormalTok{, index\_col}\OperatorTok{=}\DecValTok{0}\NormalTok{).loc[:,X\_train.columns]}
\NormalTok{model }\OperatorTok{=}\NormalTok{ h2o.load\_model(dir\_path }\OperatorTok{+} \StringTok{\textquotesingle{}/whole\_data\_set/\textquotesingle{}} \OperatorTok{+}\NormalTok{ model\_name)}
\KeywordTok{def}\NormalTok{ model\_predict\_(data):}
\NormalTok{    data }\OperatorTok{=}\NormalTok{ pd.DataFrame(data, columns}\OperatorTok{=}\NormalTok{X\_train.columns)}
\NormalTok{    h2o\_data }\OperatorTok{=}\NormalTok{ h2o.H2OFrame(data)}
\NormalTok{    res }\OperatorTok{=}\NormalTok{ model.predict(h2o\_data)}
\NormalTok{    res }\OperatorTok{=}\NormalTok{ res.as\_data\_frame().iloc[:,}\DecValTok{2}\NormalTok{]}
    \ControlFlowTok{return}\NormalTok{(res)}

\NormalTok{np.random.seed(}\DecValTok{1}\NormalTok{)}
\NormalTok{X\_train\_ }\OperatorTok{=}\NormalTok{ X\_train.iloc[np.random.choice(X\_train.shape[}\DecValTok{0}\NormalTok{], }\DecValTok{100}\NormalTok{, replace}\OperatorTok{=}\VariableTok{False}\NormalTok{), :]}
\NormalTok{explainer }\OperatorTok{=}\NormalTok{ shap.KernelExplainer(model\_predict\_, X\_train\_, link}\OperatorTok{=}\StringTok{\textquotesingle{}identity\textquotesingle{}}\NormalTok{)}
\NormalTok{shap\_res }\OperatorTok{=}\NormalTok{ explainer.shap\_values(X\_test, nsamples}\OperatorTok{=}\DecValTok{1000}\NormalTok{)}
\NormalTok{h2o.remove\_all()}

\NormalTok{exp }\OperatorTok{=}\NormalTok{ shap.Explanation(shap\_res }\OperatorTok{*} \DecValTok{100}\NormalTok{, explainer.expected\_value }\OperatorTok{*} \DecValTok{100}\NormalTok{, data}\OperatorTok{=}\NormalTok{X\_test.iloc[}\DecValTok{0}\NormalTok{:}\DecValTok{1}\NormalTok{, :], }\OperatorTok{\textbackslash{}}
\NormalTok{                       feature\_names}\OperatorTok{=}\NormalTok{X\_train.columns)}
                       
\NormalTok{fig, ax }\OperatorTok{=}\NormalTok{ plt.subplots(figsize}\OperatorTok{=}\NormalTok{(}\DecValTok{10}\NormalTok{, }\DecValTok{5}\NormalTok{))}
\NormalTok{shap.plots.waterfall(exp[}\DecValTok{0}\NormalTok{], max\_display}\OperatorTok{=}\DecValTok{11}\NormalTok{, show}\OperatorTok{=}\VariableTok{False}\NormalTok{)}

\NormalTok{yticklabels }\OperatorTok{=}\NormalTok{ plt.gca().get\_yticklabels()}
\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\BuiltInTok{int}\NormalTok{(}\BuiltInTok{len}\NormalTok{(yticklabels) }\OperatorTok{/} \DecValTok{2}\NormalTok{)):}
\NormalTok{    label }\OperatorTok{=}\NormalTok{ yticklabels[i]}
\NormalTok{    label\_ }\OperatorTok{=}\NormalTok{ label.get\_text().split(}\StringTok{\textquotesingle{} = \textquotesingle{}}\NormalTok{)}
    \ControlFlowTok{if} \BuiltInTok{len}\NormalTok{(label\_) }\OperatorTok{\textgreater{}} \DecValTok{1}\NormalTok{:}
\NormalTok{        yticklabels[i].set\_text(}\StringTok{\textquotesingle{} = \textquotesingle{}} \OperatorTok{+}\NormalTok{ label\_[}\DecValTok{0}\NormalTok{])}
\NormalTok{    yticklabels[}\BuiltInTok{int}\NormalTok{(i }\OperatorTok{+} \BuiltInTok{len}\NormalTok{(yticklabels) }\OperatorTok{/} \DecValTok{2}\NormalTok{)].set\_text(}\StringTok{\textquotesingle{} = \textquotesingle{}}\NormalTok{.join(label\_[::}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]))}

\NormalTok{plt.gca().set\_yticklabels(yticklabels)}
\NormalTok{fig.subplots\_adjust(left}\OperatorTok{=}\FloatTok{0.32}\NormalTok{, bottom}\OperatorTok{=}\FloatTok{0.18}\NormalTok{, right}\OperatorTok{=}\FloatTok{0.927}\NormalTok{, top}\OperatorTok{=}\FloatTok{0.925}\NormalTok{)}
\NormalTok{fig.set\_figwidth(}\DecValTok{10}\NormalTok{)}
\NormalTok{fig.set\_figheight(}\DecValTok{5}\NormalTok{)}
\NormalTok{plt.text(}\DecValTok{72}\NormalTok{, }\OperatorTok{{-}}\FloatTok{3.5}\NormalTok{, }\StringTok{\textquotesingle{}SHAP value}\CharTok{\textbackslash{}n}\StringTok{(variable contribution to model prediction)\textquotesingle{}}\NormalTok{,}
\NormalTok{         horizontalalignment}\OperatorTok{=}\StringTok{\textquotesingle{}center\textquotesingle{}}\NormalTok{, fontsize}\OperatorTok{=}\DecValTok{14}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics[width=1\linewidth]{./figures/Fig 4 HR97 cpp} \end{center}

\hypertarget{toxicity}{%
\subsection{Toxicity}\label{toxicity}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{h2o.init(nthreads}\OperatorTok{={-}}\DecValTok{1}\NormalTok{)}

\NormalTok{dir\_path }\OperatorTok{=} \StringTok{\textquotesingle{}/Users/renee/Downloads/toxicity\textquotesingle{}}
\NormalTok{model\_name }\OperatorTok{=} \StringTok{\textquotesingle{}superlearner\_iter\_3\textquotesingle{}}
\NormalTok{train }\OperatorTok{=}\NormalTok{ pd.read\_csv(dir\_path }\OperatorTok{+} \StringTok{\textquotesingle{}/whole\_data\_set/train\_set.csv\textquotesingle{}}\NormalTok{, index\_col}\OperatorTok{=}\DecValTok{0}\NormalTok{)}
\NormalTok{X\_train }\OperatorTok{=}\NormalTok{ train.iloc[:, :}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\NormalTok{X\_test }\OperatorTok{=}\NormalTok{ pd.read\_csv(}\StringTok{\textquotesingle{}./other\_data/HR97\_ml\_input.csv\textquotesingle{}}\NormalTok{, index\_col}\OperatorTok{=}\DecValTok{0}\NormalTok{).loc[:,X\_train.columns]}
\NormalTok{model }\OperatorTok{=}\NormalTok{ h2o.load\_model(dir\_path }\OperatorTok{+} \StringTok{\textquotesingle{}/whole\_data\_set/\textquotesingle{}} \OperatorTok{+}\NormalTok{ model\_name)}
\KeywordTok{def}\NormalTok{ model\_predict\_(data):}
\NormalTok{    data }\OperatorTok{=}\NormalTok{ pd.DataFrame(data, columns}\OperatorTok{=}\NormalTok{X\_train.columns)}
\NormalTok{    h2o\_data }\OperatorTok{=}\NormalTok{ h2o.H2OFrame(data)}
\NormalTok{    res }\OperatorTok{=}\NormalTok{ model.predict(h2o\_data)}
\NormalTok{    res }\OperatorTok{=}\NormalTok{ res.as\_data\_frame().iloc[:,}\DecValTok{2}\NormalTok{]}
    \ControlFlowTok{return}\NormalTok{(res)}

\NormalTok{np.random.seed(}\DecValTok{1}\NormalTok{)}
\NormalTok{X\_train\_ }\OperatorTok{=}\NormalTok{ X\_train.iloc[np.random.choice(X\_train.shape[}\DecValTok{0}\NormalTok{], }\DecValTok{100}\NormalTok{, replace}\OperatorTok{=}\VariableTok{False}\NormalTok{), :]}
\NormalTok{explainer }\OperatorTok{=}\NormalTok{ shap.KernelExplainer(model\_predict\_, X\_train\_, link}\OperatorTok{=}\StringTok{\textquotesingle{}identity\textquotesingle{}}\NormalTok{)}
\NormalTok{shap\_res }\OperatorTok{=}\NormalTok{ explainer.shap\_values(X\_test, nsamples}\OperatorTok{=}\DecValTok{1000}\NormalTok{)}
\NormalTok{h2o.remove\_all()}

\NormalTok{exp }\OperatorTok{=}\NormalTok{ shap.Explanation(shap\_res }\OperatorTok{*} \DecValTok{100}\NormalTok{, explainer.expected\_value }\OperatorTok{*} \DecValTok{100}\NormalTok{, data}\OperatorTok{=}\NormalTok{X\_test.iloc[}\DecValTok{0}\NormalTok{:}\DecValTok{1}\NormalTok{, :], }\OperatorTok{\textbackslash{}}
\NormalTok{                       feature\_names}\OperatorTok{=}\NormalTok{X\_train.columns)}
                       
\NormalTok{fig, ax }\OperatorTok{=}\NormalTok{ plt.subplots(figsize}\OperatorTok{=}\NormalTok{(}\DecValTok{10}\NormalTok{, }\DecValTok{5}\NormalTok{))}
\NormalTok{shap.plots.waterfall(exp[}\DecValTok{0}\NormalTok{], max\_display}\OperatorTok{=}\DecValTok{11}\NormalTok{, show}\OperatorTok{=}\VariableTok{False}\NormalTok{)}

\NormalTok{yticklabels }\OperatorTok{=}\NormalTok{ plt.gca().get\_yticklabels()}
\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\BuiltInTok{int}\NormalTok{(}\BuiltInTok{len}\NormalTok{(yticklabels) }\OperatorTok{/} \DecValTok{2}\NormalTok{)):}
\NormalTok{    label }\OperatorTok{=}\NormalTok{ yticklabels[i]}
\NormalTok{    label\_ }\OperatorTok{=}\NormalTok{ label.get\_text().split(}\StringTok{\textquotesingle{} = \textquotesingle{}}\NormalTok{)}
    \ControlFlowTok{if} \BuiltInTok{len}\NormalTok{(label\_) }\OperatorTok{\textgreater{}} \DecValTok{1}\NormalTok{:}
\NormalTok{        yticklabels[i].set\_text(}\StringTok{\textquotesingle{} = \textquotesingle{}} \OperatorTok{+}\NormalTok{ label\_[}\DecValTok{0}\NormalTok{])}
\NormalTok{    yticklabels[}\BuiltInTok{int}\NormalTok{(i }\OperatorTok{+} \BuiltInTok{len}\NormalTok{(yticklabels) }\OperatorTok{/} \DecValTok{2}\NormalTok{)].set\_text(}\StringTok{\textquotesingle{} = \textquotesingle{}}\NormalTok{.join(label\_[::}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]))}

\NormalTok{plt.gca().set\_yticklabels(yticklabels)}
\NormalTok{fig.subplots\_adjust(left}\OperatorTok{=}\FloatTok{0.395}\NormalTok{, bottom}\OperatorTok{=}\FloatTok{0.18}\NormalTok{, right}\OperatorTok{=}\FloatTok{0.927}\NormalTok{, top}\OperatorTok{=}\FloatTok{0.925}\NormalTok{)}
\NormalTok{fig.set\_figwidth(}\DecValTok{10}\NormalTok{)}
\NormalTok{fig.set\_figheight(}\DecValTok{5}\NormalTok{)}
\NormalTok{plt.text(}\DecValTok{80}\NormalTok{, }\OperatorTok{{-}}\FloatTok{3.5}\NormalTok{, }\StringTok{\textquotesingle{}SHAP value}\CharTok{\textbackslash{}n}\StringTok{(variable contribution to model prediction)\textquotesingle{}}\NormalTok{,}
\NormalTok{         horizontalalignment}\OperatorTok{=}\StringTok{\textquotesingle{}center\textquotesingle{}}\NormalTok{, fontsize}\OperatorTok{=}\DecValTok{14}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics[width=1\linewidth]{./figures/Fig 4 HR97 tx} \end{center}

\hypertarget{peptide-design-space-visualization}{%
\section{Peptide design space visualization}\label{peptide-design-space-visualization}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{p1 }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(tsne\_df, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =} \StringTok{\textasciigrave{}}\AttributeTok{tSNE 1}\StringTok{\textasciigrave{}}\NormalTok{, }\AttributeTok{y =} \StringTok{\textasciigrave{}}\AttributeTok{tSNE 2}\StringTok{\textasciigrave{}}\NormalTok{, }\AttributeTok{fill =}\NormalTok{ source)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{color =} \StringTok{"grey30"}\NormalTok{, }\AttributeTok{shape =} \DecValTok{21}\NormalTok{, }\AttributeTok{alpha =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{size =} \FloatTok{2.5}\NormalTok{, }\AttributeTok{stroke =} \FloatTok{0.1}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_text\_repel}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{label =}\NormalTok{ note), }\AttributeTok{color =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \FloatTok{4.5}\NormalTok{, }\AttributeTok{nudge\_x =} \SpecialCharTok{{-}}\DecValTok{10}\NormalTok{, }\AttributeTok{nudge\_y =} \DecValTok{10}\NormalTok{, }\AttributeTok{point.padding =} \FloatTok{0.1}\NormalTok{, }\AttributeTok{force =} \DecValTok{100}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_fill\_manual}\NormalTok{(}\AttributeTok{values =} \FunctionTok{c}\NormalTok{(}\StringTok{"\#FF380D"}\NormalTok{, }\StringTok{"\#0DACFF"}\NormalTok{, }\StringTok{"\#7134F7"}\NormalTok{, }\StringTok{"grey90"}\NormalTok{, }\StringTok{"\#FEFA0A"}\NormalTok{, }\StringTok{"grey20"}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{theme\_bw}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}
    \AttributeTok{plot.margin =}\NormalTok{ ggplot2}\SpecialCharTok{::}\FunctionTok{margin}\NormalTok{(}\DecValTok{5}\NormalTok{, }\DecValTok{10}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{10}\NormalTok{),}
    \AttributeTok{plot.background =} \FunctionTok{element\_rect}\NormalTok{(}\AttributeTok{fill =} \StringTok{"transparent"}\NormalTok{, }\AttributeTok{color =} \ConstantTok{NA}\NormalTok{),}
    \AttributeTok{panel.background =} \FunctionTok{element\_rect}\NormalTok{(}\AttributeTok{fill =} \StringTok{"transparent"}\NormalTok{),}
    \AttributeTok{panel.grid.major =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{panel.grid.minor =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{strip.background =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{panel.border =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{axis.line =} \FunctionTok{element\_line}\NormalTok{(}\AttributeTok{color =} \StringTok{"black"}\NormalTok{),}
    \AttributeTok{plot.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{hjust =} \FloatTok{0.5}\NormalTok{, }\AttributeTok{size =} \DecValTok{16}\NormalTok{),}
    \AttributeTok{axis.title.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{hjust =} \FloatTok{0.5}\NormalTok{, }\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{14}\NormalTok{),}
    \AttributeTok{axis.title.y =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{14}\NormalTok{),}
    \AttributeTok{axis.text.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{12}\NormalTok{),}
    \AttributeTok{axis.text.y =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{12}\NormalTok{),}
    \AttributeTok{legend.title =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{legend.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{10}\NormalTok{),}
    \AttributeTok{legend.title.align =} \FloatTok{0.5}\NormalTok{,}
    \AttributeTok{legend.position =} \StringTok{"top"}\NormalTok{,}
    \AttributeTok{legend.background =} \FunctionTok{element\_rect}\NormalTok{(}\AttributeTok{fill =} \StringTok{"transparent"}\NormalTok{, }\AttributeTok{color =} \StringTok{"black"}\NormalTok{, }\AttributeTok{linetype =} \StringTok{"solid"}\NormalTok{, }\AttributeTok{size =} \FloatTok{0.1}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{guides}\NormalTok{(}\AttributeTok{fill =} \FunctionTok{guide\_legend}\NormalTok{(}\AttributeTok{nrow =} \DecValTok{2}\NormalTok{, }\AttributeTok{byrow =} \ConstantTok{TRUE}\NormalTok{))}

\NormalTok{p2 }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(tsne\_df, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =} \StringTok{\textasciigrave{}}\AttributeTok{tSNE 1}\StringTok{\textasciigrave{}}\NormalTok{, }\AttributeTok{y =} \StringTok{\textasciigrave{}}\AttributeTok{tSNE 2}\StringTok{\textasciigrave{}}\NormalTok{, }\AttributeTok{fill =}\NormalTok{ mb\_predict)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{color =} \StringTok{"grey30"}\NormalTok{, }\AttributeTok{shape =} \DecValTok{21}\NormalTok{, }\AttributeTok{alpha =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{size =} \FloatTok{2.5}\NormalTok{, }\AttributeTok{stroke =} \FloatTok{0.1}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_text\_repel}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{label =}\NormalTok{ note), }\AttributeTok{color =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \FloatTok{4.5}\NormalTok{, }\AttributeTok{nudge\_x =} \SpecialCharTok{{-}}\DecValTok{10}\NormalTok{, }\AttributeTok{nudge\_y =} \DecValTok{10}\NormalTok{, }\AttributeTok{point.padding =} \FloatTok{0.1}\NormalTok{, }\AttributeTok{force =} \DecValTok{100}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_fill\_gradient2}\NormalTok{(}\AttributeTok{low =} \StringTok{"\#0DACFF"}\NormalTok{, }\AttributeTok{mid =} \StringTok{"white"}\NormalTok{, }\AttributeTok{high =} \StringTok{"\#FF380D"}\NormalTok{, }\AttributeTok{midpoint =} \DecValTok{50}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_bw}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}
    \AttributeTok{plot.margin =}\NormalTok{ ggplot2}\SpecialCharTok{::}\FunctionTok{margin}\NormalTok{(}\DecValTok{5}\NormalTok{, }\DecValTok{10}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{10}\NormalTok{),}
    \AttributeTok{plot.background =} \FunctionTok{element\_rect}\NormalTok{(}\AttributeTok{fill =} \StringTok{"transparent"}\NormalTok{, }\AttributeTok{color =} \ConstantTok{NA}\NormalTok{),}
    \AttributeTok{panel.background =} \FunctionTok{element\_rect}\NormalTok{(}\AttributeTok{fill =} \StringTok{"transparent"}\NormalTok{),}
    \AttributeTok{panel.grid.major =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{panel.grid.minor =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{strip.background =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{panel.border =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{axis.line =} \FunctionTok{element\_line}\NormalTok{(}\AttributeTok{color =} \StringTok{"black"}\NormalTok{),}
    \AttributeTok{plot.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{hjust =} \FloatTok{0.5}\NormalTok{, }\AttributeTok{size =} \DecValTok{16}\NormalTok{),}
    \AttributeTok{axis.title.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{hjust =} \FloatTok{0.5}\NormalTok{, }\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{14}\NormalTok{),}
    \AttributeTok{axis.title.y =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{14}\NormalTok{),}
    \AttributeTok{axis.text.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{12}\NormalTok{),}
    \AttributeTok{axis.text.y =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{12}\NormalTok{),}
    \AttributeTok{legend.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{12}\NormalTok{, }\AttributeTok{angle =} \DecValTok{90}\NormalTok{),}
    \AttributeTok{legend.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{10}\NormalTok{),}
    \AttributeTok{legend.title.align =} \FloatTok{0.5}\NormalTok{,}
    \AttributeTok{legend.position =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.91}\NormalTok{, }\FloatTok{0.82}\NormalTok{),}
    \AttributeTok{legend.background =} \FunctionTok{element\_blank}\NormalTok{()}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{guides}\NormalTok{(}\AttributeTok{fill =} \FunctionTok{guide\_colorbar}\NormalTok{(}
    \AttributeTok{title =} \StringTok{"Predicted peptide }\SpecialCharTok{\textbackslash{}n}\StringTok{ bound to b{-}mNPs (\%)"}\NormalTok{,}
    \AttributeTok{title.position =} \StringTok{"left"}
\NormalTok{  )) }\SpecialCharTok{+}
  \FunctionTok{ggtitle}\NormalTok{(}\StringTok{"Melanin binding prediction"}\NormalTok{)}

\NormalTok{p3 }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(tsne\_df, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =} \StringTok{\textasciigrave{}}\AttributeTok{tSNE 1}\StringTok{\textasciigrave{}}\NormalTok{, }\AttributeTok{y =} \StringTok{\textasciigrave{}}\AttributeTok{tSNE 2}\StringTok{\textasciigrave{}}\NormalTok{, }\AttributeTok{fill =}\NormalTok{ cpp\_predict)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{color =} \StringTok{"grey30"}\NormalTok{, }\AttributeTok{shape =} \DecValTok{21}\NormalTok{, }\AttributeTok{alpha =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{size =} \FloatTok{2.5}\NormalTok{, }\AttributeTok{stroke =} \FloatTok{0.1}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_text\_repel}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{label =}\NormalTok{ note), }\AttributeTok{color =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \FloatTok{4.5}\NormalTok{, }\AttributeTok{nudge\_x =} \SpecialCharTok{{-}}\DecValTok{10}\NormalTok{, }\AttributeTok{nudge\_y =} \DecValTok{10}\NormalTok{, }\AttributeTok{point.padding =} \FloatTok{0.1}\NormalTok{, }\AttributeTok{force =} \DecValTok{100}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_fill\_manual}\NormalTok{(}\AttributeTok{values =} \FunctionTok{c}\NormalTok{(}\StringTok{"\#FF380D"}\NormalTok{, }\StringTok{"\#0DACFF"}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{theme\_bw}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}
    \AttributeTok{plot.margin =}\NormalTok{ ggplot2}\SpecialCharTok{::}\FunctionTok{margin}\NormalTok{(}\DecValTok{5}\NormalTok{, }\DecValTok{10}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{10}\NormalTok{),}
    \AttributeTok{plot.background =} \FunctionTok{element\_rect}\NormalTok{(}\AttributeTok{fill =} \StringTok{"transparent"}\NormalTok{, }\AttributeTok{color =} \ConstantTok{NA}\NormalTok{),}
    \AttributeTok{panel.background =} \FunctionTok{element\_rect}\NormalTok{(}\AttributeTok{fill =} \StringTok{"transparent"}\NormalTok{),}
    \AttributeTok{panel.grid.major =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{panel.grid.minor =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{strip.background =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{panel.border =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{axis.line =} \FunctionTok{element\_line}\NormalTok{(}\AttributeTok{color =} \StringTok{"black"}\NormalTok{),}
    \AttributeTok{plot.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{hjust =} \FloatTok{0.5}\NormalTok{, }\AttributeTok{size =} \DecValTok{16}\NormalTok{),}
    \AttributeTok{axis.title.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{hjust =} \FloatTok{0.5}\NormalTok{, }\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{14}\NormalTok{),}
    \AttributeTok{axis.title.y =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{14}\NormalTok{),}
    \AttributeTok{axis.text.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{12}\NormalTok{),}
    \AttributeTok{axis.text.y =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{12}\NormalTok{),}
    \AttributeTok{legend.title =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{legend.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{10}\NormalTok{),}
    \AttributeTok{legend.title.align =} \FloatTok{0.5}\NormalTok{,}
    \AttributeTok{legend.position =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.90}\NormalTok{, }\FloatTok{0.93}\NormalTok{),}
    \AttributeTok{legend.background =} \FunctionTok{element\_rect}\NormalTok{(}\AttributeTok{fill =} \StringTok{"transparent"}\NormalTok{, }\AttributeTok{color =} \StringTok{"black"}\NormalTok{, }\AttributeTok{linetype =} \StringTok{"solid"}\NormalTok{, }\AttributeTok{size =} \FloatTok{0.1}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{ggtitle}\NormalTok{(}\StringTok{"Cell{-}penetration prediction"}\NormalTok{)}

\NormalTok{p4 }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(tsne\_df, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =} \StringTok{\textasciigrave{}}\AttributeTok{tSNE 1}\StringTok{\textasciigrave{}}\NormalTok{, }\AttributeTok{y =} \StringTok{\textasciigrave{}}\AttributeTok{tSNE 2}\StringTok{\textasciigrave{}}\NormalTok{, }\AttributeTok{fill =}\NormalTok{ tx\_predict)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{color =} \StringTok{"grey30"}\NormalTok{, }\AttributeTok{shape =} \DecValTok{21}\NormalTok{, }\AttributeTok{alpha =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{size =} \FloatTok{2.5}\NormalTok{, }\AttributeTok{stroke =} \FloatTok{0.1}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_text\_repel}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{label =}\NormalTok{ note), }\AttributeTok{color =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \FloatTok{4.5}\NormalTok{, }\AttributeTok{nudge\_x =} \SpecialCharTok{{-}}\DecValTok{10}\NormalTok{, }\AttributeTok{nudge\_y =} \DecValTok{10}\NormalTok{, }\AttributeTok{point.padding =} \FloatTok{0.1}\NormalTok{, }\AttributeTok{force =} \DecValTok{100}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_fill\_manual}\NormalTok{(}\AttributeTok{values =} \FunctionTok{c}\NormalTok{(}\StringTok{"\#7d5ef7"}\NormalTok{, }\StringTok{"\#FF380D"}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{theme\_bw}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}
    \AttributeTok{plot.margin =}\NormalTok{ ggplot2}\SpecialCharTok{::}\FunctionTok{margin}\NormalTok{(}\DecValTok{5}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{5}\NormalTok{),}
    \AttributeTok{plot.background =} \FunctionTok{element\_rect}\NormalTok{(}\AttributeTok{fill =} \StringTok{"transparent"}\NormalTok{, }\AttributeTok{color =} \ConstantTok{NA}\NormalTok{),}
    \AttributeTok{panel.background =} \FunctionTok{element\_rect}\NormalTok{(}\AttributeTok{fill =} \StringTok{"transparent"}\NormalTok{),}
    \AttributeTok{panel.grid.major =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{panel.grid.minor =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{strip.background =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{panel.border =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{axis.line =} \FunctionTok{element\_line}\NormalTok{(}\AttributeTok{color =} \StringTok{"black"}\NormalTok{),}
    \AttributeTok{plot.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{hjust =} \FloatTok{0.5}\NormalTok{, }\AttributeTok{size =} \DecValTok{16}\NormalTok{),}
    \AttributeTok{axis.title.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{hjust =} \FloatTok{0.5}\NormalTok{, }\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{14}\NormalTok{),}
    \AttributeTok{axis.title.y =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{14}\NormalTok{),}
    \AttributeTok{axis.text.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{12}\NormalTok{),}
    \AttributeTok{axis.text.y =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{12}\NormalTok{),}
    \AttributeTok{legend.title =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{legend.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{10}\NormalTok{),}
    \AttributeTok{legend.title.align =} \FloatTok{0.5}\NormalTok{,}
    \AttributeTok{legend.position =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.90}\NormalTok{, }\FloatTok{0.93}\NormalTok{),}
    \AttributeTok{legend.background =} \FunctionTok{element\_rect}\NormalTok{(}\AttributeTok{fill =} \StringTok{"transparent"}\NormalTok{, }\AttributeTok{color =} \StringTok{"black"}\NormalTok{, }\AttributeTok{linetype =} \StringTok{"solid"}\NormalTok{, }\AttributeTok{size =} \FloatTok{0.1}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{ggtitle}\NormalTok{(}\StringTok{"Non{-}toxic prediction"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{combined }\OtherTok{\textless{}{-}} \FunctionTok{plot\_grid}\NormalTok{(p1,}
  \FunctionTok{plot\_grid}\NormalTok{(}\ConstantTok{NULL}\NormalTok{, p2, }\AttributeTok{nrow =} \DecValTok{2}\NormalTok{, }\AttributeTok{rel\_heights =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.08}\NormalTok{, }\FloatTok{0.85}\NormalTok{)),}
\NormalTok{  p3, p4,}
  \AttributeTok{nrow =} \DecValTok{2}\NormalTok{, }\AttributeTok{rel\_heights =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.48}\NormalTok{, }\FloatTok{0.45}\NormalTok{),}
  \AttributeTok{labels =} \FunctionTok{c}\NormalTok{(}\StringTok{"a"}\NormalTok{, }\StringTok{"b"}\NormalTok{, }\StringTok{"c"}\NormalTok{, }\StringTok{"d"}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics[width=1\linewidth]{./figures/Fig 5 peptide design space} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sessionInfo}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## R version 4.2.2 (2022-10-31)
## Platform: x86_64-apple-darwin17.0 (64-bit)
## Running under: macOS Big Sur ... 10.16
## 
## Matrix products: default
## BLAS:   /Library/Frameworks/R.framework/Versions/4.2/Resources/lib/libRblas.0.dylib
## LAPACK: /Library/Frameworks/R.framework/Versions/4.2/Resources/lib/libRlapack.dylib
## 
## locale:
## [1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8
## 
## attached base packages:
## [1] stats     graphics  grDevices utils     datasets  methods   base     
## 
## other attached packages:
##  [1] ggrepel_0.9.1    plotly_4.10.0    cowplot_1.1.1    ggforce_0.3.4   
##  [5] scales_1.2.1     reshape2_1.4.4   reticulate_1.25  ggbeeswarm_0.6.0
##  [9] ggpubr_0.4.0     ggplot2_3.3.6    h2o_3.38.0.2    
## 
## loaded via a namespace (and not attached):
##  [1] httr_1.4.4        tidyr_1.2.0       jsonlite_1.8.0    viridisLite_0.4.1
##  [5] carData_3.0-5     R.utils_2.12.0    here_1.0.1        assertthat_0.2.1 
##  [9] vipor_0.4.5       yaml_2.3.5        pillar_1.8.1      backports_1.4.1  
## [13] lattice_0.20-45   glue_1.6.2        digest_0.6.29     ggsignif_0.6.3   
## [17] polyclip_1.10-0   colorspace_2.0-3  htmltools_0.5.3   Matrix_1.5-1     
## [21] R.oo_1.25.0       plyr_1.8.7        pkgconfig_2.0.3   broom_1.0.0      
## [25] bookdown_0.28     purrr_0.3.4       tweenr_2.0.1      tibble_3.1.8     
## [29] styler_1.8.0      generics_0.1.3    farver_2.1.1      car_3.1-0        
## [33] withr_2.5.0       lazyeval_0.2.2    cli_3.3.0         magrittr_2.0.3   
## [37] evaluate_0.16     R.methodsS3_1.8.2 fansi_1.0.3       R.cache_0.16.0   
## [41] MASS_7.3-58.1     rstatix_0.7.0     beeswarm_0.4.0    tools_4.2.2      
## [45] data.table_1.14.2 lifecycle_1.0.1   stringr_1.4.1     munsell_0.5.0    
## [49] compiler_4.2.2    rlang_1.0.4       grid_4.2.2        RCurl_1.98-1.8   
## [53] rstudioapi_0.14   htmlwidgets_1.5.4 bitops_1.0-7      rmarkdown_2.16   
## [57] gtable_0.3.0      codetools_0.2-18  abind_1.4-5       DBI_1.1.3        
## [61] R6_2.5.1          knitr_1.40        dplyr_1.0.9       fastmap_1.1.0    
## [65] utf8_1.2.2        rprojroot_2.0.3   stringi_1.7.8     Rcpp_1.0.9       
## [69] vctrs_0.4.1       png_0.1-7         tidyselect_1.1.2  xfun_0.32
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{session\_info.show()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## -----
## h2o                 3.38.0.2
## matplotlib          3.6.2
## numpy               1.23.5
## pandas              1.5.2
## session_info        1.0.0
## shap                0.41.0
## -----
## Python 3.8.15 | packaged by conda-forge | (default, Nov 22 2022, 09:04:40) [Clang 14.0.6 ]
## macOS-10.16-x86_64-i386-64bit
## -----
## Session information updated at 2023-03-12 23:18
\end{verbatim}

\hypertarget{05_adversarial_computational_control}{%
\chapter{Adversarial computational control}\label{05_adversarial_computational_control}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(h2o)}
\FunctionTok{library}\NormalTok{(MLmetrics)}
\FunctionTok{library}\NormalTok{(mltools)}
\FunctionTok{library}\NormalTok{(scales)}
\FunctionTok{library}\NormalTok{(enrichvs)}
\FunctionTok{library}\NormalTok{(rlist)}
\FunctionTok{library}\NormalTok{(stringr)}
\FunctionTok{library}\NormalTok{(digest)}
\FunctionTok{library}\NormalTok{(DT)}
\FunctionTok{library}\NormalTok{(reshape2)}
\FunctionTok{library}\NormalTok{(ggplot2)}
\FunctionTok{library}\NormalTok{(ggforce)}
\FunctionTok{library}\NormalTok{(reticulate)}
\FunctionTok{use\_condaenv}\NormalTok{(}\StringTok{"/Users/renee/Library/r{-}miniconda/envs/peptide\_engineering/bin/python"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{general-codefunctions-1}{%
\section{General code/functions}\label{general-codefunctions-1}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# h2o.init(nthreads={-}1, max\_mem\_size=\textquotesingle{}100G\textquotesingle{}, port=54321)}
\FunctionTok{h2o.init}\NormalTok{(}\AttributeTok{nthreads =} \SpecialCharTok{{-}}\DecValTok{1}\NormalTok{)}
\FunctionTok{h2o.removeAll}\NormalTok{()}
\CommentTok{\# DeepLearning Grid 1}
\NormalTok{deeplearning\_params\_1 }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}
  \AttributeTok{activation =} \StringTok{"RectifierWithDropout"}\NormalTok{,}
  \AttributeTok{epochs =} \DecValTok{10000}\NormalTok{, }\CommentTok{\# early stopping}
  \AttributeTok{epsilon =} \FunctionTok{c}\NormalTok{(}\FloatTok{1e{-}6}\NormalTok{, }\FloatTok{1e{-}7}\NormalTok{, }\FloatTok{1e{-}8}\NormalTok{, }\FloatTok{1e{-}9}\NormalTok{),}
  \AttributeTok{hidden =} \FunctionTok{list}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{50}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\DecValTok{200}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\DecValTok{500}\NormalTok{)),}
  \AttributeTok{hidden\_dropout\_ratios =} \FunctionTok{list}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\FloatTok{0.1}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\FloatTok{0.2}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\FloatTok{0.3}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\FloatTok{0.4}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\FloatTok{0.5}\NormalTok{)),}
  \AttributeTok{input\_dropout\_ratio =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FloatTok{0.05}\NormalTok{, }\FloatTok{0.1}\NormalTok{, }\FloatTok{0.15}\NormalTok{, }\FloatTok{0.2}\NormalTok{),}
  \AttributeTok{rho =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.9}\NormalTok{, }\FloatTok{0.95}\NormalTok{, }\FloatTok{0.99}\NormalTok{)}
\NormalTok{)}
\CommentTok{\# DeepLearning Grid 2}
\NormalTok{deeplearning\_params\_2 }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}
  \AttributeTok{activation =} \StringTok{"RectifierWithDropout"}\NormalTok{,}
  \AttributeTok{epochs =} \DecValTok{10000}\NormalTok{, }\CommentTok{\# early stopping}
  \AttributeTok{epsilon =} \FunctionTok{c}\NormalTok{(}\FloatTok{1e{-}6}\NormalTok{, }\FloatTok{1e{-}7}\NormalTok{, }\FloatTok{1e{-}8}\NormalTok{, }\FloatTok{1e{-}9}\NormalTok{),}
  \AttributeTok{hidden =} \FunctionTok{list}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{50}\NormalTok{, }\DecValTok{50}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\DecValTok{200}\NormalTok{, }\DecValTok{200}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\DecValTok{500}\NormalTok{, }\DecValTok{500}\NormalTok{)),}
  \AttributeTok{hidden\_dropout\_ratios =} \FunctionTok{list}\NormalTok{(}
    \FunctionTok{c}\NormalTok{(}\FloatTok{0.1}\NormalTok{, }\FloatTok{0.1}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\FloatTok{0.2}\NormalTok{, }\FloatTok{0.2}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\FloatTok{0.3}\NormalTok{, }\FloatTok{0.3}\NormalTok{),}
    \FunctionTok{c}\NormalTok{(}\FloatTok{0.4}\NormalTok{, }\FloatTok{0.4}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\FloatTok{0.5}\NormalTok{, }\FloatTok{0.5}\NormalTok{)}
\NormalTok{  ),}
  \AttributeTok{input\_dropout\_ratio =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FloatTok{0.05}\NormalTok{, }\FloatTok{0.1}\NormalTok{, }\FloatTok{0.15}\NormalTok{, }\FloatTok{0.2}\NormalTok{),}
  \AttributeTok{rho =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.9}\NormalTok{, }\FloatTok{0.95}\NormalTok{, }\FloatTok{0.99}\NormalTok{)}
\NormalTok{)}
\CommentTok{\# DeepLearning Grid 3}
\NormalTok{deeplearning\_params\_3 }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}
  \AttributeTok{activation =} \StringTok{"RectifierWithDropout"}\NormalTok{,}
  \AttributeTok{epochs =} \DecValTok{10000}\NormalTok{, }\CommentTok{\# early stopping}
  \AttributeTok{epsilon =} \FunctionTok{c}\NormalTok{(}\FloatTok{1e{-}6}\NormalTok{, }\FloatTok{1e{-}7}\NormalTok{, }\FloatTok{1e{-}8}\NormalTok{, }\FloatTok{1e{-}9}\NormalTok{),}
  \AttributeTok{hidden =} \FunctionTok{list}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{50}\NormalTok{, }\DecValTok{50}\NormalTok{, }\DecValTok{50}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\DecValTok{200}\NormalTok{, }\DecValTok{200}\NormalTok{, }\DecValTok{200}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\DecValTok{500}\NormalTok{, }\DecValTok{500}\NormalTok{, }\DecValTok{500}\NormalTok{)),}
  \AttributeTok{hidden\_dropout\_ratios =} \FunctionTok{list}\NormalTok{(}
    \FunctionTok{c}\NormalTok{(}\FloatTok{0.1}\NormalTok{, }\FloatTok{0.1}\NormalTok{, }\FloatTok{0.1}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\FloatTok{0.2}\NormalTok{, }\FloatTok{0.2}\NormalTok{, }\FloatTok{0.2}\NormalTok{),}
    \FunctionTok{c}\NormalTok{(}\FloatTok{0.3}\NormalTok{, }\FloatTok{0.3}\NormalTok{, }\FloatTok{0.3}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\FloatTok{0.4}\NormalTok{, }\FloatTok{0.4}\NormalTok{, }\FloatTok{0.4}\NormalTok{),}
    \FunctionTok{c}\NormalTok{(}\FloatTok{0.5}\NormalTok{, }\FloatTok{0.5}\NormalTok{, }\FloatTok{0.5}\NormalTok{)}
\NormalTok{  ),}
  \AttributeTok{input\_dropout\_ratio =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FloatTok{0.05}\NormalTok{, }\FloatTok{0.1}\NormalTok{, }\FloatTok{0.15}\NormalTok{, }\FloatTok{0.2}\NormalTok{),}
  \AttributeTok{rho =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.9}\NormalTok{, }\FloatTok{0.95}\NormalTok{, }\FloatTok{0.99}\NormalTok{)}
\NormalTok{)}
\CommentTok{\# GBM}
\NormalTok{gbm\_params }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}
  \AttributeTok{col\_sample\_rate =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.4}\NormalTok{, }\FloatTok{0.7}\NormalTok{, }\FloatTok{1.0}\NormalTok{),}
  \AttributeTok{col\_sample\_rate\_per\_tree =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.4}\NormalTok{, }\FloatTok{0.7}\NormalTok{, }\FloatTok{1.0}\NormalTok{),}
  \AttributeTok{learn\_rate =} \FloatTok{0.1}\NormalTok{,}
  \AttributeTok{max\_depth =} \FunctionTok{c}\NormalTok{(}\DecValTok{3}\NormalTok{, }\DecValTok{4}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{6}\NormalTok{, }\DecValTok{7}\NormalTok{, }\DecValTok{8}\NormalTok{, }\DecValTok{9}\NormalTok{, }\DecValTok{10}\NormalTok{, }\DecValTok{11}\NormalTok{, }\DecValTok{12}\NormalTok{, }\DecValTok{13}\NormalTok{, }\DecValTok{14}\NormalTok{, }\DecValTok{15}\NormalTok{, }\DecValTok{16}\NormalTok{, }\DecValTok{17}\NormalTok{),}
  \AttributeTok{min\_rows =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{10}\NormalTok{, }\DecValTok{15}\NormalTok{, }\DecValTok{30}\NormalTok{, }\DecValTok{100}\NormalTok{),}
  \AttributeTok{min\_split\_improvement =} \FunctionTok{c}\NormalTok{(}\FloatTok{1e{-}4}\NormalTok{, }\FloatTok{1e{-}5}\NormalTok{),}
  \AttributeTok{ntrees =} \DecValTok{10000}\NormalTok{, }\CommentTok{\# early stopping}
  \AttributeTok{sample\_rate =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.5}\NormalTok{, }\FloatTok{0.6}\NormalTok{, }\FloatTok{0.7}\NormalTok{, }\FloatTok{0.8}\NormalTok{, }\FloatTok{0.9}\NormalTok{, }\FloatTok{1.0}\NormalTok{)}
\NormalTok{)}
\CommentTok{\# XGBoost}
\NormalTok{xgboost\_params }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}
  \AttributeTok{booster =} \FunctionTok{c}\NormalTok{(}\StringTok{"gbtree"}\NormalTok{, }\StringTok{"dart"}\NormalTok{),}
  \AttributeTok{col\_sample\_rate =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.6}\NormalTok{, }\FloatTok{0.8}\NormalTok{, }\FloatTok{1.0}\NormalTok{),}
  \AttributeTok{col\_sample\_rate\_per\_tree =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.7}\NormalTok{, }\FloatTok{0.8}\NormalTok{, }\FloatTok{0.9}\NormalTok{, }\FloatTok{1.0}\NormalTok{),}
  \AttributeTok{max\_depth =} \FunctionTok{c}\NormalTok{(}\DecValTok{5}\NormalTok{, }\DecValTok{10}\NormalTok{, }\DecValTok{15}\NormalTok{, }\DecValTok{20}\NormalTok{),}
  \AttributeTok{min\_rows =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.01}\NormalTok{, }\FloatTok{0.1}\NormalTok{, }\FloatTok{1.0}\NormalTok{, }\FloatTok{3.0}\NormalTok{, }\FloatTok{5.0}\NormalTok{, }\FloatTok{10.0}\NormalTok{, }\FloatTok{15.0}\NormalTok{, }\FloatTok{20.0}\NormalTok{),}
  \AttributeTok{ntrees =} \DecValTok{10000}\NormalTok{, }\CommentTok{\# early stopping}
  \AttributeTok{reg\_alpha =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.001}\NormalTok{, }\FloatTok{0.01}\NormalTok{, }\FloatTok{0.1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{10}\NormalTok{, }\DecValTok{100}\NormalTok{),}
  \AttributeTok{reg\_lambda =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.001}\NormalTok{, }\FloatTok{0.01}\NormalTok{, }\FloatTok{0.1}\NormalTok{, }\FloatTok{0.5}\NormalTok{, }\DecValTok{1}\NormalTok{),}
  \AttributeTok{sample\_rate =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.6}\NormalTok{, }\FloatTok{0.8}\NormalTok{, }\FloatTok{1.0}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{balanced\_accuracy }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(y\_pred, y\_true) \{}
  \FunctionTok{return}\NormalTok{(}\FunctionTok{mean}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\FunctionTok{Sensitivity}\NormalTok{(y\_pred, y\_true), }\FunctionTok{Specificity}\NormalTok{(y\_pred, y\_true)), }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{))}
\NormalTok{\}}

\NormalTok{sem }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{) }\FunctionTok{sd}\NormalTok{(x, na.rm) }\SpecialCharTok{/} \FunctionTok{sqrt}\NormalTok{(}\FunctionTok{length}\NormalTok{(}\FunctionTok{na.omit}\NormalTok{(x)))}

\NormalTok{statistical\_testing }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(data, metric\_vec, decreasing\_vec, }\AttributeTok{p\_value\_threshold =} \FloatTok{0.05}\NormalTok{, }\AttributeTok{num\_entries =} \DecValTok{10}\NormalTok{,}
                                \AttributeTok{output\_path =} \ConstantTok{NULL}\NormalTok{) \{}
  \ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(metric\_vec)) \{}
\NormalTok{    metric }\OtherTok{\textless{}{-}}\NormalTok{ metric\_vec[i]}
\NormalTok{    ranked\_models }\OtherTok{\textless{}{-}} \FunctionTok{rownames}\NormalTok{(data[}\FunctionTok{order}\NormalTok{(data[, }\FunctionTok{paste}\NormalTok{(metric, }\StringTok{"mean"}\NormalTok{)], }\AttributeTok{decreasing =}\NormalTok{ decreasing\_vec[i]), ])}
\NormalTok{    pval }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
    \ControlFlowTok{for}\NormalTok{ (j }\ControlFlowTok{in} \DecValTok{2}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(ranked\_models)) \{}
      \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{sum}\NormalTok{(}\FunctionTok{is.na}\NormalTok{(data[ranked\_models[j], }\FunctionTok{paste}\NormalTok{(metric, }\StringTok{"CV"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{)]))) \{}
\NormalTok{        pval }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(pval, }\ConstantTok{NA}\NormalTok{)}
\NormalTok{      \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{        pval }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(pval, }\FunctionTok{wilcox.test}\NormalTok{(}\FunctionTok{as.numeric}\NormalTok{(data[ranked\_models[}\DecValTok{1}\NormalTok{], }\FunctionTok{paste}\NormalTok{(metric, }\StringTok{"CV"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{)]),}
          \FunctionTok{as.numeric}\NormalTok{(data[ranked\_models[j], }\FunctionTok{paste}\NormalTok{(metric, }\StringTok{"CV"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{)]),}
          \AttributeTok{exact =} \ConstantTok{FALSE}
\NormalTok{        )}\SpecialCharTok{$}\NormalTok{p.value)}
\NormalTok{      \}}
\NormalTok{    \}}
\NormalTok{    adj\_pval }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\ConstantTok{NA}\NormalTok{, }\FunctionTok{p.adjust}\NormalTok{(pval, }\AttributeTok{method =} \StringTok{"BH"}\NormalTok{, }\AttributeTok{n =} \FunctionTok{length}\NormalTok{(pval)))}
\NormalTok{    df }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(adj\_pval)}
    \FunctionTok{rownames}\NormalTok{(df) }\OtherTok{\textless{}{-}}\NormalTok{ ranked\_models}
    \FunctionTok{colnames}\NormalTok{(df) }\OtherTok{\textless{}{-}} \FunctionTok{paste}\NormalTok{(metric, }\StringTok{"adj. \textless{}i\textgreater{}p\textless{}/i\textgreater{} value"}\NormalTok{)}
\NormalTok{    data }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(data, df, }\AttributeTok{by =} \StringTok{"row.names"}\NormalTok{, }\AttributeTok{all =} \ConstantTok{TRUE}\NormalTok{)}
    \FunctionTok{rownames}\NormalTok{(data) }\OtherTok{\textless{}{-}}\NormalTok{ data}\SpecialCharTok{$}\NormalTok{Row.names}
\NormalTok{    data}\SpecialCharTok{$}\NormalTok{Row.names }\OtherTok{\textless{}{-}} \ConstantTok{NULL}
\NormalTok{  \}}
  \ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(metric\_vec)) \{}
    \ControlFlowTok{if}\NormalTok{ (decreasing\_vec[i]) \{}
\NormalTok{      data[}\FunctionTok{paste}\NormalTok{(metric\_vec[i], }\StringTok{"rank"}\NormalTok{)] }\OtherTok{\textless{}{-}} \FunctionTok{rank}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{data[, }\FunctionTok{paste}\NormalTok{(metric\_vec[i], }\StringTok{"mean"}\NormalTok{)], }\AttributeTok{ties.method =} \StringTok{"average"}\NormalTok{)}
\NormalTok{    \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{      data[}\FunctionTok{paste}\NormalTok{(metric\_vec[i], }\StringTok{"rank"}\NormalTok{)] }\OtherTok{\textless{}{-}} \FunctionTok{rank}\NormalTok{(data[, }\FunctionTok{paste}\NormalTok{(metric\_vec[i], }\StringTok{"mean"}\NormalTok{)], }\AttributeTok{ties.method =} \StringTok{"average"}\NormalTok{)}
\NormalTok{    \}}
\NormalTok{  \}}
\NormalTok{  data[}\StringTok{"Rank sum"}\NormalTok{] }\OtherTok{\textless{}{-}} \FunctionTok{rowSums}\NormalTok{(data[(}\FunctionTok{ncol}\NormalTok{(data) }\SpecialCharTok{{-}} \FunctionTok{length}\NormalTok{(metric\_vec) }\SpecialCharTok{+} \DecValTok{1}\NormalTok{)}\SpecialCharTok{:}\FunctionTok{ncol}\NormalTok{(data)])}
\NormalTok{  data }\OtherTok{\textless{}{-}}\NormalTok{ data[}\FunctionTok{order}\NormalTok{(data}\SpecialCharTok{$}\StringTok{\textasciigrave{}}\AttributeTok{Rank sum}\StringTok{\textasciigrave{}}\NormalTok{), ]}
\NormalTok{  competitive }\OtherTok{\textless{}{-}} \FunctionTok{rowSums}\NormalTok{(data[}\FunctionTok{paste}\NormalTok{(metric\_vec, }\StringTok{"adj. \textless{}i\textgreater{}p\textless{}/i\textgreater{} value"}\NormalTok{)] }\SpecialCharTok{\textless{}}\NormalTok{ p\_value\_threshold) }\SpecialCharTok{==} \DecValTok{0}
\NormalTok{  competitive[}\FunctionTok{is.na}\NormalTok{(competitive)] }\OtherTok{\textless{}{-}} \ConstantTok{TRUE}
\NormalTok{  data }\OtherTok{\textless{}{-}}\NormalTok{ data[competitive, ]}
  \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{is.null}\NormalTok{(output\_path)) \{}
\NormalTok{    data[}\FunctionTok{c}\NormalTok{(}
      \FunctionTok{paste}\NormalTok{(metric\_vec, }\StringTok{"adj. \textless{}i\textgreater{}p\textless{}/i\textgreater{} value"}\NormalTok{), }\FunctionTok{paste}\NormalTok{(metric\_vec, }\StringTok{"rank"}\NormalTok{), }\StringTok{"Rank sum"}\NormalTok{,}
      \FunctionTok{melt}\NormalTok{(}\FunctionTok{sapply}\NormalTok{(metric\_vec, }\ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{paste}\NormalTok{(x, }\FunctionTok{c}\NormalTok{(}\StringTok{"mean"}\NormalTok{, }\StringTok{"s.e.m."}\NormalTok{))))}\SpecialCharTok{$}\NormalTok{value}
\NormalTok{    )] }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{round}\NormalTok{(}\AttributeTok{digits =} \DecValTok{4}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{write.csv}\NormalTok{(., }\AttributeTok{file =}\NormalTok{ output\_path)}
\NormalTok{  \}}
\NormalTok{  data[}\FunctionTok{c}\NormalTok{(}\FunctionTok{paste}\NormalTok{(metric\_vec, }\StringTok{"adj. \textless{}i\textgreater{}p\textless{}/i\textgreater{} value"}\NormalTok{), }\FunctionTok{paste}\NormalTok{(metric\_vec, }\StringTok{"rank"}\NormalTok{), }\StringTok{"Rank sum"}\NormalTok{)] }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{round}\NormalTok{(}\AttributeTok{digits =} \DecValTok{4}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{datatable}\NormalTok{(}\AttributeTok{options =} \FunctionTok{list}\NormalTok{(}\AttributeTok{pageLength =}\NormalTok{ num\_entries), }\AttributeTok{escape =} \ConstantTok{FALSE}\NormalTok{)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\hypertarget{melanin-binding-regression-3}{%
\section{Melanin binding (regression)}\label{melanin-binding-regression-3}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{load}\NormalTok{(}\AttributeTok{file =} \StringTok{"./rdata/var\_reduct\_mb\_train\_test\_splits.RData"}\NormalTok{)}
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{32}\NormalTok{)}

\CommentTok{\# Shuffle the response variable of cross{-}validation training sets}
\ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{) \{}
\NormalTok{  response }\OtherTok{\textless{}{-}}\NormalTok{ outer\_splits[[i]]}\SpecialCharTok{$}\NormalTok{train}\SpecialCharTok{$}\NormalTok{log\_intensity}
\NormalTok{  response }\OtherTok{\textless{}{-}} \FunctionTok{sample}\NormalTok{(response)}
\NormalTok{  outer\_splits[[i]]}\SpecialCharTok{$}\NormalTok{train}\SpecialCharTok{$}\NormalTok{log\_intensity }\OtherTok{\textless{}{-}}\NormalTok{ response}
\NormalTok{\}}

\CommentTok{\# Shuffle the response variable of the whole data set}
\NormalTok{response }\OtherTok{\textless{}{-}}\NormalTok{ mb\_data}\SpecialCharTok{$}\NormalTok{log\_intensity}
\NormalTok{response }\OtherTok{\textless{}{-}} \FunctionTok{sample}\NormalTok{(response)}
\NormalTok{mb\_data}\SpecialCharTok{$}\NormalTok{log\_intensity }\OtherTok{\textless{}{-}}\NormalTok{ response}

\FunctionTok{save}\NormalTok{(mb\_data, outer\_splits,}
  \AttributeTok{file =} \StringTok{"./rdata/var\_reduct\_mb\_train\_test\_splits\_y\_shuffled.RData"}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{model-training-3}{%
\subsection{Model training}\label{model-training-3}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{train\_mb\_models }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(train\_set, exp\_dir, prefix, }\AttributeTok{nfolds =} \DecValTok{10}\NormalTok{, }\AttributeTok{grid\_seed =} \DecValTok{1}\NormalTok{) \{}
\NormalTok{  tmp }\OtherTok{\textless{}{-}} \FunctionTok{as.h2o}\NormalTok{(train\_set, }\AttributeTok{destination\_frame =}\NormalTok{ prefix)}
\NormalTok{  y }\OtherTok{\textless{}{-}} \StringTok{"log\_intensity"}
\NormalTok{  x }\OtherTok{\textless{}{-}} \FunctionTok{setdiff}\NormalTok{(}\FunctionTok{names}\NormalTok{(tmp), y)}
\NormalTok{  res }\OtherTok{\textless{}{-}} \FunctionTok{as.data.frame}\NormalTok{(tmp}\SpecialCharTok{$}\NormalTok{log\_intensity)}
  \CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
  \CommentTok{\# base model training}
  \CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"Deep learning grid 1}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  deeplearning\_1 }\OtherTok{\textless{}{-}} \FunctionTok{h2o.grid}\NormalTok{(}
    \AttributeTok{algorithm =} \StringTok{"deeplearning"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{hyper\_params =}\NormalTok{ deeplearning\_params\_1,}
    \AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{, }\AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{,}
    \AttributeTok{search\_criteria =} \FunctionTok{list}\NormalTok{(}
      \AttributeTok{strategy =} \StringTok{"RandomDiscrete"}\NormalTok{,}
      \AttributeTok{max\_models =} \DecValTok{100}\NormalTok{, }\AttributeTok{seed =}\NormalTok{ grid\_seed}
\NormalTok{    ),}
    \AttributeTok{fold\_assignment =} \StringTok{"Modulo"}\NormalTok{, }\AttributeTok{parallelism =} \DecValTok{0}
\NormalTok{  )}
  \ControlFlowTok{for}\NormalTok{ (model\_id }\ControlFlowTok{in}\NormalTok{ deeplearning\_1}\SpecialCharTok{@}\NormalTok{model\_ids) \{}
\NormalTok{    tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(model\_id), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  \}}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"Deep learning grid 2}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  deeplearning\_2 }\OtherTok{\textless{}{-}} \FunctionTok{h2o.grid}\NormalTok{(}
    \AttributeTok{algorithm =} \StringTok{"deeplearning"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{hyper\_params =}\NormalTok{ deeplearning\_params\_2,}
    \AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{, }\AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{,}
    \AttributeTok{search\_criteria =} \FunctionTok{list}\NormalTok{(}
      \AttributeTok{strategy =} \StringTok{"RandomDiscrete"}\NormalTok{,}
      \AttributeTok{max\_models =} \DecValTok{100}\NormalTok{, }\AttributeTok{seed =}\NormalTok{ grid\_seed}
\NormalTok{    ),}
    \AttributeTok{fold\_assignment =} \StringTok{"Modulo"}\NormalTok{, }\AttributeTok{parallelism =} \DecValTok{0}
\NormalTok{  )}
  \ControlFlowTok{for}\NormalTok{ (model\_id }\ControlFlowTok{in}\NormalTok{ deeplearning\_2}\SpecialCharTok{@}\NormalTok{model\_ids) \{}
\NormalTok{    tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(model\_id), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  \}}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"Deep learning grid 3}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  deeplearning\_3 }\OtherTok{\textless{}{-}} \FunctionTok{h2o.grid}\NormalTok{(}
    \AttributeTok{algorithm =} \StringTok{"deeplearning"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{hyper\_params =}\NormalTok{ deeplearning\_params\_3,}
    \AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{, }\AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{,}
    \AttributeTok{search\_criteria =} \FunctionTok{list}\NormalTok{(}
      \AttributeTok{strategy =} \StringTok{"RandomDiscrete"}\NormalTok{,}
      \AttributeTok{max\_models =} \DecValTok{100}\NormalTok{, }\AttributeTok{seed =}\NormalTok{ grid\_seed}
\NormalTok{    ),}
    \AttributeTok{fold\_assignment =} \StringTok{"Modulo"}\NormalTok{, }\AttributeTok{parallelism =} \DecValTok{0}
\NormalTok{  )}
  \ControlFlowTok{for}\NormalTok{ (model\_id }\ControlFlowTok{in}\NormalTok{ deeplearning\_3}\SpecialCharTok{@}\NormalTok{model\_ids) \{}
\NormalTok{    tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(model\_id), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  \}}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"GBM grid}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  gbm }\OtherTok{\textless{}{-}} \FunctionTok{h2o.grid}\NormalTok{(}
    \AttributeTok{algorithm =} \StringTok{"gbm"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{hyper\_params =}\NormalTok{ gbm\_params, }\AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{,}
    \AttributeTok{search\_criteria =} \FunctionTok{list}\NormalTok{(}\AttributeTok{strategy =} \StringTok{"RandomDiscrete"}\NormalTok{, }\AttributeTok{max\_models =} \DecValTok{300}\NormalTok{, }\AttributeTok{seed =}\NormalTok{ grid\_seed),}
    \AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}\NormalTok{, }\AttributeTok{parallelism =} \DecValTok{0}
\NormalTok{  )}
  \ControlFlowTok{for}\NormalTok{ (model\_id }\ControlFlowTok{in}\NormalTok{ gbm}\SpecialCharTok{@}\NormalTok{model\_ids) \{}
\NormalTok{    tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(model\_id), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  \}}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"GBM 5 default models}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  gbm\_1 }\OtherTok{\textless{}{-}} \FunctionTok{h2o.gbm}\NormalTok{(}
    \AttributeTok{model\_id =} \StringTok{"GBM\_1"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{, }\AttributeTok{score\_tree\_interval =} \DecValTok{5}\NormalTok{,}
    \AttributeTok{col\_sample\_rate =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{col\_sample\_rate\_per\_tree =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{learn\_rate =} \FloatTok{0.1}\NormalTok{,}
    \AttributeTok{max\_depth =} \DecValTok{6}\NormalTok{, }\AttributeTok{min\_rows =} \DecValTok{1}\NormalTok{, }\AttributeTok{min\_split\_improvement =} \FloatTok{1e{-}5}\NormalTok{, }\AttributeTok{ntrees =} \DecValTok{10000}\NormalTok{, }\AttributeTok{sample\_rate =} \FloatTok{0.8}\NormalTok{,}
    \AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}
\NormalTok{  )}
\NormalTok{  gbm\_2 }\OtherTok{\textless{}{-}} \FunctionTok{h2o.gbm}\NormalTok{(}
    \AttributeTok{model\_id =} \StringTok{"GBM\_2"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{, }\AttributeTok{score\_tree\_interval =} \DecValTok{5}\NormalTok{,}
    \AttributeTok{col\_sample\_rate =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{col\_sample\_rate\_per\_tree =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{learn\_rate =} \FloatTok{0.1}\NormalTok{,}
    \AttributeTok{max\_depth =} \DecValTok{7}\NormalTok{, }\AttributeTok{min\_rows =} \DecValTok{10}\NormalTok{, }\AttributeTok{min\_split\_improvement =} \FloatTok{1e{-}5}\NormalTok{, }\AttributeTok{ntrees =} \DecValTok{10000}\NormalTok{, }\AttributeTok{sample\_rate =} \FloatTok{0.8}\NormalTok{,}
    \AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}
\NormalTok{  )}
\NormalTok{  gbm\_3 }\OtherTok{\textless{}{-}} \FunctionTok{h2o.gbm}\NormalTok{(}
    \AttributeTok{model\_id =} \StringTok{"GBM\_3"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{, }\AttributeTok{score\_tree\_interval =} \DecValTok{5}\NormalTok{,}
    \AttributeTok{col\_sample\_rate =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{col\_sample\_rate\_per\_tree =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{learn\_rate =} \FloatTok{0.1}\NormalTok{,}
    \AttributeTok{max\_depth =} \DecValTok{8}\NormalTok{, }\AttributeTok{min\_rows =} \DecValTok{10}\NormalTok{, }\AttributeTok{min\_split\_improvement =} \FloatTok{1e{-}5}\NormalTok{, }\AttributeTok{ntrees =} \DecValTok{10000}\NormalTok{, }\AttributeTok{sample\_rate =} \FloatTok{0.8}\NormalTok{,}
    \AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}
\NormalTok{  )}
\NormalTok{  gbm\_4 }\OtherTok{\textless{}{-}} \FunctionTok{h2o.gbm}\NormalTok{(}
    \AttributeTok{model\_id =} \StringTok{"GBM\_4"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{, }\AttributeTok{score\_tree\_interval =} \DecValTok{5}\NormalTok{,}
    \AttributeTok{col\_sample\_rate =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{col\_sample\_rate\_per\_tree =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{learn\_rate =} \FloatTok{0.1}\NormalTok{,}
    \AttributeTok{max\_depth =} \DecValTok{10}\NormalTok{, }\AttributeTok{min\_rows =} \DecValTok{10}\NormalTok{, }\AttributeTok{min\_split\_improvement =} \FloatTok{1e{-}5}\NormalTok{, }\AttributeTok{ntrees =} \DecValTok{10000}\NormalTok{, }\AttributeTok{sample\_rate =} \FloatTok{0.8}\NormalTok{,}
    \AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}
\NormalTok{  )}
\NormalTok{  gbm\_5 }\OtherTok{\textless{}{-}} \FunctionTok{h2o.gbm}\NormalTok{(}
    \AttributeTok{model\_id =} \StringTok{"GBM\_5"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{, }\AttributeTok{score\_tree\_interval =} \DecValTok{5}\NormalTok{,}
    \AttributeTok{col\_sample\_rate =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{col\_sample\_rate\_per\_tree =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{learn\_rate =} \FloatTok{0.1}\NormalTok{,}
    \AttributeTok{max\_depth =} \DecValTok{15}\NormalTok{, }\AttributeTok{min\_rows =} \DecValTok{100}\NormalTok{, }\AttributeTok{min\_split\_improvement =} \FloatTok{1e{-}5}\NormalTok{, }\AttributeTok{ntrees =} \DecValTok{10000}\NormalTok{, }\AttributeTok{sample\_rate =} \FloatTok{0.8}\NormalTok{,}
    \AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}
\NormalTok{  )}
  \ControlFlowTok{for}\NormalTok{ (model\_id }\ControlFlowTok{in} \FunctionTok{paste0}\NormalTok{(}\StringTok{"GBM\_"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{5}\NormalTok{)) \{}
\NormalTok{    tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(model\_id), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  \}}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"XGBoost grid}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  xgboost }\OtherTok{\textless{}{-}} \FunctionTok{h2o.grid}\NormalTok{(}
    \AttributeTok{algorithm =} \StringTok{"xgboost"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{hyper\_params =}\NormalTok{ xgboost\_params, }\AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{,}
    \AttributeTok{search\_criteria =} \FunctionTok{list}\NormalTok{(}\AttributeTok{strategy =} \StringTok{"RandomDiscrete"}\NormalTok{, }\AttributeTok{max\_models =} \DecValTok{300}\NormalTok{, }\AttributeTok{seed =}\NormalTok{ grid\_seed),}
    \AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}\NormalTok{, }\AttributeTok{parallelism =} \DecValTok{0}
\NormalTok{  )}
  \ControlFlowTok{for}\NormalTok{ (model\_id }\ControlFlowTok{in}\NormalTok{ xgboost}\SpecialCharTok{@}\NormalTok{model\_ids) \{}
\NormalTok{    tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(model\_id), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  \}}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"XGBoost 3 default models}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  xgboost\_1 }\OtherTok{\textless{}{-}} \FunctionTok{h2o.xgboost}\NormalTok{(}
    \AttributeTok{model\_id =} \StringTok{"XGBoost\_1"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{, }\AttributeTok{score\_tree\_interval =} \DecValTok{5}\NormalTok{,}
    \AttributeTok{booster =} \StringTok{"gbtree"}\NormalTok{, }\AttributeTok{col\_sample\_rate =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{col\_sample\_rate\_per\_tree =} \FloatTok{0.8}\NormalTok{,}
    \AttributeTok{max\_depth =} \DecValTok{10}\NormalTok{, }\AttributeTok{min\_rows =} \DecValTok{5}\NormalTok{, }\AttributeTok{ntrees =} \DecValTok{10000}\NormalTok{, }\AttributeTok{reg\_alpha =} \DecValTok{0}\NormalTok{, }\AttributeTok{reg\_lambda =} \DecValTok{1}\NormalTok{,}
    \AttributeTok{sample\_rate =} \FloatTok{0.6}\NormalTok{, }\AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}
\NormalTok{  )}
\NormalTok{  xgboost\_2 }\OtherTok{\textless{}{-}} \FunctionTok{h2o.xgboost}\NormalTok{(}
    \AttributeTok{model\_id =} \StringTok{"XGBoost\_2"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{, }\AttributeTok{score\_tree\_interval =} \DecValTok{5}\NormalTok{,}
    \AttributeTok{booster =} \StringTok{"gbtree"}\NormalTok{, }\AttributeTok{col\_sample\_rate =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{col\_sample\_rate\_per\_tree =} \FloatTok{0.8}\NormalTok{,}
    \AttributeTok{max\_depth =} \DecValTok{20}\NormalTok{, }\AttributeTok{min\_rows =} \DecValTok{10}\NormalTok{, }\AttributeTok{ntrees =} \DecValTok{10000}\NormalTok{, }\AttributeTok{reg\_alpha =} \DecValTok{0}\NormalTok{, }\AttributeTok{reg\_lambda =} \DecValTok{1}\NormalTok{,}
    \AttributeTok{sample\_rate =} \FloatTok{0.6}\NormalTok{, }\AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}
\NormalTok{  )}
\NormalTok{  xgboost\_3 }\OtherTok{\textless{}{-}} \FunctionTok{h2o.xgboost}\NormalTok{(}
    \AttributeTok{model\_id =} \StringTok{"XGBoost\_3"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{, }\AttributeTok{score\_tree\_interval =} \DecValTok{5}\NormalTok{,}
    \AttributeTok{booster =} \StringTok{"gbtree"}\NormalTok{, }\AttributeTok{col\_sample\_rate =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{col\_sample\_rate\_per\_tree =} \FloatTok{0.8}\NormalTok{,}
    \AttributeTok{max\_depth =} \DecValTok{5}\NormalTok{, }\AttributeTok{min\_rows =} \DecValTok{3}\NormalTok{, }\AttributeTok{ntrees =} \DecValTok{10000}\NormalTok{, }\AttributeTok{reg\_alpha =} \DecValTok{0}\NormalTok{, }\AttributeTok{reg\_lambda =} \DecValTok{1}\NormalTok{,}
    \AttributeTok{sample\_rate =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}
\NormalTok{  )}
  \ControlFlowTok{for}\NormalTok{ (model\_id }\ControlFlowTok{in} \FunctionTok{paste0}\NormalTok{(}\StringTok{"XGBoost\_"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{)) \{}
\NormalTok{    tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(model\_id), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  \}}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"GLM}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  glm }\OtherTok{\textless{}{-}} \FunctionTok{h2o.glm}\NormalTok{(}
    \AttributeTok{model\_id =} \StringTok{"GLM"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{alpha =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.0}\NormalTok{, }\FloatTok{0.2}\NormalTok{, }\FloatTok{0.4}\NormalTok{, }\FloatTok{0.6}\NormalTok{, }\FloatTok{0.8}\NormalTok{, }\FloatTok{1.0}\NormalTok{),}
    \AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}
\NormalTok{  )}
\NormalTok{  tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(}\StringTok{"GLM"}\NormalTok{), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"DRF}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  drf }\OtherTok{\textless{}{-}} \FunctionTok{h2o.randomForest}\NormalTok{(}
    \AttributeTok{model\_id =} \StringTok{"DRF"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{ntrees =} \DecValTok{10000}\NormalTok{,}
    \AttributeTok{score\_tree\_interval =} \DecValTok{5}\NormalTok{, }\AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{,}
    \AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}
\NormalTok{  )}
\NormalTok{  tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(}\StringTok{"DRF"}\NormalTok{), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"XRT}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  xrt }\OtherTok{\textless{}{-}} \FunctionTok{h2o.randomForest}\NormalTok{(}
    \AttributeTok{model\_id =} \StringTok{"XRT"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{ntrees =} \DecValTok{10000}\NormalTok{, }\AttributeTok{histogram\_type =} \StringTok{"Random"}\NormalTok{,}
    \AttributeTok{score\_tree\_interval =} \DecValTok{5}\NormalTok{, }\AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{,}
    \AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}
\NormalTok{  )}
\NormalTok{  tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(}\StringTok{"XRT"}\NormalTok{), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
  \CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
  \CommentTok{\# get holdout predictions}
  \CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\NormalTok{  base\_models }\OtherTok{\textless{}{-}} \FunctionTok{as.list}\NormalTok{(}\FunctionTok{c}\NormalTok{(}
    \FunctionTok{unlist}\NormalTok{(deeplearning\_1}\SpecialCharTok{@}\NormalTok{model\_ids),}
    \FunctionTok{unlist}\NormalTok{(deeplearning\_2}\SpecialCharTok{@}\NormalTok{model\_ids),}
    \FunctionTok{unlist}\NormalTok{(deeplearning\_3}\SpecialCharTok{@}\NormalTok{model\_ids),}
    \FunctionTok{unlist}\NormalTok{(gbm}\SpecialCharTok{@}\NormalTok{model\_ids), }\FunctionTok{paste0}\NormalTok{(}\StringTok{"GBM\_"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{5}\NormalTok{),}
    \FunctionTok{unlist}\NormalTok{(xgboost}\SpecialCharTok{@}\NormalTok{model\_ids), }\FunctionTok{paste0}\NormalTok{(}\StringTok{"XGBoost\_"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{),}
    \StringTok{"GLM"}\NormalTok{,}
    \StringTok{"DRF"}\NormalTok{,}
    \StringTok{"XRT"}
\NormalTok{  ))}
  \ControlFlowTok{for}\NormalTok{ (model\_id }\ControlFlowTok{in}\NormalTok{ base\_models) \{}
\NormalTok{    res }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(res, }\FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{h2o.getFrame}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"cv\_holdout\_prediction\_"}\NormalTok{, model\_id)),}
      \AttributeTok{col.names =}\NormalTok{ model\_id}
\NormalTok{    ))}
\NormalTok{  \}}
  \CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
  \CommentTok{\# super learner training}
  \CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\NormalTok{  sl\_iter }\OtherTok{\textless{}{-}} \DecValTok{0}
  \FunctionTok{cat}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"Super learner iteration "}\NormalTok{, sl\_iter, }\StringTok{" ("}\NormalTok{, }\FunctionTok{length}\NormalTok{(base\_models), }\StringTok{" models)}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{))}
\NormalTok{  sl }\OtherTok{\textless{}{-}} \FunctionTok{h2o.stackedEnsemble}\NormalTok{(}
    \AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{model\_id =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"superlearner\_iter\_"}\NormalTok{, sl\_iter),}
    \AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{,}
    \AttributeTok{base\_models =}\NormalTok{ base\_models,}
    \AttributeTok{metalearner\_algorithm =} \StringTok{"glm"}\NormalTok{,}
    \AttributeTok{metalearner\_nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_levelone\_frame =} \ConstantTok{TRUE}\NormalTok{,}
    \AttributeTok{metalearner\_params =} \FunctionTok{list}\NormalTok{(}\AttributeTok{standardize =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  )}
\NormalTok{  tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"superlearner\_iter\_"}\NormalTok{, sl\_iter)), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  model\_id }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"metalearner\_glm\_superlearner\_iter\_"}\NormalTok{, sl\_iter)}
\NormalTok{  tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(model\_id), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  res }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(res, }\FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{h2o.getFrame}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"cv\_holdout\_prediction\_"}\NormalTok{, model\_id)),}
    \AttributeTok{col.names =} \FunctionTok{paste0}\NormalTok{(model\_id, }\StringTok{"\_"}\NormalTok{, }\FunctionTok{length}\NormalTok{(base\_models), }\StringTok{"\_models"}\NormalTok{)}
\NormalTok{  ))}
  \CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
  \CommentTok{\# super learner base model reduction}
  \CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
  \ControlFlowTok{while}\NormalTok{ (}\ConstantTok{TRUE}\NormalTok{) \{}
\NormalTok{    meta }\OtherTok{\textless{}{-}} \FunctionTok{h2o.getModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"metalearner\_glm\_superlearner\_iter\_"}\NormalTok{, sl\_iter, }\StringTok{"\_cv\_1"}\NormalTok{))}
\NormalTok{    names }\OtherTok{\textless{}{-}}\NormalTok{ meta}\SpecialCharTok{@}\NormalTok{model}\SpecialCharTok{$}\NormalTok{coefficients\_table[, }\StringTok{"names"}\NormalTok{]}
\NormalTok{    coeffs }\OtherTok{\textless{}{-}}\NormalTok{ (meta}\SpecialCharTok{@}\NormalTok{model}\SpecialCharTok{$}\NormalTok{coefficients\_table[, }\StringTok{"standardized\_coefficients"}\NormalTok{] }\SpecialCharTok{\textgreater{}} \DecValTok{0}\NormalTok{)}
    \ControlFlowTok{for}\NormalTok{ (j }\ControlFlowTok{in} \DecValTok{2}\SpecialCharTok{:}\NormalTok{nfolds) \{}
\NormalTok{      meta }\OtherTok{\textless{}{-}} \FunctionTok{h2o.getModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"metalearner\_glm\_superlearner\_iter\_"}\NormalTok{, sl\_iter, }\StringTok{"\_cv\_"}\NormalTok{, j))}
\NormalTok{      names }\OtherTok{\textless{}{-}}\NormalTok{ meta}\SpecialCharTok{@}\NormalTok{model}\SpecialCharTok{$}\NormalTok{coefficients\_table[, }\StringTok{"names"}\NormalTok{]}
\NormalTok{      coeffs }\OtherTok{\textless{}{-}}\NormalTok{ coeffs }\SpecialCharTok{+}\NormalTok{ (meta}\SpecialCharTok{@}\NormalTok{model}\SpecialCharTok{$}\NormalTok{coefficients\_table[, }\StringTok{"standardized\_coefficients"}\NormalTok{] }\SpecialCharTok{\textgreater{}} \DecValTok{0}\NormalTok{)}
\NormalTok{    \}}
\NormalTok{    base\_models\_ }\OtherTok{\textless{}{-}} \FunctionTok{as.list}\NormalTok{(names[coeffs }\SpecialCharTok{\textgreater{}=} \FunctionTok{ceiling}\NormalTok{(nfolds }\SpecialCharTok{/} \DecValTok{2}\NormalTok{) }\SpecialCharTok{\&}\NormalTok{ names }\SpecialCharTok{!=} \StringTok{"Intercept"}\NormalTok{])}
    \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{length}\NormalTok{(base\_models\_) }\SpecialCharTok{==} \DecValTok{0}\NormalTok{) \{}
      \FunctionTok{cat}\NormalTok{(}\StringTok{"No base models passing the threshold}\SpecialCharTok{\textbackslash{}n\textbackslash{}n}\StringTok{"}\NormalTok{)}
      \ControlFlowTok{break}
\NormalTok{    \}}
    \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{sum}\NormalTok{(base\_models }\SpecialCharTok{\%in\%}\NormalTok{ base\_models\_) }\SpecialCharTok{==} \FunctionTok{length}\NormalTok{(base\_models)) \{}
      \FunctionTok{cat}\NormalTok{(}\StringTok{"No further reduction of base models}\SpecialCharTok{\textbackslash{}n\textbackslash{}n}\StringTok{"}\NormalTok{)}
      \ControlFlowTok{break}
\NormalTok{    \}}
\NormalTok{    sl\_iter }\OtherTok{\textless{}{-}}\NormalTok{ sl\_iter }\SpecialCharTok{+} \DecValTok{1}
\NormalTok{    base\_models }\OtherTok{\textless{}{-}}\NormalTok{ base\_models\_}
    \FunctionTok{cat}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"Super learner iteration "}\NormalTok{, sl\_iter, }\StringTok{" ("}\NormalTok{, }\FunctionTok{length}\NormalTok{(base\_models), }\StringTok{" models)}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{))}
\NormalTok{    sl }\OtherTok{\textless{}{-}} \FunctionTok{h2o.stackedEnsemble}\NormalTok{(}
      \AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{model\_id =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"superlearner\_iter\_"}\NormalTok{, sl\_iter),}
      \AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{,}
      \AttributeTok{base\_models =}\NormalTok{ base\_models,}
      \AttributeTok{metalearner\_algorithm =} \StringTok{"glm"}\NormalTok{,}
      \AttributeTok{metalearner\_nfolds =}\NormalTok{ nfolds,}
      \AttributeTok{keep\_levelone\_frame =} \ConstantTok{TRUE}\NormalTok{,}
      \AttributeTok{metalearner\_params =} \FunctionTok{list}\NormalTok{(}\AttributeTok{standardize =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{    )}
\NormalTok{    tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"superlearner\_iter\_"}\NormalTok{, sl\_iter)), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{    model\_id }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"metalearner\_glm\_superlearner\_iter\_"}\NormalTok{, sl\_iter)}
\NormalTok{    tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(model\_id), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{    res }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(res, }\FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{h2o.getFrame}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"cv\_holdout\_prediction\_"}\NormalTok{, model\_id)),}
      \AttributeTok{col.names =} \FunctionTok{paste0}\NormalTok{(model\_id, }\StringTok{"\_"}\NormalTok{, }\FunctionTok{length}\NormalTok{(base\_models), }\StringTok{"\_models"}\NormalTok{)}
\NormalTok{    ))}
\NormalTok{  \}}
  \CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
  \CommentTok{\# super learner for homogeneous base models}
  \CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
  \CommentTok{\# DeepLearning}
\NormalTok{  base\_models }\OtherTok{\textless{}{-}} \FunctionTok{as.list}\NormalTok{(}\FunctionTok{c}\NormalTok{(}
    \FunctionTok{unlist}\NormalTok{(deeplearning\_1}\SpecialCharTok{@}\NormalTok{model\_ids),}
    \FunctionTok{unlist}\NormalTok{(deeplearning\_2}\SpecialCharTok{@}\NormalTok{model\_ids),}
    \FunctionTok{unlist}\NormalTok{(deeplearning\_3}\SpecialCharTok{@}\NormalTok{model\_ids)}
\NormalTok{  ))}
  \FunctionTok{cat}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"Super learner deep learning ("}\NormalTok{, }\FunctionTok{length}\NormalTok{(base\_models), }\StringTok{" models)}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{))}
\NormalTok{  sl }\OtherTok{\textless{}{-}} \FunctionTok{h2o.stackedEnsemble}\NormalTok{(}
    \AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{model\_id =} \StringTok{"superlearner\_deeplearning"}\NormalTok{,}
    \AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{,}
    \AttributeTok{base\_models =}\NormalTok{ base\_models,}
    \AttributeTok{metalearner\_algorithm =} \StringTok{"glm"}\NormalTok{,}
    \AttributeTok{metalearner\_nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_levelone\_frame =} \ConstantTok{TRUE}\NormalTok{,}
    \AttributeTok{metalearner\_params =} \FunctionTok{list}\NormalTok{(}\AttributeTok{standardize =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  )}
\NormalTok{  tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(}\StringTok{"superlearner\_deeplearning"}\NormalTok{), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  model\_id }\OtherTok{\textless{}{-}} \StringTok{"metalearner\_glm\_superlearner\_deeplearning"}
\NormalTok{  tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(model\_id), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  res }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(res, }\FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{h2o.getFrame}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"cv\_holdout\_prediction\_"}\NormalTok{, model\_id)),}
    \AttributeTok{col.names =} \FunctionTok{paste0}\NormalTok{(model\_id, }\StringTok{"\_"}\NormalTok{, }\FunctionTok{length}\NormalTok{(base\_models), }\StringTok{"\_models"}\NormalTok{)}
\NormalTok{  ))}
  \CommentTok{\# GBM}
\NormalTok{  base\_models }\OtherTok{\textless{}{-}} \FunctionTok{as.list}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\FunctionTok{unlist}\NormalTok{(gbm}\SpecialCharTok{@}\NormalTok{model\_ids), }\FunctionTok{paste0}\NormalTok{(}\StringTok{"GBM\_"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{5}\NormalTok{)))}
  \FunctionTok{cat}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"Super learner GBM ("}\NormalTok{, }\FunctionTok{length}\NormalTok{(base\_models), }\StringTok{" models)}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{))}
\NormalTok{  sl }\OtherTok{\textless{}{-}} \FunctionTok{h2o.stackedEnsemble}\NormalTok{(}
    \AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{model\_id =} \StringTok{"superlearner\_gbm"}\NormalTok{,}
    \AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{,}
    \AttributeTok{base\_models =}\NormalTok{ base\_models,}
    \AttributeTok{metalearner\_algorithm =} \StringTok{"glm"}\NormalTok{,}
    \AttributeTok{metalearner\_nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_levelone\_frame =} \ConstantTok{TRUE}\NormalTok{,}
    \AttributeTok{metalearner\_params =} \FunctionTok{list}\NormalTok{(}\AttributeTok{standardize =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  )}
\NormalTok{  tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(}\StringTok{"superlearner\_gbm"}\NormalTok{), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  model\_id }\OtherTok{\textless{}{-}} \StringTok{"metalearner\_glm\_superlearner\_gbm"}
\NormalTok{  tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(model\_id), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  res }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(res, }\FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{h2o.getFrame}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"cv\_holdout\_prediction\_"}\NormalTok{, model\_id)),}
    \AttributeTok{col.names =} \FunctionTok{paste0}\NormalTok{(model\_id, }\StringTok{"\_"}\NormalTok{, }\FunctionTok{length}\NormalTok{(base\_models), }\StringTok{"\_models"}\NormalTok{)}
\NormalTok{  ))}
  \CommentTok{\# XGBoost}
\NormalTok{  base\_models }\OtherTok{\textless{}{-}} \FunctionTok{as.list}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\FunctionTok{unlist}\NormalTok{(xgboost}\SpecialCharTok{@}\NormalTok{model\_ids), }\FunctionTok{paste0}\NormalTok{(}\StringTok{"XGBoost\_"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{)))}
  \FunctionTok{cat}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"Super learner XGBoost ("}\NormalTok{, }\FunctionTok{length}\NormalTok{(base\_models), }\StringTok{" models)}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{))}
\NormalTok{  sl }\OtherTok{\textless{}{-}} \FunctionTok{h2o.stackedEnsemble}\NormalTok{(}
    \AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{model\_id =} \StringTok{"superlearner\_xgboost"}\NormalTok{,}
    \AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{,}
    \AttributeTok{base\_models =}\NormalTok{ base\_models,}
    \AttributeTok{metalearner\_algorithm =} \StringTok{"glm"}\NormalTok{,}
    \AttributeTok{metalearner\_nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_levelone\_frame =} \ConstantTok{TRUE}\NormalTok{,}
    \AttributeTok{metalearner\_params =} \FunctionTok{list}\NormalTok{(}\AttributeTok{standardize =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  )}
\NormalTok{  tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(}\StringTok{"superlearner\_xgboost"}\NormalTok{), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  model\_id }\OtherTok{\textless{}{-}} \StringTok{"metalearner\_glm\_superlearner\_xgboost"}
\NormalTok{  tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(model\_id), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  res }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(res, }\FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{h2o.getFrame}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"cv\_holdout\_prediction\_"}\NormalTok{, model\_id)),}
    \AttributeTok{col.names =} \FunctionTok{paste0}\NormalTok{(model\_id, }\StringTok{"\_"}\NormalTok{, }\FunctionTok{length}\NormalTok{(base\_models), }\StringTok{"\_models"}\NormalTok{)}
\NormalTok{  ))}
  \FunctionTok{write.csv}\NormalTok{(res, }\AttributeTok{file =} \FunctionTok{paste0}\NormalTok{(exp\_dir, }\StringTok{"/cv\_holdout\_predictions.csv"}\NormalTok{), }\AttributeTok{row.names =} \ConstantTok{FALSE}\NormalTok{)}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}n\textbackslash{}n}\StringTok{"}\NormalTok{)}
  \FunctionTok{h2o.removeAll}\NormalTok{()}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\hypertarget{inner-cross-validation-3}{%
\subsection{Inner cross-validation}\label{inner-cross-validation-3}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{load}\NormalTok{(}\AttributeTok{file =} \StringTok{"./rdata/var\_reduct\_mb\_train\_test\_splits\_y\_shuffled.RData"}\NormalTok{)}
\ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{) \{}
  \FunctionTok{cat}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"Outer training set "}\NormalTok{, i, }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{))}
\NormalTok{  prefix }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"outer\_"}\NormalTok{, i)}
\NormalTok{  exp\_dir }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"/Users/renee/Downloads/melanin\_binding\_adversarial/"}\NormalTok{, prefix)}
  \FunctionTok{dir.create}\NormalTok{(exp\_dir)}
  \FunctionTok{train\_mb\_models}\NormalTok{(}\AttributeTok{train\_set =}\NormalTok{ outer\_splits[[i]][[}\StringTok{"train"}\NormalTok{]], }\AttributeTok{exp\_dir =}\NormalTok{ exp\_dir, }\AttributeTok{prefix =}\NormalTok{ prefix)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Keep track of grid models}
\NormalTok{dl\_grid }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
\NormalTok{gbm\_grid }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
\NormalTok{xgboost\_grid }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
\NormalTok{dl\_grid\_params }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
\NormalTok{gbm\_grid\_params }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
\NormalTok{xgboost\_grid\_params }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
\ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{) \{}
  \FunctionTok{cat}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"Outer training set "}\NormalTok{, i, }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{))}
\NormalTok{  prefix }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"outer\_"}\NormalTok{, i)}
\NormalTok{  dir }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"/Users/renee/Downloads/melanin\_binding\_adversarial/"}\NormalTok{, prefix)}
\NormalTok{  files }\OtherTok{\textless{}{-}} \FunctionTok{list.files}\NormalTok{(dir)}
  \CommentTok{\# Deep learning}
\NormalTok{  dl }\OtherTok{\textless{}{-}}\NormalTok{ files[}\FunctionTok{str\_detect}\NormalTok{(files, }\StringTok{"DeepLearning\_model"}\NormalTok{)]}
  \ControlFlowTok{for}\NormalTok{ (m }\ControlFlowTok{in}\NormalTok{ dl) \{}
\NormalTok{    model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/"}\NormalTok{, m))}
\NormalTok{    hs }\OtherTok{\textless{}{-}} \FunctionTok{sha1}\NormalTok{(}\FunctionTok{paste}\NormalTok{(}\FunctionTok{c}\NormalTok{(}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{epsilon,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{hidden,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{hidden\_dropout\_ratios,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{input\_dropout\_ratio,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{rho}
\NormalTok{    ), }\AttributeTok{collapse =} \StringTok{" "}\NormalTok{))}
    \ControlFlowTok{if}\NormalTok{ (hs }\SpecialCharTok{\%in\%} \FunctionTok{names}\NormalTok{(dl\_grid)) \{}
\NormalTok{      dl\_grid[[hs]] }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(dl\_grid[[hs]], m)}
\NormalTok{    \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{      dl\_grid[[hs]] }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(m)}
\NormalTok{      dl\_grid\_params }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(}
\NormalTok{        dl\_grid\_params,}
        \FunctionTok{c}\NormalTok{(}
          \StringTok{"epsilon"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{epsilon,}
          \StringTok{"hidden"} \OtherTok{=} \FunctionTok{paste0}\NormalTok{(}\StringTok{"["}\NormalTok{, }\FunctionTok{paste}\NormalTok{(model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{hidden, }\AttributeTok{collapse =} \StringTok{","}\NormalTok{), }\StringTok{"]"}\NormalTok{),}
          \StringTok{"hidden\_dropout\_ratios"} \OtherTok{=} \FunctionTok{paste0}\NormalTok{(}
            \StringTok{"["}\NormalTok{,}
            \FunctionTok{paste}\NormalTok{(model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{hidden\_dropout\_ratios,}
              \AttributeTok{collapse =} \StringTok{","}
\NormalTok{            ), }\StringTok{"]"}
\NormalTok{          ),}
          \StringTok{"input\_dropout\_ratio"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{input\_dropout\_ratio,}
          \StringTok{"rho"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{rho}
\NormalTok{        )}
\NormalTok{      )}
\NormalTok{    \}}
\NormalTok{  \}}
  \FunctionTok{h2o.removeAll}\NormalTok{()}
  \CommentTok{\# GBM}
\NormalTok{  gbm }\OtherTok{\textless{}{-}}\NormalTok{ files[}\FunctionTok{str\_detect}\NormalTok{(files, }\StringTok{"GBM\_model"}\NormalTok{)]}
  \ControlFlowTok{for}\NormalTok{ (m }\ControlFlowTok{in}\NormalTok{ gbm) \{}
\NormalTok{    model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/"}\NormalTok{, m))}
\NormalTok{    hs }\OtherTok{\textless{}{-}} \FunctionTok{sha1}\NormalTok{(}\FunctionTok{paste}\NormalTok{(}\FunctionTok{c}\NormalTok{(}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{col\_sample\_rate,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{col\_sample\_rate\_per\_tree,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{max\_depth,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{min\_rows,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{min\_split\_improvement,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{sample\_rate}
\NormalTok{    ), }\AttributeTok{collapse =} \StringTok{" "}\NormalTok{))}
    \ControlFlowTok{if}\NormalTok{ (hs }\SpecialCharTok{\%in\%} \FunctionTok{names}\NormalTok{(gbm\_grid)) \{}
\NormalTok{      gbm\_grid[[hs]] }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(gbm\_grid[[hs]], m)}
\NormalTok{    \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{      gbm\_grid[[hs]] }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(m)}
\NormalTok{      gbm\_grid\_params }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(}
\NormalTok{        gbm\_grid\_params,}
        \FunctionTok{c}\NormalTok{(}
          \StringTok{"col\_sample\_rate"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{col\_sample\_rate,}
          \StringTok{"col\_sample\_rate\_per\_tree"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{col\_sample\_rate\_per\_tree,}
          \StringTok{"max\_depth"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{max\_depth,}
          \StringTok{"min\_rows"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{min\_rows,}
          \StringTok{"min\_split\_improvement"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{min\_split\_improvement,}
          \StringTok{"sample\_rate"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{sample\_rate}
\NormalTok{        )}
\NormalTok{      )}
\NormalTok{    \}}
\NormalTok{  \}}
  \FunctionTok{h2o.removeAll}\NormalTok{()}
  \CommentTok{\# XGBoost}
\NormalTok{  xgboost }\OtherTok{\textless{}{-}}\NormalTok{ files[}\FunctionTok{str\_detect}\NormalTok{(files, }\StringTok{"XGBoost\_model"}\NormalTok{)]}
  \ControlFlowTok{for}\NormalTok{ (m }\ControlFlowTok{in}\NormalTok{ xgboost) \{}
\NormalTok{    model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/"}\NormalTok{, m))}
\NormalTok{    hs }\OtherTok{\textless{}{-}} \FunctionTok{sha1}\NormalTok{(}\FunctionTok{paste}\NormalTok{(}\FunctionTok{c}\NormalTok{(}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{booster,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{col\_sample\_rate,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{col\_sample\_rate\_per\_tree,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{max\_depth,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{min\_rows,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{reg\_alpha,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{reg\_lambda,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{sample\_rate}
\NormalTok{    ), }\AttributeTok{collapse =} \StringTok{" "}\NormalTok{))}
    \ControlFlowTok{if}\NormalTok{ (hs }\SpecialCharTok{\%in\%} \FunctionTok{names}\NormalTok{(xgboost\_grid)) \{}
\NormalTok{      xgboost\_grid[[hs]] }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(xgboost\_grid[[hs]], m)}
\NormalTok{    \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{      xgboost\_grid[[hs]] }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(m)}
\NormalTok{      xgboost\_grid\_params }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(}
\NormalTok{        xgboost\_grid\_params,}
        \FunctionTok{c}\NormalTok{(}
          \StringTok{"booster"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{booster,}
          \StringTok{"col\_sample\_rate"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{col\_sample\_rate,}
          \StringTok{"col\_sample\_rate\_per\_tree"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{col\_sample\_rate\_per\_tree,}
          \StringTok{"max\_depth"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{max\_depth,}
          \StringTok{"min\_rows"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{min\_rows,}
          \StringTok{"reg\_alpha"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{reg\_alpha,}
          \StringTok{"reg\_lambda"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{reg\_lambda,}
          \StringTok{"sample\_rate"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{sample\_rate}
\NormalTok{        )}
\NormalTok{      )}
\NormalTok{    \}}
\NormalTok{  \}}
  \FunctionTok{h2o.removeAll}\NormalTok{()}
\NormalTok{\}}

\NormalTok{dl\_grid\_params }\OtherTok{\textless{}{-}} \FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{t}\NormalTok{(}\FunctionTok{data.frame}\NormalTok{(dl\_grid\_params)))}
\FunctionTok{rownames}\NormalTok{(dl\_grid\_params) }\OtherTok{\textless{}{-}} \FunctionTok{paste}\NormalTok{(}\StringTok{"Neural network grid model"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(dl\_grid\_params))}

\NormalTok{gbm\_grid\_params }\OtherTok{\textless{}{-}} \FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{t}\NormalTok{(}\FunctionTok{data.frame}\NormalTok{(gbm\_grid\_params)))}
\FunctionTok{rownames}\NormalTok{(gbm\_grid\_params) }\OtherTok{\textless{}{-}} \FunctionTok{paste}\NormalTok{(}\StringTok{"GBM grid model"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(gbm\_grid\_params))}

\NormalTok{xgboost\_grid\_params }\OtherTok{\textless{}{-}} \FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{t}\NormalTok{(}\FunctionTok{data.frame}\NormalTok{(xgboost\_grid\_params)))}
\FunctionTok{rownames}\NormalTok{(xgboost\_grid\_params) }\OtherTok{\textless{}{-}} \FunctionTok{paste}\NormalTok{(}\StringTok{"XGBoost grid model"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(xgboost\_grid\_params))}

\FunctionTok{write.csv}\NormalTok{(dl\_grid\_params, }\StringTok{"./other\_data/melanin\_binding\_adversarial/neural\_network\_grid\_params.csv"}\NormalTok{)}
\FunctionTok{write.csv}\NormalTok{(gbm\_grid\_params, }\StringTok{"./other\_data/melanin\_binding\_adversarial/gbm\_grid\_params.csv"}\NormalTok{)}
\FunctionTok{write.csv}\NormalTok{(xgboost\_grid\_params, }\StringTok{"./other\_data/melanin\_binding\_adversarial/xgboost\_grid\_params.csv"}\NormalTok{)}

\FunctionTok{save}\NormalTok{(dl\_grid, gbm\_grid, xgboost\_grid, }\AttributeTok{file =} \StringTok{"./rdata/model\_training\_grid\_models\_mb\_ad.RData"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{model-evaluation-3}{%
\subsection{Model evaluation}\label{model-evaluation-3}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{model\_evaluation }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(holdout\_pred, fold\_asign, grid\_name, }\AttributeTok{grid\_meta =} \ConstantTok{NULL}\NormalTok{) \{}
  \FunctionTok{load}\NormalTok{(}\AttributeTok{file =} \StringTok{"./rdata/var\_reduct\_mb\_train\_test\_splits\_y\_shuffled.RData"}\NormalTok{)}
\NormalTok{  res\_ }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
\NormalTok{  model\_num }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{startsWith}\NormalTok{(grid\_name, }\StringTok{"Super learner"}\NormalTok{)) \{}
    \ControlFlowTok{if}\NormalTok{ (grid\_name }\SpecialCharTok{==} \StringTok{"Super learner all models"}\NormalTok{) \{}
\NormalTok{      m }\OtherTok{\textless{}{-}} \FunctionTok{colnames}\NormalTok{(holdout\_pred)[}\FunctionTok{startsWith}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(holdout\_pred), }\StringTok{"metalearner\_glm\_superlearner\_iter\_0"}\NormalTok{)]}
\NormalTok{    \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (grid\_name }\SpecialCharTok{==} \StringTok{"Super learner final"}\NormalTok{) \{}
\NormalTok{      sl\_models }\OtherTok{\textless{}{-}} \FunctionTok{colnames}\NormalTok{(holdout\_pred)[}\FunctionTok{startsWith}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(holdout\_pred), }\StringTok{"metalearner\_glm\_superlearner\_iter"}\NormalTok{)]}
\NormalTok{      m }\OtherTok{\textless{}{-}}\NormalTok{ sl\_models[}\FunctionTok{length}\NormalTok{(sl\_models)]}
\NormalTok{    \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (grid\_name }\SpecialCharTok{==} \StringTok{"Super learner neural network"}\NormalTok{) \{}
\NormalTok{      m }\OtherTok{\textless{}{-}} \FunctionTok{colnames}\NormalTok{(holdout\_pred)[}\FunctionTok{startsWith}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(holdout\_pred), }\StringTok{"metalearner\_glm\_superlearner\_deeplearning"}\NormalTok{)]}
\NormalTok{    \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (grid\_name }\SpecialCharTok{==} \StringTok{"Super learner GBM"}\NormalTok{) \{}
\NormalTok{      m }\OtherTok{\textless{}{-}} \FunctionTok{colnames}\NormalTok{(holdout\_pred)[}\FunctionTok{startsWith}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(holdout\_pred), }\StringTok{"metalearner\_glm\_superlearner\_gbm"}\NormalTok{)]}
\NormalTok{    \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (grid\_name }\SpecialCharTok{==} \StringTok{"Super learner XGBoost"}\NormalTok{) \{}
\NormalTok{      m }\OtherTok{\textless{}{-}} \FunctionTok{colnames}\NormalTok{(holdout\_pred)[}\FunctionTok{startsWith}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(holdout\_pred), }\StringTok{"metalearner\_glm\_superlearner\_xgboost"}\NormalTok{)]}
\NormalTok{    \}}
\NormalTok{    mae }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{    rmse }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{    R2 }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
    \ControlFlowTok{for}\NormalTok{ (k }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{) \{}
\NormalTok{      y\_true }\OtherTok{\textless{}{-}}\NormalTok{ holdout\_pred[fold\_assign }\SpecialCharTok{==}\NormalTok{ k, }\StringTok{"log\_intensity"}\NormalTok{]}
\NormalTok{      y\_pred }\OtherTok{\textless{}{-}}\NormalTok{ holdout\_pred[fold\_assign }\SpecialCharTok{==}\NormalTok{ k, m]}
\NormalTok{      mae }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(mae, }\FunctionTok{MAE}\NormalTok{(}\AttributeTok{y\_pred =}\NormalTok{ y\_pred, }\AttributeTok{y\_true =}\NormalTok{ y\_true))}
\NormalTok{      rmse }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(rmse, }\FunctionTok{RMSE}\NormalTok{(}\AttributeTok{y\_pred =}\NormalTok{ y\_pred, }\AttributeTok{y\_true =}\NormalTok{ y\_true))}
\NormalTok{      R2 }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(R2, }\FunctionTok{R2\_Score}\NormalTok{(}\AttributeTok{y\_pred =}\NormalTok{ y\_pred, }\AttributeTok{y\_true =}\NormalTok{ y\_true))}
\NormalTok{    \}}
    \CommentTok{\# Re{-}scale to 0{-}100}
\NormalTok{    mae }\OtherTok{\textless{}{-}} \FunctionTok{rescale}\NormalTok{(mae, }\AttributeTok{to =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{100}\NormalTok{), }\AttributeTok{from =} \FunctionTok{range}\NormalTok{(mb\_data}\SpecialCharTok{$}\NormalTok{log\_intensity))}
\NormalTok{    rmse }\OtherTok{\textless{}{-}} \FunctionTok{rescale}\NormalTok{(rmse, }\AttributeTok{to =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{100}\NormalTok{), }\AttributeTok{from =} \FunctionTok{range}\NormalTok{(mb\_data}\SpecialCharTok{$}\NormalTok{log\_intensity))}
\NormalTok{    res\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(res\_, }\FunctionTok{c}\NormalTok{(}
      \FunctionTok{mean}\NormalTok{(mae, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{), }\FunctionTok{sem}\NormalTok{(mae),}
      \FunctionTok{mean}\NormalTok{(rmse, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{), }\FunctionTok{sem}\NormalTok{(rmse),}
      \FunctionTok{mean}\NormalTok{(R2, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{), }\FunctionTok{sem}\NormalTok{(R2),}
\NormalTok{      mae, rmse, R2}
\NormalTok{    ))}
\NormalTok{  \} }\ControlFlowTok{else}\NormalTok{ \{}
    \ControlFlowTok{for}\NormalTok{ (j }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(grid\_meta)) \{}
\NormalTok{      g }\OtherTok{\textless{}{-}}\NormalTok{ grid\_meta[[j]]}
\NormalTok{      m }\OtherTok{\textless{}{-}} \FunctionTok{intersect}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(holdout\_pred), g)}
      \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{length}\NormalTok{(m) }\SpecialCharTok{==} \DecValTok{1}\NormalTok{) \{}
\NormalTok{        model\_num }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(model\_num, j)}
\NormalTok{        mae }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{        rmse }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{        R2 }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
        \ControlFlowTok{for}\NormalTok{ (k }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{) \{}
\NormalTok{          y\_true }\OtherTok{\textless{}{-}}\NormalTok{ holdout\_pred[fold\_assign }\SpecialCharTok{==}\NormalTok{ k, }\StringTok{"log\_intensity"}\NormalTok{]}
\NormalTok{          y\_pred }\OtherTok{\textless{}{-}}\NormalTok{ holdout\_pred[fold\_assign }\SpecialCharTok{==}\NormalTok{ k, m]}
\NormalTok{          mae }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(mae, }\FunctionTok{MAE}\NormalTok{(}\AttributeTok{y\_pred =}\NormalTok{ y\_pred, }\AttributeTok{y\_true =}\NormalTok{ y\_true))}
\NormalTok{          rmse }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(rmse, }\FunctionTok{RMSE}\NormalTok{(}\AttributeTok{y\_pred =}\NormalTok{ y\_pred, }\AttributeTok{y\_true =}\NormalTok{ y\_true))}
\NormalTok{          R2 }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(R2, }\FunctionTok{R2\_Score}\NormalTok{(}\AttributeTok{y\_pred =}\NormalTok{ y\_pred, }\AttributeTok{y\_true =}\NormalTok{ y\_true))}
\NormalTok{        \}}
        \CommentTok{\# Re{-}scale to 0{-}100}
\NormalTok{        mae }\OtherTok{\textless{}{-}} \FunctionTok{rescale}\NormalTok{(mae, }\AttributeTok{to =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{100}\NormalTok{), }\AttributeTok{from =} \FunctionTok{range}\NormalTok{(mb\_data}\SpecialCharTok{$}\NormalTok{log\_intensity))}
\NormalTok{        rmse }\OtherTok{\textless{}{-}} \FunctionTok{rescale}\NormalTok{(rmse, }\AttributeTok{to =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{100}\NormalTok{), }\AttributeTok{from =} \FunctionTok{range}\NormalTok{(mb\_data}\SpecialCharTok{$}\NormalTok{log\_intensity))}
\NormalTok{        res\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(res\_, }\FunctionTok{c}\NormalTok{(}
          \FunctionTok{mean}\NormalTok{(mae, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{), }\FunctionTok{sem}\NormalTok{(mae),}
          \FunctionTok{mean}\NormalTok{(rmse, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{), }\FunctionTok{sem}\NormalTok{(rmse),}
          \FunctionTok{mean}\NormalTok{(R2, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{), }\FunctionTok{sem}\NormalTok{(R2),}
\NormalTok{          mae, rmse, R2}
\NormalTok{        ))}
\NormalTok{      \}}
\NormalTok{    \}}
\NormalTok{  \}}
\NormalTok{  res }\OtherTok{\textless{}{-}} \FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{t}\NormalTok{(}\FunctionTok{data.frame}\NormalTok{(res\_)))}
  \FunctionTok{colnames}\NormalTok{(res) }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}
    \StringTok{"Norm. MAE mean"}\NormalTok{, }\StringTok{"Norm. MAE s.e.m."}\NormalTok{, }\StringTok{"Norm. RMSE mean"}\NormalTok{, }\StringTok{"Norm. RMSE s.e.m."}\NormalTok{,}
    \StringTok{"R\^{}2 mean"}\NormalTok{, }\StringTok{"R\^{}2 s.e.m."}\NormalTok{,}
    \FunctionTok{paste}\NormalTok{(}\StringTok{"Norm. MAE CV"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{), }\FunctionTok{paste}\NormalTok{(}\StringTok{"Norm. RMSE CV"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{), }\FunctionTok{paste}\NormalTok{(}\StringTok{"R\^{}2 CV"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{)}
\NormalTok{  )}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{nrow}\NormalTok{(res) }\SpecialCharTok{==} \DecValTok{1}\NormalTok{) \{}
    \FunctionTok{rownames}\NormalTok{(res) }\OtherTok{\textless{}{-}}\NormalTok{ grid\_name}
\NormalTok{  \} }\ControlFlowTok{else}\NormalTok{ \{}
    \FunctionTok{rownames}\NormalTok{(res) }\OtherTok{\textless{}{-}} \FunctionTok{paste}\NormalTok{(grid\_name, model\_num)}
\NormalTok{  \}}
  \FunctionTok{return}\NormalTok{(res)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\hypertarget{inner-loop-model-selection-3}{%
\subsection{Inner loop model selection}\label{inner-loop-model-selection-3}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{load}\NormalTok{(}\AttributeTok{file =} \StringTok{"./rdata/model\_training\_grid\_models\_mb\_ad.RData"}\NormalTok{)}

\ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{) \{}
\NormalTok{  holdout\_pred }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"./other\_data/melanin\_binding\_adversarial/outer\_"}\NormalTok{, i, }\StringTok{"/cv\_holdout\_predictions.csv"}\NormalTok{))}
\NormalTok{  fold\_assign }\OtherTok{\textless{}{-}} \FunctionTok{rep}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{, }\FunctionTok{ceiling}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(holdout\_pred) }\SpecialCharTok{/} \DecValTok{10}\NormalTok{))[}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(holdout\_pred)]}
\NormalTok{  data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
  \CommentTok{\# Deep learning grid models}
\NormalTok{  data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign,}
    \AttributeTok{grid\_name =} \StringTok{"Neural network grid model"}\NormalTok{,}
    \AttributeTok{grid\_meta =}\NormalTok{ dl\_grid}
\NormalTok{  ))}
  \CommentTok{\# GBM grid models}
\NormalTok{  data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign,}
    \AttributeTok{grid\_name =} \StringTok{"GBM grid model"}\NormalTok{,}
    \AttributeTok{grid\_meta =}\NormalTok{ gbm\_grid}
\NormalTok{  ))}
  \CommentTok{\# GBM default models}
\NormalTok{  data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign,}
    \AttributeTok{grid\_name =} \StringTok{"GBM model"}\NormalTok{,}
    \AttributeTok{grid\_meta =} \FunctionTok{as.list}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"GBM\_"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{5}\NormalTok{))}
\NormalTok{  ))}
  \CommentTok{\# XGBoost grid models}
\NormalTok{  data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign,}
    \AttributeTok{grid\_name =} \StringTok{"XGBoost grid model"}\NormalTok{,}
    \AttributeTok{grid\_meta =}\NormalTok{ xgboost\_grid}
\NormalTok{  ))}
  \CommentTok{\# XGBoost default models}
\NormalTok{  data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign,}
    \AttributeTok{grid\_name =} \StringTok{"XGBoost model"}\NormalTok{,}
    \AttributeTok{grid\_meta =} \FunctionTok{as.list}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"XGBoost\_"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{))}
\NormalTok{  ))}
  \CommentTok{\# GLM}
\NormalTok{  data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign, }\AttributeTok{grid\_name =} \StringTok{"GLM model"}\NormalTok{, }\AttributeTok{grid\_meta =} \FunctionTok{list}\NormalTok{(}\StringTok{"GLM"}\NormalTok{)))}
  \CommentTok{\# DRF}
\NormalTok{  data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign, }\AttributeTok{grid\_name =} \StringTok{"DRF model"}\NormalTok{, }\AttributeTok{grid\_meta =} \FunctionTok{list}\NormalTok{(}\StringTok{"DRF"}\NormalTok{)))}
  \CommentTok{\# XRT}
\NormalTok{  data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign, }\AttributeTok{grid\_name =} \StringTok{"XRT model"}\NormalTok{, }\AttributeTok{grid\_meta =} \FunctionTok{list}\NormalTok{(}\StringTok{"XRT"}\NormalTok{)))}
  \CommentTok{\# Super learner all}
\NormalTok{  data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign, }\AttributeTok{grid\_name =} \StringTok{"Super learner all models"}\NormalTok{))}
  \CommentTok{\# Super learner final}
\NormalTok{  data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign, }\AttributeTok{grid\_name =} \StringTok{"Super learner final"}\NormalTok{))}
  \CommentTok{\# Super learner deep learning}
\NormalTok{  data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign, }\AttributeTok{grid\_name =} \StringTok{"Super learner neural network"}\NormalTok{))}
  \CommentTok{\# Super learner GBM}
\NormalTok{  data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign, }\AttributeTok{grid\_name =} \StringTok{"Super learner GBM"}\NormalTok{))}
  \CommentTok{\# Super learner XGBoost}
\NormalTok{  data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign, }\AttributeTok{grid\_name =} \StringTok{"Super learner XGBoost"}\NormalTok{))}

\NormalTok{  data }\OtherTok{\textless{}{-}} \FunctionTok{do.call}\NormalTok{(rbind, data\_)}
  \FunctionTok{write.csv}\NormalTok{(data, }\FunctionTok{paste0}\NormalTok{(}\StringTok{"./other\_data/melanin\_binding\_adversarial/outer\_"}\NormalTok{, i, }\StringTok{"/cv\_res.csv"}\NormalTok{))}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\hypertarget{cv-1-3}{%
\subsubsection{CV 1}\label{cv-1-3}}

\includegraphics{05_adversarial_computational_control_files/figure-latex/unnamed-chunk-11-1.pdf}

\hypertarget{cv-2-3}{%
\subsubsection{CV 2}\label{cv-2-3}}

\includegraphics{05_adversarial_computational_control_files/figure-latex/unnamed-chunk-12-1.pdf}

\hypertarget{cv-3-3}{%
\subsubsection{CV 3}\label{cv-3-3}}

\includegraphics{05_adversarial_computational_control_files/figure-latex/unnamed-chunk-13-1.pdf}

\hypertarget{cv-4-3}{%
\subsubsection{CV 4}\label{cv-4-3}}

\includegraphics{05_adversarial_computational_control_files/figure-latex/unnamed-chunk-14-1.pdf}

\hypertarget{cv-5-3}{%
\subsubsection{CV 5}\label{cv-5-3}}

\includegraphics{05_adversarial_computational_control_files/figure-latex/unnamed-chunk-15-1.pdf}

\hypertarget{cv-6-3}{%
\subsubsection{CV 6}\label{cv-6-3}}

\includegraphics{05_adversarial_computational_control_files/figure-latex/unnamed-chunk-16-1.pdf}

\hypertarget{cv-7-3}{%
\subsubsection{CV 7}\label{cv-7-3}}

\includegraphics{05_adversarial_computational_control_files/figure-latex/unnamed-chunk-17-1.pdf}

\hypertarget{cv-8-3}{%
\subsubsection{CV 8}\label{cv-8-3}}

\includegraphics{05_adversarial_computational_control_files/figure-latex/unnamed-chunk-18-1.pdf}

\hypertarget{cv-9-3}{%
\subsubsection{CV 9}\label{cv-9-3}}

\includegraphics{05_adversarial_computational_control_files/figure-latex/unnamed-chunk-19-1.pdf}

\hypertarget{cv-10-3}{%
\subsubsection{CV 10}\label{cv-10-3}}

\includegraphics{05_adversarial_computational_control_files/figure-latex/unnamed-chunk-20-1.pdf}

\hypertarget{final-evaluation-3}{%
\subsection{Final evaluation}\label{final-evaluation-3}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{load}\NormalTok{(}\AttributeTok{file =} \StringTok{"./rdata/var\_reduct\_mb\_train\_test\_splits\_y\_shuffled.RData"}\NormalTok{)}
\FunctionTok{load}\NormalTok{(}\AttributeTok{file =} \StringTok{"./rdata/model\_training\_grid\_models\_mb\_ad.RData"}\NormalTok{)}
\NormalTok{dir }\OtherTok{\textless{}{-}} \StringTok{"/Users/renee/Downloads/melanin\_binding\_adversarial"}
\NormalTok{selected\_models }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}
  \StringTok{"Neural network grid model 113"}\NormalTok{, }\StringTok{"Neural network grid model 187"}\NormalTok{,}
  \StringTok{"Neural network grid model 145"}\NormalTok{, }\StringTok{"Neural network grid model 215"}\NormalTok{,}
  \StringTok{"Super learner final"}\NormalTok{, }\StringTok{"Neural network grid model 188"}\NormalTok{,}
  \StringTok{"Neural network grid model 176"}\NormalTok{, }\StringTok{"Neural network grid model 201"}\NormalTok{,}
  \StringTok{"Neural network grid model 139"}\NormalTok{, }\StringTok{"Neural network grid model 160"}
\NormalTok{)}
\NormalTok{mae }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{rmse }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{R2 }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{) \{}
\NormalTok{  holdout\_pred }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"./other\_data/melanin\_binding\_adversarial/outer\_"}\NormalTok{, i, }\StringTok{"/cv\_holdout\_predictions.csv"}\NormalTok{))}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{startsWith}\NormalTok{(selected\_models[i], }\StringTok{"Neural network grid model"}\NormalTok{)) \{}
\NormalTok{    grid\_num }\OtherTok{\textless{}{-}} \FunctionTok{as.integer}\NormalTok{(}\FunctionTok{str\_extract}\NormalTok{(selected\_models[i], }\StringTok{"[0{-}9]+"}\NormalTok{))}
\NormalTok{    m }\OtherTok{\textless{}{-}} \FunctionTok{intersect}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(holdout\_pred), dl\_grid[[grid\_num]])}
\NormalTok{    model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/outer\_"}\NormalTok{, i, }\StringTok{"/"}\NormalTok{, m))}
\NormalTok{  \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{startsWith}\NormalTok{(selected\_models[i], }\StringTok{"GBM grid model"}\NormalTok{)) \{}
\NormalTok{    grid\_num }\OtherTok{\textless{}{-}} \FunctionTok{as.integer}\NormalTok{(}\FunctionTok{str\_extract}\NormalTok{(selected\_models[i], }\StringTok{"[0{-}9]+"}\NormalTok{))}
\NormalTok{    m }\OtherTok{\textless{}{-}} \FunctionTok{intersect}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(holdout\_pred), gbm\_grid[[grid\_num]])}
\NormalTok{    model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/outer\_"}\NormalTok{, i, }\StringTok{"/"}\NormalTok{, m))}
\NormalTok{  \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{startsWith}\NormalTok{(selected\_models[i], }\StringTok{"GBM model"}\NormalTok{)) \{}
\NormalTok{    grid\_num }\OtherTok{\textless{}{-}} \FunctionTok{as.integer}\NormalTok{(}\FunctionTok{str\_extract}\NormalTok{(selected\_models[i], }\StringTok{"[0{-}9]+"}\NormalTok{))}
\NormalTok{    model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/outer\_"}\NormalTok{, i, }\StringTok{"/GBM\_"}\NormalTok{, grid\_num))}
\NormalTok{  \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{startsWith}\NormalTok{(selected\_models[i], }\StringTok{"XGBoost grid model"}\NormalTok{)) \{}
\NormalTok{    grid\_num }\OtherTok{\textless{}{-}} \FunctionTok{as.integer}\NormalTok{(}\FunctionTok{str\_extract}\NormalTok{(selected\_models[i], }\StringTok{"[0{-}9]+"}\NormalTok{))}
\NormalTok{    m }\OtherTok{\textless{}{-}} \FunctionTok{intersect}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(holdout\_pred), xgboost\_grid[[grid\_num]])}
\NormalTok{    model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/outer\_"}\NormalTok{, i, }\StringTok{"/"}\NormalTok{, m))}
\NormalTok{  \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{startsWith}\NormalTok{(selected\_models[i], }\StringTok{"XGBoost model"}\NormalTok{)) \{}
\NormalTok{    grid\_num }\OtherTok{\textless{}{-}} \FunctionTok{as.integer}\NormalTok{(}\FunctionTok{str\_extract}\NormalTok{(selected\_models[i], }\StringTok{"[0{-}9]+"}\NormalTok{))}
\NormalTok{    model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/outer\_"}\NormalTok{, i, }\StringTok{"/XGBoost\_"}\NormalTok{, grid\_num))}
\NormalTok{  \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (selected\_models[i] }\SpecialCharTok{==} \StringTok{"Super learner all models"}\NormalTok{) \{}
\NormalTok{    model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/outer\_"}\NormalTok{, i, }\StringTok{"/superlearner\_iter\_0"}\NormalTok{))}
\NormalTok{  \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (selected\_models[i] }\SpecialCharTok{==} \StringTok{"Super learner final"}\NormalTok{) \{}
\NormalTok{    files }\OtherTok{\textless{}{-}} \FunctionTok{list.files}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/outer\_"}\NormalTok{, i))}
\NormalTok{    files }\OtherTok{\textless{}{-}}\NormalTok{ files[}\FunctionTok{startsWith}\NormalTok{(files, }\StringTok{"superlearner\_iter"}\NormalTok{)]}
\NormalTok{    model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/outer\_"}\NormalTok{, i, }\StringTok{"/"}\NormalTok{, files[}\FunctionTok{length}\NormalTok{(files)]))}
\NormalTok{  \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (selected\_models[i] }\SpecialCharTok{==} \StringTok{"Super learner neural network"}\NormalTok{) \{}
\NormalTok{    model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/outer\_"}\NormalTok{, i, }\StringTok{"/superlearner\_deeplearning"}\NormalTok{))}
\NormalTok{  \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (selected\_models[i] }\SpecialCharTok{==} \StringTok{"Super learner GBM"}\NormalTok{) \{}
\NormalTok{    model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/outer\_"}\NormalTok{, i, }\StringTok{"/superlearner\_gbm"}\NormalTok{))}
\NormalTok{  \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (selected\_models[i] }\SpecialCharTok{==} \StringTok{"Super learner XGBoost"}\NormalTok{) \{}
\NormalTok{    model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/outer\_"}\NormalTok{, i, }\StringTok{"/superlearner\_xgboost"}\NormalTok{))}
\NormalTok{  \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{    model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/outer\_"}\NormalTok{, i, }\StringTok{"/"}\NormalTok{, }\FunctionTok{unlist}\NormalTok{(}\FunctionTok{strsplit}\NormalTok{(selected\_models[i], }\StringTok{" "}\NormalTok{))[}\DecValTok{1}\NormalTok{]))}
\NormalTok{  \}}
\NormalTok{  tmp }\OtherTok{\textless{}{-}} \FunctionTok{as.h2o}\NormalTok{(}\FunctionTok{subset}\NormalTok{(outer\_splits[[i]][[}\StringTok{"test"}\NormalTok{]], }\AttributeTok{select =} \SpecialCharTok{{-}}\NormalTok{log\_intensity))}
\NormalTok{  y\_true }\OtherTok{\textless{}{-}}\NormalTok{ outer\_splits[[i]][[}\StringTok{"test"}\NormalTok{]]}\SpecialCharTok{$}\NormalTok{log\_intensity}
\NormalTok{  y\_pred }\OtherTok{\textless{}{-}} \FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{h2o.predict}\NormalTok{(model, tmp)))[, }\DecValTok{1}\NormalTok{]}
\NormalTok{  mae }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(mae, }\FunctionTok{MAE}\NormalTok{(}\AttributeTok{y\_pred =}\NormalTok{ y\_pred, }\AttributeTok{y\_true =}\NormalTok{ y\_true))}
\NormalTok{  rmse }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(rmse, }\FunctionTok{RMSE}\NormalTok{(}\AttributeTok{y\_pred =}\NormalTok{ y\_pred, }\AttributeTok{y\_true =}\NormalTok{ y\_true))}
\NormalTok{  R2 }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(R2, }\FunctionTok{R2\_Score}\NormalTok{(}\AttributeTok{y\_pred =}\NormalTok{ y\_pred, }\AttributeTok{y\_true =}\NormalTok{ y\_true))}
\NormalTok{\}}

\CommentTok{\# Re{-}scale to 0{-}100}
\NormalTok{mae }\OtherTok{\textless{}{-}} \FunctionTok{rescale}\NormalTok{(mae, }\AttributeTok{to =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{100}\NormalTok{), }\AttributeTok{from =} \FunctionTok{range}\NormalTok{(mb\_data}\SpecialCharTok{$}\NormalTok{log\_intensity))}
\NormalTok{rmse }\OtherTok{\textless{}{-}} \FunctionTok{rescale}\NormalTok{(rmse, }\AttributeTok{to =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{100}\NormalTok{), }\AttributeTok{from =} \FunctionTok{range}\NormalTok{(mb\_data}\SpecialCharTok{$}\NormalTok{log\_intensity))}

\FunctionTok{h2o.removeAll}\NormalTok{()}
\FunctionTok{save}\NormalTok{(mae, rmse, R2, }\AttributeTok{file =} \StringTok{"./rdata/final\_evaluation\_mb\_ad.RData"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{load}\NormalTok{(}\AttributeTok{file =} \StringTok{"./rdata/final\_evaluation\_mb\_ad.RData"}\NormalTok{)}
\FunctionTok{data.frame}\NormalTok{(}
  \AttributeTok{Metric =} \FunctionTok{c}\NormalTok{(}\StringTok{"Norm. MAE"}\NormalTok{, }\StringTok{"Norm. RMSE"}\NormalTok{, }\StringTok{"R\textless{}sup\textgreater{}2\textless{}/sup\textgreater{}"}\NormalTok{),}
  \StringTok{\textasciigrave{}}\AttributeTok{Mean  s.e.m.}\StringTok{\textasciigrave{}} \OtherTok{=} \FunctionTok{c}\NormalTok{(}
    \FunctionTok{paste0}\NormalTok{(}\FunctionTok{round}\NormalTok{(}\FunctionTok{mean}\NormalTok{(mae), }\DecValTok{3}\NormalTok{), }\StringTok{"  "}\NormalTok{, }\FunctionTok{round}\NormalTok{(}\FunctionTok{sem}\NormalTok{(mae), }\DecValTok{3}\NormalTok{)),}
    \FunctionTok{paste0}\NormalTok{(}\FunctionTok{round}\NormalTok{(}\FunctionTok{mean}\NormalTok{(rmse), }\DecValTok{3}\NormalTok{), }\StringTok{"  "}\NormalTok{, }\FunctionTok{round}\NormalTok{(}\FunctionTok{sem}\NormalTok{(rmse), }\DecValTok{3}\NormalTok{)),}
    \FunctionTok{paste0}\NormalTok{(}\FunctionTok{round}\NormalTok{(}\FunctionTok{mean}\NormalTok{(R2), }\DecValTok{3}\NormalTok{), }\StringTok{"  "}\NormalTok{, }\FunctionTok{round}\NormalTok{(}\FunctionTok{sem}\NormalTok{(R2), }\DecValTok{3}\NormalTok{))}
\NormalTok{  ),}
  \AttributeTok{check.names =} \ConstantTok{FALSE}
\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{datatable}\NormalTok{(}\AttributeTok{escape =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{rownames =} \ConstantTok{FALSE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{05_adversarial_computational_control_files/figure-latex/unnamed-chunk-22-1.pdf}

\hypertarget{cell-penetration-classification-3}{%
\section{Cell-penetration (classification)}\label{cell-penetration-classification-3}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{load}\NormalTok{(}\AttributeTok{file =} \StringTok{"./rdata/var\_reduct\_cpp\_train\_test\_splits.RData"}\NormalTok{)}
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{32}\NormalTok{)}

\CommentTok{\# Shuffle the response variable of cross{-}validation training sets}
\ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{) \{}
\NormalTok{  response }\OtherTok{\textless{}{-}}\NormalTok{ outer\_splits[[i]]}\SpecialCharTok{$}\NormalTok{train}\SpecialCharTok{$}\NormalTok{category}
\NormalTok{  response }\OtherTok{\textless{}{-}} \FunctionTok{sample}\NormalTok{(response)}
\NormalTok{  outer\_splits[[i]]}\SpecialCharTok{$}\NormalTok{train}\SpecialCharTok{$}\NormalTok{category }\OtherTok{\textless{}{-}}\NormalTok{ response}
\NormalTok{\}}

\CommentTok{\# Shuffle the response variable of the whole data set}
\NormalTok{response }\OtherTok{\textless{}{-}}\NormalTok{ cpp\_data}\SpecialCharTok{$}\NormalTok{category}
\NormalTok{response }\OtherTok{\textless{}{-}} \FunctionTok{sample}\NormalTok{(response)}
\NormalTok{cpp\_data}\SpecialCharTok{$}\NormalTok{category }\OtherTok{\textless{}{-}}\NormalTok{ response}

\FunctionTok{save}\NormalTok{(cpp\_data, outer\_splits,}
  \AttributeTok{file =} \StringTok{"./rdata/var\_reduct\_cpp\_train\_test\_splits\_y\_shuffled.RData"}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{model-training-4}{%
\subsection{Model training}\label{model-training-4}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{train\_cpp\_models }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(train\_set, exp\_dir, prefix, }\AttributeTok{nfolds =} \DecValTok{10}\NormalTok{, }\AttributeTok{grid\_seed =} \DecValTok{1}\NormalTok{) \{}
\NormalTok{  tmp }\OtherTok{\textless{}{-}} \FunctionTok{as.h2o}\NormalTok{(train\_set, }\AttributeTok{destination\_frame =}\NormalTok{ prefix)}
\NormalTok{  tmp[}\StringTok{"category"}\NormalTok{] }\OtherTok{\textless{}{-}} \FunctionTok{as.factor}\NormalTok{(tmp[}\StringTok{"category"}\NormalTok{])}
\NormalTok{  y }\OtherTok{\textless{}{-}} \StringTok{"category"}
\NormalTok{  x }\OtherTok{\textless{}{-}} \FunctionTok{setdiff}\NormalTok{(}\FunctionTok{names}\NormalTok{(tmp), y)}
\NormalTok{  res }\OtherTok{\textless{}{-}} \FunctionTok{as.data.frame}\NormalTok{(tmp}\SpecialCharTok{$}\NormalTok{category)}
\NormalTok{  samp\_factors }\OtherTok{\textless{}{-}} \FunctionTok{as.vector}\NormalTok{(}\FunctionTok{mean}\NormalTok{(}\FunctionTok{table}\NormalTok{(train\_set}\SpecialCharTok{$}\NormalTok{category)) }\SpecialCharTok{/} \FunctionTok{table}\NormalTok{(train\_set}\SpecialCharTok{$}\NormalTok{category))}
  \CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
  \CommentTok{\# base model training}
  \CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"Deep learning grid 1}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  deeplearning\_1 }\OtherTok{\textless{}{-}} \FunctionTok{h2o.grid}\NormalTok{(}
    \AttributeTok{algorithm =} \StringTok{"deeplearning"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{hyper\_params =}\NormalTok{ deeplearning\_params\_1,}
    \AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{, }\AttributeTok{balance\_classes =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{class\_sampling\_factors =}\NormalTok{ samp\_factors,}
    \AttributeTok{search\_criteria =} \FunctionTok{list}\NormalTok{(}
      \AttributeTok{strategy =} \StringTok{"RandomDiscrete"}\NormalTok{,}
      \AttributeTok{max\_models =} \DecValTok{100}\NormalTok{, }\AttributeTok{seed =}\NormalTok{ grid\_seed}
\NormalTok{    ),}
    \AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}\NormalTok{, }\AttributeTok{parallelism =} \DecValTok{0}
\NormalTok{  )}
  \ControlFlowTok{for}\NormalTok{ (model\_id }\ControlFlowTok{in}\NormalTok{ deeplearning\_1}\SpecialCharTok{@}\NormalTok{model\_ids) \{}
\NormalTok{    tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(model\_id), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  \}}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"GBM grid}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  gbm }\OtherTok{\textless{}{-}} \FunctionTok{h2o.grid}\NormalTok{(}
    \AttributeTok{algorithm =} \StringTok{"gbm"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{hyper\_params =}\NormalTok{ gbm\_params, }\AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{,}
    \AttributeTok{balance\_classes =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{class\_sampling\_factors =}\NormalTok{ samp\_factors,}
    \AttributeTok{search\_criteria =} \FunctionTok{list}\NormalTok{(}\AttributeTok{strategy =} \StringTok{"RandomDiscrete"}\NormalTok{, }\AttributeTok{max\_models =} \DecValTok{100}\NormalTok{, }\AttributeTok{seed =}\NormalTok{ grid\_seed),}
    \AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}\NormalTok{, }\AttributeTok{parallelism =} \DecValTok{0}
\NormalTok{  )}
  \ControlFlowTok{for}\NormalTok{ (model\_id }\ControlFlowTok{in}\NormalTok{ gbm}\SpecialCharTok{@}\NormalTok{model\_ids) \{}
\NormalTok{    tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(model\_id), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  \}}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"GBM 5 default models}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  gbm\_1 }\OtherTok{\textless{}{-}} \FunctionTok{h2o.gbm}\NormalTok{(}
    \AttributeTok{model\_id =} \StringTok{"GBM\_1"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{, }\AttributeTok{score\_tree\_interval =} \DecValTok{5}\NormalTok{,}
    \AttributeTok{balance\_classes =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{class\_sampling\_factors =}\NormalTok{ samp\_factors,}
    \AttributeTok{col\_sample\_rate =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{col\_sample\_rate\_per\_tree =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{learn\_rate =} \FloatTok{0.1}\NormalTok{,}
    \AttributeTok{max\_depth =} \DecValTok{6}\NormalTok{, }\AttributeTok{min\_rows =} \DecValTok{1}\NormalTok{, }\AttributeTok{min\_split\_improvement =} \FloatTok{1e{-}5}\NormalTok{, }\AttributeTok{ntrees =} \DecValTok{10000}\NormalTok{, }\AttributeTok{sample\_rate =} \FloatTok{0.8}\NormalTok{,}
    \AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}
\NormalTok{  )}
\NormalTok{  gbm\_2 }\OtherTok{\textless{}{-}} \FunctionTok{h2o.gbm}\NormalTok{(}
    \AttributeTok{model\_id =} \StringTok{"GBM\_2"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{, }\AttributeTok{score\_tree\_interval =} \DecValTok{5}\NormalTok{,}
    \AttributeTok{balance\_classes =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{class\_sampling\_factors =}\NormalTok{ samp\_factors,}
    \AttributeTok{col\_sample\_rate =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{col\_sample\_rate\_per\_tree =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{learn\_rate =} \FloatTok{0.1}\NormalTok{,}
    \AttributeTok{max\_depth =} \DecValTok{7}\NormalTok{, }\AttributeTok{min\_rows =} \DecValTok{10}\NormalTok{, }\AttributeTok{min\_split\_improvement =} \FloatTok{1e{-}5}\NormalTok{, }\AttributeTok{ntrees =} \DecValTok{10000}\NormalTok{, }\AttributeTok{sample\_rate =} \FloatTok{0.8}\NormalTok{,}
    \AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}
\NormalTok{  )}
\NormalTok{  gbm\_3 }\OtherTok{\textless{}{-}} \FunctionTok{h2o.gbm}\NormalTok{(}
    \AttributeTok{model\_id =} \StringTok{"GBM\_3"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{, }\AttributeTok{score\_tree\_interval =} \DecValTok{5}\NormalTok{,}
    \AttributeTok{balance\_classes =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{class\_sampling\_factors =}\NormalTok{ samp\_factors,}
    \AttributeTok{col\_sample\_rate =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{col\_sample\_rate\_per\_tree =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{learn\_rate =} \FloatTok{0.1}\NormalTok{,}
    \AttributeTok{max\_depth =} \DecValTok{8}\NormalTok{, }\AttributeTok{min\_rows =} \DecValTok{10}\NormalTok{, }\AttributeTok{min\_split\_improvement =} \FloatTok{1e{-}5}\NormalTok{, }\AttributeTok{ntrees =} \DecValTok{10000}\NormalTok{, }\AttributeTok{sample\_rate =} \FloatTok{0.8}\NormalTok{,}
    \AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}
\NormalTok{  )}
\NormalTok{  gbm\_4 }\OtherTok{\textless{}{-}} \FunctionTok{h2o.gbm}\NormalTok{(}
    \AttributeTok{model\_id =} \StringTok{"GBM\_4"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{, }\AttributeTok{score\_tree\_interval =} \DecValTok{5}\NormalTok{,}
    \AttributeTok{balance\_classes =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{class\_sampling\_factors =}\NormalTok{ samp\_factors,}
    \AttributeTok{col\_sample\_rate =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{col\_sample\_rate\_per\_tree =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{learn\_rate =} \FloatTok{0.1}\NormalTok{,}
    \AttributeTok{max\_depth =} \DecValTok{10}\NormalTok{, }\AttributeTok{min\_rows =} \DecValTok{10}\NormalTok{, }\AttributeTok{min\_split\_improvement =} \FloatTok{1e{-}5}\NormalTok{, }\AttributeTok{ntrees =} \DecValTok{10000}\NormalTok{, }\AttributeTok{sample\_rate =} \FloatTok{0.8}\NormalTok{,}
    \AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}
\NormalTok{  )}
\NormalTok{  gbm\_5 }\OtherTok{\textless{}{-}} \FunctionTok{h2o.gbm}\NormalTok{(}
    \AttributeTok{model\_id =} \StringTok{"GBM\_5"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{, }\AttributeTok{score\_tree\_interval =} \DecValTok{5}\NormalTok{,}
    \AttributeTok{balance\_classes =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{class\_sampling\_factors =}\NormalTok{ samp\_factors,}
    \AttributeTok{col\_sample\_rate =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{col\_sample\_rate\_per\_tree =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{learn\_rate =} \FloatTok{0.1}\NormalTok{,}
    \AttributeTok{max\_depth =} \DecValTok{15}\NormalTok{, }\AttributeTok{min\_rows =} \DecValTok{100}\NormalTok{, }\AttributeTok{min\_split\_improvement =} \FloatTok{1e{-}5}\NormalTok{, }\AttributeTok{ntrees =} \DecValTok{10000}\NormalTok{, }\AttributeTok{sample\_rate =} \FloatTok{0.8}\NormalTok{,}
    \AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}
\NormalTok{  )}
  \ControlFlowTok{for}\NormalTok{ (model\_id }\ControlFlowTok{in} \FunctionTok{paste0}\NormalTok{(}\StringTok{"GBM\_"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{5}\NormalTok{)) \{}
\NormalTok{    tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(model\_id), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  \}}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"XGBoost grid}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  xgboost }\OtherTok{\textless{}{-}} \FunctionTok{h2o.grid}\NormalTok{(}
    \AttributeTok{algorithm =} \StringTok{"xgboost"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{hyper\_params =}\NormalTok{ xgboost\_params, }\AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{,}
    \AttributeTok{search\_criteria =} \FunctionTok{list}\NormalTok{(}\AttributeTok{strategy =} \StringTok{"RandomDiscrete"}\NormalTok{, }\AttributeTok{max\_models =} \DecValTok{100}\NormalTok{, }\AttributeTok{seed =}\NormalTok{ grid\_seed),}
    \AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}\NormalTok{, }\AttributeTok{parallelism =} \DecValTok{0}
\NormalTok{  )}
  \ControlFlowTok{for}\NormalTok{ (model\_id }\ControlFlowTok{in}\NormalTok{ xgboost}\SpecialCharTok{@}\NormalTok{model\_ids) \{}
\NormalTok{    tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(model\_id), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  \}}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"XGBoost 3 default models}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  xgboost\_1 }\OtherTok{\textless{}{-}} \FunctionTok{h2o.xgboost}\NormalTok{(}
    \AttributeTok{model\_id =} \StringTok{"XGBoost\_1"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{, }\AttributeTok{score\_tree\_interval =} \DecValTok{5}\NormalTok{,}
    \AttributeTok{booster =} \StringTok{"gbtree"}\NormalTok{, }\AttributeTok{col\_sample\_rate =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{col\_sample\_rate\_per\_tree =} \FloatTok{0.8}\NormalTok{,}
    \AttributeTok{max\_depth =} \DecValTok{10}\NormalTok{, }\AttributeTok{min\_rows =} \DecValTok{5}\NormalTok{, }\AttributeTok{ntrees =} \DecValTok{10000}\NormalTok{, }\AttributeTok{reg\_alpha =} \DecValTok{0}\NormalTok{, }\AttributeTok{reg\_lambda =} \DecValTok{1}\NormalTok{,}
    \AttributeTok{sample\_rate =} \FloatTok{0.6}\NormalTok{, }\AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}
\NormalTok{  )}
\NormalTok{  xgboost\_2 }\OtherTok{\textless{}{-}} \FunctionTok{h2o.xgboost}\NormalTok{(}
    \AttributeTok{model\_id =} \StringTok{"XGBoost\_2"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{, }\AttributeTok{score\_tree\_interval =} \DecValTok{5}\NormalTok{,}
    \AttributeTok{booster =} \StringTok{"gbtree"}\NormalTok{, }\AttributeTok{col\_sample\_rate =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{col\_sample\_rate\_per\_tree =} \FloatTok{0.8}\NormalTok{,}
    \AttributeTok{max\_depth =} \DecValTok{20}\NormalTok{, }\AttributeTok{min\_rows =} \DecValTok{10}\NormalTok{, }\AttributeTok{ntrees =} \DecValTok{10000}\NormalTok{, }\AttributeTok{reg\_alpha =} \DecValTok{0}\NormalTok{, }\AttributeTok{reg\_lambda =} \DecValTok{1}\NormalTok{,}
    \AttributeTok{sample\_rate =} \FloatTok{0.6}\NormalTok{, }\AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}
\NormalTok{  )}
\NormalTok{  xgboost\_3 }\OtherTok{\textless{}{-}} \FunctionTok{h2o.xgboost}\NormalTok{(}
    \AttributeTok{model\_id =} \StringTok{"XGBoost\_3"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{, }\AttributeTok{score\_tree\_interval =} \DecValTok{5}\NormalTok{,}
    \AttributeTok{booster =} \StringTok{"gbtree"}\NormalTok{, }\AttributeTok{col\_sample\_rate =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{col\_sample\_rate\_per\_tree =} \FloatTok{0.8}\NormalTok{,}
    \AttributeTok{max\_depth =} \DecValTok{5}\NormalTok{, }\AttributeTok{min\_rows =} \DecValTok{3}\NormalTok{, }\AttributeTok{ntrees =} \DecValTok{10000}\NormalTok{, }\AttributeTok{reg\_alpha =} \DecValTok{0}\NormalTok{, }\AttributeTok{reg\_lambda =} \DecValTok{1}\NormalTok{,}
    \AttributeTok{sample\_rate =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}
\NormalTok{  )}
  \ControlFlowTok{for}\NormalTok{ (model\_id }\ControlFlowTok{in} \FunctionTok{paste0}\NormalTok{(}\StringTok{"XGBoost\_"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{)) \{}
\NormalTok{    tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(model\_id), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  \}}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"DRF}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  drf }\OtherTok{\textless{}{-}} \FunctionTok{h2o.randomForest}\NormalTok{(}
    \AttributeTok{model\_id =} \StringTok{"DRF"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{ntrees =} \DecValTok{10000}\NormalTok{,}
    \AttributeTok{score\_tree\_interval =} \DecValTok{5}\NormalTok{, }\AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{,}
    \AttributeTok{balance\_classes =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{class\_sampling\_factors =}\NormalTok{ samp\_factors,}
    \AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}
\NormalTok{  )}
\NormalTok{  tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(}\StringTok{"DRF"}\NormalTok{), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"XRT}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  xrt }\OtherTok{\textless{}{-}} \FunctionTok{h2o.randomForest}\NormalTok{(}
    \AttributeTok{model\_id =} \StringTok{"XRT"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{ntrees =} \DecValTok{10000}\NormalTok{, }\AttributeTok{histogram\_type =} \StringTok{"Random"}\NormalTok{,}
    \AttributeTok{score\_tree\_interval =} \DecValTok{5}\NormalTok{, }\AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{,}
    \AttributeTok{balance\_classes =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{class\_sampling\_factors =}\NormalTok{ samp\_factors,}
    \AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}
\NormalTok{  )}
\NormalTok{  tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(}\StringTok{"XRT"}\NormalTok{), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
  \CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
  \CommentTok{\# get holdout predictions}
  \CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\NormalTok{  base\_models }\OtherTok{\textless{}{-}} \FunctionTok{as.list}\NormalTok{(}\FunctionTok{c}\NormalTok{(}
    \FunctionTok{unlist}\NormalTok{(deeplearning\_1}\SpecialCharTok{@}\NormalTok{model\_ids),}
    \FunctionTok{unlist}\NormalTok{(gbm}\SpecialCharTok{@}\NormalTok{model\_ids), }\FunctionTok{paste0}\NormalTok{(}\StringTok{"GBM\_"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{5}\NormalTok{),}
    \FunctionTok{unlist}\NormalTok{(xgboost}\SpecialCharTok{@}\NormalTok{model\_ids), }\FunctionTok{paste0}\NormalTok{(}\StringTok{"XGBoost\_"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{),}
    \StringTok{"DRF"}\NormalTok{,}
    \StringTok{"XRT"}
\NormalTok{  ))}
  \ControlFlowTok{for}\NormalTok{ (model\_id }\ControlFlowTok{in}\NormalTok{ base\_models) \{}
\NormalTok{    res }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(res, }\FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{h2o.getFrame}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"cv\_holdout\_prediction\_"}\NormalTok{, model\_id))[}\StringTok{"penetrating"}\NormalTok{],}
      \AttributeTok{col.names =}\NormalTok{ model\_id}
\NormalTok{    ))}
\NormalTok{  \}}
  \CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
  \CommentTok{\# super learner training}
  \CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\NormalTok{  sl\_iter }\OtherTok{\textless{}{-}} \DecValTok{0}
  \FunctionTok{cat}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"Super learner iteration "}\NormalTok{, sl\_iter, }\StringTok{" ("}\NormalTok{, }\FunctionTok{length}\NormalTok{(base\_models), }\StringTok{" models)}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{))}
\NormalTok{  sl }\OtherTok{\textless{}{-}} \FunctionTok{h2o.stackedEnsemble}\NormalTok{(}
    \AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{model\_id =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"superlearner\_iter\_"}\NormalTok{, sl\_iter),}
    \AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{,}
    \AttributeTok{base\_models =}\NormalTok{ base\_models,}
    \AttributeTok{metalearner\_algorithm =} \StringTok{"glm"}\NormalTok{,}
    \AttributeTok{metalearner\_nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_levelone\_frame =} \ConstantTok{TRUE}\NormalTok{,}
    \AttributeTok{metalearner\_params =} \FunctionTok{list}\NormalTok{(}
      \AttributeTok{standardize =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{,}
      \AttributeTok{balance\_classes =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{class\_sampling\_factors =}\NormalTok{ samp\_factors}
\NormalTok{    )}
\NormalTok{  )}
\NormalTok{  tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"superlearner\_iter\_"}\NormalTok{, sl\_iter)), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  model\_id }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"metalearner\_glm\_superlearner\_iter\_"}\NormalTok{, sl\_iter)}
\NormalTok{  tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(model\_id), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  res }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(res, }\FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{h2o.getFrame}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"cv\_holdout\_prediction\_"}\NormalTok{, model\_id))[}\StringTok{"penetrating"}\NormalTok{],}
    \AttributeTok{col.names =} \FunctionTok{paste0}\NormalTok{(model\_id, }\StringTok{"\_"}\NormalTok{, }\FunctionTok{length}\NormalTok{(base\_models), }\StringTok{"\_models"}\NormalTok{)}
\NormalTok{  ))}
  \CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
  \CommentTok{\# super learner base model reduction}
  \CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
  \ControlFlowTok{while}\NormalTok{ (}\ConstantTok{TRUE}\NormalTok{) \{}
\NormalTok{    meta }\OtherTok{\textless{}{-}} \FunctionTok{h2o.getModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"metalearner\_glm\_superlearner\_iter\_"}\NormalTok{, sl\_iter, }\StringTok{"\_cv\_1"}\NormalTok{))}
\NormalTok{    names }\OtherTok{\textless{}{-}}\NormalTok{ meta}\SpecialCharTok{@}\NormalTok{model}\SpecialCharTok{$}\NormalTok{coefficients\_table[, }\StringTok{"names"}\NormalTok{]}
\NormalTok{    coeffs }\OtherTok{\textless{}{-}}\NormalTok{ (meta}\SpecialCharTok{@}\NormalTok{model}\SpecialCharTok{$}\NormalTok{coefficients\_table[, }\StringTok{"standardized\_coefficients"}\NormalTok{] }\SpecialCharTok{\textgreater{}} \DecValTok{0}\NormalTok{)}
    \ControlFlowTok{for}\NormalTok{ (j }\ControlFlowTok{in} \DecValTok{2}\SpecialCharTok{:}\NormalTok{nfolds) \{}
\NormalTok{      meta }\OtherTok{\textless{}{-}} \FunctionTok{h2o.getModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"metalearner\_glm\_superlearner\_iter\_"}\NormalTok{, sl\_iter, }\StringTok{"\_cv\_"}\NormalTok{, j))}
\NormalTok{      names }\OtherTok{\textless{}{-}}\NormalTok{ meta}\SpecialCharTok{@}\NormalTok{model}\SpecialCharTok{$}\NormalTok{coefficients\_table[, }\StringTok{"names"}\NormalTok{]}
\NormalTok{      coeffs }\OtherTok{\textless{}{-}}\NormalTok{ coeffs }\SpecialCharTok{+}\NormalTok{ (meta}\SpecialCharTok{@}\NormalTok{model}\SpecialCharTok{$}\NormalTok{coefficients\_table[, }\StringTok{"standardized\_coefficients"}\NormalTok{] }\SpecialCharTok{\textgreater{}} \DecValTok{0}\NormalTok{)}
\NormalTok{    \}}
\NormalTok{    base\_models\_ }\OtherTok{\textless{}{-}} \FunctionTok{as.list}\NormalTok{(names[coeffs }\SpecialCharTok{\textgreater{}=} \FunctionTok{ceiling}\NormalTok{(nfolds }\SpecialCharTok{/} \DecValTok{2}\NormalTok{) }\SpecialCharTok{\&}\NormalTok{ names }\SpecialCharTok{!=} \StringTok{"Intercept"}\NormalTok{])}
    \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{length}\NormalTok{(base\_models\_) }\SpecialCharTok{==} \DecValTok{0}\NormalTok{) \{}
      \FunctionTok{cat}\NormalTok{(}\StringTok{"No base models passing the threshold}\SpecialCharTok{\textbackslash{}n\textbackslash{}n}\StringTok{"}\NormalTok{)}
      \ControlFlowTok{break}
\NormalTok{    \}}
    \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{sum}\NormalTok{(base\_models }\SpecialCharTok{\%in\%}\NormalTok{ base\_models\_) }\SpecialCharTok{==} \FunctionTok{length}\NormalTok{(base\_models)) \{}
      \FunctionTok{cat}\NormalTok{(}\StringTok{"No further reduction of base models}\SpecialCharTok{\textbackslash{}n\textbackslash{}n}\StringTok{"}\NormalTok{)}
      \ControlFlowTok{break}
\NormalTok{    \}}
\NormalTok{    sl\_iter }\OtherTok{\textless{}{-}}\NormalTok{ sl\_iter }\SpecialCharTok{+} \DecValTok{1}
\NormalTok{    base\_models }\OtherTok{\textless{}{-}}\NormalTok{ base\_models\_}
    \FunctionTok{cat}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"Super learner iteration "}\NormalTok{, sl\_iter, }\StringTok{" ("}\NormalTok{, }\FunctionTok{length}\NormalTok{(base\_models), }\StringTok{" models)}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{))}
\NormalTok{    sl }\OtherTok{\textless{}{-}} \FunctionTok{h2o.stackedEnsemble}\NormalTok{(}
      \AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{model\_id =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"superlearner\_iter\_"}\NormalTok{, sl\_iter),}
      \AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{,}
      \AttributeTok{base\_models =}\NormalTok{ base\_models,}
      \AttributeTok{metalearner\_algorithm =} \StringTok{"glm"}\NormalTok{,}
      \AttributeTok{metalearner\_nfolds =}\NormalTok{ nfolds,}
      \AttributeTok{keep\_levelone\_frame =} \ConstantTok{TRUE}\NormalTok{,}
      \AttributeTok{metalearner\_params =} \FunctionTok{list}\NormalTok{(}
        \AttributeTok{standardize =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{,}
        \AttributeTok{balance\_classes =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{class\_sampling\_factors =}\NormalTok{ samp\_factors}
\NormalTok{      )}
\NormalTok{    )}
\NormalTok{    tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"superlearner\_iter\_"}\NormalTok{, sl\_iter)), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{    model\_id }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"metalearner\_glm\_superlearner\_iter\_"}\NormalTok{, sl\_iter)}
\NormalTok{    tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(model\_id), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{    res }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(res, }\FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{h2o.getFrame}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"cv\_holdout\_prediction\_"}\NormalTok{, model\_id))[}\StringTok{"penetrating"}\NormalTok{],}
      \AttributeTok{col.names =} \FunctionTok{paste0}\NormalTok{(model\_id, }\StringTok{"\_"}\NormalTok{, }\FunctionTok{length}\NormalTok{(base\_models), }\StringTok{"\_models"}\NormalTok{)}
\NormalTok{    ))}
\NormalTok{  \}}
  \CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
  \CommentTok{\# super learner for homogeneous base models}
  \CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
  \CommentTok{\# DeepLearning}
\NormalTok{  base\_models }\OtherTok{\textless{}{-}}\NormalTok{ deeplearning\_1}\SpecialCharTok{@}\NormalTok{model\_ids}
  \FunctionTok{cat}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"Super learner deep learning ("}\NormalTok{, }\FunctionTok{length}\NormalTok{(base\_models), }\StringTok{" models)}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{))}
\NormalTok{  sl }\OtherTok{\textless{}{-}} \FunctionTok{h2o.stackedEnsemble}\NormalTok{(}
    \AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{model\_id =} \StringTok{"superlearner\_deeplearning"}\NormalTok{,}
    \AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{,}
    \AttributeTok{base\_models =}\NormalTok{ base\_models,}
    \AttributeTok{metalearner\_algorithm =} \StringTok{"glm"}\NormalTok{,}
    \AttributeTok{metalearner\_nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_levelone\_frame =} \ConstantTok{TRUE}\NormalTok{,}
    \AttributeTok{metalearner\_params =} \FunctionTok{list}\NormalTok{(}
      \AttributeTok{standardize =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{,}
      \AttributeTok{balance\_classes =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{class\_sampling\_factors =}\NormalTok{ samp\_factors}
\NormalTok{    )}
\NormalTok{  )}
\NormalTok{  tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(}\StringTok{"superlearner\_deeplearning"}\NormalTok{), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  model\_id }\OtherTok{\textless{}{-}} \StringTok{"metalearner\_glm\_superlearner\_deeplearning"}
\NormalTok{  tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(model\_id), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  res }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(res, }\FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{h2o.getFrame}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"cv\_holdout\_prediction\_"}\NormalTok{, model\_id))[}\StringTok{"penetrating"}\NormalTok{],}
    \AttributeTok{col.names =} \FunctionTok{paste0}\NormalTok{(model\_id, }\StringTok{"\_"}\NormalTok{, }\FunctionTok{length}\NormalTok{(base\_models), }\StringTok{"\_models"}\NormalTok{)}
\NormalTok{  ))}
  \CommentTok{\# GBM}
\NormalTok{  base\_models }\OtherTok{\textless{}{-}} \FunctionTok{as.list}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\FunctionTok{unlist}\NormalTok{(gbm}\SpecialCharTok{@}\NormalTok{model\_ids), }\FunctionTok{paste0}\NormalTok{(}\StringTok{"GBM\_"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{5}\NormalTok{)))}
  \FunctionTok{cat}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"Super learner GBM ("}\NormalTok{, }\FunctionTok{length}\NormalTok{(base\_models), }\StringTok{" models)}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{))}
\NormalTok{  sl }\OtherTok{\textless{}{-}} \FunctionTok{h2o.stackedEnsemble}\NormalTok{(}
    \AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{model\_id =} \StringTok{"superlearner\_gbm"}\NormalTok{,}
    \AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{,}
    \AttributeTok{base\_models =}\NormalTok{ base\_models,}
    \AttributeTok{metalearner\_algorithm =} \StringTok{"glm"}\NormalTok{,}
    \AttributeTok{metalearner\_nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_levelone\_frame =} \ConstantTok{TRUE}\NormalTok{,}
    \AttributeTok{metalearner\_params =} \FunctionTok{list}\NormalTok{(}
      \AttributeTok{standardize =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{,}
      \AttributeTok{balance\_classes =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{class\_sampling\_factors =}\NormalTok{ samp\_factors}
\NormalTok{    )}
\NormalTok{  )}
\NormalTok{  tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(}\StringTok{"superlearner\_gbm"}\NormalTok{), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  model\_id }\OtherTok{\textless{}{-}} \StringTok{"metalearner\_glm\_superlearner\_gbm"}
\NormalTok{  tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(model\_id), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  res }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(res, }\FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{h2o.getFrame}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"cv\_holdout\_prediction\_"}\NormalTok{, model\_id))[}\StringTok{"penetrating"}\NormalTok{],}
    \AttributeTok{col.names =} \FunctionTok{paste0}\NormalTok{(model\_id, }\StringTok{"\_"}\NormalTok{, }\FunctionTok{length}\NormalTok{(base\_models), }\StringTok{"\_models"}\NormalTok{)}
\NormalTok{  ))}
  \CommentTok{\# XGBoost}
\NormalTok{  base\_models }\OtherTok{\textless{}{-}} \FunctionTok{as.list}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\FunctionTok{unlist}\NormalTok{(xgboost}\SpecialCharTok{@}\NormalTok{model\_ids), }\FunctionTok{paste0}\NormalTok{(}\StringTok{"XGBoost\_"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{)))}
  \FunctionTok{cat}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"Super learner XGBoost ("}\NormalTok{, }\FunctionTok{length}\NormalTok{(base\_models), }\StringTok{" models)}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{))}
\NormalTok{  sl }\OtherTok{\textless{}{-}} \FunctionTok{h2o.stackedEnsemble}\NormalTok{(}
    \AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{model\_id =} \StringTok{"superlearner\_xgboost"}\NormalTok{,}
    \AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{,}
    \AttributeTok{base\_models =}\NormalTok{ base\_models,}
    \AttributeTok{metalearner\_algorithm =} \StringTok{"glm"}\NormalTok{,}
    \AttributeTok{metalearner\_nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_levelone\_frame =} \ConstantTok{TRUE}\NormalTok{,}
    \AttributeTok{metalearner\_params =} \FunctionTok{list}\NormalTok{(}
      \AttributeTok{standardize =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{,}
      \AttributeTok{balance\_classes =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{class\_sampling\_factors =}\NormalTok{ samp\_factors}
\NormalTok{    )}
\NormalTok{  )}
\NormalTok{  tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(}\StringTok{"superlearner\_xgboost"}\NormalTok{), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  model\_id }\OtherTok{\textless{}{-}} \StringTok{"metalearner\_glm\_superlearner\_xgboost"}
\NormalTok{  tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(model\_id), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  res }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(res, }\FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{h2o.getFrame}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"cv\_holdout\_prediction\_"}\NormalTok{, model\_id))[}\StringTok{"penetrating"}\NormalTok{],}
    \AttributeTok{col.names =} \FunctionTok{paste0}\NormalTok{(model\_id, }\StringTok{"\_"}\NormalTok{, }\FunctionTok{length}\NormalTok{(base\_models), }\StringTok{"\_models"}\NormalTok{)}
\NormalTok{  ))}
  \FunctionTok{write.csv}\NormalTok{(res, }\AttributeTok{file =} \FunctionTok{paste0}\NormalTok{(exp\_dir, }\StringTok{"/cv\_holdout\_predictions.csv"}\NormalTok{), }\AttributeTok{row.names =} \ConstantTok{FALSE}\NormalTok{)}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}n\textbackslash{}n}\StringTok{"}\NormalTok{)}
  \FunctionTok{h2o.removeAll}\NormalTok{()}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\hypertarget{inner-cross-validation-4}{%
\subsection{Inner cross-validation}\label{inner-cross-validation-4}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{load}\NormalTok{(}\AttributeTok{file =} \StringTok{"./rdata/var\_reduct\_cpp\_train\_test\_splits\_y\_shuffled.RData"}\NormalTok{)}
\ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{) \{}
  \FunctionTok{cat}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"Outer training set "}\NormalTok{, i, }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{))}
\NormalTok{  prefix }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"outer\_"}\NormalTok{, i)}
\NormalTok{  exp\_dir }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"/Users/renee/Downloads/cell\_penetration\_adversarial/"}\NormalTok{, prefix)}
  \FunctionTok{dir.create}\NormalTok{(exp\_dir)}
  \FunctionTok{train\_cpp\_models}\NormalTok{(}\AttributeTok{train\_set =}\NormalTok{ outer\_splits[[i]][[}\StringTok{"train"}\NormalTok{]], }\AttributeTok{exp\_dir =}\NormalTok{ exp\_dir, }\AttributeTok{prefix =}\NormalTok{ prefix)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Keep track of grid models}
\NormalTok{dl\_grid }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
\NormalTok{gbm\_grid }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
\NormalTok{xgboost\_grid }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
\NormalTok{dl\_grid\_params }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
\NormalTok{gbm\_grid\_params }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
\NormalTok{xgboost\_grid\_params }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
\ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{) \{}
  \FunctionTok{cat}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"Outer training set "}\NormalTok{, i, }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{))}
\NormalTok{  prefix }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"outer\_"}\NormalTok{, i)}
\NormalTok{  dir }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"/Users/renee/Downloads/cell\_penetration\_adversarial/"}\NormalTok{, prefix)}
\NormalTok{  files }\OtherTok{\textless{}{-}} \FunctionTok{list.files}\NormalTok{(dir)}
  \CommentTok{\# Deep learning}
\NormalTok{  dl }\OtherTok{\textless{}{-}}\NormalTok{ files[}\FunctionTok{str\_detect}\NormalTok{(files, }\StringTok{"DeepLearning\_model"}\NormalTok{)]}
  \ControlFlowTok{for}\NormalTok{ (m }\ControlFlowTok{in}\NormalTok{ dl) \{}
\NormalTok{    model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/"}\NormalTok{, m))}
\NormalTok{    hs }\OtherTok{\textless{}{-}} \FunctionTok{sha1}\NormalTok{(}\FunctionTok{paste}\NormalTok{(}\FunctionTok{c}\NormalTok{(}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{epsilon,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{hidden,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{hidden\_dropout\_ratios,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{input\_dropout\_ratio,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{rho}
\NormalTok{    ), }\AttributeTok{collapse =} \StringTok{" "}\NormalTok{))}
    \ControlFlowTok{if}\NormalTok{ (hs }\SpecialCharTok{\%in\%} \FunctionTok{names}\NormalTok{(dl\_grid)) \{}
\NormalTok{      dl\_grid[[hs]] }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(dl\_grid[[hs]], m)}
\NormalTok{    \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{      dl\_grid[[hs]] }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(m)}
\NormalTok{      dl\_grid\_params }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(}
\NormalTok{        dl\_grid\_params,}
        \FunctionTok{c}\NormalTok{(}
          \StringTok{"epsilon"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{epsilon,}
          \StringTok{"hidden"} \OtherTok{=} \FunctionTok{paste0}\NormalTok{(}\StringTok{"["}\NormalTok{, }\FunctionTok{paste}\NormalTok{(model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{hidden, }\AttributeTok{collapse =} \StringTok{","}\NormalTok{), }\StringTok{"]"}\NormalTok{),}
          \StringTok{"hidden\_dropout\_ratios"} \OtherTok{=} \FunctionTok{paste0}\NormalTok{(}
            \StringTok{"["}\NormalTok{,}
            \FunctionTok{paste}\NormalTok{(model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{hidden\_dropout\_ratios,}
              \AttributeTok{collapse =} \StringTok{","}
\NormalTok{            ), }\StringTok{"]"}
\NormalTok{          ),}
          \StringTok{"input\_dropout\_ratio"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{input\_dropout\_ratio,}
          \StringTok{"rho"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{rho}
\NormalTok{        )}
\NormalTok{      )}
\NormalTok{    \}}
\NormalTok{  \}}
  \FunctionTok{h2o.removeAll}\NormalTok{()}
  \CommentTok{\# GBM}
\NormalTok{  gbm }\OtherTok{\textless{}{-}}\NormalTok{ files[}\FunctionTok{str\_detect}\NormalTok{(files, }\StringTok{"GBM\_model"}\NormalTok{)]}
  \ControlFlowTok{for}\NormalTok{ (m }\ControlFlowTok{in}\NormalTok{ gbm) \{}
\NormalTok{    model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/"}\NormalTok{, m))}
\NormalTok{    hs }\OtherTok{\textless{}{-}} \FunctionTok{sha1}\NormalTok{(}\FunctionTok{paste}\NormalTok{(}\FunctionTok{c}\NormalTok{(}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{col\_sample\_rate,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{col\_sample\_rate\_per\_tree,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{max\_depth,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{min\_rows,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{min\_split\_improvement,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{sample\_rate}
\NormalTok{    ), }\AttributeTok{collapse =} \StringTok{" "}\NormalTok{))}
    \ControlFlowTok{if}\NormalTok{ (hs }\SpecialCharTok{\%in\%} \FunctionTok{names}\NormalTok{(gbm\_grid)) \{}
\NormalTok{      gbm\_grid[[hs]] }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(gbm\_grid[[hs]], m)}
\NormalTok{    \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{      gbm\_grid[[hs]] }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(m)}
\NormalTok{      gbm\_grid\_params }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(}
\NormalTok{        gbm\_grid\_params,}
        \FunctionTok{c}\NormalTok{(}
          \StringTok{"col\_sample\_rate"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{col\_sample\_rate,}
          \StringTok{"col\_sample\_rate\_per\_tree"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{col\_sample\_rate\_per\_tree,}
          \StringTok{"max\_depth"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{max\_depth,}
          \StringTok{"min\_rows"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{min\_rows,}
          \StringTok{"min\_split\_improvement"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{min\_split\_improvement,}
          \StringTok{"sample\_rate"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{sample\_rate}
\NormalTok{        )}
\NormalTok{      )}
\NormalTok{    \}}
\NormalTok{  \}}
  \FunctionTok{h2o.removeAll}\NormalTok{()}
  \CommentTok{\# XGBoost}
\NormalTok{  xgboost }\OtherTok{\textless{}{-}}\NormalTok{ files[}\FunctionTok{str\_detect}\NormalTok{(files, }\StringTok{"XGBoost\_model"}\NormalTok{)]}
  \ControlFlowTok{for}\NormalTok{ (m }\ControlFlowTok{in}\NormalTok{ xgboost) \{}
\NormalTok{    model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/"}\NormalTok{, m))}
\NormalTok{    hs }\OtherTok{\textless{}{-}} \FunctionTok{sha1}\NormalTok{(}\FunctionTok{paste}\NormalTok{(}\FunctionTok{c}\NormalTok{(}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{booster,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{col\_sample\_rate,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{col\_sample\_rate\_per\_tree,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{max\_depth,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{min\_rows,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{reg\_alpha,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{reg\_lambda,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{sample\_rate}
\NormalTok{    ), }\AttributeTok{collapse =} \StringTok{" "}\NormalTok{))}
    \ControlFlowTok{if}\NormalTok{ (hs }\SpecialCharTok{\%in\%} \FunctionTok{names}\NormalTok{(xgboost\_grid)) \{}
\NormalTok{      xgboost\_grid[[hs]] }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(xgboost\_grid[[hs]], m)}
\NormalTok{    \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{      xgboost\_grid[[hs]] }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(m)}
\NormalTok{      xgboost\_grid\_params }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(}
\NormalTok{        xgboost\_grid\_params,}
        \FunctionTok{c}\NormalTok{(}
          \StringTok{"booster"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{booster,}
          \StringTok{"col\_sample\_rate"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{col\_sample\_rate,}
          \StringTok{"col\_sample\_rate\_per\_tree"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{col\_sample\_rate\_per\_tree,}
          \StringTok{"max\_depth"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{max\_depth,}
          \StringTok{"min\_rows"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{min\_rows,}
          \StringTok{"reg\_alpha"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{reg\_alpha,}
          \StringTok{"reg\_lambda"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{reg\_lambda,}
          \StringTok{"sample\_rate"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{sample\_rate}
\NormalTok{        )}
\NormalTok{      )}
\NormalTok{    \}}
\NormalTok{  \}}
  \FunctionTok{h2o.removeAll}\NormalTok{()}
\NormalTok{\}}

\NormalTok{dl\_grid\_params }\OtherTok{\textless{}{-}} \FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{t}\NormalTok{(}\FunctionTok{data.frame}\NormalTok{(dl\_grid\_params)))}
\FunctionTok{rownames}\NormalTok{(dl\_grid\_params) }\OtherTok{\textless{}{-}} \FunctionTok{paste}\NormalTok{(}\StringTok{"Neural network grid model"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(dl\_grid\_params))}

\NormalTok{gbm\_grid\_params }\OtherTok{\textless{}{-}} \FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{t}\NormalTok{(}\FunctionTok{data.frame}\NormalTok{(gbm\_grid\_params)))}
\FunctionTok{rownames}\NormalTok{(gbm\_grid\_params) }\OtherTok{\textless{}{-}} \FunctionTok{paste}\NormalTok{(}\StringTok{"GBM grid model"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(gbm\_grid\_params))}

\NormalTok{xgboost\_grid\_params }\OtherTok{\textless{}{-}} \FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{t}\NormalTok{(}\FunctionTok{data.frame}\NormalTok{(xgboost\_grid\_params)))}
\FunctionTok{rownames}\NormalTok{(xgboost\_grid\_params) }\OtherTok{\textless{}{-}} \FunctionTok{paste}\NormalTok{(}\StringTok{"XGBoost grid model"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(xgboost\_grid\_params))}

\FunctionTok{write.csv}\NormalTok{(dl\_grid\_params, }\StringTok{"./other\_data/cell\_penetration\_adversarial/neural\_network\_grid\_params.csv"}\NormalTok{)}
\FunctionTok{write.csv}\NormalTok{(gbm\_grid\_params, }\StringTok{"./other\_data/cell\_penetration\_adversarial/gbm\_grid\_params.csv"}\NormalTok{)}
\FunctionTok{write.csv}\NormalTok{(xgboost\_grid\_params, }\StringTok{"./other\_data/cell\_penetration\_adversarial/xgboost\_grid\_params.csv"}\NormalTok{)}

\FunctionTok{save}\NormalTok{(dl\_grid, gbm\_grid, xgboost\_grid, }\AttributeTok{file =} \StringTok{"./rdata/model\_training\_grid\_models\_cpp\_ad.RData"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{model-evaluation-4}{%
\subsection{Model evaluation}\label{model-evaluation-4}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{model\_evaluation }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(holdout\_pred, fold\_asign, grid\_name, }\AttributeTok{grid\_meta =} \ConstantTok{NULL}\NormalTok{) \{}
\NormalTok{  res\_ }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
\NormalTok{  model\_num }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{startsWith}\NormalTok{(grid\_name, }\StringTok{"Super learner"}\NormalTok{)) \{}
    \ControlFlowTok{if}\NormalTok{ (grid\_name }\SpecialCharTok{==} \StringTok{"Super learner all models"}\NormalTok{) \{}
\NormalTok{      m }\OtherTok{\textless{}{-}} \FunctionTok{colnames}\NormalTok{(holdout\_pred)[}\FunctionTok{startsWith}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(holdout\_pred), }\StringTok{"metalearner\_glm\_superlearner\_iter\_0"}\NormalTok{)]}
\NormalTok{    \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (grid\_name }\SpecialCharTok{==} \StringTok{"Super learner final"}\NormalTok{) \{}
\NormalTok{      sl\_models }\OtherTok{\textless{}{-}} \FunctionTok{colnames}\NormalTok{(holdout\_pred)[}\FunctionTok{startsWith}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(holdout\_pred), }\StringTok{"metalearner\_glm\_superlearner\_iter"}\NormalTok{)]}
\NormalTok{      m }\OtherTok{\textless{}{-}}\NormalTok{ sl\_models[}\FunctionTok{length}\NormalTok{(sl\_models)]}
\NormalTok{    \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (grid\_name }\SpecialCharTok{==} \StringTok{"Super learner neural network"}\NormalTok{) \{}
\NormalTok{      m }\OtherTok{\textless{}{-}} \FunctionTok{colnames}\NormalTok{(holdout\_pred)[}\FunctionTok{startsWith}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(holdout\_pred), }\StringTok{"metalearner\_glm\_superlearner\_deeplearning"}\NormalTok{)]}
\NormalTok{    \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (grid\_name }\SpecialCharTok{==} \StringTok{"Super learner GBM"}\NormalTok{) \{}
\NormalTok{      m }\OtherTok{\textless{}{-}} \FunctionTok{colnames}\NormalTok{(holdout\_pred)[}\FunctionTok{startsWith}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(holdout\_pred), }\StringTok{"metalearner\_glm\_superlearner\_gbm"}\NormalTok{)]}
\NormalTok{    \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (grid\_name }\SpecialCharTok{==} \StringTok{"Super learner XGBoost"}\NormalTok{) \{}
\NormalTok{      m }\OtherTok{\textless{}{-}} \FunctionTok{colnames}\NormalTok{(holdout\_pred)[}\FunctionTok{startsWith}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(holdout\_pred), }\StringTok{"metalearner\_glm\_superlearner\_xgboost"}\NormalTok{)]}
\NormalTok{    \}}
\NormalTok{    logloss }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{    MCC }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{    F1 }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{    acc }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{    EF }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{    BEDROC }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{    threshold }\OtherTok{\textless{}{-}} \FloatTok{0.5}
    \ControlFlowTok{for}\NormalTok{ (k }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{) \{}
\NormalTok{      y\_true }\OtherTok{\textless{}{-}} \FunctionTok{sapply}\NormalTok{(holdout\_pred[fold\_assign }\SpecialCharTok{==}\NormalTok{ k, }\StringTok{"category"}\NormalTok{], }\ControlFlowTok{function}\NormalTok{(x) }\ControlFlowTok{if}\NormalTok{ (x }\SpecialCharTok{==} \StringTok{"penetrating"}\NormalTok{) }\DecValTok{1} \ControlFlowTok{else} \DecValTok{0}\NormalTok{)}
\NormalTok{      y\_pred }\OtherTok{\textless{}{-}}\NormalTok{ holdout\_pred[fold\_assign }\SpecialCharTok{==}\NormalTok{ k, m]}
\NormalTok{      y\_pred\_cls }\OtherTok{\textless{}{-}} \FunctionTok{sapply}\NormalTok{(y\_pred, }\ControlFlowTok{function}\NormalTok{(x) }\ControlFlowTok{if}\NormalTok{ (x }\SpecialCharTok{\textgreater{}=}\NormalTok{ threshold) }\DecValTok{1} \ControlFlowTok{else} \DecValTok{0}\NormalTok{)}
\NormalTok{      logloss }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(logloss, }\FunctionTok{LogLoss}\NormalTok{(}\AttributeTok{y\_pred =}\NormalTok{ y\_pred, }\AttributeTok{y\_true =}\NormalTok{ y\_true))}
\NormalTok{      MCC }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(MCC, }\FunctionTok{mcc}\NormalTok{(}\AttributeTok{preds =}\NormalTok{ y\_pred\_cls, }\AttributeTok{actuals =}\NormalTok{ y\_true))}
\NormalTok{      F1 }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(F1, }\FunctionTok{F1\_Score}\NormalTok{(}\AttributeTok{y\_pred =}\NormalTok{ y\_pred\_cls, }\AttributeTok{y\_true =}\NormalTok{ y\_true))}
\NormalTok{      acc }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(acc, }\FunctionTok{balanced\_accuracy}\NormalTok{(}\AttributeTok{y\_pred =}\NormalTok{ y\_pred\_cls, }\AttributeTok{y\_true =}\NormalTok{ y\_true))}
\NormalTok{      EF }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(EF, }\FunctionTok{enrichment\_factor}\NormalTok{(}\AttributeTok{x =}\NormalTok{ y\_pred, }\AttributeTok{y =}\NormalTok{ y\_true, }\AttributeTok{top =} \FloatTok{0.05}\NormalTok{))}
\NormalTok{      BEDROC }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(BEDROC, }\FunctionTok{bedroc}\NormalTok{(}\AttributeTok{x =}\NormalTok{ y\_pred, }\AttributeTok{y =}\NormalTok{ y\_true, }\AttributeTok{alpha =} \DecValTok{20}\NormalTok{))}
\NormalTok{    \}}
\NormalTok{    res\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(res\_, }\FunctionTok{c}\NormalTok{(}
      \FunctionTok{mean}\NormalTok{(logloss, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{), }\FunctionTok{sem}\NormalTok{(logloss),}
      \FunctionTok{mean}\NormalTok{(MCC, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{), }\FunctionTok{sem}\NormalTok{(MCC),}
      \FunctionTok{mean}\NormalTok{(F1, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{), }\FunctionTok{sem}\NormalTok{(F1),}
      \FunctionTok{mean}\NormalTok{(acc, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{), }\FunctionTok{sem}\NormalTok{(acc),}
      \FunctionTok{mean}\NormalTok{(EF, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{), }\FunctionTok{sem}\NormalTok{(EF),}
      \FunctionTok{mean}\NormalTok{(BEDROC, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{), }\FunctionTok{sem}\NormalTok{(BEDROC),}
\NormalTok{      logloss, MCC, F1, acc, EF, BEDROC}
\NormalTok{    ))}
\NormalTok{  \} }\ControlFlowTok{else}\NormalTok{ \{}
    \ControlFlowTok{for}\NormalTok{ (j }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(grid\_meta)) \{}
\NormalTok{      g }\OtherTok{\textless{}{-}}\NormalTok{ grid\_meta[[j]]}
\NormalTok{      m }\OtherTok{\textless{}{-}} \FunctionTok{intersect}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(holdout\_pred), g)}
      \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{length}\NormalTok{(m) }\SpecialCharTok{==} \DecValTok{1}\NormalTok{) \{}
\NormalTok{        model\_num }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(model\_num, j)}
\NormalTok{        logloss }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{        MCC }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{        F1 }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{        acc }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{        EF }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{        BEDROC }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{        threshold }\OtherTok{\textless{}{-}} \FloatTok{0.5}
        \ControlFlowTok{for}\NormalTok{ (k }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{) \{}
\NormalTok{          y\_true }\OtherTok{\textless{}{-}} \FunctionTok{sapply}\NormalTok{(holdout\_pred[fold\_assign }\SpecialCharTok{==}\NormalTok{ k, }\StringTok{"category"}\NormalTok{], }\ControlFlowTok{function}\NormalTok{(x) }\ControlFlowTok{if}\NormalTok{ (x }\SpecialCharTok{==} \StringTok{"penetrating"}\NormalTok{) }\DecValTok{1} \ControlFlowTok{else} \DecValTok{0}\NormalTok{)}
\NormalTok{          y\_pred }\OtherTok{\textless{}{-}}\NormalTok{ holdout\_pred[fold\_assign }\SpecialCharTok{==}\NormalTok{ k, m]}
\NormalTok{          y\_pred\_cls }\OtherTok{\textless{}{-}} \FunctionTok{sapply}\NormalTok{(y\_pred, }\ControlFlowTok{function}\NormalTok{(x) }\ControlFlowTok{if}\NormalTok{ (x }\SpecialCharTok{\textgreater{}=}\NormalTok{ threshold) }\DecValTok{1} \ControlFlowTok{else} \DecValTok{0}\NormalTok{)}
\NormalTok{          logloss }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(logloss, }\FunctionTok{LogLoss}\NormalTok{(}\AttributeTok{y\_pred =}\NormalTok{ y\_pred, }\AttributeTok{y\_true =}\NormalTok{ y\_true))}
\NormalTok{          MCC }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(MCC, }\FunctionTok{mcc}\NormalTok{(}\AttributeTok{preds =}\NormalTok{ y\_pred\_cls, }\AttributeTok{actuals =}\NormalTok{ y\_true))}
\NormalTok{          F1 }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(F1, }\FunctionTok{F1\_Score}\NormalTok{(}\AttributeTok{y\_pred =}\NormalTok{ y\_pred\_cls, }\AttributeTok{y\_true =}\NormalTok{ y\_true))}
\NormalTok{          acc }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(acc, }\FunctionTok{balanced\_accuracy}\NormalTok{(}\AttributeTok{y\_pred =}\NormalTok{ y\_pred\_cls, }\AttributeTok{y\_true =}\NormalTok{ y\_true))}
\NormalTok{          EF }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(EF, }\FunctionTok{enrichment\_factor}\NormalTok{(}\AttributeTok{x =}\NormalTok{ y\_pred, }\AttributeTok{y =}\NormalTok{ y\_true, }\AttributeTok{top =} \FloatTok{0.05}\NormalTok{))}
\NormalTok{          BEDROC }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(BEDROC, }\FunctionTok{bedroc}\NormalTok{(}\AttributeTok{x =}\NormalTok{ y\_pred, }\AttributeTok{y =}\NormalTok{ y\_true, }\AttributeTok{alpha =} \DecValTok{20}\NormalTok{))}
\NormalTok{        \}}
\NormalTok{        res\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(res\_, }\FunctionTok{c}\NormalTok{(}
          \FunctionTok{mean}\NormalTok{(logloss, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{), }\FunctionTok{sem}\NormalTok{(logloss),}
          \FunctionTok{mean}\NormalTok{(MCC, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{), }\FunctionTok{sem}\NormalTok{(MCC),}
          \FunctionTok{mean}\NormalTok{(F1, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{), }\FunctionTok{sem}\NormalTok{(F1),}
          \FunctionTok{mean}\NormalTok{(acc, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{), }\FunctionTok{sem}\NormalTok{(acc),}
          \FunctionTok{mean}\NormalTok{(EF, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{), }\FunctionTok{sem}\NormalTok{(EF),}
          \FunctionTok{mean}\NormalTok{(BEDROC, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{), }\FunctionTok{sem}\NormalTok{(BEDROC),}
\NormalTok{          logloss, MCC, F1, acc, EF, BEDROC}
\NormalTok{        ))}
\NormalTok{      \}}
\NormalTok{    \}}
\NormalTok{  \}}
\NormalTok{  res }\OtherTok{\textless{}{-}} \FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{t}\NormalTok{(}\FunctionTok{data.frame}\NormalTok{(res\_)))}
  \FunctionTok{colnames}\NormalTok{(res) }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}
    \StringTok{"Log loss mean"}\NormalTok{, }\StringTok{"Log loss s.e.m."}\NormalTok{, }\StringTok{"MCC mean"}\NormalTok{, }\StringTok{"MCC s.e.m."}\NormalTok{, }\StringTok{"F\_1 mean"}\NormalTok{, }\StringTok{"F\_1 s.e.m."}\NormalTok{,}
    \StringTok{"Balanced accuracy mean"}\NormalTok{, }\StringTok{"Balanced accuracy s.e.m."}\NormalTok{, }\StringTok{"EF mean"}\NormalTok{, }\StringTok{"EF s.e.m."}\NormalTok{, }\StringTok{"BEDROC mean"}\NormalTok{, }\StringTok{"BEDROC s.e.m."}\NormalTok{,}
    \FunctionTok{paste}\NormalTok{(}\StringTok{"Log loss CV"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{), }\FunctionTok{paste}\NormalTok{(}\StringTok{"MCC CV"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{), }\FunctionTok{paste}\NormalTok{(}\StringTok{"F\_1 CV"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{),}
    \FunctionTok{paste}\NormalTok{(}\StringTok{"Balanced accuracy CV"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{), }\FunctionTok{paste}\NormalTok{(}\StringTok{"EF CV"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{), }\FunctionTok{paste}\NormalTok{(}\StringTok{"BEDROC CV"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{)}
\NormalTok{  )}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{nrow}\NormalTok{(res) }\SpecialCharTok{==} \DecValTok{1}\NormalTok{) \{}
    \FunctionTok{rownames}\NormalTok{(res) }\OtherTok{\textless{}{-}}\NormalTok{ grid\_name}
\NormalTok{  \} }\ControlFlowTok{else}\NormalTok{ \{}
    \FunctionTok{rownames}\NormalTok{(res) }\OtherTok{\textless{}{-}} \FunctionTok{paste}\NormalTok{(grid\_name, model\_num)}
\NormalTok{  \}}
  \FunctionTok{return}\NormalTok{(res)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\hypertarget{inner-loop-model-selection-4}{%
\subsection{Inner loop model selection}\label{inner-loop-model-selection-4}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{load}\NormalTok{(}\AttributeTok{file =} \StringTok{"./rdata/model\_training\_grid\_models\_cpp\_ad.RData"}\NormalTok{)}

\ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{) \{}
\NormalTok{  holdout\_pred }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"./other\_data/cell\_penetration\_adversarial/outer\_"}\NormalTok{, i, }\StringTok{"/cv\_holdout\_predictions.csv"}\NormalTok{))}
\NormalTok{  fold\_assign }\OtherTok{\textless{}{-}} \FunctionTok{rep}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{, }\FunctionTok{ceiling}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(holdout\_pred) }\SpecialCharTok{/} \DecValTok{10}\NormalTok{))[}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(holdout\_pred)]}
\NormalTok{  data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
  \CommentTok{\# Deep learning grid models}
\NormalTok{  data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign,}
    \AttributeTok{grid\_name =} \StringTok{"Neural network grid model"}\NormalTok{,}
    \AttributeTok{grid\_meta =}\NormalTok{ dl\_grid}
\NormalTok{  ))}
  \CommentTok{\# GBM grid models}
\NormalTok{  data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign,}
    \AttributeTok{grid\_name =} \StringTok{"GBM grid model"}\NormalTok{,}
    \AttributeTok{grid\_meta =}\NormalTok{ gbm\_grid}
\NormalTok{  ))}
  \CommentTok{\# GBM default models}
\NormalTok{  data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign,}
    \AttributeTok{grid\_name =} \StringTok{"GBM model"}\NormalTok{,}
    \AttributeTok{grid\_meta =} \FunctionTok{as.list}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"GBM\_"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{5}\NormalTok{))}
\NormalTok{  ))}
  \CommentTok{\# XGBoost grid models}
\NormalTok{  data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign,}
    \AttributeTok{grid\_name =} \StringTok{"XGBoost grid model"}\NormalTok{,}
    \AttributeTok{grid\_meta =}\NormalTok{ xgboost\_grid}
\NormalTok{  ))}
  \CommentTok{\# XGBoost default models}
\NormalTok{  data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign,}
    \AttributeTok{grid\_name =} \StringTok{"XGBoost model"}\NormalTok{,}
    \AttributeTok{grid\_meta =} \FunctionTok{as.list}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"XGBoost\_"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{))}
\NormalTok{  ))}
  \CommentTok{\# DRF}
\NormalTok{  data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign, }\AttributeTok{grid\_name =} \StringTok{"DRF model"}\NormalTok{, }\AttributeTok{grid\_meta =} \FunctionTok{list}\NormalTok{(}\StringTok{"DRF"}\NormalTok{)))}
  \CommentTok{\# XRT}
\NormalTok{  data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign, }\AttributeTok{grid\_name =} \StringTok{"XRT model"}\NormalTok{, }\AttributeTok{grid\_meta =} \FunctionTok{list}\NormalTok{(}\StringTok{"XRT"}\NormalTok{)))}
  \CommentTok{\# Super learner all}
\NormalTok{  data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign, }\AttributeTok{grid\_name =} \StringTok{"Super learner all models"}\NormalTok{))}
  \CommentTok{\# Super learner final}
\NormalTok{  data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign, }\AttributeTok{grid\_name =} \StringTok{"Super learner final"}\NormalTok{))}
  \CommentTok{\# Super learner deep learning}
\NormalTok{  data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign, }\AttributeTok{grid\_name =} \StringTok{"Super learner neural network"}\NormalTok{))}
  \CommentTok{\# Super learner GBM}
\NormalTok{  data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign, }\AttributeTok{grid\_name =} \StringTok{"Super learner GBM"}\NormalTok{))}
  \CommentTok{\# Super learner XGBoost}
\NormalTok{  data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign, }\AttributeTok{grid\_name =} \StringTok{"Super learner XGBoost"}\NormalTok{))}

\NormalTok{  data }\OtherTok{\textless{}{-}} \FunctionTok{do.call}\NormalTok{(rbind, data\_)}
  \FunctionTok{write.csv}\NormalTok{(data, }\FunctionTok{paste0}\NormalTok{(}\StringTok{"./other\_data/cell\_penetration\_adversarial/outer\_"}\NormalTok{, i, }\StringTok{"/cv\_res.csv"}\NormalTok{))}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\hypertarget{cv-1-4}{%
\subsubsection{CV 1}\label{cv-1-4}}

\includegraphics{05_adversarial_computational_control_files/figure-latex/unnamed-chunk-29-1.pdf}

\hypertarget{cv-2-4}{%
\subsubsection{CV 2}\label{cv-2-4}}

\includegraphics{05_adversarial_computational_control_files/figure-latex/unnamed-chunk-30-1.pdf}

\hypertarget{cv-3-4}{%
\subsubsection{CV 3}\label{cv-3-4}}

\includegraphics{05_adversarial_computational_control_files/figure-latex/unnamed-chunk-31-1.pdf}

\hypertarget{cv-4-4}{%
\subsubsection{CV 4}\label{cv-4-4}}

\includegraphics{05_adversarial_computational_control_files/figure-latex/unnamed-chunk-32-1.pdf}

\hypertarget{cv-5-4}{%
\subsubsection{CV 5}\label{cv-5-4}}

\includegraphics{05_adversarial_computational_control_files/figure-latex/unnamed-chunk-33-1.pdf}

\hypertarget{cv-6-4}{%
\subsubsection{CV 6}\label{cv-6-4}}

\includegraphics{05_adversarial_computational_control_files/figure-latex/unnamed-chunk-34-1.pdf}

\hypertarget{cv-7-4}{%
\subsubsection{CV 7}\label{cv-7-4}}

\includegraphics{05_adversarial_computational_control_files/figure-latex/unnamed-chunk-35-1.pdf}

\hypertarget{cv-8-4}{%
\subsubsection{CV 8}\label{cv-8-4}}

\includegraphics{05_adversarial_computational_control_files/figure-latex/unnamed-chunk-36-1.pdf}

\hypertarget{cv-9-4}{%
\subsubsection{CV 9}\label{cv-9-4}}

\includegraphics{05_adversarial_computational_control_files/figure-latex/unnamed-chunk-37-1.pdf}

\hypertarget{cv-10-4}{%
\subsubsection{CV 10}\label{cv-10-4}}

\includegraphics{05_adversarial_computational_control_files/figure-latex/unnamed-chunk-38-1.pdf}

\hypertarget{final-evaluation-4}{%
\subsection{Final evaluation}\label{final-evaluation-4}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{load}\NormalTok{(}\AttributeTok{file =} \StringTok{"./rdata/var\_reduct\_cpp\_train\_test\_splits\_y\_shuffled.RData"}\NormalTok{)}
\FunctionTok{load}\NormalTok{(}\AttributeTok{file =} \StringTok{"./rdata/model\_training\_grid\_models\_cpp\_ad.RData"}\NormalTok{)}
\NormalTok{dir }\OtherTok{\textless{}{-}} \StringTok{"/Users/renee/Downloads/cell\_penetration\_adversarial"}
\NormalTok{selected\_models }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}
  \StringTok{"GBM grid model 68"}\NormalTok{, }\StringTok{"Super learner XGBoost"}\NormalTok{, }\StringTok{"GBM grid model 75"}\NormalTok{,}
  \StringTok{"Super learner XGBoost"}\NormalTok{, }\StringTok{"GBM grid model 21"}\NormalTok{, }\StringTok{"Super learner final"}\NormalTok{,}
  \StringTok{"GBM grid model 15"}\NormalTok{, }\StringTok{"GBM grid model 6"}\NormalTok{, }\StringTok{"GBM grid model 76"}\NormalTok{,}
  \StringTok{"Neural network grid model 86"}
\NormalTok{)}
\NormalTok{logloss }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{MCC }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{F1 }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{acc }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{EF }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{BEDROC }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{threshold }\OtherTok{\textless{}{-}} \FloatTok{0.5}
\ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{) \{}
\NormalTok{  holdout\_pred }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"./other\_data/cell\_penetration\_adversarial/outer\_"}\NormalTok{, i, }\StringTok{"/cv\_holdout\_predictions.csv"}\NormalTok{))}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{startsWith}\NormalTok{(selected\_models[i], }\StringTok{"Neural network grid model"}\NormalTok{)) \{}
\NormalTok{    grid\_num }\OtherTok{\textless{}{-}} \FunctionTok{as.integer}\NormalTok{(}\FunctionTok{str\_extract}\NormalTok{(selected\_models[i], }\StringTok{"[0{-}9]+"}\NormalTok{))}
\NormalTok{    m }\OtherTok{\textless{}{-}} \FunctionTok{intersect}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(holdout\_pred), dl\_grid[[grid\_num]])}
\NormalTok{    model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/outer\_"}\NormalTok{, i, }\StringTok{"/"}\NormalTok{, m))}
\NormalTok{  \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{startsWith}\NormalTok{(selected\_models[i], }\StringTok{"GBM grid model"}\NormalTok{)) \{}
\NormalTok{    grid\_num }\OtherTok{\textless{}{-}} \FunctionTok{as.integer}\NormalTok{(}\FunctionTok{str\_extract}\NormalTok{(selected\_models[i], }\StringTok{"[0{-}9]+"}\NormalTok{))}
\NormalTok{    m }\OtherTok{\textless{}{-}} \FunctionTok{intersect}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(holdout\_pred), gbm\_grid[[grid\_num]])}
\NormalTok{    model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/outer\_"}\NormalTok{, i, }\StringTok{"/"}\NormalTok{, m))}
\NormalTok{  \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{startsWith}\NormalTok{(selected\_models[i], }\StringTok{"GBM model"}\NormalTok{)) \{}
\NormalTok{    grid\_num }\OtherTok{\textless{}{-}} \FunctionTok{as.integer}\NormalTok{(}\FunctionTok{str\_extract}\NormalTok{(selected\_models[i], }\StringTok{"[0{-}9]+"}\NormalTok{))}
\NormalTok{    model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/outer\_"}\NormalTok{, i, }\StringTok{"/GBM\_"}\NormalTok{, grid\_num))}
\NormalTok{  \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{startsWith}\NormalTok{(selected\_models[i], }\StringTok{"XGBoost grid model"}\NormalTok{)) \{}
\NormalTok{    grid\_num }\OtherTok{\textless{}{-}} \FunctionTok{as.integer}\NormalTok{(}\FunctionTok{str\_extract}\NormalTok{(selected\_models[i], }\StringTok{"[0{-}9]+"}\NormalTok{))}
\NormalTok{    m }\OtherTok{\textless{}{-}} \FunctionTok{intersect}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(holdout\_pred), xgboost\_grid[[grid\_num]])}
\NormalTok{    model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/outer\_"}\NormalTok{, i, }\StringTok{"/"}\NormalTok{, m))}
\NormalTok{  \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{startsWith}\NormalTok{(selected\_models[i], }\StringTok{"XGBoost model"}\NormalTok{)) \{}
\NormalTok{    grid\_num }\OtherTok{\textless{}{-}} \FunctionTok{as.integer}\NormalTok{(}\FunctionTok{str\_extract}\NormalTok{(selected\_models[i], }\StringTok{"[0{-}9]+"}\NormalTok{))}
\NormalTok{    model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/outer\_"}\NormalTok{, i, }\StringTok{"/XGBoost\_"}\NormalTok{, grid\_num))}
\NormalTok{  \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (selected\_models[i] }\SpecialCharTok{==} \StringTok{"Super learner all models"}\NormalTok{) \{}
\NormalTok{    model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/outer\_"}\NormalTok{, i, }\StringTok{"/superlearner\_iter\_0"}\NormalTok{))}
\NormalTok{  \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (selected\_models[i] }\SpecialCharTok{==} \StringTok{"Super learner final"}\NormalTok{) \{}
\NormalTok{    files }\OtherTok{\textless{}{-}} \FunctionTok{list.files}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/outer\_"}\NormalTok{, i))}
\NormalTok{    files }\OtherTok{\textless{}{-}}\NormalTok{ files[}\FunctionTok{startsWith}\NormalTok{(files, }\StringTok{"superlearner\_iter"}\NormalTok{)]}
\NormalTok{    model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/outer\_"}\NormalTok{, i, }\StringTok{"/"}\NormalTok{, files[}\FunctionTok{length}\NormalTok{(files)]))}
\NormalTok{  \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (selected\_models[i] }\SpecialCharTok{==} \StringTok{"Super learner neural network"}\NormalTok{) \{}
\NormalTok{    model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/outer\_"}\NormalTok{, i, }\StringTok{"/superlearner\_deeplearning"}\NormalTok{))}
\NormalTok{  \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (selected\_models[i] }\SpecialCharTok{==} \StringTok{"Super learner GBM"}\NormalTok{) \{}
\NormalTok{    model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/outer\_"}\NormalTok{, i, }\StringTok{"/superlearner\_gbm"}\NormalTok{))}
\NormalTok{  \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (selected\_models[i] }\SpecialCharTok{==} \StringTok{"Super learner XGBoost"}\NormalTok{) \{}
\NormalTok{    model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/outer\_"}\NormalTok{, i, }\StringTok{"/superlearner\_xgboost"}\NormalTok{))}
\NormalTok{  \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{    model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/outer\_"}\NormalTok{, i, }\StringTok{"/"}\NormalTok{, }\FunctionTok{unlist}\NormalTok{(}\FunctionTok{strsplit}\NormalTok{(selected\_models[i], }\StringTok{" "}\NormalTok{))[}\DecValTok{1}\NormalTok{]))}
\NormalTok{  \}}
\NormalTok{  tmp }\OtherTok{\textless{}{-}} \FunctionTok{as.h2o}\NormalTok{(}\FunctionTok{subset}\NormalTok{(outer\_splits[[i]][[}\StringTok{"test"}\NormalTok{]], }\AttributeTok{select =} \SpecialCharTok{{-}}\NormalTok{category))}
\NormalTok{  y\_true }\OtherTok{\textless{}{-}} \FunctionTok{sapply}\NormalTok{(outer\_splits[[i]][[}\StringTok{"test"}\NormalTok{]]}\SpecialCharTok{$}\NormalTok{category, }\ControlFlowTok{function}\NormalTok{(x) }\ControlFlowTok{if}\NormalTok{ (x }\SpecialCharTok{==} \StringTok{"penetrating"}\NormalTok{) }\DecValTok{1} \ControlFlowTok{else} \DecValTok{0}\NormalTok{)}
\NormalTok{  y\_pred }\OtherTok{\textless{}{-}} \FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{h2o.predict}\NormalTok{(model, tmp)))[, }\StringTok{"penetrating"}\NormalTok{]}
\NormalTok{  y\_pred\_cls }\OtherTok{\textless{}{-}} \FunctionTok{sapply}\NormalTok{(y\_pred, }\ControlFlowTok{function}\NormalTok{(x) }\ControlFlowTok{if}\NormalTok{ (x }\SpecialCharTok{\textgreater{}=}\NormalTok{ threshold) }\DecValTok{1} \ControlFlowTok{else} \DecValTok{0}\NormalTok{)}
\NormalTok{  logloss }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(logloss, }\FunctionTok{LogLoss}\NormalTok{(}\AttributeTok{y\_pred =}\NormalTok{ y\_pred, }\AttributeTok{y\_true =}\NormalTok{ y\_true))}
\NormalTok{  MCC }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(MCC, }\FunctionTok{mcc}\NormalTok{(}\AttributeTok{preds =}\NormalTok{ y\_pred\_cls, }\AttributeTok{actuals =}\NormalTok{ y\_true))}
\NormalTok{  F1 }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(F1, }\FunctionTok{F1\_Score}\NormalTok{(}\AttributeTok{y\_pred =}\NormalTok{ y\_pred\_cls, }\AttributeTok{y\_true =}\NormalTok{ y\_true))}
\NormalTok{  acc }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(acc, }\FunctionTok{balanced\_accuracy}\NormalTok{(}\AttributeTok{y\_pred =}\NormalTok{ y\_pred\_cls, }\AttributeTok{y\_true =}\NormalTok{ y\_true))}
\NormalTok{  EF }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(EF, }\FunctionTok{enrichment\_factor}\NormalTok{(}\AttributeTok{x =}\NormalTok{ y\_pred, }\AttributeTok{y =}\NormalTok{ y\_true, }\AttributeTok{top =} \FloatTok{0.05}\NormalTok{))}
\NormalTok{  BEDROC }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(BEDROC, }\FunctionTok{bedroc}\NormalTok{(}\AttributeTok{x =}\NormalTok{ y\_pred, }\AttributeTok{y =}\NormalTok{ y\_true, }\AttributeTok{alpha =} \DecValTok{20}\NormalTok{))}
\NormalTok{\}}
\FunctionTok{save}\NormalTok{(logloss, MCC, F1, acc, EF, BEDROC, }\AttributeTok{file =} \StringTok{"./rdata/final\_evaluation\_cpp\_ad.RData"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{load}\NormalTok{(}\AttributeTok{file =} \StringTok{"./rdata/final\_evaluation\_cpp\_ad.RData"}\NormalTok{)}
\FunctionTok{data.frame}\NormalTok{(}
  \AttributeTok{Metric =} \FunctionTok{c}\NormalTok{(}\StringTok{"Log loss"}\NormalTok{, }\StringTok{"MCC"}\NormalTok{, }\StringTok{"F\textless{}sub\textgreater{}1\textless{}/sub\textgreater{}"}\NormalTok{, }\StringTok{"Balanced accuracy"}\NormalTok{, }\StringTok{"EF"}\NormalTok{, }\StringTok{"BEDROC"}\NormalTok{),}
  \StringTok{\textasciigrave{}}\AttributeTok{Mean  s.e.m.}\StringTok{\textasciigrave{}} \OtherTok{=} \FunctionTok{c}\NormalTok{(}
    \FunctionTok{paste0}\NormalTok{(}\FunctionTok{round}\NormalTok{(}\FunctionTok{mean}\NormalTok{(logloss), }\DecValTok{3}\NormalTok{), }\StringTok{"  "}\NormalTok{, }\FunctionTok{round}\NormalTok{(}\FunctionTok{sem}\NormalTok{(logloss), }\DecValTok{3}\NormalTok{)),}
    \FunctionTok{paste0}\NormalTok{(}\FunctionTok{round}\NormalTok{(}\FunctionTok{mean}\NormalTok{(MCC), }\DecValTok{3}\NormalTok{), }\StringTok{"  "}\NormalTok{, }\FunctionTok{round}\NormalTok{(}\FunctionTok{sem}\NormalTok{(MCC), }\DecValTok{3}\NormalTok{)),}
    \FunctionTok{paste0}\NormalTok{(}\FunctionTok{round}\NormalTok{(}\FunctionTok{mean}\NormalTok{(F1), }\DecValTok{3}\NormalTok{), }\StringTok{"  "}\NormalTok{, }\FunctionTok{round}\NormalTok{(}\FunctionTok{sem}\NormalTok{(F1), }\DecValTok{3}\NormalTok{)),}
    \FunctionTok{paste0}\NormalTok{(}\FunctionTok{round}\NormalTok{(}\FunctionTok{mean}\NormalTok{(acc), }\DecValTok{3}\NormalTok{), }\StringTok{"  "}\NormalTok{, }\FunctionTok{round}\NormalTok{(}\FunctionTok{sem}\NormalTok{(acc), }\DecValTok{3}\NormalTok{)),}
    \FunctionTok{paste0}\NormalTok{(}\FunctionTok{round}\NormalTok{(}\FunctionTok{mean}\NormalTok{(EF), }\DecValTok{3}\NormalTok{), }\StringTok{"  "}\NormalTok{, }\FunctionTok{round}\NormalTok{(}\FunctionTok{sem}\NormalTok{(EF), }\DecValTok{3}\NormalTok{)),}
    \FunctionTok{paste0}\NormalTok{(}\FunctionTok{round}\NormalTok{(}\FunctionTok{mean}\NormalTok{(BEDROC), }\DecValTok{3}\NormalTok{), }\StringTok{"  "}\NormalTok{, }\FunctionTok{round}\NormalTok{(}\FunctionTok{sem}\NormalTok{(BEDROC), }\DecValTok{3}\NormalTok{))}
\NormalTok{  ),}
  \AttributeTok{check.names =} \ConstantTok{FALSE}
\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{datatable}\NormalTok{(}\AttributeTok{escape =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{rownames =} \ConstantTok{FALSE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{05_adversarial_computational_control_files/figure-latex/unnamed-chunk-40-1.pdf}

\hypertarget{toxicity-classification-3}{%
\section{Toxicity (classification)}\label{toxicity-classification-3}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{load}\NormalTok{(}\AttributeTok{file =} \StringTok{"./rdata/var\_reduct\_tx\_train\_test\_splits.RData"}\NormalTok{)}
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{32}\NormalTok{)}

\CommentTok{\# Shuffle the response variable of cross{-}validation training sets}
\ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{) \{}
\NormalTok{  response }\OtherTok{\textless{}{-}}\NormalTok{ outer\_splits[[i]]}\SpecialCharTok{$}\NormalTok{train}\SpecialCharTok{$}\NormalTok{category}
\NormalTok{  response }\OtherTok{\textless{}{-}} \FunctionTok{sample}\NormalTok{(response)}
\NormalTok{  outer\_splits[[i]]}\SpecialCharTok{$}\NormalTok{train}\SpecialCharTok{$}\NormalTok{category }\OtherTok{\textless{}{-}}\NormalTok{ response}
\NormalTok{\}}

\CommentTok{\# Shuffle the response variable of the whole data set}
\NormalTok{response }\OtherTok{\textless{}{-}}\NormalTok{ tx\_data}\SpecialCharTok{$}\NormalTok{category}
\NormalTok{response }\OtherTok{\textless{}{-}} \FunctionTok{sample}\NormalTok{(response)}
\NormalTok{tx\_data}\SpecialCharTok{$}\NormalTok{category }\OtherTok{\textless{}{-}}\NormalTok{ response}

\FunctionTok{save}\NormalTok{(tx\_data, outer\_splits,}
  \AttributeTok{file =} \StringTok{"./rdata/var\_reduct\_tx\_train\_test\_splits\_y\_shuffled.RData"}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{model-training-5}{%
\subsection{Model training}\label{model-training-5}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{train\_tx\_models }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(train\_set, exp\_dir, prefix, }\AttributeTok{nfolds =} \DecValTok{10}\NormalTok{, }\AttributeTok{grid\_seed =} \DecValTok{1}\NormalTok{) \{}
\NormalTok{  tmp }\OtherTok{\textless{}{-}} \FunctionTok{as.h2o}\NormalTok{(train\_set, }\AttributeTok{destination\_frame =}\NormalTok{ prefix)}
\NormalTok{  tmp[}\StringTok{"category"}\NormalTok{] }\OtherTok{\textless{}{-}} \FunctionTok{as.factor}\NormalTok{(tmp[}\StringTok{"category"}\NormalTok{])}
\NormalTok{  y }\OtherTok{\textless{}{-}} \StringTok{"category"}
\NormalTok{  x }\OtherTok{\textless{}{-}} \FunctionTok{setdiff}\NormalTok{(}\FunctionTok{names}\NormalTok{(tmp), y)}
\NormalTok{  res }\OtherTok{\textless{}{-}} \FunctionTok{as.data.frame}\NormalTok{(tmp}\SpecialCharTok{$}\NormalTok{category)}
\NormalTok{  samp\_factors }\OtherTok{\textless{}{-}} \FunctionTok{as.vector}\NormalTok{(}\FunctionTok{mean}\NormalTok{(}\FunctionTok{table}\NormalTok{(train\_set}\SpecialCharTok{$}\NormalTok{category)) }\SpecialCharTok{/} \FunctionTok{table}\NormalTok{(train\_set}\SpecialCharTok{$}\NormalTok{category))}
  \CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
  \CommentTok{\# base model training}
  \CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"Deep learning grid 1}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  deeplearning\_1 }\OtherTok{\textless{}{-}} \FunctionTok{h2o.grid}\NormalTok{(}
    \AttributeTok{algorithm =} \StringTok{"deeplearning"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{hyper\_params =}\NormalTok{ deeplearning\_params\_1,}
    \AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{, }\AttributeTok{balance\_classes =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{class\_sampling\_factors =}\NormalTok{ samp\_factors,}
    \AttributeTok{max\_after\_balance\_size =} \FloatTok{0.5}\NormalTok{,}
    \AttributeTok{search\_criteria =} \FunctionTok{list}\NormalTok{(}
      \AttributeTok{strategy =} \StringTok{"RandomDiscrete"}\NormalTok{,}
      \AttributeTok{max\_models =} \DecValTok{100}\NormalTok{, }\AttributeTok{seed =}\NormalTok{ grid\_seed}
\NormalTok{    ),}
    \AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}\NormalTok{, }\AttributeTok{parallelism =} \DecValTok{0}
\NormalTok{  )}
  \ControlFlowTok{for}\NormalTok{ (model\_id }\ControlFlowTok{in}\NormalTok{ deeplearning\_1}\SpecialCharTok{@}\NormalTok{model\_ids) \{}
\NormalTok{    tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(model\_id), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  \}}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"GBM grid}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  gbm }\OtherTok{\textless{}{-}} \FunctionTok{h2o.grid}\NormalTok{(}
    \AttributeTok{algorithm =} \StringTok{"gbm"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{hyper\_params =}\NormalTok{ gbm\_params, }\AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{,}
    \AttributeTok{balance\_classes =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{class\_sampling\_factors =}\NormalTok{ samp\_factors, }\AttributeTok{max\_after\_balance\_size =} \FloatTok{0.5}\NormalTok{,}
    \AttributeTok{search\_criteria =} \FunctionTok{list}\NormalTok{(}\AttributeTok{strategy =} \StringTok{"RandomDiscrete"}\NormalTok{, }\AttributeTok{max\_models =} \DecValTok{100}\NormalTok{, }\AttributeTok{seed =}\NormalTok{ grid\_seed),}
    \AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}\NormalTok{, }\AttributeTok{parallelism =} \DecValTok{0}
\NormalTok{  )}
  \ControlFlowTok{for}\NormalTok{ (model\_id }\ControlFlowTok{in}\NormalTok{ gbm}\SpecialCharTok{@}\NormalTok{model\_ids) \{}
\NormalTok{    tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(model\_id), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  \}}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"GBM 5 default models}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  gbm\_1 }\OtherTok{\textless{}{-}} \FunctionTok{h2o.gbm}\NormalTok{(}
    \AttributeTok{model\_id =} \StringTok{"GBM\_1"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{, }\AttributeTok{score\_tree\_interval =} \DecValTok{5}\NormalTok{,}
    \AttributeTok{balance\_classes =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{class\_sampling\_factors =}\NormalTok{ samp\_factors, }\AttributeTok{max\_after\_balance\_size =} \FloatTok{0.5}\NormalTok{,}
    \AttributeTok{col\_sample\_rate =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{col\_sample\_rate\_per\_tree =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{learn\_rate =} \FloatTok{0.1}\NormalTok{,}
    \AttributeTok{max\_depth =} \DecValTok{6}\NormalTok{, }\AttributeTok{min\_rows =} \DecValTok{1}\NormalTok{, }\AttributeTok{min\_split\_improvement =} \FloatTok{1e{-}5}\NormalTok{, }\AttributeTok{ntrees =} \DecValTok{10000}\NormalTok{, }\AttributeTok{sample\_rate =} \FloatTok{0.8}\NormalTok{,}
    \AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}
\NormalTok{  )}
\NormalTok{  gbm\_2 }\OtherTok{\textless{}{-}} \FunctionTok{h2o.gbm}\NormalTok{(}
    \AttributeTok{model\_id =} \StringTok{"GBM\_2"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{, }\AttributeTok{score\_tree\_interval =} \DecValTok{5}\NormalTok{,}
    \AttributeTok{balance\_classes =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{class\_sampling\_factors =}\NormalTok{ samp\_factors, }\AttributeTok{max\_after\_balance\_size =} \FloatTok{0.5}\NormalTok{,}
    \AttributeTok{col\_sample\_rate =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{col\_sample\_rate\_per\_tree =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{learn\_rate =} \FloatTok{0.1}\NormalTok{,}
    \AttributeTok{max\_depth =} \DecValTok{7}\NormalTok{, }\AttributeTok{min\_rows =} \DecValTok{10}\NormalTok{, }\AttributeTok{min\_split\_improvement =} \FloatTok{1e{-}5}\NormalTok{, }\AttributeTok{ntrees =} \DecValTok{10000}\NormalTok{, }\AttributeTok{sample\_rate =} \FloatTok{0.8}\NormalTok{,}
    \AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}
\NormalTok{  )}
\NormalTok{  gbm\_3 }\OtherTok{\textless{}{-}} \FunctionTok{h2o.gbm}\NormalTok{(}
    \AttributeTok{model\_id =} \StringTok{"GBM\_3"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{, }\AttributeTok{score\_tree\_interval =} \DecValTok{5}\NormalTok{,}
    \AttributeTok{balance\_classes =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{class\_sampling\_factors =}\NormalTok{ samp\_factors, }\AttributeTok{max\_after\_balance\_size =} \FloatTok{0.5}\NormalTok{,}
    \AttributeTok{col\_sample\_rate =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{col\_sample\_rate\_per\_tree =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{learn\_rate =} \FloatTok{0.1}\NormalTok{,}
    \AttributeTok{max\_depth =} \DecValTok{8}\NormalTok{, }\AttributeTok{min\_rows =} \DecValTok{10}\NormalTok{, }\AttributeTok{min\_split\_improvement =} \FloatTok{1e{-}5}\NormalTok{, }\AttributeTok{ntrees =} \DecValTok{10000}\NormalTok{, }\AttributeTok{sample\_rate =} \FloatTok{0.8}\NormalTok{,}
    \AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}
\NormalTok{  )}
\NormalTok{  gbm\_4 }\OtherTok{\textless{}{-}} \FunctionTok{h2o.gbm}\NormalTok{(}
    \AttributeTok{model\_id =} \StringTok{"GBM\_4"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{, }\AttributeTok{score\_tree\_interval =} \DecValTok{5}\NormalTok{,}
    \AttributeTok{balance\_classes =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{class\_sampling\_factors =}\NormalTok{ samp\_factors, }\AttributeTok{max\_after\_balance\_size =} \FloatTok{0.5}\NormalTok{,}
    \AttributeTok{col\_sample\_rate =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{col\_sample\_rate\_per\_tree =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{learn\_rate =} \FloatTok{0.1}\NormalTok{,}
    \AttributeTok{max\_depth =} \DecValTok{10}\NormalTok{, }\AttributeTok{min\_rows =} \DecValTok{10}\NormalTok{, }\AttributeTok{min\_split\_improvement =} \FloatTok{1e{-}5}\NormalTok{, }\AttributeTok{ntrees =} \DecValTok{10000}\NormalTok{, }\AttributeTok{sample\_rate =} \FloatTok{0.8}\NormalTok{,}
    \AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}
\NormalTok{  )}
\NormalTok{  gbm\_5 }\OtherTok{\textless{}{-}} \FunctionTok{h2o.gbm}\NormalTok{(}
    \AttributeTok{model\_id =} \StringTok{"GBM\_5"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{, }\AttributeTok{score\_tree\_interval =} \DecValTok{5}\NormalTok{,}
    \AttributeTok{balance\_classes =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{class\_sampling\_factors =}\NormalTok{ samp\_factors, }\AttributeTok{max\_after\_balance\_size =} \FloatTok{0.5}\NormalTok{,}
    \AttributeTok{col\_sample\_rate =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{col\_sample\_rate\_per\_tree =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{learn\_rate =} \FloatTok{0.1}\NormalTok{,}
    \AttributeTok{max\_depth =} \DecValTok{15}\NormalTok{, }\AttributeTok{min\_rows =} \DecValTok{100}\NormalTok{, }\AttributeTok{min\_split\_improvement =} \FloatTok{1e{-}5}\NormalTok{, }\AttributeTok{ntrees =} \DecValTok{10000}\NormalTok{, }\AttributeTok{sample\_rate =} \FloatTok{0.8}\NormalTok{,}
    \AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}
\NormalTok{  )}
  \ControlFlowTok{for}\NormalTok{ (model\_id }\ControlFlowTok{in} \FunctionTok{paste0}\NormalTok{(}\StringTok{"GBM\_"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{5}\NormalTok{)) \{}
\NormalTok{    tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(model\_id), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  \}}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"XGBoost grid}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  xgboost }\OtherTok{\textless{}{-}} \FunctionTok{h2o.grid}\NormalTok{(}
    \AttributeTok{algorithm =} \StringTok{"xgboost"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{hyper\_params =}\NormalTok{ xgboost\_params, }\AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{,}
    \AttributeTok{search\_criteria =} \FunctionTok{list}\NormalTok{(}\AttributeTok{strategy =} \StringTok{"RandomDiscrete"}\NormalTok{, }\AttributeTok{max\_models =} \DecValTok{100}\NormalTok{, }\AttributeTok{seed =}\NormalTok{ grid\_seed),}
    \AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}\NormalTok{, }\AttributeTok{parallelism =} \DecValTok{0}
\NormalTok{  )}
  \ControlFlowTok{for}\NormalTok{ (model\_id }\ControlFlowTok{in}\NormalTok{ xgboost}\SpecialCharTok{@}\NormalTok{model\_ids) \{}
\NormalTok{    tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(model\_id), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  \}}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"XGBoost 3 default models}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  xgboost\_1 }\OtherTok{\textless{}{-}} \FunctionTok{h2o.xgboost}\NormalTok{(}
    \AttributeTok{model\_id =} \StringTok{"XGBoost\_1"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{, }\AttributeTok{score\_tree\_interval =} \DecValTok{5}\NormalTok{,}
    \AttributeTok{booster =} \StringTok{"gbtree"}\NormalTok{, }\AttributeTok{col\_sample\_rate =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{col\_sample\_rate\_per\_tree =} \FloatTok{0.8}\NormalTok{,}
    \AttributeTok{max\_depth =} \DecValTok{10}\NormalTok{, }\AttributeTok{min\_rows =} \DecValTok{5}\NormalTok{, }\AttributeTok{ntrees =} \DecValTok{10000}\NormalTok{, }\AttributeTok{reg\_alpha =} \DecValTok{0}\NormalTok{, }\AttributeTok{reg\_lambda =} \DecValTok{1}\NormalTok{,}
    \AttributeTok{sample\_rate =} \FloatTok{0.6}\NormalTok{, }\AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}
\NormalTok{  )}
\NormalTok{  xgboost\_2 }\OtherTok{\textless{}{-}} \FunctionTok{h2o.xgboost}\NormalTok{(}
    \AttributeTok{model\_id =} \StringTok{"XGBoost\_2"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{, }\AttributeTok{score\_tree\_interval =} \DecValTok{5}\NormalTok{,}
    \AttributeTok{booster =} \StringTok{"gbtree"}\NormalTok{, }\AttributeTok{col\_sample\_rate =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{col\_sample\_rate\_per\_tree =} \FloatTok{0.8}\NormalTok{,}
    \AttributeTok{max\_depth =} \DecValTok{20}\NormalTok{, }\AttributeTok{min\_rows =} \DecValTok{10}\NormalTok{, }\AttributeTok{ntrees =} \DecValTok{10000}\NormalTok{, }\AttributeTok{reg\_alpha =} \DecValTok{0}\NormalTok{, }\AttributeTok{reg\_lambda =} \DecValTok{1}\NormalTok{,}
    \AttributeTok{sample\_rate =} \FloatTok{0.6}\NormalTok{, }\AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}
\NormalTok{  )}
\NormalTok{  xgboost\_3 }\OtherTok{\textless{}{-}} \FunctionTok{h2o.xgboost}\NormalTok{(}
    \AttributeTok{model\_id =} \StringTok{"XGBoost\_3"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{, }\AttributeTok{score\_tree\_interval =} \DecValTok{5}\NormalTok{,}
    \AttributeTok{booster =} \StringTok{"gbtree"}\NormalTok{, }\AttributeTok{col\_sample\_rate =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{col\_sample\_rate\_per\_tree =} \FloatTok{0.8}\NormalTok{,}
    \AttributeTok{max\_depth =} \DecValTok{5}\NormalTok{, }\AttributeTok{min\_rows =} \DecValTok{3}\NormalTok{, }\AttributeTok{ntrees =} \DecValTok{10000}\NormalTok{, }\AttributeTok{reg\_alpha =} \DecValTok{0}\NormalTok{, }\AttributeTok{reg\_lambda =} \DecValTok{1}\NormalTok{,}
    \AttributeTok{sample\_rate =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}
\NormalTok{  )}
  \ControlFlowTok{for}\NormalTok{ (model\_id }\ControlFlowTok{in} \FunctionTok{paste0}\NormalTok{(}\StringTok{"XGBoost\_"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{)) \{}
\NormalTok{    tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(model\_id), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  \}}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"GLM}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  glm }\OtherTok{\textless{}{-}} \FunctionTok{h2o.glm}\NormalTok{(}
    \AttributeTok{model\_id =} \StringTok{"GLM"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{alpha =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.0}\NormalTok{, }\FloatTok{0.2}\NormalTok{, }\FloatTok{0.4}\NormalTok{, }\FloatTok{0.6}\NormalTok{, }\FloatTok{0.8}\NormalTok{, }\FloatTok{1.0}\NormalTok{),}
    \AttributeTok{balance\_classes =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{class\_sampling\_factors =}\NormalTok{ samp\_factors, }\AttributeTok{max\_after\_balance\_size =} \FloatTok{0.5}\NormalTok{,}
    \AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}
\NormalTok{  )}
\NormalTok{  tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(}\StringTok{"GLM"}\NormalTok{), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"DRF}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  drf }\OtherTok{\textless{}{-}} \FunctionTok{h2o.randomForest}\NormalTok{(}
    \AttributeTok{model\_id =} \StringTok{"DRF"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{ntrees =} \DecValTok{10000}\NormalTok{,}
    \AttributeTok{score\_tree\_interval =} \DecValTok{5}\NormalTok{, }\AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{,}
    \AttributeTok{balance\_classes =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{class\_sampling\_factors =}\NormalTok{ samp\_factors, }\AttributeTok{max\_after\_balance\_size =} \FloatTok{0.5}\NormalTok{,}
    \AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}
\NormalTok{  )}
\NormalTok{  tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(}\StringTok{"DRF"}\NormalTok{), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"XRT}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  xrt }\OtherTok{\textless{}{-}} \FunctionTok{h2o.randomForest}\NormalTok{(}
    \AttributeTok{model\_id =} \StringTok{"XRT"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{ntrees =} \DecValTok{10000}\NormalTok{, }\AttributeTok{histogram\_type =} \StringTok{"Random"}\NormalTok{,}
    \AttributeTok{score\_tree\_interval =} \DecValTok{5}\NormalTok{, }\AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{,}
    \AttributeTok{balance\_classes =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{class\_sampling\_factors =}\NormalTok{ samp\_factors, }\AttributeTok{max\_after\_balance\_size =} \FloatTok{0.5}\NormalTok{,}
    \AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}
\NormalTok{  )}
\NormalTok{  tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(}\StringTok{"XRT"}\NormalTok{), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
  \CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
  \CommentTok{\# get holdout predictions}
  \CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\NormalTok{  base\_models }\OtherTok{\textless{}{-}} \FunctionTok{as.list}\NormalTok{(}\FunctionTok{c}\NormalTok{(}
    \FunctionTok{unlist}\NormalTok{(deeplearning\_1}\SpecialCharTok{@}\NormalTok{model\_ids),}
    \FunctionTok{unlist}\NormalTok{(gbm}\SpecialCharTok{@}\NormalTok{model\_ids), }\FunctionTok{paste0}\NormalTok{(}\StringTok{"GBM\_"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{5}\NormalTok{),}
    \FunctionTok{unlist}\NormalTok{(xgboost}\SpecialCharTok{@}\NormalTok{model\_ids), }\FunctionTok{paste0}\NormalTok{(}\StringTok{"XGBoost\_"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{),}
    \StringTok{"GLM"}\NormalTok{,}
    \StringTok{"DRF"}\NormalTok{,}
    \StringTok{"XRT"}
\NormalTok{  ))}
  \ControlFlowTok{for}\NormalTok{ (model\_id }\ControlFlowTok{in}\NormalTok{ base\_models) \{}
\NormalTok{    res }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(res, }\FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{h2o.getFrame}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"cv\_holdout\_prediction\_"}\NormalTok{, model\_id))[}\DecValTok{3}\NormalTok{],}
      \AttributeTok{col.names =}\NormalTok{ model\_id}
\NormalTok{    ))}
\NormalTok{  \}}
  \CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
  \CommentTok{\# super learner training}
  \CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\NormalTok{  sl\_iter }\OtherTok{\textless{}{-}} \DecValTok{0}
  \FunctionTok{cat}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"Super learner iteration "}\NormalTok{, sl\_iter, }\StringTok{" ("}\NormalTok{, }\FunctionTok{length}\NormalTok{(base\_models), }\StringTok{" models)}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{))}
\NormalTok{  sl }\OtherTok{\textless{}{-}} \FunctionTok{h2o.stackedEnsemble}\NormalTok{(}
    \AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{model\_id =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"superlearner\_iter\_"}\NormalTok{, sl\_iter),}
    \AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{,}
    \AttributeTok{base\_models =}\NormalTok{ base\_models,}
    \AttributeTok{metalearner\_algorithm =} \StringTok{"glm"}\NormalTok{,}
    \AttributeTok{metalearner\_nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_levelone\_frame =} \ConstantTok{TRUE}\NormalTok{,}
    \AttributeTok{metalearner\_params =} \FunctionTok{list}\NormalTok{(}
      \AttributeTok{standardize =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{,}
      \AttributeTok{balance\_classes =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{class\_sampling\_factors =}\NormalTok{ samp\_factors,}
      \AttributeTok{max\_after\_balance\_size =} \FloatTok{0.5}
\NormalTok{    )}
\NormalTok{  )}
\NormalTok{  tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"superlearner\_iter\_"}\NormalTok{, sl\_iter)), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  model\_id }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"metalearner\_glm\_superlearner\_iter\_"}\NormalTok{, sl\_iter)}
\NormalTok{  tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(model\_id), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  res }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(res, }\FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{h2o.getFrame}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"cv\_holdout\_prediction\_"}\NormalTok{, model\_id))[}\DecValTok{3}\NormalTok{],}
    \AttributeTok{col.names =} \FunctionTok{paste0}\NormalTok{(model\_id, }\StringTok{"\_"}\NormalTok{, }\FunctionTok{length}\NormalTok{(base\_models), }\StringTok{"\_models"}\NormalTok{)}
\NormalTok{  ))}
  \CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
  \CommentTok{\# super learner base model reduction}
  \CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
  \ControlFlowTok{while}\NormalTok{ (}\ConstantTok{TRUE}\NormalTok{) \{}
\NormalTok{    meta }\OtherTok{\textless{}{-}} \FunctionTok{h2o.getModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"metalearner\_glm\_superlearner\_iter\_"}\NormalTok{, sl\_iter, }\StringTok{"\_cv\_1"}\NormalTok{))}
\NormalTok{    names }\OtherTok{\textless{}{-}}\NormalTok{ meta}\SpecialCharTok{@}\NormalTok{model}\SpecialCharTok{$}\NormalTok{coefficients\_table[, }\StringTok{"names"}\NormalTok{]}
\NormalTok{    coeffs }\OtherTok{\textless{}{-}}\NormalTok{ (meta}\SpecialCharTok{@}\NormalTok{model}\SpecialCharTok{$}\NormalTok{coefficients\_table[, }\StringTok{"standardized\_coefficients"}\NormalTok{] }\SpecialCharTok{\textgreater{}} \DecValTok{0}\NormalTok{)}
    \ControlFlowTok{for}\NormalTok{ (j }\ControlFlowTok{in} \DecValTok{2}\SpecialCharTok{:}\NormalTok{nfolds) \{}
\NormalTok{      meta }\OtherTok{\textless{}{-}} \FunctionTok{h2o.getModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"metalearner\_glm\_superlearner\_iter\_"}\NormalTok{, sl\_iter, }\StringTok{"\_cv\_"}\NormalTok{, j))}
\NormalTok{      names }\OtherTok{\textless{}{-}}\NormalTok{ meta}\SpecialCharTok{@}\NormalTok{model}\SpecialCharTok{$}\NormalTok{coefficients\_table[, }\StringTok{"names"}\NormalTok{]}
\NormalTok{      coeffs }\OtherTok{\textless{}{-}}\NormalTok{ coeffs }\SpecialCharTok{+}\NormalTok{ (meta}\SpecialCharTok{@}\NormalTok{model}\SpecialCharTok{$}\NormalTok{coefficients\_table[, }\StringTok{"standardized\_coefficients"}\NormalTok{] }\SpecialCharTok{\textgreater{}} \DecValTok{0}\NormalTok{)}
\NormalTok{    \}}
\NormalTok{    base\_models\_ }\OtherTok{\textless{}{-}} \FunctionTok{as.list}\NormalTok{(names[coeffs }\SpecialCharTok{\textgreater{}=} \FunctionTok{ceiling}\NormalTok{(nfolds }\SpecialCharTok{/} \DecValTok{2}\NormalTok{) }\SpecialCharTok{\&}\NormalTok{ names }\SpecialCharTok{!=} \StringTok{"Intercept"}\NormalTok{])}
    \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{length}\NormalTok{(base\_models\_) }\SpecialCharTok{==} \DecValTok{0}\NormalTok{) \{}
      \FunctionTok{cat}\NormalTok{(}\StringTok{"No base models passing the threshold}\SpecialCharTok{\textbackslash{}n\textbackslash{}n}\StringTok{"}\NormalTok{)}
      \ControlFlowTok{break}
\NormalTok{    \}}
    \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{sum}\NormalTok{(base\_models }\SpecialCharTok{\%in\%}\NormalTok{ base\_models\_) }\SpecialCharTok{==} \FunctionTok{length}\NormalTok{(base\_models)) \{}
      \FunctionTok{cat}\NormalTok{(}\StringTok{"No further reduction of base models}\SpecialCharTok{\textbackslash{}n\textbackslash{}n}\StringTok{"}\NormalTok{)}
      \ControlFlowTok{break}
\NormalTok{    \}}
\NormalTok{    sl\_iter }\OtherTok{\textless{}{-}}\NormalTok{ sl\_iter }\SpecialCharTok{+} \DecValTok{1}
\NormalTok{    base\_models }\OtherTok{\textless{}{-}}\NormalTok{ base\_models\_}
    \FunctionTok{cat}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"Super learner iteration "}\NormalTok{, sl\_iter, }\StringTok{" ("}\NormalTok{, }\FunctionTok{length}\NormalTok{(base\_models), }\StringTok{" models)}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{))}
\NormalTok{    sl }\OtherTok{\textless{}{-}} \FunctionTok{h2o.stackedEnsemble}\NormalTok{(}
      \AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{model\_id =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"superlearner\_iter\_"}\NormalTok{, sl\_iter),}
      \AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{,}
      \AttributeTok{base\_models =}\NormalTok{ base\_models,}
      \AttributeTok{metalearner\_algorithm =} \StringTok{"glm"}\NormalTok{,}
      \AttributeTok{metalearner\_nfolds =}\NormalTok{ nfolds,}
      \AttributeTok{keep\_levelone\_frame =} \ConstantTok{TRUE}\NormalTok{,}
      \AttributeTok{metalearner\_params =} \FunctionTok{list}\NormalTok{(}
        \AttributeTok{standardize =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{,}
        \AttributeTok{balance\_classes =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{class\_sampling\_factors =}\NormalTok{ samp\_factors,}
        \AttributeTok{max\_after\_balance\_size =} \FloatTok{0.5}
\NormalTok{      )}
\NormalTok{    )}
\NormalTok{    tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"superlearner\_iter\_"}\NormalTok{, sl\_iter)), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{    model\_id }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"metalearner\_glm\_superlearner\_iter\_"}\NormalTok{, sl\_iter)}
\NormalTok{    tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(model\_id), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{    res }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(res, }\FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{h2o.getFrame}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"cv\_holdout\_prediction\_"}\NormalTok{, model\_id))[}\DecValTok{3}\NormalTok{],}
      \AttributeTok{col.names =} \FunctionTok{paste0}\NormalTok{(model\_id, }\StringTok{"\_"}\NormalTok{, }\FunctionTok{length}\NormalTok{(base\_models), }\StringTok{"\_models"}\NormalTok{)}
\NormalTok{    ))}
\NormalTok{  \}}
  \CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
  \CommentTok{\# super learner for homogeneous base models}
  \CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
  \CommentTok{\# DeepLearning}
\NormalTok{  base\_models }\OtherTok{\textless{}{-}}\NormalTok{ deeplearning\_1}\SpecialCharTok{@}\NormalTok{model\_ids}
  \FunctionTok{cat}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"Super learner deep learning ("}\NormalTok{, }\FunctionTok{length}\NormalTok{(base\_models), }\StringTok{" models)}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{))}
\NormalTok{  sl }\OtherTok{\textless{}{-}} \FunctionTok{h2o.stackedEnsemble}\NormalTok{(}
    \AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{model\_id =} \StringTok{"superlearner\_deeplearning"}\NormalTok{,}
    \AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{,}
    \AttributeTok{base\_models =}\NormalTok{ base\_models,}
    \AttributeTok{metalearner\_algorithm =} \StringTok{"glm"}\NormalTok{,}
    \AttributeTok{metalearner\_nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_levelone\_frame =} \ConstantTok{TRUE}\NormalTok{,}
    \AttributeTok{metalearner\_params =} \FunctionTok{list}\NormalTok{(}
      \AttributeTok{standardize =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{,}
      \AttributeTok{balance\_classes =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{class\_sampling\_factors =}\NormalTok{ samp\_factors,}
      \AttributeTok{max\_after\_balance\_size =} \FloatTok{0.5}
\NormalTok{    )}
\NormalTok{  )}
\NormalTok{  tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(}\StringTok{"superlearner\_deeplearning"}\NormalTok{), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  model\_id }\OtherTok{\textless{}{-}} \StringTok{"metalearner\_glm\_superlearner\_deeplearning"}
\NormalTok{  tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(model\_id), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  res }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(res, }\FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{h2o.getFrame}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"cv\_holdout\_prediction\_"}\NormalTok{, model\_id))[}\DecValTok{3}\NormalTok{],}
    \AttributeTok{col.names =} \FunctionTok{paste0}\NormalTok{(model\_id, }\StringTok{"\_"}\NormalTok{, }\FunctionTok{length}\NormalTok{(base\_models), }\StringTok{"\_models"}\NormalTok{)}
\NormalTok{  ))}
  \CommentTok{\# GBM}
\NormalTok{  base\_models }\OtherTok{\textless{}{-}} \FunctionTok{as.list}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\FunctionTok{unlist}\NormalTok{(gbm}\SpecialCharTok{@}\NormalTok{model\_ids), }\FunctionTok{paste0}\NormalTok{(}\StringTok{"GBM\_"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{5}\NormalTok{)))}
  \FunctionTok{cat}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"Super learner GBM ("}\NormalTok{, }\FunctionTok{length}\NormalTok{(base\_models), }\StringTok{" models)}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{))}
\NormalTok{  sl }\OtherTok{\textless{}{-}} \FunctionTok{h2o.stackedEnsemble}\NormalTok{(}
    \AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{model\_id =} \StringTok{"superlearner\_gbm"}\NormalTok{,}
    \AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{,}
    \AttributeTok{base\_models =}\NormalTok{ base\_models,}
    \AttributeTok{metalearner\_algorithm =} \StringTok{"glm"}\NormalTok{,}
    \AttributeTok{metalearner\_nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_levelone\_frame =} \ConstantTok{TRUE}\NormalTok{,}
    \AttributeTok{metalearner\_params =} \FunctionTok{list}\NormalTok{(}
      \AttributeTok{standardize =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{,}
      \AttributeTok{balance\_classes =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{class\_sampling\_factors =}\NormalTok{ samp\_factors,}
      \AttributeTok{max\_after\_balance\_size =} \FloatTok{0.5}
\NormalTok{    )}
\NormalTok{  )}
\NormalTok{  tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(}\StringTok{"superlearner\_gbm"}\NormalTok{), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  model\_id }\OtherTok{\textless{}{-}} \StringTok{"metalearner\_glm\_superlearner\_gbm"}
\NormalTok{  tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(model\_id), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  res }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(res, }\FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{h2o.getFrame}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"cv\_holdout\_prediction\_"}\NormalTok{, model\_id))[}\DecValTok{3}\NormalTok{],}
    \AttributeTok{col.names =} \FunctionTok{paste0}\NormalTok{(model\_id, }\StringTok{"\_"}\NormalTok{, }\FunctionTok{length}\NormalTok{(base\_models), }\StringTok{"\_models"}\NormalTok{)}
\NormalTok{  ))}
  \CommentTok{\# XGBoost}
\NormalTok{  base\_models }\OtherTok{\textless{}{-}} \FunctionTok{as.list}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\FunctionTok{unlist}\NormalTok{(xgboost}\SpecialCharTok{@}\NormalTok{model\_ids), }\FunctionTok{paste0}\NormalTok{(}\StringTok{"XGBoost\_"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{)))}
  \FunctionTok{cat}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"Super learner XGBoost ("}\NormalTok{, }\FunctionTok{length}\NormalTok{(base\_models), }\StringTok{" models)}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{))}
\NormalTok{  sl }\OtherTok{\textless{}{-}} \FunctionTok{h2o.stackedEnsemble}\NormalTok{(}
    \AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{model\_id =} \StringTok{"superlearner\_xgboost"}\NormalTok{,}
    \AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{,}
    \AttributeTok{base\_models =}\NormalTok{ base\_models,}
    \AttributeTok{metalearner\_algorithm =} \StringTok{"glm"}\NormalTok{,}
    \AttributeTok{metalearner\_nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_levelone\_frame =} \ConstantTok{TRUE}\NormalTok{,}
    \AttributeTok{metalearner\_params =} \FunctionTok{list}\NormalTok{(}
      \AttributeTok{standardize =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{,}
      \AttributeTok{balance\_classes =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{class\_sampling\_factors =}\NormalTok{ samp\_factors,}
      \AttributeTok{max\_after\_balance\_size =} \FloatTok{0.5}
\NormalTok{    )}
\NormalTok{  )}
\NormalTok{  tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(}\StringTok{"superlearner\_xgboost"}\NormalTok{), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  model\_id }\OtherTok{\textless{}{-}} \StringTok{"metalearner\_glm\_superlearner\_xgboost"}
\NormalTok{  tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(model\_id), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  res }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(res, }\FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{h2o.getFrame}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"cv\_holdout\_prediction\_"}\NormalTok{, model\_id))[}\DecValTok{3}\NormalTok{],}
    \AttributeTok{col.names =} \FunctionTok{paste0}\NormalTok{(model\_id, }\StringTok{"\_"}\NormalTok{, }\FunctionTok{length}\NormalTok{(base\_models), }\StringTok{"\_models"}\NormalTok{)}
\NormalTok{  ))}
  \FunctionTok{write.csv}\NormalTok{(res, }\AttributeTok{file =} \FunctionTok{paste0}\NormalTok{(exp\_dir, }\StringTok{"/cv\_holdout\_predictions.csv"}\NormalTok{), }\AttributeTok{row.names =} \ConstantTok{FALSE}\NormalTok{)}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}n\textbackslash{}n}\StringTok{"}\NormalTok{)}
  \FunctionTok{h2o.removeAll}\NormalTok{()}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\hypertarget{inner-cross-validation-5}{%
\subsection{Inner cross-validation}\label{inner-cross-validation-5}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{load}\NormalTok{(}\AttributeTok{file =} \StringTok{"./rdata/var\_reduct\_tx\_train\_test\_splits\_y\_shuffled.RData"}\NormalTok{)}
\ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{) \{}
  \FunctionTok{cat}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"Outer training set "}\NormalTok{, i, }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{))}
\NormalTok{  prefix }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"outer\_"}\NormalTok{, i)}
\NormalTok{  exp\_dir }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"/Users/renee/Downloads/toxicity\_adversarial/"}\NormalTok{, prefix)}
  \FunctionTok{dir.create}\NormalTok{(exp\_dir)}
  \FunctionTok{train\_tx\_models}\NormalTok{(}\AttributeTok{train\_set =}\NormalTok{ outer\_splits[[i]][[}\StringTok{"train"}\NormalTok{]], }\AttributeTok{exp\_dir =}\NormalTok{ exp\_dir, }\AttributeTok{prefix =}\NormalTok{ prefix)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Keep track of grid models}
\NormalTok{dl\_grid }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
\NormalTok{gbm\_grid }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
\NormalTok{xgboost\_grid }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
\NormalTok{dl\_grid\_params }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
\NormalTok{gbm\_grid\_params }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
\NormalTok{xgboost\_grid\_params }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
\ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{) \{}
  \FunctionTok{cat}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"Outer training set "}\NormalTok{, i, }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{))}
\NormalTok{  prefix }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"outer\_"}\NormalTok{, i)}
\NormalTok{  dir }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"/Users/renee/Downloads/toxicity\_adversarial/"}\NormalTok{, prefix)}
\NormalTok{  files }\OtherTok{\textless{}{-}} \FunctionTok{list.files}\NormalTok{(dir)}
  \CommentTok{\# Deep learning}
\NormalTok{  dl }\OtherTok{\textless{}{-}}\NormalTok{ files[}\FunctionTok{str\_detect}\NormalTok{(files, }\StringTok{"DeepLearning\_model"}\NormalTok{)]}
  \ControlFlowTok{for}\NormalTok{ (m }\ControlFlowTok{in}\NormalTok{ dl) \{}
\NormalTok{    model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/"}\NormalTok{, m))}
\NormalTok{    hs }\OtherTok{\textless{}{-}} \FunctionTok{sha1}\NormalTok{(}\FunctionTok{paste}\NormalTok{(}\FunctionTok{c}\NormalTok{(}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{epsilon,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{hidden,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{hidden\_dropout\_ratios,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{input\_dropout\_ratio,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{rho}
\NormalTok{    ), }\AttributeTok{collapse =} \StringTok{" "}\NormalTok{))}
    \ControlFlowTok{if}\NormalTok{ (hs }\SpecialCharTok{\%in\%} \FunctionTok{names}\NormalTok{(dl\_grid)) \{}
\NormalTok{      dl\_grid[[hs]] }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(dl\_grid[[hs]], m)}
\NormalTok{    \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{      dl\_grid[[hs]] }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(m)}
\NormalTok{      dl\_grid\_params }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(}
\NormalTok{        dl\_grid\_params,}
        \FunctionTok{c}\NormalTok{(}
          \StringTok{"epsilon"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{epsilon,}
          \StringTok{"hidden"} \OtherTok{=} \FunctionTok{paste0}\NormalTok{(}\StringTok{"["}\NormalTok{, }\FunctionTok{paste}\NormalTok{(model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{hidden, }\AttributeTok{collapse =} \StringTok{","}\NormalTok{), }\StringTok{"]"}\NormalTok{),}
          \StringTok{"hidden\_dropout\_ratios"} \OtherTok{=} \FunctionTok{paste0}\NormalTok{(}
            \StringTok{"["}\NormalTok{,}
            \FunctionTok{paste}\NormalTok{(model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{hidden\_dropout\_ratios,}
              \AttributeTok{collapse =} \StringTok{","}
\NormalTok{            ), }\StringTok{"]"}
\NormalTok{          ),}
          \StringTok{"input\_dropout\_ratio"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{input\_dropout\_ratio,}
          \StringTok{"rho"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{rho}
\NormalTok{        )}
\NormalTok{      )}
\NormalTok{    \}}
\NormalTok{  \}}
  \FunctionTok{h2o.removeAll}\NormalTok{()}
  \CommentTok{\# GBM}
\NormalTok{  gbm }\OtherTok{\textless{}{-}}\NormalTok{ files[}\FunctionTok{str\_detect}\NormalTok{(files, }\StringTok{"GBM\_model"}\NormalTok{)]}
  \ControlFlowTok{for}\NormalTok{ (m }\ControlFlowTok{in}\NormalTok{ gbm) \{}
\NormalTok{    model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/"}\NormalTok{, m))}
\NormalTok{    hs }\OtherTok{\textless{}{-}} \FunctionTok{sha1}\NormalTok{(}\FunctionTok{paste}\NormalTok{(}\FunctionTok{c}\NormalTok{(}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{col\_sample\_rate,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{col\_sample\_rate\_per\_tree,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{max\_depth,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{min\_rows,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{min\_split\_improvement,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{sample\_rate}
\NormalTok{    ), }\AttributeTok{collapse =} \StringTok{" "}\NormalTok{))}
    \ControlFlowTok{if}\NormalTok{ (hs }\SpecialCharTok{\%in\%} \FunctionTok{names}\NormalTok{(gbm\_grid)) \{}
\NormalTok{      gbm\_grid[[hs]] }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(gbm\_grid[[hs]], m)}
\NormalTok{    \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{      gbm\_grid[[hs]] }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(m)}
\NormalTok{      gbm\_grid\_params }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(}
\NormalTok{        gbm\_grid\_params,}
        \FunctionTok{c}\NormalTok{(}
          \StringTok{"col\_sample\_rate"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{col\_sample\_rate,}
          \StringTok{"col\_sample\_rate\_per\_tree"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{col\_sample\_rate\_per\_tree,}
          \StringTok{"max\_depth"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{max\_depth,}
          \StringTok{"min\_rows"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{min\_rows,}
          \StringTok{"min\_split\_improvement"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{min\_split\_improvement,}
          \StringTok{"sample\_rate"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{sample\_rate}
\NormalTok{        )}
\NormalTok{      )}
\NormalTok{    \}}
\NormalTok{  \}}
  \FunctionTok{h2o.removeAll}\NormalTok{()}
  \CommentTok{\# XGBoost}
\NormalTok{  xgboost }\OtherTok{\textless{}{-}}\NormalTok{ files[}\FunctionTok{str\_detect}\NormalTok{(files, }\StringTok{"XGBoost\_model"}\NormalTok{)]}
  \ControlFlowTok{for}\NormalTok{ (m }\ControlFlowTok{in}\NormalTok{ xgboost) \{}
\NormalTok{    model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/"}\NormalTok{, m))}
\NormalTok{    hs }\OtherTok{\textless{}{-}} \FunctionTok{sha1}\NormalTok{(}\FunctionTok{paste}\NormalTok{(}\FunctionTok{c}\NormalTok{(}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{booster,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{col\_sample\_rate,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{col\_sample\_rate\_per\_tree,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{max\_depth,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{min\_rows,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{reg\_alpha,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{reg\_lambda,}
\NormalTok{      model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{sample\_rate}
\NormalTok{    ), }\AttributeTok{collapse =} \StringTok{" "}\NormalTok{))}
    \ControlFlowTok{if}\NormalTok{ (hs }\SpecialCharTok{\%in\%} \FunctionTok{names}\NormalTok{(xgboost\_grid)) \{}
\NormalTok{      xgboost\_grid[[hs]] }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(xgboost\_grid[[hs]], m)}
\NormalTok{    \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{      xgboost\_grid[[hs]] }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(m)}
\NormalTok{      xgboost\_grid\_params }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(}
\NormalTok{        xgboost\_grid\_params,}
        \FunctionTok{c}\NormalTok{(}
          \StringTok{"booster"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{booster,}
          \StringTok{"col\_sample\_rate"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{col\_sample\_rate,}
          \StringTok{"col\_sample\_rate\_per\_tree"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{col\_sample\_rate\_per\_tree,}
          \StringTok{"max\_depth"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{max\_depth,}
          \StringTok{"min\_rows"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{min\_rows,}
          \StringTok{"reg\_alpha"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{reg\_alpha,}
          \StringTok{"reg\_lambda"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{reg\_lambda,}
          \StringTok{"sample\_rate"} \OtherTok{=}\NormalTok{ model}\SpecialCharTok{@}\NormalTok{allparameters}\SpecialCharTok{$}\NormalTok{sample\_rate}
\NormalTok{        )}
\NormalTok{      )}
\NormalTok{    \}}
\NormalTok{  \}}
  \FunctionTok{h2o.removeAll}\NormalTok{()}
\NormalTok{\}}

\NormalTok{dl\_grid\_params }\OtherTok{\textless{}{-}} \FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{t}\NormalTok{(}\FunctionTok{data.frame}\NormalTok{(dl\_grid\_params)))}
\FunctionTok{rownames}\NormalTok{(dl\_grid\_params) }\OtherTok{\textless{}{-}} \FunctionTok{paste}\NormalTok{(}\StringTok{"Neural network grid model"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(dl\_grid\_params))}

\NormalTok{gbm\_grid\_params }\OtherTok{\textless{}{-}} \FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{t}\NormalTok{(}\FunctionTok{data.frame}\NormalTok{(gbm\_grid\_params)))}
\FunctionTok{rownames}\NormalTok{(gbm\_grid\_params) }\OtherTok{\textless{}{-}} \FunctionTok{paste}\NormalTok{(}\StringTok{"GBM grid model"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(gbm\_grid\_params))}

\NormalTok{xgboost\_grid\_params }\OtherTok{\textless{}{-}} \FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{t}\NormalTok{(}\FunctionTok{data.frame}\NormalTok{(xgboost\_grid\_params)))}
\FunctionTok{rownames}\NormalTok{(xgboost\_grid\_params) }\OtherTok{\textless{}{-}} \FunctionTok{paste}\NormalTok{(}\StringTok{"XGBoost grid model"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(xgboost\_grid\_params))}

\FunctionTok{write.csv}\NormalTok{(dl\_grid\_params, }\StringTok{"./other\_data/toxicity\_adversarial/neural\_network\_grid\_params.csv"}\NormalTok{)}
\FunctionTok{write.csv}\NormalTok{(gbm\_grid\_params, }\StringTok{"./other\_data/toxicity\_adversarial/gbm\_grid\_params.csv"}\NormalTok{)}
\FunctionTok{write.csv}\NormalTok{(xgboost\_grid\_params, }\StringTok{"./other\_data/toxicity\_adversarial/xgboost\_grid\_params.csv"}\NormalTok{)}

\FunctionTok{save}\NormalTok{(dl\_grid, gbm\_grid, xgboost\_grid, }\AttributeTok{file =} \StringTok{"./rdata/model\_training\_grid\_models\_tx\_ad.RData"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{model-evaluation-5}{%
\subsection{Model evaluation}\label{model-evaluation-5}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{model\_evaluation }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(holdout\_pred, fold\_asign, grid\_name, }\AttributeTok{grid\_meta =} \ConstantTok{NULL}\NormalTok{) \{}
\NormalTok{  res\_ }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
\NormalTok{  model\_num }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{startsWith}\NormalTok{(grid\_name, }\StringTok{"Super learner"}\NormalTok{)) \{}
    \ControlFlowTok{if}\NormalTok{ (grid\_name }\SpecialCharTok{==} \StringTok{"Super learner all models"}\NormalTok{) \{}
\NormalTok{      m }\OtherTok{\textless{}{-}} \FunctionTok{colnames}\NormalTok{(holdout\_pred)[}\FunctionTok{startsWith}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(holdout\_pred), }\StringTok{"metalearner\_glm\_superlearner\_iter\_0"}\NormalTok{)]}
\NormalTok{    \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (grid\_name }\SpecialCharTok{==} \StringTok{"Super learner final"}\NormalTok{) \{}
\NormalTok{      sl\_models }\OtherTok{\textless{}{-}} \FunctionTok{colnames}\NormalTok{(holdout\_pred)[}\FunctionTok{startsWith}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(holdout\_pred), }\StringTok{"metalearner\_glm\_superlearner\_iter"}\NormalTok{)]}
\NormalTok{      m }\OtherTok{\textless{}{-}}\NormalTok{ sl\_models[}\FunctionTok{length}\NormalTok{(sl\_models)]}
\NormalTok{    \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (grid\_name }\SpecialCharTok{==} \StringTok{"Super learner neural network"}\NormalTok{) \{}
\NormalTok{      m }\OtherTok{\textless{}{-}} \FunctionTok{colnames}\NormalTok{(holdout\_pred)[}\FunctionTok{startsWith}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(holdout\_pred), }\StringTok{"metalearner\_glm\_superlearner\_deeplearning"}\NormalTok{)]}
\NormalTok{    \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (grid\_name }\SpecialCharTok{==} \StringTok{"Super learner GBM"}\NormalTok{) \{}
\NormalTok{      m }\OtherTok{\textless{}{-}} \FunctionTok{colnames}\NormalTok{(holdout\_pred)[}\FunctionTok{startsWith}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(holdout\_pred), }\StringTok{"metalearner\_glm\_superlearner\_gbm"}\NormalTok{)]}
\NormalTok{    \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (grid\_name }\SpecialCharTok{==} \StringTok{"Super learner XGBoost"}\NormalTok{) \{}
\NormalTok{      m }\OtherTok{\textless{}{-}} \FunctionTok{colnames}\NormalTok{(holdout\_pred)[}\FunctionTok{startsWith}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(holdout\_pred), }\StringTok{"metalearner\_glm\_superlearner\_xgboost"}\NormalTok{)]}
\NormalTok{    \}}
\NormalTok{    logloss }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{    MCC }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{    F1 }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{    acc }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{    EF }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{    BEDROC }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{    threshold }\OtherTok{\textless{}{-}} \FloatTok{0.5}
    \ControlFlowTok{for}\NormalTok{ (k }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{) \{}
\NormalTok{      y\_true }\OtherTok{\textless{}{-}}\NormalTok{ holdout\_pred[fold\_assign }\SpecialCharTok{==}\NormalTok{ k, }\StringTok{"category"}\NormalTok{]}
\NormalTok{      y\_pred }\OtherTok{\textless{}{-}}\NormalTok{ holdout\_pred[fold\_assign }\SpecialCharTok{==}\NormalTok{ k, m]}
\NormalTok{      y\_pred\_cls }\OtherTok{\textless{}{-}} \FunctionTok{sapply}\NormalTok{(y\_pred, }\ControlFlowTok{function}\NormalTok{(x) }\ControlFlowTok{if}\NormalTok{ (x }\SpecialCharTok{\textgreater{}=}\NormalTok{ threshold) }\DecValTok{1} \ControlFlowTok{else} \DecValTok{0}\NormalTok{)}
\NormalTok{      logloss }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(logloss, }\FunctionTok{LogLoss}\NormalTok{(}\AttributeTok{y\_pred =}\NormalTok{ y\_pred, }\AttributeTok{y\_true =}\NormalTok{ y\_true))}
\NormalTok{      MCC }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(MCC, }\FunctionTok{mcc}\NormalTok{(}\AttributeTok{preds =}\NormalTok{ y\_pred\_cls, }\AttributeTok{actuals =}\NormalTok{ y\_true))}
\NormalTok{      F1 }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(F1, }\FunctionTok{F1\_Score}\NormalTok{(}\AttributeTok{y\_pred =}\NormalTok{ y\_pred\_cls, }\AttributeTok{y\_true =}\NormalTok{ y\_true))}
\NormalTok{      acc }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(acc, }\FunctionTok{balanced\_accuracy}\NormalTok{(}\AttributeTok{y\_pred =}\NormalTok{ y\_pred\_cls, }\AttributeTok{y\_true =}\NormalTok{ y\_true))}
\NormalTok{      EF }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(EF, }\FunctionTok{enrichment\_factor}\NormalTok{(}\AttributeTok{x =}\NormalTok{ y\_pred, }\AttributeTok{y =}\NormalTok{ y\_true, }\AttributeTok{top =} \FloatTok{0.05}\NormalTok{))}
\NormalTok{      BEDROC }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(BEDROC, }\FunctionTok{bedroc}\NormalTok{(}\AttributeTok{x =}\NormalTok{ y\_pred, }\AttributeTok{y =}\NormalTok{ y\_true, }\AttributeTok{alpha =} \DecValTok{20}\NormalTok{))}
\NormalTok{    \}}
\NormalTok{    res\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(res\_, }\FunctionTok{c}\NormalTok{(}
      \FunctionTok{mean}\NormalTok{(logloss, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{), }\FunctionTok{sem}\NormalTok{(logloss),}
      \FunctionTok{mean}\NormalTok{(MCC, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{), }\FunctionTok{sem}\NormalTok{(MCC),}
      \FunctionTok{mean}\NormalTok{(F1, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{), }\FunctionTok{sem}\NormalTok{(F1),}
      \FunctionTok{mean}\NormalTok{(acc, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{), }\FunctionTok{sem}\NormalTok{(acc),}
      \FunctionTok{mean}\NormalTok{(EF, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{), }\FunctionTok{sem}\NormalTok{(EF),}
      \FunctionTok{mean}\NormalTok{(BEDROC, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{), }\FunctionTok{sem}\NormalTok{(BEDROC),}
\NormalTok{      logloss, MCC, F1, acc, EF, BEDROC}
\NormalTok{    ))}
\NormalTok{  \} }\ControlFlowTok{else}\NormalTok{ \{}
    \ControlFlowTok{for}\NormalTok{ (j }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(grid\_meta)) \{}
\NormalTok{      g }\OtherTok{\textless{}{-}}\NormalTok{ grid\_meta[[j]]}
\NormalTok{      m }\OtherTok{\textless{}{-}} \FunctionTok{intersect}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(holdout\_pred), g)}
      \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{length}\NormalTok{(m) }\SpecialCharTok{==} \DecValTok{1}\NormalTok{) \{}
\NormalTok{        model\_num }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(model\_num, j)}
\NormalTok{        logloss }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{        MCC }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{        F1 }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{        acc }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{        EF }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{        BEDROC }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{        threshold }\OtherTok{\textless{}{-}} \FloatTok{0.5}
        \ControlFlowTok{for}\NormalTok{ (k }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{) \{}
\NormalTok{          y\_true }\OtherTok{\textless{}{-}}\NormalTok{ holdout\_pred[fold\_assign }\SpecialCharTok{==}\NormalTok{ k, }\StringTok{"category"}\NormalTok{]}
\NormalTok{          y\_pred }\OtherTok{\textless{}{-}}\NormalTok{ holdout\_pred[fold\_assign }\SpecialCharTok{==}\NormalTok{ k, m]}
\NormalTok{          y\_pred\_cls }\OtherTok{\textless{}{-}} \FunctionTok{sapply}\NormalTok{(y\_pred, }\ControlFlowTok{function}\NormalTok{(x) }\ControlFlowTok{if}\NormalTok{ (x }\SpecialCharTok{\textgreater{}=}\NormalTok{ threshold) }\DecValTok{1} \ControlFlowTok{else} \DecValTok{0}\NormalTok{)}
\NormalTok{          logloss }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(logloss, }\FunctionTok{LogLoss}\NormalTok{(}\AttributeTok{y\_pred =}\NormalTok{ y\_pred, }\AttributeTok{y\_true =}\NormalTok{ y\_true))}
\NormalTok{          MCC }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(MCC, }\FunctionTok{mcc}\NormalTok{(}\AttributeTok{preds =}\NormalTok{ y\_pred\_cls, }\AttributeTok{actuals =}\NormalTok{ y\_true))}
\NormalTok{          F1 }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(F1, }\FunctionTok{F1\_Score}\NormalTok{(}\AttributeTok{y\_pred =}\NormalTok{ y\_pred\_cls, }\AttributeTok{y\_true =}\NormalTok{ y\_true))}
\NormalTok{          acc }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(acc, }\FunctionTok{balanced\_accuracy}\NormalTok{(}\AttributeTok{y\_pred =}\NormalTok{ y\_pred\_cls, }\AttributeTok{y\_true =}\NormalTok{ y\_true))}
\NormalTok{          EF }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(EF, }\FunctionTok{enrichment\_factor}\NormalTok{(}\AttributeTok{x =}\NormalTok{ y\_pred, }\AttributeTok{y =}\NormalTok{ y\_true, }\AttributeTok{top =} \FloatTok{0.05}\NormalTok{))}
\NormalTok{          BEDROC }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(BEDROC, }\FunctionTok{bedroc}\NormalTok{(}\AttributeTok{x =}\NormalTok{ y\_pred, }\AttributeTok{y =}\NormalTok{ y\_true, }\AttributeTok{alpha =} \DecValTok{20}\NormalTok{))}
\NormalTok{        \}}
\NormalTok{        res\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(res\_, }\FunctionTok{c}\NormalTok{(}
          \FunctionTok{mean}\NormalTok{(logloss, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{), }\FunctionTok{sem}\NormalTok{(logloss),}
          \FunctionTok{mean}\NormalTok{(MCC, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{), }\FunctionTok{sem}\NormalTok{(MCC),}
          \FunctionTok{mean}\NormalTok{(F1, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{), }\FunctionTok{sem}\NormalTok{(F1),}
          \FunctionTok{mean}\NormalTok{(acc, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{), }\FunctionTok{sem}\NormalTok{(acc),}
          \FunctionTok{mean}\NormalTok{(EF, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{), }\FunctionTok{sem}\NormalTok{(EF),}
          \FunctionTok{mean}\NormalTok{(BEDROC, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{), }\FunctionTok{sem}\NormalTok{(BEDROC),}
\NormalTok{          logloss, MCC, F1, acc, EF, BEDROC}
\NormalTok{        ))}
\NormalTok{      \}}
\NormalTok{    \}}
\NormalTok{  \}}
\NormalTok{  res }\OtherTok{\textless{}{-}} \FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{t}\NormalTok{(}\FunctionTok{data.frame}\NormalTok{(res\_)))}
  \FunctionTok{colnames}\NormalTok{(res) }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}
    \StringTok{"Log loss mean"}\NormalTok{, }\StringTok{"Log loss s.e.m."}\NormalTok{, }\StringTok{"MCC mean"}\NormalTok{, }\StringTok{"MCC s.e.m."}\NormalTok{, }\StringTok{"F\_1 mean"}\NormalTok{, }\StringTok{"F\_1 s.e.m."}\NormalTok{,}
    \StringTok{"Balanced accuracy mean"}\NormalTok{, }\StringTok{"Balanced accuracy s.e.m."}\NormalTok{, }\StringTok{"EF mean"}\NormalTok{, }\StringTok{"EF s.e.m."}\NormalTok{, }\StringTok{"BEDROC mean"}\NormalTok{, }\StringTok{"BEDROC s.e.m."}\NormalTok{,}
    \FunctionTok{paste}\NormalTok{(}\StringTok{"Log loss CV"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{), }\FunctionTok{paste}\NormalTok{(}\StringTok{"MCC CV"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{), }\FunctionTok{paste}\NormalTok{(}\StringTok{"F\_1 CV"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{),}
    \FunctionTok{paste}\NormalTok{(}\StringTok{"Balanced accuracy CV"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{), }\FunctionTok{paste}\NormalTok{(}\StringTok{"EF CV"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{), }\FunctionTok{paste}\NormalTok{(}\StringTok{"BEDROC CV"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{)}
\NormalTok{  )}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{nrow}\NormalTok{(res) }\SpecialCharTok{==} \DecValTok{1}\NormalTok{) \{}
    \FunctionTok{rownames}\NormalTok{(res) }\OtherTok{\textless{}{-}}\NormalTok{ grid\_name}
\NormalTok{  \} }\ControlFlowTok{else}\NormalTok{ \{}
    \FunctionTok{rownames}\NormalTok{(res) }\OtherTok{\textless{}{-}} \FunctionTok{paste}\NormalTok{(grid\_name, model\_num)}
\NormalTok{  \}}
  \FunctionTok{return}\NormalTok{(res)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\hypertarget{inner-loop-model-selection-5}{%
\subsection{Inner loop model selection}\label{inner-loop-model-selection-5}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{load}\NormalTok{(}\AttributeTok{file =} \StringTok{"./rdata/model\_training\_grid\_models\_tx\_ad.RData"}\NormalTok{)}

\ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{) \{}
\NormalTok{  holdout\_pred }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"./other\_data/toxicity\_adversarial/outer\_"}\NormalTok{, i, }\StringTok{"/cv\_holdout\_predictions.csv"}\NormalTok{))}
\NormalTok{  fold\_assign }\OtherTok{\textless{}{-}} \FunctionTok{rep}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{, }\FunctionTok{ceiling}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(holdout\_pred) }\SpecialCharTok{/} \DecValTok{10}\NormalTok{))[}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(holdout\_pred)]}
\NormalTok{  data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
  \CommentTok{\# Deep learning grid models}
\NormalTok{  data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign,}
    \AttributeTok{grid\_name =} \StringTok{"Neural network grid model"}\NormalTok{,}
    \AttributeTok{grid\_meta =}\NormalTok{ dl\_grid}
\NormalTok{  ))}
  \CommentTok{\# GBM grid models}
\NormalTok{  data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign,}
    \AttributeTok{grid\_name =} \StringTok{"GBM grid model"}\NormalTok{,}
    \AttributeTok{grid\_meta =}\NormalTok{ gbm\_grid}
\NormalTok{  ))}
  \CommentTok{\# GBM default models}
\NormalTok{  data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign,}
    \AttributeTok{grid\_name =} \StringTok{"GBM model"}\NormalTok{,}
    \AttributeTok{grid\_meta =} \FunctionTok{as.list}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"GBM\_"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{5}\NormalTok{))}
\NormalTok{  ))}
  \CommentTok{\# XGBoost grid models}
\NormalTok{  data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign,}
    \AttributeTok{grid\_name =} \StringTok{"XGBoost grid model"}\NormalTok{,}
    \AttributeTok{grid\_meta =}\NormalTok{ xgboost\_grid}
\NormalTok{  ))}
  \CommentTok{\# XGBoost default models}
\NormalTok{  data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign,}
    \AttributeTok{grid\_name =} \StringTok{"XGBoost model"}\NormalTok{,}
    \AttributeTok{grid\_meta =} \FunctionTok{as.list}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"XGBoost\_"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{))}
\NormalTok{  ))}
  \CommentTok{\# GLM}
\NormalTok{  data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign, }\AttributeTok{grid\_name =} \StringTok{"GLM model"}\NormalTok{, }\AttributeTok{grid\_meta =} \FunctionTok{list}\NormalTok{(}\StringTok{"GLM"}\NormalTok{)))}
  \CommentTok{\# DRF}
\NormalTok{  data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign, }\AttributeTok{grid\_name =} \StringTok{"DRF model"}\NormalTok{, }\AttributeTok{grid\_meta =} \FunctionTok{list}\NormalTok{(}\StringTok{"DRF"}\NormalTok{)))}
  \CommentTok{\# XRT}
\NormalTok{  data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign, }\AttributeTok{grid\_name =} \StringTok{"XRT model"}\NormalTok{, }\AttributeTok{grid\_meta =} \FunctionTok{list}\NormalTok{(}\StringTok{"XRT"}\NormalTok{)))}
  \CommentTok{\# Super learner all}
\NormalTok{  data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign, }\AttributeTok{grid\_name =} \StringTok{"Super learner all models"}\NormalTok{))}
  \CommentTok{\# Super learner final}
\NormalTok{  data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign, }\AttributeTok{grid\_name =} \StringTok{"Super learner final"}\NormalTok{))}
  \CommentTok{\# Super learner deep learning}
\NormalTok{  data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign, }\AttributeTok{grid\_name =} \StringTok{"Super learner neural network"}\NormalTok{))}
  \CommentTok{\# Super learner GBM}
\NormalTok{  data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign, }\AttributeTok{grid\_name =} \StringTok{"Super learner GBM"}\NormalTok{))}
  \CommentTok{\# Super learner XGBoost}
\NormalTok{  data\_ }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(data\_, }\FunctionTok{model\_evaluation}\NormalTok{(holdout\_pred, fold\_assign, }\AttributeTok{grid\_name =} \StringTok{"Super learner XGBoost"}\NormalTok{))}

\NormalTok{  data }\OtherTok{\textless{}{-}} \FunctionTok{do.call}\NormalTok{(rbind, data\_)}
  \FunctionTok{write.csv}\NormalTok{(data, }\FunctionTok{paste0}\NormalTok{(}\StringTok{"./other\_data/toxicity\_adversarial/outer\_"}\NormalTok{, i, }\StringTok{"/cv\_res.csv"}\NormalTok{))}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\hypertarget{cv-1-5}{%
\subsubsection{CV 1}\label{cv-1-5}}

\includegraphics{05_adversarial_computational_control_files/figure-latex/unnamed-chunk-47-1.pdf}

\hypertarget{cv-2-5}{%
\subsubsection{CV 2}\label{cv-2-5}}

\includegraphics{05_adversarial_computational_control_files/figure-latex/unnamed-chunk-48-1.pdf}

\hypertarget{cv-3-5}{%
\subsubsection{CV 3}\label{cv-3-5}}

\includegraphics{05_adversarial_computational_control_files/figure-latex/unnamed-chunk-49-1.pdf}

\hypertarget{cv-4-5}{%
\subsubsection{CV 4}\label{cv-4-5}}

\includegraphics{05_adversarial_computational_control_files/figure-latex/unnamed-chunk-50-1.pdf}

\hypertarget{cv-5-5}{%
\subsubsection{CV 5}\label{cv-5-5}}

\includegraphics{05_adversarial_computational_control_files/figure-latex/unnamed-chunk-51-1.pdf}

\hypertarget{cv-6-5}{%
\subsubsection{CV 6}\label{cv-6-5}}

\includegraphics{05_adversarial_computational_control_files/figure-latex/unnamed-chunk-52-1.pdf}

\hypertarget{cv-7-5}{%
\subsubsection{CV 7}\label{cv-7-5}}

\includegraphics{05_adversarial_computational_control_files/figure-latex/unnamed-chunk-53-1.pdf}

\hypertarget{cv-8-5}{%
\subsubsection{CV 8}\label{cv-8-5}}

\includegraphics{05_adversarial_computational_control_files/figure-latex/unnamed-chunk-54-1.pdf}

\hypertarget{cv-9-5}{%
\subsubsection{CV 9}\label{cv-9-5}}

\includegraphics{05_adversarial_computational_control_files/figure-latex/unnamed-chunk-55-1.pdf}

\hypertarget{cv-10-5}{%
\subsubsection{CV 10}\label{cv-10-5}}

\includegraphics{05_adversarial_computational_control_files/figure-latex/unnamed-chunk-56-1.pdf}

\hypertarget{final-evaluation-5}{%
\subsection{Final evaluation}\label{final-evaluation-5}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{load}\NormalTok{(}\AttributeTok{file =} \StringTok{"./rdata/var\_reduct\_tx\_train\_test\_splits\_y\_shuffled.RData"}\NormalTok{)}
\FunctionTok{load}\NormalTok{(}\AttributeTok{file =} \StringTok{"./rdata/model\_training\_grid\_models\_tx\_ad.RData"}\NormalTok{)}
\NormalTok{dir }\OtherTok{\textless{}{-}} \StringTok{"/Users/renee/Downloads/toxicity\_adversarial"}
\NormalTok{selected\_models }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}
  \StringTok{"GBM grid model 52"}\NormalTok{, }\StringTok{"GBM grid model 95"}\NormalTok{, }\StringTok{"GBM grid model 48"}\NormalTok{,}
  \StringTok{"GBM grid model 98"}\NormalTok{, }\StringTok{"GBM grid model 55"}\NormalTok{, }\StringTok{"GBM grid model 21"}\NormalTok{,}
  \StringTok{"GBM grid model 23"}\NormalTok{, }\StringTok{"GBM grid model 54"}\NormalTok{, }\StringTok{"GBM grid model 3"}\NormalTok{,}
  \StringTok{"GBM grid model 68"}
\NormalTok{)}
\NormalTok{logloss }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{MCC }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{F1 }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{acc }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{EF }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{BEDROC }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{threshold }\OtherTok{\textless{}{-}} \FloatTok{0.5}
\ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{) \{}
\NormalTok{  holdout\_pred }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"./other\_data/toxicity\_adversarial/outer\_"}\NormalTok{, i, }\StringTok{"/cv\_holdout\_predictions.csv"}\NormalTok{))}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{startsWith}\NormalTok{(selected\_models[i], }\StringTok{"Neural network grid model"}\NormalTok{)) \{}
\NormalTok{    grid\_num }\OtherTok{\textless{}{-}} \FunctionTok{as.integer}\NormalTok{(}\FunctionTok{str\_extract}\NormalTok{(selected\_models[i], }\StringTok{"[0{-}9]+"}\NormalTok{))}
\NormalTok{    m }\OtherTok{\textless{}{-}} \FunctionTok{intersect}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(holdout\_pred), dl\_grid[[grid\_num]])}
\NormalTok{    model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/outer\_"}\NormalTok{, i, }\StringTok{"/"}\NormalTok{, m))}
\NormalTok{  \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{startsWith}\NormalTok{(selected\_models[i], }\StringTok{"GBM grid model"}\NormalTok{)) \{}
\NormalTok{    grid\_num }\OtherTok{\textless{}{-}} \FunctionTok{as.integer}\NormalTok{(}\FunctionTok{str\_extract}\NormalTok{(selected\_models[i], }\StringTok{"[0{-}9]+"}\NormalTok{))}
\NormalTok{    m }\OtherTok{\textless{}{-}} \FunctionTok{intersect}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(holdout\_pred), gbm\_grid[[grid\_num]])}
\NormalTok{    model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/outer\_"}\NormalTok{, i, }\StringTok{"/"}\NormalTok{, m))}
\NormalTok{  \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{startsWith}\NormalTok{(selected\_models[i], }\StringTok{"GBM model"}\NormalTok{)) \{}
\NormalTok{    grid\_num }\OtherTok{\textless{}{-}} \FunctionTok{as.integer}\NormalTok{(}\FunctionTok{str\_extract}\NormalTok{(selected\_models[i], }\StringTok{"[0{-}9]+"}\NormalTok{))}
\NormalTok{    model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/outer\_"}\NormalTok{, i, }\StringTok{"/GBM\_"}\NormalTok{, grid\_num))}
\NormalTok{  \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{startsWith}\NormalTok{(selected\_models[i], }\StringTok{"XGBoost grid model"}\NormalTok{)) \{}
\NormalTok{    grid\_num }\OtherTok{\textless{}{-}} \FunctionTok{as.integer}\NormalTok{(}\FunctionTok{str\_extract}\NormalTok{(selected\_models[i], }\StringTok{"[0{-}9]+"}\NormalTok{))}
\NormalTok{    m }\OtherTok{\textless{}{-}} \FunctionTok{intersect}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(holdout\_pred), xgboost\_grid[[grid\_num]])}
\NormalTok{    model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/outer\_"}\NormalTok{, i, }\StringTok{"/"}\NormalTok{, m))}
\NormalTok{  \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{startsWith}\NormalTok{(selected\_models[i], }\StringTok{"XGBoost model"}\NormalTok{)) \{}
\NormalTok{    grid\_num }\OtherTok{\textless{}{-}} \FunctionTok{as.integer}\NormalTok{(}\FunctionTok{str\_extract}\NormalTok{(selected\_models[i], }\StringTok{"[0{-}9]+"}\NormalTok{))}
\NormalTok{    model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/outer\_"}\NormalTok{, i, }\StringTok{"/XGBoost\_"}\NormalTok{, grid\_num))}
\NormalTok{  \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (selected\_models[i] }\SpecialCharTok{==} \StringTok{"Super learner all models"}\NormalTok{) \{}
\NormalTok{    model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/outer\_"}\NormalTok{, i, }\StringTok{"/superlearner\_iter\_0"}\NormalTok{))}
\NormalTok{  \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (selected\_models[i] }\SpecialCharTok{==} \StringTok{"Super learner final"}\NormalTok{) \{}
\NormalTok{    files }\OtherTok{\textless{}{-}} \FunctionTok{list.files}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/outer\_"}\NormalTok{, i))}
\NormalTok{    files }\OtherTok{\textless{}{-}}\NormalTok{ files[}\FunctionTok{startsWith}\NormalTok{(files, }\StringTok{"superlearner\_iter"}\NormalTok{)]}
\NormalTok{    model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/outer\_"}\NormalTok{, i, }\StringTok{"/"}\NormalTok{, files[}\FunctionTok{length}\NormalTok{(files)]))}
\NormalTok{  \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (selected\_models[i] }\SpecialCharTok{==} \StringTok{"Super learner neural network"}\NormalTok{) \{}
\NormalTok{    model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/outer\_"}\NormalTok{, i, }\StringTok{"/superlearner\_deeplearning"}\NormalTok{))}
\NormalTok{  \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (selected\_models[i] }\SpecialCharTok{==} \StringTok{"Super learner GBM"}\NormalTok{) \{}
\NormalTok{    model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/outer\_"}\NormalTok{, i, }\StringTok{"/superlearner\_gbm"}\NormalTok{))}
\NormalTok{  \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (selected\_models[i] }\SpecialCharTok{==} \StringTok{"Super learner XGBoost"}\NormalTok{) \{}
\NormalTok{    model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/outer\_"}\NormalTok{, i, }\StringTok{"/superlearner\_xgboost"}\NormalTok{))}
\NormalTok{  \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{    model }\OtherTok{\textless{}{-}} \FunctionTok{h2o.loadModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/outer\_"}\NormalTok{, i, }\StringTok{"/"}\NormalTok{, }\FunctionTok{unlist}\NormalTok{(}\FunctionTok{strsplit}\NormalTok{(selected\_models[i], }\StringTok{" "}\NormalTok{))[}\DecValTok{1}\NormalTok{]))}
\NormalTok{  \}}
\NormalTok{  tmp }\OtherTok{\textless{}{-}} \FunctionTok{as.h2o}\NormalTok{(}\FunctionTok{subset}\NormalTok{(outer\_splits[[i]][[}\StringTok{"test"}\NormalTok{]], }\AttributeTok{select =} \SpecialCharTok{{-}}\NormalTok{category))}
\NormalTok{  y\_true }\OtherTok{\textless{}{-}} \FunctionTok{as.numeric}\NormalTok{(outer\_splits[[i]][[}\StringTok{"test"}\NormalTok{]]}\SpecialCharTok{$}\NormalTok{category) }\SpecialCharTok{{-}} \DecValTok{1}
\NormalTok{  y\_pred }\OtherTok{\textless{}{-}} \FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{h2o.predict}\NormalTok{(model, tmp)))[, }\DecValTok{3}\NormalTok{]}
\NormalTok{  y\_pred\_cls }\OtherTok{\textless{}{-}} \FunctionTok{sapply}\NormalTok{(y\_pred, }\ControlFlowTok{function}\NormalTok{(x) }\ControlFlowTok{if}\NormalTok{ (x }\SpecialCharTok{\textgreater{}=}\NormalTok{ threshold) }\DecValTok{1} \ControlFlowTok{else} \DecValTok{0}\NormalTok{)}
\NormalTok{  logloss }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(logloss, }\FunctionTok{LogLoss}\NormalTok{(}\AttributeTok{y\_pred =}\NormalTok{ y\_pred, }\AttributeTok{y\_true =}\NormalTok{ y\_true))}
\NormalTok{  MCC }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(MCC, }\FunctionTok{mcc}\NormalTok{(}\AttributeTok{preds =}\NormalTok{ y\_pred\_cls, }\AttributeTok{actuals =}\NormalTok{ y\_true))}
\NormalTok{  F1 }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(F1, }\FunctionTok{F1\_Score}\NormalTok{(}\AttributeTok{y\_pred =}\NormalTok{ y\_pred\_cls, }\AttributeTok{y\_true =}\NormalTok{ y\_true))}
\NormalTok{  acc }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(acc, }\FunctionTok{balanced\_accuracy}\NormalTok{(}\AttributeTok{y\_pred =}\NormalTok{ y\_pred\_cls, }\AttributeTok{y\_true =}\NormalTok{ y\_true))}
\NormalTok{  EF }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(EF, }\FunctionTok{enrichment\_factor}\NormalTok{(}\AttributeTok{x =}\NormalTok{ y\_pred, }\AttributeTok{y =}\NormalTok{ y\_true, }\AttributeTok{top =} \FloatTok{0.05}\NormalTok{))}
\NormalTok{  BEDROC }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(BEDROC, }\FunctionTok{bedroc}\NormalTok{(}\AttributeTok{x =}\NormalTok{ y\_pred, }\AttributeTok{y =}\NormalTok{ y\_true, }\AttributeTok{alpha =} \DecValTok{20}\NormalTok{))}
\NormalTok{\}}
\FunctionTok{save}\NormalTok{(logloss, MCC, F1, acc, EF, BEDROC, }\AttributeTok{file =} \StringTok{"./rdata/final\_evaluation\_tx\_ad.RData"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{load}\NormalTok{(}\AttributeTok{file =} \StringTok{"./rdata/final\_evaluation\_tx\_ad.RData"}\NormalTok{)}
\FunctionTok{data.frame}\NormalTok{(}
  \AttributeTok{Metric =} \FunctionTok{c}\NormalTok{(}\StringTok{"Log loss"}\NormalTok{, }\StringTok{"MCC"}\NormalTok{, }\StringTok{"F\textless{}sub\textgreater{}1\textless{}/sub\textgreater{}"}\NormalTok{, }\StringTok{"Balanced accuracy"}\NormalTok{, }\StringTok{"EF"}\NormalTok{, }\StringTok{"BEDROC"}\NormalTok{),}
  \StringTok{\textasciigrave{}}\AttributeTok{Mean  s.e.m.}\StringTok{\textasciigrave{}} \OtherTok{=} \FunctionTok{c}\NormalTok{(}
    \FunctionTok{paste0}\NormalTok{(}\FunctionTok{round}\NormalTok{(}\FunctionTok{mean}\NormalTok{(logloss), }\DecValTok{3}\NormalTok{), }\StringTok{"  "}\NormalTok{, }\FunctionTok{round}\NormalTok{(}\FunctionTok{sem}\NormalTok{(logloss), }\DecValTok{3}\NormalTok{)),}
    \FunctionTok{paste0}\NormalTok{(}\FunctionTok{round}\NormalTok{(}\FunctionTok{mean}\NormalTok{(MCC), }\DecValTok{3}\NormalTok{), }\StringTok{"  "}\NormalTok{, }\FunctionTok{round}\NormalTok{(}\FunctionTok{sem}\NormalTok{(MCC), }\DecValTok{3}\NormalTok{)),}
    \FunctionTok{paste0}\NormalTok{(}\FunctionTok{round}\NormalTok{(}\FunctionTok{mean}\NormalTok{(F1, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{), }\DecValTok{3}\NormalTok{), }\StringTok{"  "}\NormalTok{, }\FunctionTok{round}\NormalTok{(}\FunctionTok{sem}\NormalTok{(F1), }\DecValTok{3}\NormalTok{)),}
    \FunctionTok{paste0}\NormalTok{(}\FunctionTok{round}\NormalTok{(}\FunctionTok{mean}\NormalTok{(acc), }\DecValTok{3}\NormalTok{), }\StringTok{"  "}\NormalTok{, }\FunctionTok{round}\NormalTok{(}\FunctionTok{sem}\NormalTok{(acc), }\DecValTok{3}\NormalTok{)),}
    \FunctionTok{paste0}\NormalTok{(}\FunctionTok{round}\NormalTok{(}\FunctionTok{mean}\NormalTok{(EF), }\DecValTok{3}\NormalTok{), }\StringTok{"  "}\NormalTok{, }\FunctionTok{round}\NormalTok{(}\FunctionTok{sem}\NormalTok{(EF), }\DecValTok{3}\NormalTok{)),}
    \FunctionTok{paste0}\NormalTok{(}\FunctionTok{round}\NormalTok{(}\FunctionTok{mean}\NormalTok{(BEDROC), }\DecValTok{3}\NormalTok{), }\StringTok{"  "}\NormalTok{, }\FunctionTok{round}\NormalTok{(}\FunctionTok{sem}\NormalTok{(BEDROC), }\DecValTok{3}\NormalTok{))}
\NormalTok{  ),}
  \AttributeTok{check.names =} \ConstantTok{FALSE}
\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{datatable}\NormalTok{(}\AttributeTok{escape =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{rownames =} \ConstantTok{FALSE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{05_adversarial_computational_control_files/figure-latex/unnamed-chunk-58-1.pdf}

\hypertarget{overall-model-interpretation-1}{%
\section{Overall model interpretation}\label{overall-model-interpretation-1}}

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ h2o}
\ImportTok{import}\NormalTok{ pandas }\ImportTok{as}\NormalTok{ pd}
\ImportTok{import}\NormalTok{ numpy }\ImportTok{as}\NormalTok{ np}
\ImportTok{import}\NormalTok{ shap}
\ImportTok{import}\NormalTok{ matplotlib.pyplot }\ImportTok{as}\NormalTok{ plt}
\ImportTok{import}\NormalTok{ session\_info}
\end{Highlighting}
\end{Shaded}

\hypertarget{melanin-binding-regression-4}{%
\subsection{Melanin binding (regression)}\label{melanin-binding-regression-4}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Save train and test sets in csv format}
\FunctionTok{load}\NormalTok{(}\AttributeTok{file =} \StringTok{"./rdata/var\_reduct\_mb\_train\_test\_splits\_y\_shuffled.RData"}\NormalTok{)}
\ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{) \{}
\NormalTok{  prefix }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"outer\_"}\NormalTok{, i)}
\NormalTok{  exp\_dir }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"/Users/renee/Downloads/melanin\_binding\_adversarial/"}\NormalTok{, prefix)}
  \FunctionTok{write.csv}\NormalTok{(outer\_splits[[i]]}\SpecialCharTok{$}\NormalTok{train, }\AttributeTok{file =} \FunctionTok{paste0}\NormalTok{(exp\_dir, }\StringTok{"/train\_set.csv"}\NormalTok{))}
  \FunctionTok{write.csv}\NormalTok{(outer\_splits[[i]]}\SpecialCharTok{$}\NormalTok{test, }\AttributeTok{file =} \FunctionTok{paste0}\NormalTok{(exp\_dir, }\StringTok{"/test\_set.csv"}\NormalTok{))}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{h2o.init(nthreads}\OperatorTok{={-}}\DecValTok{1}\NormalTok{)}

\NormalTok{dir\_path }\OperatorTok{=} \StringTok{\textquotesingle{}/Users/renee/Downloads/melanin\_binding\_adversarial\textquotesingle{}}
\NormalTok{model\_names }\OperatorTok{=}\NormalTok{ [}\StringTok{\textquotesingle{}superlearner\_iter\_6\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}superlearner\_iter\_5\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}superlearner\_iter\_6\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}superlearner\_iter\_6\textquotesingle{}}\NormalTok{, }
               \StringTok{\textquotesingle{}superlearner\_iter\_7\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}superlearner\_iter\_7\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}superlearner\_iter\_6\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}superlearner\_iter\_7\textquotesingle{}}\NormalTok{, }
               \StringTok{\textquotesingle{}superlearner\_iter\_7\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}superlearner\_iter\_6\textquotesingle{}}\NormalTok{]}
\NormalTok{shap\_res }\OperatorTok{=}\NormalTok{ []}
\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{10}\NormalTok{):}
    \BuiltInTok{print}\NormalTok{(}\StringTok{\textquotesingle{}Iter \textquotesingle{}} \OperatorTok{+} \BuiltInTok{str}\NormalTok{(i }\OperatorTok{+} \DecValTok{1}\NormalTok{) }\OperatorTok{+} \StringTok{\textquotesingle{}:\textquotesingle{}}\NormalTok{)}
\NormalTok{    train }\OperatorTok{=}\NormalTok{ pd.read\_csv(dir\_path }\OperatorTok{+} \StringTok{\textquotesingle{}/outer\_\textquotesingle{}} \OperatorTok{+} \BuiltInTok{str}\NormalTok{(i }\OperatorTok{+} \DecValTok{1}\NormalTok{) }\OperatorTok{+} \StringTok{\textquotesingle{}/train\_set.csv\textquotesingle{}}\NormalTok{, index\_col}\OperatorTok{=}\DecValTok{0}\NormalTok{)}
\NormalTok{    X\_train }\OperatorTok{=}\NormalTok{ train.iloc[:, :}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\NormalTok{    test }\OperatorTok{=}\NormalTok{ pd.read\_csv(dir\_path }\OperatorTok{+} \StringTok{\textquotesingle{}/outer\_\textquotesingle{}} \OperatorTok{+} \BuiltInTok{str}\NormalTok{(i }\OperatorTok{+} \DecValTok{1}\NormalTok{) }\OperatorTok{+} \StringTok{\textquotesingle{}/test\_set.csv\textquotesingle{}}\NormalTok{, index\_col}\OperatorTok{=}\DecValTok{0}\NormalTok{)}
\NormalTok{    X\_test }\OperatorTok{=}\NormalTok{ test.iloc[:, :}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\NormalTok{    model }\OperatorTok{=}\NormalTok{ h2o.load\_model(dir\_path }\OperatorTok{+} \StringTok{\textquotesingle{}/outer\_\textquotesingle{}} \OperatorTok{+} \BuiltInTok{str}\NormalTok{(i }\OperatorTok{+} \DecValTok{1}\NormalTok{) }\OperatorTok{+} \StringTok{\textquotesingle{}/\textquotesingle{}} \OperatorTok{+}\NormalTok{ model\_names[i])}
    \KeywordTok{def}\NormalTok{ model\_predict\_(data):}
\NormalTok{        data }\OperatorTok{=}\NormalTok{ pd.DataFrame(data, columns}\OperatorTok{=}\NormalTok{X\_train.columns)}
\NormalTok{        h2o\_data }\OperatorTok{=}\NormalTok{ h2o.H2OFrame(data)}
\NormalTok{        res }\OperatorTok{=}\NormalTok{ model.predict(h2o\_data)}
\NormalTok{        res }\OperatorTok{=}\NormalTok{ res.as\_data\_frame()}
        \ControlFlowTok{return}\NormalTok{(res)}
\NormalTok{    np.random.seed(}\DecValTok{1}\NormalTok{)}
\NormalTok{    X\_train\_ }\OperatorTok{=}\NormalTok{ X\_train.iloc[np.random.choice(X\_train.shape[}\DecValTok{0}\NormalTok{], }\DecValTok{100}\NormalTok{, replace}\OperatorTok{=}\VariableTok{False}\NormalTok{), :]}
\NormalTok{    explainer }\OperatorTok{=}\NormalTok{ shap.KernelExplainer(model\_predict\_, X\_train\_, link}\OperatorTok{=}\StringTok{\textquotesingle{}identity\textquotesingle{}}\NormalTok{)}
\NormalTok{    shap\_values }\OperatorTok{=}\NormalTok{ explainer.shap\_values(X\_test, nsamples}\OperatorTok{=}\DecValTok{1000}\NormalTok{)}
\NormalTok{    shap\_res.append(shap\_values)}
\NormalTok{    h2o.remove\_all()}

\NormalTok{shap\_res }\OperatorTok{=}\NormalTok{ pd.DataFrame(np.vstack(shap\_res), columns}\OperatorTok{=}\NormalTok{X\_train.columns)}
\NormalTok{shap\_res.to\_csv(}\StringTok{\textquotesingle{}./other\_data/mb\_ad\_shap\_values\_cv\_data\_sets.csv\textquotesingle{}}\NormalTok{, index}\OperatorTok{=}\VariableTok{False}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{load}\NormalTok{(}\AttributeTok{file =} \StringTok{"./rdata/var\_reduct\_mb\_train\_test\_splits\_y\_shuffled.RData"}\NormalTok{)}
\NormalTok{data }\OtherTok{\textless{}{-}} \FunctionTok{do.call}\NormalTok{(rbind, }\FunctionTok{lapply}\NormalTok{(outer\_splits, }\ControlFlowTok{function}\NormalTok{(x) x}\SpecialCharTok{$}\NormalTok{test[}\SpecialCharTok{{-}}\FunctionTok{ncol}\NormalTok{(mb\_data)]))}
\NormalTok{data }\OtherTok{\textless{}{-}} \FunctionTok{apply}\NormalTok{(data, }\DecValTok{2}\NormalTok{, }\ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{rank}\NormalTok{(x))}
\NormalTok{data }\OtherTok{\textless{}{-}} \FunctionTok{apply}\NormalTok{(data, }\DecValTok{2}\NormalTok{, }\ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{rescale}\NormalTok{(x, }\AttributeTok{to =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{100}\NormalTok{)))}
\NormalTok{shap\_values }\OtherTok{\textless{}{-}} \FunctionTok{as.matrix}\NormalTok{(}\FunctionTok{read.csv}\NormalTok{(}\StringTok{"./other\_data/mb\_ad\_shap\_values\_cv\_data\_sets.csv"}\NormalTok{, }\AttributeTok{check.names =} \ConstantTok{FALSE}\NormalTok{))}
\NormalTok{shap\_values }\OtherTok{\textless{}{-}} \FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{rescale}\NormalTok{(shap\_values, }\AttributeTok{to =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{100}\NormalTok{), }\AttributeTok{from =} \FunctionTok{range}\NormalTok{(mb\_data}\SpecialCharTok{$}\NormalTok{log\_intensity)))}

\NormalTok{var\_diff }\OtherTok{\textless{}{-}} \FunctionTok{apply}\NormalTok{(shap\_values, }\DecValTok{2}\NormalTok{, }\ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{max}\NormalTok{(x) }\SpecialCharTok{{-}} \FunctionTok{min}\NormalTok{(x))}
\NormalTok{var\_diff }\OtherTok{\textless{}{-}}\NormalTok{ var\_diff[}\FunctionTok{order}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{var\_diff)]}
\NormalTok{df }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}
  \AttributeTok{variable =} \FunctionTok{melt}\NormalTok{(shap\_values)}\SpecialCharTok{$}\NormalTok{variable,}
  \AttributeTok{shap =} \FunctionTok{melt}\NormalTok{(shap\_values)}\SpecialCharTok{$}\NormalTok{value,}
  \AttributeTok{variable\_value =} \FunctionTok{melt}\NormalTok{(data)}\SpecialCharTok{$}\NormalTok{value}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{top\_vars }\OtherTok{\textless{}{-}} \FunctionTok{names}\NormalTok{(var\_diff)[}\DecValTok{1}\SpecialCharTok{:}\DecValTok{20}\NormalTok{]}
\NormalTok{df }\OtherTok{\textless{}{-}}\NormalTok{ df[df}\SpecialCharTok{$}\NormalTok{variable }\SpecialCharTok{\%in\%}\NormalTok{ top\_vars, ]}
\NormalTok{df}\SpecialCharTok{$}\NormalTok{variable }\OtherTok{\textless{}{-}} \FunctionTok{factor}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{variable, }\AttributeTok{levels =} \FunctionTok{rev}\NormalTok{(top\_vars), }\AttributeTok{labels =} \FunctionTok{rev}\NormalTok{(top\_vars))}

\NormalTok{p1 }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(df, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ shap, }\AttributeTok{y =}\NormalTok{ variable)) }\SpecialCharTok{+}
  \FunctionTok{geom\_hline}\NormalTok{(}\AttributeTok{yintercept =}\NormalTok{ top\_vars, }\AttributeTok{linetype =} \StringTok{"dotted"}\NormalTok{, }\AttributeTok{color =} \StringTok{"grey80"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_vline}\NormalTok{(}\AttributeTok{xintercept =} \DecValTok{0}\NormalTok{, }\AttributeTok{color =} \StringTok{"grey80"}\NormalTok{, }\AttributeTok{size =} \DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{fill =}\NormalTok{ variable\_value), }\AttributeTok{color =} \StringTok{"grey30"}\NormalTok{, }\AttributeTok{shape =} \DecValTok{21}\NormalTok{, }\AttributeTok{alpha =} \FloatTok{0.3}\NormalTok{, }\AttributeTok{size =} \DecValTok{2}\NormalTok{, }\AttributeTok{position =} \StringTok{"auto"}\NormalTok{, }\AttributeTok{stroke =} \FloatTok{0.1}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_fill\_gradient2}\NormalTok{(}\AttributeTok{low =} \StringTok{"\#1f77b4"}\NormalTok{, }\AttributeTok{mid =} \StringTok{"white"}\NormalTok{, }\AttributeTok{high =} \StringTok{"\#d62728"}\NormalTok{, }\AttributeTok{midpoint =} \DecValTok{50}\NormalTok{, }\AttributeTok{breaks =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{100}\NormalTok{), }\AttributeTok{labels =} \FunctionTok{c}\NormalTok{(}\StringTok{"Low"}\NormalTok{, }\StringTok{"High"}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{theme\_bw}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}
    \AttributeTok{plot.margin =}\NormalTok{ ggplot2}\SpecialCharTok{::}\FunctionTok{margin}\NormalTok{(}\FloatTok{1.5}\NormalTok{, }\DecValTok{8}\NormalTok{, }\FloatTok{1.5}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{3}\NormalTok{),}
    \AttributeTok{panel.grid.major =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{panel.grid.minor =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{strip.background =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{panel.border =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{axis.line =} \FunctionTok{element\_line}\NormalTok{(}\AttributeTok{color =} \StringTok{"black"}\NormalTok{),}
    \AttributeTok{plot.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{hjust =} \FloatTok{0.5}\NormalTok{, }\AttributeTok{size =} \DecValTok{20}\NormalTok{),}
    \AttributeTok{axis.title.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{hjust =} \FloatTok{0.5}\NormalTok{, }\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{20}\NormalTok{),}
    \AttributeTok{axis.title.y =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{20}\NormalTok{),}
    \AttributeTok{axis.text.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{17}\NormalTok{),}
    \AttributeTok{axis.text.y =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{16}\NormalTok{),}
    \AttributeTok{legend.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{20}\NormalTok{),}
    \AttributeTok{legend.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{16}\NormalTok{),}
    \AttributeTok{legend.title.align =} \FloatTok{0.5}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{guides}\NormalTok{(}
    \AttributeTok{fill =} \FunctionTok{guide\_colourbar}\NormalTok{(}\StringTok{"Variable}\SpecialCharTok{\textbackslash{}n}\StringTok{value}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{, }\AttributeTok{ticks =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{barheight =} \DecValTok{10}\NormalTok{, }\AttributeTok{barwidth =} \FloatTok{0.5}\NormalTok{),}
    \AttributeTok{color =} \StringTok{"none"}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{xlab}\NormalTok{(}\StringTok{"SHAP value}\SpecialCharTok{\textbackslash{}n}\StringTok{(variable contribution to model prediction)"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{ylab}\NormalTok{(}\StringTok{""}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{ggtitle}\NormalTok{(}\StringTok{"Melanin binding"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics[width=1\linewidth]{./figures/Supplementary Fig 7 mb} \end{center}

\hypertarget{cell-penetration-classification-4}{%
\subsection{Cell-penetration (classification)}\label{cell-penetration-classification-4}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Save train and test sets in csv format}
\FunctionTok{load}\NormalTok{(}\AttributeTok{file =} \StringTok{"./rdata/var\_reduct\_cpp\_train\_test\_splits\_y\_shuffled.RData"}\NormalTok{)}
\ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{) \{}
\NormalTok{  prefix }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"outer\_"}\NormalTok{, i)}
\NormalTok{  exp\_dir }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"/Users/renee/Downloads/cell\_penetration\_adversarial/"}\NormalTok{, prefix)}
  \FunctionTok{write.csv}\NormalTok{(outer\_splits[[i]]}\SpecialCharTok{$}\NormalTok{train, }\AttributeTok{file =} \FunctionTok{paste0}\NormalTok{(exp\_dir, }\StringTok{"/train\_set.csv"}\NormalTok{))}
  \FunctionTok{write.csv}\NormalTok{(outer\_splits[[i]]}\SpecialCharTok{$}\NormalTok{test, }\AttributeTok{file =} \FunctionTok{paste0}\NormalTok{(exp\_dir, }\StringTok{"/test\_set.csv"}\NormalTok{))}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{h2o.init(nthreads}\OperatorTok{={-}}\DecValTok{1}\NormalTok{)}

\NormalTok{dir\_path }\OperatorTok{=} \StringTok{\textquotesingle{}/Users/renee/Downloads/cell\_penetration\_adversarial\textquotesingle{}}
\NormalTok{model\_names }\OperatorTok{=}\NormalTok{ [}\StringTok{\textquotesingle{}GBM\_model\_1671047404901\_26693\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}GBM\_model\_1671047404901\_85146\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}GBM\_model\_1671047404901\_143415\textquotesingle{}}\NormalTok{, }
               \StringTok{\textquotesingle{}GBM\_model\_1671047404901\_201211\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}GBM\_model\_1671047404901\_258107\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}GBM\_model\_1671047404901\_315866\textquotesingle{}}\NormalTok{,  }
               \StringTok{\textquotesingle{}GBM\_model\_1671047404901\_373347\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}GBM\_model\_1671047404901\_432044\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}GBM\_model\_1671122685293\_29338\textquotesingle{}}\NormalTok{, }
               \StringTok{\textquotesingle{}GBM\_model\_1671122685293\_86356\textquotesingle{}}\NormalTok{]}
\NormalTok{shap\_res }\OperatorTok{=}\NormalTok{ []}
\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{10}\NormalTok{):}
    \BuiltInTok{print}\NormalTok{(}\StringTok{\textquotesingle{}Iter \textquotesingle{}} \OperatorTok{+} \BuiltInTok{str}\NormalTok{(i }\OperatorTok{+} \DecValTok{1}\NormalTok{) }\OperatorTok{+} \StringTok{\textquotesingle{}:\textquotesingle{}}\NormalTok{)}
\NormalTok{    train }\OperatorTok{=}\NormalTok{ pd.read\_csv(dir\_path }\OperatorTok{+} \StringTok{\textquotesingle{}/outer\_\textquotesingle{}} \OperatorTok{+} \BuiltInTok{str}\NormalTok{(i }\OperatorTok{+} \DecValTok{1}\NormalTok{) }\OperatorTok{+} \StringTok{\textquotesingle{}/train\_set.csv\textquotesingle{}}\NormalTok{, index\_col}\OperatorTok{=}\DecValTok{0}\NormalTok{)}
\NormalTok{    X\_train }\OperatorTok{=}\NormalTok{ train.iloc[:, :}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\NormalTok{    test }\OperatorTok{=}\NormalTok{ pd.read\_csv(dir\_path }\OperatorTok{+} \StringTok{\textquotesingle{}/outer\_\textquotesingle{}} \OperatorTok{+} \BuiltInTok{str}\NormalTok{(i }\OperatorTok{+} \DecValTok{1}\NormalTok{) }\OperatorTok{+} \StringTok{\textquotesingle{}/test\_set.csv\textquotesingle{}}\NormalTok{, index\_col}\OperatorTok{=}\DecValTok{0}\NormalTok{)}
\NormalTok{    X\_test }\OperatorTok{=}\NormalTok{ test.iloc[:, :}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\NormalTok{    model }\OperatorTok{=}\NormalTok{ h2o.load\_model(dir\_path }\OperatorTok{+} \StringTok{\textquotesingle{}/outer\_\textquotesingle{}} \OperatorTok{+} \BuiltInTok{str}\NormalTok{(i }\OperatorTok{+} \DecValTok{1}\NormalTok{) }\OperatorTok{+} \StringTok{\textquotesingle{}/\textquotesingle{}} \OperatorTok{+}\NormalTok{ model\_names[i])}
    \KeywordTok{def}\NormalTok{ model\_predict\_(data):}
\NormalTok{        data }\OperatorTok{=}\NormalTok{ pd.DataFrame(data, columns}\OperatorTok{=}\NormalTok{X\_train.columns)}
\NormalTok{        h2o\_data }\OperatorTok{=}\NormalTok{ h2o.H2OFrame(data)}
\NormalTok{        res }\OperatorTok{=}\NormalTok{ model.predict(h2o\_data)}
\NormalTok{        res }\OperatorTok{=}\NormalTok{ res.as\_data\_frame().iloc[:,}\DecValTok{2}\NormalTok{]}
        \ControlFlowTok{return}\NormalTok{(res)}
\NormalTok{    np.random.seed(}\DecValTok{1}\NormalTok{)}
\NormalTok{    X\_train\_ }\OperatorTok{=}\NormalTok{ X\_train.iloc[np.random.choice(X\_train.shape[}\DecValTok{0}\NormalTok{], }\DecValTok{100}\NormalTok{, replace}\OperatorTok{=}\VariableTok{False}\NormalTok{), :]}
\NormalTok{    explainer }\OperatorTok{=}\NormalTok{ shap.KernelExplainer(model\_predict\_, X\_train\_, link}\OperatorTok{=}\StringTok{\textquotesingle{}identity\textquotesingle{}}\NormalTok{)}
\NormalTok{    shap\_values }\OperatorTok{=}\NormalTok{ explainer.shap\_values(X\_test, nsamples}\OperatorTok{=}\DecValTok{1000}\NormalTok{)}
\NormalTok{    shap\_res.append(shap\_values)}
\NormalTok{    h2o.remove\_all()}

\NormalTok{shap\_res }\OperatorTok{=}\NormalTok{ pd.DataFrame(np.vstack(shap\_res), columns}\OperatorTok{=}\NormalTok{X\_train.columns)}
\NormalTok{shap\_res.to\_csv(}\StringTok{\textquotesingle{}./other\_data/cpp\_ad\_shap\_values\_cv\_data\_sets.csv\textquotesingle{}}\NormalTok{, index}\OperatorTok{=}\VariableTok{False}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{load}\NormalTok{(}\AttributeTok{file =} \StringTok{"./rdata/var\_reduct\_cpp\_train\_test\_splits\_y\_shuffled.RData"}\NormalTok{)}
\NormalTok{data }\OtherTok{\textless{}{-}} \FunctionTok{do.call}\NormalTok{(rbind, }\FunctionTok{lapply}\NormalTok{(outer\_splits, }\ControlFlowTok{function}\NormalTok{(x) x}\SpecialCharTok{$}\NormalTok{test[}\SpecialCharTok{{-}}\FunctionTok{ncol}\NormalTok{(cpp\_data)]))}
\NormalTok{data }\OtherTok{\textless{}{-}} \FunctionTok{apply}\NormalTok{(data, }\DecValTok{2}\NormalTok{, }\ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{rank}\NormalTok{(x))}
\NormalTok{data }\OtherTok{\textless{}{-}} \FunctionTok{apply}\NormalTok{(data, }\DecValTok{2}\NormalTok{, }\ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{rescale}\NormalTok{(x, }\AttributeTok{to =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{100}\NormalTok{)))}
\NormalTok{shap\_values }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\StringTok{"./other\_data/cpp\_ad\_shap\_values\_cv\_data\_sets.csv"}\NormalTok{, }\AttributeTok{check.names =} \ConstantTok{FALSE}\NormalTok{) }\SpecialCharTok{*} \DecValTok{100}

\NormalTok{var\_diff }\OtherTok{\textless{}{-}} \FunctionTok{apply}\NormalTok{(shap\_values, }\DecValTok{2}\NormalTok{, }\ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{max}\NormalTok{(x) }\SpecialCharTok{{-}} \FunctionTok{min}\NormalTok{(x))}
\NormalTok{var\_diff }\OtherTok{\textless{}{-}}\NormalTok{ var\_diff[}\FunctionTok{order}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{var\_diff)]}
\NormalTok{df }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}
  \AttributeTok{variable =} \FunctionTok{melt}\NormalTok{(shap\_values)}\SpecialCharTok{$}\NormalTok{variable,}
  \AttributeTok{shap =} \FunctionTok{melt}\NormalTok{(shap\_values)}\SpecialCharTok{$}\NormalTok{value,}
  \AttributeTok{variable\_value =} \FunctionTok{melt}\NormalTok{(data)}\SpecialCharTok{$}\NormalTok{value}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{top\_vars }\OtherTok{\textless{}{-}} \FunctionTok{names}\NormalTok{(var\_diff)[}\DecValTok{1}\SpecialCharTok{:}\DecValTok{11}\NormalTok{]}
\NormalTok{df }\OtherTok{\textless{}{-}}\NormalTok{ df[df}\SpecialCharTok{$}\NormalTok{variable }\SpecialCharTok{\%in\%}\NormalTok{ top\_vars, ]}
\NormalTok{df}\SpecialCharTok{$}\NormalTok{variable }\OtherTok{\textless{}{-}} \FunctionTok{factor}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{variable, }\AttributeTok{levels =} \FunctionTok{rev}\NormalTok{(top\_vars), }\AttributeTok{labels =} \FunctionTok{rev}\NormalTok{(top\_vars))}

\NormalTok{p2 }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(df, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ shap, }\AttributeTok{y =}\NormalTok{ variable)) }\SpecialCharTok{+}
  \FunctionTok{geom\_hline}\NormalTok{(}\AttributeTok{yintercept =}\NormalTok{ top\_vars, }\AttributeTok{linetype =} \StringTok{"dotted"}\NormalTok{, }\AttributeTok{color =} \StringTok{"grey80"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_vline}\NormalTok{(}\AttributeTok{xintercept =} \DecValTok{0}\NormalTok{, }\AttributeTok{color =} \StringTok{"grey80"}\NormalTok{, }\AttributeTok{size =} \DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{fill =}\NormalTok{ variable\_value), }\AttributeTok{color =} \StringTok{"grey30"}\NormalTok{, }\AttributeTok{shape =} \DecValTok{21}\NormalTok{, }\AttributeTok{alpha =} \FloatTok{0.5}\NormalTok{, }\AttributeTok{size =} \DecValTok{2}\NormalTok{, }\AttributeTok{position =} \StringTok{"auto"}\NormalTok{, }\AttributeTok{stroke =} \FloatTok{0.1}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_fill\_gradient2}\NormalTok{(}\AttributeTok{low =} \StringTok{"\#1f77b4"}\NormalTok{, }\AttributeTok{mid =} \StringTok{"white"}\NormalTok{, }\AttributeTok{high =} \StringTok{"\#d62728"}\NormalTok{, }\AttributeTok{midpoint =} \DecValTok{50}\NormalTok{, }\AttributeTok{breaks =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{100}\NormalTok{), }\AttributeTok{labels =} \FunctionTok{c}\NormalTok{(}\StringTok{"Low"}\NormalTok{, }\StringTok{"High"}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{theme\_bw}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}
    \AttributeTok{plot.margin =}\NormalTok{ ggplot2}\SpecialCharTok{::}\FunctionTok{margin}\NormalTok{(}\FloatTok{1.5}\NormalTok{, }\DecValTok{8}\NormalTok{, }\FloatTok{1.5}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{3}\NormalTok{),}
    \AttributeTok{panel.grid.major =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{panel.grid.minor =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{strip.background =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{panel.border =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{axis.line =} \FunctionTok{element\_line}\NormalTok{(}\AttributeTok{color =} \StringTok{"black"}\NormalTok{),}
    \AttributeTok{plot.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{hjust =} \FloatTok{0.5}\NormalTok{, }\AttributeTok{size =} \DecValTok{20}\NormalTok{),}
    \AttributeTok{axis.title.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{hjust =} \FloatTok{0.5}\NormalTok{, }\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{20}\NormalTok{),}
    \AttributeTok{axis.title.y =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{20}\NormalTok{),}
    \AttributeTok{axis.text.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{17}\NormalTok{),}
    \AttributeTok{axis.text.y =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{16}\NormalTok{),}
    \AttributeTok{legend.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{20}\NormalTok{),}
    \AttributeTok{legend.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{16}\NormalTok{),}
    \AttributeTok{legend.title.align =} \FloatTok{0.5}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{guides}\NormalTok{(}
    \AttributeTok{fill =} \FunctionTok{guide\_colourbar}\NormalTok{(}\StringTok{"Variable}\SpecialCharTok{\textbackslash{}n}\StringTok{value}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{, }\AttributeTok{ticks =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{barheight =} \DecValTok{10}\NormalTok{, }\AttributeTok{barwidth =} \FloatTok{0.5}\NormalTok{),}
    \AttributeTok{color =} \StringTok{"none"}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{xlab}\NormalTok{(}\StringTok{"SHAP value}\SpecialCharTok{\textbackslash{}n}\StringTok{(variable contribution to model prediction)"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{ylab}\NormalTok{(}\StringTok{""}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{ggtitle}\NormalTok{(}\StringTok{"Cell{-}penetration"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics[width=1\linewidth]{./figures/Supplementary Fig 7 cpp} \end{center}

\hypertarget{toxicity-classification-4}{%
\subsection{Toxicity (classification)}\label{toxicity-classification-4}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Save train and test sets in csv format}
\FunctionTok{load}\NormalTok{(}\AttributeTok{file =} \StringTok{"./rdata/var\_reduct\_tx\_train\_test\_splits\_y\_shuffled.RData"}\NormalTok{)}
\ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{) \{}
\NormalTok{  prefix }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"outer\_"}\NormalTok{, i)}
\NormalTok{  exp\_dir }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"/Users/renee/Downloads/toxicity\_adversarial/"}\NormalTok{, prefix)}
  \FunctionTok{write.csv}\NormalTok{(outer\_splits[[i]]}\SpecialCharTok{$}\NormalTok{train, }\AttributeTok{file =} \FunctionTok{paste0}\NormalTok{(exp\_dir, }\StringTok{"/train\_set.csv"}\NormalTok{))}
  \FunctionTok{write.csv}\NormalTok{(outer\_splits[[i]]}\SpecialCharTok{$}\NormalTok{test, }\AttributeTok{file =} \FunctionTok{paste0}\NormalTok{(exp\_dir, }\StringTok{"/test\_set.csv"}\NormalTok{))}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{h2o.init(nthreads}\OperatorTok{={-}}\DecValTok{1}\NormalTok{)}

\NormalTok{dir\_path }\OperatorTok{=} \StringTok{\textquotesingle{}/Users/renee/Downloads/toxicity\_adversarial\textquotesingle{}}
\NormalTok{model\_names }\OperatorTok{=}\NormalTok{ [}\StringTok{\textquotesingle{}superlearner\_iter\_5\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}superlearner\_iter\_6\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}superlearner\_iter\_5\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}superlearner\_iter\_7\textquotesingle{}}\NormalTok{,}
               \StringTok{\textquotesingle{}superlearner\_iter\_4\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}superlearner\_iter\_6\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}superlearner\_iter\_6\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}superlearner\_iter\_5\textquotesingle{}}\NormalTok{,}
               \StringTok{\textquotesingle{}superlearner\_iter\_4\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}superlearner\_iter\_5\textquotesingle{}}\NormalTok{]}
\NormalTok{shap\_res }\OperatorTok{=}\NormalTok{ []}
\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{10}\NormalTok{):}
    \BuiltInTok{print}\NormalTok{(}\StringTok{\textquotesingle{}Iter \textquotesingle{}} \OperatorTok{+} \BuiltInTok{str}\NormalTok{(i }\OperatorTok{+} \DecValTok{1}\NormalTok{) }\OperatorTok{+} \StringTok{\textquotesingle{}:\textquotesingle{}}\NormalTok{)}
\NormalTok{    train }\OperatorTok{=}\NormalTok{ pd.read\_csv(dir\_path }\OperatorTok{+} \StringTok{\textquotesingle{}/outer\_\textquotesingle{}} \OperatorTok{+} \BuiltInTok{str}\NormalTok{(i }\OperatorTok{+} \DecValTok{1}\NormalTok{) }\OperatorTok{+} \StringTok{\textquotesingle{}/train\_set.csv\textquotesingle{}}\NormalTok{, index\_col}\OperatorTok{=}\DecValTok{0}\NormalTok{)}
\NormalTok{    X\_train }\OperatorTok{=}\NormalTok{ train.iloc[:, :}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\NormalTok{    test }\OperatorTok{=}\NormalTok{ pd.read\_csv(dir\_path }\OperatorTok{+} \StringTok{\textquotesingle{}/outer\_\textquotesingle{}} \OperatorTok{+} \BuiltInTok{str}\NormalTok{(i }\OperatorTok{+} \DecValTok{1}\NormalTok{) }\OperatorTok{+} \StringTok{\textquotesingle{}/test\_set.csv\textquotesingle{}}\NormalTok{, index\_col}\OperatorTok{=}\DecValTok{0}\NormalTok{)}
\NormalTok{    X\_test }\OperatorTok{=}\NormalTok{ test.iloc[:, :}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\NormalTok{    model }\OperatorTok{=}\NormalTok{ h2o.load\_model(dir\_path }\OperatorTok{+} \StringTok{\textquotesingle{}/outer\_\textquotesingle{}} \OperatorTok{+} \BuiltInTok{str}\NormalTok{(i }\OperatorTok{+} \DecValTok{1}\NormalTok{) }\OperatorTok{+} \StringTok{\textquotesingle{}/\textquotesingle{}} \OperatorTok{+}\NormalTok{ model\_names[i])}
    \KeywordTok{def}\NormalTok{ model\_predict\_(data):}
\NormalTok{        data }\OperatorTok{=}\NormalTok{ pd.DataFrame(data, columns}\OperatorTok{=}\NormalTok{X\_train.columns)}
\NormalTok{        h2o\_data }\OperatorTok{=}\NormalTok{ h2o.H2OFrame(data)}
\NormalTok{        res }\OperatorTok{=}\NormalTok{ model.predict(h2o\_data)}
\NormalTok{        res }\OperatorTok{=}\NormalTok{ res.as\_data\_frame().iloc[:,}\DecValTok{2}\NormalTok{] }\CommentTok{\# 0:toxic; 1:non{-}toxic }
        \ControlFlowTok{return}\NormalTok{(res)}
\NormalTok{    np.random.seed(}\DecValTok{1}\NormalTok{)}
\NormalTok{    X\_train\_ }\OperatorTok{=}\NormalTok{ X\_train.iloc[np.random.choice(X\_train.shape[}\DecValTok{0}\NormalTok{], }\DecValTok{100}\NormalTok{, replace}\OperatorTok{=}\VariableTok{False}\NormalTok{), :]}
\NormalTok{    explainer }\OperatorTok{=}\NormalTok{ shap.KernelExplainer(model\_predict\_, X\_train\_, link}\OperatorTok{=}\StringTok{\textquotesingle{}identity\textquotesingle{}}\NormalTok{)}
\NormalTok{    shap\_values }\OperatorTok{=}\NormalTok{ explainer.shap\_values(X\_test, nsamples}\OperatorTok{=}\DecValTok{1000}\NormalTok{)}
\NormalTok{    shap\_res.append(shap\_values)}
\NormalTok{    h2o.remove\_all()}

\NormalTok{shap\_res }\OperatorTok{=}\NormalTok{ pd.DataFrame(np.vstack(shap\_res), columns}\OperatorTok{=}\NormalTok{X\_train.columns)}
\NormalTok{shap\_res.to\_csv(}\StringTok{\textquotesingle{}./other\_data/tx\_ad\_shap\_values\_cv\_data\_sets.csv\textquotesingle{}}\NormalTok{, index}\OperatorTok{=}\VariableTok{False}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{load}\NormalTok{(}\AttributeTok{file =} \StringTok{"./rdata/var\_reduct\_tx\_train\_test\_splits\_y\_shuffled.RData"}\NormalTok{)}
\NormalTok{data }\OtherTok{\textless{}{-}} \FunctionTok{do.call}\NormalTok{(rbind, }\FunctionTok{lapply}\NormalTok{(outer\_splits, }\ControlFlowTok{function}\NormalTok{(x) x}\SpecialCharTok{$}\NormalTok{test[}\SpecialCharTok{{-}}\FunctionTok{ncol}\NormalTok{(tx\_data)]))}
\NormalTok{data }\OtherTok{\textless{}{-}} \FunctionTok{apply}\NormalTok{(data, }\DecValTok{2}\NormalTok{, }\ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{rank}\NormalTok{(x))}
\NormalTok{data }\OtherTok{\textless{}{-}} \FunctionTok{apply}\NormalTok{(data, }\DecValTok{2}\NormalTok{, }\ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{rescale}\NormalTok{(x, }\AttributeTok{to =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{100}\NormalTok{)))}
\NormalTok{shap\_values }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\StringTok{"./other\_data/tx\_ad\_shap\_values\_cv\_data\_sets.csv"}\NormalTok{, }\AttributeTok{check.names =} \ConstantTok{FALSE}\NormalTok{) }\SpecialCharTok{*} \DecValTok{100}

\FunctionTok{set.seed}\NormalTok{(}\DecValTok{12}\NormalTok{)}
\NormalTok{ind }\OtherTok{\textless{}{-}} \FunctionTok{sample}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(data), }\DecValTok{2500}\NormalTok{)}
\NormalTok{data }\OtherTok{\textless{}{-}}\NormalTok{ data[ind, ]}
\NormalTok{shap\_values }\OtherTok{\textless{}{-}}\NormalTok{ shap\_values[ind, ]}

\NormalTok{var\_diff }\OtherTok{\textless{}{-}} \FunctionTok{apply}\NormalTok{(shap\_values, }\DecValTok{2}\NormalTok{, }\ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{max}\NormalTok{(x) }\SpecialCharTok{{-}} \FunctionTok{min}\NormalTok{(x))}
\NormalTok{var\_diff }\OtherTok{\textless{}{-}}\NormalTok{ var\_diff[}\FunctionTok{order}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{var\_diff)]}
\NormalTok{df }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}
  \AttributeTok{variable =} \FunctionTok{melt}\NormalTok{(shap\_values)}\SpecialCharTok{$}\NormalTok{variable,}
  \AttributeTok{shap =} \FunctionTok{melt}\NormalTok{(shap\_values)}\SpecialCharTok{$}\NormalTok{value,}
  \AttributeTok{variable\_value =} \FunctionTok{melt}\NormalTok{(data)}\SpecialCharTok{$}\NormalTok{value}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{top\_vars }\OtherTok{\textless{}{-}} \FunctionTok{names}\NormalTok{(var\_diff)[}\DecValTok{1}\SpecialCharTok{:}\DecValTok{20}\NormalTok{]}
\NormalTok{df }\OtherTok{\textless{}{-}}\NormalTok{ df[df}\SpecialCharTok{$}\NormalTok{variable }\SpecialCharTok{\%in\%}\NormalTok{ top\_vars, ]}
\NormalTok{df}\SpecialCharTok{$}\NormalTok{variable }\OtherTok{\textless{}{-}} \FunctionTok{factor}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{variable, }\AttributeTok{levels =} \FunctionTok{rev}\NormalTok{(top\_vars), }\AttributeTok{labels =} \FunctionTok{rev}\NormalTok{(top\_vars))}

\NormalTok{p3 }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(df, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ shap, }\AttributeTok{y =}\NormalTok{ variable)) }\SpecialCharTok{+}
  \FunctionTok{geom\_hline}\NormalTok{(}\AttributeTok{yintercept =}\NormalTok{ top\_vars, }\AttributeTok{linetype =} \StringTok{"dotted"}\NormalTok{, }\AttributeTok{color =} \StringTok{"grey80"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_vline}\NormalTok{(}\AttributeTok{xintercept =} \DecValTok{0}\NormalTok{, }\AttributeTok{color =} \StringTok{"grey80"}\NormalTok{, }\AttributeTok{size =} \DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{fill =}\NormalTok{ variable\_value), }\AttributeTok{color =} \StringTok{"grey30"}\NormalTok{, }\AttributeTok{shape =} \DecValTok{21}\NormalTok{, }\AttributeTok{alpha =} \FloatTok{0.3}\NormalTok{, }\AttributeTok{size =} \DecValTok{2}\NormalTok{, }\AttributeTok{position =} \StringTok{"auto"}\NormalTok{, }\AttributeTok{stroke =} \FloatTok{0.1}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_fill\_gradient2}\NormalTok{(}\AttributeTok{low =} \StringTok{"\#1f77b4"}\NormalTok{, }\AttributeTok{mid =} \StringTok{"white"}\NormalTok{, }\AttributeTok{high =} \StringTok{"\#d62728"}\NormalTok{, }\AttributeTok{midpoint =} \DecValTok{50}\NormalTok{, }\AttributeTok{breaks =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{100}\NormalTok{), }\AttributeTok{labels =} \FunctionTok{c}\NormalTok{(}\StringTok{"Low"}\NormalTok{, }\StringTok{"High"}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{theme\_bw}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}
    \AttributeTok{plot.margin =}\NormalTok{ ggplot2}\SpecialCharTok{::}\FunctionTok{margin}\NormalTok{(}\FloatTok{1.5}\NormalTok{, }\DecValTok{8}\NormalTok{, }\FloatTok{1.5}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{3}\NormalTok{),}
    \AttributeTok{panel.grid.major =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{panel.grid.minor =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{strip.background =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{panel.border =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{axis.line =} \FunctionTok{element\_line}\NormalTok{(}\AttributeTok{color =} \StringTok{"black"}\NormalTok{),}
    \AttributeTok{plot.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{hjust =} \FloatTok{0.5}\NormalTok{, }\AttributeTok{size =} \DecValTok{20}\NormalTok{),}
    \AttributeTok{axis.title.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{hjust =} \FloatTok{0.5}\NormalTok{, }\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{20}\NormalTok{),}
    \AttributeTok{axis.title.y =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{20}\NormalTok{),}
    \AttributeTok{axis.text.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{17}\NormalTok{),}
    \AttributeTok{axis.text.y =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{16}\NormalTok{),}
    \AttributeTok{legend.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{20}\NormalTok{),}
    \AttributeTok{legend.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{colour =} \StringTok{"black"}\NormalTok{, }\AttributeTok{size =} \DecValTok{16}\NormalTok{),}
    \AttributeTok{legend.title.align =} \FloatTok{0.5}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{guides}\NormalTok{(}
    \AttributeTok{fill =} \FunctionTok{guide\_colourbar}\NormalTok{(}\StringTok{"Variable}\SpecialCharTok{\textbackslash{}n}\StringTok{value}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{, }\AttributeTok{ticks =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{barheight =} \DecValTok{10}\NormalTok{, }\AttributeTok{barwidth =} \FloatTok{0.5}\NormalTok{),}
    \AttributeTok{color =} \StringTok{"none"}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{xlab}\NormalTok{(}\StringTok{"SHAP value}\SpecialCharTok{\textbackslash{}n}\StringTok{(variable contribution to model prediction)"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{ylab}\NormalTok{(}\StringTok{""}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{ggtitle}\NormalTok{(}\StringTok{"Non{-}toxic"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics[width=1\linewidth]{./figures/Supplementary Fig 7 tx} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sessionInfo}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## R version 4.2.2 (2022-10-31)
## Platform: x86_64-apple-darwin17.0 (64-bit)
## Running under: macOS Big Sur ... 10.16
## 
## Matrix products: default
## BLAS:   /Library/Frameworks/R.framework/Versions/4.2/Resources/lib/libRblas.0.dylib
## LAPACK: /Library/Frameworks/R.framework/Versions/4.2/Resources/lib/libRlapack.dylib
## 
## locale:
## [1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8
## 
## attached base packages:
## [1] stats     graphics  grDevices utils     datasets  methods   base     
## 
## other attached packages:
##  [1] reticulate_1.25 ggforce_0.3.4   ggplot2_3.3.6   reshape2_1.4.4 
##  [5] DT_0.24         digest_0.6.29   stringr_1.4.1   rlist_0.4.6.2  
##  [9] enrichvs_0.0.5  scales_1.2.1    mltools_0.3.5   MLmetrics_1.1.1
## [13] h2o_3.38.0.2   
## 
## loaded via a namespace (and not attached):
##  [1] Rcpp_1.0.9        here_1.0.1        lattice_0.20-45   ps_1.7.1         
##  [5] png_0.1-7         rprojroot_2.0.3   assertthat_0.2.1  utf8_1.2.2       
##  [9] R6_2.5.1          plyr_1.8.7        evaluate_0.16     highr_0.9        
## [13] pillar_1.8.1      rlang_1.0.4       rstudioapi_0.14   data.table_1.14.2
## [17] callr_3.7.2       jquerylib_0.1.4   R.utils_2.12.0    R.oo_1.25.0      
## [21] Matrix_1.5-1      rmarkdown_2.16    styler_1.8.0      webshot_0.5.4    
## [25] htmlwidgets_1.5.4 RCurl_1.98-1.8    polyclip_1.10-0   munsell_0.5.0    
## [29] compiler_4.2.2    xfun_0.32         pkgconfig_2.0.3   htmltools_0.5.3  
## [33] tidyselect_1.1.2  tibble_3.1.8      bookdown_0.28     codetools_0.2-18 
## [37] fansi_1.0.3       dplyr_1.0.9       withr_2.5.0       MASS_7.3-58.1    
## [41] bitops_1.0-7      R.methodsS3_1.8.2 grid_4.2.2        jsonlite_1.8.0   
## [45] gtable_0.3.0      lifecycle_1.0.1   DBI_1.1.3         magrittr_2.0.3   
## [49] cachem_1.0.6      cli_3.3.0         stringi_1.7.8     farver_2.1.1     
## [53] bslib_0.4.0       generics_0.1.3    vctrs_0.4.1       tools_4.2.2      
## [57] R.cache_0.16.0    glue_1.6.2        tweenr_2.0.1      purrr_0.3.4      
## [61] crosstalk_1.2.0   processx_3.7.0    fastmap_1.1.0     yaml_2.3.5       
## [65] colorspace_2.0-3  knitr_1.40        sass_0.4.2
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{session\_info.show()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## -----
## h2o                 3.38.0.2
## matplotlib          3.6.2
## numpy               1.23.5
## pandas              1.5.2
## session_info        1.0.0
## shap                0.41.0
## -----
## Python 3.8.15 | packaged by conda-forge | (default, Nov 22 2022, 09:04:40) [Clang 14.0.6 ]
## macOS-10.16-x86_64-i386-64bit
## -----
## Session information updated at 2023-03-12 23:20
\end{verbatim}

\hypertarget{06_small_data_set_demo}{%
\chapter{Small data set demo}\label{06_small_data_set_demo}}

\hypertarget{setup}{%
\section{Setup}\label{setup}}

\hypertarget{load-libraries}{%
\subsection{Load libraries}\label{load-libraries}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(ranger)}
\FunctionTok{library}\NormalTok{(rlist)}
\FunctionTok{library}\NormalTok{(h2o)}
\FunctionTok{h2o.init}\NormalTok{(}\AttributeTok{nthreads =} \SpecialCharTok{{-}}\DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{aic-functions-1}{%
\subsection{AIC functions}\label{aic-functions-1}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\#\textquotesingle{} Mean squared error function}
\CommentTok{\#\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @param y\_true a factor vector representing true values.}
\CommentTok{\#\textquotesingle{} @param y\_pred a numeric vector or a matrix of predicted values.}
\CommentTok{\#\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @return MSE}
\CommentTok{\#\textquotesingle{}}
\NormalTok{mse }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(y\_true, y\_pred) \{}
  \FunctionTok{return}\NormalTok{(}\FunctionTok{mean}\NormalTok{((y\_true }\SpecialCharTok{{-}}\NormalTok{ y\_pred)}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{))}
\NormalTok{\}}

\CommentTok{\#\textquotesingle{} Regression AIC}
\CommentTok{\#\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @param y\_true a factor vector representing true values.}
\CommentTok{\#\textquotesingle{} @param y\_pred a numeric vector or a matrix of predicted values.}
\CommentTok{\#\textquotesingle{} @param k number of parameters/variables.}
\CommentTok{\#\textquotesingle{} @param eps a very small value to avoid negative infinitives generated by log(p=0).}
\CommentTok{\#\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @return AIC}
\CommentTok{\#\textquotesingle{}}
\NormalTok{aic\_reg }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(y\_true, y\_pred, k, }\AttributeTok{eps =} \FloatTok{1e{-}15}\NormalTok{) \{}
\NormalTok{  mserr }\OtherTok{\textless{}{-}} \FunctionTok{mse}\NormalTok{(y\_true, y\_pred)}
  \ControlFlowTok{if}\NormalTok{ (mserr }\SpecialCharTok{==} \DecValTok{0}\NormalTok{) mserr }\OtherTok{\textless{}{-}}\NormalTok{ eps}
\NormalTok{  AIC }\OtherTok{\textless{}{-}} \FunctionTok{length}\NormalTok{(y\_true) }\SpecialCharTok{*} \FunctionTok{log}\NormalTok{(mserr) }\SpecialCharTok{+} \DecValTok{2} \SpecialCharTok{*}\NormalTok{ k}
  \FunctionTok{return}\NormalTok{(AIC)}
\NormalTok{\}}

\CommentTok{\#\textquotesingle{} Cross{-}entropy function}
\CommentTok{\#\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @param y\_true a factor vector representing true labels.}
\CommentTok{\#\textquotesingle{} @param y\_pred a numeric vector (probabilities of the second class/factor level)}
\CommentTok{\#\textquotesingle{} or a matrix of predicted probabilities.}
\CommentTok{\#\textquotesingle{} @param eps a very small value to avoid negative infinitives generated by log(p=0).}
\CommentTok{\#\textquotesingle{} If the function returns NaN, then increasing eps may solve the issue. Alternatively,}
\CommentTok{\#\textquotesingle{} As NaN is usually generated in the case of p = 1 {-} eps = 1, resulting in log(1 {-} p)}
\CommentTok{\#\textquotesingle{} = log(0) from binary cross{-}entropy, the user can pass prediction values as a matrix}
\CommentTok{\#\textquotesingle{} to calculate categorical cross{-}entropy instead.}
\CommentTok{\#\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @return H, cross{-}entropy (mean loss per sample)}
\CommentTok{\#\textquotesingle{}}
\NormalTok{crossEntropy }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(y\_true, y\_pred, }\AttributeTok{eps =} \FloatTok{1e{-}15}\NormalTok{) \{}
  \FunctionTok{stopifnot}\NormalTok{(}\FunctionTok{is.factor}\NormalTok{(y\_true))}
\NormalTok{  y\_pred }\OtherTok{\textless{}{-}} \FunctionTok{pmax}\NormalTok{(}\FunctionTok{pmin}\NormalTok{(y\_pred, }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ eps), eps)}
\NormalTok{  n\_levels }\OtherTok{\textless{}{-}} \FunctionTok{nlevels}\NormalTok{(y\_true)}
\NormalTok{  H }\OtherTok{\textless{}{-}} \ConstantTok{NULL}
  \CommentTok{\# Binary classification}
  \ControlFlowTok{if}\NormalTok{ (n\_levels }\SpecialCharTok{==} \DecValTok{2} \SpecialCharTok{\&\&} \FunctionTok{is.vector}\NormalTok{(y\_pred)) \{}
\NormalTok{    y\_true }\OtherTok{\textless{}{-}} \FunctionTok{as.numeric}\NormalTok{(y\_true }\SpecialCharTok{==} \FunctionTok{levels}\NormalTok{(y\_true)[}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{])}
\NormalTok{    H }\OtherTok{\textless{}{-}} \SpecialCharTok{{-}}\FunctionTok{mean}\NormalTok{(y\_true }\SpecialCharTok{*} \FunctionTok{log2}\NormalTok{(y\_pred) }\SpecialCharTok{+}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ y\_true) }\SpecialCharTok{*} \FunctionTok{log2}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ y\_pred))}
\NormalTok{  \}}
  \CommentTok{\# Multi{-}class classification}
  \ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (n\_levels }\SpecialCharTok{==} \FunctionTok{ncol}\NormalTok{(y\_pred)) \{}
\NormalTok{    y\_true }\OtherTok{\textless{}{-}} \FunctionTok{as.numeric}\NormalTok{(y\_true)}
\NormalTok{    y\_true\_encoded }\OtherTok{\textless{}{-}} \FunctionTok{t}\NormalTok{(}\FunctionTok{sapply}\NormalTok{(y\_true, }\ControlFlowTok{function}\NormalTok{(x) \{}
\NormalTok{      tmp }\OtherTok{\textless{}{-}} \FunctionTok{rep}\NormalTok{(}\DecValTok{0}\NormalTok{, n\_levels)}
\NormalTok{      tmp[x] }\OtherTok{\textless{}{-}} \DecValTok{1}
      \FunctionTok{return}\NormalTok{(tmp)}
\NormalTok{    \}))}
\NormalTok{    H }\OtherTok{\textless{}{-}} \SpecialCharTok{{-}}\FunctionTok{mean}\NormalTok{(}\FunctionTok{sapply}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(y\_true\_encoded), }\ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{sum}\NormalTok{(y\_true\_encoded[x, ] }\SpecialCharTok{*} \FunctionTok{log2}\NormalTok{(y\_pred[x, ]))))}
\NormalTok{  \}}
  \FunctionTok{return}\NormalTok{(H)}
\NormalTok{\}}

\CommentTok{\#\textquotesingle{} Classification AIC}
\CommentTok{\#\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @param y\_true a factor vector representing true labels.}
\CommentTok{\#\textquotesingle{} @param y\_pred a numeric vector or a matrix of predicted probabilities.}
\CommentTok{\#\textquotesingle{} @param k number of parameters/variables.}
\CommentTok{\#\textquotesingle{} @param ... other parameters to be passed to \textasciigrave{}crossEntropy()\textasciigrave{}}
\CommentTok{\#\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @return AIC}
\CommentTok{\#\textquotesingle{}}
\NormalTok{aic\_clf }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(y\_true, y\_pred, k, ...) \{}
\NormalTok{  H }\OtherTok{\textless{}{-}} \FunctionTok{crossEntropy}\NormalTok{(y\_true, y\_pred, ...)}
\NormalTok{  AIC }\OtherTok{\textless{}{-}} \DecValTok{2} \SpecialCharTok{*} \FunctionTok{log}\NormalTok{(}\DecValTok{2}\NormalTok{) }\SpecialCharTok{*} \FunctionTok{length}\NormalTok{(y\_true) }\SpecialCharTok{*}\NormalTok{ H }\SpecialCharTok{+} \DecValTok{2} \SpecialCharTok{*}\NormalTok{ k}
  \FunctionTok{return}\NormalTok{(AIC)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\hypertarget{model-parameters}{%
\subsection{Model parameters}\label{model-parameters}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# DeepLearning Grid 1}
\NormalTok{deeplearning\_params\_1 }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}
  \AttributeTok{activation =} \StringTok{"RectifierWithDropout"}\NormalTok{,}
  \AttributeTok{epochs =} \DecValTok{10000}\NormalTok{, }\CommentTok{\# early stopping}
  \AttributeTok{epsilon =} \FunctionTok{c}\NormalTok{(}\FloatTok{1e{-}6}\NormalTok{, }\FloatTok{1e{-}7}\NormalTok{, }\FloatTok{1e{-}8}\NormalTok{, }\FloatTok{1e{-}9}\NormalTok{),}
  \AttributeTok{hidden =} \FunctionTok{list}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{50}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\DecValTok{200}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\DecValTok{500}\NormalTok{)),}
  \AttributeTok{hidden\_dropout\_ratios =} \FunctionTok{list}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\FloatTok{0.1}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\FloatTok{0.2}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\FloatTok{0.3}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\FloatTok{0.4}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\FloatTok{0.5}\NormalTok{)),}
  \AttributeTok{input\_dropout\_ratio =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FloatTok{0.05}\NormalTok{, }\FloatTok{0.1}\NormalTok{, }\FloatTok{0.15}\NormalTok{, }\FloatTok{0.2}\NormalTok{),}
  \AttributeTok{rho =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.9}\NormalTok{, }\FloatTok{0.95}\NormalTok{, }\FloatTok{0.99}\NormalTok{)}
\NormalTok{)}
\CommentTok{\# DeepLearning Grid 2}
\NormalTok{deeplearning\_params\_2 }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}
  \AttributeTok{activation =} \StringTok{"RectifierWithDropout"}\NormalTok{,}
  \AttributeTok{epochs =} \DecValTok{10000}\NormalTok{, }\CommentTok{\# early stopping}
  \AttributeTok{epsilon =} \FunctionTok{c}\NormalTok{(}\FloatTok{1e{-}6}\NormalTok{, }\FloatTok{1e{-}7}\NormalTok{, }\FloatTok{1e{-}8}\NormalTok{, }\FloatTok{1e{-}9}\NormalTok{),}
  \AttributeTok{hidden =} \FunctionTok{list}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{50}\NormalTok{, }\DecValTok{50}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\DecValTok{200}\NormalTok{, }\DecValTok{200}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\DecValTok{500}\NormalTok{, }\DecValTok{500}\NormalTok{)),}
  \AttributeTok{hidden\_dropout\_ratios =} \FunctionTok{list}\NormalTok{(}
    \FunctionTok{c}\NormalTok{(}\FloatTok{0.1}\NormalTok{, }\FloatTok{0.1}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\FloatTok{0.2}\NormalTok{, }\FloatTok{0.2}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\FloatTok{0.3}\NormalTok{, }\FloatTok{0.3}\NormalTok{),}
    \FunctionTok{c}\NormalTok{(}\FloatTok{0.4}\NormalTok{, }\FloatTok{0.4}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\FloatTok{0.5}\NormalTok{, }\FloatTok{0.5}\NormalTok{)}
\NormalTok{  ),}
  \AttributeTok{input\_dropout\_ratio =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FloatTok{0.05}\NormalTok{, }\FloatTok{0.1}\NormalTok{, }\FloatTok{0.15}\NormalTok{, }\FloatTok{0.2}\NormalTok{),}
  \AttributeTok{rho =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.9}\NormalTok{, }\FloatTok{0.95}\NormalTok{, }\FloatTok{0.99}\NormalTok{)}
\NormalTok{)}
\CommentTok{\# DeepLearning Grid 3}
\NormalTok{deeplearning\_params\_3 }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}
  \AttributeTok{activation =} \StringTok{"RectifierWithDropout"}\NormalTok{,}
  \AttributeTok{epochs =} \DecValTok{10000}\NormalTok{, }\CommentTok{\# early stopping}
  \AttributeTok{epsilon =} \FunctionTok{c}\NormalTok{(}\FloatTok{1e{-}6}\NormalTok{, }\FloatTok{1e{-}7}\NormalTok{, }\FloatTok{1e{-}8}\NormalTok{, }\FloatTok{1e{-}9}\NormalTok{),}
  \AttributeTok{hidden =} \FunctionTok{list}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{50}\NormalTok{, }\DecValTok{50}\NormalTok{, }\DecValTok{50}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\DecValTok{200}\NormalTok{, }\DecValTok{200}\NormalTok{, }\DecValTok{200}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\DecValTok{500}\NormalTok{, }\DecValTok{500}\NormalTok{, }\DecValTok{500}\NormalTok{)),}
  \AttributeTok{hidden\_dropout\_ratios =} \FunctionTok{list}\NormalTok{(}
    \FunctionTok{c}\NormalTok{(}\FloatTok{0.1}\NormalTok{, }\FloatTok{0.1}\NormalTok{, }\FloatTok{0.1}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\FloatTok{0.2}\NormalTok{, }\FloatTok{0.2}\NormalTok{, }\FloatTok{0.2}\NormalTok{),}
    \FunctionTok{c}\NormalTok{(}\FloatTok{0.3}\NormalTok{, }\FloatTok{0.3}\NormalTok{, }\FloatTok{0.3}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\FloatTok{0.4}\NormalTok{, }\FloatTok{0.4}\NormalTok{, }\FloatTok{0.4}\NormalTok{),}
    \FunctionTok{c}\NormalTok{(}\FloatTok{0.5}\NormalTok{, }\FloatTok{0.5}\NormalTok{, }\FloatTok{0.5}\NormalTok{)}
\NormalTok{  ),}
  \AttributeTok{input\_dropout\_ratio =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FloatTok{0.05}\NormalTok{, }\FloatTok{0.1}\NormalTok{, }\FloatTok{0.15}\NormalTok{, }\FloatTok{0.2}\NormalTok{),}
  \AttributeTok{rho =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.9}\NormalTok{, }\FloatTok{0.95}\NormalTok{, }\FloatTok{0.99}\NormalTok{)}
\NormalTok{)}
\CommentTok{\# GBM}
\NormalTok{gbm\_params }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}
  \AttributeTok{col\_sample\_rate =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.4}\NormalTok{, }\FloatTok{0.7}\NormalTok{, }\FloatTok{1.0}\NormalTok{),}
  \AttributeTok{col\_sample\_rate\_per\_tree =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.4}\NormalTok{, }\FloatTok{0.7}\NormalTok{, }\FloatTok{1.0}\NormalTok{),}
  \AttributeTok{learn\_rate =} \FloatTok{0.1}\NormalTok{,}
  \AttributeTok{max\_depth =} \FunctionTok{c}\NormalTok{(}\DecValTok{3}\NormalTok{, }\DecValTok{4}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{6}\NormalTok{, }\DecValTok{7}\NormalTok{, }\DecValTok{8}\NormalTok{, }\DecValTok{9}\NormalTok{, }\DecValTok{10}\NormalTok{, }\DecValTok{11}\NormalTok{, }\DecValTok{12}\NormalTok{, }\DecValTok{13}\NormalTok{, }\DecValTok{14}\NormalTok{, }\DecValTok{15}\NormalTok{, }\DecValTok{16}\NormalTok{, }\DecValTok{17}\NormalTok{),}
  \AttributeTok{min\_rows =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{10}\NormalTok{, }\DecValTok{15}\NormalTok{, }\DecValTok{30}\NormalTok{, }\DecValTok{100}\NormalTok{),}
  \AttributeTok{min\_split\_improvement =} \FunctionTok{c}\NormalTok{(}\FloatTok{1e{-}4}\NormalTok{, }\FloatTok{1e{-}5}\NormalTok{),}
  \AttributeTok{ntrees =} \DecValTok{10000}\NormalTok{, }\CommentTok{\# early stopping}
  \AttributeTok{sample\_rate =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.5}\NormalTok{, }\FloatTok{0.6}\NormalTok{, }\FloatTok{0.7}\NormalTok{, }\FloatTok{0.8}\NormalTok{, }\FloatTok{0.9}\NormalTok{, }\FloatTok{1.0}\NormalTok{)}
\NormalTok{)}
\CommentTok{\# XGBoost}
\NormalTok{xgboost\_params }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}
  \AttributeTok{booster =} \FunctionTok{c}\NormalTok{(}\StringTok{"gbtree"}\NormalTok{, }\StringTok{"dart"}\NormalTok{),}
  \AttributeTok{col\_sample\_rate =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.6}\NormalTok{, }\FloatTok{0.8}\NormalTok{, }\FloatTok{1.0}\NormalTok{),}
  \AttributeTok{col\_sample\_rate\_per\_tree =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.7}\NormalTok{, }\FloatTok{0.8}\NormalTok{, }\FloatTok{0.9}\NormalTok{, }\FloatTok{1.0}\NormalTok{),}
  \AttributeTok{max\_depth =} \FunctionTok{c}\NormalTok{(}\DecValTok{5}\NormalTok{, }\DecValTok{10}\NormalTok{, }\DecValTok{15}\NormalTok{, }\DecValTok{20}\NormalTok{),}
  \AttributeTok{min\_rows =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.01}\NormalTok{, }\FloatTok{0.1}\NormalTok{, }\FloatTok{1.0}\NormalTok{, }\FloatTok{3.0}\NormalTok{, }\FloatTok{5.0}\NormalTok{, }\FloatTok{10.0}\NormalTok{, }\FloatTok{15.0}\NormalTok{, }\FloatTok{20.0}\NormalTok{),}
  \AttributeTok{ntrees =} \DecValTok{10000}\NormalTok{, }\CommentTok{\# early stopping}
  \AttributeTok{reg\_alpha =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.001}\NormalTok{, }\FloatTok{0.01}\NormalTok{, }\FloatTok{0.1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{10}\NormalTok{, }\DecValTok{100}\NormalTok{),}
  \AttributeTok{reg\_lambda =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.001}\NormalTok{, }\FloatTok{0.01}\NormalTok{, }\FloatTok{0.1}\NormalTok{, }\FloatTok{0.5}\NormalTok{, }\DecValTok{1}\NormalTok{),}
  \AttributeTok{sample\_rate =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.6}\NormalTok{, }\FloatTok{0.8}\NormalTok{, }\FloatTok{1.0}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{variable-reduction-3}{%
\section{Variable reduction}\label{variable-reduction-3}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{variable\_reduction }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(predictor\_variables, response\_variable, }\AttributeTok{seed =} \DecValTok{12}\NormalTok{) \{}
  \CommentTok{\# Calculate initial variable importance}
  \FunctionTok{set.seed}\NormalTok{(seed)}
  \CommentTok{\# Train random forest using ranger}
\NormalTok{  ntree }\OtherTok{\textless{}{-}} \DecValTok{100000}
\NormalTok{  rf }\OtherTok{\textless{}{-}} \FunctionTok{ranger}\NormalTok{(}\AttributeTok{x =}\NormalTok{ predictor\_variables, }\AttributeTok{y =}\NormalTok{ response\_variable, }\AttributeTok{num.trees =}\NormalTok{ ntree, }\AttributeTok{importance =} \StringTok{"permutation"}\NormalTok{, }\AttributeTok{verbose =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{scale.permutation.importance =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{seed =} \DecValTok{3}\NormalTok{, }\AttributeTok{keep.inbag =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  var\_imp }\OtherTok{\textless{}{-}}\NormalTok{ ranger}\SpecialCharTok{::}\FunctionTok{importance}\NormalTok{(rf)}
\NormalTok{  var\_imp }\OtherTok{\textless{}{-}}\NormalTok{ var\_imp[}\FunctionTok{order}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{var\_imp)]}
\NormalTok{  var\_imp }\OtherTok{\textless{}{-}}\NormalTok{ var\_imp[var\_imp }\SpecialCharTok{\textgreater{}=} \DecValTok{0}\NormalTok{]}
  \CommentTok{\# Variable reduction iterations}
\NormalTok{  ntree }\OtherTok{\textless{}{-}} \DecValTok{1000}
\NormalTok{  var\_subset\_res }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
  \ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(var\_imp)) \{}
    \FunctionTok{cat}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"Evaluating "}\NormalTok{, i, }\StringTok{" variable(s) out of "}\NormalTok{, }\FunctionTok{length}\NormalTok{(var\_imp), }\StringTok{" variables}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{))}
\NormalTok{    predictor\_variables\_ }\OtherTok{\textless{}{-}}\NormalTok{ predictor\_variables[, }\FunctionTok{colnames}\NormalTok{(predictor\_variables) }\SpecialCharTok{\%in\%} \FunctionTok{names}\NormalTok{(var\_imp)[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{i], drop }\OtherTok{=} \ConstantTok{FALSE}\NormalTok{]}
\NormalTok{    rf\_ }\OtherTok{\textless{}{-}} \FunctionTok{ranger}\NormalTok{(}\AttributeTok{x =}\NormalTok{ predictor\_variables\_, }\AttributeTok{y =}\NormalTok{ response\_variable, }\AttributeTok{num.trees =}\NormalTok{ ntree, }\AttributeTok{importance =} \StringTok{"none"}\NormalTok{, }\AttributeTok{verbose =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{seed =}\NormalTok{ seed, }\AttributeTok{probability =} \FunctionTok{is.factor}\NormalTok{(response\_variable))}
    \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{is.factor}\NormalTok{(response\_variable)) \{ }\CommentTok{\# Regression}
\NormalTok{      var\_subset\_res }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(var\_subset\_res, }\FunctionTok{list}\NormalTok{(}
        \AttributeTok{rsq =}\NormalTok{ rf}\SpecialCharTok{$}\NormalTok{r.squared,}
        \AttributeTok{aic =} \FunctionTok{aic\_reg}\NormalTok{(}
          \AttributeTok{y\_true =}\NormalTok{ response\_variable,}
          \AttributeTok{y\_pred =}\NormalTok{ rf\_}\SpecialCharTok{$}\NormalTok{predictions,}
          \AttributeTok{k =}\NormalTok{ i}
\NormalTok{        )}
\NormalTok{      ))}
\NormalTok{    \} }\ControlFlowTok{else}\NormalTok{ \{ }\CommentTok{\# Classification}
\NormalTok{      var\_subset\_res }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(var\_subset\_res, }\FunctionTok{list}\NormalTok{(}
        \AttributeTok{acc =} \DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ rf}\SpecialCharTok{$}\NormalTok{prediction.error,}
        \AttributeTok{aic =} \FunctionTok{aic\_clf}\NormalTok{(}
          \AttributeTok{y\_true =}\NormalTok{ response\_variable,}
          \AttributeTok{y\_pred =}\NormalTok{ rf\_}\SpecialCharTok{$}\NormalTok{predictions,}
          \AttributeTok{k =}\NormalTok{ i}
\NormalTok{        )}
\NormalTok{      ))}
\NormalTok{    \}}
\NormalTok{  \}}
\NormalTok{  aic\_vec }\OtherTok{\textless{}{-}} \FunctionTok{unlist}\NormalTok{(}\FunctionTok{lapply}\NormalTok{(var\_subset\_res, }\ControlFlowTok{function}\NormalTok{(x) x}\SpecialCharTok{$}\NormalTok{aic))}
\NormalTok{  aic\_cutoff }\OtherTok{\textless{}{-}} \FunctionTok{which.min}\NormalTok{(aic\_vec)}
\NormalTok{  var\_imp }\OtherTok{\textless{}{-}}\NormalTok{ ranger}\SpecialCharTok{::}\FunctionTok{importance}\NormalTok{(rf)}
\NormalTok{  var\_imp }\OtherTok{\textless{}{-}}\NormalTok{ var\_imp[}\FunctionTok{order}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{var\_imp)][}\DecValTok{1}\SpecialCharTok{:}\NormalTok{aic\_cutoff]}
  \FunctionTok{cat}\NormalTok{(}\FunctionTok{paste}\NormalTok{(}\StringTok{"Number of variables after variable reduction: "}\NormalTok{, aic\_cutoff, }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{))}
\NormalTok{  data }\OtherTok{\textless{}{-}}\NormalTok{ predictor\_variables[, }\FunctionTok{colnames}\NormalTok{(predictor\_variables) }\SpecialCharTok{\%in\%} \FunctionTok{names}\NormalTok{(var\_imp), drop }\OtherTok{=} \ConstantTok{FALSE}\NormalTok{]}
\NormalTok{  data}\SpecialCharTok{$}\NormalTok{response }\OtherTok{\textless{}{-}}\NormalTok{ response\_variable}
  \FunctionTok{return}\NormalTok{(data)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\hypertarget{model-training-6}{%
\section{Model training}\label{model-training-6}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{model\_training }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(train\_set, }\AttributeTok{prefix =} \StringTok{"demo\_models"}\NormalTok{, }\AttributeTok{exp\_dir =} \StringTok{"./demo\_models"}\NormalTok{, }\AttributeTok{nfolds =} \DecValTok{10}\NormalTok{, }\AttributeTok{grid\_seed =} \DecValTok{1}\NormalTok{) \{}
  \FunctionTok{h2o.init}\NormalTok{(}\AttributeTok{nthreads =} \SpecialCharTok{{-}}\DecValTok{1}\NormalTok{)}
  \FunctionTok{h2o.removeAll}\NormalTok{()}
  \FunctionTok{dir.create}\NormalTok{(exp\_dir)}
\NormalTok{  tmp }\OtherTok{\textless{}{-}} \FunctionTok{as.h2o}\NormalTok{(train\_set, }\AttributeTok{destination\_frame =}\NormalTok{ prefix)}
\NormalTok{  classification }\OtherTok{\textless{}{-}} \ConstantTok{FALSE}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{is.factor}\NormalTok{(train\_set}\SpecialCharTok{$}\NormalTok{response)) classification }\OtherTok{\textless{}{-}} \ConstantTok{TRUE}
\NormalTok{  samp\_factors }\OtherTok{\textless{}{-}} \ConstantTok{NULL}
  \ControlFlowTok{if}\NormalTok{ (classification) \{}
\NormalTok{    tmp[}\StringTok{"response"}\NormalTok{] }\OtherTok{\textless{}{-}} \FunctionTok{as.factor}\NormalTok{(tmp[}\StringTok{"response"}\NormalTok{])}
\NormalTok{    samp\_factors }\OtherTok{\textless{}{-}} \FunctionTok{as.vector}\NormalTok{(}\FunctionTok{mean}\NormalTok{(}\FunctionTok{table}\NormalTok{(train\_set}\SpecialCharTok{$}\NormalTok{response)) }\SpecialCharTok{/} \FunctionTok{table}\NormalTok{(train\_set}\SpecialCharTok{$}\NormalTok{response))}
\NormalTok{  \}}
\NormalTok{  y }\OtherTok{\textless{}{-}} \StringTok{"response"}
\NormalTok{  x }\OtherTok{\textless{}{-}} \FunctionTok{setdiff}\NormalTok{(}\FunctionTok{names}\NormalTok{(tmp), y)}
\NormalTok{  res }\OtherTok{\textless{}{-}} \FunctionTok{as.data.frame}\NormalTok{(tmp}\SpecialCharTok{$}\NormalTok{response)}
  \CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
  \CommentTok{\# base model training}
  \CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"Deep learning grid 1}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  deeplearning\_1 }\OtherTok{\textless{}{-}} \FunctionTok{h2o.grid}\NormalTok{(}
    \AttributeTok{algorithm =} \StringTok{"deeplearning"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{hyper\_params =}\NormalTok{ deeplearning\_params\_1,}
    \AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{, }\AttributeTok{balance\_classes =}\NormalTok{ classification,}
    \AttributeTok{class\_sampling\_factors =}\NormalTok{ samp\_factors,}
    \AttributeTok{search\_criteria =} \FunctionTok{list}\NormalTok{(}
      \AttributeTok{strategy =} \StringTok{"RandomDiscrete"}\NormalTok{,}
      \AttributeTok{max\_models =} \DecValTok{5}\NormalTok{, }\AttributeTok{seed =}\NormalTok{ grid\_seed}
\NormalTok{    ),}
    \AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}\NormalTok{, }\AttributeTok{parallelism =} \DecValTok{0}
\NormalTok{  )}
  \ControlFlowTok{for}\NormalTok{ (model\_id }\ControlFlowTok{in}\NormalTok{ deeplearning\_1}\SpecialCharTok{@}\NormalTok{model\_ids) \{}
\NormalTok{    tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(model\_id), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  \}}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"Deep learning grid 2}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  deeplearning\_2 }\OtherTok{\textless{}{-}} \FunctionTok{h2o.grid}\NormalTok{(}
    \AttributeTok{algorithm =} \StringTok{"deeplearning"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{hyper\_params =}\NormalTok{ deeplearning\_params\_2,}
    \AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{, }\AttributeTok{balance\_classes =}\NormalTok{ classification,}
    \AttributeTok{class\_sampling\_factors =}\NormalTok{ samp\_factors,}
    \AttributeTok{search\_criteria =} \FunctionTok{list}\NormalTok{(}
      \AttributeTok{strategy =} \StringTok{"RandomDiscrete"}\NormalTok{,}
      \AttributeTok{max\_models =} \DecValTok{5}\NormalTok{, }\AttributeTok{seed =}\NormalTok{ grid\_seed}
\NormalTok{    ),}
    \AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}\NormalTok{, }\AttributeTok{parallelism =} \DecValTok{0}
\NormalTok{  )}
  \ControlFlowTok{for}\NormalTok{ (model\_id }\ControlFlowTok{in}\NormalTok{ deeplearning\_2}\SpecialCharTok{@}\NormalTok{model\_ids) \{}
\NormalTok{    tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(model\_id), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  \}}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"Deep learning grid 3}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  deeplearning\_3 }\OtherTok{\textless{}{-}} \FunctionTok{h2o.grid}\NormalTok{(}
    \AttributeTok{algorithm =} \StringTok{"deeplearning"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{hyper\_params =}\NormalTok{ deeplearning\_params\_3,}
    \AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{, }\AttributeTok{balance\_classes =}\NormalTok{ classification,}
    \AttributeTok{class\_sampling\_factors =}\NormalTok{ samp\_factors,}
    \AttributeTok{search\_criteria =} \FunctionTok{list}\NormalTok{(}
      \AttributeTok{strategy =} \StringTok{"RandomDiscrete"}\NormalTok{,}
      \AttributeTok{max\_models =} \DecValTok{5}\NormalTok{, }\AttributeTok{seed =}\NormalTok{ grid\_seed}
\NormalTok{    ),}
    \AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}\NormalTok{, }\AttributeTok{parallelism =} \DecValTok{0}
\NormalTok{  )}
  \ControlFlowTok{for}\NormalTok{ (model\_id }\ControlFlowTok{in}\NormalTok{ deeplearning\_3}\SpecialCharTok{@}\NormalTok{model\_ids) \{}
\NormalTok{    tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(model\_id), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  \}}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"GBM grid}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  gbm }\OtherTok{\textless{}{-}} \FunctionTok{h2o.grid}\NormalTok{(}
    \AttributeTok{algorithm =} \StringTok{"gbm"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{hyper\_params =}\NormalTok{ gbm\_params, }\AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{,}
    \AttributeTok{balance\_classes =}\NormalTok{ classification, }\AttributeTok{class\_sampling\_factors =}\NormalTok{ samp\_factors,}
    \AttributeTok{search\_criteria =} \FunctionTok{list}\NormalTok{(}\AttributeTok{strategy =} \StringTok{"RandomDiscrete"}\NormalTok{, }\AttributeTok{max\_models =} \DecValTok{15}\NormalTok{, }\AttributeTok{seed =}\NormalTok{ grid\_seed),}
    \AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}\NormalTok{, }\AttributeTok{parallelism =} \DecValTok{0}
\NormalTok{  )}
  \ControlFlowTok{for}\NormalTok{ (model\_id }\ControlFlowTok{in}\NormalTok{ gbm}\SpecialCharTok{@}\NormalTok{model\_ids) \{}
\NormalTok{    tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(model\_id), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  \}}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"GBM 5 default models}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  gbm\_1 }\OtherTok{\textless{}{-}} \FunctionTok{h2o.gbm}\NormalTok{(}
    \AttributeTok{model\_id =} \StringTok{"GBM\_1"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{, }\AttributeTok{score\_tree\_interval =} \DecValTok{5}\NormalTok{,}
    \AttributeTok{balance\_classes =}\NormalTok{ classification, }\AttributeTok{class\_sampling\_factors =}\NormalTok{ samp\_factors,}
    \AttributeTok{col\_sample\_rate =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{col\_sample\_rate\_per\_tree =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{learn\_rate =} \FloatTok{0.1}\NormalTok{,}
    \AttributeTok{max\_depth =} \DecValTok{6}\NormalTok{, }\AttributeTok{min\_rows =} \DecValTok{1}\NormalTok{, }\AttributeTok{min\_split\_improvement =} \FloatTok{1e{-}5}\NormalTok{, }\AttributeTok{ntrees =} \DecValTok{10000}\NormalTok{, }\AttributeTok{sample\_rate =} \FloatTok{0.8}\NormalTok{,}
    \AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}
\NormalTok{  )}
\NormalTok{  gbm\_2 }\OtherTok{\textless{}{-}} \FunctionTok{h2o.gbm}\NormalTok{(}
    \AttributeTok{model\_id =} \StringTok{"GBM\_2"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{, }\AttributeTok{score\_tree\_interval =} \DecValTok{5}\NormalTok{,}
    \AttributeTok{balance\_classes =}\NormalTok{ classification, }\AttributeTok{class\_sampling\_factors =}\NormalTok{ samp\_factors,}
    \AttributeTok{col\_sample\_rate =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{col\_sample\_rate\_per\_tree =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{learn\_rate =} \FloatTok{0.1}\NormalTok{,}
    \AttributeTok{max\_depth =} \DecValTok{7}\NormalTok{, }\AttributeTok{min\_rows =} \DecValTok{10}\NormalTok{, }\AttributeTok{min\_split\_improvement =} \FloatTok{1e{-}5}\NormalTok{, }\AttributeTok{ntrees =} \DecValTok{10000}\NormalTok{, }\AttributeTok{sample\_rate =} \FloatTok{0.8}\NormalTok{,}
    \AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}
\NormalTok{  )}
\NormalTok{  gbm\_3 }\OtherTok{\textless{}{-}} \FunctionTok{h2o.gbm}\NormalTok{(}
    \AttributeTok{model\_id =} \StringTok{"GBM\_3"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{, }\AttributeTok{score\_tree\_interval =} \DecValTok{5}\NormalTok{,}
    \AttributeTok{balance\_classes =}\NormalTok{ classification, }\AttributeTok{class\_sampling\_factors =}\NormalTok{ samp\_factors,}
    \AttributeTok{col\_sample\_rate =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{col\_sample\_rate\_per\_tree =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{learn\_rate =} \FloatTok{0.1}\NormalTok{,}
    \AttributeTok{max\_depth =} \DecValTok{8}\NormalTok{, }\AttributeTok{min\_rows =} \DecValTok{10}\NormalTok{, }\AttributeTok{min\_split\_improvement =} \FloatTok{1e{-}5}\NormalTok{, }\AttributeTok{ntrees =} \DecValTok{10000}\NormalTok{, }\AttributeTok{sample\_rate =} \FloatTok{0.8}\NormalTok{,}
    \AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}
\NormalTok{  )}
\NormalTok{  gbm\_4 }\OtherTok{\textless{}{-}} \FunctionTok{h2o.gbm}\NormalTok{(}
    \AttributeTok{model\_id =} \StringTok{"GBM\_4"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{, }\AttributeTok{score\_tree\_interval =} \DecValTok{5}\NormalTok{,}
    \AttributeTok{balance\_classes =}\NormalTok{ classification, }\AttributeTok{class\_sampling\_factors =}\NormalTok{ samp\_factors,}
    \AttributeTok{col\_sample\_rate =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{col\_sample\_rate\_per\_tree =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{learn\_rate =} \FloatTok{0.1}\NormalTok{,}
    \AttributeTok{max\_depth =} \DecValTok{10}\NormalTok{, }\AttributeTok{min\_rows =} \DecValTok{10}\NormalTok{, }\AttributeTok{min\_split\_improvement =} \FloatTok{1e{-}5}\NormalTok{, }\AttributeTok{ntrees =} \DecValTok{10000}\NormalTok{, }\AttributeTok{sample\_rate =} \FloatTok{0.8}\NormalTok{,}
    \AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}
\NormalTok{  )}
  \CommentTok{\# gbm\_5 = h2o.gbm(model\_id=\textquotesingle{}GBM\_5\textquotesingle{}, x=x, y=y, training\_frame=tmp, seed=1, nfolds=nfolds,}
  \CommentTok{\#                 keep\_cross\_validation\_predictions=TRUE, stopping\_rounds=3, score\_tree\_interval=5,}
  \CommentTok{\#                 balance\_classes=classification, class\_sampling\_factors=samp\_factors,}
  \CommentTok{\#                 col\_sample\_rate=0.8, col\_sample\_rate\_per\_tree=0.8, learn\_rate=0.1,}
  \CommentTok{\#                 max\_depth=15, min\_rows=100, min\_split\_improvement=1e{-}5, ntrees=10000, sample\_rate=0.8,}
  \CommentTok{\#                 keep\_cross\_validation\_models=FALSE, fold\_assignment=\textquotesingle{}Modulo\textquotesingle{})}
  \ControlFlowTok{for}\NormalTok{ (model\_id }\ControlFlowTok{in} \FunctionTok{paste0}\NormalTok{(}\StringTok{"GBM\_"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{4}\NormalTok{)) \{}
\NormalTok{    tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(model\_id), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  \}}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"XGBoost grid}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  xgboost }\OtherTok{\textless{}{-}} \FunctionTok{h2o.grid}\NormalTok{(}
    \AttributeTok{algorithm =} \StringTok{"xgboost"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{hyper\_params =}\NormalTok{ xgboost\_params, }\AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{,}
    \AttributeTok{search\_criteria =} \FunctionTok{list}\NormalTok{(}\AttributeTok{strategy =} \StringTok{"RandomDiscrete"}\NormalTok{, }\AttributeTok{max\_models =} \DecValTok{15}\NormalTok{, }\AttributeTok{seed =}\NormalTok{ grid\_seed),}
    \AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}\NormalTok{, }\AttributeTok{parallelism =} \DecValTok{0}
\NormalTok{  )}
  \ControlFlowTok{for}\NormalTok{ (model\_id }\ControlFlowTok{in}\NormalTok{ xgboost}\SpecialCharTok{@}\NormalTok{model\_ids) \{}
\NormalTok{    tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(model\_id), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  \}}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"XGBoost 3 default models}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  xgboost\_1 }\OtherTok{\textless{}{-}} \FunctionTok{h2o.xgboost}\NormalTok{(}
    \AttributeTok{model\_id =} \StringTok{"XGBoost\_1"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{, }\AttributeTok{score\_tree\_interval =} \DecValTok{5}\NormalTok{,}
    \AttributeTok{booster =} \StringTok{"gbtree"}\NormalTok{, }\AttributeTok{col\_sample\_rate =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{col\_sample\_rate\_per\_tree =} \FloatTok{0.8}\NormalTok{,}
    \AttributeTok{max\_depth =} \DecValTok{10}\NormalTok{, }\AttributeTok{min\_rows =} \DecValTok{5}\NormalTok{, }\AttributeTok{ntrees =} \DecValTok{10000}\NormalTok{, }\AttributeTok{reg\_alpha =} \DecValTok{0}\NormalTok{, }\AttributeTok{reg\_lambda =} \DecValTok{1}\NormalTok{,}
    \AttributeTok{sample\_rate =} \FloatTok{0.6}\NormalTok{, }\AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}
\NormalTok{  )}
\NormalTok{  xgboost\_2 }\OtherTok{\textless{}{-}} \FunctionTok{h2o.xgboost}\NormalTok{(}
    \AttributeTok{model\_id =} \StringTok{"XGBoost\_2"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{, }\AttributeTok{score\_tree\_interval =} \DecValTok{5}\NormalTok{,}
    \AttributeTok{booster =} \StringTok{"gbtree"}\NormalTok{, }\AttributeTok{col\_sample\_rate =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{col\_sample\_rate\_per\_tree =} \FloatTok{0.8}\NormalTok{,}
    \AttributeTok{max\_depth =} \DecValTok{20}\NormalTok{, }\AttributeTok{min\_rows =} \DecValTok{10}\NormalTok{, }\AttributeTok{ntrees =} \DecValTok{10000}\NormalTok{, }\AttributeTok{reg\_alpha =} \DecValTok{0}\NormalTok{, }\AttributeTok{reg\_lambda =} \DecValTok{1}\NormalTok{,}
    \AttributeTok{sample\_rate =} \FloatTok{0.6}\NormalTok{, }\AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}
\NormalTok{  )}
\NormalTok{  xgboost\_3 }\OtherTok{\textless{}{-}} \FunctionTok{h2o.xgboost}\NormalTok{(}
    \AttributeTok{model\_id =} \StringTok{"XGBoost\_3"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{, }\AttributeTok{score\_tree\_interval =} \DecValTok{5}\NormalTok{,}
    \AttributeTok{booster =} \StringTok{"gbtree"}\NormalTok{, }\AttributeTok{col\_sample\_rate =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{col\_sample\_rate\_per\_tree =} \FloatTok{0.8}\NormalTok{,}
    \AttributeTok{max\_depth =} \DecValTok{5}\NormalTok{, }\AttributeTok{min\_rows =} \DecValTok{3}\NormalTok{, }\AttributeTok{ntrees =} \DecValTok{10000}\NormalTok{, }\AttributeTok{reg\_alpha =} \DecValTok{0}\NormalTok{, }\AttributeTok{reg\_lambda =} \DecValTok{1}\NormalTok{,}
    \AttributeTok{sample\_rate =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}
\NormalTok{  )}
  \ControlFlowTok{for}\NormalTok{ (model\_id }\ControlFlowTok{in} \FunctionTok{paste0}\NormalTok{(}\StringTok{"XGBoost\_"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{)) \{}
\NormalTok{    tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(model\_id), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  \}}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"GLM}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  glm }\OtherTok{\textless{}{-}} \FunctionTok{h2o.glm}\NormalTok{(}
    \AttributeTok{model\_id =} \StringTok{"GLM"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{alpha =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.0}\NormalTok{, }\FloatTok{0.2}\NormalTok{, }\FloatTok{0.4}\NormalTok{, }\FloatTok{0.6}\NormalTok{, }\FloatTok{0.8}\NormalTok{, }\FloatTok{1.0}\NormalTok{),}
    \AttributeTok{balance\_classes =}\NormalTok{ classification, }\AttributeTok{class\_sampling\_factors =}\NormalTok{ samp\_factors,}
    \AttributeTok{max\_after\_balance\_size =} \FloatTok{0.5}\NormalTok{, }\AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}
\NormalTok{  )}
\NormalTok{  tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(}\StringTok{"GLM"}\NormalTok{), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"DRF}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  drf }\OtherTok{\textless{}{-}} \FunctionTok{h2o.randomForest}\NormalTok{(}
    \AttributeTok{model\_id =} \StringTok{"DRF"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{ntrees =} \DecValTok{10000}\NormalTok{,}
    \AttributeTok{score\_tree\_interval =} \DecValTok{5}\NormalTok{, }\AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{,}
    \AttributeTok{balance\_classes =}\NormalTok{ classification,}
    \AttributeTok{class\_sampling\_factors =}\NormalTok{ samp\_factors,}
    \AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}
\NormalTok{  )}
\NormalTok{  tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(}\StringTok{"DRF"}\NormalTok{), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"XRT}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  xrt }\OtherTok{\textless{}{-}} \FunctionTok{h2o.randomForest}\NormalTok{(}
    \AttributeTok{model\_id =} \StringTok{"XRT"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{ntrees =} \DecValTok{10000}\NormalTok{, }\AttributeTok{histogram\_type =} \StringTok{"Random"}\NormalTok{,}
    \AttributeTok{score\_tree\_interval =} \DecValTok{5}\NormalTok{, }\AttributeTok{stopping\_rounds =} \DecValTok{3}\NormalTok{,}
    \AttributeTok{balance\_classes =}\NormalTok{ classification,}
    \AttributeTok{class\_sampling\_factors =}\NormalTok{ samp\_factors,}
    \AttributeTok{keep\_cross\_validation\_models =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{fold\_assignment =} \StringTok{"Modulo"}
\NormalTok{  )}
\NormalTok{  tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(}\StringTok{"XRT"}\NormalTok{), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
  \CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
  \CommentTok{\# get holdout predictions}
  \CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\NormalTok{  base\_models }\OtherTok{\textless{}{-}} \FunctionTok{as.list}\NormalTok{(}\FunctionTok{c}\NormalTok{(}
    \FunctionTok{unlist}\NormalTok{(deeplearning\_1}\SpecialCharTok{@}\NormalTok{model\_ids),}
    \FunctionTok{unlist}\NormalTok{(deeplearning\_2}\SpecialCharTok{@}\NormalTok{model\_ids),}
    \FunctionTok{unlist}\NormalTok{(deeplearning\_3}\SpecialCharTok{@}\NormalTok{model\_ids),}
    \FunctionTok{unlist}\NormalTok{(gbm}\SpecialCharTok{@}\NormalTok{model\_ids), }\FunctionTok{paste0}\NormalTok{(}\StringTok{"GBM\_"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{4}\NormalTok{),}
    \FunctionTok{unlist}\NormalTok{(xgboost}\SpecialCharTok{@}\NormalTok{model\_ids), }\FunctionTok{paste0}\NormalTok{(}\StringTok{"XGBoost\_"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{),}
    \StringTok{"GLM"}\NormalTok{,}
    \StringTok{"DRF"}\NormalTok{,}
    \StringTok{"XRT"}
\NormalTok{  ))}
  \ControlFlowTok{for}\NormalTok{ (model\_id }\ControlFlowTok{in}\NormalTok{ base\_models) \{}
    \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\NormalTok{classification) \{}
\NormalTok{      res }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(res, }\FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{h2o.getFrame}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"cv\_holdout\_prediction\_"}\NormalTok{, model\_id)),}
        \AttributeTok{col.names =}\NormalTok{ model\_id}
\NormalTok{      ))}
\NormalTok{    \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{      res }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(res, }\FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{h2o.getFrame}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"cv\_holdout\_prediction\_"}\NormalTok{, model\_id))[}\DecValTok{3}\NormalTok{],}
        \AttributeTok{col.names =}\NormalTok{ model\_id}
\NormalTok{      ))}
\NormalTok{    \}}
\NormalTok{  \}}
  \CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
  \CommentTok{\# super learner training}
  \CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\NormalTok{  sl\_iter }\OtherTok{\textless{}{-}} \DecValTok{0}
  \FunctionTok{cat}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"Super learner iteration "}\NormalTok{, sl\_iter, }\StringTok{" ("}\NormalTok{, }\FunctionTok{length}\NormalTok{(base\_models), }\StringTok{" models)}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{))}
\NormalTok{  sl }\OtherTok{\textless{}{-}} \FunctionTok{h2o.stackedEnsemble}\NormalTok{(}
    \AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{model\_id =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"superlearner\_iter\_"}\NormalTok{, sl\_iter),}
    \AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{,}
    \AttributeTok{base\_models =}\NormalTok{ base\_models,}
    \AttributeTok{metalearner\_algorithm =} \StringTok{"glm"}\NormalTok{,}
    \AttributeTok{metalearner\_nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_levelone\_frame =} \ConstantTok{TRUE}\NormalTok{,}
    \AttributeTok{metalearner\_params =} \FunctionTok{list}\NormalTok{(}
      \AttributeTok{standardize =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{,}
      \AttributeTok{balance\_classes =}\NormalTok{ classification,}
      \AttributeTok{class\_sampling\_factors =}\NormalTok{ samp\_factors,}
      \AttributeTok{max\_after\_balance\_size =} \FloatTok{0.5}
\NormalTok{    )}
\NormalTok{  )}
\NormalTok{  tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"superlearner\_iter\_"}\NormalTok{, sl\_iter)), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  model\_id }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"metalearner\_glm\_superlearner\_iter\_"}\NormalTok{, sl\_iter)}
\NormalTok{  tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(model\_id), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
  \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\NormalTok{classification) \{}
\NormalTok{    res }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(res, }\FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{h2o.getFrame}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"cv\_holdout\_prediction\_"}\NormalTok{, model\_id)),}
      \AttributeTok{col.names =} \FunctionTok{paste0}\NormalTok{(model\_id, }\StringTok{"\_"}\NormalTok{, }\FunctionTok{length}\NormalTok{(base\_models), }\StringTok{"\_models"}\NormalTok{)}
\NormalTok{    ))}
\NormalTok{  \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{    res }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(res, }\FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{h2o.getFrame}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"cv\_holdout\_prediction\_"}\NormalTok{, model\_id))[}\DecValTok{3}\NormalTok{],}
      \AttributeTok{col.names =} \FunctionTok{paste0}\NormalTok{(model\_id, }\StringTok{"\_"}\NormalTok{, }\FunctionTok{length}\NormalTok{(base\_models), }\StringTok{"\_models"}\NormalTok{)}
\NormalTok{    ))}
\NormalTok{  \}}
  \CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
  \CommentTok{\# super learner base model reduction}
  \CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
  \ControlFlowTok{while}\NormalTok{ (}\ConstantTok{TRUE}\NormalTok{) \{}
\NormalTok{    meta }\OtherTok{\textless{}{-}} \FunctionTok{h2o.getModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"metalearner\_glm\_superlearner\_iter\_"}\NormalTok{, sl\_iter, }\StringTok{"\_cv\_1"}\NormalTok{))}
\NormalTok{    names }\OtherTok{\textless{}{-}}\NormalTok{ meta}\SpecialCharTok{@}\NormalTok{model}\SpecialCharTok{$}\NormalTok{coefficients\_table[, }\StringTok{"names"}\NormalTok{]}
\NormalTok{    coeffs }\OtherTok{\textless{}{-}}\NormalTok{ (meta}\SpecialCharTok{@}\NormalTok{model}\SpecialCharTok{$}\NormalTok{coefficients\_table[, }\StringTok{"standardized\_coefficients"}\NormalTok{] }\SpecialCharTok{\textgreater{}} \DecValTok{0}\NormalTok{)}
    \ControlFlowTok{for}\NormalTok{ (j }\ControlFlowTok{in} \DecValTok{2}\SpecialCharTok{:}\NormalTok{nfolds) \{}
\NormalTok{      meta }\OtherTok{\textless{}{-}} \FunctionTok{h2o.getModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"metalearner\_glm\_superlearner\_iter\_"}\NormalTok{, sl\_iter, }\StringTok{"\_cv\_"}\NormalTok{, j))}
\NormalTok{      names }\OtherTok{\textless{}{-}}\NormalTok{ meta}\SpecialCharTok{@}\NormalTok{model}\SpecialCharTok{$}\NormalTok{coefficients\_table[, }\StringTok{"names"}\NormalTok{]}
\NormalTok{      coeffs }\OtherTok{\textless{}{-}}\NormalTok{ coeffs }\SpecialCharTok{+}\NormalTok{ (meta}\SpecialCharTok{@}\NormalTok{model}\SpecialCharTok{$}\NormalTok{coefficients\_table[, }\StringTok{"standardized\_coefficients"}\NormalTok{] }\SpecialCharTok{\textgreater{}} \DecValTok{0}\NormalTok{)}
\NormalTok{    \}}
\NormalTok{    base\_models\_ }\OtherTok{\textless{}{-}} \FunctionTok{as.list}\NormalTok{(names[coeffs }\SpecialCharTok{\textgreater{}=} \FunctionTok{ceiling}\NormalTok{(nfolds }\SpecialCharTok{/} \DecValTok{2}\NormalTok{) }\SpecialCharTok{\&}\NormalTok{ names }\SpecialCharTok{!=} \StringTok{"Intercept"}\NormalTok{])}
    \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{length}\NormalTok{(base\_models\_) }\SpecialCharTok{==} \DecValTok{0}\NormalTok{) \{}
      \FunctionTok{cat}\NormalTok{(}\StringTok{"No base models passing the threshold}\SpecialCharTok{\textbackslash{}n\textbackslash{}n}\StringTok{"}\NormalTok{)}
      \ControlFlowTok{break}
\NormalTok{    \}}
    \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{sum}\NormalTok{(base\_models }\SpecialCharTok{\%in\%}\NormalTok{ base\_models\_) }\SpecialCharTok{==} \FunctionTok{length}\NormalTok{(base\_models)) \{}
      \FunctionTok{cat}\NormalTok{(}\StringTok{"No further reduction of base models}\SpecialCharTok{\textbackslash{}n\textbackslash{}n}\StringTok{"}\NormalTok{)}
      \ControlFlowTok{break}
\NormalTok{    \}}
\NormalTok{    sl\_iter }\OtherTok{\textless{}{-}}\NormalTok{ sl\_iter }\SpecialCharTok{+} \DecValTok{1}
\NormalTok{    base\_models }\OtherTok{\textless{}{-}}\NormalTok{ base\_models\_}
    \FunctionTok{cat}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"Super learner iteration "}\NormalTok{, sl\_iter, }\StringTok{" ("}\NormalTok{, }\FunctionTok{length}\NormalTok{(base\_models), }\StringTok{" models)}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{))}
\NormalTok{    sl }\OtherTok{\textless{}{-}} \FunctionTok{h2o.stackedEnsemble}\NormalTok{(}
      \AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{model\_id =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"superlearner\_iter\_"}\NormalTok{, sl\_iter),}
      \AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{,}
      \AttributeTok{base\_models =}\NormalTok{ base\_models,}
      \AttributeTok{metalearner\_algorithm =} \StringTok{"glm"}\NormalTok{,}
      \AttributeTok{metalearner\_nfolds =}\NormalTok{ nfolds,}
      \AttributeTok{keep\_levelone\_frame =} \ConstantTok{TRUE}\NormalTok{,}
      \AttributeTok{metalearner\_params =} \FunctionTok{list}\NormalTok{(}
        \AttributeTok{standardize =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{,}
        \AttributeTok{balance\_classes =}\NormalTok{ classification,}
        \AttributeTok{class\_sampling\_factors =}\NormalTok{ samp\_factors,}
        \AttributeTok{max\_after\_balance\_size =} \FloatTok{0.5}
\NormalTok{      )}
\NormalTok{    )}
\NormalTok{    tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"superlearner\_iter\_"}\NormalTok{, sl\_iter)), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{    model\_id }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"metalearner\_glm\_superlearner\_iter\_"}\NormalTok{, sl\_iter)}
\NormalTok{    tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(model\_id), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
    \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\NormalTok{classification) \{}
\NormalTok{      res }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(res, }\FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{h2o.getFrame}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"cv\_holdout\_prediction\_"}\NormalTok{, model\_id)),}
        \AttributeTok{col.names =} \FunctionTok{paste0}\NormalTok{(model\_id, }\StringTok{"\_"}\NormalTok{, }\FunctionTok{length}\NormalTok{(base\_models), }\StringTok{"\_models"}\NormalTok{)}
\NormalTok{      ))}
\NormalTok{    \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{      res }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(res, }\FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{h2o.getFrame}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"cv\_holdout\_prediction\_"}\NormalTok{, model\_id))[}\DecValTok{3}\NormalTok{],}
        \AttributeTok{col.names =} \FunctionTok{paste0}\NormalTok{(model\_id, }\StringTok{"\_"}\NormalTok{, }\FunctionTok{length}\NormalTok{(base\_models), }\StringTok{"\_models"}\NormalTok{)}
\NormalTok{      ))}
\NormalTok{    \}}
\NormalTok{  \}}
  \CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
  \CommentTok{\# super learner for homogeneous base models}
  \CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
  \CommentTok{\# DeepLearning}
\NormalTok{  base\_models }\OtherTok{\textless{}{-}} \FunctionTok{as.list}\NormalTok{(}\FunctionTok{c}\NormalTok{(}
    \FunctionTok{unlist}\NormalTok{(deeplearning\_1}\SpecialCharTok{@}\NormalTok{model\_ids),}
    \FunctionTok{unlist}\NormalTok{(deeplearning\_2}\SpecialCharTok{@}\NormalTok{model\_ids),}
    \FunctionTok{unlist}\NormalTok{(deeplearning\_3}\SpecialCharTok{@}\NormalTok{model\_ids)}
\NormalTok{  ))}
  \FunctionTok{cat}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"Super learner deep learning ("}\NormalTok{, }\FunctionTok{length}\NormalTok{(base\_models), }\StringTok{" models)}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{))}
\NormalTok{  sl }\OtherTok{\textless{}{-}} \FunctionTok{h2o.stackedEnsemble}\NormalTok{(}
    \AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{model\_id =} \StringTok{"superlearner\_deeplearning"}\NormalTok{,}
    \AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{,}
    \AttributeTok{base\_models =}\NormalTok{ base\_models,}
    \AttributeTok{metalearner\_algorithm =} \StringTok{"glm"}\NormalTok{,}
    \AttributeTok{metalearner\_nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_levelone\_frame =} \ConstantTok{TRUE}\NormalTok{,}
    \AttributeTok{metalearner\_params =} \FunctionTok{list}\NormalTok{(}
      \AttributeTok{standardize =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{,}
      \AttributeTok{balance\_classes =}\NormalTok{ classification,}
      \AttributeTok{class\_sampling\_factors =}\NormalTok{ samp\_factors,}
      \AttributeTok{max\_after\_balance\_size =} \FloatTok{0.5}
\NormalTok{    )}
\NormalTok{  )}
\NormalTok{  tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(}\StringTok{"superlearner\_deeplearning"}\NormalTok{), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  model\_id }\OtherTok{\textless{}{-}} \StringTok{"metalearner\_glm\_superlearner\_deeplearning"}
\NormalTok{  tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(model\_id), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
  \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\NormalTok{classification) \{}
\NormalTok{    res }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(res, }\FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{h2o.getFrame}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"cv\_holdout\_prediction\_"}\NormalTok{, model\_id)),}
      \AttributeTok{col.names =} \FunctionTok{paste0}\NormalTok{(model\_id, }\StringTok{"\_"}\NormalTok{, }\FunctionTok{length}\NormalTok{(base\_models), }\StringTok{"\_models"}\NormalTok{)}
\NormalTok{    ))}
\NormalTok{  \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{    res }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(res, }\FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{h2o.getFrame}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"cv\_holdout\_prediction\_"}\NormalTok{, model\_id))[}\DecValTok{3}\NormalTok{],}
      \AttributeTok{col.names =} \FunctionTok{paste0}\NormalTok{(model\_id, }\StringTok{"\_"}\NormalTok{, }\FunctionTok{length}\NormalTok{(base\_models), }\StringTok{"\_models"}\NormalTok{)}
\NormalTok{    ))}
\NormalTok{  \}}
  \CommentTok{\# GBM}
\NormalTok{  base\_models }\OtherTok{\textless{}{-}} \FunctionTok{as.list}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\FunctionTok{unlist}\NormalTok{(gbm}\SpecialCharTok{@}\NormalTok{model\_ids), }\FunctionTok{paste0}\NormalTok{(}\StringTok{"GBM\_"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{4}\NormalTok{)))}
  \FunctionTok{cat}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"Super learner GBM ("}\NormalTok{, }\FunctionTok{length}\NormalTok{(base\_models), }\StringTok{" models)}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{))}
\NormalTok{  sl }\OtherTok{\textless{}{-}} \FunctionTok{h2o.stackedEnsemble}\NormalTok{(}
    \AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{model\_id =} \StringTok{"superlearner\_gbm"}\NormalTok{,}
    \AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{,}
    \AttributeTok{base\_models =}\NormalTok{ base\_models,}
    \AttributeTok{metalearner\_algorithm =} \StringTok{"glm"}\NormalTok{,}
    \AttributeTok{metalearner\_nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_levelone\_frame =} \ConstantTok{TRUE}\NormalTok{,}
    \AttributeTok{metalearner\_params =} \FunctionTok{list}\NormalTok{(}
      \AttributeTok{standardize =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{,}
      \AttributeTok{balance\_classes =}\NormalTok{ classification,}
      \AttributeTok{class\_sampling\_factors =}\NormalTok{ samp\_factors,}
      \AttributeTok{max\_after\_balance\_size =} \FloatTok{0.5}
\NormalTok{    )}
\NormalTok{  )}
\NormalTok{  tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(}\StringTok{"superlearner\_gbm"}\NormalTok{), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  model\_id }\OtherTok{\textless{}{-}} \StringTok{"metalearner\_glm\_superlearner\_gbm"}
\NormalTok{  tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(model\_id), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
  \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\NormalTok{classification) \{}
\NormalTok{    res }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(res, }\FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{h2o.getFrame}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"cv\_holdout\_prediction\_"}\NormalTok{, model\_id)),}
      \AttributeTok{col.names =} \FunctionTok{paste0}\NormalTok{(model\_id, }\StringTok{"\_"}\NormalTok{, }\FunctionTok{length}\NormalTok{(base\_models), }\StringTok{"\_models"}\NormalTok{)}
\NormalTok{    ))}
\NormalTok{  \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{    res }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(res, }\FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{h2o.getFrame}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"cv\_holdout\_prediction\_"}\NormalTok{, model\_id))[}\DecValTok{3}\NormalTok{],}
      \AttributeTok{col.names =} \FunctionTok{paste0}\NormalTok{(model\_id, }\StringTok{"\_"}\NormalTok{, }\FunctionTok{length}\NormalTok{(base\_models), }\StringTok{"\_models"}\NormalTok{)}
\NormalTok{    ))}
\NormalTok{  \}}
  \CommentTok{\# XGBoost}
\NormalTok{  base\_models }\OtherTok{\textless{}{-}} \FunctionTok{as.list}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\FunctionTok{unlist}\NormalTok{(xgboost}\SpecialCharTok{@}\NormalTok{model\_ids), }\FunctionTok{paste0}\NormalTok{(}\StringTok{"XGBoost\_"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{)))}
  \FunctionTok{cat}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"Super learner XGBoost ("}\NormalTok{, }\FunctionTok{length}\NormalTok{(base\_models), }\StringTok{" models)}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{))}
\NormalTok{  sl }\OtherTok{\textless{}{-}} \FunctionTok{h2o.stackedEnsemble}\NormalTok{(}
    \AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{model\_id =} \StringTok{"superlearner\_xgboost"}\NormalTok{,}
    \AttributeTok{training\_frame =}\NormalTok{ tmp, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{,}
    \AttributeTok{base\_models =}\NormalTok{ base\_models,}
    \AttributeTok{metalearner\_algorithm =} \StringTok{"glm"}\NormalTok{,}
    \AttributeTok{metalearner\_nfolds =}\NormalTok{ nfolds,}
    \AttributeTok{keep\_levelone\_frame =} \ConstantTok{TRUE}\NormalTok{,}
    \AttributeTok{metalearner\_params =} \FunctionTok{list}\NormalTok{(}
      \AttributeTok{standardize =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{keep\_cross\_validation\_predictions =} \ConstantTok{TRUE}\NormalTok{,}
      \AttributeTok{balance\_classes =}\NormalTok{ classification,}
      \AttributeTok{class\_sampling\_factors =}\NormalTok{ samp\_factors,}
      \AttributeTok{max\_after\_balance\_size =} \FloatTok{0.5}
\NormalTok{    )}
\NormalTok{  )}
\NormalTok{  tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(}\StringTok{"superlearner\_xgboost"}\NormalTok{), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  model\_id }\OtherTok{\textless{}{-}} \StringTok{"metalearner\_glm\_superlearner\_xgboost"}
\NormalTok{  tmp\_path }\OtherTok{\textless{}{-}} \FunctionTok{h2o.saveModel}\NormalTok{(}\FunctionTok{h2o.getModel}\NormalTok{(model\_id), }\AttributeTok{path =}\NormalTok{ exp\_dir, }\AttributeTok{force =} \ConstantTok{TRUE}\NormalTok{)}
  \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\NormalTok{classification) \{}
\NormalTok{    res }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(res, }\FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{h2o.getFrame}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"cv\_holdout\_prediction\_"}\NormalTok{, model\_id)),}
      \AttributeTok{col.names =} \FunctionTok{paste0}\NormalTok{(model\_id, }\StringTok{"\_"}\NormalTok{, }\FunctionTok{length}\NormalTok{(base\_models), }\StringTok{"\_models"}\NormalTok{)}
\NormalTok{    ))}
\NormalTok{  \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{    res }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(res, }\FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{h2o.getFrame}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"cv\_holdout\_prediction\_"}\NormalTok{, model\_id))[}\DecValTok{3}\NormalTok{],}
      \AttributeTok{col.names =} \FunctionTok{paste0}\NormalTok{(model\_id, }\StringTok{"\_"}\NormalTok{, }\FunctionTok{length}\NormalTok{(base\_models), }\StringTok{"\_models"}\NormalTok{)}
\NormalTok{    ))}
\NormalTok{  \}}
  \FunctionTok{write.csv}\NormalTok{(res, }\AttributeTok{file =} \FunctionTok{paste0}\NormalTok{(exp\_dir, }\StringTok{"/cv\_holdout\_predictions.csv"}\NormalTok{), }\AttributeTok{row.names =} \ConstantTok{FALSE}\NormalTok{)}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}n\textbackslash{}n}\StringTok{"}\NormalTok{)}
  \FunctionTok{h2o.removeAll}\NormalTok{()}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\hypertarget{run-pipeline}{%
\section{Run pipeline}\label{run-pipeline}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\StringTok{"https://archive.ics.uci.edu/ml/machine{-}learning{-}databases/parkinsons/parkinsons.data"}\NormalTok{, }\AttributeTok{check.names =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{row.names =} \DecValTok{1}\NormalTok{)}

\CommentTok{\# Random subset}
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{10}\NormalTok{)}
\NormalTok{data }\OtherTok{\textless{}{-}}\NormalTok{ data[}\FunctionTok{sample}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(data), }\AttributeTok{size =} \DecValTok{50}\NormalTok{, }\AttributeTok{replace =} \ConstantTok{FALSE}\NormalTok{), ]}
\NormalTok{predictor\_variables }\OtherTok{\textless{}{-}}\NormalTok{ data[, }\FunctionTok{colnames}\NormalTok{(data) }\SpecialCharTok{!=} \StringTok{"status"}\NormalTok{]}
\NormalTok{response\_variable }\OtherTok{\textless{}{-}} \FunctionTok{as.factor}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{status)}

\FunctionTok{system.time}\NormalTok{(\{}
\NormalTok{  reduced\_data }\OtherTok{\textless{}{-}} \FunctionTok{variable\_reduction}\NormalTok{(}\AttributeTok{predictor\_variables =}\NormalTok{ predictor\_variables, }\AttributeTok{response\_variable =}\NormalTok{ response\_variable)}
  \FunctionTok{model\_training}\NormalTok{(}\AttributeTok{train\_set =}\NormalTok{ reduced\_data)}
\NormalTok{\})}
\end{Highlighting}
\end{Shaded}

\hypertarget{session-info}{%
\section{Session info}\label{session-info}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sessionInfo}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## R version 4.2.2 (2022-10-31)
## Platform: x86_64-apple-darwin17.0 (64-bit)
## Running under: macOS Big Sur ... 10.16
## 
## Matrix products: default
## BLAS:   /Library/Frameworks/R.framework/Versions/4.2/Resources/lib/libRblas.0.dylib
## LAPACK: /Library/Frameworks/R.framework/Versions/4.2/Resources/lib/libRlapack.dylib
## 
## locale:
## [1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8
## 
## attached base packages:
## [1] stats     graphics  grDevices utils     datasets  methods   base     
## 
## loaded via a namespace (and not attached):
##  [1] bookdown_0.28     digest_0.6.29     R.methodsS3_1.8.2 magrittr_2.0.3   
##  [5] evaluate_0.16     rlang_1.0.4       stringi_1.7.8     cli_3.3.0        
##  [9] rstudioapi_0.14   R.utils_2.12.0    R.oo_1.25.0       vctrs_0.4.1      
## [13] rmarkdown_2.16    styler_1.8.0      tools_4.2.2       stringr_1.4.1    
## [17] R.cache_0.16.0    purrr_0.3.4       xfun_0.32         yaml_2.3.5       
## [21] fastmap_1.1.0     compiler_4.2.2    htmltools_0.5.3   knitr_1.40
\end{verbatim}

\end{document}
